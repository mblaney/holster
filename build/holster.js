var ae={is:e=>{if(e instanceof Array)return!1;if(typeof e=="number")return!isNaN(e);if(typeof e=="string"){let t=parseFloat(e);return!isNaN(t)&&isFinite(t)}return!1}},L={is:e=>{if(!e||typeof e!="object")return!1;let r=Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/);return e.constructor===Object||r&&r[1]==="Object"},map:(e,t,r)=>{var n=Object.keys(e);for(let o=0;o<n.length;o++){let a=t(e[n[o]],n[o],r);if(typeof a<"u")return a}},put:(e,t,r)=>(e||(e={}),e[t]=r,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Be=(e,t,r)=>{if(r.id){r.id=!1;return}if(t==="#"&&typeof e=="string"){r.id=e;return}r.id=!1},U={is:e=>{if(e&&e["#"]&&!e._&&L.is(e)){let t={};if(L.map(e,Be,t),t.id)return t.id}return!1},ify:e=>L.put({},"#",e)},W="_holster_user_signature",K="_holster_user_public_key",X=(e,t,r,n)=>{let o=Date.now(),a={[e]:{_:{"#":e,">":{}}}};for(let[w,d]of Object.entries(t))w!=="_"&&w!==K&&w!==W&&(a[e][w]=d,a[e]._[">"][w]=o);return r&&n&&(a[e][W]=r,a[e]._[">"][W]=o,a[e][K]=n,a[e]._[">"][K]=o),a},V=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!L.is(e)||!t)return!1;let r=e["*"];if(r)return t.slice(0,r.length)===r;let n=e[">"],o=e["<"];return n&&o?t>=n&&t<=o:n?t>=n:o?t<=o:!1},D={random:e=>{var t="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let n=0;n<e;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}};var Fe=e=>{e||(e=9e3);let t={store:{}};return t.check=r=>t.store[r]?t.track(r):!1,t.track=r=>(t.store[r]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{if(t.expiry)return;let n=Date.now();Object.keys(t.store).forEach(o=>{n-t.store[o]>e&&delete t.store[o]}),t.expiry=null},e)),r),t},xe=Fe;var He=(e,t)=>{if(!e||typeof e!="object")throw new TypeError("lex must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");let r=e["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!t[r])return;let n={_:{"#":r,">":{}}};if(typeof e["."]=="string"){let o=e["."];if(typeof t[r][o]>"u")return;n[o]=t[r][o],n._[">"][o]=t[r]._[">"][o]}else for(let o of Object.keys(t[r]))V(e["."],o)&&(n[o]=t[r][o],n._[">"][o]=t[r]._[">"][o]);return{[r]:n}},me=He;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function fe(){}Object.assign(fe,{from:Array.from});fe.prototype=Object.create(Array.prototype);fe.prototype.toString=function(e,t,r){if(e||(e="utf8"),t||(t=0),r=r?Math.min(Math.max(r,t),this.length):this.length,e==="hex"){let n=new Uint8Array(this.slice(t,r));return Array.from(n,o=>o.toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:r-t},(n,o)=>{let a=this[o+t];return a<0||a>1114111?"\uFFFD":String.fromCharCode(a)}).join("");if(e==="base64"){let n=Array.from({length:r-t},(o,a)=>{let w=this[a+t];return w<0||w>255?"\uFFFD":String.fromCharCode(w)}).join("");return btoa(n)}};var Q=fe;var ce={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function Y(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),Y.from(...e)}Y.prototype=Object.create(Array.prototype);var ie=(e,t)=>{if(typeof e!="string")throw new TypeError("Input must be a string for encoding: "+t);if(e.length>ce.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${e.length} > ${ce.MAX_STRING_LENGTH}`)},z=(e,t="buffer operation")=>{if(e>ce.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${t}: ${e} > ${ce.MAX_BUFFER_SIZE}`)},Ke=e=>{ie(e,"hex");let t=e.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(t))throw new TypeError("Invalid hex string: contains non-hex characters");if(t.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(t.length===0)return new Uint8Array(0);z(t.length/2,"hex parsing");let r=new Uint8Array(t.length/2);for(let n=0;n<t.length;n+=2){let o=t.substr(n,2);r[n/2]=parseInt(o,16)}return r},Te=e=>{ie(e,"utf8");try{let r=new TextEncoder().encode(e);return z(r.length,"UTF-8 encoding"),r}catch(t){throw new TypeError("Failed to encode UTF-8 string: "+t.message)}},Je=e=>{ie(e,"binary"),z(e.length,"binary encoding");let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);t[r]=n}return t},qe=e=>{ie(e,"base64");let t=e.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(t))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(t);z(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let o=0;o<r.length;o++)n[o]=r.charCodeAt(o);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},$e=e=>{let t;if(e instanceof ArrayBuffer)z(e.byteLength,"ArrayBuffer processing"),t=new Uint8Array(e);else if(ArrayBuffer.isView(e))z(e.byteLength||e.length,"TypedArray processing"),t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);else if(Array.isArray(e)){z(e.length,"Array processing");for(let r=0;r<e.length;r++){let n=e[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}t=new Uint8Array(e)}else if(typeof e=="object"&&e!==null&&typeof e.length=="number"){z(e.length,"array-like processing");let r=Array.from(e);for(let n=0;n<r.length;n++){let o=r[n];if(typeof o!="number"||o<0||o>255||!Number.isInteger(o))throw new TypeError(`Invalid byte value at index ${n}: ${o} (must be integer 0-255)`)}t=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof e);return t};Object.assign(Y,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let t=arguments[0];if(t==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof t=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=Ke(t);break;case"utf8":case"utf-8":r=Te(t);break;case"binary":case"latin1":r=Je(t);break;case"base64":r=qe(t);break;case"ascii":ie(t,"ascii");for(let o=0;o<t.length;o++)if(t.charCodeAt(o)>127)throw new TypeError(`Invalid ASCII character at position ${o}: ${t.charCodeAt(o)} > 127`);r=Te(t);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=$e(t);if(!r||r.length===0)return Q.from(new Uint8Array(0));try{return Q.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(e,t=0){if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Length must be a non-negative integer");if(z(e,"buffer allocation"),typeof t=="number"){if(t<0||t>255||!Number.isInteger(t))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof t=="string"){if(t.length!==1)throw new TypeError("Fill string must be exactly one character");if(t=t.charCodeAt(0),t>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(e);return t!==0&&r.fill(t),Q.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be an array");if(e.length===0)return Q.from(new Uint8Array(0));let t=0,r=[];for(let n=0;n<e.length;n++){let o=e[n];if(!o)throw new TypeError(`Array element at index ${n} is null or undefined`);let a;try{a=$e(o)}catch(w){throw new TypeError(`Invalid array element at index ${n}: ${w.message}`)}t+=a.length,z(t,"buffer concatenation"),r.push(a)}try{let n=new Uint8Array(t),o=0;for(let a of r)n.set(a,o),o+=a.length;return Q.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(e){return e instanceof Q||e&&typeof e=="object"&&e.constructor===Y},byteLength(e,t="utf8"){if(typeof e!="string")throw new TypeError("First argument must be a string");switch(t.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(e).length;case"ascii":case"binary":case"latin1":return e.length;case"base64":let r=e.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(e.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+t)}}});Y.prototype.from=Y.from;Y.prototype.toString=function(e="utf8",t=0,r=this.length){if(typeof e!="string")throw new TypeError("Encoding must be a string");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<t)throw new TypeError("End must be an integer >= start");try{return Q.prototype.toString.call(this,e,t,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var J=Y;var We=typeof document>"u",Ae=We?(await import("node:crypto")).webcrypto:globalThis.crypto,P=Ae.subtle,ge=e=>typeof e=="string"?e:JSON.stringify(e),se=e=>{try{return JSON.parse(e)}catch{return e}},pe=e=>{let t=new Uint8Array(J.alloc(e));return J.from(Ae.getRandomValues(t))},ue=(e,t)=>{let[r,n]=e.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},de=async e=>{let t=await P.digest({name:"SHA-256"},new TextEncoder().encode(ge(e)));return J.from(t)},we=async(e,t)=>{let r=e+t.toString("utf8"),n=J.from(await de(r),"binary"),o=Ge(n);return await P.importKey("jwk",o,{name:"AES-GCM"},!1,["encrypt","decrypt"])},Ge=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var Xe={pair:async e=>{let t=await P.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async o=>{let a=await P.exportKey("jwk",o.publicKey);return{priv:(await P.exportKey("jwk",o.privateKey)).d,pub:a.x+"."+a.y}}),r=await P.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async o=>{let a=await P.exportKey("jwk",o.publicKey);return{epriv:(await P.exportKey("jwk",o.privateKey)).d,epub:a.x+"."+a.y}}),n={pub:t.pub,priv:t.priv,epub:r.epub,epriv:r.epriv};return e&&e(n),n},encrypt:async(e,t,r)=>{if(!t||!t.epriv)return r&&r(null),null;let n={s:pe(9),iv:pe(15)},o=await we(t.epriv,n.s).then(w=>P.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},w,new TextEncoder().encode(ge(e)))),a={ct:J.from(o,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(a),a},decrypt:async(e,t,r)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return r&&r(null),null;let n={ct:J.from(e.ct,"base64"),iv:J.from(e.iv,"base64"),s:J.from(e.s,"base64")};try{let o=await we(t.epriv,n.s).then(w=>P.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},w,new Uint8Array(n.ct))),a=se(new TextDecoder("utf8").decode(o));return r&&r(a),a}catch{return r&&r(null),null}},verify:async(e,t,r)=>{if(!t||!t.pub)return r&&r(null),null;let n=se(e),o=await P.importKey("jwk",ue(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),a={};if(typeof n.m=="string")a=n.m;else for(let l of Object.keys(n.m).sort())l!=="_"&&l!=K&&l!=W&&(a[l]=n.m[l]);let w=await de(a),d=new Uint8Array(J.from(n.s,"base64")),f={name:"ECDSA",hash:{name:"SHA-256"}};if(await P.verify(f,o,d,new Uint8Array(w))){let l=se(n.m);return r&&r(l),l}return r&&r(null),null},sign:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n={};if(typeof e=="string")n=e;else{let l=se(e);for(let m of Object.keys(l).sort())m!=="_"&&m!=K&&m!=W&&(n[m]=l[m])}let o=await de(n),a=ue(t.pub,t.priv),w={name:"ECDSA",namedCurve:"P-256"},d=await P.importKey("jwk",a,w,!1,["sign"]).then(l=>P.sign({name:"ECDSA",hash:{name:"SHA-256"}},l,new Uint8Array(o))),f={m:n,s:J.from(d,"binary").toString("base64")};return r&&r(f),f},work:async(e,t,r)=>{typeof t=="function"&&(r=t,t=void 0),typeof t>"u"&&(t=pe(9));let n=await P.importKey("raw",new TextEncoder().encode(ge(e)),{name:"PBKDF2"},!1,["deriveBits"]),o={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},a=await P.deriveBits(o,n,512),w={epriv:J.from(a,"binary").toString("base64")};return r&&r(w),w},secret:async(e,t,r)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},o=ue(e.epub),a=await P.importKey("jwk",o,n,!0,[]),w=ue(t.epub,t.epriv,!1);delete w.key_ops;let d=await P.importKey("jwk",w,n,!1,["deriveBits"]).then(async f=>{let l=await P.deriveBits({public:a,name:"ECDH",namedCurve:"P-256"},f,256),m=await P.importKey("raw",new Uint8Array(l),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return P.exportKey("jwk",m).then(({k:v})=>v)});return r&&r({epriv:d}),{epriv:d}}},H=Xe;var je=100,Ce=1e4,be=(e,t,r,n)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});be.mix=async(e,t,r,n)=>{if(!e||typeof e!="object")throw new TypeError("change must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let o=Date.now(),a={},w={},d=0;for(let l of Object.keys(e)){let m=e[l],v=!1,T=!1,i=0,s=r;if(!m||!m._)continue;let g=m[W],c=m[K];if(g&&c&&(s=!0),l.length>1&&l[0]==="~")if(l[1]==="@")T=!0,s=!1;else{if(c&&l!="~"+c){console.log(`error public key does not match for soul: ${l}`);continue}s=!0}if(!(s&&(!g||!c||!await H.verify({m,s:g},{pub:c})))){for(let u of Object.keys(m)){if(u==="_")continue;let p=m[u],E=m._&&m._[">"]?m._[">"][u]:0,h=(t[l]||{})[u],b=(t[l]||{_:{">":{}}})._[">"][u]||0;if(T&&u!==U.is(p)){console.log(`error alias ${T}: ${u} !== ${U.is(p)}`);continue}let $=E-o;if($>0){if($>864e5)continue;(d===0||$<d)&&(d=i=$),w[l]||(w[l]={_:{"#":l,">":{}}}),w[l][u]=p,w[l]._[">"][u]=E}else be(E,b,p,h).incoming&&(a[l]||(a[l]={_:{"#":l,">":{}}}),t[l]||(t[l]={_:{"#":l,">":{}}}),t[l][u]=a[l][u]=p,t[l]._[">"][u]=a[l]._[">"][u]=E,n[l]&&setTimeout(()=>{n[l]&&n[l].filter(O=>V(O["."],u)).forEach(O=>O.cb())},je),v=!0)}s&&i!==0&&a[l]&&(Object.assign(w[l],a[l]),delete a[l]),v&&n[l]&&setTimeout(()=>{n[l]&&n[l].filter(u=>V(u["."])).forEach(u=>u.cb())},je)}}let f=Object.keys(t);return f.length>Ce&&f.map(v=>{let T=t[v]._&&t[v]._[">"],i=T?Math.max(...Object.values(T)):0;return{soul:v,maxState:i}}).sort((v,T)=>v.maxState-T.maxState).slice(0,f.length-Ce).forEach(({soul:v})=>delete t[v]),{now:a,defer:w,wait:d}};var Se=be;var G="",oe="",Oe=()=>{let e=(t,r,n)=>{if(n||(e[G]||(e[G]={}),n=e[G]),!t)return n;let o=0,a={},w=t[o],d=t.length-1,f=typeof r>"u",l=n[w];for(;!l&&o<d;)w+=t[++o],l=n[w];if(l)if(o===d){if(f)return typeof l[oe]>"u"?l[G]:l[oe];l[oe]=r}else return!l[G]&&!f&&(l[G]={}),e(t.slice(++o),r,l[G]);else if(L.map(n,(v,T)=>{let i=0,s="";for(;T[i]===t[i];)s+=T[i++];if(s){if(f)return i<=d?void 0:(a[T.slice(i)]=v,v);let g={[T.slice(i)]:v,[t.slice(i)]:{[oe]:r}};return n[s]={[G]:g},delete n[T],!0}})){if(f)return a}else{if(f)return;n[w]||(n[w]={}),n[w][oe]=r}};return e};Oe.map=function e(t,r,n,o){o||(o=[]);var a=t[G]||t,w=Object.keys(a).sort(),d;for(let f=0;f<w.length;f++){let l=w[f],m=a[l],v=m[oe];if(typeof v<"u"){if(v=r(v,o.join("")+l,l,o),typeof v<"u")return v}else n&&r(d,o.join(""),l,o);if(m[G]){if(o.push(l),v=e(m[G],r,n,o),typeof v<"u")return v;o.pop()}}};var q=Oe;var Ie="",_e="",F="",te=e=>{var t;let r=new Map,n=null,o=0,a=1e4,w=new Map,d=0,f=3e4,l=.8,m=.9;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=100),e.write||(e.write=1),e.size||(e.size=1024*1024),e.memoryLimit||(e.memoryLimit=500),typeof e.cache>"u"&&(e.cache=!0),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let v=(s,g,c,u)=>{let p=Date.now()-g;p>2e3&&console.log(`[RADISK-SLOW] ${s}: ${p}ms for ${c}${u?` (${u} bytes)`:""}`)},T=()=>{if(typeof process>"u"||!process.memoryUsage)return;let s=Date.now();if(s-d<f)return;d=s;let g=process.memoryUsage(),c=g.heapUsed,u=g.heapTotal,p=e.memoryLimit*1024*1024,E=c/p;if(E>m){let h=r.size;console.log(`[RADISK-MEMORY] High memory usage: ${Math.round(E*100)}% of heap limit. Clearing ${h} cached files.`),r.clear(),global.gc&&global.gc(),d=s+f}else E>l&&console.log(`[RADISK-MEMORY] Memory warning: ${Math.round(E*100)}% of heap limit used. Cache size: ${r.size} files.`)},i=(s,g,c)=>{if(s=""+s,typeof g=="function"){if(c=g,g=i.batch(s),typeof g<"u"||i.thrash.at&&(g=i.thrash.at(s),typeof g<"u"))return c(t,g);if(w.has(s)){w.get(s).push(c);return}w.set(s,[c]);let u=Date.now();return i.read(s,(p,E)=>{v("read",u,s);let h=w.get(s)||[];w.delete(s),h.forEach(b=>b(p,E))})}if(i.batch(s,g),T(),c&&i.batch.acks.push(c),++i.batch.ed>=e.batch)return i.thrash();clearTimeout(i.batch.timeout),i.batch.timeout=setTimeout(i.thrash,e.write)};return i.batch=q(),i.batch.acks=[],i.batch.ed=0,i.thrash=()=>{if(i.thrash.ing)return i.thrash.more=!0;let s=Date.now();clearTimeout(i.batch.timeout),i.thrash.more=!1,i.thrash.ing=!0;var g=i.thrash.at=i.batch;i.batch=null,i.batch=q(),i.batch.acks=[],i.batch.ed=0;let c=0;i.save(g,u=>{++c>1||(v("thrash",s,`batch-${g.ed}`),u&&e.log(u),g.acks.forEach(p=>p(u)),i.thrash.at=null,i.thrash.ing=!1,i.thrash.more&&i.thrash())})},i.save=(s,g)=>{let c={find:(u,p)=>{if(!(p<c.start))return c.start=p,e.store.list(c.lex),!0},lex:u=>{!u||u>c.start?(c.end=u,c.start&&c.mix(c.file||"!",c.start,c.end)):c.file=u},mix:(u,p,E)=>{if(c.start=c.end=c.file=t,r.has(u)){let h=r.get(u);q.map(s,(b,$)=>{if(!($<p)){if(E&&E<$){c.start=$;return}h($,b)}}),i.write(u,h,c.next)}else i.parse(u,(h,b)=>{if(h)return g(h);q.map(s,($,C)=>{if(!(C<p)){if(E&&E<C){c.start=C;return}b(C,$)}}),i.write(u,b,c.next)})},next:u=>{if(u)return g(u);if(c.start)return q.map(s,c.find);g(u)}};q.map(s,c.find)},i.write=(s,g,c)=>{let u={text:"",limit:"",done:!1,count:0,each:(E,h,b,$)=>{if(u.done)return;u.count++,E=typeof E>"u"?"":"="+te.encode(E);let C=te.encode($.length)+"#"+te.encode(b)+E+`
`;if(u.count>1&&$.length===0&&u.text.length+C.length>e.size){let O=b.indexOf(_e);if(u.limit=O===-1?b:b.substring(0,O),u.limit!==s){u.done=!0,u.sub=q(),q.map(g,u.slice),i.write(u.limit,u.sub,c);return}}u.text+=C},slice:(E,h)=>{h<u.limit||u.sub(h,E)}};q.map(g,u.each,!0);let p=Date.now();e.store.put(s,u.text,E=>{v("file-write",p,s,u.text.length),c(E)})},i.read=(s,g)=>{let c=s.indexOf(_e),u=c===-1?s:s.substring(0,c),p={lex:h=>{if(!h){if(!p.file){g("no file found",t);return}if(e.cache&&r.has(p.file)){let b=r.get(p.file);return p.value=b(s),g(t,p.value)}i.parse(p.file,p.it);return}h>u||h<p.file||(p.file=h)},it:(h,b)=>{h&&e.log(h),b&&(e.cache&&(r.set(p.file,b),T()),p.value=b(s)),g(h,p.value)}},E=Date.now();if(e.cache&&n&&E-o<a)n.forEach(h=>p.lex(h)),p.lex();else{let h=[],b=p.lex;p.lex=$=>($&&h.push($),b($)),e.store.list($=>{p.lex($),!$&&e.cache&&(n=h,o=E)})}},i.parse=(s,g)=>{let c={disk:q(),read:(u,p)=>{if(u)return g(u);if(!p)return g(t,c.disk);let E=[],h="",b=c.split(p);for(;b;){let $,C,O=b[1];b=c.split(b[2])||"",b[0]==="#"&&($=b[1],O<E.length&&(E.length=O),O<=E.length&&(E[O]=$,E.length=O+1),h=E.join("")),b=c.split(b[2])||"",b[0]!==`
`&&(b[0]==="="&&(C=b[1]),typeof $<"u"&&typeof C<"u"&&c.disk(h,C),b=c.split(b[2]))}g(t,c.disk)},split:u=>{if(!u)return;let p=u.indexOf(F);if(p===-1)return;let E=u.slice(0,p),h={};return[E,te.decode(u.slice(p),h),u.slice(p+h.i)]}};e.store.get(s,c.read)},i};te.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=Ie+e[1],e=e[0]),typeof e=="string"){let n=0,o=null,a=F;for(;o=e[n++];)o===F&&(a+=F);return a+'"'+e+t+F}let r=U.is(e);if(r)return F+"#"+r+t+F;if(ae.is(e))return F+"+"+(e||0)+t+F;if(e===!0)return F+"+"+t+F;if(e===!1)return F+"-"+t+F;if(e===null)return F+" "+t+F};te.decode=(e,t)=>{var r=-1,n=0,o=null,a=null,w=-1,d=-1;if(e[0]!==F)return;for(;o=e[++r];)if(a){if(w===-1&&(w=r),o===F&&--n<=0){d=r;break}}else o===F?n++:a=o||!0;let f=w!==-1?e.slice(w,d!==-1?d:r):"";t&&(t.i=r+1);let[l,m]=f.split(Ie);if(m){if(m=parseFloat(m),a==='"')return[l,m];if(a==="#")return[U.ify(l),m];if(a==="+")return l.length===0?[!0,m]:[parseFloat(l),m];if(a==="-")return[!1,m];if(a===" ")return[null,m]}else{if(a==='"')return f;if(a==="#")return U.ify(f);if(a==="+")return f.length===0?!0:parseFloat(f);if(a==="-")return!1;if(a===" ")return null}};var Ne=te;var Re=typeof document>"u",Z=Re?await import("node:fs"):void 0,Me="",he="",ve=he+"+0"+he+"#"+he+'"root'+he,Qe=e=>{let t=e.file;if(Re)return Z.existsSync(t)||Z.mkdirSync(t),Z.existsSync(t+"/!")||Z.writeFileSync(t+"/!",ve),{get:(r,n)=>{Z.readFile(t+"/"+r,(o,a)=>{if(o){if(o.code==="ENOENT"){n();return}console.log("fs.readFile error:",o)}a&&(a=a.toString()),n(o,a)})},put:(r,n,o)=>{var a=r+"."+D.random(9)+".tmp";Z.writeFile(a,n,w=>{if(w){console.log("fs.writeFile error:",w),o(w);return}Z.rename(a,t+"/"+r,o)})},list:r=>{Z.readdir(t,(n,o)=>{if(n){console.log("fs.readdir error:",n),r();return}o.forEach(r),r()})}};if(e.indexedDB){let r,n=indexedDB.open(t,1);return n.onupgradeneeded=o=>{o.target.result.createObjectStore(t)},n.onerror=o=>{console.log(o)},n.onsuccess=()=>{if(r=n.result,r){let a=r.transaction([t],"readonly").objectStore(t).getKey("!");a.onerror=()=>{console.log(`error getting key ${t}/!`)},a.onsuccess=()=>{if(!a.result){let d=r.transaction([t],"readwrite").objectStore(t).put(ve,"!");d.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(o,a)=>{let w=(l,m)=>{let T=r.transaction([t],"readonly").objectStore(t).get(l);T.onerror=()=>{console.log(`error getting ${t}/${l}`)},T.onsuccess=()=>{m(null,T.result)}};if(r){w(o,a);return}let d=0,f=setInterval(()=>{if(r){clearInterval(f),w(o,a);return}d++>5&&(clearInterval(f),a("error indexedDB not available"))},1e3)},put:(o,a,w)=>{let d=(m,v,T)=>{let s=r.transaction([t],"readwrite").objectStore(t).put(v,m);s.onerror=()=>{console.log(`error putting data on ${t}/${m}`)},s.onsuccess=()=>{T(null)}};if(r){d(o,a,w);return}let f=0,l=setInterval(()=>{if(r){clearInterval(l),d(o,a,w);return}f++>5&&(clearInterval(l),w("error indexedDB not available"))},1e3)},list:o=>{let a=f=>{let m=r.transaction([t],"readonly").objectStore(t).getAllKeys();m.onerror=()=>console.log("error getting keys for",t),m.onsuccess=()=>{m.result.forEach(f),f()}};if(r){a(o);return}let w=0,d=setInterval(()=>{if(r){clearInterval(d),a(o);return}w++>5&&(clearInterval(d),console.log("error indexedDB not available"),o())},1e3)}}}return{get:(r,n)=>{n(null,ve)},put:(r,n,o)=>{o(null)},list:r=>{r("!"),r()}}},Ye=e=>{L.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Qe(e));let t=Ne(e);return{get:(r,n)=>{if(!r||!L.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}var o=r["#"],a=typeof r["."]=="string"?r["."]:"",w;let d=(f,l)=>{V(r["."],l)&&(w||(w={_:{"#":o,">":{}}}),w[l]=f[0],w._[">"][l]=f[1])};t(o+Me+a,(f,l)=>{let m;L.is(l)?(q.map(l,d),w||d(l,a),m={[o]:w}):l&&(d(l,a),m={[o]:w}),n(f,m)})},put:(r,n)=>{if(!r){n("graph required");return}let o=0,a=!1,w=d=>{if(o--,!a){if(d){a=!0,n(d);return}o===0&&(a=!0,n(null))}};Object.keys(r).forEach(d=>{var f=r[d];Object.keys(f).forEach(l=>{if(l==="_")return;o++;let m=f[l],v=f._[">"][l];t(d+Me+l,[m,v],w)})})}}},De=Ye;var Ue=typeof document>"u",Pe=Ue?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Pe?.WebSocket);var Ze=e=>{let t=new Map,r=1e3,n=6e4,o=10,a=null;return e||(a=setInterval(()=>{let d=Date.now();for(let[f,l]of t.entries())d-l.lastCleanup>n&&(l.requests=[],l.lastCleanup=d),l.requests=l.requests.filter(m=>d-m<n),d-l.lastCleanup>n*10&&(l.throttleCount=0)},n/4)),{getDelay:d=>{let f=Date.now(),l=t.get(d)||{requests:[],lastCleanup:f,throttleCount:0};if(l.requests=l.requests.filter(m=>f-m<n),l.requests.length>=r){let m=Math.min(...l.requests),v=n-(f-m);return l.throttleCount=(l.throttleCount||0)+1,t.set(d,l),Math.max(0,v)}return l.requests.push(f),t.set(d,l),0},getRemainingRequests:d=>{let f=t.get(d);if(!f)return r;let l=Date.now(),m=f.requests.filter(v=>l-v<n);return Math.max(0,r-m.length)},getThrottleCount:d=>{let f=t.get(d);return f&&f.throttleCount||0},shouldDisconnect:d=>{let f=t.get(d);return f?f.throttleCount>=o:!1},destroy:()=>{a&&(clearInterval(a),a=null),t.clear()}}},Ve=(e,t=1024*1024)=>{try{if(typeof e=="string"&&e.length>t)throw new Error("Message too large");return{success:!0,data:JSON.parse(e)}}catch(r){return{success:!1,error:r.message}}},et=(e,t=1024*1024)=>typeof e=="string"&&e.length>t?{valid:!1,error:"Message too large"}:Buffer.isBuffer(e)&&e.length>t?{valid:!1,error:"Message too large"}:{valid:!0},tt=(e=1e3)=>{let t=new Set;return{add:r=>{if(t.size>=e)return!1;t.add(r);let n=r.close;return r.close=(...o)=>(t.delete(r),n.apply(r,o)),!0},remove:r=>{t.delete(r)},count:()=>t.size,isFull:()=>t.size>=e}},ke=(e=5)=>{let t=0;return{shouldRetry:()=>t<e,getDelay:()=>Math.min(1e3*Math.pow(2,t),3e4),increment:()=>t++,reset:()=>t=0}},rt=e=>{let t=xe(e.maxAge),r=De(e),n={},o={},a={},w=new Set,d=new Map,f=async x=>n[x]?!0:new Promise(k=>{r.get({"#":x},(y,S)=>{k(!y&&S&&S[x])})}),l=e.wss&&e.wss.constructor.name==="Server",m=Ze(l),v=tt(e.maxConnections||1e3),T=async(x,k,y)=>{for(let S of Object.keys(x)){let A=await new Promise(_=>{g({"#":S},_,k)});if(A.err)return y&&y(A.err),!1;let j=x[S],M=K;if(!(!A.put||!A.put[S]||A.put[S][M]===j[M]))return y&&y(`error in wire check public key does not match for soul: ${S}`),!1}return!0},i=(x,k)=>{let y=me(x.get,n);y?k(JSON.stringify({"#":t.track(D.random(9)),"@":x["#"],put:y})):r.get(x.get,(S,A)=>{k(JSON.stringify({"#":t.track(D.random(9)),"@":x["#"],put:A,err:S}))})},s=async(x,k)=>{let y=await Se.mix(x.put,n,e.secure,a);if(Object.keys(y.now).length===0){Object.keys(y.defer).length!==0&&setTimeout(()=>s({put:y.defer,"#":x["#"]},k),y.wait);return}await T(y.now,k)&&(r.put(y.now,S=>{k(JSON.stringify({"#":t.track(D.random(9)),"@":x["#"],err:S}))}),Object.keys(y.defer).length!==0&&setTimeout(()=>s({put:y.defer,"#":x["#"]},k),y.wait))},g=(x,k,y,S)=>{if(!k)return;L.is(S)||(S={});let A=me(x,n),j=D.random(9),M=JSON.stringify({"#":t.track(j),get:e.secure?{"#":x["#"]}:x});if(A){let _=y(M);if(_&&_.err){k({err:_.err});return}k({put:A});return}r.get(x,(_,R)=>{if(R){let B=y(M);if(B&&B.err){k({err:B.err});return}k({put:R,err:_});return}_&&console.log(_),o[j]=k,d.set(j,{lex:x,wait:S.wait||100});let N=y(M);if(N&&N.err){k({err:N.err}),delete o[j],d.delete(j);return}})},c=x=>({get:(k,y,S)=>{k&&k["#"]&&w.add(k["#"]),g(k,y,x,S)},put:async(k,y)=>{let S=await Se.mix(k,n,e.secure,a);if(Object.keys(S.now).length===0){y&&y(null);return}if(!await T(S.now,x,y))return;for(let[j,M]of Object.entries(S.now))if(M&&typeof M=="object")for(let[_,R]of Object.entries(M)){let N=U.is(R);N&&w.add(N)}r.put(S.now,y);let A=x(JSON.stringify({"#":t.track(D.random(9)),put:k}));if(A&&A.err){y&&y(A.err);return}},on:(k,y,S,A)=>{let j=k&&k["#"];!j||!y||(a[j]?a[j].push({".":k["."],cb:y}):a[j]=[{".":k["."],cb:y}],S&&g(k,y,x,A))},off:(k,y)=>{let S=k&&k["#"];if(!(!S||!a[S]))if(y){let A=a[S].find(j=>j.cb===y);A&&a[S].splice(a[S].indexOf(A),1)}else delete a[S]}});if(Ue){let x=e.wss,k=()=>x.clients();if(!x){let S=e.server?{server:e.server}:{port:e.port||8765};x=new Pe.WebSocketServer(S),k=()=>x.clients}let y=(S,A)=>{let M=JSON.parse(S)["#"];if(M&&d.has(M)){let _=d.get(M);d.delete(M),_.timeoutId=setTimeout(()=>{let R=o[M];if(R){let N=_.lex["#"],B={[N]:null};typeof _.lex["."]=="string"&&(B[N]={[_.lex["."]]:null}),R({put:B}),delete o[M]}},_.wait)}k().forEach(_=>{if(_&&_.readyState===WebSocket.OPEN)_.send(S,{binary:A});else{let R=_._retryHandler||ke();if(_._retryHandler=R,R.shouldRetry()){let N=R.getDelay();R.increment(),setTimeout(()=>{_&&_.readyState===WebSocket.OPEN&&(R.reset(),_.send(S,{binary:A}))},N)}}})};return x.on("connection",S=>{if(!v.add(S)){console.log("Connection limit reached, rejecting connection"),S.close(1013,"Connection limit reached - try again later");return}let A=D.random(9);console.log(`New WebSocket client connected: ${A}`),S.on("error",j=>{console.log("WebSocket error:",j),v.remove(S)}),S.on("close",()=>{console.log(`WebSocket client disconnected: ${A}`),v.remove(S)}),S.on("message",(j,M)=>{let _=et(j,e.maxMessageSize);if(!_.valid){console.warn(`Invalid message: ${_.error}`),S.send(JSON.stringify({error:_.error}));return}let R=Ve(j,e.maxMessageSize);if(!R.success){console.warn(`JSON parse error: ${R.error}`),S.send(JSON.stringify({error:"Invalid JSON"}));return}let N=R.data;if(t.check(N["#"]))return;let B=m.getDelay(A);if(B>0){let ne=m.getThrottleCount(A);if(console.log(`Client ${A}: rate limit exceeded, delay would be ${B}ms, dropping message (throttle count: ${ne})`),m.shouldDisconnect(A)){console.log(`Client ${A}: Disconnecting after ${ne} throttle violations`),S.close(1008,"Rate limit violations");return}S.send(JSON.stringify({"#":t.track(D.random(9)),"@":N["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(B/1e3)}s`,throttle:B}));return}let re=()=>{t.track(N["#"]),N.get&&i(N,y),N.put&&s(N,y),y(j,M);let ne=N["@"],le=o[ne];le&&(delete N["#"],delete N["@"],le(N),delete o[ne])};B>0?setTimeout(re,B):re()})}),c(y)}let u=[],p=!1,E=0,h=[],b=null,$=e.maxQueueLength||1e4,C=()=>{if(h.length===0){b=null;return}let x=Date.now();if(p&&x<E){b=setTimeout(C,Math.min(1e3,E-x));return}p&&x>=E&&(console.log("Throttle period ended, resuming queue processing"),p=!1,E=0);let k=h[0];if(O(k)){h.shift();let A=JSON.parse(k)["#"];if(A&&d.has(A)){let j=d.get(A);d.delete(A),j.timeoutId=setTimeout(()=>{let M=o[A];if(M){let _=j.lex["#"],R={[_]:null};typeof j.lex["."]=="string"&&(R[_]={[j.lex["."]]:null}),M({put:R}),delete o[A]}},j.wait)}}h.length>0?b=setTimeout(C,100):b=null},O=x=>{let k=!1;return u.forEach(y=>{if(y&&y.readyState===WebSocket.OPEN)y.send(x),k=!0;else{let S=y._retryHandler||ke();if(y._retryHandler=S,S.shouldRetry()){let A=S.getDelay();S.increment(),setTimeout(()=>{y&&y.readyState===WebSocket.OPEN&&(S.reset(),y.send(x))},A)}}}),k},I=x=>{if(h.length>=$)return{err:`Message queue exceeded maximum length (${$}). Update query logic to request less data.`,queueLength:h.length,maxQueueLength:$};h.push(x),b||(b=setTimeout(C,100))};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(x=>{let k=()=>{let y=new WebSocket(x);u.push(y);let S=ke();y.onclose=A=>{if(u.indexOf(y)!==-1&&u.splice(u.indexOf(y),1),y=null,S.shouldRetry()){let j=S.getDelay();S.increment(),setTimeout(k,j)}},y.onopen=()=>{S.reset()},y.onerror=A=>{console.log(A)},y.onmessage=async A=>{let j=JSON.parse(A.data);if(t.check(j["#"]))return;if(j.throttle&&j.err){console.log(`Server throttling: ${j.err}`),p=!0,E=Date.now()+j.throttle;return}if(t.track(j["#"]),j.get&&i(j,I),j.put){let R={};for(let[N,B]of Object.entries(j.put)){let re=!1;if(await f(N)&&(re=!0,B&&typeof B=="object"))for(let[ne,le]of Object.entries(B)){let Ee=U.is(le);Ee&&w.add(Ee)}w.has(N)&&(re=!0,w.delete(N)),re&&(R[N]=B)}if(Object.keys(R).length>0){let N={put:R,"#":j["#"]};s(N,I)}}let M=j["@"],_=o[M];_&&(delete j["#"],delete j["@"],_(j),delete o[M])}};k()}),c(I)},ye=rt;var nt=(e,t)=>{t||(t=ye(e));let r=[],n=!1,o=!1,a=0,w=(f,l,m,v)=>{let T=c=>{a++,w(c,l,m,v)},i=c=>{r=[],a=0,o=!1,v(c)},s=()=>{if(r.length===0){i("Wrong username or password");return}let c=r.shift();t.get({"#":c},async u=>{if(u.err){i(`error getting ${c}: ${u.err}`);return}let p=u.put&&u.put[c];if(!p||!p.auth)return s();let E=JSON.parse(p.auth),h=await H.work(l,E.salt),b=await H.decrypt(E.enc,h);if(!b)return s();if(d.is={username:f,pub:p.pub,epub:p.epub,priv:b.priv,epriv:b.epriv},m!==""){let $=D.random(64),C=await H.work(m,$),O=await H.encrypt(b,C),I={username:f,pub:p.pub,epub:p.epub,auth:JSON.stringify({enc:O,salt:$})},x=await H.sign(I,d.is),k=X(c,x.m,x.s,p.pub);t.put(k,y=>{i(y?`error putting ${I} on ${c}: ${y}`:null)});return}return i(null)},{wait:1e3})};if(a>9){i("Wrong username or password");return}let g="~@"+f;t.get({"#":g},async c=>{if(c.err){i(`error getting ${g}: ${c.err}`);return}let u=c.put&&c.put[g];if(!u)return T(f);delete c.put[g]._,r=Object.keys(u),s()},{wait:1e3})},d={create:(f,l,m)=>{let v=i=>{m?m(i):console.log(i)};if(n){v("User is already being created");return}if(f===""){v("Please provide a username");return}if(l===""){v("Please provide a password");return}n=!0;let T="~@"+f;t.get({"#":T},async i=>{if(i.err){n=!1,v(`error getting ${T}: ${i.err}`);return}if(i.put&&i.put[T]){n=!1,v("Username already exists");return}let s=D.random(64),g=await H.work(l,s),c=await H.pair(),u={priv:c.priv,epriv:c.epriv},p=await H.encrypt(u,g),E={username:f,pub:c.pub,epub:c.epub,auth:JSON.stringify({enc:p,salt:s})},h="~"+c.pub,b=await H.sign(E,c),$=X(h,b.m,b.s,c.pub);t.put($,C=>{if(n=!1,C){v(`error putting ${E} on ${h}: ${C}`);return}let O={[h]:{"#":h}};t.put(X(T,O),I=>{if(I){v(`error putting ${O} on ${T}: ${I}`);return}m&&m(null)})})},{wait:1e3})},auth:(f,l,m)=>{let v=T=>{m?m(T):T&&console.log(T)};if(o){v("User is already authenticating");return}if(d.is=null,f===""){v("Please provide a username");return}if(l===""){v("Please provide a password");return}o=!0,w(f,l,"",v)},change:(f,l,m,v)=>{let T=i=>{v?v(i):i&&console.log(i)};if(o){T("User is already authenticating");return}if(d.is=null,f===""){T("Please provide a username");return}if(l===""){T("Please provide a password");return}if(m===""){T("Please provide a new password");return}o=!0,w(f,l,m,T)},store:f=>{if(!d.is){console.log("Please authenticate before calling store");return}if(f){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let f=globalThis.localStorage.getItem("user.is");if(f){d.is=JSON.parse(f);return}}if(typeof globalThis.sessionStorage<"u"){let f=globalThis.sessionStorage.getItem("user.is");f&&(d.is=JSON.parse(f))}},leave:()=>{d.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(f,l,m)=>{let v=T=>{m?m(T):console.log(T)};if(o){v("User is already authenticating");return}if(f===""){v("Please provide a username");return}if(l===""){v("Please provide a password");return}o=!0,w(f,l,"",async T=>{if(T){v(T);return}let i={username:null,pub:null,epub:null,auth:null},s=await H.sign(i,d.is),g="~"+d.is.pub,c=X(g,s.m,s.s,d.is.pub);t.put(c,u=>{if(u){v(`error putting null on ${g}: ${u}`);return}d.is=null,m&&m(null)})})}};return d},Le=nt;var ot=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:L.is(e)||(e={});let t=ye(e),r=Le(null,t),n=new Map,o=new Map,a=f=>f===null||f===!0||f===!1||typeof f=="string"||U.is(f)||ae.is(f),w=f=>{if(a(f))return!0;if(L.is(f)){let m=[];for(let[v,T]of Object.entries(f)){if(v==="_")return"error underscore cannot be used as a property name";if(L.is(T)||a(T)){m.push(v);continue}return typeof T>"u"?`error undefined ${v} cannot be converted to a graph`:`error ${JSON.stringify({[v]:T})} cannot be converted to a graph`}if(m.length!==0)return m}return`error ${JSON.stringify(f)} cannot be converted to a graph`},d=f=>{let l=(i,s,g,c)=>{t.get(L.put(i,"#",s),async u=>{if(u.err&&console.log(u.err),u.put&&u.put[s]){delete u.put[s]._,delete u.put[s][K],delete u.put[s][W];for(let p of Object.keys(u.put[s])){let E=U.is(u.put[s][p]);if(E){let h=async(b=0)=>{let $=await new Promise(C=>{let O=D.random();o.set(O,{chain:[{item:null,soul:E}]}),d(O).next(null,C,c)});return $!==null||b>=5?$:(await new Promise(C=>setTimeout(C,50)),h(b+1))};u.put[s][p]=await h()}}g(u.put[s])}else g(null)},c)},m=async(i,s,g,c)=>{if(g){let u=await H.sign(s,g);return X(i,u.m,u.s,g.pub)}return e.secure?(c||(c=console.log),c(`error putting data on ${i}: user required in secure mode`),null):X(i,s)},v=i=>s=>{let g=o.get(i);g&&typeof g.cb<"u"?setTimeout(()=>g.cb(s),1):s&&console.log("error no callback for data",s,"ctx",g),g&&!g.on&&o.delete(i)},T=(i,s)=>{if(!i){console.log("error resolve request parameter required");return}let g=typeof i.get<"u",c=typeof i.put<"u",u=typeof i.on<"u",p=typeof i.off<"u",E=!1,h=o.get(f);for(var b=1;b<h.chain.length;b++)if(h.chain[b].soul===null){E=!0;break}if(E){let{item:$,soul:C}=h.chain[b-1],O=h.user||e.secure?{"#":C}:{"#":C,".":$};return t.get(O,async I=>{if(I.err){h.user||e.secure?console.log(`error getting ${C}: ${I.err}`):console.log(`error getting ${$} on ${C}: ${I.err}`),s&&s(null);return}let x=I.put&&I.put[C];if(x&&typeof x[$]<"u"){let k=U.is(x[$]);if(k)h.chain[b].soul=k,o.set(f,{...h}),g?d(f).next(null,i.get,s,i._opt):c?d(f).put(i.put,s):u?d(f).on(i.on,s,i._get,i._opt):p&&d(f).off(s);else if(g)s(x[$]);else if(c){k=D.random(),x[$]=U.ify(k);let y=await m(C,x,h.user,s);if(y===null)return;t.put(y,S=>{if(S){s(`error putting ${$} on ${C}: ${S}`);return}h.chain[b].soul=k,d(f).put(i.put,s)})}else(u||p&&s)&&s(null)}else if(c){let k=D.random();x||(x={}),x[$]=U.ify(k);let y=await m(C,x,h.user,s);if(y===null)return;t.put(y,S=>{if(S){s(`error putting ${$} on ${C}: ${S}`);return}h.chain[b].soul=k,d(f).put(i.put,s)})}else s&&s(null)},i._opt),!1}return g&&h.chain[h.chain.length-1].item!==null?(h.chain.push({item:null,soul:null}),d(f).next(null,i.get,s,i._opt),!1):h.chain[h.chain.length-1]};return{get:(i,s,g,c)=>{if(typeof s=="function"&&(c=g,g=s,s=null),i===null||i===""||i==="_"){console.log("error please provide a key"),g&&g(null);return}if(s&&typeof g!="function"){console.log("error lex requires a callback function");return}if(f=D.random(),o.set(f,{chain:[{item:i,soul:"root"}],cb:g}),!g)return d(f);let u=v(f),{soul:p}=T({get:s,_opt:c},u);p&&l(s,p,u,c)},next:(i,s,g,c)=>{let u=b=>$=>{g?g($):v(b)($)};if(typeof s=="function"&&(c=g,g=s,s=null),!f){console.log("error please provide a key using get(key)"),g&&g(null);return}let p=u(f);if(i===""||i==="_"){p(null);return}if(s&&typeof g!="function"){console.log("error lex requires a callback function");return}let E=o.get(f);if(!E)return;if(g&&typeof E.cb>"u"&&(E.cb=g,g=null),i!==null&&E.chain.push({item:i,soul:null}),!E.cb)return d(f);let{soul:h}=T({get:s,_opt:c},p);h&&l(s,h,p,c)},put:(i,s,g)=>{typeof s=="function"&&(g=s,s=!1);let c=C=>O=>{g?g(O):v(C)(O)};if(!f){g&&g("error please provide a key using get(key)");return}let u=o.get(f);if(!u)return;if(!u.cb){if(!g)return;u.cb=g,g=null}s&&(i={[D.random()]:i});let p=c(f),E=w(i);if(typeof E=="string"){p(E);return}let{item:h,soul:b}=T({put:i},p);if(!b)return;if(E===!0){let C=u.user||e.secure?{"#":b}:{"#":b,".":h};t.get(C,async O=>{if(O.err){p(`error getting ${b}: ${O.err}`);return}let I=O.put&&O.put[b],x=I&&I[h],k=U.is(x);if(!k){I||(I={}),I[h]=i;let y=await m(b,I,u.user,p);if(y===null)return;t.put(y,p);return}t.get({"#":k},async y=>{if(y.err){p(`error getting ${k}: ${y.err}`);return}if(!y.put||!y.put[k]){p(`error ${k} not found`);return}for(let A of Object.keys(y.put[k])){if(A==="_"||A===K||A===W)continue;let j=await new Promise(M=>{let _=D.random(),R=[{item:A,soul:k}];o.set(_,{chain:R,user:u.user}),d(_).put(null,M)});if(j){p(j);return}}I||(I={}),I[h]=i;let S=await m(b,I,u.user,p);S!==null&&t.put(S,p)})});return}let $=u.user||e.secure?{"#":b}:{"#":b,".":h};t.get($,async C=>{if(C.err){p(`error getting ${b}.${h}: ${C.err}`);return}let O=C.put&&C.put[b],I=O&&O[h],x=U.is(I);if(!x){O||(O={}),O[h]=U.ify(D.random());let y=await m(b,O,u.user,p);if(y===null)return;t.put(y,S=>{if(S)p(`error putting ${h} on ${b}: ${S}`);else{let A=D.random(),j=[{item:h,soul:b}];o.set(A,{chain:j,user:u.user,cb:u.cb}),d(A).put(i)}});return}let k=[];for(let y of E){let S=await new Promise(A=>{if(L.is(i[y])&&!U.is(i[y])){let j=D.random(),M=[{item:y,soul:x}];o.set(j,{chain:M,user:u.user}),d(j).put(i[y],A)}else k.push(y),A(null)});if(S){p(S,f);return}}if(k.length===0){p(null);return}t.get({"#":x},async y=>{if(y.err){p(`error getting ${x}: ${y.err}`);return}let S=y.put&&y.put[x];S||(S={}),k.forEach(j=>{S[j]=i[j]});let A=await m(x,S,u.user,p);A!==null&&t.put(A,p)})})},on:(i,s,g,c)=>{if(typeof i=="function"&&(c=g,g=s,s=i,i=null),typeof s!="function"){console.log("error on() requires a callback function");return}if(!f){console.log("error please provide a key using get(key)"),s(null);return}let{item:u,soul:p}=T({on:i,_get:g,_opt:c},s);if(!p)return;o.set(f,{chain:[{item:u,soul:p}],on:!0}),n.set(s,()=>{t.get({"#":p,".":u},h=>{let b=h.put&&h.put[p]&&h.put[p][u],$=U.is(b);if($){let C=async(O=0)=>{let I=await new Promise(x=>{let k=D.random();o.set(k,{chain:[{item:null,soul:$}]}),d(k).next(null,x,c)});I!==null||O>=5?s(I):(await new Promise(x=>setTimeout(x,50)),C(O+1))};C()}else s(b!==void 0?b:null)},c)});let E;i?E=L.put(i,"#",p):E={"#":p,".":u},t.on(E,n.get(s),!1,c),t.get({"#":p,".":u},h=>{if(h.err){console.log(`error getting ${p}.${u}: ${h.err}`);return}let b=h.put&&h.put[p]&&h.put[p][u],$=U.is(b);if($){t.off(E,n.get(s));let C;i?C=L.put(i,"#",$):C={"#":$,".":null},t.on(C,n.get(s),g,c)}else g&&n.get(s)()},c)},off:i=>{if(!f){console.log("error please provide a key using get(key)"),i&&i(null);return}let{item:s,soul:g}=T({off:!0},i);g&&t.get({"#":g,".":s},c=>{if(c.err){console.log(`error getting ${g}.${s}: ${c.err}`);return}let u=c.put&&c.put[g]&&c.put[g][s],p=U.is(u);p?t.off({"#":p},n.get(i)):t.off({"#":g},n.get(i)),n.delete(i),o.delete(f)})},user:()=>(r.get||(Object.assign(r,d()),r.get=(i,s,g,c)=>{typeof s=="function"&&(c=g,g=s,s=null);let u=null,p=null;if(r.is&&(u=r.is.pub),typeof i=="string"?p=i:i instanceof Array&&(i.length===2?(u=i[0],p=i[1]):i.length===1&&(p=i[0])),!u){console.log("error please log in or provide a public key"),g&&g(null);return}if(p===null||p===""||p==="_"){console.log("error please provide a key"),g&&g(null);return}if(s&&!g){console.log("error lex requires a callback function");return}f=D.random();let E=[{item:p,soul:"~"+u}];if(o.set(f,{chain:E,user:r.is,cb:g}),!g)return d(f);let h=v(f),{soul:b}=T({get:s,_opt:c},h);b&&l(s,b,h,c)}),r),wire:t,SEA:H}};return d()},Mt=ot;export{Mt as default};
//# sourceMappingURL=holster.js.map
