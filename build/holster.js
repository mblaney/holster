var ae={is:t=>{if(t instanceof Array)return!1;if(typeof t=="number")return!isNaN(t);if(typeof t=="string"){let e=parseFloat(t);return!isNaN(e)&&isFinite(e)}return!1}},L={is:t=>{if(!t||typeof t!="object")return!1;let r=Object.prototype.toString.call(t).match(/^\[object (\w+)\]$/);return t.constructor===Object||r&&r[1]==="Object"},map:(t,e,r)=>{var n=Object.keys(t);for(let i=0;i<n.length;i++){let s=e(t[n[i]],n[i],r);if(typeof s<"u")return s}},put:(t,e,r)=>(t||(t={}),t[e]=r,t),del:(t,e)=>{if(t)return t[e]=null,delete t[e],t}},Le=(t,e,r)=>{if(r.id){r.id=!1;return}if(e==="#"&&typeof t=="string"){r.id=t;return}r.id=!1},U={is:t=>{if(t&&t["#"]&&!t._&&L.is(t)){let e={};if(L.map(t,Le,e),e.id)return e.id}return!1},ify:t=>L.put({},"#",t)},G="_holster_user_signature",M="_holster_user_public_key",z=(t,e,r,n,i)=>{let s={[t]:{_:{"#":t,">":{}}}};for(let[m,d]of Object.entries(e))m!=="_"&&m!==M&&m!==G&&(s[t][m]=d,s[t]._[">"][m]=i||Date.now());if(r&&n&&i){if(s[t]._.s={},typeof r=="string")s[t]._.s[i]=r;else if(typeof r=="object")for(let[m,d]of Object.entries(r))s[t]._.s[m]=d;s[t][M]=n,s[t]._[">"][M]=i}return s},V=(t,e)=>{if(typeof e>"u")return t===null;if(typeof t>"u")return!0;if(typeof t=="string")return t===e;if(!L.is(t)||!e)return!1;let r=t["*"];if(r)return e.slice(0,r.length)===r;let n=t[">"],i=t["<"];return n&&i?e>=n&&e<=i:n?e>=n:i?e<=i:!1},P={random:t=>{var e="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";t||(t=24);for(let n=0;n<t;n++)e+=r.charAt(Math.floor(Math.random()*r.length));return e}};var Be=t=>{t||(t=9e3);let e={store:{}};return e.check=r=>e.store[r]?e.track(r):!1,e.track=r=>(e.store[r]=Date.now(),e.expiry||(e.expiry=setTimeout(()=>{if(e.expiry)return;let n=Date.now();Object.keys(e.store).forEach(i=>{n-e.store[i]>t&&delete e.store[i]}),e.expiry=null},t)),r),e},ke=Be;var He=(t,e)=>{if(!t||typeof t!="object")throw new TypeError("lex must be an object");if(!e||typeof e!="object")throw new TypeError("graph must be an object");let r=t["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!e[r])return;let n={_:{"#":r,">":{}}},i={};if(typeof t["."]=="string"){let s=t["."];if(typeof e[r][s]>"u")return;n[s]=e[r][s],n._[">"][s]=e[r]._[">"][s];let m=e[r]._[">"][s];if(e[r]._.s&&(e[r]._.s[m]?i[m]=e[r]._.s[m]:e[r]._.s[s]&&(i[s]=e[r]._.s[s])),M&&typeof e[r][M]<"u"){n[M]=e[r][M],n._[">"][M]=e[r]._[">"][M];let d=e[r]._[">"][M];e[r]._.s&&(e[r]._.s[d]?i[d]=e[r]._.s[d]:e[r]._.s[M]&&(i[M]=e[r]._.s[M]))}}else for(let s of Object.keys(e[r]))if(s===M||V(t["."],s)){n[s]=e[r][s],n._[">"][s]=e[r]._[">"][s];let m=e[r]._[">"][s];e[r]._.s&&(e[r]._.s[m]?i[m]=e[r]._.s[m]:e[r]._.s[s]&&(i[s]=e[r]._.s[s]))}return Object.keys(i).length>0&&(n._.s=i),{[r]:n}},ye=He;typeof btoa>"u"&&(globalThis.btoa=t=>Buffer.from(t,"binary").toString("base64"),globalThis.atob=t=>Buffer.from(t,"base64").toString("binary"));function fe(){}Object.assign(fe,{from:Array.from});fe.prototype=Object.create(Array.prototype);fe.prototype.toString=function(t,e,r){if(t||(t="utf8"),e||(e=0),r=r?Math.min(Math.max(r,e),this.length):this.length,t==="hex"){let n=new Uint8Array(this.slice(e,r));return Array.from(n,i=>i.toString(16).padStart(2,"0")).join("")}if(t==="utf8")return Array.from({length:r-e},(n,i)=>{let s=this[i+e];return s<0||s>1114111?"\uFFFD":String.fromCharCode(s)}).join("");if(t==="base64"){let n=Array.from({length:r-e},(i,s)=>{let m=this[s+e];return m<0||m>255?"\uFFFD":String.fromCharCode(m)}).join("");return btoa(n)}};var X=fe;var ce={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function Q(...t){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),Q.from(...t)}Q.prototype=Object.create(Array.prototype);var oe=(t,e)=>{if(typeof t!="string")throw new TypeError("Input must be a string for encoding: "+e);if(t.length>ce.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${t.length} > ${ce.MAX_STRING_LENGTH}`)},W=(t,e="buffer operation")=>{if(t>ce.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${e}: ${t} > ${ce.MAX_BUFFER_SIZE}`)},Fe=t=>{oe(t,"hex");let e=t.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(e))throw new TypeError("Invalid hex string: contains non-hex characters");if(e.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(e.length===0)return new Uint8Array(0);W(e.length/2,"hex parsing");let r=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2){let i=e.substr(n,2);r[n/2]=parseInt(i,16)}return r},Ee=t=>{oe(t,"utf8");try{let r=new TextEncoder().encode(t);return W(r.length,"UTF-8 encoding"),r}catch(e){throw new TypeError("Failed to encode UTF-8 string: "+e.message)}},Ke=t=>{oe(t,"binary"),W(t.length,"binary encoding");let e=new Uint8Array(t.length);for(let r=0;r<t.length;r++){let n=t.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);e[r]=n}return e},Je=t=>{oe(t,"base64");let e=t.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(e))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(e);W(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let i=0;i<r.length;i++)n[i]=r.charCodeAt(i);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},Ae=t=>{let e;if(t instanceof ArrayBuffer)W(t.byteLength,"ArrayBuffer processing"),e=new Uint8Array(t);else if(ArrayBuffer.isView(t))W(t.byteLength||t.length,"TypedArray processing"),e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);else if(Array.isArray(t)){W(t.length,"Array processing");for(let r=0;r<t.length;r++){let n=t[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}e=new Uint8Array(t)}else if(typeof t=="object"&&t!==null&&typeof t.length=="number"){W(t.length,"array-like processing");let r=Array.from(t);for(let n=0;n<r.length;n++){let i=r[n];if(typeof i!="number"||i<0||i>255||!Number.isInteger(i))throw new TypeError(`Invalid byte value at index ${n}: ${i} (must be integer 0-255)`)}e=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof t);return e};Object.assign(Q,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let e=arguments[0];if(e==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof e=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=Fe(e);break;case"utf8":case"utf-8":r=Ee(e);break;case"binary":case"latin1":r=Ke(e);break;case"base64":r=Je(e);break;case"ascii":oe(e,"ascii");for(let i=0;i<e.length;i++)if(e.charCodeAt(i)>127)throw new TypeError(`Invalid ASCII character at position ${i}: ${e.charCodeAt(i)} > 127`);r=Ee(e);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=Ae(e);if(!r||r.length===0)return X.from(new Uint8Array(0));try{return X.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(t,e=0){if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Length must be a non-negative integer");if(W(t,"buffer allocation"),typeof e=="number"){if(e<0||e>255||!Number.isInteger(e))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof e=="string"){if(e.length!==1)throw new TypeError("Fill string must be exactly one character");if(e=e.charCodeAt(0),e>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(t);return e!==0&&r.fill(e),X.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(t){if(!Array.isArray(t))throw new TypeError("First argument must be an array");if(t.length===0)return X.from(new Uint8Array(0));let e=0,r=[];for(let n=0;n<t.length;n++){let i=t[n];if(!i)throw new TypeError(`Array element at index ${n} is null or undefined`);let s;try{s=Ae(i)}catch(m){throw new TypeError(`Invalid array element at index ${n}: ${m.message}`)}e+=s.length,W(e,"buffer concatenation"),r.push(s)}try{let n=new Uint8Array(e),i=0;for(let s of r)n.set(s,i),i+=s.length;return X.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(t){return t instanceof X||t&&typeof t=="object"&&t.constructor===Q},byteLength(t,e="utf8"){if(typeof t!="string")throw new TypeError("First argument must be a string");switch(e.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(t).length;case"ascii":case"binary":case"latin1":return t.length;case"base64":let r=t.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(t.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+e)}}});Q.prototype.from=Q.from;Q.prototype.toString=function(t="utf8",e=0,r=this.length){if(typeof t!="string")throw new TypeError("Encoding must be a string");if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<e)throw new TypeError("End must be an integer >= start");try{return X.prototype.toString.call(this,t,e,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var K=Q;var qe=typeof document>"u",je=qe?(await import("node:crypto")).webcrypto:globalThis.crypto,R=je.subtle,ge=t=>typeof t=="string"?t:JSON.stringify(t),ue=t=>{try{return JSON.parse(t)}catch{return t}},de=t=>{let e=new Uint8Array(K.alloc(t));return K.from(je.getRandomValues(e))},Y=(t,e)=>{let[r,n]=t.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:e,ext:!0,key_ops:e?["sign"]:["verify"]}},te=async t=>{let e=await R.digest({name:"SHA-256"},new TextEncoder().encode(ge(t)));return K.from(e)},me=async(t,e)=>{let r=t+e.toString("utf8"),n=K.from(await te(r),"binary"),i=We(n);return await R.importKey("jwk",i,{name:"AES-GCM"},!1,["encrypt","decrypt"])},We=t=>({kty:"oct",k:t.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var ze={pair:async t=>{let e=await R.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async i=>{let s=await R.exportKey("jwk",i.publicKey);return{priv:(await R.exportKey("jwk",i.privateKey)).d,pub:s.x+"."+s.y}}),r=await R.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async i=>{let s=await R.exportKey("jwk",i.publicKey);return{epriv:(await R.exportKey("jwk",i.privateKey)).d,epub:s.x+"."+s.y}}),n={pub:e.pub,priv:e.priv,epub:r.epub,epriv:r.epriv};return t&&t(n),n},encrypt:async(t,e,r)=>{if(!e||!e.epriv)return r&&r(null),null;let n={s:de(9),iv:de(15)},i=await me(e.epriv,n.s).then(m=>R.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},m,new TextEncoder().encode(ge(t)))),s={ct:K.from(i,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(s),s},decrypt:async(t,e,r)=>{if(!t||!t.ct||!t.iv||!t.s||!e||!e.epriv)return r&&r(null),null;let n={ct:K.from(t.ct,"base64"),iv:K.from(t.iv,"base64"),s:K.from(t.s,"base64")};try{let i=await me(e.epriv,n.s).then(m=>R.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},m,new Uint8Array(n.ct))),s=ue(new TextDecoder("utf8").decode(i));return r&&r(s),s}catch{return r&&r(null),null}},verify:async(t,e,r)=>{if(!e||!e.pub)return r&&r(null),null;let n=ue(t),i=await R.importKey("jwk",Y(e.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),s={};if(typeof n.m=="string")s=n.m;else for(let h of Object.keys(n.m).sort())h!=="_"&&h!==M&&h!==G&&(s[h]=n.m[h]);let m=await te(s),d=new Uint8Array(K.from(n.s,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}};if(await R.verify(a,i,d,new Uint8Array(m))){let h=ue(n.m);return r&&r(h),h}return r&&r(null),null},sign:async(t,e,r)=>{if(!e||!e.pub||!e.priv)return r&&r(null),null;let n={};if(typeof t=="string")n=t;else{let h=ue(t);for(let S of Object.keys(h).sort())S!=="_"&&S!==M&&S!==G&&(n[S]=h[S])}let i=await te(n),s=Y(e.pub,e.priv),m={name:"ECDSA",namedCurve:"P-256"},d=await R.importKey("jwk",s,m,!1,["sign"]).then(h=>R.sign({name:"ECDSA",hash:{name:"SHA-256"}},h,new Uint8Array(i))),a={m:n,s:K.from(d,"binary").toString("base64")};return r&&r(a),a},signTimestamp:async(t,e,r)=>{if(!e||!e.pub||!e.priv)return r&&r(null),null;let n=t.toString(),i=await te(n),s=Y(e.pub,e.priv),m={name:"ECDSA",namedCurve:"P-256"},d=await R.importKey("jwk",s,m,!1,["sign"]).then(h=>R.sign({name:"ECDSA",hash:{name:"SHA-256"}},h,new Uint8Array(i))),a=K.from(d,"binary").toString("base64");return r&&r(a),a},verifyTimestamp:async(t,e,r,n)=>{if(!r||!t||!e)return n&&n(!1),!1;try{let i=t.toString(),s=await te(i),m=await R.importKey("jwk",Y(r),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),d=new Uint8Array(K.from(e,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}},h=await R.verify(a,m,d,new Uint8Array(s));return n&&n(h),h}catch(i){return console.log(`error verifying timestamp signature: ${i.message}`),n&&n(!1),!1}},verifyProperties:async(t,e,r)=>{if(!e||!t)return r&&r([]),[];let n=await R.importKey("jwk",Y(e),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),i={name:"ECDSA",hash:{name:"SHA-256"}},s=[],m=t._&&t._.s||{};for(let d of Object.keys(t).sort()){if(d==="_"||d==M)continue;let a=m[d];if(a)try{let h=await te(t[d]),S=new Uint8Array(K.from(a,"base64"));await R.verify(i,n,S,new Uint8Array(h))?s.push(d):console.log(`warning: property '${d}' signature verification failed`)}catch(h){console.log(`warning: property '${d}' error verifying: ${h.message}`)}}return r&&r(s),s},work:async(t,e,r)=>{typeof e=="function"&&(r=e,e=void 0),typeof e>"u"&&(e=de(9));let n=await R.importKey("raw",new TextEncoder().encode(ge(t)),{name:"PBKDF2"},!1,["deriveBits"]),i={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(e),hash:{name:"SHA-256"}},s=await R.deriveBits(i,n,512),m={epriv:K.from(s,"binary").toString("base64")};return r&&r(m),m},secret:async(t,e,r)=>{if(!t||!t.epub||!e||!e.epub||!e.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},i=Y(t.epub),s=await R.importKey("jwk",i,n,!0,[]),m=Y(e.epub,e.epriv,!1);delete m.key_ops;let d=await R.importKey("jwk",m,n,!1,["deriveBits"]).then(async a=>{let h=await R.deriveBits({public:s,name:"ECDH",namedCurve:"P-256"},a,256),S=await R.importKey("raw",new Uint8Array(h),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return R.exportKey("jwk",S).then(({k:f})=>f)});return r&&r({epriv:d}),{epriv:d}}},H=ze;var $e=100,xe=1e4,we=(t,e,r,n,i=!1)=>t<e?{historical:!0}:t>e?{incoming:!0}:i&&r!==n?(console.log(`Signed timestamp ${t}: reject conflicting value`),{historical:!0}):(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});we.mix=async(t,e,r,n)=>{if(!t||typeof t!="object")throw new TypeError("change must be an object");if(!e||typeof e!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let i=Date.now(),s={},m={},d=new Map,a=new Map,h=0;for(let f of Object.keys(t)){let w=t[f],o=!1,l=!1,p=0,g=r;if(!w||!w._)continue;let c=w[M];if(w._.s&&c&&(g=!0),f.length>1&&f[0]==="~")if(f[1]==="@")l=!0,g=!1;else{if(c&&f!="~"+c){console.log(`error public key does not match for soul: ${f}`);continue}g=!0}if(g){if(!c||!w._)continue;let u=new Set,T=new Set;for(let[_,C]of Object.entries(w._.s||{})){let A=Number(_);if(!isNaN(A)&&A>0&&await H.verifyTimestamp(A,C,c)){u.add(A);for(let[k,v]of Object.entries(w._[">"]||{}))Number(v)===A&&T.add(k)}}if((await H.verifyProperties(w,c)).forEach(_=>T.add(_)),T.size===0)continue;d.set(f,T),a.set(f,u)}for(let u of Object.keys(w)){if(u==="_"||d.has(f)&&!d.get(f).has(u))continue;let T=w[u],y=w._&&w._[">"]?w._[">"][u]:0,_=(e[f]||{})[u],C=(e[f]||{_:{">":{}}})._[">"][u]||0;if(l&&u!==U.is(T)){console.log(`error alias ${l}: ${u} !== ${U.is(T)}`);continue}let A=y-i;if(A>0){if(A>864e5)continue;(h===0||A<h)&&(h=p=A),m[f]||(m[f]={_:{"#":f,">":{},s:{}}}),m[f][u]=T,m[f]._[">"][u]=y,w._.s&&(w._.s[y]?m[f]._.s[y]=w._.s[y]:w._.s[u]&&(m[f]._.s[u]=w._.s[u]))}else{let x=a.has(f)&&a.get(f).has(y);we(y,C,T,_,x).incoming&&(s[f]||(s[f]={_:{"#":f,">":{},s:{}}}),e[f]||(e[f]={_:{"#":f,">":{},s:{}}}),e[f][u]=s[f][u]=T,e[f]._[">"][u]=s[f]._[">"][u]=y,w._.s&&(w._.s[y]?e[f]._.s[y]=s[f]._.s[y]=w._.s[y]:w._.s[u]&&(e[f]._.s[u]=s[f]._.s[u]=w._.s[u])),n[f]&&setTimeout(()=>{n[f]&&n[f].filter(v=>V(v["."],u)).forEach(v=>v.cb())},$e),o=!0)}}o&&n[f]&&setTimeout(()=>{n[f]&&n[f].filter(u=>V(u["."])).forEach(u=>u.cb())},$e)}let S=Object.keys(e);return S.length>xe&&S.map(o=>{let l=e[o]._&&e[o]._[">"],p=l?Math.max(...Object.values(l)):0;return{soul:o,maxState:p}}).sort((o,l)=>o.maxState-l.maxState).slice(0,S.length-xe).forEach(({soul:o})=>delete e[o]),{now:s,defer:m,wait:h}};var be=we;var q="",se="",Ce=()=>{let t=(e,r,n)=>{if(n||(t[q]||(t[q]={}),n=t[q]),!e)return n;let i=0,s={},m=e[i],d=e.length-1,a=typeof r>"u",h=n[m];for(;!h&&i<d;)m+=e[++i],h=n[m];if(h)if(i===d){if(a)return typeof h[se]>"u"?h[q]:h[se];h[se]=r}else return!h[q]&&!a&&(h[q]={}),t(e.slice(++i),r,h[q]);else if(L.map(n,(f,w)=>{let o=0,l="";for(;w[o]===e[o];)l+=w[o++];if(l){if(a)return o<=d?void 0:(s[w.slice(o)]=f,f);let p={[w.slice(o)]:f,[e.slice(o)]:{[se]:r}};return n[l]={[q]:p},delete n[w],!0}})){if(a)return s}else{if(a)return;n[m]||(n[m]={}),n[m][se]=r}};return t};Ce.map=function t(e,r,n,i){i||(i=[]);var s=e[q]||e,m=Object.keys(s).sort(),d;for(let a=0;a<m.length;a++){let h=m[a],S=s[h],f=S[se];if(typeof f<"u"){if(f=r(f,i.join("")+h,h,i),typeof f<"u")return f}else n&&r(d,i.join(""),h,i);if(S[q]){if(i.push(h),f=t(S[q],r,n,i),typeof f<"u")return f;i.pop()}}};var J=Ce;var Se="",Oe="",F="",re=t=>{var e;let r=new Map,n=null,i=0,s=1e4,m=new Map,d=0,a=3e4,h=.8,S=.9;if(t||(t={}),t.log||(t.log=console.log),t.batch||(t.batch=100),t.write||(t.write=1),t.size||(t.size=1024*1024),t.memoryLimit||(t.memoryLimit=500),t.readTimeout||(t.readTimeout=1e3),typeof t.cache>"u"&&(t.cache=!0),!t.store){t.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!t.store.get){t.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!t.store.put){t.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!t.store.list){t.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let f=(l,p,g,c)=>{let u=Date.now()-p;u>2e3&&console.log(`[RADISK-SLOW] ${l}: ${u}ms for ${g}${c?` (${c} bytes)`:""}`)},w=()=>{if(typeof process>"u"||!process.memoryUsage)return;let l=Date.now();if(l-d<a)return;d=l;let p=process.memoryUsage(),g=p.heapUsed,c=p.heapTotal,u=t.memoryLimit*1024*1024,T=g/u;if(T>S){let y=r.size;console.log(`[RADISK-MEMORY] High memory usage: ${Math.round(T*100)}% of heap limit. Clearing ${y} cached files.`),r.clear(),global.gc&&global.gc(),d=l+a}else T>h&&console.log(`[RADISK-MEMORY] Memory warning: ${Math.round(T*100)}% of heap limit used. Cache size: ${r.size} files.`)},o=(l,p,g)=>{if(l=""+l,typeof p=="function"){if(g=p,p=o.batch(l),typeof p<"u"||o.thrash.at&&(p=o.thrash.at(l),typeof p<"u"))return g(e,p);if(m.has(l)){m.get(l).callbacks.push(g);return}let c={callbacks:[g],fired:!1,timeoutId:null};m.set(l,c),c.timeoutId=setTimeout(()=>{if(!c.fired){c.fired=!0,m.delete(l);let T=new Error("radisk read timeout");c.callbacks.forEach(y=>y(T,void 0))}},t.readTimeout);let u=Date.now();return o.read(l,(T,y)=>{clearTimeout(c.timeoutId),f("read",u,l),c.fired||(c.fired=!0,m.delete(l),c.callbacks.forEach(_=>_(T,y)))})}if(o.batch(l,p),w(),g&&o.batch.acks.push(g),++o.batch.ed>=t.batch)return o.thrash();clearTimeout(o.batch.timeout),o.batch.timeout=setTimeout(o.thrash,t.write)};return o.batch=J(),o.batch.acks=[],o.batch.ed=0,o.thrash=()=>{if(o.thrash.ing)return o.thrash.more=!0;let l=Date.now();clearTimeout(o.batch.timeout),o.thrash.more=!1,o.thrash.ing=!0;var p=o.thrash.at=o.batch;o.batch=null,o.batch=J(),o.batch.acks=[],o.batch.ed=0;let g=0;o.save(p,c=>{++g>1||(f("thrash",l,`batch-${p.ed}`),c&&t.log(c),p.acks.forEach(u=>u(c)),o.thrash.at=null,o.thrash.ing=!1,o.thrash.more&&o.thrash())})},o.save=(l,p)=>{let g={find:(c,u)=>{if(!(u<g.start))return g.start=u,t.store.list(g.lex),!0},lex:c=>{!c||c>g.start?(g.end=c,g.start&&g.mix(g.file||"!",g.start,g.end)):g.file=c},mix:(c,u,T)=>{if(g.start=g.end=g.file=e,r.has(c)){let y=r.get(c);J.map(l,(_,C)=>{if(!(C<u)){if(T&&T<C){g.start=C;return}y(C,_)}}),o.write(c,y,g.next)}else o.parse(c,(y,_)=>{if(y)return p(y);J.map(l,(C,A)=>{if(!(A<u)){if(T&&T<A){g.start=A;return}_(A,C)}}),o.write(c,_,g.next)})},next:c=>{if(c)return p(c);if(g.start)return J.map(l,g.find);p(c)}};J.map(l,g.find)},o.write=(l,p,g)=>{let c={text:"",limit:"",done:!1,count:0,each:(T,y,_,C)=>{if(c.done)return;c.count++,T=typeof T>"u"?"":"="+re.encode(T);let A=re.encode(C.length)+"#"+re.encode(_)+T+`
`;if(c.count>1&&C.length===0&&c.text.length+A.length>t.size){let x=_.indexOf(Oe);if(c.limit=x===-1?_:_.substring(0,x),c.limit!==l){c.done=!0,c.sub=J(),J.map(p,c.slice),o.write(c.limit,c.sub,g);return}}c.text+=A},slice:(T,y)=>{y<c.limit||c.sub(y,T)}};J.map(p,c.each,!0);let u=Date.now();t.store.put(l,c.text,T=>{f("file-write",u,l,c.text.length),g(T)})},o.read=(l,p)=>{let g=l.indexOf(Oe),c=g===-1?l:l.substring(0,g),u={lex:y=>{if(!y){if(!u.file){p("no file found",e);return}if(t.cache&&r.has(u.file)){let _=r.get(u.file);return u.value=_(l),p(e,u.value)}o.parse(u.file,u.it);return}y>c||y<u.file||(u.file=y)},it:(y,_)=>{y&&t.log(y),_&&(t.cache&&(r.set(u.file,_),w()),u.value=_(l)),p(y,u.value)}},T=Date.now();if(t.cache&&n&&T-i<s)n.forEach(y=>u.lex(y)),u.lex();else{let y=[],_=u.lex;u.lex=C=>(C&&y.push(C),_(C)),t.store.list(C=>{u.lex(C),!C&&t.cache&&(n=y,i=T)})}},o.parse=(l,p)=>{let g={disk:J(),read:(c,u)=>{if(c)return p(c);if(!u)return p(e,g.disk);let T=[],y="",_=g.split(u);for(;_;){let C,A,x=_[1];_=g.split(_[2])||"",_[0]==="#"&&(C=_[1],x<T.length&&(T.length=x),x<=T.length&&(T[x]=C,T.length=x+1),y=T.join("")),_=g.split(_[2])||"",_[0]!==`
`&&(_[0]==="="&&(A=_[1]),typeof C<"u"&&typeof A<"u"&&g.disk(y,A),_=g.split(_[2]))}p(e,g.disk)},split:c=>{if(!c)return;let u=c.indexOf(F);if(u===-1)return;let T=c.slice(0,u),y={};return[T,re.decode(c.slice(u),y),c.slice(u+y.i)]}};t.store.get(l,g.read)},o};re.encode=t=>{let e="",r="";if(t instanceof Array&&(t.length===2||t.length===3)&&(e=Se+t[1],t.length===3&&t[2]&&(r=Se+t[2]),t=t[0]),typeof t=="string"){let i=0,s=null,m=F;for(;s=t[i++];)s===F&&(m+=F);return m+'"'+t+e+r+F}let n=U.is(t);if(n)return F+"#"+n+e+r+F;if(ae.is(t))return F+"+"+(t||0)+e+r+F;if(t===!0)return F+"+"+e+r+F;if(t===!1)return F+"-"+e+r+F;if(t===null)return F+" "+e+r+F};re.decode=(t,e)=>{var r=-1,n=0,i=null,s=null,m=-1,d=-1;if(t[0]!==F)return;for(;i=t[++r];)if(s){if(m===-1&&(m=r),i===F&&--n<=0){d=r;break}}else i===F?n++:s=i||!0;let a=m!==-1?t.slice(m,d!==-1?d:r):"";e&&(e.i=r+1);let h=a.split(Se),S=h[0],f=h[1],w=h[2];if(f)if(f=parseFloat(f),w){if(s==='"')return[S,f,w];if(s==="#")return[U.ify(S),f,w];if(s==="+")return S.length===0?[!0,f,w]:[parseFloat(S),f,w];if(s==="-")return[!1,f,w];if(s===" ")return[null,f,w]}else{if(s==='"')return[S,f];if(s==="#")return[U.ify(S),f];if(s==="+")return S.length===0?[!0,f]:[parseFloat(S),f];if(s==="-")return[!1,f];if(s===" ")return[null,f]}else{if(s==='"')return a;if(s==="#")return U.ify(a);if(s==="+")return a.length===0?!0:parseFloat(a);if(s==="-")return!1;if(s===" ")return null}};var Ie=re;var De=typeof document>"u",Z=De?await import("node:fs"):void 0,Ne="",pe="",ve=pe+"+0"+pe+"#"+pe+'"root'+pe,Xe=t=>{let e=t.file;if(De)return Z.existsSync(e)||Z.mkdirSync(e),Z.existsSync(e+"/!")||Z.writeFileSync(e+"/!",ve),{get:(r,n)=>{Z.readFile(e+"/"+r,(i,s)=>{if(i){if(i.code==="ENOENT"){n();return}console.log("fs.readFile error:",i)}s&&(s=s.toString()),n(i,s)})},put:(r,n,i)=>{var s=r+"."+P.random(9)+".tmp";Z.writeFile(s,n,m=>{if(m){console.log("fs.writeFile error:",m),i(m);return}Z.rename(s,e+"/"+r,i)})},list:r=>{Z.readdir(e,(n,i)=>{if(n){console.log("fs.readdir error:",n),r();return}i.forEach(r),r()})}};if(t.indexedDB){let r,n=indexedDB.open(e,1);return n.onupgradeneeded=i=>{i.target.result.createObjectStore(e)},n.onerror=i=>{console.log(i)},n.onsuccess=()=>{if(r=n.result,r){let s=r.transaction([e],"readonly").objectStore(e).getKey("!");s.onerror=()=>{console.log(`error getting key ${e}/!`)},s.onsuccess=()=>{if(!s.result){let d=r.transaction([e],"readwrite").objectStore(e).put(ve,"!");d.onerror=()=>{console.log(`error putting root on ${e}/!`)}}}}else console.log("error indexedDB not available")},{get:(i,s)=>{let m=(h,S)=>{let w=r.transaction([e],"readonly").objectStore(e).get(h);w.onerror=()=>{console.log(`error getting ${e}/${h}`)},w.onsuccess=()=>{S(null,w.result)}};if(r){m(i,s);return}let d=0,a=setInterval(()=>{if(r){clearInterval(a),m(i,s);return}d++>5&&(clearInterval(a),s("error indexedDB not available"))},1e3)},put:(i,s,m)=>{let d=(S,f,w)=>{let l=r.transaction([e],"readwrite").objectStore(e).put(f,S);l.onerror=()=>{console.log(`error putting data on ${e}/${S}`)},l.onsuccess=()=>{w(null)}};if(r){d(i,s,m);return}let a=0,h=setInterval(()=>{if(r){clearInterval(h),d(i,s,m);return}a++>5&&(clearInterval(h),m("error indexedDB not available"))},1e3)},list:i=>{let s=a=>{let S=r.transaction([e],"readonly").objectStore(e).getAllKeys();S.onerror=()=>console.log("error getting keys for",e),S.onsuccess=()=>{S.result.forEach(a),a()}};if(r){s(i);return}let m=0,d=setInterval(()=>{if(r){clearInterval(d),s(i);return}m++>5&&(clearInterval(d),console.log("error indexedDB not available"),i())},1e3)}}}return{get:(r,n)=>{n(null,ve)},put:(r,n,i)=>{i(null)},list:r=>{r("!"),r()}}},Qe=t=>{L.is(t)||(t={}),t.file=String(t.file||"radata"),t.store||(t.store=Xe(t));let e=Ie(t);return{get:(r,n,i)=>{if(!r||!L.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}i||(i={});var s=r["#"],m=!i.secure&&typeof r["."]=="string"?r["."]:"",d,a={};let h=(S,f)=>{if(!(f!==M&&!V(r["."],f))&&(d||(d={_:{"#":s,">":{}}}),d[f]=S[0],d._[">"][f]=S[1],S.length===3&&S[2])){let w=S[1];a[w]=S[2],a[f]=S[2]}};e(s+Ne+m,(S,f)=>{let w;L.is(f)?(J.map(f,h),d||h(f,m),w={[s]:d}):f&&(h(f,m),w={[s]:d}),w&&w[s]&&Object.keys(a).length>0&&(w[s]._.s=a),n(S,w)})},put:(r,n)=>{if(!r){n("graph required");return}let i=0,s=!1,m=d=>{if(i--,!s){if(d){s=!0,n(d);return}i===0&&(s=!0,n(null))}};Object.keys(r).forEach(d=>{var a=r[d];Object.keys(a).forEach(h=>{if(h==="_")return;i++;let S=a[h],f=a._[">"][h],w=a._.s&&a._.s[f],o=w?[S,f,w]:[S,f];e(d+Ne+h,o,m)})})}}},Me=Qe;var Re=typeof document>"u",Pe=Re?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Pe?.WebSocket);var Ye=t=>{let e=new Map,r=1500,n=6e4,i=10,s=null;return t||(s=setInterval(()=>{let d=Date.now();for(let[a,h]of e.entries())d-h.lastCleanup>n&&(h.requests=[],h.lastCleanup=d),h.requests=h.requests.filter(S=>d-S<n),d-h.lastCleanup>n*10&&(h.throttleCount=0)},n/4)),{getDelay:d=>{let a=Date.now(),h=e.get(d)||{requests:[],lastCleanup:a,throttleCount:0};if(h.requests=h.requests.filter(S=>a-S<n),h.requests.length>=r){let S=Math.min(...h.requests),f=n-(a-S);return h.throttleCount=(h.throttleCount||0)+1,e.set(d,h),Math.max(0,f)}return h.requests.push(a),e.set(d,h),0},getRemainingRequests:d=>{let a=e.get(d);if(!a)return r;let h=Date.now(),S=a.requests.filter(f=>h-f<n);return Math.max(0,r-S.length)},getThrottleCount:d=>{let a=e.get(d);return a&&a.throttleCount||0},shouldDisconnect:d=>{let a=e.get(d);return a?a.throttleCount>=i:!1},destroy:()=>{s&&(clearInterval(s),s=null),e.clear()}}},Ze=(t,e=1024*1024)=>{try{if(typeof t=="string"&&t.length>e)throw new Error("Message too large");return{success:!0,data:JSON.parse(t)}}catch(r){return{success:!1,error:r.message}}},Ve=(t,e=1024*1024)=>typeof t=="string"&&t.length>e?{valid:!1,error:"Message too large"}:Buffer.isBuffer(t)&&t.length>e?{valid:!1,error:"Message too large"}:{valid:!0},et=(t=1e3)=>{let e=new Set;return{add:r=>{if(e.size>=t)return!1;e.add(r);let n=r.close;return r.close=(...i)=>(e.delete(r),n.apply(r,i)),!0},remove:r=>{e.delete(r)},count:()=>e.size,isFull:()=>e.size>=t}},_e=(t=5)=>{let e=0;return{shouldRetry:()=>e<t,getDelay:()=>Math.min(1e3*Math.pow(2,e),3e4),increment:()=>e++,reset:()=>e=0}},tt=t=>{let e=ke(t.maxAge),r=Me(t),n={},i={},s={},m=new Set,d=new Map,a=async k=>n[k]?!0:new Promise(v=>{r.get({"#":k},(b,E)=>{v(!b&&E&&E[k])})}),h=t.wss&&t.wss.constructor.name==="Server",S=Ye(h),f=et(t.maxConnections||1e3),w=(k,v)=>{let b=ye(k.get,n);b?v(JSON.stringify({"#":e.track(P.random(9)),"@":k["#"],put:b})):r.get(k.get,(E,j)=>{v(JSON.stringify({"#":e.track(P.random(9)),"@":k["#"],put:j,err:E}))},{secure:!0})},o=async(k,v)=>{let b=await be.mix(k.put,n,t.secure,s);if(Object.keys(b.now).length===0){Object.keys(b.defer).length!==0&&setTimeout(()=>o({put:b.defer,"#":k["#"]},v),b.wait);return}r.put(b.now,E=>{v(JSON.stringify({"#":e.track(P.random(9)),"@":k["#"],err:E}))}),Object.keys(b.defer).length!==0&&setTimeout(()=>o({put:b.defer,"#":k["#"]},v),b.wait)},l=(k,v,b,E)=>{if(!v)return;L.is(E)||(E={});let j=ye(k,n),$=P.random(9),I=JSON.stringify({"#":e.track($),get:k});if(j){let O=b(I);if(O&&O.err){v({err:O.err});return}v({put:j});return}r.get(k,(O,D)=>{if(D){let B=b(I);if(B&&B.err){v({err:B.err});return}v({put:D,err:O});return}O&&console.log(O),i[$]=v,d.set($,{lex:k,wait:E.wait||100});let N=b(I);if(N&&N.err){v({err:N.err}),delete i[$],d.delete($);return}},E)},p=k=>({get:(v,b,E)=>{v&&typeof v["."]=="number"&&(v={...v,".":String(v["."])}),v&&v["#"]&&m.add(v["#"]),l(v,b,k,E)},put:async(v,b)=>{let E=await be.mix(v,n,t.secure,s);if(Object.keys(E.now).length===0){b&&b(null);return}for(let[$,I]of Object.entries(E.now))if(I&&typeof I=="object")for(let[O,D]of Object.entries(I)){let N=U.is(D);N&&m.add(N)}r.put(E.now,b);let j=k(JSON.stringify({"#":e.track(P.random(9)),put:v}));if(j&&j.err){b&&b(j.err);return}},on:(v,b,E,j)=>{v&&typeof v["."]=="number"&&(v={...v,".":String(v["."])});let $=v&&v["#"];!$||!b||(s[$]?s[$].push({".":v["."],cb:b}):s[$]=[{".":v["."],cb:b}],E&&l(v,b,k,j))},off:(v,b)=>{let E=v&&v["#"];if(!(!E||!s[E]))if(b){let j=s[E].find($=>$.cb===b);j&&s[E].splice(s[E].indexOf(j),1)}else delete s[E]}});if(Re){let k=t.wss,v=()=>k.clients();if(!k){let E=t.server?{server:t.server}:{port:t.port||8765};k=new Pe.WebSocketServer(E),v=()=>k.clients}let b=(E,j)=>{let I=JSON.parse(E)["#"];if(I&&d.has(I)){let O=d.get(I);d.delete(I),O.timeoutId=setTimeout(()=>{let D=i[I];if(D){let N=O.lex["#"],B={[N]:null};typeof O.lex["."]=="string"&&(B[N]={[O.lex["."]]:null}),D({put:B}),delete i[I]}},O.wait)}v().forEach(O=>{if(O&&O.readyState===WebSocket.OPEN)O.send(E,{binary:j});else{let D=O._retryHandler||_e();if(O._retryHandler=D,D.shouldRetry()){let N=D.getDelay();D.increment(),setTimeout(()=>{O&&O.readyState===WebSocket.OPEN&&(D.reset(),O.send(E,{binary:j}))},N)}}})};return k.on("connection",E=>{if(!f.add(E)){console.log("Connection limit reached, rejecting connection"),E.close(1013,"Connection limit reached - try again later");return}let j=P.random(9);console.log(`New WebSocket client connected: ${j}`),E.on("error",$=>{console.log("WebSocket error:",$),f.remove(E)}),E.on("close",()=>{console.log(`WebSocket client disconnected: ${j}`),f.remove(E)}),E.on("message",($,I)=>{let O=Ve($,t.maxMessageSize);if(!O.valid){console.warn(`Invalid message: ${O.error}`),E.send(JSON.stringify({error:O.error}));return}let D=Ze($,t.maxMessageSize);if(!D.success){console.warn(`JSON parse error: ${D.error}`),E.send(JSON.stringify({error:"Invalid JSON"}));return}let N=D.data;if(e.check(N["#"]))return;let B=S.getDelay(j);if(B>0){let ie=S.getThrottleCount(j);if(console.log(`Client ${j}: rate limit exceeded, delay would be ${B}ms, dropping message (throttle count: ${ie})`),S.shouldDisconnect(j)){console.log(`Client ${j}: Disconnecting after ${ie} throttle violations`),E.close(1008,"Rate limit violations");return}E.send(JSON.stringify({"#":e.track(P.random(9)),"@":N["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(B/1e3)}s`,throttle:B}));return}let ne=()=>{e.track(N["#"]),N.get&&w(N,b),N.put&&o(N,b),b($,I);let ie=N["@"],le=i[ie];le&&(delete N["#"],delete N["@"],le(N),delete i[ie])};B>0?setTimeout(ne,B):ne()})}),p(b)}let g=[],c=!1,u=0,T=[],y=null,_=t.maxQueueLength||1e4,C=()=>{if(T.length===0){y=null;return}let k=Date.now();if(c&&k<u){y=setTimeout(C,Math.min(1e3,u-k));return}c&&k>=u&&(console.log("Throttle period ended, resuming queue processing"),c=!1,u=0);let v=T[0];if(A(v)){T.shift();let j=JSON.parse(v)["#"];if(j&&d.has(j)){let $=d.get(j);d.delete(j),$.timeoutId=setTimeout(()=>{let I=i[j];if(I){let O=$.lex["#"],D={[O]:null};typeof $.lex["."]=="string"&&(D[O]={[$.lex["."]]:null}),I({put:D}),delete i[j]}},$.wait)}}T.length>0?y=setTimeout(C,50):y=null},A=k=>{let v=!1;return g.forEach(b=>{if(b&&b.readyState===WebSocket.OPEN)b.send(k),v=!0;else{let E=b._retryHandler||_e();if(b._retryHandler=E,E.shouldRetry()){let j=E.getDelay();E.increment(),setTimeout(()=>{b&&b.readyState===WebSocket.OPEN&&(E.reset(),b.send(k))},j)}}}),v},x=k=>{if(T.length>=_)return{err:`Message queue exceeded maximum length (${_}). Update query logic to request less data.`,queueLength:T.length,maxQueueLength:_};T.push(k),y||(y=setTimeout(C,50))};return t.peers instanceof Array||(t.peers=[`ws://localhost:${t.port||8765}`]),t.peers.forEach(k=>{let v=()=>{let b=new WebSocket(k);g.push(b);let E=_e();b.onclose=j=>{if(g.indexOf(b)!==-1&&g.splice(g.indexOf(b),1),b=null,E.shouldRetry()){let $=E.getDelay();E.increment(),setTimeout(v,$)}},b.onopen=()=>{E.reset()},b.onerror=j=>{console.log(j)},b.onmessage=async j=>{let $=JSON.parse(j.data);if(e.check($["#"]))return;if($.throttle&&$.err){console.log(`Server throttling: ${$.err}`),c=!0,u=Date.now()+$.throttle;return}if(e.track($["#"]),$.get&&w($,x),$.put){let D={};for(let[N,B]of Object.entries($.put)){let ne=!1;if(await a(N)&&(ne=!0,B&&typeof B=="object"))for(let[ie,le]of Object.entries(B)){let Te=U.is(le);Te&&m.add(Te)}m.has(N)&&(ne=!0,m.delete(N)),ne&&(D[N]=B)}if(Object.keys(D).length>0){let N={put:D,"#":$["#"]};o(N,x)}}let I=$["@"],O=i[I];O&&(delete $["#"],delete $["@"],O($),delete i[I])}};v()}),p(x)},he=tt;var rt=(t,e)=>{e||(e=he(t));let r=[],n=!1,i=!1,s=0,m=(a,h,S,f)=>{let w=g=>{s++,m(g,h,S,f)},o=g=>{r=[],s=0,i=!1,f(g)},l=()=>{if(r.length===0){o("Wrong username or password");return}let g=r.shift();e.get({"#":g},async c=>{if(c.err){o(`error getting ${g}: ${c.err}`);return}let u=c.put&&c.put[g];if(!u||!u.auth)return l();let T=JSON.parse(u.auth),y=await H.work(h,T.salt),_=await H.decrypt(T.enc,y);if(!_)return l();if(d.is={username:a,pub:u.pub,epub:u.epub,priv:_.priv,epriv:_.epriv},S!==""){let A=P.random(64),x=await H.work(S,A),k=await H.encrypt(_,x),v={auth:JSON.stringify({enc:k,salt:A})},b=Date.now(),E=await H.signTimestamp(b,d.is),j=z(g,v,E,u.pub,b);e.put(j,$=>{o($?`error putting ${v} on ${g}: ${$}`:null)});return}if(typeof globalThis.localStorage<"u"&&globalThis.localStorage.getItem("holster_migrate_signatures")==="true"){let A={};for(let b of Object.keys(u))b!=="_"&&b!==M&&b!==G&&(A[b]=u[b]);let x=Date.now(),k=await H.signTimestamp(x,d.is),v=z(g,A,k,u.pub,x);e.put(v,b=>{b&&console.log(`warning: failed to migrate signatures on login: ${b}`),o(null)})}else o(null)},{wait:5e3})};if(s>9){o("Wrong username or password");return}let p="~@"+a;e.get({"#":p},async g=>{if(g.err){o(`error getting ${p}: ${g.err}`);return}let c=g.put&&g.put[p];if(!c)return w(a);delete g.put[p]._,r=Object.keys(c),l()},{wait:5e3})},d={create:(a,h,S)=>{let f=o=>{S?S(o):console.log(o)};if(n){f("User is already being created");return}if(a===""){f("Please provide a username");return}if(h===""){f("Please provide a password");return}n=!0;let w="~@"+a;e.get({"#":w},async o=>{if(o.err){n=!1,f(`error getting ${w}: ${o.err}`);return}if(o.put&&o.put[w]){n=!1,f("Username already exists");return}let l=P.random(64),p=await H.work(h,l),g=await H.pair(),c={priv:g.priv,epriv:g.epriv},u=await H.encrypt(c,p),T={username:a,pub:g.pub,epub:g.epub,auth:JSON.stringify({enc:u,salt:l})},y="~"+g.pub,_=Date.now(),C=await H.signTimestamp(_,g),A=z(y,T,C,g.pub,_);e.put(A,x=>{if(n=!1,x){f(`error putting ${T} on ${y}: ${x}`);return}let k={[y]:{"#":y}};e.put(z(w,k),v=>{if(v){f(`error putting ${k} on ${w}: ${v}`);return}S&&S(null)})})},{wait:5e3})},auth:(a,h,S)=>{let f=w=>{S?S(w):w&&console.log(w)};if(i){f("User is already authenticating");return}if(d.is=null,a===""){f("Please provide a username");return}if(h===""){f("Please provide a password");return}i=!0,m(a,h,"",f)},change:(a,h,S,f)=>{let w=o=>{f?f(o):o&&console.log(o)};if(i){w("User is already authenticating");return}if(d.is=null,a===""){w("Please provide a username");return}if(h===""){w("Please provide a password");return}if(S===""){w("Please provide a new password");return}i=!0,m(a,h,S,w)},store:a=>{if(!d.is){console.log("Please authenticate before calling store");return}if(a){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let a=globalThis.localStorage.getItem("user.is");if(a){d.is=JSON.parse(a);return}}if(typeof globalThis.sessionStorage<"u"){let a=globalThis.sessionStorage.getItem("user.is");a&&(d.is=JSON.parse(a))}},leave:()=>{d.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(a,h,S)=>{let f=w=>{S?S(w):console.log(w)};if(i){f("User is already authenticating");return}if(a===""){f("Please provide a username");return}if(h===""){f("Please provide a password");return}i=!0,m(a,h,"",async w=>{if(w){f(w);return}let o={username:null,pub:null,epub:null,auth:null},l=Date.now(),p=await H.signTimestamp(l,d.is),g="~"+d.is.pub,c=z(g,o,p,d.is.pub,l);e.put(c,u=>{if(u){f(`error putting null on ${g}: ${u}`);return}d.is=null,S&&S(null)})})}};return d},Ue=rt;var nt=t=>{typeof t=="string"?t={peers:[t]}:t instanceof Array?t={peers:t}:L.is(t)||(t={});let e=he(t),r=Ue(null,e),n=new Map,i=new Map,s=a=>a===null||a===!0||a===!1||typeof a=="string"||U.is(a)||ae.is(a),m=a=>{if(s(a))return!0;if(L.is(a)){let S=[];for(let[f,w]of Object.entries(a)){if(f==="_")return"error underscore cannot be used as a property name";if(L.is(w)||s(w)){S.push(f);continue}return typeof w>"u"?`error undefined ${f} cannot be converted to a graph`:`error ${JSON.stringify({[f]:w})} cannot be converted to a graph`}if(S.length!==0)return S}return`error ${JSON.stringify(a)} cannot be converted to a graph`},d=a=>{let h=(o,l,p,g)=>{e.get(L.put(o,"#",l),async c=>{if(c.err&&console.log(c.err),c.put&&c.put[l]){delete c.put[l]._,delete c.put[l][M],delete c.put[l][G];for(let u of Object.keys(c.put[l])){let T=U.is(c.put[l][u]);if(T){let y=async(_=0)=>{let C=await new Promise(A=>{let x=P.random(),k=i.get(a);i.set(x,{chain:[{item:null,soul:T}],user:k?k.user:null}),d(x).next(null,A,g)});return C!==null||_>=5?C:(await new Promise(A=>setTimeout(A,50)),y(_+1))};c.put[l][u]=await y()}}p(c.put[l])}else p(null)},g)},S=async(o,l,p,g)=>{if(p){let c=Date.now(),u=await H.signTimestamp(c,p);return z(o,l,u,p.pub,c)}return t.secure?(g||(g=console.log),g(`error putting data on ${o}: user required in secure mode`),null):z(o,l)},f=o=>l=>{let p=i.get(o);p&&typeof p.cb<"u"?setTimeout(()=>p.cb(l),1):l&&console.log("error no callback for data",l,"ctx",p),p&&!p.on&&i.delete(o)},w=(o,l)=>{if(!o){console.log("error resolve request parameter required");return}let p=typeof o.get<"u",g=typeof o.put<"u",c=typeof o.on<"u",u=typeof o.off<"u",T=!1,y=i.get(a);for(var _=1;_<y.chain.length;_++)if(y.chain[_].soul===null){T=!0;break}if(T){let{item:C,soul:A}=y.chain[_-1];return e.get({"#":A,".":C},async x=>{if(x.err){console.log(`error getting ${C} on ${A}: ${x.err}`),l&&l(null);return}let k=x.put&&x.put[A];if(k&&typeof k[C]<"u"){let v=U.is(k[C]);if(v)y.chain[_].soul=v,i.set(a,{...y}),p?d(a).next(null,o.get,l,o._opt):g?d(a).put(o.put,l):c?d(a).on(o.on,l,o._get,o._opt):u&&d(a).off(l);else if(p)l(k[C]);else if(g){v=P.random(),k[C]=U.ify(v);let b=await S(A,k,y.user,l);if(b===null)return;e.put(b,E=>{if(E){l(`error putting ${C} on ${A}: ${E}`);return}y.chain[_].soul=v,d(a).put(o.put,l)})}else(c||u&&l)&&l(null)}else if(g){let v=P.random();k||(k={}),k[C]=U.ify(v);let b=await S(A,k,y.user,l);if(b===null)return;e.put(b,E=>{if(E){l(`error putting ${C} on ${A}: ${E}`);return}y.chain[_].soul=v,d(a).put(o.put,l)})}else l&&l(null)},{...o._opt,secure:y.user||t.secure}),!1}return p&&y.chain[y.chain.length-1].item!==null?(y.chain.push({item:null,soul:null}),d(a).next(null,o.get,l,o._opt),!1):y.chain[y.chain.length-1]};return{get:(o,l,p,g)=>{if(typeof l=="function"&&(g=p,p=l,l=null),o===null||o===""||o==="_"){console.log("error please provide a key"),p&&p(null);return}if(l&&typeof p!="function"){console.log("error lex requires a callback function");return}if(a=P.random(),i.set(a,{chain:[{item:String(o),soul:"root"}],cb:p}),!p)return d(a);let c=f(a),{soul:u}=w({get:l,_opt:g},c);u&&h(l,u,c,g)},next:(o,l,p,g)=>{let c=_=>C=>{p?p(C):f(_)(C)};if(typeof l=="function"&&(g=p,p=l,l=null),!a){console.log("error please provide a key using get(key)"),p&&p(null);return}let u=c(a);if(o===""||o==="_"){u(null);return}if(l&&typeof p!="function"){console.log("error lex requires a callback function");return}let T=i.get(a);if(!T)return;if(p&&typeof T.cb>"u"&&(T.cb=p,p=null),o!==null&&T.chain.push({item:String(o),soul:null}),!T.cb)return d(a);let{soul:y}=w({get:l,_opt:g},u);y&&h(l,y,u,g)},put:(o,l,p)=>{typeof l=="function"&&(p=l,l=!1);let g=A=>x=>{p?p(x):f(A)(x)};if(!a){p&&p("error please provide a key using get(key)");return}let c=i.get(a);if(!c)return;if(!c.cb){if(!p)return;c.cb=p,p=null}l&&(o={[P.random()]:o});let u=g(a),T=m(o);if(typeof T=="string"){u(T);return}let{item:y,soul:_}=w({put:o},u);if(!_)return;if(T===!0){e.get({"#":_,".":y},async A=>{if(A.err){u(`error getting ${_}: ${A.err}`);return}let x=A.put&&A.put[_],k=x&&x[y],v=U.is(k);if(!v){x||(x={}),x[y]=o;let b=await S(_,x,c.user,u);if(b===null)return;e.put(b,u);return}e.get({"#":v},async b=>{if(b.err){u(`error getting ${v}: ${b.err}`);return}if(!b.put||!b.put[v]){u(`error ${v} not found`);return}for(let j of Object.keys(b.put[v])){if(j==="_"||j===M||j===G)continue;let $=await new Promise(I=>{let O=P.random(),D=[{item:j,soul:v}];i.set(O,{chain:D,user:c.user}),d(O).put(null,I)});if($){u($);return}}x||(x={}),x[y]=o;let E=await S(_,x,c.user,u);E!==null&&e.put(E,u)})},{secure:c.user||t.secure});return}let C=(A=0)=>{e.get({"#":_,".":y},async x=>{if(x.err){u(`error getting ${_}.${y}: ${x.err}`);return}let k=x.put&&x.put[_],v=k&&k[y];if(!v&&A<5)return await new Promise(j=>setTimeout(j,50)),C(A+1);let b=U.is(v);if(!b){k||(k={}),k[y]=U.ify(P.random());let j=await S(_,k,c.user,u);if(j===null)return;e.put(j,$=>{if($)u(`error putting ${y} on ${_}: ${$}`);else{let I=P.random(),O=[{item:y,soul:_}];i.set(I,{chain:O,user:c.user,cb:c.cb}),d(I).put(o)}});return}let E=[];for(let j of T){let $=await new Promise(I=>{if(L.is(o[j])&&!U.is(o[j])){let O=P.random(),D=[{item:j,soul:b}];i.set(O,{chain:D,user:c.user}),d(O).put(o[j],I)}else E.push(j),I(null)});if($){u($,a);return}}if(E.length===0){u(null);return}e.get({"#":b},async j=>{if(j.err){u(`error getting ${b}: ${j.err}`);return}let $=j.put&&j.put[b];$||($={}),E.forEach(O=>{$[O]=o[O]});let I=await S(b,$,c.user,u);I!==null&&e.put(I,u)})},{secure:c.user||t.secure})};C()},on:(o,l,p,g)=>{if(typeof o=="function"&&(g=p,p=l,l=o,o=null),typeof l!="function"){console.log("error on() requires a callback function");return}if(!a){console.log("error please provide a key using get(key)"),l(null);return}let{item:c,soul:u}=w({on:o,_get:p,_opt:g},l);if(!u)return;let T=i.get(a);i.set(a,{chain:[{item:c,soul:u}],on:!0,user:T?T.user:null}),n.set(l,()=>{e.get({"#":u,".":c},_=>{let C=_.put&&_.put[u]&&_.put[u][c],A=U.is(C);if(A){let x=async(k=0)=>{let v=await new Promise(b=>{let E=P.random();i.set(E,{chain:[{item:null,soul:A}],user:T?T.user:null}),d(E).next(null,b,g)});v!==null||k>=5?l(v):(await new Promise(b=>setTimeout(b,50)),x(k+1))};x()}else l(C!==void 0?C:null)},{...g,secure:T.user||t.secure})});let y;o?(y=L.put(o,"#",u),y["."]!=null&&typeof y["."]=="number"&&(y={...y,".":String(y["."])})):y={"#":u,".":c},e.on(y,n.get(l),!1,g),e.get({"#":u,".":c},_=>{if(_.err){console.log(`error getting ${u}.${c}: ${_.err}`);return}let C=_.put&&_.put[u]&&_.put[u][c],A=U.is(C);if(A){e.off(y,n.get(l));let x;o?x=L.put(y,"#",A):x={"#":A,".":null},e.on(x,n.get(l),p,g)}else p&&n.get(l)()},{...g,secure:T.user||t.secure})},off:o=>{if(!a){console.log("error please provide a key using get(key)"),o&&o(null);return}let{item:l,soul:p}=w({off:!0},o);p&&e.get({"#":p,".":l},g=>{if(g.err){console.log(`error getting ${p}.${l}: ${g.err}`);return}let c=g.put&&g.put[p]&&g.put[p][l],u=U.is(c);u?e.off({"#":u},n.get(o)):e.off({"#":p},n.get(o)),n.delete(o),i.delete(a)})},user:()=>(r.get||(Object.assign(r,d()),r.get=(o,l,p,g)=>{typeof l=="function"&&(g=p,p=l,l=null);let c=null,u=null;if(r.is&&(c=r.is.pub),typeof o=="string"?u=o:o instanceof Array&&(o.length===2?(c=o[0],u=o[1]):o.length===1&&(u=o[0])),!c){console.log("error please log in or provide a public key"),p&&p(null);return}if(u===null||u===""||u==="_"){console.log("error please provide a key"),p&&p(null);return}if(l&&!p){console.log("error lex requires a callback function");return}a=P.random();let T=[{item:String(u),soul:"~"+c}];if(i.set(a,{chain:T,user:r.is,cb:p}),!p)return d(a);let y=f(a),{soul:_}=w({get:l,_opt:g},y);_&&h(l,_,y,g)}),r),wire:e,SEA:H}};return d()},Dt=nt;export{Dt as default};
//# sourceMappingURL=holster.js.map
