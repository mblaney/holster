var fe={is:e=>{if(e instanceof Array)return!1;if(typeof e=="number")return!isNaN(e);if(typeof e=="string"){let t=parseFloat(e);return!isNaN(t)&&isFinite(t)}return!1}},B={is:e=>{if(!e||typeof e!="object")return!1;let r=Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/);return e.constructor===Object||r&&r[1]==="Object"},map:(e,t,r)=>{var n=Object.keys(e);for(let s=0;s<n.length;s++){let o=t(e[n[s]],n[s],r);if(typeof o<"u")return o}},put:(e,t,r)=>(e||(e={}),e[t]=r,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Le=(e,t,r)=>{if(r.id){r.id=!1;return}if(t==="#"&&typeof e=="string"){r.id=e;return}r.id=!1},L={is:e=>{if(e&&e["#"]&&!e._&&B.is(e)){let t={};if(B.map(e,Le,t),t.id)return t.id}return!1},ify:e=>B.put({},"#",e)},V="_holster_user_signature",D="_holster_user_public_key",z=(e,t,r,n,s)=>{let o={[e]:{_:{"#":e,">":{}}}};for(let[m,f]of Object.entries(t))m!=="_"&&m!==D&&m!==V&&(o[e][m]=f,o[e]._[">"][m]=s||Date.now());if(r&&n&&s){if(o[e]._.s={},typeof r=="string")o[e]._.s[s]=r;else if(typeof r=="object")for(let[m,f]of Object.entries(r))o[e]._.s[m]=f;o[e][D]=n,o[e]._[">"][D]=s}return o},ee=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(Array.isArray(e))return e.includes(t);if(!B.is(e)||!t)return!1;let r=e["*"];if(r)return t.slice(0,r.length)===r;let n=e[">"],s=e["<"];return n&&s?t>=n&&t<=s:n?t>=n:s?t<=s:!1},R={random:e=>{var t="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let n=0;n<e;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}};var Be=e=>{e||(e=9e3);let t={store:{}};return t.check=r=>t.store[r]?t.track(r):!1,t.track=r=>(t.store[r]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{if(t.expiry)return;let n=Date.now();Object.keys(t.store).forEach(s=>{n-t.store[s]>e&&delete t.store[s]}),t.expiry=null},e)),r),t},Ee=Be;var He=(e,t)=>{if(!e||typeof e!="object")throw new TypeError("lex must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");let r=e["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!t[r])return;let n={_:{"#":r,">":{}}},s={};if(typeof e["."]=="string"){let o=e["."];if(typeof t[r][o]>"u")return;n[o]=t[r][o],n._[">"][o]=t[r]._[">"][o];let m=t[r]._[">"][o];if(t[r]._.s&&(t[r]._.s[m]?s[m]=t[r]._.s[m]:t[r]._.s[o]&&(s[o]=t[r]._.s[o])),D&&typeof t[r][D]<"u"){n[D]=t[r][D],n._[">"][D]=t[r]._[">"][D];let f=t[r]._[">"][D];t[r]._.s&&(t[r]._.s[f]?s[f]=t[r]._.s[f]:t[r]._.s[D]&&(s[D]=t[r]._.s[D]))}}else for(let o of Object.keys(t[r]))if(o===D||ee(e["."],o)){n[o]=t[r][o],n._[">"][o]=t[r]._[">"][o];let m=t[r]._[">"][o];t[r]._.s&&(t[r]._.s[m]?s[m]=t[r]._.s[m]:t[r]._.s[o]&&(s[o]=t[r]._.s[o]))}return Object.keys(s).length>0&&(n._.s=s),{[r]:n}},me=He;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function ce(){}Object.assign(ce,{from:Array.from});ce.prototype=Object.create(Array.prototype);ce.prototype.toString=function(e,t,r){if(e||(e="utf8"),t||(t=0),r=r?Math.min(Math.max(r,t),this.length):this.length,e==="hex"){let n=new Uint8Array(this.slice(t,r));return Array.from(n,s=>s.toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:r-t},(n,s)=>{let o=this[s+t];return o<0||o>1114111?"\uFFFD":String.fromCharCode(o)}).join("");if(e==="base64"){let n=Array.from({length:r-t},(s,o)=>{let m=this[o+t];return m<0||m>255?"\uFFFD":String.fromCharCode(m)}).join("");return btoa(n)}};var X=ce;var ge={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function Q(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),Q.from(...e)}Q.prototype=Object.create(Array.prototype);var ue=(e,t)=>{if(typeof e!="string")throw new TypeError("Input must be a string for encoding: "+t);if(e.length>ge.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${e.length} > ${ge.MAX_STRING_LENGTH}`)},W=(e,t="buffer operation")=>{if(e>ge.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${t}: ${e} > ${ge.MAX_BUFFER_SIZE}`)},Ke=e=>{ue(e,"hex");let t=e.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(t))throw new TypeError("Invalid hex string: contains non-hex characters");if(t.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(t.length===0)return new Uint8Array(0);W(t.length/2,"hex parsing");let r=new Uint8Array(t.length/2);for(let n=0;n<t.length;n+=2){let s=t.substr(n,2);r[n/2]=parseInt(s,16)}return r},Ae=e=>{ue(e,"utf8");try{let r=new TextEncoder().encode(e);return W(r.length,"UTF-8 encoding"),r}catch(t){throw new TypeError("Failed to encode UTF-8 string: "+t.message)}},Fe=e=>{ue(e,"binary"),W(e.length,"binary encoding");let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);t[r]=n}return t},Je=e=>{ue(e,"base64");let t=e.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(t))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(t);W(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let s=0;s<r.length;s++)n[s]=r.charCodeAt(s);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},je=e=>{let t;if(e instanceof ArrayBuffer)W(e.byteLength,"ArrayBuffer processing"),t=new Uint8Array(e);else if(ArrayBuffer.isView(e))W(e.byteLength||e.length,"TypedArray processing"),t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);else if(Array.isArray(e)){W(e.length,"Array processing");for(let r=0;r<e.length;r++){let n=e[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}t=new Uint8Array(e)}else if(typeof e=="object"&&e!==null&&typeof e.byteLength=="number")W(e.byteLength,"ArrayBuffer-like processing"),t=new Uint8Array(e);else if(typeof e=="object"&&e!==null&&typeof e.length=="number"){W(e.length,"array-like processing");let r=Array.from(e);for(let n=0;n<r.length;n++){let s=r[n];if(typeof s!="number"||s<0||s>255||!Number.isInteger(s))throw new TypeError(`Invalid byte value at index ${n}: ${s} (must be integer 0-255)`)}t=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof e);return t};Object.assign(Q,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let t=arguments[0];if(t==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof t=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=Ke(t);break;case"utf8":case"utf-8":r=Ae(t);break;case"binary":case"latin1":r=Fe(t);break;case"base64":r=Je(t);break;case"ascii":ue(t,"ascii");for(let s=0;s<t.length;s++)if(t.charCodeAt(s)>127)throw new TypeError(`Invalid ASCII character at position ${s}: ${t.charCodeAt(s)} > 127`);r=Ae(t);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=je(t);if(!r||r.length===0)return X.from(new Uint8Array(0));try{return X.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(e,t=0){if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Length must be a non-negative integer");if(W(e,"buffer allocation"),typeof t=="number"){if(t<0||t>255||!Number.isInteger(t))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof t=="string"){if(t.length!==1)throw new TypeError("Fill string must be exactly one character");if(t=t.charCodeAt(0),t>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(e);return t!==0&&r.fill(t),X.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be an array");if(e.length===0)return X.from(new Uint8Array(0));let t=0,r=[];for(let n=0;n<e.length;n++){let s=e[n];if(!s)throw new TypeError(`Array element at index ${n} is null or undefined`);let o;try{o=je(s)}catch(m){throw new TypeError(`Invalid array element at index ${n}: ${m.message}`)}t+=o.length,W(t,"buffer concatenation"),r.push(o)}try{let n=new Uint8Array(t),s=0;for(let o of r)n.set(o,s),s+=o.length;return X.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(e){return e instanceof X||e&&typeof e=="object"&&e.constructor===Q},byteLength(e,t="utf8"){if(typeof e!="string")throw new TypeError("First argument must be a string");switch(t.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(e).length;case"ascii":case"binary":case"latin1":return e.length;case"base64":let r=e.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(e.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+t)}}});Q.prototype.from=Q.from;Q.prototype.toString=function(e="utf8",t=0,r=this.length){if(typeof e!="string")throw new TypeError("Encoding must be a string");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<t)throw new TypeError("End must be an integer >= start");try{return X.prototype.toString.call(this,e,t,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var J=Q;var qe=typeof document>"u",$e=qe?(await import("node:crypto")).webcrypto:globalThis.crypto,P=$e.subtle,de=e=>typeof e=="string"?e:JSON.stringify(e),le=e=>{try{return JSON.parse(e)}catch{return e}},pe=e=>{let t=new Uint8Array(J.alloc(e));return J.from($e.getRandomValues(t))},Z=(e,t)=>{let[r,n]=e.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},re=async e=>{let t=await P.digest({name:"SHA-256"},new TextEncoder().encode(de(e)));return J.from(t)},we=async(e,t)=>{let r=e+t.toString("utf8"),n=J.from(await re(r),"binary"),s=We(n);return await P.importKey("jwk",s,{name:"AES-GCM"},!1,["encrypt","decrypt"])},We=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var ze={pair:async e=>{let t=await P.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async s=>{let o=await P.exportKey("jwk",s.publicKey);return{priv:(await P.exportKey("jwk",s.privateKey)).d,pub:o.x+"."+o.y}}),r=await P.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async s=>{let o=await P.exportKey("jwk",s.publicKey);return{epriv:(await P.exportKey("jwk",s.privateKey)).d,epub:o.x+"."+o.y}}),n={pub:t.pub,priv:t.priv,epub:r.epub,epriv:r.epriv};return e&&e(n),n},encrypt:async(e,t,r)=>{if(!t||!t.epriv)return r&&r(null),null;let n={s:pe(9),iv:pe(15)},s=await we(t.epriv,n.s).then(m=>P.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},m,new TextEncoder().encode(de(e)))),o={ct:J.from(s,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(o),o},decrypt:async(e,t,r)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return r&&r(null),null;let n={ct:J.from(e.ct,"base64"),iv:J.from(e.iv,"base64"),s:J.from(e.s,"base64")};try{let s=await we(t.epriv,n.s).then(m=>P.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},m,new Uint8Array(n.ct))),o=le(new TextDecoder("utf8").decode(s));return r&&r(o),o}catch{return r&&r(null),null}},verify:async(e,t,r)=>{if(!t||!t.pub)return r&&r(null),null;let n=le(e),s=await P.importKey("jwk",Z(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),o={};if(typeof n.m=="string")o=n.m;else for(let h of Object.keys(n.m).sort())h!=="_"&&h!==D&&h!==V&&(o[h]=n.m[h]);let m=await re(o),f=new Uint8Array(J.from(n.s,"base64")),l={name:"ECDSA",hash:{name:"SHA-256"}};if(await P.verify(l,s,f,new Uint8Array(m))){let h=le(n.m);return r&&r(h),h}return r&&r(null),null},sign:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n={};if(typeof e=="string")n=e;else{let h=le(e);for(let v of Object.keys(h).sort())v!=="_"&&v!==D&&v!==V&&(n[v]=h[v])}let s=await re(n),o=Z(t.pub,t.priv),m={name:"ECDSA",namedCurve:"P-256"},f=await P.importKey("jwk",o,m,!1,["sign"]).then(h=>P.sign({name:"ECDSA",hash:{name:"SHA-256"}},h,new Uint8Array(s))),l={m:n,s:J.from(f,"binary").toString("base64")};return r&&r(l),l},signTimestamp:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n=e.toString(),s=await re(n),o=Z(t.pub,t.priv),m={name:"ECDSA",namedCurve:"P-256"},f=await P.importKey("jwk",o,m,!1,["sign"]).then(h=>P.sign({name:"ECDSA",hash:{name:"SHA-256"}},h,new Uint8Array(s))),l=J.from(f,"binary").toString("base64");return r&&r(l),l},verifyTimestamp:async(e,t,r,n)=>{if(!r||!e||!t)return n&&n(!1),!1;try{let s=e.toString(),o=await re(s),m=await P.importKey("jwk",Z(r),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),f=new Uint8Array(J.from(t,"base64")),l={name:"ECDSA",hash:{name:"SHA-256"}},h=await P.verify(l,m,f,new Uint8Array(o));return n&&n(h),h}catch(s){return console.log(`error verifying timestamp signature: ${s.message}`),n&&n(!1),!1}},verifyProperties:async(e,t,r)=>{if(!t||!e)return r&&r([]),[];let n=await P.importKey("jwk",Z(t),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),s={name:"ECDSA",hash:{name:"SHA-256"}},o=[],m=e._&&e._.s||{};for(let f of Object.keys(e).sort()){if(f==="_"||f==D)continue;let l=m[f];if(l)try{let h=await re(e[f]),v=new Uint8Array(J.from(l,"base64"));await P.verify(s,n,v,new Uint8Array(h))?o.push(f):console.log(`warning: property '${f}' signature verification failed`)}catch(h){console.log(`warning: property '${f}' error verifying: ${h.message}`)}}return r&&r(o),o},work:async(e,t,r)=>{typeof t=="function"&&(r=t,t=void 0),typeof t>"u"&&(t=pe(9));let n=await P.importKey("raw",new TextEncoder().encode(de(e)),{name:"PBKDF2"},!1,["deriveBits"]),s={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},o=await P.deriveBits(s,n,512),m={epriv:J.from(o,"binary").toString("base64")};return r&&r(m),m},secret:async(e,t,r)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},s=Z(e.epub),o=await P.importKey("jwk",s,n,!0,[]),m=Z(t.epub,t.epriv,!1);delete m.key_ops;let f=await P.importKey("jwk",m,n,!1,["deriveBits"]).then(async l=>{let h=await P.deriveBits({public:o,name:"ECDH",namedCurve:"P-256"},l,256),v=await P.importKey("raw",new Uint8Array(h),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return P.exportKey("jwk",v).then(({k:b})=>b)});return r&&r({epriv:f}),{epriv:f}}},F=ze;var xe=1e4,be=(e,t,r,n,s=!1)=>e<t?{historical:!0}:e>t?{incoming:!0}:s&&r!==n?(console.log(`Signed timestamp ${e}: reject conflicting value`),{historical:!0}):(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});be.mix=async(e,t,r,n)=>{if(!e||typeof e!="object")throw new TypeError("change must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let s=Date.now(),o={},m={},f=[],l=new Map,h=new Map,v=0;for(let p of Object.keys(e)){let i=e[p],u=!1,c=!1,d=0,a=r;if(!i||!i._)continue;let g=i[D];if(i._.s&&g&&(a=!0),p.length>1&&p[0]==="~")if(p[1]==="@")c=!0,a=!1;else{if(g&&p!="~"+g){console.log(`error public key does not match for soul: ${p}`);continue}a=!0}if(a){if(!g||!i._)continue;let w=new Set,y=new Set;for(let[j,C]of Object.entries(i._.s||{})){let $=Number(j);if(!isNaN($)&&$>0&&await F.verifyTimestamp($,C,g)){w.add($);for(let[E,k]of Object.entries(i._[">"]||{}))Number(k)===$&&y.add(E)}}if((await F.verifyProperties(i,g)).forEach(j=>y.add(j)),y.size===0)continue;l.set(p,y),h.set(p,w)}for(let w of Object.keys(i)){if(w==="_"||l.has(p)&&!l.get(p).has(w))continue;let y=i[w],S=i._&&i._[">"]?i._[">"][w]:0,j=(t[p]||{})[w],C=(t[p]||{_:{">":{}}})._[">"][w]||0;if(c&&w!==L.is(y)){console.log(`error alias ${c}: ${w} !== ${L.is(y)}`);continue}let $=S-s;if($>0){if($>864e5)continue;(v===0||$<v)&&(v=d=$),m[p]||(m[p]={_:{"#":p,">":{},s:{}}}),m[p][w]=y,m[p]._[">"][w]=S,i._.s&&(i._.s[S]?m[p]._.s[S]=i._.s[S]:i._.s[w]&&(m[p]._.s[w]=i._.s[w]))}else{let I=h.has(p)&&h.get(p).has(S);be(S,C,y,j,I).incoming&&(o[p]||(o[p]={_:{"#":p,">":{},s:{}}}),t[p]||(t[p]={_:{"#":p,">":{},s:{}}}),t[p][w]=o[p][w]=y,t[p]._[">"][w]=o[p]._[">"][w]=S,i._.s&&(i._.s[S]?t[p]._.s[S]=o[p]._.s[S]=i._.s[S]:i._.s[w]&&(t[p]._.s[w]=o[p]._.s[w]=i._.s[w])),n[p]&&n[p].filter(k=>ee(k["."],w)).forEach(k=>f.push(k.cb)),u=!0)}}u&&n[p]&&n[p].filter(w=>ee(w["."])).forEach(w=>f.push(w.cb))}let b=Object.keys(t);return b.length>xe&&b.map(u=>{let c=t[u]._&&t[u]._[">"],d=c?Math.max(...Object.values(c)):0;return{soul:u,maxState:d}}).sort((u,c)=>u.maxState-c.maxState).slice(0,b.length-xe).forEach(({soul:u})=>delete t[u]),{now:o,defer:m,wait:v,listeners:f}};var Se=be;var G="",oe="",Ce=()=>{let e=(t,r,n)=>{if(n||(e[G]||(e[G]={}),n=e[G]),!t)return n;let s=0,o={},m=t[s],f=t.length-1,l=typeof r>"u",h=n[m];for(;!h&&s<f;)m+=t[++s],h=n[m];if(h)if(s===f){if(l)return typeof h[oe]>"u"?h[G]:h[oe];h[oe]=r}else return!h[G]&&!l&&(h[G]={}),e(t.slice(++s),r,h[G]);else if(B.map(n,(b,p)=>{let i=0,u="";for(;p[i]===t[i];)u+=p[i++];if(u){if(l)return i<=f?void 0:(o[p.slice(i)]=b,b);let c={[p.slice(i)]:b,[t.slice(i)]:{[oe]:r}};return n[u]={[G]:c},delete n[p],!0}})){if(l)return o}else{if(l)return;n[m]||(n[m]={}),n[m][oe]=r}};return e};Ce.map=function e(t,r,n,s){s||(s=[]);var o=t[G]||t,m=Object.keys(o).sort(),f;for(let l=0;l<m.length;l++){let h=m[l],v=o[h],b=v[oe];if(typeof b<"u"){if(b=r(b,s.join("")+h,h,s),typeof b<"u")return b}else n&&r(f,s.join(""),h,s);if(v[G]){if(s.push(h),b=e(v[G],r,n,s),typeof b<"u")return b;s.pop()}}};var q=Ce;var ve="",Oe="",K="",ne=e=>{var t;let r=new Map,n=null,s=0,o=1e4,m=new Map,f=0,l=3e4,h=.8,v=.9;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=100),e.write||(e.write=1),e.size||(e.size=1024*1024),e.memoryLimit||(e.memoryLimit=500),e.readTimeout||(e.readTimeout=1e3),typeof e.cache>"u"&&(e.cache=!0),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let b=(u,c,d,a)=>{let g=Date.now()-c;g>2e3&&console.log(`[RADISK-SLOW] ${u}: ${g}ms for ${d}${a?` (${a} bytes)`:""}`)},p=()=>{if(typeof process>"u"||!process.memoryUsage)return;let u=Date.now();if(u-f<l)return;f=u;let c=process.memoryUsage(),d=c.heapUsed,a=c.heapTotal,g=e.memoryLimit*1024*1024,w=d/g;if(w>v){let y=r.size;console.log(`[RADISK-MEMORY] High memory usage: ${Math.round(w*100)}% of heap limit. Clearing ${y} cached files.`),r.clear(),global.gc&&global.gc(),f=u+l}else w>h&&console.log(`[RADISK-MEMORY] Memory warning: ${Math.round(w*100)}% of heap limit used. Cache size: ${r.size} files.`)},i=(u,c,d)=>{if(u=""+u,typeof c=="function"){if(d=c,c=i.batch(u),typeof c<"u"||i.thrash.at&&(c=i.thrash.at(u),typeof c<"u"))return d(t,c);if(m.has(u)){m.get(u).callbacks.push(d);return}let a={callbacks:[d],fired:!1,timeoutId:null};m.set(u,a),a.timeoutId=setTimeout(()=>{if(!a.fired){a.fired=!0,m.delete(u);let w=new Error("radisk read timeout");a.callbacks.forEach(y=>y(w,void 0))}},e.readTimeout);let g=Date.now();return i.read(u,(w,y)=>{clearTimeout(a.timeoutId),b("read",g,u),a.fired||(a.fired=!0,m.delete(u),a.callbacks.forEach(S=>S(w,y)))})}if(i.batch(u,c),p(),d&&i.batch.acks.push(d),++i.batch.ed>=e.batch)return i.thrash();clearTimeout(i.batch.timeout),i.batch.timeout=setTimeout(i.thrash,e.write)};return i.batch=q(),i.batch.acks=[],i.batch.ed=0,i.thrash=()=>{if(i.thrash.ing)return i.thrash.more=!0;let u=Date.now();clearTimeout(i.batch.timeout),i.thrash.more=!1,i.thrash.ing=!0;var c=i.thrash.at=i.batch;i.batch=null,i.batch=q(),i.batch.acks=[],i.batch.ed=0;let d=0;i.save(c,a=>{++d>1||(b("thrash",u,`batch-${c.ed}`),a&&e.log(a),c.acks.forEach(g=>g(a)),i.thrash.at=null,i.thrash.ing=!1,i.thrash.more&&i.thrash())})},i.save=(u,c)=>{let d={find:(a,g)=>{if(!(g<d.start))return d.start=g,e.store.list(d.lex),!0},lex:a=>{!a||a>d.start?(d.end=a,d.start&&d.mix(d.file||"!",d.start,d.end)):d.file=a},mix:(a,g,w)=>{if(d.start=d.end=d.file=t,r.has(a)){let y=r.get(a);q.map(u,(S,j)=>{if(!(j<g)){if(w&&w<j){d.start=j;return}y(j,S)}}),i.write(a,y,d.next)}else i.parse(a,(y,S)=>{if(y)return c(y);q.map(u,(j,C)=>{if(!(C<g)){if(w&&w<C){d.start=C;return}S(C,j)}}),i.write(a,S,d.next)})},next:a=>{if(a)return c(a);if(d.start)return q.map(u,d.find);c(a)}};q.map(u,d.find)},i.write=(u,c,d)=>{let a={text:"",limit:"",done:!1,count:0,each:(w,y,S,j)=>{if(a.done)return;a.count++,w=typeof w>"u"?"":"="+ne.encode(w);let C=ne.encode(j.length)+"#"+ne.encode(S)+w+`
`;if(a.count>1&&j.length===0&&a.text.length+C.length>e.size){let $=S.indexOf(Oe);if(a.limit=$===-1?S:S.substring(0,$),a.limit!==u){a.done=!0,a.sub=q(),q.map(c,a.slice),i.write(a.limit,a.sub,d);return}}a.text+=C},slice:(w,y)=>{y<a.limit||a.sub(y,w)}};q.map(c,a.each,!0);let g=Date.now();e.store.put(u,a.text,w=>{b("file-write",g,u,a.text.length),d(w)})},i.read=(u,c)=>{let d=u.indexOf(Oe),a=d===-1?u:u.substring(0,d),g={lex:y=>{if(!y){if(!g.file){c("no file found",t);return}if(e.cache&&r.has(g.file)){let S=r.get(g.file);return g.value=S(u),c(t,g.value)}i.parse(g.file,g.it);return}y>a||y<g.file||(g.file=y)},it:(y,S)=>{y&&e.log(y),S&&(e.cache&&(r.set(g.file,S),p()),g.value=S(u)),c(y,g.value)}},w=Date.now();if(e.cache&&n&&w-s<o)n.forEach(y=>g.lex(y)),g.lex();else{let y=[],S=g.lex;g.lex=j=>(j&&y.push(j),S(j)),e.store.list(j=>{g.lex(j),!j&&e.cache&&(n=y,s=w)})}},i.parse=(u,c)=>{let d={disk:q(),read:(a,g)=>{if(a)return c(a);if(!g)return c(t,d.disk);let w=[],y="",S=d.split(g);for(;S;){let j,C,$=S[1];S=d.split(S[2])||"",S[0]==="#"&&(j=S[1],$<w.length&&(w.length=$),$<=w.length&&(w[$]=j,w.length=$+1),y=w.join("")),S=d.split(S[2])||"",S[0]!==`
`&&(S[0]==="="&&(C=S[1]),typeof j<"u"&&typeof C<"u"&&d.disk(y,C),S=d.split(S[2]))}c(t,d.disk)},split:a=>{if(!a)return;let g=a.indexOf(K);if(g===-1)return;let w=a.slice(0,g),y={};return[w,ne.decode(a.slice(g),y),a.slice(g+y.i)]}};e.store.get(u,d.read)},i};ne.encode=e=>{let t="",r="";if(e instanceof Array&&(e.length===2||e.length===3)&&(t=ve+e[1],e.length===3&&e[2]&&(r=ve+e[2]),e=e[0]),typeof e=="string"){let s=0,o=null,m=K;for(;o=e[s++];)o===K&&(m+=K);return m+'"'+e+t+r+K}let n=L.is(e);if(n)return K+"#"+n+t+r+K;if(fe.is(e))return K+"+"+(e||0)+t+r+K;if(e===!0)return K+"+"+t+r+K;if(e===!1)return K+"-"+t+r+K;if(e===null)return K+" "+t+r+K};ne.decode=(e,t)=>{var r=-1,n=0,s=null,o=null,m=-1,f=-1;if(e[0]!==K)return;for(;s=e[++r];)if(o){if(m===-1&&(m=r),s===K&&--n<=0){f=r;break}}else s===K?n++:o=s||!0;let l=m!==-1?e.slice(m,f!==-1?f:r):"";t&&(t.i=r+1);let h=l.split(ve),v=h[0],b=h[1],p=h[2];if(b)if(b=parseFloat(b),p){if(o==='"')return[v,b,p];if(o==="#")return[L.ify(v),b,p];if(o==="+")return v.length===0?[!0,b,p]:[parseFloat(v),b,p];if(o==="-")return[!1,b,p];if(o===" ")return[null,b,p]}else{if(o==='"')return[v,b];if(o==="#")return[L.ify(v),b];if(o==="+")return v.length===0?[!0,b]:[parseFloat(v),b];if(o==="-")return[!1,b];if(o===" ")return[null,b]}else{if(o==='"')return l;if(o==="#")return L.ify(l);if(o==="+")return l.length===0?!0:parseFloat(l);if(o==="-")return!1;if(o===" ")return null}};var Ie=ne;var Me=typeof document>"u",Y=Me?await import("node:fs"):void 0,Ne="",he="",ke=he+"+0"+he+"#"+he+'"root'+he,Xe=e=>{let t=e.file;if(Me)return Y.existsSync(t)||Y.mkdirSync(t),Y.existsSync(t+"/!")||Y.writeFileSync(t+"/!",ke),{get:(r,n)=>{Y.readFile(t+"/"+r,(s,o)=>{if(s){if(s.code==="ENOENT"){n();return}console.log("fs.readFile error:",s)}o&&(o=o.toString()),n(s,o)})},put:(r,n,s)=>{var o=r+"."+R.random(9)+".tmp";Y.writeFile(o,n,m=>{if(m){console.log("fs.writeFile error:",m),s(m);return}Y.rename(o,t+"/"+r,s)})},list:r=>{Y.readdir(t,(n,s)=>{if(n){console.log("fs.readdir error:",n),r();return}s.forEach(r),r()})}};if(e.indexedDB){let r,n=indexedDB.open(t,1);return n.onupgradeneeded=s=>{s.target.result.createObjectStore(t)},n.onerror=s=>{console.log(s)},n.onsuccess=()=>{if(r=n.result,r){let o=r.transaction([t],"readonly").objectStore(t).getKey("!");o.onerror=()=>{console.log(`error getting key ${t}/!`)},o.onsuccess=()=>{if(!o.result){let f=r.transaction([t],"readwrite").objectStore(t).put(ke,"!");f.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(s,o)=>{let m=(h,v)=>{let p=r.transaction([t],"readonly").objectStore(t).get(h);p.onerror=()=>{console.log(`error getting ${t}/${h}`)},p.onsuccess=()=>{v(null,p.result)}};if(r){m(s,o);return}let f=0,l=setInterval(()=>{if(r){clearInterval(l),m(s,o);return}f++>5&&(clearInterval(l),o("error indexedDB not available"))},1e3)},put:(s,o,m)=>{let f=(v,b,p)=>{let u=r.transaction([t],"readwrite").objectStore(t).put(b,v);u.onerror=()=>{console.log(`error putting data on ${t}/${v}`)},u.onsuccess=()=>{p(null)}};if(r){f(s,o,m);return}let l=0,h=setInterval(()=>{if(r){clearInterval(h),f(s,o,m);return}l++>5&&(clearInterval(h),m("error indexedDB not available"))},1e3)},list:s=>{let o=l=>{let v=r.transaction([t],"readonly").objectStore(t).getAllKeys();v.onerror=()=>console.log("error getting keys for",t),v.onsuccess=()=>{v.result.forEach(l),l()}};if(r){o(s);return}let m=0,f=setInterval(()=>{if(r){clearInterval(f),o(s);return}m++>5&&(clearInterval(f),console.log("error indexedDB not available"),s())},1e3)}}}return{get:(r,n)=>{n(null,ke)},put:(r,n,s)=>{s(null)},list:r=>{r("!"),r()}}},Qe=e=>{B.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Xe(e));let t=Ie(e);return{get:(r,n,s)=>{if(!r||!B.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}s||(s={});var o=r["#"],m=!s.secure&&typeof r["."]=="string"?r["."]:"",f,l={};let h=(v,b)=>{if(!(b!==D&&!ee(r["."],b))&&(f||(f={_:{"#":o,">":{}}}),f[b]=v[0],f._[">"][b]=v[1],v.length===3&&v[2])){let p=v[1];l[p]=v[2],l[b]=v[2]}};t(o+Ne+m,(v,b)=>{let p;B.is(b)?(q.map(b,h),f||h(b,m),p={[o]:f}):b&&(h(b,m),p={[o]:f}),p&&p[o]&&Object.keys(l).length>0&&(p[o]._.s=l),n(v,p)})},put:(r,n)=>{if(!r){n("graph required");return}let s=0,o=!1,m=f=>{if(s--,!o){if(f){o=!0,n(f);return}s===0&&(o=!0,n(null))}};Object.keys(r).forEach(f=>{var l=r[f];Object.keys(l).forEach(h=>{if(h==="_")return;s++;let v=l[h],b=l._[">"][h],p=l._.s&&l._.s[b],i=p?[v,b,p]:[v,b];t(f+Ne+h,i,m)})})}}},De=Qe;var Pe=typeof document>"u",Re=Pe?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Re?.WebSocket);var Ze=e=>{let t=new Map,r=1500,n=6e4,s=10,o=null;return e||(o=setInterval(()=>{let f=Date.now();for(let[l,h]of t.entries())f-h.lastCleanup>n&&(h.requests=[],h.lastCleanup=f),h.requests=h.requests.filter(v=>f-v<n),f-h.lastCleanup>n*10&&(h.throttleCount=0)},n/4)),{getDelay:f=>{let l=Date.now(),h=t.get(f)||{requests:[],lastCleanup:l,throttleCount:0};if(h.requests=h.requests.filter(v=>l-v<n),h.requests.length>=r){let v=Math.min(...h.requests),b=n-(l-v);return h.throttleCount=(h.throttleCount||0)+1,t.set(f,h),Math.max(0,b)}return h.requests.push(l),t.set(f,h),0},getRemainingRequests:f=>{let l=t.get(f);if(!l)return r;let h=Date.now(),v=l.requests.filter(b=>h-b<n);return Math.max(0,r-v.length)},getThrottleCount:f=>{let l=t.get(f);return l&&l.throttleCount||0},shouldDisconnect:f=>{let l=t.get(f);return l?l.throttleCount>=s:!1},destroy:()=>{o&&(clearInterval(o),o=null),t.clear()}}},Ye=(e,t=1024*1024)=>{try{if(typeof e=="string"&&e.length>t)throw new Error("Message too large");return{success:!0,data:JSON.parse(e)}}catch(r){return{success:!1,error:r.message}}},Ve=(e,t=1024*1024)=>typeof e=="string"&&e.length>t?{valid:!1,error:"Message too large"}:Buffer.isBuffer(e)&&e.length>t?{valid:!1,error:"Message too large"}:{valid:!0},et=(e=1e3)=>{let t=new Set;return{add:r=>{if(t.size>=e)return!1;t.add(r);let n=r.close;return r.close=(...s)=>(t.delete(r),n.apply(r,s)),!0},remove:r=>{t.delete(r)},count:()=>t.size,isFull:()=>t.size>=e}},_e=(e=5)=>{let t=0;return{shouldRetry:()=>t<e,getDelay:()=>Math.min(1e3*Math.pow(2,t),3e4),increment:()=>t++,reset:()=>t=0}},tt=e=>{let t=Ee(e.maxAge),r=De(e),n={},s={},o={},m=new Set,f=new Map,l=async E=>n[E]?!0:new Promise(k=>{r.get({"#":E},(T,_)=>{k(!T&&_&&_[E])})}),h=e.wss&&e.wss.constructor.name==="Server",v=Ze(h),b=et(e.maxConnections||1e3),p=async(E,k,T)=>{let _=D;for(let x of Object.keys(E)){let A=await new Promise(O=>{c({"#":x,".":_},O,k)});if(A.err)return T&&T(A.err),!1;let N=E[x];if(!(!A.put||!A.put[x]||N[_]===void 0||A.put[x][_]===N[_]))return T&&T(`error in wire check public key does not match for soul: ${x}`),!1}return!0},i=(E,k)=>{let T=me(E.get,n);T?k(JSON.stringify({"#":t.track(R.random(9)),"@":E["#"],put:T})):r.get(E.get,(_,x)=>{k(JSON.stringify({"#":t.track(R.random(9)),"@":E["#"],put:x,err:_}))},{secure:!0})},u=async(E,k)=>{let T=await Se.mix(E.put,n,e.secure,o);if(Object.keys(T.now).length===0){Object.keys(T.defer).length!==0&&setTimeout(()=>u({put:T.defer,"#":E["#"]},k),T.wait);return}await p(T.now,k)&&(r.put(T.now,_=>{k(JSON.stringify({"#":t.track(R.random(9)),"@":E["#"],err:_})),T.listeners.forEach(x=>x())}),Object.keys(T.defer).length!==0&&setTimeout(()=>u({put:T.defer,"#":E["#"]},k),T.wait))},c=(E,k,T,_)=>{if(!k)return;B.is(_)||(_={});let x=me(E,n),A=R.random(9),N=JSON.stringify({"#":t.track(A),get:E});if(x){let O=T(N);if(O&&O.err){k({err:O.err});return}k({put:x});return}r.get(E,(O,U)=>{if(U){let H=T(N);if(H&&H.err){k({err:H.err});return}k({put:U,err:O});return}O&&console.log(O),s[A]=k,f.set(A,{lex:E,wait:_.wait||100});let M=T(N);if(M&&M.err){k({err:M.err}),delete s[A],f.delete(A);return}},_)},d=E=>({get:(k,T,_)=>{k&&typeof k["."]=="number"&&(k={...k,".":String(k["."])}),k&&k["#"]&&m.add(k["#"]),c(k,T,E,_)},put:async(k,T)=>{let _=await Se.mix(k,n,e.secure,o);if(Object.keys(_.now).length===0){T&&T(null);return}if(!await p(_.now,E,T))return;for(let[A,N]of Object.entries(_.now))if(N&&typeof N=="object")for(let[O,U]of Object.entries(N)){let M=L.is(U);M&&m.add(M)}r.put(_.now,A=>{T&&T(A),_.listeners.forEach(N=>N())});let x=E(JSON.stringify({"#":t.track(R.random(9)),put:k}));if(x&&x.err){T&&T(x.err);return}},on:(k,T,_,x)=>{k&&typeof k["."]=="number"&&(k={...k,".":String(k["."])});let A=k&&k["#"];!A||!T||(o[A]?o[A].push({".":k["."],cb:T}):o[A]=[{".":k["."],cb:T}],_&&c(k,T,E,x))},off:(k,T)=>{let _=k&&k["#"];if(!(!_||!o[_]))if(T){let x=o[_].find(A=>A.cb===T);x&&o[_].splice(o[_].indexOf(x),1)}else delete o[_]}});if(Pe){let E=e.wss,k=()=>E.clients();if(!E){let _=e.server?{server:e.server}:{port:e.port||8765};E=new Re.WebSocketServer(_),k=()=>E.clients}let T=(_,x)=>{let N=JSON.parse(_)["#"];if(N&&f.has(N)){let O=f.get(N);f.delete(N),O.timeoutId=setTimeout(()=>{let U=s[N];if(U){let M=O.lex["#"],H={[M]:null};typeof O.lex["."]=="string"&&(H[M]={[O.lex["."]]:null}),U({put:H}),delete s[N]}},O.wait)}k().forEach(O=>{if(O&&O.readyState===WebSocket.OPEN)O.send(_,{binary:x});else{let U=O._retryHandler||_e();if(O._retryHandler=U,U.shouldRetry()){let M=U.getDelay();U.increment(),setTimeout(()=>{O&&O.readyState===WebSocket.OPEN&&(U.reset(),O.send(_,{binary:x}))},M)}}})};return E.on("connection",_=>{if(!b.add(_)){console.log("Connection limit reached, rejecting connection"),_.close(1013,"Connection limit reached - try again later");return}let x=R.random(9);console.log(`New WebSocket client connected: ${x}`),_.on("error",A=>{console.log("WebSocket error:",A),b.remove(_)}),_.on("close",()=>{console.log(`WebSocket client disconnected: ${x}`),b.remove(_)}),_.on("message",(A,N)=>{let O=Ve(A,e.maxMessageSize);if(!O.valid){console.warn(`Invalid message: ${O.error}`),_.send(JSON.stringify({error:O.error}));return}let U=Ye(A,e.maxMessageSize);if(!U.success){console.warn(`JSON parse error: ${U.error}`),_.send(JSON.stringify({error:"Invalid JSON"}));return}let M=U.data;if(t.check(M["#"]))return;let H=v.getDelay(x);if(H>0){let ie=v.getThrottleCount(x);if(console.log(`Client ${x}: rate limit exceeded, delay would be ${H}ms, dropping message (throttle count: ${ie})`),v.shouldDisconnect(x)){console.log(`Client ${x}: Disconnecting after ${ie} throttle violations`),_.close(1008,"Rate limit violations");return}_.send(JSON.stringify({"#":t.track(R.random(9)),"@":M["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(H/1e3)}s`,throttle:H}));return}let se=()=>{t.track(M["#"]),M.get&&i(M,T),M.put&&u(M,T),T(A,N);let ie=M["@"],ae=s[ie];ae&&(delete M["#"],delete M["@"],ae(M),delete s[ie])};H>0?setTimeout(se,H):se()})}),d(T)}let a=[],g=!1,w=0,y=[],S=null,j=e.maxQueueLength||1e4,C=()=>{if(y.length===0){S=null;return}let E=Date.now();if(g&&E<w){S=setTimeout(C,Math.min(1e3,w-E));return}g&&E>=w&&(console.log("Throttle period ended, resuming queue processing"),g=!1,w=0);let k=y[0];if($(k)){y.shift();let x=JSON.parse(k)["#"];if(x&&f.has(x)){let A=f.get(x);f.delete(x),A.timeoutId=setTimeout(()=>{let N=s[x];if(N){let O=A.lex["#"],U={[O]:null};typeof A.lex["."]=="string"&&(U[O]={[A.lex["."]]:null}),N({put:U}),delete s[x]}},A.wait)}}y.length>0?S=setTimeout(C,50):S=null},$=E=>{let k=!1;return a.forEach(T=>{if(T&&T.readyState===WebSocket.OPEN)T.send(E),k=!0;else{let _=T._retryHandler||_e();if(T._retryHandler=_,_.shouldRetry()){let x=_.getDelay();_.increment(),setTimeout(()=>{T&&T.readyState===WebSocket.OPEN&&(_.reset(),T.send(E))},x)}}}),k},I=E=>{if(y.length>=j)return{err:`Message queue exceeded maximum length (${j}). Update query logic to request less data.`,queueLength:y.length,maxQueueLength:j};y.push(E),S||(S=setTimeout(C,50))};return(!(e.peers instanceof Array)||e.peers.length===0)&&(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(E=>{let k=()=>{let T=new WebSocket(E);a.push(T);let _=_e();T.onclose=x=>{if(a.indexOf(T)!==-1&&a.splice(a.indexOf(T),1),T=null,_.shouldRetry()){let A=_.getDelay();_.increment(),setTimeout(k,A)}},T.onopen=()=>{_.reset()},T.onerror=x=>{console.log(x)},T.onmessage=async x=>{let A=JSON.parse(x.data);if(t.check(A["#"]))return;if(A.throttle&&A.err){console.log(`Server throttling: ${A.err}`),g=!0,w=Date.now()+A.throttle;return}if(t.track(A["#"]),A.get&&i(A,I),A.put){let U={};for(let[M,H]of Object.entries(A.put)){let se=!1;if(await l(M)&&(se=!0,H&&typeof H=="object"))for(let[ie,ae]of Object.entries(H)){let Te=L.is(ae);Te&&m.add(Te)}m.has(M)&&(se=!0,m.delete(M)),se&&(U[M]=H)}if(Object.keys(U).length>0){let M={put:U,"#":A["#"]};u(M,I)}}let N=A["@"],O=s[N];O&&(delete A["#"],delete A["@"],O(A),delete s[N])}};k()}),d(I)},ye=tt;var rt=(e,t)=>{t||(t=ye(e));let r=[],n=!1,s=!1,o=0,m=(l,h,v,b)=>{let p=d=>{o++,m(d,h,v,b)},i=d=>{r=[],o=0,s=!1,b(d)},u=()=>{if(r.length===0){i("Wrong username or password");return}let d=r.shift();t.get({"#":d,".":["auth","pub","epub"]},async a=>{if(a.err){i(`error getting ${d}: ${a.err}`);return}let g=a.put&&a.put[d];if(!g||!g.auth)return u();let w=JSON.parse(g.auth),y=await F.work(h,w.salt),S=await F.decrypt(w.enc,y);if(!S)return u();if(f.is={username:l,pub:g.pub,epub:g.epub,priv:S.priv,epriv:S.epriv},v!==""){let j=R.random(64),C=await F.work(v,j),$=await F.encrypt(S,C),I={auth:JSON.stringify({enc:$,salt:j})},E=Date.now(),k=await F.signTimestamp(E,f.is),T=z(d,I,k,g.pub,E);t.put(T,_=>{i(_?`error putting ${I} on ${d}: ${_}`:null)});return}i(null)},{wait:5e3})};if(o>9){i("Wrong username or password");return}let c="~@"+l;t.get({"#":c},async d=>{if(d.err){i(`error getting ${c}: ${d.err}`);return}let a=d.put&&d.put[c];if(!a)return p(l);delete d.put[c]._,r=Object.keys(a),u()},{wait:5e3})},f={create:(l,h,v)=>{let b=i=>{v?v(i):console.log(i)};if(n){b("User is already being created");return}if(l===""){b("Please provide a username");return}if(h===""){b("Please provide a password");return}n=!0;let p="~@"+l;t.get({"#":p},async i=>{if(i.err){n=!1,b(`error getting ${p}: ${i.err}`);return}if(i.put&&i.put[p]){n=!1,b("Username already exists");return}let u=R.random(64),c=await F.work(h,u),d=await F.pair(),a={priv:d.priv,epriv:d.epriv},g=await F.encrypt(a,c),w={username:l,pub:d.pub,epub:d.epub,auth:JSON.stringify({enc:g,salt:u})},y="~"+d.pub,S=Date.now(),j=await F.signTimestamp(S,d),C=z(y,w,j,d.pub,S);t.put(C,$=>{if(n=!1,$){b(`error putting ${w} on ${y}: ${$}`);return}let I={[y]:{"#":y}};t.put(z(p,I),E=>{if(E){b(`error putting ${I} on ${p}: ${E}`);return}v&&v(null)})})},{wait:5e3})},auth:(l,h,v)=>{let b=p=>{v?v(p):p&&console.log(p)};if(s){b("User is already authenticating");return}if(f.is=null,l===""){b("Please provide a username");return}if(h===""){b("Please provide a password");return}s=!0,m(l,h,"",b)},change:(l,h,v,b)=>{let p=i=>{b?b(i):i&&console.log(i)};if(s){p("User is already authenticating");return}if(f.is=null,l===""){p("Please provide a username");return}if(h===""){p("Please provide a password");return}if(v===""){p("Please provide a new password");return}s=!0,m(l,h,v,p)},store:l=>{if(!f.is){console.log("Please authenticate before calling store");return}if(l){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(f.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(f.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let l=globalThis.localStorage.getItem("user.is");if(l){f.is=JSON.parse(l);return}}if(typeof globalThis.sessionStorage<"u"){let l=globalThis.sessionStorage.getItem("user.is");l&&(f.is=JSON.parse(l))}},leave:()=>{f.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(l,h,v)=>{let b=p=>{v?v(p):console.log(p)};if(s){b("User is already authenticating");return}if(l===""){b("Please provide a username");return}if(h===""){b("Please provide a password");return}s=!0,m(l,h,"",async p=>{if(p){b(p);return}let i={username:null,pub:null,epub:null,auth:null},u=Date.now(),c=await F.signTimestamp(u,f.is),d="~"+f.is.pub,a=z(d,i,c,f.is.pub,u);t.put(a,g=>{if(g){b(`error putting null on ${d}: ${g}`);return}f.is=null,v&&v(null)})})}};return f},Ue=rt;var nt=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:B.is(e)||(e={});let t=ye(e),r=Ue(null,t),n=new Map,s=new Map,o=l=>l===null||l===!0||l===!1||typeof l=="string"||L.is(l)||fe.is(l),m=l=>{if(o(l))return!0;if(B.is(l)){let v=[];for(let[b,p]of Object.entries(l)){if(b==="_")return"error underscore cannot be used as a property name";if(B.is(p)||o(p)){v.push(b);continue}return typeof p>"u"?`error undefined ${b} cannot be converted to a graph`:`error ${JSON.stringify({[b]:p})} cannot be converted to a graph`}if(v.length!==0)return v}return`error ${JSON.stringify(l)} cannot be converted to a graph`},f=l=>{let h=(i,u,c,d)=>{t.get(B.put(i,"#",u),async a=>{if(a.err&&console.log(a.err),a.put&&a.put[u]){delete a.put[u]._,delete a.put[u][D],delete a.put[u][V];for(let g of Object.keys(a.put[u])){let w=L.is(a.put[u][g]);if(w){let y=async(S=0)=>{let j=await new Promise(C=>{let $=R.random(),I=s.get(l);s.set($,{chain:[{item:null,soul:w}],user:I?I.user:null}),f($).next(null,C,d)});return j!==null||S>=5?j:(await new Promise(C=>setTimeout(C,50)),y(S+1))};a.put[u][g]=await y()}}c(a.put[u])}else c(null)},d)},v=async(i,u,c,d)=>{if(c){let a=Date.now(),g=await F.signTimestamp(a,c);return z(i,u,g,c.pub,a)}return e.secure?(d||(d=console.log),d(`error putting data on ${i}: user required in secure mode`),null):z(i,u)},b=i=>u=>{let c=s.get(i);c&&typeof c.cb<"u"?setTimeout(()=>c.cb(u),1):u&&console.log("error no callback for data",u,"ctx",c),c&&!c.on&&s.delete(i)},p=(i,u)=>{if(!i){console.log("error resolve request parameter required");return}let c=typeof i.get<"u",d=typeof i.put<"u",a=typeof i.on<"u",g=typeof i.off<"u",w=!1,y=s.get(l);for(var S=1;S<y.chain.length;S++)if(y.chain[S].soul===null){w=!0;break}if(w){let{item:j,soul:C}=y.chain[S-1];return t.get({"#":C,".":j},async $=>{if($.err){console.log(`error getting ${j} on ${C}: ${$.err}`),u&&u(null);return}let I=$.put&&$.put[C];if(I&&typeof I[j]<"u"){let E=L.is(I[j]);if(E)y.chain[S].soul=E,s.set(l,{...y}),c?f(l).next(null,i.get,u,i._opt):d?f(l).put(i.put,u):a?f(l).on(i.on,u,i._get,i._opt):g&&f(l).off(u);else if(c)u(I[j]);else if(d){E=R.random(),I[j]=L.ify(E);let k=await v(C,I,y.user,u);if(k===null)return;t.put(k,T=>{if(T){u(`error putting ${j} on ${C}: ${T}`);return}y.chain[S].soul=E,f(l).put(i.put,u)})}else(a||g&&u)&&u(null)}else if(d){let E=R.random();I||(I={}),I[j]=L.ify(E);let k=await v(C,I,y.user,u);if(k===null)return;t.put(k,T=>{if(T){u(`error putting ${j} on ${C}: ${T}`);return}y.chain[S].soul=E,f(l).put(i.put,u)})}else u&&u(null)},{...i._opt,secure:y.user||e.secure}),!1}return c&&y.chain[y.chain.length-1].item!==null?(y.chain.push({item:null,soul:null}),f(l).next(null,i.get,u,i._opt),!1):y.chain[y.chain.length-1]};return{get:(i,u,c,d)=>{if(typeof u=="function"&&(d=c,c=u,u=null),i===null||i===""||i==="_"){console.log("error please provide a key"),c&&c(null);return}if(u&&typeof c!="function"){console.log("error lex requires a callback function");return}if(l=R.random(),s.set(l,{chain:[{item:String(i),soul:"root"}],cb:c}),!c)return f(l);let a=b(l),{soul:g}=p({get:u,_opt:d},a);g&&h(u,g,a,d)},next:(i,u,c,d)=>{let a=S=>j=>{c?c(j):b(S)(j)};if(typeof u=="function"&&(d=c,c=u,u=null),!l){console.log("error please provide a key using get(key)"),c&&c(null);return}let g=a(l);if(i===""||i==="_"){g(null);return}if(u&&typeof c!="function"){console.log("error lex requires a callback function");return}let w=s.get(l);if(!w)return;if(c&&typeof w.cb>"u"&&(w.cb=c,c=null),i!==null&&w.chain.push({item:String(i),soul:null}),!w.cb)return f(l);let{soul:y}=p({get:u,_opt:d},g);y&&h(u,y,g,d)},put:(i,u,c)=>{typeof u=="function"&&(c=u,u=!1);let d=C=>$=>{c?c($):b(C)($)};if(!l){c&&c("error please provide a key using get(key)");return}let a=s.get(l);if(!a)return;if(!a.cb){if(!c)return;a.cb=c,c=null}u&&(i={[R.random()]:i});let g=d(l),w=m(i);if(typeof w=="string"){g(w);return}let{item:y,soul:S}=p({put:i},g);if(!S)return;if(w===!0){t.get({"#":S,".":y},async C=>{if(C.err){g(`error getting ${S}: ${C.err}`);return}let $=C.put&&C.put[S],I=$&&$[y],E=L.is(I);if(!E){$||($={}),$[y]=i;let k=await v(S,$,a.user,g);if(k===null)return;t.put(k,g);return}t.get({"#":E},async k=>{if(k.err){g(`error getting ${E}: ${k.err}`);return}if(!k.put||!k.put[E]){g(`error ${E} not found`);return}for(let _ of Object.keys(k.put[E])){if(_==="_"||_===D||_===V)continue;let x=await new Promise(A=>{let N=R.random(),O=[{item:_,soul:E}];s.set(N,{chain:O,user:a.user}),f(N).put(null,A)});if(x){g(x);return}}$||($={}),$[y]=i;let T=await v(S,$,a.user,g);T!==null&&t.put(T,g)})},{secure:a.user||e.secure});return}let j=(C=0)=>{t.get({"#":S,".":y},async $=>{if($.err){g(`error getting ${S}.${y}: ${$.err}`);return}let I=$.put&&$.put[S],E=I&&I[y];if(!E&&C<5)return await new Promise(_=>setTimeout(_,50)),j(C+1);let k=L.is(E);if(!k){I||(I={}),I[y]=L.ify(R.random());let _=await v(S,I,a.user,g);if(_===null)return;t.put(_,x=>{if(x)g(`error putting ${y} on ${S}: ${x}`);else{let A=R.random(),N=[{item:y,soul:S}];s.set(A,{chain:N,user:a.user,cb:a.cb}),f(A).put(i)}});return}let T=[];for(let _ of w){let x=await new Promise(A=>{if(B.is(i[_])&&!L.is(i[_])){let N=R.random(),O=[{item:_,soul:k}];s.set(N,{chain:O,user:a.user}),f(N).put(i[_],A)}else T.push(_),A(null)});if(x){g(x,l);return}}if(T.length===0){g(null);return}t.get({"#":k},async _=>{if(_.err){g(`error getting ${k}: ${_.err}`);return}let x=_.put&&_.put[k];x||(x={}),T.forEach(N=>{x[N]=i[N]});let A=await v(k,x,a.user,g);A!==null&&t.put(A,g)})},{secure:a.user||e.secure})};j()},on:(i,u,c,d)=>{if(typeof i=="function"&&(d=c,c=u,u=i,i=null),typeof u!="function"){console.log("error on() requires a callback function");return}if(!l){console.log("error please provide a key using get(key)"),u(null);return}let{item:a,soul:g}=p({on:i,_get:c,_opt:d},u);if(!g)return;let w=s.get(l);s.set(l,{chain:[{item:a,soul:g}],on:!0,user:w?w.user:null}),n.set(u,()=>{t.get({"#":g,".":a},S=>{let j=S.put&&S.put[g]&&S.put[g][a],C=L.is(j);if(C){let $=async(I=0)=>{let E=await new Promise(k=>{let T=R.random();s.set(T,{chain:[{item:null,soul:C}],user:w?w.user:null}),f(T).next(null,k,d)});E!==null||I>=5?u(E):(await new Promise(k=>setTimeout(k,50)),$(I+1))};$()}else u(j!==void 0?j:null)},{...d,secure:w.user||e.secure})});let y;i?(y=B.put(i,"#",g),y["."]!=null&&typeof y["."]=="number"&&(y={...y,".":String(y["."])})):y={"#":g,".":a},t.on(y,n.get(u),!1,d),t.get({"#":g,".":a},S=>{if(S.err){console.log(`error getting ${g}.${a}: ${S.err}`);return}let j=S.put&&S.put[g]&&S.put[g][a],C=L.is(j);if(C){t.off(y,n.get(u));let $;i?$=B.put(y,"#",C):$={"#":C,".":null},t.on($,n.get(u),c,d)}else c&&n.get(u)()},{...d,secure:w.user||e.secure})},off:i=>{if(!l){console.log("error please provide a key using get(key)"),i&&i(null);return}let{item:u,soul:c}=p({off:!0},i);c&&(t.off({"#":c},n.get(i)),t.get({"#":c,".":u},d=>{if(d.err){n.delete(i),s.delete(l);return}let a=d.put&&d.put[c]&&d.put[c][u],g=L.is(a);g&&t.off({"#":g},n.get(i)),n.delete(i),s.delete(l)}))},user:()=>(r.get||(Object.assign(r,f()),r.get=(i,u,c,d)=>{typeof u=="function"&&(d=c,c=u,u=null);let a=null,g=null;if(r.is&&(a=r.is.pub),typeof i=="string"?g=i:i instanceof Array&&(i.length===2?(a=i[0],g=i[1]):i.length===1&&(g=i[0])),!a){console.log("error please log in or provide a public key"),c&&c(null);return}if(g===null||g===""||g==="_"){console.log("error please provide a key"),c&&c(null);return}if(u&&!c){console.log("error lex requires a callback function");return}l=R.random();let w=[{item:String(g),soul:"~"+a}];if(s.set(l,{chain:w,user:r.is,cb:c}),!c)return f(l);let y=b(l),{soul:S}=p({get:u,_opt:d},y);S&&h(u,S,y,d)}),r),wire:t,SEA:F}};return f()},Pt=nt;export{Pt as default};
//# sourceMappingURL=holster.js.map
