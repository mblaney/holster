var fe={is:t=>{if(t instanceof Array)return!1;if(typeof t=="number")return!isNaN(t);if(typeof t=="string"){let e=parseFloat(t);return!isNaN(e)&&isFinite(e)}return!1}},B={is:t=>{if(!t||typeof t!="object")return!1;let r=Object.prototype.toString.call(t).match(/^\[object (\w+)\]$/);return t.constructor===Object||r&&r[1]==="Object"},map:(t,e,r)=>{var n=Object.keys(t);for(let s=0;s<n.length;s++){let u=e(t[n[s]],n[s],r);if(typeof u<"u")return u}},put:(t,e,r)=>(t||(t={}),t[e]=r,t),del:(t,e)=>{if(t)return t[e]=null,delete t[e],t}},Le=(t,e,r)=>{if(r.id){r.id=!1;return}if(e==="#"&&typeof t=="string"){r.id=t;return}r.id=!1},L={is:t=>{if(t&&t["#"]&&!t._&&B.is(t)){let e={};if(B.map(t,Le,e),e.id)return e.id}return!1},ify:t=>B.put({},"#",t)},Y="_holster_user_signature",P="_holster_user_public_key",z=(t,e,r,n,s)=>{let u={[t]:{_:{"#":t,">":{}}}};for(let[g,d]of Object.entries(e))g!=="_"&&g!==P&&g!==Y&&(u[t][g]=d,u[t]._[">"][g]=s||Date.now());return r&&n&&s&&(u[t]._.s={[s]:r},u[t][P]=n,u[t]._[">"][P]=s),u},ee=(t,e)=>{if(typeof e>"u")return t===null;if(typeof t>"u")return!0;if(typeof t=="string")return t===e;if(Array.isArray(t))return t.includes(e);if(!B.is(t)||!e)return!1;let r=t["*"];if(r)return e.slice(0,r.length)===r;let n=t[">"],s=t["<"];return n&&s?e>=n&&e<=s:n?e>=n:s?e<=s:!1},R={random:t=>{var e="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";t||(t=24);for(let n=0;n<t;n++)e+=r.charAt(Math.floor(Math.random()*r.length));return e}};var Be=t=>{t||(t=9e3);let e={store:{}};return e.check=r=>e.store[r]?e.track(r):!1,e.track=r=>(e.store[r]=Date.now(),e.expiry||(e.expiry=setTimeout(()=>{if(e.expiry)return;let n=Date.now();Object.keys(e.store).forEach(s=>{n-e.store[s]>t&&delete e.store[s]}),e.expiry=null},t)),r),e},Ee=Be;var Ke=(t,e,r)=>{if(!t||typeof t!="object")throw new TypeError("lex must be an object");if(!e||typeof e!="object")throw new TypeError("graph must be an object");let n=t["#"];if(!n||typeof n!="string")throw new TypeError("soul must be a string");if(!e[n])return;let s={_:{"#":n,">":{}}},u={};if(typeof t["."]=="string"){let g=t["."];if(typeof e[n][g]>"u")return;s[g]=e[n][g],s._[">"][g]=e[n]._[">"][g];let d=e[n]._[">"][g];if(e[n]._.s&&(e[n]._.s[d]?u[d]=e[n]._.s[d]:e[n]._.s[g]&&(u[g]=e[n]._.s[g])),P&&typeof e[n][P]<"u"){s[P]=e[n][P],s._[">"][P]=e[n]._[">"][P];let a=e[n]._[">"][P];e[n]._.s&&(e[n]._.s[a]?u[a]=e[n]._.s[a]:e[n]._.s[P]&&(u[P]=e[n]._.s[P]))}}else{if(!r)return;for(let g of Object.keys(e[n]))if(g===P||ee(t["."],g)){s[g]=e[n][g],s._[">"][g]=e[n]._[">"][g];let d=e[n]._[">"][g];e[n]._.s&&(e[n]._.s[d]?u[d]=e[n]._.s[d]:e[n]._.s[g]&&(u[g]=e[n]._.s[g]))}}return Object.keys(u).length>0&&(s._.s=u),{[n]:s}},me=Ke;typeof btoa>"u"&&(globalThis.btoa=t=>Buffer.from(t,"binary").toString("base64"),globalThis.atob=t=>Buffer.from(t,"base64").toString("binary"));function ce(){}Object.assign(ce,{from:Array.from});ce.prototype=Object.create(Array.prototype);ce.prototype.toString=function(t,e,r){if(t||(t="utf8"),e||(e=0),r=r?Math.min(Math.max(r,e),this.length):this.length,t==="hex"){let n=new Uint8Array(this.slice(e,r));return Array.from(n,s=>s.toString(16).padStart(2,"0")).join("")}if(t==="utf8")return Array.from({length:r-e},(n,s)=>{let u=this[s+e];return u<0||u>1114111?"\uFFFD":String.fromCharCode(u)}).join("");if(t==="base64"){let n=Array.from({length:r-e},(s,u)=>{let g=this[u+e];return g<0||g>255?"\uFFFD":String.fromCharCode(g)}).join("");return btoa(n)}};var X=ce;var ge={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function Q(...t){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),Q.from(...t)}Q.prototype=Object.create(Array.prototype);var ue=(t,e)=>{if(typeof t!="string")throw new TypeError("Input must be a string for encoding: "+e);if(t.length>ge.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${t.length} > ${ge.MAX_STRING_LENGTH}`)},W=(t,e="buffer operation")=>{if(t>ge.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${e}: ${t} > ${ge.MAX_BUFFER_SIZE}`)},He=t=>{ue(t,"hex");let e=t.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(e))throw new TypeError("Invalid hex string: contains non-hex characters");if(e.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(e.length===0)return new Uint8Array(0);W(e.length/2,"hex parsing");let r=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2){let s=e.substr(n,2);r[n/2]=parseInt(s,16)}return r},Ae=t=>{ue(t,"utf8");try{let r=new TextEncoder().encode(t);return W(r.length,"UTF-8 encoding"),r}catch(e){throw new TypeError("Failed to encode UTF-8 string: "+e.message)}},Fe=t=>{ue(t,"binary"),W(t.length,"binary encoding");let e=new Uint8Array(t.length);for(let r=0;r<t.length;r++){let n=t.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);e[r]=n}return e},Je=t=>{ue(t,"base64");let e=t.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(e))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(e);W(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let s=0;s<r.length;s++)n[s]=r.charCodeAt(s);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},je=t=>{let e;if(t instanceof ArrayBuffer)W(t.byteLength,"ArrayBuffer processing"),e=new Uint8Array(t);else if(ArrayBuffer.isView(t))W(t.byteLength||t.length,"TypedArray processing"),e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);else if(Array.isArray(t)){W(t.length,"Array processing");for(let r=0;r<t.length;r++){let n=t[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}e=new Uint8Array(t)}else if(typeof t=="object"&&t!==null&&typeof t.byteLength=="number")W(t.byteLength,"ArrayBuffer-like processing"),e=new Uint8Array(t);else if(typeof t=="object"&&t!==null&&typeof t.length=="number"){W(t.length,"array-like processing");let r=Array.from(t);for(let n=0;n<r.length;n++){let s=r[n];if(typeof s!="number"||s<0||s>255||!Number.isInteger(s))throw new TypeError(`Invalid byte value at index ${n}: ${s} (must be integer 0-255)`)}e=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof t);return e};Object.assign(Q,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let e=arguments[0];if(e==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof e=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=He(e);break;case"utf8":case"utf-8":r=Ae(e);break;case"binary":case"latin1":r=Fe(e);break;case"base64":r=Je(e);break;case"ascii":ue(e,"ascii");for(let s=0;s<e.length;s++)if(e.charCodeAt(s)>127)throw new TypeError(`Invalid ASCII character at position ${s}: ${e.charCodeAt(s)} > 127`);r=Ae(e);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=je(e);if(!r||r.length===0)return X.from(new Uint8Array(0));try{return X.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(t,e=0){if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Length must be a non-negative integer");if(W(t,"buffer allocation"),typeof e=="number"){if(e<0||e>255||!Number.isInteger(e))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof e=="string"){if(e.length!==1)throw new TypeError("Fill string must be exactly one character");if(e=e.charCodeAt(0),e>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(t);return e!==0&&r.fill(e),X.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(t){if(!Array.isArray(t))throw new TypeError("First argument must be an array");if(t.length===0)return X.from(new Uint8Array(0));let e=0,r=[];for(let n=0;n<t.length;n++){let s=t[n];if(!s)throw new TypeError(`Array element at index ${n} is null or undefined`);let u;try{u=je(s)}catch(g){throw new TypeError(`Invalid array element at index ${n}: ${g.message}`)}e+=u.length,W(e,"buffer concatenation"),r.push(u)}try{let n=new Uint8Array(e),s=0;for(let u of r)n.set(u,s),s+=u.length;return X.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(t){return t instanceof X||t&&typeof t=="object"&&t.constructor===Q},byteLength(t,e="utf8"){if(typeof t!="string")throw new TypeError("First argument must be a string");switch(e.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(t).length;case"ascii":case"binary":case"latin1":return t.length;case"base64":let r=t.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(t.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+e)}}});Q.prototype.from=Q.from;Q.prototype.toString=function(t="utf8",e=0,r=this.length){if(typeof t!="string")throw new TypeError("Encoding must be a string");if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<e)throw new TypeError("End must be an integer >= start");try{return X.prototype.toString.call(this,t,e,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var J=Q;var qe=typeof document>"u",$e=qe?(await import("node:crypto")).webcrypto:globalThis.crypto,D=$e.subtle,de=t=>typeof t=="string"?t:JSON.stringify(t),le=t=>{try{return JSON.parse(t)}catch{return t}},pe=t=>{let e=new Uint8Array(J.alloc(t));return J.from($e.getRandomValues(e))},Z=(t,e)=>{let[r,n]=t.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:e,ext:!0,key_ops:e?["sign"]:["verify"]}},re=async t=>{let e=await D.digest({name:"SHA-256"},new TextEncoder().encode(de(t)));return J.from(e)},we=async(t,e)=>{let r=t+e.toString("utf8"),n=J.from(await re(r),"binary"),s=We(n);return await D.importKey("jwk",s,{name:"AES-GCM"},!1,["encrypt","decrypt"])},We=t=>({kty:"oct",k:t.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var ze={pair:async t=>{let e=await D.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async s=>{let u=await D.exportKey("jwk",s.publicKey);return{priv:(await D.exportKey("jwk",s.privateKey)).d,pub:u.x+"."+u.y}}),r=await D.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async s=>{let u=await D.exportKey("jwk",s.publicKey);return{epriv:(await D.exportKey("jwk",s.privateKey)).d,epub:u.x+"."+u.y}}),n={pub:e.pub,priv:e.priv,epub:r.epub,epriv:r.epriv};return t&&t(n),n},encrypt:async(t,e,r)=>{if(!e||!e.epriv)return r&&r(null),null;let n={s:pe(9),iv:pe(15)},s=await we(e.epriv,n.s).then(g=>D.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},g,new TextEncoder().encode(de(t)))),u={ct:J.from(s,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(u),u},decrypt:async(t,e,r)=>{if(!t||!t.ct||!t.iv||!t.s||!e||!e.epriv)return r&&r(null),null;let n={ct:J.from(t.ct,"base64"),iv:J.from(t.iv,"base64"),s:J.from(t.s,"base64")};try{let s=await we(e.epriv,n.s).then(g=>D.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},g,new Uint8Array(n.ct))),u=le(new TextDecoder("utf8").decode(s));return r&&r(u),u}catch{return r&&r(null),null}},verify:async(t,e,r)=>{if(!e||!e.pub)return r&&r(null),null;let n=le(t),s=await D.importKey("jwk",Z(e.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),u={};if(typeof n.m=="string")u=n.m;else for(let p of Object.keys(n.m).sort())p!=="_"&&p!==P&&p!==Y&&(u[p]=n.m[p]);let g=await re(u),d=new Uint8Array(J.from(n.s,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}};if(await D.verify(a,s,d,new Uint8Array(g))){let p=le(n.m);return r&&r(p),p}return r&&r(null),null},sign:async(t,e,r)=>{if(!e||!e.pub||!e.priv)return r&&r(null),null;let n={};if(typeof t=="string")n=t;else{let p=le(t);for(let k of Object.keys(p).sort())k!=="_"&&k!==P&&k!==Y&&(n[k]=p[k])}let s=await re(n),u=Z(e.pub,e.priv),g={name:"ECDSA",namedCurve:"P-256"},d=await D.importKey("jwk",u,g,!1,["sign"]).then(p=>D.sign({name:"ECDSA",hash:{name:"SHA-256"}},p,new Uint8Array(s))),a={m:n,s:J.from(d,"binary").toString("base64")};return r&&r(a),a},signTimestamp:async(t,e,r)=>{if(!e||!e.pub||!e.priv)return r&&r(null),null;let n=t.toString(),s=await re(n),u=Z(e.pub,e.priv),g={name:"ECDSA",namedCurve:"P-256"},d=await D.importKey("jwk",u,g,!1,["sign"]).then(p=>D.sign({name:"ECDSA",hash:{name:"SHA-256"}},p,new Uint8Array(s))),a=J.from(d,"binary").toString("base64");return r&&r(a),a},verifyTimestamp:async(t,e,r,n)=>{if(!r||!t||!e)return n&&n(!1),!1;try{let s=t.toString(),u=await re(s),g=await D.importKey("jwk",Z(r),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),d=new Uint8Array(J.from(e,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}},p=await D.verify(a,g,d,new Uint8Array(u));return n&&n(p),p}catch(s){return console.log(`error verifying timestamp signature: ${s.message}`),n&&n(!1),!1}},verifyProperties:async(t,e,r)=>{if(!e||!t)return r&&r([]),[];let n=await D.importKey("jwk",Z(e),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),s={name:"ECDSA",hash:{name:"SHA-256"}},u=[],g=t._&&t._.s||{};for(let d of Object.keys(t).sort()){if(d==="_"||d==P)continue;let a=g[d];if(a)try{let p=await re(t[d]),k=new Uint8Array(J.from(a,"base64"));await D.verify(s,n,k,new Uint8Array(p))?u.push(d):console.log(`warning: property '${d}' signature verification failed`)}catch(p){console.log(`warning: property '${d}' error verifying: ${p.message}`)}}return r&&r(u),u},work:async(t,e,r)=>{typeof e=="function"&&(r=e,e=void 0),typeof e>"u"&&(e=pe(9));let n=await D.importKey("raw",new TextEncoder().encode(de(t)),{name:"PBKDF2"},!1,["deriveBits"]),s={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(e),hash:{name:"SHA-256"}},u=await D.deriveBits(s,n,512),g={epriv:J.from(u,"binary").toString("base64")};return r&&r(g),g},secret:async(t,e,r)=>{if(!t||!t.epub||!e||!e.epub||!e.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},s=Z(t.epub),u=await D.importKey("jwk",s,n,!0,[]),g=Z(e.epub,e.epriv,!1);delete g.key_ops;let d=await D.importKey("jwk",g,n,!1,["deriveBits"]).then(async a=>{let p=await D.deriveBits({public:u,name:"ECDH",namedCurve:"P-256"},a,256),k=await D.importKey("raw",new Uint8Array(p),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return D.exportKey("jwk",k).then(({k:v})=>v)});return r&&r({epriv:d}),{epriv:d}}},F=ze;var xe=1e4,be=(t,e,r,n,s=!1)=>t<e?{historical:!0}:t>e?{incoming:!0}:s&&r!==n?{historical:!0}:(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});be.mix=async(t,e,r,n)=>{if(!t||typeof t!="object")throw new TypeError("change must be an object");if(!e||typeof e!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let s=Date.now(),u={},g={},d=[],a=new Map,p=new Map,k=0;for(let h of Object.keys(t)){let i=t[h],o=!1,f=!1,w=0,l=r;if(!i||!i._)continue;let c=i[P];if(i._.s&&c&&(l=!0),h.length>1&&h[0]==="~")if(h[1]==="@")f=!0,l=!1;else{if(c&&h!="~"+c){console.log(`error public key does not match for soul: ${h}`);continue}l=!0}if(l){if(!c||!i._)continue;let y=new Set,m=new Set,b=Object.entries(i._[">"]||{});for(let[x,C]of Object.entries(i._.s||{})){let O=Number(x);if(!isNaN(O)&&O>0){if(b.some(([T,_])=>Number(_)===O&&(e[h]&&e[h]._[">"]?e[h]._[">"][T]:0)>O))continue;if(await F.verifyTimestamp(O,C,c)){y.add(O);for(let[T,_]of b)Number(_)===O&&m.add(T)}}}let $=Object.keys(i).filter(x=>x==="_"||x===P?!1:!b.some(([C,O])=>C===x&&y.has(Number(O))));if($.length>0){let x={_:i._};for(let O of $)x[O]=i[O];(await F.verifyProperties(x,c)).forEach(O=>m.add(O))}if(m.size===0)continue;a.set(h,m),p.set(h,y)}for(let y of Object.keys(i)){if(y==="_"||a.has(h)&&!a.get(h).has(y))continue;let m=i[y],b=i._&&i._[">"]?i._[">"][y]:0,$=(e[h]||{})[y],x=(e[h]||{_:{">":{}}})._[">"][y]||0;if(f&&y!==L.is(m)){console.log(`error alias ${f}: ${y} !== ${L.is(m)}`);continue}let C=b-s;if(C>0){if(C>864e5)continue;(k===0||C<k)&&(k=w=C),g[h]||(g[h]={_:{"#":h,">":{},s:{}}}),g[h][y]=m,g[h]._[">"][y]=b,i._.s&&(i._.s[b]?g[h]._.s[b]=i._.s[b]:i._.s[y]&&(g[h]._.s[y]=i._.s[y]))}else{let O=p.has(h)&&p.get(h).has(b);be(b,x,m,$,O).incoming&&(u[h]||(u[h]={_:{"#":h,">":{},s:{}}}),e[h]||(e[h]={_:{"#":h,">":{},s:{}}}),e[h][y]=u[h][y]=m,e[h]._[">"][y]=u[h]._[">"][y]=b,i._.s&&(i._.s[b]?e[h]._.s[b]=u[h]._.s[b]=i._.s[b]:i._.s[y]&&(e[h]._.s[y]=u[h]._.s[y]=i._.s[y])),n[h]&&n[h].filter(S=>ee(S["."],y)).forEach(S=>d.push(S.cb)),o=!0)}}o&&n[h]&&n[h].filter(y=>ee(y["."])).forEach(y=>d.push(y.cb))}let v=Object.keys(e);return v.length>xe&&v.map(o=>{let f=e[o]._&&e[o]._[">"],w=f?Math.max(...Object.values(f)):0;return{soul:o,maxState:w}}).sort((o,f)=>o.maxState-f.maxState).slice(0,v.length-xe).forEach(({soul:o})=>delete e[o]),{now:u,defer:g,wait:k,listeners:d}};var Se=be;var G="",oe="",Ce=()=>{let t=(e,r,n)=>{if(n||(t[G]||(t[G]={}),n=t[G]),!e)return n;let s=0,u={},g=e[s],d=e.length-1,a=typeof r>"u",p=n[g];for(;!p&&s<d;)g+=e[++s],p=n[g];if(p)if(s===d){if(a)return typeof p[oe]>"u"?p[G]:p[oe];p[oe]=r}else return!p[G]&&!a&&(p[G]={}),t(e.slice(++s),r,p[G]);else if(B.map(n,(v,h)=>{let i=0,o="";for(;h[i]===e[i];)o+=h[i++];if(o){if(a)return i<=d?void 0:(u[h.slice(i)]=v,v);let f={[h.slice(i)]:v,[e.slice(i)]:{[oe]:r}};return n[o]={[G]:f},delete n[h],!0}})){if(a)return u}else{if(a)return;n[g]||(n[g]={}),n[g][oe]=r}};return t};Ce.map=function t(e,r,n,s){s||(s=[]);var u=e[G]||e,g=Object.keys(u).sort(),d;for(let a=0;a<g.length;a++){let p=g[a],k=u[p],v=k[oe];if(typeof v<"u"){if(v=r(v,s.join("")+p,p,s),typeof v<"u")return v}else n&&r(d,s.join(""),p,s);if(k[G]){if(s.push(p),v=t(k[G],r,n,s),typeof v<"u")return v;s.pop()}}};var q=Ce;var ve="",Oe="",H="",ne=t=>{var e;let r=new Map,n=null,s=0,u=1e4,g=new Map,d=0,a=3e4,p=.8,k=.9;if(t||(t={}),t.log||(t.log=console.log),t.batch||(t.batch=100),t.write||(t.write=1),t.size||(t.size=1024*1024),t.memoryLimit||(t.memoryLimit=500),t.readTimeout||(t.readTimeout=1e3),typeof t.cache>"u"&&(t.cache=!0),!t.store){t.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!t.store.get){t.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!t.store.put){t.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!t.store.list){t.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let v=(o,f,w,l)=>{let c=Date.now()-f;c>2e3&&console.log(`[RADISK-SLOW] ${o}: ${c}ms for ${w}${l?` (${l} bytes)`:""}`)},h=()=>{if(typeof process>"u"||!process.memoryUsage)return;let o=Date.now();if(o-d<a)return;d=o;let f=process.memoryUsage(),w=f.heapUsed,l=f.heapTotal,c=t.memoryLimit*1024*1024,y=w/c;if(y>k){let m=r.size;console.log(`[RADISK-MEMORY] High memory usage: ${Math.round(y*100)}% of heap limit. Clearing ${m} cached files.`),r.clear(),global.gc&&global.gc(),d=o+a}else y>p&&console.log(`[RADISK-MEMORY] Memory warning: ${Math.round(y*100)}% of heap limit used. Cache size: ${r.size} files.`)},i=(o,f,w)=>{if(o=""+o,typeof f=="function"){if(w=f,f=i.batch(o),typeof f<"u"||i.thrash.at&&(f=i.thrash.at(o),typeof f<"u"))return w(e,f);if(g.has(o)){g.get(o).callbacks.push(w);return}let l={callbacks:[w],fired:!1,timeoutId:null};g.set(o,l),l.timeoutId=setTimeout(()=>{if(!l.fired){l.fired=!0,g.delete(o);let y=new Error("radisk read timeout");l.callbacks.forEach(m=>m(y,void 0))}},t.readTimeout);let c=Date.now();return i.read(o,(y,m)=>{clearTimeout(l.timeoutId),v("read",c,o),l.fired||(l.fired=!0,g.delete(o),l.callbacks.forEach(b=>b(y,m)))})}if(i.batch(o,f),h(),w&&i.batch.acks.push(w),++i.batch.ed>=t.batch)return i.thrash();clearTimeout(i.batch.timeout),i.batch.timeout=setTimeout(i.thrash,t.write)};return i.batch=q(),i.batch.acks=[],i.batch.ed=0,i.thrash=()=>{if(i.thrash.ing)return i.thrash.more=!0;let o=Date.now();clearTimeout(i.batch.timeout),i.thrash.more=!1,i.thrash.ing=!0;var f=i.thrash.at=i.batch;i.batch=null,i.batch=q(),i.batch.acks=[],i.batch.ed=0;let w=0;i.save(f,l=>{++w>1||(v("thrash",o,`batch-${f.ed}`),l&&t.log(l),f.acks.forEach(c=>c(l)),i.thrash.at=null,i.thrash.ing=!1,i.thrash.more&&i.thrash())})},i.save=(o,f)=>{let w={find:(l,c)=>{if(!(c<w.start))return w.start=c,t.store.list(w.lex),!0},lex:l=>{!l||l>w.start?(w.end=l,w.start&&w.mix(w.file||"!",w.start,w.end)):w.file=l},mix:(l,c,y)=>{if(w.start=w.end=w.file=e,r.has(l)){let m=r.get(l);q.map(o,(b,$)=>{if(!($<c)){if(y&&y<$){w.start=$;return}m($,b)}}),i.write(l,m,w.next)}else i.parse(l,(m,b)=>{if(m)return f(m);q.map(o,($,x)=>{if(!(x<c)){if(y&&y<x){w.start=x;return}b(x,$)}}),i.write(l,b,w.next)})},next:l=>{if(l)return f(l);if(w.start)return q.map(o,w.find);f(l)}};q.map(o,w.find)},i.write=(o,f,w)=>{let l={text:"",limit:"",done:!1,count:0,each:(y,m,b,$)=>{if(l.done)return;l.count++,y=typeof y>"u"?"":"="+ne.encode(y);let x=ne.encode($.length)+"#"+ne.encode(b)+y+`
`;if(l.count>1&&$.length===0&&l.text.length+x.length>t.size){let C=b.indexOf(Oe);if(l.limit=C===-1?b:b.substring(0,C),l.limit!==o){l.done=!0,l.sub=q(),q.map(f,l.slice),i.write(l.limit,l.sub,w);return}}l.text+=x},slice:(y,m)=>{m<l.limit||l.sub(m,y)}};q.map(f,l.each,!0);let c=Date.now();t.store.put(o,l.text,y=>{v("file-write",c,o,l.text.length),w(y)})},i.read=(o,f)=>{let w=o.indexOf(Oe),l=w===-1?o:o.substring(0,w),c={lex:m=>{if(!m){if(!c.file){f("no file found",e);return}if(t.cache&&r.has(c.file)){let b=r.get(c.file);return c.value=b(o),f(e,c.value)}i.parse(c.file,c.it);return}m>l||m<c.file||(c.file=m)},it:(m,b)=>{m&&t.log(m),b&&(t.cache&&(r.set(c.file,b),h()),c.value=b(o)),f(m,c.value)}},y=Date.now();if(t.cache&&n&&y-s<u)n.forEach(m=>c.lex(m)),c.lex();else{let m=[],b=c.lex;c.lex=$=>($&&m.push($),b($)),t.store.list($=>{c.lex($),!$&&t.cache&&(n=m,s=y)})}},i.parse=(o,f)=>{let w={disk:q(),read:(l,c)=>{if(l)return f(l);if(!c)return f(e,w.disk);let y=[],m="",b=w.split(c);for(;b;){let $,x,C=b[1];b=w.split(b[2])||"",b[0]==="#"&&($=b[1],C<y.length&&(y.length=C),C<=y.length&&(y[C]=$,y.length=C+1),m=y.join("")),b=w.split(b[2])||"",b[0]!==`
`&&(b[0]==="="&&(x=b[1]),typeof $<"u"&&typeof x<"u"&&w.disk(m,x),b=w.split(b[2]))}f(e,w.disk)},split:l=>{if(!l)return;let c=l.indexOf(H);if(c===-1)return;let y=l.slice(0,c),m={};return[y,ne.decode(l.slice(c),m),l.slice(c+m.i)]}};t.store.get(o,w.read)},i};ne.encode=t=>{let e="",r="";if(t instanceof Array&&(t.length===2||t.length===3)&&(e=ve+t[1],t.length===3&&t[2]&&(r=ve+t[2]),t=t[0]),typeof t=="string"){let s=0,u=null,g=H;for(;u=t[s++];)u===H&&(g+=H);return g+'"'+t+e+r+H}let n=L.is(t);if(n)return H+"#"+n+e+r+H;if(fe.is(t))return H+"+"+(t||0)+e+r+H;if(t===!0)return H+"+"+e+r+H;if(t===!1)return H+"-"+e+r+H;if(t===null)return H+" "+e+r+H};ne.decode=(t,e)=>{var r=-1,n=0,s=null,u=null,g=-1,d=-1;if(t[0]!==H)return;for(;s=t[++r];)if(u){if(g===-1&&(g=r),s===H&&--n<=0){d=r;break}}else s===H?n++:u=s||!0;let a=g!==-1?t.slice(g,d!==-1?d:r):"";e&&(e.i=r+1);let p=a.split(ve),k=p[0],v=p[1],h=p[2];if(v)if(v=parseFloat(v),h){if(u==='"')return[k,v,h];if(u==="#")return[L.ify(k),v,h];if(u==="+")return k.length===0?[!0,v,h]:[parseFloat(k),v,h];if(u==="-")return[!1,v,h];if(u===" ")return[null,v,h]}else{if(u==='"')return[k,v];if(u==="#")return[L.ify(k),v];if(u==="+")return k.length===0?[!0,v]:[parseFloat(k),v];if(u==="-")return[!1,v];if(u===" ")return[null,v]}else{if(u==='"')return a;if(u==="#")return L.ify(a);if(u==="+")return a.length===0?!0:parseFloat(a);if(u==="-")return!1;if(u===" ")return null}};var Ne=ne;var Me=typeof document>"u",V=Me?await import("node:fs"):void 0,Ie="",he="",ke=he+"+0"+he+"#"+he+'"root'+he,Xe=t=>{let e=t.file;if(Me)return V.existsSync(e)||V.mkdirSync(e),V.existsSync(e+"/!")||V.writeFileSync(e+"/!",ke),{get:(r,n)=>{V.readFile(e+"/"+r,(s,u)=>{if(s){if(s.code==="ENOENT"){n();return}console.log("fs.readFile error:",s)}u&&(u=u.toString()),n(s,u)})},put:(r,n,s)=>{var u=r+"."+R.random(9)+".tmp";V.writeFile(u,n,g=>{if(g){console.log("fs.writeFile error:",g),s(g);return}V.rename(u,e+"/"+r,s)})},list:r=>{V.readdir(e,(n,s)=>{if(n){console.log("fs.readdir error:",n),r();return}s.forEach(r),r()})}};if(t.indexedDB){let r,n=new Promise((s,u)=>{let g=indexedDB.open(e,1);g.onupgradeneeded=d=>{d.target.result.createObjectStore(e)},g.onerror=d=>{console.log(d),u(d)},g.onsuccess=()=>{if(r=g.result,r){let a=r.transaction([e],"readonly").objectStore(e).getKey("!");a.onerror=()=>{console.log(`error getting key ${e}/!`),u(a.error)},a.onsuccess=()=>{if(a.result)s();else{let k=r.transaction([e],"readwrite").objectStore(e).put(ke,"!");k.onerror=()=>{console.log(`error putting root on ${e}/!`),u(k.error)},k.onsuccess=()=>{s()}}}}else console.log("error indexedDB not available"),u(new Error("indexedDB not available"))}});return{get:(s,u)=>{let g=(d,a)=>{let k=r.transaction([e],"readonly").objectStore(e).get(d);k.onerror=()=>{console.log(`error getting ${e}/${d}`)},k.onsuccess=()=>{a(null,k.result)}};n.then(()=>{g(s,u)}).catch(d=>{u(d)})},put:(s,u,g)=>{let d=(a,p,k)=>{let h=r.transaction([e],"readwrite").objectStore(e).put(p,a);h.onerror=()=>{console.log(`error putting data on ${e}/${a}`)},h.onsuccess=()=>{k(null)}};n.then(()=>{d(s,u,g)}).catch(a=>{g(a)})},list:s=>{let u=g=>{let a=r.transaction([e],"readonly").objectStore(e).getAllKeys();a.onerror=()=>console.log("error getting keys for",e),a.onsuccess=()=>{a.result.forEach(g),g()}};n.then(()=>{u(s)}).catch(g=>{console.log("error indexedDB not available:",g),s()})}}}return{get:(r,n)=>{n(null,ke)},put:(r,n,s)=>{s(null)},list:r=>{r("!"),r()}}},Qe=t=>{B.is(t)||(t={}),t.file=String(t.file||"radata"),t.store||(t.store=Xe(t));let e=Ne(t);return{get:(r,n,s)=>{if(!r||!B.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}s||(s={});var u=r["#"],g=!s.secure&&typeof r["."]=="string"?r["."]:"",d,a={};let p=(k,v)=>{if(!(v!==P&&!ee(r["."],v))&&(d||(d={_:{"#":u,">":{}}}),d[v]=k[0],d._[">"][v]=k[1],k.length===3&&k[2])){let h=k[1];a[h]=k[2],a[v]=k[2]}};e(u+Ie+g,(k,v)=>{let h;B.is(v)?(q.map(v,p),d||p(v,g),h={[u]:d}):v&&(p(v,g),h={[u]:d}),h&&h[u]&&Object.keys(a).length>0&&(h[u]._.s=a),n(k,h)})},put:(r,n)=>{if(!r){n("graph required");return}let s=0,u=!1,g=d=>{if(s--,!u){if(d){u=!0,n(d);return}s===0&&(u=!0,n(null))}};Object.keys(r).forEach(d=>{var a=r[d];Object.keys(a).forEach(p=>{if(p==="_")return;s++;let k=a[p],v=a._[">"][p],h=a._.s&&a._.s[v],i=h?[k,v,h]:[k,v];e(d+Ie+p,i,g)})})}}},Pe=Qe;var De=typeof document>"u",Re=De?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Re?.WebSocket);var Ze=t=>{let e=new Map,r=1500,n=6e4,s=10,u=null;return t||(u=setInterval(()=>{let d=Date.now();for(let[a,p]of e.entries())d-p.lastCleanup>n&&(p.requests=[],p.lastCleanup=d),p.requests=p.requests.filter(k=>d-k<n),d-p.lastCleanup>n*10&&(p.throttleCount=0)},n/4)),{getDelay:d=>{let a=Date.now(),p=e.get(d)||{requests:[],lastCleanup:a,throttleCount:0};if(p.requests=p.requests.filter(k=>a-k<n),p.requests.length>=r){let k=Math.min(...p.requests),v=n-(a-k);return p.throttleCount=(p.throttleCount||0)+1,e.set(d,p),Math.max(0,v)}return p.requests.push(a),e.set(d,p),0},getRemainingRequests:d=>{let a=e.get(d);if(!a)return r;let p=Date.now(),k=a.requests.filter(v=>p-v<n);return Math.max(0,r-k.length)},getThrottleCount:d=>{let a=e.get(d);return a&&a.throttleCount||0},shouldDisconnect:d=>{let a=e.get(d);return a?a.throttleCount>=s:!1},destroy:()=>{u&&(clearInterval(u),u=null),e.clear()}}},Ve=(t,e=1024*1024)=>{try{if(typeof t=="string"&&t.length>e)throw new Error("Message too large");return{success:!0,data:JSON.parse(t)}}catch(r){return{success:!1,error:r.message}}},Ye=(t,e=1024*1024)=>typeof t=="string"&&t.length>e?{valid:!1,error:"Message too large"}:Buffer.isBuffer(t)&&t.length>e?{valid:!1,error:"Message too large"}:{valid:!0},et=(t=1e3)=>{let e=new Set;return{add:r=>{if(e.size>=t)return!1;e.add(r);let n=r.close;return r.close=(...s)=>(e.delete(r),n.apply(r,s)),!0},remove:r=>{e.delete(r)},count:()=>e.size,isFull:()=>e.size>=t}},_e=(t=5)=>{let e=0;return{shouldRetry:()=>e<t,getDelay:()=>Math.min(1e3*Math.pow(2,e),3e4),increment:()=>e++,reset:()=>e=0}},tt=t=>{let e=Ee(t.maxAge),r=Pe(t),n={},s={},u={},g=new Set,d=new Map,a=async E=>n[E]?!0:new Promise(S=>{r.get({"#":E},(T,_)=>{S(!T&&_&&_[E])})}),p=t.wss&&t.wss.constructor.name==="Server",k=Ze(p),v=et(t.maxConnections||1e3),h=async(E,S,T)=>{let _=P;for(let A of Object.keys(E)){let j=await new Promise(N=>{f({"#":A,".":_},N,S)});if(j.err)return T&&T(j.err),!1;let I=E[A];if(!(!j.put||!j.put[A]||I[_]===void 0||j.put[A][_]===I[_]))return T&&T(`error in wire check public key does not match for soul: ${A}`),!1}return!0},i=(E,S)=>{let T=me(E.get,n);T?S(JSON.stringify({"#":e.track(R.random(9)),"@":E["#"],put:T})):r.get(E.get,(_,A)=>{S(JSON.stringify({"#":e.track(R.random(9)),"@":E["#"],put:A,err:_}))},{secure:!0})},o=async(E,S)=>{let T=await Se.mix(E.put,n,t.secure,u);if(Object.keys(T.now).length===0){Object.keys(T.defer).length!==0&&setTimeout(()=>o({put:T.defer,"#":E["#"]},S),T.wait);return}await h(T.now,S)&&(r.put(T.now,_=>{S(JSON.stringify({"#":e.track(R.random(9)),"@":E["#"],err:_})),T.listeners.forEach(A=>A())}),Object.keys(T.defer).length!==0&&setTimeout(()=>o({put:T.defer,"#":E["#"]},S),T.wait))},f=(E,S,T,_)=>{if(!S)return;B.is(_)||(_={});let A=me(E,n,_.fast),j=R.random(9),I=JSON.stringify({"#":e.track(j),get:E});if(A){let N=T(I);if(N&&N.err){S({err:N.err});return}S({put:A});return}r.get(E,(N,U)=>{if(U){let K=T(I);if(K&&K.err){S({err:K.err});return}S({put:U,err:N});return}N&&console.log(N),s[j]=S,d.set(j,{lex:E,wait:_.wait||100});let M=T(I);if(M&&M.err){S({err:M.err}),delete s[j],d.delete(j);return}},_)},w=E=>({get:(S,T,_)=>{S&&typeof S["."]=="number"&&(S={...S,".":String(S["."])}),S&&S["#"]&&g.add(S["#"]),f(S,T,E,_)},put:async(S,T)=>{let _=await Se.mix(S,n,t.secure,u);if(Object.keys(_.now).length===0){T&&T(null);return}if(!await h(_.now,E,T))return;for(let[j,I]of Object.entries(_.now))if(I&&typeof I=="object")for(let[N,U]of Object.entries(I)){let M=L.is(U);M&&g.add(M)}r.put(_.now,j=>{T&&T(j),_.listeners.forEach(I=>I())});let A=E(JSON.stringify({"#":e.track(R.random(9)),put:S}));if(A&&A.err){T&&T(A.err);return}},on:(S,T,_,A)=>{S&&typeof S["."]=="number"&&(S={...S,".":String(S["."])});let j=S&&S["#"];!j||!T||(u[j]?u[j].push({".":S["."],cb:T}):u[j]=[{".":S["."],cb:T}],_&&f(S,T,E,A))},off:(S,T)=>{let _=S&&S["#"];if(!(!_||!u[_]))if(T){let A=u[_].find(j=>j.cb===T);A&&u[_].splice(u[_].indexOf(A),1)}else delete u[_]}});if(De){let E=t.wss,S=()=>E.clients();if(!E){let _=t.server?{server:t.server}:{port:t.port||8765};E=new Re.WebSocketServer(_),S=()=>E.clients}let T=(_,A)=>{let I=JSON.parse(_)["#"];if(I&&d.has(I)){let N=d.get(I);d.delete(I),N.timeoutId=setTimeout(()=>{let U=s[I];if(U){let M=N.lex["#"],K={[M]:null};typeof N.lex["."]=="string"&&(K[M]={[N.lex["."]]:null}),U({put:K}),delete s[I]}},N.wait)}S().forEach(N=>{if(N&&N.readyState===WebSocket.OPEN)N.send(_,{binary:A});else{let U=N._retryHandler||_e();if(N._retryHandler=U,U.shouldRetry()){let M=U.getDelay();U.increment(),setTimeout(()=>{N&&N.readyState===WebSocket.OPEN&&(U.reset(),N.send(_,{binary:A}))},M)}}})};return E.on("connection",_=>{if(!v.add(_)){console.log("Connection limit reached, rejecting connection"),_.close(1013,"Connection limit reached - try again later");return}let A=R.random(9);console.log(`New WebSocket client connected: ${A}`),_.on("error",j=>{console.log("WebSocket error:",j),v.remove(_)}),_.on("close",()=>{console.log(`WebSocket client disconnected: ${A}`),v.remove(_)}),_.on("message",(j,I)=>{let N=Ye(j,t.maxMessageSize);if(!N.valid){console.warn(`Invalid message: ${N.error}`),_.send(JSON.stringify({error:N.error}));return}let U=Ve(j,t.maxMessageSize);if(!U.success){console.warn(`JSON parse error: ${U.error}`),_.send(JSON.stringify({error:"Invalid JSON"}));return}let M=U.data;if(e.check(M["#"]))return;let K=k.getDelay(A);if(K>0){let ie=k.getThrottleCount(A);if(console.log(`Client ${A}: rate limit exceeded, delay would be ${K}ms, dropping message (throttle count: ${ie})`),k.shouldDisconnect(A)){console.log(`Client ${A}: Disconnecting after ${ie} throttle violations`),_.close(1008,"Rate limit violations");return}_.send(JSON.stringify({"#":e.track(R.random(9)),"@":M["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(K/1e3)}s`,throttle:K}));return}let se=async()=>{e.track(M["#"]),M.get&&i(M,T),M.put&&await o(M,T),T(j,I);let ie=M["@"],ae=s[ie];ae&&(delete M["#"],delete M["@"],ae(M),delete s[ie])};K>0?setTimeout(se,K):se()})}),w(T)}let l=[],c=!1,y=0,m=[],b=null,$=t.maxQueueLength||1e4,x=()=>{if(m.length===0){b=null;return}let E=Date.now();if(c&&E<y){b=setTimeout(x,Math.min(1e3,y-E));return}c&&E>=y&&(console.log("Throttle period ended, resuming queue processing"),c=!1,y=0);let S=m[0];if(C(S)){m.shift();let A=JSON.parse(S)["#"];if(A&&d.has(A)){let j=d.get(A);d.delete(A),j.timeoutId=setTimeout(()=>{let I=s[A];if(I){let N=j.lex["#"],U={[N]:null};typeof j.lex["."]=="string"&&(U[N]={[j.lex["."]]:null}),I({put:U}),delete s[A]}},j.wait)}}m.length>0?b=setTimeout(x,50):b=null},C=E=>{let S=!1;return l.forEach(T=>{if(T&&T.readyState===WebSocket.OPEN)T.send(E),S=!0;else{let _=T._retryHandler||_e();if(T._retryHandler=_,_.shouldRetry()){let A=_.getDelay();_.increment(),setTimeout(()=>{T&&T.readyState===WebSocket.OPEN&&(_.reset(),T.send(E))},A)}}}),S},O=E=>{if(m.length>=$)return{err:`Message queue exceeded maximum length (${$}). Update query logic to request less data.`,queueLength:m.length,maxQueueLength:$};m.push(E),b||(b=setTimeout(x,50))};return(!(t.peers instanceof Array)||t.peers.length===0)&&(t.peers=[`ws://localhost:${t.port||8765}`]),t.peers.forEach(E=>{let S=()=>{let T=new WebSocket(E);l.push(T);let _=_e();T.onclose=A=>{if(l.indexOf(T)!==-1&&l.splice(l.indexOf(T),1),T=null,_.shouldRetry()){let j=_.getDelay();_.increment(),setTimeout(S,j)}},T.onopen=()=>{_.reset()},T.onerror=A=>{console.log(A)},T.onmessage=async A=>{let j=JSON.parse(A.data);if(e.check(j["#"]))return;if(j.throttle&&j.err){console.log(`Server throttling: ${j.err}`),c=!0,y=Date.now()+j.throttle;return}if(e.track(j["#"]),j.get&&i(j,O),j.put){let U={};for(let[M,K]of Object.entries(j.put)){let se=!1;if(await a(M)&&(se=!0,K&&typeof K=="object"))for(let[ie,ae]of Object.entries(K)){let Te=L.is(ae);Te&&g.add(Te)}g.has(M)&&(se=!0,g.delete(M)),se&&(U[M]=K)}if(Object.keys(U).length>0){let M={put:U,"#":j["#"]};await o(M,O)}}let I=j["@"],N=s[I];N&&(delete j["#"],delete j["@"],N(j),delete s[I])}};S()}),w(O)},ye=tt;var rt=(t,e)=>{e||(e=ye(t));let r=t?.wait??5e3,n=[],s=!1,u=!1,g=0,d=(p,k,v,h)=>{let i=l=>{g++,d(l,k,v,h)},o=l=>{n=[],g=0,u=!1,h(l)},f=()=>{if(n.length===0){o("Wrong username or password");return}let l=n.shift();e.get({"#":l,".":["auth","pub","epub"]},async c=>{if(c.err){o(`error getting ${l}: ${c.err}`);return}let y=c.put&&c.put[l];if(!y||!y.auth)return f();let m=JSON.parse(y.auth),b=await F.work(k,m.salt),$=await F.decrypt(m.enc,b);if(!$)return f();if(a.is={username:p,pub:y.pub,epub:y.epub,priv:$.priv,epriv:$.epriv},v!==""){let x=R.random(64),C=await F.work(v,x),O=await F.encrypt($,C),E={auth:JSON.stringify({enc:O,salt:x})},S=Date.now(),T=await F.signTimestamp(S,a.is),_=z(l,E,T,y.pub,S);e.put(_,A=>{o(A?`error putting ${E} on ${l}: ${A}`:null)});return}o(null)},{wait:r})};if(g>9){o("Wrong username or password");return}let w="~@"+p;e.get({"#":w},async l=>{if(l.err){o(`error getting ${w}: ${l.err}`);return}let c=l.put&&l.put[w];if(!c)return i(p);delete l.put[w]._,n=Object.keys(c),f()},{wait:r})},a={create:(p,k,v)=>{let h=o=>{v?v(o):console.log(o)};if(s){h("User is already being created");return}if(p===""){h("Please provide a username");return}if(k===""){h("Please provide a password");return}s=!0;let i="~@"+p;e.get({"#":i},async o=>{if(o.err){s=!1,h(`error getting ${i}: ${o.err}`);return}if(o.put&&o.put[i]){s=!1,h("Username already exists");return}let f=R.random(64),w=await F.work(k,f),l=await F.pair(),c={priv:l.priv,epriv:l.epriv},y=await F.encrypt(c,w),m={username:p,pub:l.pub,epub:l.epub,auth:JSON.stringify({enc:y,salt:f})},b="~"+l.pub,$=Date.now(),x=await F.signTimestamp($,l),C=z(b,m,x,l.pub,$);e.put(C,O=>{if(s=!1,O){h(`error putting ${m} on ${b}: ${O}`);return}let E={[b]:{"#":b}};e.put(z(i,E),S=>{if(S){h(`error putting ${E} on ${i}: ${S}`);return}v&&v(null)})})},{wait:r})},auth:(p,k,v)=>{let h=i=>{v?v(i):i&&console.log(i)};if(u){h("User is already authenticating");return}if(a.is=null,p===""){h("Please provide a username");return}if(k===""){h("Please provide a password");return}u=!0,d(p,k,"",h)},change:(p,k,v,h)=>{let i=o=>{h?h(o):o&&console.log(o)};if(u){i("User is already authenticating");return}if(a.is=null,p===""){i("Please provide a username");return}if(k===""){i("Please provide a password");return}if(v===""){i("Please provide a new password");return}u=!0,d(p,k,v,i)},store:p=>{if(!a.is){console.log("Please authenticate before calling store");return}if(p){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(a.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(a.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let p=globalThis.localStorage.getItem("user.is");if(p){a.is=JSON.parse(p);return}}if(typeof globalThis.sessionStorage<"u"){let p=globalThis.sessionStorage.getItem("user.is");p&&(a.is=JSON.parse(p))}},leave:()=>{a.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(p,k,v)=>{let h=i=>{v?v(i):console.log(i)};if(u){h("User is already authenticating");return}if(p===""){h("Please provide a username");return}if(k===""){h("Please provide a password");return}u=!0,d(p,k,"",async i=>{if(i){h(i);return}let o={username:null,pub:null,epub:null,auth:null},f=Date.now(),w=await F.signTimestamp(f,a.is),l="~"+a.is.pub,c=z(l,o,w,a.is.pub,f);e.put(c,y=>{if(y){h(`error putting null on ${l}: ${y}`);return}a.is=null,v&&v(null)})})}};return a},Ue=rt;var nt=t=>{typeof t=="string"?t={peers:[t]}:t instanceof Array?t={peers:t}:B.is(t)||(t={});let e=ye(t),r=Ue(t,e),n=new Map,s=new Map,u=a=>a===null||a===!0||a===!1||typeof a=="string"||L.is(a)||fe.is(a),g=a=>{if(u(a))return!0;if(B.is(a)){let k=[];for(let[v,h]of Object.entries(a)){if(v==="_")return"error underscore cannot be used as a property name";if(B.is(h)||u(h)){k.push(v);continue}return typeof h>"u"?`error undefined ${v} cannot be converted to a graph`:`error ${JSON.stringify({[v]:h})} cannot be converted to a graph`}if(k.length!==0)return k}return`error ${JSON.stringify(a)} cannot be converted to a graph`},d=a=>{let p=(i,o,f,w)=>{e.get(B.put(i,"#",o),async l=>{if(l.err&&console.log(l.err),l.put&&l.put[o]){delete l.put[o]._,delete l.put[o][P],delete l.put[o][Y];for(let c of Object.keys(l.put[o])){let y=L.is(l.put[o][c]);if(y){let m=async(b=0)=>{let $=await new Promise(x=>{let C=R.random(),O=s.get(a);s.set(C,{chain:[{item:null,soul:y}],user:O?O.user:null}),d(C).next(null,x,w)});return $!==null||b>=5?$:(await new Promise(x=>setTimeout(x,50)),m(b+1))};l.put[o][c]=await m()}}f(l.put[o])}else f(null)},w)},k=async(i,o,f,w)=>{if(f){let l=Date.now(),c=await F.signTimestamp(l,f);return z(i,o,c,f.pub,l)}return t.secure?(w||(w=console.log),w(`error putting data on ${i}: user required in secure mode`),null):z(i,o)},v=i=>o=>{let f=s.get(i);f&&typeof f.cb<"u"?setTimeout(()=>f.cb(o),1):o&&console.log("error no callback for data",o,"ctx",f),f&&!f.on&&s.delete(i)},h=(i,o)=>{if(!i){console.log("error resolve request parameter required");return}let f=typeof i.get<"u",w=typeof i.put<"u",l=typeof i.on<"u",c=typeof i.off<"u",y=!1,m=s.get(a);for(var b=1;b<m.chain.length;b++)if(m.chain[b].soul===null){y=!0;break}if(y){let{item:$,soul:x}=m.chain[b-1];return e.get({"#":x,".":$},async C=>{if(C.err){console.log(`error getting ${$} on ${x}: ${C.err}`),o&&o(null);return}let O=C.put&&C.put[x];if(O&&typeof O[$]<"u"){let E=L.is(O[$]);if(E)m.chain[b].soul=E,s.set(a,{...m}),f?d(a).next(null,i.get,o,i._opt):w?d(a).put(i.put,o):l?d(a).on(i.on,o,i._get,i._opt):c&&d(a).off(o);else if(f)o(O[$]);else if(w){E=R.random(),O[$]=L.ify(E);let S=await k(x,O,m.user,o);if(S===null)return;e.put(S,T=>{if(T){o(`error putting ${$} on ${x}: ${T}`);return}m.chain[b].soul=E,d(a).put(i.put,o)})}else(l||c&&o)&&o(null)}else if(w){let E=R.random();O||(O={}),O[$]=L.ify(E);let S=await k(x,O,m.user,o);if(S===null)return;e.put(S,T=>{if(T){o(`error putting ${$} on ${x}: ${T}`);return}m.chain[b].soul=E,d(a).put(i.put,o)})}else o&&o(null)},{...i._opt,secure:m.user||t.secure}),!1}return f&&m.chain[m.chain.length-1].item!==null?(m.chain.push({item:null,soul:null}),d(a).next(null,i.get,o,i._opt),!1):m.chain[m.chain.length-1]};return{get:(i,o,f,w)=>{if(typeof o=="function"&&(w=f,f=o,o=null),i===null||i===""||i==="_"){console.log("error please provide a key"),f&&f(null);return}if(o&&typeof f!="function"){console.log("error lex requires a callback function");return}if(a=R.random(),s.set(a,{chain:[{item:String(i),soul:"root"}],cb:f}),!f)return d(a);let l=v(a),{soul:c}=h({get:o,_opt:w},l);c&&p(o,c,l,w)},next:(i,o,f,w)=>{let l=b=>$=>{f?f($):v(b)($)};if(typeof o=="function"&&(w=f,f=o,o=null),!a){console.log("error please provide a key using get(key)"),f&&f(null);return}let c=l(a);if(i===""||i==="_"){c(null);return}if(o&&typeof f!="function"){console.log("error lex requires a callback function");return}let y=s.get(a);if(!y)return;if(f&&typeof y.cb>"u"&&(y.cb=f,f=null),i!==null&&y.chain.push({item:String(i),soul:null}),!y.cb)return d(a);let{soul:m}=h({get:o,_opt:w},c);m&&p(o,m,c,w)},put:(i,o,f)=>{typeof o=="function"&&(f=o,o=!1);let w=x=>C=>{f?f(C):v(x)(C)};if(!a){f&&f("error please provide a key using get(key)");return}let l=s.get(a);if(!l)return;if(!l.cb){if(!f)return;l.cb=f,f=null}o&&(i={[R.random()]:i});let c=w(a),y=g(i);if(typeof y=="string"){c(y);return}let{item:m,soul:b}=h({put:i},c);if(!b)return;if(y===!0){e.get({"#":b,".":m},async x=>{if(x.err){c(`error getting ${b}: ${x.err}`);return}let C=x.put&&x.put[b],O=C&&C[m],E=L.is(O);if(!E){C||(C={}),C[m]=i;let S=await k(b,C,l.user,c);if(S===null)return;e.put(S,c);return}e.get({"#":E},async S=>{if(S.err){c(`error getting ${E}: ${S.err}`);return}if(!S.put||!S.put[E]){c(`error ${E} not found`);return}for(let _ of Object.keys(S.put[E])){if(_==="_"||_===P||_===Y)continue;let A=await new Promise(j=>{let I=R.random(),N=[{item:_,soul:E}];s.set(I,{chain:N,user:l.user}),d(I).put(null,j)});if(A){c(A);return}}C||(C={}),C[m]=i;let T=await k(b,C,l.user,c);T!==null&&e.put(T,c)})},{secure:l.user||t.secure});return}let $=(x=0)=>{e.get({"#":b,".":m},async C=>{if(C.err){c(`error getting ${b}.${m}: ${C.err}`);return}let O=C.put&&C.put[b],E=O&&O[m];if(!E&&x<5)return await new Promise(_=>setTimeout(_,50)),$(x+1);let S=L.is(E);if(!S){O||(O={}),O[m]=L.ify(R.random());let _=await k(b,O,l.user,c);if(_===null)return;e.put(_,A=>{if(A)c(`error putting ${m} on ${b}: ${A}`);else{let j=R.random(),I=[{item:m,soul:b}];s.set(j,{chain:I,user:l.user,cb:l.cb}),d(j).put(i)}});return}let T=[];for(let _ of y){let A=await new Promise(j=>{if(B.is(i[_])&&!L.is(i[_])){let I=R.random(),N=[{item:_,soul:S}];s.set(I,{chain:N,user:l.user}),d(I).put(i[_],j)}else T.push(_),j(null)});if(A){c(A,a);return}}if(T.length===0){c(null);return}e.get({"#":S},async _=>{if(_.err){c(`error getting ${S}: ${_.err}`);return}let A=_.put&&_.put[S];A||(A={}),T.forEach(I=>{A[I]=i[I]});let j=await k(S,A,l.user,c);j!==null&&e.put(j,c)})},{secure:l.user||t.secure})};$()},on:(i,o,f,w)=>{if(typeof i=="function"&&(w=f,f=o,o=i,i=null),typeof o!="function"){console.log("error on() requires a callback function");return}if(!a){console.log("error please provide a key using get(key)"),o(null);return}let{item:l,soul:c}=h({on:i,_get:f,_opt:w},o);if(!c)return;let y=s.get(a);s.set(a,{chain:[{item:l,soul:c}],on:!0,user:y?y.user:null}),n.set(o,()=>{e.get({"#":c,".":l},b=>{let $=b.put&&b.put[c]&&b.put[c][l],x=L.is($);if(x){let C=async(O=0)=>{let E=await new Promise(S=>{let T=R.random();s.set(T,{chain:[{item:null,soul:x}],user:y?y.user:null}),d(T).next(null,S,w)});E!==null||O>=5?o(E):(await new Promise(S=>setTimeout(S,50)),C(O+1))};C()}else o($!==void 0?$:null)},{...w,secure:y.user||t.secure})});let m;i?(m=B.put(i,"#",c),m["."]!=null&&typeof m["."]=="number"&&(m={...m,".":String(m["."])})):m={"#":c,".":l},e.on(m,n.get(o),!1,w),e.get({"#":c,".":l},b=>{if(b.err){console.log(`error getting ${c}.${l}: ${b.err}`);return}let $=b.put&&b.put[c]&&b.put[c][l],x=L.is($);if(x){e.off(m,n.get(o));let C;i?C=B.put(m,"#",x):C={"#":x,".":null},e.on(C,n.get(o),f,w)}else f&&n.get(o)()},{...w,secure:y.user||t.secure})},off:i=>{if(!a){console.log("error please provide a key using get(key)"),i&&i(null);return}let{item:o,soul:f}=h({off:!0},i);f&&(e.off({"#":f},n.get(i)),e.get({"#":f,".":o},w=>{if(w.err){n.delete(i),s.delete(a);return}let l=w.put&&w.put[f]&&w.put[f][o],c=L.is(l);c&&e.off({"#":c},n.get(i)),n.delete(i),s.delete(a)}))},user:()=>(r.get||(Object.assign(r,d()),r.get=(i,o,f,w)=>{typeof o=="function"&&(w=f,f=o,o=null);let l=null,c=null;if(r.is&&(l=r.is.pub),typeof i=="string"?c=i:i instanceof Array&&(i.length===2?(l=i[0],c=i[1]):i.length===1&&(c=i[0])),!l){console.log("error please log in or provide a public key"),f&&f(null);return}if(c===null||c===""||c==="_"){console.log("error please provide a key"),f&&f(null);return}if(o&&!f){console.log("error lex requires a callback function");return}a=R.random();let y=[{item:String(c),soul:"~"+l}];if(s.set(a,{chain:y,user:r.is,cb:f}),!f)return d(a);let m=v(a),{soul:b}=h({get:o,_opt:w},m);b&&p(o,b,m,w)}),r),wire:e,SEA:F}};return d()},Dt=nt;export{Dt as default};
//# sourceMappingURL=holster.js.map
