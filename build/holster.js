var Y={is:e=>!(e instanceof Array)&&(e-parseFloat(e)+1>=0||e===1/0||e===-1/0)},K={is:e=>e?e instanceof Object&&e.constructor===Object||Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/)[1]==="Object":!1,map:(e,t,o)=>{var n=Object.keys(e);for(let r=0;r<n.length;r++){let f=t(e[n[r]],n[r],o);if(typeof f<"u")return f}},put:(e,t,o)=>(e||(e={}),e[t]=o,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Ae=(e,t,o)=>{if(o.id){o.id=!1;return}if(t==="#"&&typeof e=="string"){o.id=e;return}o.id=!1},P={is:e=>{if(e&&e["#"]&&!e._&&K.is(e)){let t={};if(K.map(e,Ae,t),t.id)return t.id}return!1},ify:e=>K.put({},"#",e)},W="_holster_user_signature",J="_holster_user_public_key",I=(e,t,o,n)=>{let r={[e]:{_:{"#":e,">":{}}}};for(let[f,c]of Object.entries(t))f!=="_"&&f!=J&&f!=W&&(r[e][f]=c,r[e]._[">"][f]=Date.now());return o&&n&&(r[e][W]=o,r[e]._[">"][W]=Date.now(),r[e][J]=n,r[e]._[">"][J]=Date.now()),r},G=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!K.is(e)||!t)return!1;let o=e["*"];if(o)return t.slice(0,o.length)===o;let n=e[">"],r=e["<"];return n&&r?t>=n&&t<=r:n?t>=n:r?t<=r:!1},T={random:e=>{var t="";let o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let n=0;n<e;n++)t+=o.charAt(Math.floor(Math.random()*o.length));return t}};var Oe=e=>{e||(e=9e3);let t={store:{}};return t.check=o=>t.store[o]?t.track(o):!1,t.track=o=>(t.store[o]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{let n=Date.now();Object.keys(t.store).forEach(r=>{n-t.store[r]>e&&delete t.store[r]}),t.expiry=null},e)),o),t},pe=Oe;var xe=(e,t)=>{let o=e["#"];if(!t[o])return;let n={_:{"#":o,">":{}}};if(typeof e["."]=="string"){let r=e["."];if(typeof t[o][r]>"u")return;n[r]=t[o][r],n._[">"][r]=t[o]._[">"][r]}else for(let r of Object.keys(t[o]))G(e["."],r)&&(n[r]=t[o][r],n._[">"][r]=t[o]._[">"][r]);return{[o]:n}},se=xe;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function V(){}Object.assign(V,{from:Array.from});V.prototype=Object.create(Array.prototype);V.prototype.toString=function(e,t,o){e||(e="utf8"),t||(t=0);let n=this.length;if(e==="hex"){let r=new Uint8Array(this);return[...Array((o&&o+1||n)-t).keys()].map(f=>r[f+t].toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:(o||n)-t},(r,f)=>String.fromCharCode(this[f+t])).join("");if(e==="base64")return btoa(this)};var H=V;function z(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),z.from(...e)}z.prototype=Object.create(Array.prototype);Object.assign(z,{from(){if(!Object.keys(arguments).length||arguments[0]==null)throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.");let e=arguments[0],t;if(typeof e=="string"){let n=arguments[1]||"utf8";if(n==="hex"){let r=e.match(/([\da-fA-F]{2})/g).map(f=>parseInt(f,16));if(!r||!r.length)throw new TypeError("Invalid first argument for type 'hex'.");t=H.from(r)}else if(n==="utf8"||n==="binary"){let r=e.length,f=new Uint16Array(r);Array.from({length:r},(c,l)=>f[l]=e.charCodeAt(l)),t=H.from(f)}else if(n==="base64"){let r=atob(e),f=r.length,c=new Uint8Array(f);Array.from({length:f},(l,i)=>c[i]=r.charCodeAt(i)),t=H.from(c)}else console.info("SafeBuffer.from unknown encoding: "+n);return t}if(e.byteLength?e.byteLength:e.length){let n;return e instanceof ArrayBuffer&&(n=new Uint8Array(e)),H.from(n||e)}},alloc(e,t=0){return H.from(new Uint8Array(Array.from({length:e},()=>t)))},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be Array containing ArrayBuffer or Uint8Array instances.");return H.from(e.reduce((t,o)=>t.concat(Array.from(o)),[]))}});z.prototype.from=z.from;z.prototype.toString=H.prototype.toString;var U=z;var _e=typeof document>"u",ge=_e?(await import("node:crypto")).webcrypto:globalThis.crypto,_=ge.subtle,ee=e=>typeof e=="string"?e:JSON.stringify(e),X=e=>{try{return JSON.parse(e)}catch{return e}},te=e=>{let t=new Uint8Array(U.alloc(e));return U.from(ge.getRandomValues(t))},Z=(e,t)=>{let[o,n]=e.split(".");return{kty:"EC",crv:"P-256",x:o,y:n,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},re=async e=>{let t=await _.digest({name:"SHA-256"},new TextEncoder().encode(ee(e)));return U.from(t)},ue=async(e,t)=>{let o=e+t.toString("utf8"),n=U.from(await re(o),"binary"),r=Ee(n);return await _.importKey("jwk",r,{name:"AES-GCM"},!1,["encrypt","decrypt"])},Ee=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var Ce={pair:async e=>{let t=await _.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async r=>{let f=await _.exportKey("jwk",r.publicKey);return{priv:(await _.exportKey("jwk",r.privateKey)).d,pub:f.x+"."+f.y}}),o=await _.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async r=>{let f=await _.exportKey("jwk",r.publicKey);return{epriv:(await _.exportKey("jwk",r.privateKey)).d,epub:f.x+"."+f.y}}),n={pub:t.pub,priv:t.priv,epub:o.epub,epriv:o.epriv};return e&&e(n),n},encrypt:async(e,t,o)=>{if(!t||!t.epriv)return o&&o(null),null;let n={s:te(9),iv:te(15)},r=await ue(t.epriv,n.s).then(c=>_.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},c,new TextEncoder().encode(ee(e)))),f={ct:U.from(r,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return o&&o(f),f},decrypt:async(e,t,o)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return o&&o(null),null;let n={ct:U.from(e.ct,"base64"),iv:U.from(e.iv,"base64"),s:U.from(e.s,"base64")};try{let r=await ue(t.epriv,n.s).then(c=>_.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},c,new Uint8Array(n.ct))),f=X(new TextDecoder("utf8").decode(r));return o&&o(f),f}catch{return o&&o(null),null}},verify:async(e,t,o)=>{if(!t||!t.pub)return o&&o(null),null;let n=X(e),r=await _.importKey("jwk",Z(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),f={};if(typeof n.m=="string")f=n.m;else for(let g of Object.keys(n.m).sort())g!=="_"&&g!=J&&g!=W&&(f[g]=n.m[g]);let c=await re(f),l=new Uint8Array(U.from(n.s,"base64")),i={name:"ECDSA",hash:{name:"SHA-256"}};if(await _.verify(i,r,l,new Uint8Array(c))){let g=X(n.m);return o&&o(g),g}return o&&o(null),null},sign:async(e,t,o)=>{if(!t||!t.pub||!t.priv)return o&&o(null),null;let n={};if(typeof e=="string")n=e;else{let g=X(e);for(let y of Object.keys(g).sort())y!=="_"&&y!=J&&y!=W&&(n[y]=g[y])}let r=await re(n),f=Z(t.pub,t.priv),c={name:"ECDSA",namedCurve:"P-256"},l=await _.importKey("jwk",f,c,!1,["sign"]).then(g=>_.sign({name:"ECDSA",hash:{name:"SHA-256"}},g,new Uint8Array(r))),i={m:n,s:U.from(l,"binary").toString("base64")};return o&&o(i),i},work:async(e,t,o)=>{typeof t=="function"&&(o=t,t=void 0),typeof t>"u"&&(t=te(9));let n=await _.importKey("raw",new TextEncoder().encode(ee(e)),{name:"PBKDF2"},!1,["deriveBits"]),r={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},f=await _.deriveBits(r,n,512),c={epriv:U.from(f,"binary").toString("base64")};return o&&o(c),c},secret:async(e,t,o)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return o&&o(null),null;let n={name:"ECDH",namedCurve:"P-256"},r=Z(e.epub),f=await _.importKey("jwk",r,n,!0,[]),c=Z(t.epub,t.epriv,!1);delete c.key_ops;let l=await _.importKey("jwk",c,n,!1,["deriveBits"]).then(async i=>{let g=await _.deriveBits({public:f,name:"ECDH",namedCurve:"P-256"},i,256),y=await _.importKey("raw",new Uint8Array(g),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return _.exportKey("jwk",y).then(({k:h})=>h)});return o&&o({epriv:l}),{epriv:l}}},B=Ce;var fe=(e,t,o,n)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof o!="string"&&(o=JSON.stringify(o)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),o===n?{state:!0}:o<n?{current:!0}:{incoming:!0});fe.mix=async(e,t,o,n)=>{let r=Date.now(),f={},c={},l=0;for(let i of Object.keys(e)){let g=e[i],y=!1,h=!1,b=0,s=o;if(!g||!g._)continue;let u=g[W],p=g[J];if(u&&p&&(s=!0),i.length>1&&i[0]==="~")if(i[1]==="@")h=!0,s=!1;else{if(p&&i!="~"+p){console.log(`error public key does not match for soul: ${i}`);continue}s=!0}if(s){if(!u||!p)continue;if(!await B.verify({m:g,s:u},{pub:p})){console.log(`error could not verify soul: ${i}`);continue}}for(let a of Object.keys(g)){if(a==="_")continue;let d=g[a],m=g._&&g._[">"]?g._[">"][a]:0,S=(t[i]||{})[a],w=(t[i]||{_:{">":{}}})._[">"][a]||0;if(h&&a!==P.is(d)){console.log(`error alias ${h}: ${a} !== ${P.is(d)}`);continue}let v=m-r;if(v>0){if(v>864e5)continue;(l===0||v<l)&&(l=b=v),c[i]||(c[i]={_:{"#":i,">":{}}}),c[i][a]=d,c[i]._[">"][a]=m}else fe(m,w,d,S).incoming&&(f[i]||(f[i]={_:{"#":i,">":{}}}),t[i]||(t[i]={_:{"#":i,">":{}}}),t[i][a]=f[i][a]=d,t[i]._[">"][a]=f[i]._[">"][a]=m,n[i]&&setTimeout(()=>{n[i]&&n[i].filter(k=>G(k["."],a)).forEach(k=>k.cb())},100),y=!0)}s&&b!==0&&f[i]&&(Object.assign(c[i],f[i]),delete f[i]),y&&n[i]&&setTimeout(()=>{n[i]&&n[i].filter(a=>G(a["."])).forEach(a=>a.cb())},100)}return{now:f,defer:c,wait:l}};var le=fe;var M="",Q="",de=()=>{let e=(t,o,n)=>{if(n||(e[M]||(e[M]={}),n=e[M]),!t)return n;let r=0,f={},c=t[r],l=t.length-1,i=typeof o>"u",g=n[c];for(;!g&&r<l;)c+=t[++r],g=n[c];if(g)if(r===l){if(i)return typeof g[Q]>"u"?g[M]:g[Q];g[Q]=o}else return!g[M]&&!i&&(g[M]={}),e(t.slice(++r),o,g[M]);else if(K.map(n,(h,b)=>{let s=0,u="";for(;b[s]===t[s];)u+=b[s++];if(u){if(i)return s<=l?void 0:(f[b.slice(s)]=h,h);let p={[b.slice(s)]:h,[t.slice(s)]:{[Q]:o}};return n[u]={[M]:p},delete n[b],!0}})){if(i)return f}else{if(i)return;n[c]||(n[c]={}),n[c][Q]=o}};return e};de.map=function e(t,o,n,r){r||(r=[]);var f=t[M]||t,c=Object.keys(f).sort(),l;for(let i=0;i<c.length;i++){let g=c[i],y=f[g],h=y[Q];if(typeof h<"u"){if(h=o(h,r.join("")+g,g,r),typeof h<"u")return h}else n&&o(l,r.join(""),g,r);if(y[M]){if(r.push(g),h=e(y[M],o,n,r),typeof h<"u")return h;r.pop()}}};var D=de;var he="",ye="",N="",L=e=>{var t,o=null;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=10*1e3),e.write||(e.write=1),e.size||(e.size=1024*1024),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let n=(r,f,c)=>{if(r=""+r,typeof f=="function")return c=f,f=n.batch(r),typeof f<"u"||n.thrash.at&&(f=n.thrash.at(r),typeof f<"u")?c(t,f):n.read(r,c);if(n.batch(r,f),c&&n.batch.acks.push(c),++n.batch.ed>=e.batch)return n.thrash();clearTimeout(n.batch.timeout),n.batch.timeout=setTimeout(n.thrash,e.write)};return n.batch=D(),n.batch.acks=[],n.batch.ed=0,n.thrash=()=>{if(n.thrash.ing)return n.thrash.more=!0;clearTimeout(n.batch.timeout),n.thrash.more=!1,n.thrash.ing=!0;var r=n.thrash.at=n.batch;n.batch=null,n.batch=D(),n.batch.acks=[],n.batch.ed=0;let f=0;n.save(r,c=>{++f>1||(c&&e.log(c),r.acks.forEach(l=>l(c)),n.thrash.at=null,n.thrash.ing=!1,n.thrash.more&&n.thrash())})},n.save=(r,f)=>{let c={find:(l,i)=>{if(!(i<c.start))return c.start=i,e.store.list(c.lex),!0},lex:l=>{if(!l||l>c.start)return c.end=l,c.mix(c.file||"!",c.start,c.end),!0;c.file=l},mix:(l,i,g)=>{c.start=c.end=c.file=t,n.parse(l,(y,h)=>{if(y)return f(y);D.map(r,(b,s)=>{if(!(s<i)){if(g&&g<s)return c.start=s,c.start;h(s,b)}}),n.write(l,h,c.next)})},next:l=>{if(l)return f(l);if(c.start)return D.map(r,c.find);f(l)}};D.map(r,c.find)},n.write=(r,f,c)=>{o=null;let l={text:"",count:0,file:r,each:(i,g,y,h)=>{l.count++;var b=L.encode(h.length)+"#"+L.encode(y)+(typeof i>"u"?"":"="+L.encode(i))+`
`;if(l.count>1&&l.text.length+b.length>e.size)return l.text="",l.limit=Math.ceil(l.count/2),l.count=0,l.sub=D(),D.map(f,l.slice),!0;l.text+=b},put:()=>{e.store.put(r,l.text,c)},slice:(i,g)=>{if(!(g<l.file)){if(++l.count>l.limit){var y=l.file;let h=g.indexOf(ye);return h===-1?l.file=g:l.file=g.substring(0,h),l.sub(l.file,null),l.count=0,n.write(y,l.sub,l.next),!0}l.sub(g,i)}},next:i=>{if(i)return c(i);l.sub=D(),D.map(f,l.slice)||n.write(l.file,l.sub,c)}};D.map(f,l.each,!0)||l.put()},n.read=(r,f)=>{if(o){let g=o(r);if(typeof g<"u")return f(t,g)}let c=r,l=r.indexOf(ye);l!==-1&&(c=r.substring(0,l));let i={lex:g=>{if(!g){if(!i.file){f("no file found",t);return}n.parse(i.file,i.it);return}g>c||g<i.file||(i.file=g)},it:(g,y)=>{g&&e.log(g),y&&(o=y,i.value=y(r)),f(g,i.value)}};e.store.list(i.lex)},n.parse=(r,f)=>{let c={disk:D(),read:(l,i)=>{if(l)return f(l);if(!i)return f(t,c.disk);let g=[],y=c.split(i);for(;y;){let h,b,s=y[1];y=c.split(y[2])||"",y[0]==="#"&&(h=y[1],g=g.slice(0,s),s<=g.length&&g.push(h)),y=c.split(y[2])||"",y[0]!==`
`&&(y[0]==="="&&(b=y[1]),typeof h<"u"&&typeof b<"u"&&c.disk(g.join(""),b),y=c.split(y[2]))}f(t,c.disk)},split:l=>{if(!l)return;let i=-1,g="",y=null;for(;(y=l[++i])&&y!==N;)g+=y;let h={};if(y)return[g,L.decode(l.slice(i),h),l.slice(i+h.i)]}};e.store.get(r,c.read)},n};L.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=he+e[1],e=e[0]),typeof e=="string"){let n=0,r=null,f=N;for(;r=e[n++];)r===N&&(f+=N);return f+'"'+e+t+N}let o=P.is(e);if(o)return N+"#"+o+t+N;if(Y.is(e))return N+"+"+(e||0)+t+N;if(e===!0)return N+"+"+t+N;if(e===!1)return N+"-"+t+N;if(e===null)return N+" "+t+N};L.decode=(e,t)=>{var o="",n=-1,r=0,f=null,c=null;if(e[0]!==N)return;for(;f=e[++n];)if(c){if(f===N&&--r<=0)break;o+=f}else f===N?r++:c=f||!0;t&&(t.i=n+1);let[l,i]=o.split(he);if(i){if(i=parseFloat(i),c==='"')return[l,i];if(c==="#")return[P.ify(l),i];if(c==="+")return l.length===0?[!0,i]:[parseFloat(l),i];if(c==="-")return[!1,i];if(c===" ")return[null,i]}else{if(c==='"')return o;if(c==="#")return P.ify(o);if(c==="+")return o.length===0?!0:parseFloat(o);if(c==="-")return!1;if(c===" ")return null}};var me=L;var be=typeof document>"u",R=be?await import("node:fs"):void 0,we="",ne="",ae=ne+"+0"+ne+"#"+ne+'"root'+ne,Ke=e=>{let t=e.file;if(be)return R.existsSync(t)||R.mkdirSync(t),R.existsSync(t+"/!")||R.writeFileSync(t+"/!",ae),{get:(o,n)=>{R.readFile(t+"/"+o,(r,f)=>{if(r){if(r.code==="ENOENT"){n();return}console.log("fs.readFile error:",r)}f&&(f=f.toString()),n(r,f)})},put:(o,n,r)=>{var f=Math.random().toString(36).slice(-9),c=o+"."+f+".tmp";R.writeFile(c,n,l=>{if(l){r(l);return}R.rename(c,t+"/"+o,r)})},list:o=>{R.readdir(t,(n,r)=>{r.forEach(o),o()})}};if(e.indexedDB){let o,n=indexedDB.open(t,1);return n.onupgradeneeded=r=>{r.target.result.createObjectStore(t)},n.onerror=r=>{console.log(r)},n.onsuccess=()=>{if(o=n.result,o){let f=o.transaction([t],"readonly").objectStore(t).getKey("!");f.onerror=()=>{console.log(`error getting key ${t}/!`)},f.onsuccess=()=>{if(!f.result){let l=o.transaction([t],"readwrite").objectStore(t).put(ae,"!");l.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(r,f)=>{if(o){let l=o.transaction([t],"readonly").objectStore(t).get(r);l.onerror=()=>{console.log(`error getting ${t}/${r}`)},l.onsuccess=()=>{f(null,l.result)}}else f("error indexedDB not available")},put:(r,f,c)=>{if(o){let i=o.transaction([t],"readwrite").objectStore(t).put(f,r);i.onerror=()=>{console.log(`error putting data on ${t}/${r}`)},i.onsuccess=()=>{c(null)}}else c("error indexedDB not available")},list:r=>{if(o){let c=o.transaction([t],"readonly").objectStore(t).getAllKeys();c.onerror=()=>console.log("error getting keys for",t),c.onsuccess=()=>{c.result.forEach(r),r()}}else console.log("error indexedDB not available"),r()}}}return{get:(o,n)=>{n(null,ae)},put:(o,n,r)=>{r(null)},list:o=>{o("!"),o()}}},Pe=e=>{K.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Ke(e));let t=me(e);return{get:(o,n)=>{if(!o){n("lex required");return}var r=o["#"],f=typeof o["."]=="string"?o["."]:"",c;let l=(i,g)=>{G(o["."],g)&&(c||(c={_:{"#":r,">":{}}}),c[g]=i[0],c._[">"][g]=i[1])};t(r+we+f,(i,g)=>{let y;K.is(g)?(D.map(g,l),c||l(g,f),y={[r]:c}):g&&(l(g,f),y={[r]:c}),n(i,y)})},put:(o,n)=>{if(!o){n("graph required");return}var r=0;let f=c=>{if(r--,!f.err){if(f.err=c,f.err){n(f.err);return}r===0&&n(null)}};Object.keys(o).forEach(c=>{var l=o[c];Object.keys(l).forEach(i=>{if(i==="_")return;r++;let g=l[i],y=l._[">"][i];t(c+we+i,[g,y],f)})})}}},Se=Pe;var ve=typeof document>"u",ke=ve?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=ke?.WebSocket);var Ne=e=>{let t=pe(e.maxAge),o=Se(e),n={},r={},f={},c=async(s,u,p)=>{for(let a of Object.keys(s)){let d=await new Promise(w=>{g({"#":a},w,u)});if(d.err)return p&&p(d.err),!1;let m=s[a],S=J;if(!(!d.put||!d.put[a]||d.put[a][S]===m[S]))return p&&p(`error in wire check public key does not match for soul: ${a}`),!1}return!0},l=(s,u)=>{let p=se(s.get,n);p?u(JSON.stringify({"#":t.track(T.random(9)),"@":s["#"],put:p})):o.get(s.get,(a,d)=>{u(JSON.stringify({"#":t.track(T.random(9)),"@":s["#"],put:d,err:a}))})},i=async(s,u)=>{let p=await le.mix(s.put,n,e.secure,f);if(Object.keys(p.now).length){if(!await c(p.now,u))return;o.put(p.now,a=>{u(JSON.stringify({"#":t.track(T.random(9)),"@":s["#"],err:a}))})}Object.keys(p.defer).length&&setTimeout(()=>i({put:p.defer},u),p.wait)},g=(s,u,p,a)=>{if(!u)return;K.is(a)||(a={});let d=se(s,n),m=T.random(9),S=JSON.stringify({"#":t.track(m),get:e.secure?{"#":s["#"]}:s});if(d){p(S),u({put:d});return}o.get(s,(w,v)=>{if(v){p(S),u({put:v,err:w});return}w&&console.log(w),r[m]=u,p(S),setTimeout(()=>{let $=r[m];if($){let k=s["#"],O={[k]:null};typeof s["."]=="string"&&(O[k]={[s["."]]:null}),$({put:O}),delete r[m]}},a.wait||100)})},y=s=>({get:(u,p,a)=>{g(u,p,s,a)},put:async(u,p)=>{let a=await le.mix(u,n,e.secure,f);Object.keys(a.now).length===0||!await c(a.now,s,p)||(o.put(a.now,p),s(JSON.stringify({"#":t.track(T.random(9)),put:u})))},on:(u,p,a,d)=>{let m=u&&u["#"];!m||!p||(f[m]?f[m].push({".":u["."],cb:p}):f[m]=[{".":u["."],cb:p}],a&&g(u,p,s,d))},off:(u,p)=>{let a=u&&u["#"];if(!(!a||!f[a]))if(p){let d=f[a].find(m=>m.cb===p);d&&f[a].splice(f[a].indexOf(d),1)}else delete f[a]}});if(ve){let s=e.wss,u=()=>s.clients();if(!s){let a=e.server?{server:e.server}:{port:e.port||8765};s=new ke.WebSocketServer(a),u=()=>s.clients}let p=(a,d)=>{u().forEach(m=>{m.readyState===WebSocket.OPEN&&m.send(a,{binary:d})})};return s.on("connection",a=>{a.on("error",console.error),a.on("message",(d,m)=>{let S=JSON.parse(d);if(t.check(S["#"]))return;t.track(S["#"]),S.get&&l(S,p),S.put&&i(S,p),p(d,m);let w=S["@"],v=r[w];v&&(delete S["#"],delete S["@"],v(S),delete r[w])})}),y(p)}let h=[],b=s=>{h.forEach(u=>{u&&u.readyState===WebSocket.OPEN?u.send(s):console.log("websocket not available")})};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(s=>{let u=new WebSocket(s);h.push(u);let p=()=>{u||(u=new WebSocket(s)),u.onclose=a=>{h.indexOf(u)!==-1&&h.splice(h.indexOf(u),1),u=null,setTimeout(p,Math.floor(Math.random()*5e3))},u.onerror=a=>{console.error(a)},u.onmessage=a=>{let d=JSON.parse(a.data);if(t.check(d["#"]))return;t.track(d["#"]),d.get&&l(d,b),d.put&&i(d,b),b(a.data);let m=d["@"],S=r[m];S&&(delete d["#"],delete d["@"],S(d),delete r[m])}};p()}),y(b)},ie=Ne;var Be=(e,t)=>{t||(t=ie(e));let o=[],n=!1,r=!1,f=0,c=(i,g,y,h)=>{let b=a=>{f++,c(a,g,y,h)},s=a=>{o=[],f=0,r=!1,h(a)},u=()=>{if(o.length===0){s("Wrong username or password");return}let a=o.shift();t.get({"#":a},async d=>{if(d.err){s(`error getting ${a}: ${d.err}`);return}let m=d.put&&d.put[a];if(!m||!m.auth)return u();let S=JSON.parse(m.auth),w=await B.work(g,S.salt),v=await B.decrypt(S.enc,w);if(!v)return u();if(l.is={username:i,pub:m.pub,epub:m.epub,priv:v.priv,epriv:v.epriv},y!==""){let $=T.random(64),k=await B.work(y,$),O=await B.encrypt(v,k),E={username:i,pub:m.pub,epub:m.epub,auth:JSON.stringify({enc:O,salt:$})},A=await B.sign(E,l.is),j=I(a,A.m,A.s,m.pub);t.put(j,x=>{s(x?`error putting ${E} on ${a}: ${x}`:null)});return}return s(null)})};if(f>9){s("Wrong username or password");return}let p="~@"+i;t.get({"#":p},async a=>{if(a.err){s(`error getting ${p}: ${a.err}`);return}let d=a.put&&a.put[p];if(!d)return b(i);delete a.put[p]._,o=Object.keys(d),u()})},l={create:(i,g,y)=>{let h=s=>{y?y(s):console.log(s)};if(n){h("User is already being created");return}if(i===""){h("Please provide a username");return}if(g===""){h("Please provide a password");return}n=!0;let b="~@"+i;t.get({"#":b},async s=>{if(s.err){n=!1,h(`error getting ${b}: ${s.err}`);return}if(s.put&&s.put[b]){n=!1,h("Username already exists");return}let u=T.random(64),p=await B.work(g,u),a=await B.pair(),d={priv:a.priv,epriv:a.epriv},m=await B.encrypt(d,p),S={username:i,pub:a.pub,epub:a.epub,auth:JSON.stringify({enc:m,salt:u})},w="~"+a.pub,v=await B.sign(S,a),$=I(w,v.m,v.s,a.pub);t.put($,k=>{if(n=!1,k){h(`error putting ${S} on ${w}: ${k}`);return}let O={[w]:{"#":w}};t.put(I(b,O),E=>{if(E){h(`error putting ${O} on ${b}: ${E}`);return}y&&y(null)})})})},auth:(i,g,y)=>{let h=b=>{y?y(b):b&&console.log(b)};if(r){h("User is already authenticating");return}if(l.is=null,i===""){h("Please provide a username");return}if(g===""){h("Please provide a password");return}r=!0,c(i,g,"",h)},change:(i,g,y,h)=>{let b=s=>{h?h(s):s&&console.log(s)};if(r){b("User is already authenticating");return}if(l.is=null,i===""){b("Please provide a username");return}if(g===""){b("Please provide a password");return}if(y===""){b("Please provide a new password");return}r=!0,c(i,g,y,b)},store:i=>{if(!l.is){console.log("Please authenticate before calling store");return}if(i){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(l.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(l.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let i=globalThis.localStorage.getItem("user.is");if(i){l.is=JSON.parse(i);return}}if(typeof globalThis.sessionStorage<"u"){let i=globalThis.sessionStorage.getItem("user.is");i&&(l.is=JSON.parse(i))}},leave:()=>{l.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(i,g,y)=>{let h=b=>{y?y(b):console.log(b)};if(r){h("User is already authenticating");return}if(i===""){h("Please provide a username");return}if(g===""){h("Please provide a password");return}r=!0,c(i,g,"",async b=>{if(b){h(b);return}let s={username:null,pub:null,epub:null,auth:null},u=await B.sign(s,l.is),p="~"+l.is.pub,a=I(p,u.m,u.s,l.is.pub);t.put(a,d=>{if(d){h(`error putting null on ${p}: ${d}`);return}l.is=null,y&&y(null)})})}};return l},je=Be;var De=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:K.is(e)||(e={});let t=ie(e),o=je(null,t),n=new Map,r=new Map,f=i=>i===null||i===!0||i===!1||typeof i=="string"||P.is(i)||Y.is(i),c=i=>{if(f(i))return!0;if(K.is(i)){let y=[];for(let[h,b]of Object.entries(i)){if(h==="_")return"error underscore cannot be used as a property name";if(K.is(b)||f(b)){y.push(h);continue}return typeof b>"u"?`error undefined ${h} cannot be converted to a graph`:`error ${JSON.stringify({[h]:b})} cannot be converted to a graph`}if(y.length!==0)return y}return`error ${JSON.stringify(i)} cannot be converted to a graph`},l=i=>{let g=(s,u,p,a)=>{t.get(K.put(s,"#",u),async d=>{if(d.err&&console.log(d.err),d.put&&d.put[u]){delete d.put[u]._,delete d.put[u][J],delete d.put[u][W];for(let m of Object.keys(d.put[u])){let S=P.is(d.put[u][m]);if(S){let w=await new Promise(v=>{let $=T.random();r.set($,{chain:[{item:null,soul:S}]}),l($).next(null,v)});d.put[u][m]=w}}p(d.put[u])}else p(null)},a)},y=async(s,u,p,a)=>{if(p){let d=await B.sign(u,p);return I(s,d.m,d.s,p.pub)}return e.secure?(a||(a=console.log),a(`error putting data on ${s}: user required in secure mode`),null):I(s,u)},h=s=>{let u=r.get(i);u&&typeof u.cb<"u"?setTimeout(()=>u.cb(s),1):s&&console.log("error no callback for data",s,"ctx",u),u&&!u.on&&r.delete(i)},b=(s,u)=>{if(!s){console.log("error resolve request parameter required");return}let p=typeof s.get<"u",a=typeof s.put<"u",d=typeof s.on<"u",m=typeof s.off<"u",S=!1,w=r.get(i);for(var v=1;v<w.chain.length;v++)if(w.chain[v].soul===null){S=!0;break}if(S){let{item:$,soul:k}=w.chain[v-1],O=w.user||e.secure?{"#":k}:{"#":k,".":$};return t.get(O,async E=>{if(E.err){w.user||e.secure?console.log(`error getting ${k}: ${E.err}`):console.log(`error getting ${$} on ${k}: ${E.err}`),u&&u(null);return}let A=E.put&&E.put[k];if(A&&typeof A[$]<"u"){let j=P.is(A[$]);if(j)w.chain[v].soul=j,r.set(i,{...w}),p?l(i).next(null,s.get,u,s._opt):a?l(i).put(s.put,u):d?l(i).on(s.on,u,s._get,s._opt):m&&l(i).off(u);else if(p)u(A[$]);else if(a){j=T.random(),A[$]=P.ify(j);let x=await y(k,A,w.user,u);if(x===null)return;t.put(x,C=>{if(C){u(`error putting ${$} on ${k}: ${C}`);return}w.chain[v].soul=j,l(i).put(s.put,u)})}else(d||m&&u)&&u(null)}else if(a){let j=T.random();A||(A={}),A[$]=P.ify(j);let x=await y(k,A,w.user,u);if(x===null)return;t.put(x,C=>{if(C){u(`error putting ${$} on ${k}: ${C}`);return}w.chain[v].soul=j,l(i).put(s.put,u)})}else u&&u(null)}),!1}return p&&w.chain[w.chain.length-1].item!==null?(w.chain.push({item:null,soul:null}),l(i).next(null,s.get,u),!1):w.chain[w.chain.length-1]};return{get:(s,u,p,a)=>{if(typeof u=="function"&&(a=p,p=u,u=null),s===null||s===""||s==="_"){console.log("error please provide a key"),p&&p(null);return}if(u&&typeof p!="function"){console.log("error lex requires a callback function");return}if(i=T.random(),r.set(i,{chain:[{item:s,soul:"root"}],cb:p}),!p)return l(i);let{soul:d}=b({get:u,_opt:a},h);d&&g(u,d,h,a)},next:(s,u,p,a)=>{let d=w=>{p?p(w):h(w)};if(typeof u=="function"&&(a=p,p=u,u=null),!i){console.log("error please provide a key using get(key)"),d(null);return}if(s===""||s==="_"){d(null);return}if(u&&typeof p!="function"){console.log("error lex requires a callback function");return}let m=r.get(i);if(!m)return;if(p&&typeof m.cb>"u"&&(m.cb=p,p=null),s!==null&&m.chain.push({item:s,soul:null}),!m.cb)return l(i);let{soul:S}=b({get:u,_opt:a},d);S&&g(u,S,d,a)},put:(s,u,p)=>{typeof u=="function"&&(p=u,u=!1);let a=$=>{p?p($):h($)};if(!i){a("please provide a key using get(key)");return}let d=r.get(i);if(!d)return;if(!d.cb){if(!p)return;d.cb=p,p=null}u&&(s={[T.random()]:s});let m=c(s);if(typeof m=="string"){a(m);return}let{item:S,soul:w}=b({put:s},a);if(!w)return;if(m===!0){let $=d.user||e.secure?{"#":w}:{"#":w,".":S};t.get($,async k=>{if(k.err){a(`error getting ${w}: ${k.err}`);return}let O=k.put&&k.put[w],E=O&&O[S],A=P.is(E);if(!A){O||(O={}),O[S]=s;let j=await y(w,O,d.user,a);if(j===null)return;t.put(j,a);return}t.get({"#":A},async j=>{if(j.err){a(`error getting ${A}: ${j.err}`);return}if(!j.put||!j.put[A]){a(`error ${A} not found`);return}for(let C of Object.keys(j.put[A])){if(C==="_"||C===J||C===W)continue;let F=await new Promise(oe=>{let ce=T.random(),$e=[{item:C,soul:A}];r.set(ce,{chain:$e,user:d.user}),l(ce).put(null,oe)});if(F){a(F);return}}O||(O={}),O[S]=s;let x=await y(w,O,d.user,a);x!==null&&t.put(x,a)})});return}let v=d.user||e.secure?{"#":w}:{"#":w,".":S};t.get(v,async $=>{if($.err){a(`error getting ${w}.${S}: ${$.err}`);return}let k=$.put&&$.put[w],O=k&&k[S],E=P.is(O);if(!E){k||(k={}),k[S]=P.ify(T.random());let j=await y(w,k,d.user,a);if(j===null)return;t.put(j,x=>{if(x)a(`error putting ${S} on ${w}: ${x}`);else{let C=T.random(),F=[{item:S,soul:w}];r.set(C,{chain:F,user:d.user,cb:d.cb}),l(C).put(s)}});return}let A=[];for(let j of m){let x=await new Promise(C=>{if(K.is(s[j])&&!P.is(s[j])){let F=T.random(),oe=[{item:j,soul:E}];r.set(F,{chain:oe,user:d.user}),l(F).put(s[j],C)}else A.push(j),C(null)});if(x){a(x);return}}if(A.length===0){a(null);return}t.get({"#":E},async j=>{if(j.err){a(`error getting ${E}: ${j.err}`);return}let x=j.put&&j.put[E];x||(x={}),A.forEach(F=>{x[F]=s[F]});let C=await y(E,x,d.user,a);C!==null&&t.put(C,a)})})},on:(s,u,p,a)=>{if(typeof s=="function"&&(a=p,p=u,u=s,s=null),typeof u!="function"){console.log("error on() requires a callback function");return}if(!i){console.log("error please provide a key using get(key)"),u(null);return}let{item:d,soul:m}=b({on:s,_get:p,_opt:a},u);m&&(r.set(i,{chain:[{item:d,soul:m}],on:!0}),n.set(u,()=>l(i).next(null,u)),t.get({"#":m,".":d},S=>{if(S.err){console.log(`error getting ${m}.${d}: ${S.err}`);return}let w=S.put&&S.put[m]&&S.put[m][d],v=P.is(w);v?s?s=K.put(s,"#",v):s={"#":v,".":null}:s?s=K.put(s,"#",m):s={"#":m,".":d},t.on(s,n.get(u),p,a)}))},off:s=>{if(!i){console.log("error please provide a key using get(key)"),s&&s(null);return}let{item:u,soul:p}=b({off:!0},s);p&&t.get({"#":p,".":u},a=>{if(a.err){console.log(`error getting ${p}.${u}: ${a.err}`);return}let d=a.put&&a.put[p]&&a.put[p][u],m=P.is(d);m?t.off({"#":m},n.get(s)):t.off({"#":p},n.get(s)),n.delete(s),r.delete(i)})},user:()=>(o.get||(Object.assign(o,l()),o.get=(s,u,p,a)=>{typeof u=="function"&&(a=p,p=u,u=null);let d=null,m=null;if(o.is&&(d=o.is.pub),typeof s=="string"?m=s:s instanceof Array&&(s.length===2?(d=s[0],m=s[1]):s.length===1&&(m=s[0])),!d){console.log("error please log in or provide a public key"),p&&p(null);return}if(m===null||m===""||m==="_"){console.log("error please provide a key"),p&&p(null);return}if(u&&!p){console.log("error lex requires a callback function");return}i=T.random();let S=[{item:m,soul:"~"+d}];if(r.set(i,{chain:S,user:o.is,cb:p}),!p)return l(i);let{soul:w}=b({get:u},h);w&&g(u,w,h,a)}),o),wire:t,SEA:B}};return l()},pt=De;export{pt as default};
//# sourceMappingURL=holster.js.map
