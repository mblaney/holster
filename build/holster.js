var ie={is:e=>{if(e instanceof Array)return!1;if(typeof e=="number")return!isNaN(e);if(typeof e=="string"){let t=parseFloat(e);return!isNaN(t)&&isFinite(t)}return!1}},R={is:e=>{if(!e||typeof e!="object")return!1;let r=Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/);return e.constructor===Object||r&&r[1]==="Object"},map:(e,t,r)=>{var o=Object.keys(e);for(let n=0;n<o.length;n++){let u=t(e[o[n]],o[n],r);if(typeof u<"u")return u}},put:(e,t,r)=>(e||(e={}),e[t]=r,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Be=(e,t,r)=>{if(r.id){r.id=!1;return}if(t==="#"&&typeof e=="string"){r.id=e;return}r.id=!1},D={is:e=>{if(e&&e["#"]&&!e._&&R.is(e)){let t={};if(R.map(e,Be,t),t.id)return t.id}return!1},ify:e=>R.put({},"#",e)},J="_holster_user_signature",F="_holster_user_public_key",G=(e,t,r,o)=>{let n=Date.now(),u={[e]:{_:{"#":e,">":{}}}};for(let[c,l]of Object.entries(t))c!=="_"&&c!==F&&c!==J&&(u[e][c]=l,u[e]._[">"][c]=n);return r&&o&&(u[e][J]=r,u[e]._[">"][J]=n,u[e][F]=o,u[e]._[">"][F]=n),u},Q=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!R.is(e)||!t)return!1;let r=e["*"];if(r)return t.slice(0,r.length)===r;let o=e[">"],n=e["<"];return o&&n?t>=o&&t<=n:o?t>=o:n?t<=n:!1},I={random:e=>{var t="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let o=0;o<e;o++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}};var Ue=e=>{e||(e=9e3);let t={store:{}};return t.check=r=>t.store[r]?t.track(r):!1,t.track=r=>(t.store[r]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{if(t.expiry)return;let o=Date.now();Object.keys(t.store).forEach(n=>{o-t.store[n]>e&&delete t.store[n]}),t.expiry=null},e)),r),t},ve=Ue;var Pe=(e,t)=>{if(!e||typeof e!="object")throw new TypeError("lex must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");let r=e["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!t[r])return;let o={_:{"#":r,">":{}}};if(typeof e["."]=="string"){let n=e["."];if(typeof t[r][n]>"u")return;o[n]=t[r][n],o._[">"][n]=t[r]._[">"][n]}else for(let n of Object.keys(t[r]))Q(e["."],n)&&(o[n]=t[r][n],o._[">"][n]=t[r]._[">"][n]);return{[r]:o}},de=Pe;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function se(){}Object.assign(se,{from:Array.from});se.prototype=Object.create(Array.prototype);se.prototype.toString=function(e,t,r){if(e||(e="utf8"),t||(t=0),r=r?Math.min(Math.max(r,t),this.length):this.length,e==="hex"){let o=new Uint8Array(this.slice(t,r));return Array.from(o,n=>n.toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:r-t},(o,n)=>{let u=this[n+t];return u<0||u>1114111?"\uFFFD":String.fromCharCode(u)}).join("");if(e==="base64"){let o=Array.from({length:r-t},(n,u)=>{let c=this[u+t];return c<0||c>255?"\uFFFD":String.fromCharCode(c)}).join("");return btoa(o)}};var z=se;var ue={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function X(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),X.from(...e)}X.prototype=Object.create(Array.prototype);var te=(e,t)=>{if(typeof e!="string")throw new TypeError("Input must be a string for encoding: "+t);if(e.length>ue.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${e.length} > ${ue.MAX_STRING_LENGTH}`)},W=(e,t="buffer operation")=>{if(e>ue.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${t}: ${e} > ${ue.MAX_BUFFER_SIZE}`)},Fe=e=>{te(e,"hex");let t=e.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(t))throw new TypeError("Invalid hex string: contains non-hex characters");if(t.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(t.length===0)return new Uint8Array(0);W(t.length/2,"hex parsing");let r=new Uint8Array(t.length/2);for(let o=0;o<t.length;o+=2){let n=t.substr(o,2);r[o/2]=parseInt(n,16)}return r},Te=e=>{te(e,"utf8");try{let r=new TextEncoder().encode(e);return W(r.length,"UTF-8 encoding"),r}catch(t){throw new TypeError("Failed to encode UTF-8 string: "+t.message)}},Le=e=>{te(e,"binary"),W(e.length,"binary encoding");let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let o=e.charCodeAt(r);if(o>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${o} > 255)`);t[r]=o}return t},He=e=>{te(e,"base64");let t=e.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(t))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(t);W(r.length,"base64 decoding");let o=new Uint8Array(r.length);for(let n=0;n<r.length;n++)o[n]=r.charCodeAt(n);return o}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},ke=e=>{let t;if(e instanceof ArrayBuffer)W(e.byteLength,"ArrayBuffer processing"),t=new Uint8Array(e);else if(ArrayBuffer.isView(e))W(e.byteLength||e.length,"TypedArray processing"),t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);else if(Array.isArray(e)){W(e.length,"Array processing");for(let r=0;r<e.length;r++){let o=e[r];if(typeof o!="number"||o<0||o>255||!Number.isInteger(o))throw new TypeError(`Invalid byte value at index ${r}: ${o} (must be integer 0-255)`)}t=new Uint8Array(e)}else if(typeof e=="object"&&e!==null&&typeof e.length=="number"){W(e.length,"array-like processing");let r=Array.from(e);for(let o=0;o<r.length;o++){let n=r[o];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${o}: ${n} (must be integer 0-255)`)}t=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof e);return t};Object.assign(X,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let t=arguments[0];if(t==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof t=="string"){let o=(arguments[1]||"utf8").toLowerCase();switch(o){case"hex":r=Fe(t);break;case"utf8":case"utf-8":r=Te(t);break;case"binary":case"latin1":r=Le(t);break;case"base64":r=He(t);break;case"ascii":te(t,"ascii");for(let n=0;n<t.length;n++)if(t.charCodeAt(n)>127)throw new TypeError(`Invalid ASCII character at position ${n}: ${t.charCodeAt(n)} > 127`);r=Te(t);break;default:throw new TypeError("Unknown encoding: "+o)}}else r=ke(t);if(!r||r.length===0)return z.from(new Uint8Array(0));try{return z.from(r)}catch(o){throw new Error("Failed to create SafeBuffer: "+o.message)}},alloc(e,t=0){if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Length must be a non-negative integer");if(W(e,"buffer allocation"),typeof t=="number"){if(t<0||t>255||!Number.isInteger(t))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof t=="string"){if(t.length!==1)throw new TypeError("Fill string must be exactly one character");if(t=t.charCodeAt(0),t>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(e);return t!==0&&r.fill(t),z.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be an array");if(e.length===0)return z.from(new Uint8Array(0));let t=0,r=[];for(let o=0;o<e.length;o++){let n=e[o];if(!n)throw new TypeError(`Array element at index ${o} is null or undefined`);let u;try{u=ke(n)}catch(c){throw new TypeError(`Invalid array element at index ${o}: ${c.message}`)}t+=u.length,W(t,"buffer concatenation"),r.push(u)}try{let o=new Uint8Array(t),n=0;for(let u of r)o.set(u,n),n+=u.length;return z.from(o)}catch(o){throw new Error("Failed to concatenate buffers: "+o.message)}},isBuffer(e){return e instanceof z||e&&typeof e=="object"&&e.constructor===X},byteLength(e,t="utf8"){if(typeof e!="string")throw new TypeError("First argument must be a string");switch(t.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(e).length;case"ascii":case"binary":case"latin1":return e.length;case"base64":let r=e.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(e.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+t)}}});X.prototype.from=X.from;X.prototype.toString=function(e="utf8",t=0,r=this.length){if(typeof e!="string")throw new TypeError("Encoding must be a string");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<t)throw new TypeError("End must be an integer >= start");try{return z.prototype.toString.call(this,e,t,r)}catch(o){throw new Error("Failed to convert buffer to string: "+o.message)}};var L=X;var Ke=typeof document>"u",Ee=Ke?(await import("node:crypto")).webcrypto:globalThis.crypto,M=Ee.subtle,le=e=>typeof e=="string"?e:JSON.stringify(e),re=e=>{try{return JSON.parse(e)}catch{return e}},ae=e=>{let t=new Uint8Array(L.alloc(e));return L.from(Ee.getRandomValues(t))},ne=(e,t)=>{let[r,o]=e.split(".");return{kty:"EC",crv:"P-256",x:r,y:o,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},fe=async e=>{let t=await M.digest({name:"SHA-256"},new TextEncoder().encode(le(e)));return L.from(t)},he=async(e,t)=>{let r=e+t.toString("utf8"),o=L.from(await fe(r),"binary"),n=Je(o);return await M.importKey("jwk",n,{name:"AES-GCM"},!1,["encrypt","decrypt"])},Je=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var We={pair:async e=>{let t=await M.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async n=>{let u=await M.exportKey("jwk",n.publicKey);return{priv:(await M.exportKey("jwk",n.privateKey)).d,pub:u.x+"."+u.y}}),r=await M.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async n=>{let u=await M.exportKey("jwk",n.publicKey);return{epriv:(await M.exportKey("jwk",n.privateKey)).d,epub:u.x+"."+u.y}}),o={pub:t.pub,priv:t.priv,epub:r.epub,epriv:r.epriv};return e&&e(o),o},encrypt:async(e,t,r)=>{if(!t||!t.epriv)return r&&r(null),null;let o={s:ae(9),iv:ae(15)},n=await he(t.epriv,o.s).then(c=>M.encrypt({name:"AES-GCM",iv:new Uint8Array(o.iv)},c,new TextEncoder().encode(le(e)))),u={ct:L.from(n,"binary").toString("base64"),iv:o.iv.toString("base64"),s:o.s.toString("base64")};return r&&r(u),u},decrypt:async(e,t,r)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return r&&r(null),null;let o={ct:L.from(e.ct,"base64"),iv:L.from(e.iv,"base64"),s:L.from(e.s,"base64")};try{let n=await he(t.epriv,o.s).then(c=>M.decrypt({name:"AES-GCM",iv:new Uint8Array(o.iv),tagLength:128},c,new Uint8Array(o.ct))),u=re(new TextDecoder("utf8").decode(n));return r&&r(u),u}catch{return r&&r(null),null}},verify:async(e,t,r)=>{if(!t||!t.pub)return r&&r(null),null;let o=re(e),n=await M.importKey("jwk",ne(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),u={};if(typeof o.m=="string")u=o.m;else for(let s of Object.keys(o.m).sort())s!=="_"&&s!=F&&s!=J&&(u[s]=o.m[s]);let c=await fe(u),l=new Uint8Array(L.from(o.s,"base64")),i={name:"ECDSA",hash:{name:"SHA-256"}};if(await M.verify(i,n,l,new Uint8Array(c))){let s=re(o.m);return r&&r(s),s}return r&&r(null),null},sign:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let o={};if(typeof e=="string")o=e;else{let s=re(e);for(let f of Object.keys(s).sort())f!=="_"&&f!=F&&f!=J&&(o[f]=s[f])}let n=await fe(o),u=ne(t.pub,t.priv),c={name:"ECDSA",namedCurve:"P-256"},l=await M.importKey("jwk",u,c,!1,["sign"]).then(s=>M.sign({name:"ECDSA",hash:{name:"SHA-256"}},s,new Uint8Array(n))),i={m:o,s:L.from(l,"binary").toString("base64")};return r&&r(i),i},work:async(e,t,r)=>{typeof t=="function"&&(r=t,t=void 0),typeof t>"u"&&(t=ae(9));let o=await M.importKey("raw",new TextEncoder().encode(le(e)),{name:"PBKDF2"},!1,["deriveBits"]),n={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},u=await M.deriveBits(n,o,512),c={epriv:L.from(u,"binary").toString("base64")};return r&&r(c),c},secret:async(e,t,r)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return r&&r(null),null;let o={name:"ECDH",namedCurve:"P-256"},n=ne(e.epub),u=await M.importKey("jwk",n,o,!0,[]),c=ne(t.epub,t.epriv,!1);delete c.key_ops;let l=await M.importKey("jwk",c,o,!1,["deriveBits"]).then(async i=>{let s=await M.deriveBits({public:u,name:"ECDH",namedCurve:"P-256"},i,256),f=await M.importKey("raw",new Uint8Array(s),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return M.exportKey("jwk",f).then(({k:p})=>p)});return r&&r({epriv:l}),{epriv:l}}},P=We;var $e=100,je=1e4,ye=(e,t,r,o)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof o!="string"&&(o=JSON.stringify(o)||""),r===o?{state:!0}:r<o?{current:!0}:{incoming:!0});ye.mix=async(e,t,r,o)=>{if(!e||typeof e!="object")throw new TypeError("change must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");if(!o||typeof o!="object")throw new TypeError("listen must be an object");let n=Date.now(),u={},c={},l=0;for(let s of Object.keys(e)){let f=e[s],p=!1,v=!1,a=0,g=r;if(!f||!f._)continue;let d=f[J],T=f[F];if(d&&T&&(g=!0),s.length>1&&s[0]==="~")if(s[1]==="@")v=!0,g=!1;else{if(T&&s!="~"+T){console.log(`error public key does not match for soul: ${s}`);continue}g=!0}if(!(g&&(!d||!T||!await P.verify({m:f,s:d},{pub:T})))){for(let h of Object.keys(f)){if(h==="_")continue;let S=f[h],x=f._&&f._[">"]?f._[">"][h]:0,$=(t[s]||{})[h],j=(t[s]||{_:{">":{}}})._[">"][h]||0;if(v&&h!==D.is(S)){console.log(`error alias ${v}: ${h} !== ${D.is(S)}`);continue}let O=x-n;if(O>0){if(O>864e5)continue;(l===0||O<l)&&(l=a=O),c[s]||(c[s]={_:{"#":s,">":{}}}),c[s][h]=S,c[s]._[">"][h]=x}else ye(x,j,S,$).incoming&&(u[s]||(u[s]={_:{"#":s,">":{}}}),t[s]||(t[s]={_:{"#":s,">":{}}}),t[s][h]=u[s][h]=S,t[s]._[">"][h]=u[s]._[">"][h]=x,o[s]&&setTimeout(()=>{o[s]&&o[s].filter(b=>Q(b["."],h)).forEach(b=>b.cb())},$e),p=!0)}g&&a!==0&&u[s]&&(Object.assign(c[s],u[s]),delete u[s]),p&&o[s]&&setTimeout(()=>{o[s]&&o[s].filter(h=>Q(h["."])).forEach(h=>h.cb())},$e)}}let i=Object.keys(t);return i.length>je&&i.map(p=>{let v=t[p]._&&t[p]._[">"],a=v?Math.max(...Object.values(v)):0;return{soul:p,maxState:a}}).sort((p,v)=>p.maxState-v.maxState).slice(0,i.length-je).forEach(({soul:p})=>delete t[p]),{now:u,defer:c,wait:l}};var me=ye;var q="",ee="",xe=()=>{let e=(t,r,o)=>{if(o||(e[q]||(e[q]={}),o=e[q]),!t)return o;let n=0,u={},c=t[n],l=t.length-1,i=typeof r>"u",s=o[c];for(;!s&&n<l;)c+=t[++n],s=o[c];if(s)if(n===l){if(i)return typeof s[ee]>"u"?s[q]:s[ee];s[ee]=r}else return!s[q]&&!i&&(s[q]={}),e(t.slice(++n),r,s[q]);else if(R.map(o,(p,v)=>{let a=0,g="";for(;v[a]===t[a];)g+=v[a++];if(g){if(i)return a<=l?void 0:(u[v.slice(a)]=p,p);let d={[v.slice(a)]:p,[t.slice(a)]:{[ee]:r}};return o[g]={[q]:d},delete o[v],!0}})){if(i)return u}else{if(i)return;o[c]||(o[c]={}),o[c][ee]=r}};return e};xe.map=function e(t,r,o,n){n||(n=[]);var u=t[q]||t,c=Object.keys(u).sort(),l;for(let i=0;i<c.length;i++){let s=c[i],f=u[s],p=f[ee];if(typeof p<"u"){if(p=r(p,n.join("")+s,s,n),typeof p<"u")return p}else o&&r(l,n.join(""),s,n);if(f[q]){if(n.push(s),p=e(f[q],r,o,n),typeof p<"u")return p;n.pop()}}};var H=xe;var Oe="",Ae="",B="",V=e=>{var t;let r=new Map;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=100),e.write||(e.write=1),e.size||(e.size=1024*1024),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let o=(u,c,l,i)=>{let s=Date.now()-c;s>500&&console.log(`[RADISK-SLOW] ${u}: ${s}ms for ${l}${i?` (${i} bytes)`:""}`)},n=(u,c,l)=>{if(u=""+u,typeof c=="function"){if(l=c,c=n.batch(u),typeof c<"u"||n.thrash.at&&(c=n.thrash.at(u),typeof c<"u"))return l(t,c);let i=Date.now();return n.read(u,(s,f)=>{o("read",i,u),l(s,f)})}if(n.batch(u,c),l&&n.batch.acks.push(l),++n.batch.ed>=e.batch)return n.thrash();clearTimeout(n.batch.timeout),n.batch.timeout=setTimeout(n.thrash,e.write)};return n.batch=H(),n.batch.acks=[],n.batch.ed=0,n.thrash=()=>{if(n.thrash.ing)return n.thrash.more=!0;let u=Date.now();clearTimeout(n.batch.timeout),n.thrash.more=!1,n.thrash.ing=!0;var c=n.thrash.at=n.batch;n.batch=null,n.batch=H(),n.batch.acks=[],n.batch.ed=0;let l=0;n.save(c,i=>{++l>1||(o("thrash",u,`batch-${n.batch.ed}`),i&&e.log(i),c.acks.forEach(s=>s(i)),n.thrash.at=null,n.thrash.ing=!1,n.thrash.more&&n.thrash())})},n.save=(u,c)=>{let l={find:(i,s)=>{if(!(s<l.start))return l.start=s,e.store.list(l.lex),!0},lex:i=>{!i||i>l.start?(l.end=i,l.start&&l.mix(l.file||"!",l.start,l.end)):l.file=i},mix:(i,s,f)=>{if(l.start=l.end=l.file=t,r.has(i)){let p=r.get(i);H.map(u,(v,a)=>{if(!(a<s)){if(f&&f<a){l.start=a;return}p(a,v)}}),n.write(i,p,l.next)}else n.parse(i,(p,v)=>{if(p)return c(p);H.map(u,(a,g)=>{if(!(g<s)){if(f&&f<g){l.start=g;return}v(g,a)}}),n.write(i,v,l.next)})},next:i=>{if(i)return c(i);if(l.start)return H.map(u,l.find);c(i)}};H.map(u,l.find)},n.write=(u,c,l)=>{r.delete(u);let i={text:"",limit:"",done:!1,count:0,each:(f,p,v,a)=>{if(i.done)return;i.count++,f=typeof f>"u"?"":"="+V.encode(f);let g=V.encode(a.length)+"#"+V.encode(v)+f+`
`;if(i.count>1&&a.length===0&&i.text.length+g.length>e.size){let d=v.indexOf(Ae);if(i.limit=d===-1?v:v.substring(0,d),i.limit!==u){i.done=!0,i.sub=H(),H.map(c,i.slice),n.write(i.limit,i.sub,l);return}}i.text+=g},slice:(f,p)=>{p<i.limit||i.sub(p,f)}};H.map(c,i.each,!0);let s=Date.now();e.store.put(u,i.text,f=>{o("file-write",s,u,i.text.length),l(f)})},n.read=(u,c)=>{let l=u.indexOf(Ae),i=l===-1?u:u.substring(0,l),s={lex:f=>{if(!f){if(!s.file){c("no file found",t);return}if(r.has(s.file)){let p=r.get(s.file);if(s.value=p(u),typeof s.value<"u")return c(t,s.value)}n.parse(s.file,s.it);return}f>i||f<s.file||(s.file=f)},it:(f,p)=>{f&&e.log(f),p&&(r.set(s.file,p),s.value=p(u)),c(f,s.value)}};e.store.list(s.lex)},n.parse=(u,c)=>{let l={disk:H(),read:(i,s)=>{if(i)return c(i);if(!s)return c(t,l.disk);let f=[],p=l.split(s);for(;p;){let v,a,g=p[1];p=l.split(p[2])||"",p[0]==="#"&&(v=p[1],f=f.slice(0,g),g<=f.length&&f.push(v)),p=l.split(p[2])||"",p[0]!==`
`&&(p[0]==="="&&(a=p[1]),typeof v<"u"&&typeof a<"u"&&l.disk(f.join(""),a),p=l.split(p[2]))}c(t,l.disk)},split:i=>{if(!i)return;let s=i.indexOf(B);if(s===-1)return;let f=i.slice(0,s),p={};return[f,V.decode(i.slice(s),p),i.slice(s+p.i)]}};e.store.get(u,l.read)},n};V.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=Oe+e[1],e=e[0]),typeof e=="string"){let o=0,n=null,u=B;for(;n=e[o++];)n===B&&(u+=B);return u+'"'+e+t+B}let r=D.is(e);if(r)return B+"#"+r+t+B;if(ie.is(e))return B+"+"+(e||0)+t+B;if(e===!0)return B+"+"+t+B;if(e===!1)return B+"-"+t+B;if(e===null)return B+" "+t+B};V.decode=(e,t)=>{var r=-1,o=0,n=null,u=null,c=-1,l=-1;if(e[0]!==B)return;for(;n=e[++r];)if(u){if(c===-1&&(c=r),n===B&&--o<=0){l=r;break}}else n===B?o++:u=n||!0;let i=c!==-1?e.slice(c,l!==-1?l:r):"";t&&(t.i=r+1);let[s,f]=i.split(Oe);if(f){if(f=parseFloat(f),u==='"')return[s,f];if(u==="#")return[D.ify(s),f];if(u==="+")return s.length===0?[!0,f]:[parseFloat(s),f];if(u==="-")return[!1,f];if(u===" ")return[null,f]}else{if(u==='"')return i;if(u==="#")return D.ify(i);if(u==="+")return i.length===0?!0:parseFloat(i);if(u==="-")return!1;if(u===" ")return null}};var _e=V;var Ie=typeof document>"u",Z=Ie?await import("node:fs"):void 0,Ce="",ce="",we=ce+"+0"+ce+"#"+ce+'"root'+ce,Ge=e=>{let t=e.file;if(Ie)return Z.existsSync(t)||Z.mkdirSync(t),Z.existsSync(t+"/!")||Z.writeFileSync(t+"/!",we),{get:(r,o)=>{Z.readFile(t+"/"+r,(n,u)=>{if(n){if(n.code==="ENOENT"){o();return}console.log("fs.readFile error:",n)}u&&(u=u.toString()),o(n,u)})},put:(r,o,n)=>{var u=r+"."+I.random(9)+".tmp";Z.writeFile(u,o,c=>{if(c){console.log("fs.writeFile error:",c),n(c);return}Z.rename(u,t+"/"+r,n)})},list:r=>{Z.readdir(t,(o,n)=>{if(o){console.log("fs.readdir error:",o),r();return}n.forEach(r),r()})}};if(e.indexedDB){let r,o=indexedDB.open(t,1);return o.onupgradeneeded=n=>{n.target.result.createObjectStore(t)},o.onerror=n=>{console.log(n)},o.onsuccess=()=>{if(r=o.result,r){let u=r.transaction([t],"readonly").objectStore(t).getKey("!");u.onerror=()=>{console.log(`error getting key ${t}/!`)},u.onsuccess=()=>{if(!u.result){let l=r.transaction([t],"readwrite").objectStore(t).put(we,"!");l.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(n,u)=>{let c=(s,f)=>{let v=r.transaction([t],"readonly").objectStore(t).get(s);v.onerror=()=>{console.log(`error getting ${t}/${s}`)},v.onsuccess=()=>{f(null,v.result)}};if(r){c(n,u);return}let l=0,i=setInterval(()=>{if(r){clearInterval(i),c(n,u);return}l++>5&&(clearInterval(i),u("error indexedDB not available"))},1e3)},put:(n,u,c)=>{let l=(f,p,v)=>{let g=r.transaction([t],"readwrite").objectStore(t).put(p,f);g.onerror=()=>{console.log(`error putting data on ${t}/${f}`)},g.onsuccess=()=>{v(null)}};if(r){l(n,u,c);return}let i=0,s=setInterval(()=>{if(r){clearInterval(s),l(n,u,c);return}i++>5&&(clearInterval(s),c("error indexedDB not available"))},1e3)},list:n=>{let u=i=>{let f=r.transaction([t],"readonly").objectStore(t).getAllKeys();f.onerror=()=>console.log("error getting keys for",t),f.onsuccess=()=>{f.result.forEach(i),i()}};if(r){u(n);return}let c=0,l=setInterval(()=>{if(r){clearInterval(l),u(n);return}c++>5&&(clearInterval(l),console.log("error indexedDB not available"),n())},1e3)}}}return{get:(r,o)=>{o(null,we)},put:(r,o,n)=>{n(null)},list:r=>{r("!"),r()}}},ze=e=>{R.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Ge(e));let t=_e(e);return{get:(r,o)=>{if(!r||!R.is(r)){o("lex required");return}if(!r["#"]){o("soul required in lex");return}var n=r["#"],u=typeof r["."]=="string"?r["."]:"",c;let l=(i,s)=>{Q(r["."],s)&&(c||(c={_:{"#":n,">":{}}}),c[s]=i[0],c._[">"][s]=i[1])};t(n+Ce+u,(i,s)=>{let f;R.is(s)?(H.map(s,l),c||l(s,u),f={[n]:c}):s&&(l(s,u),f={[n]:c}),o(i,f)})},put:(r,o)=>{if(!r){o("graph required");return}let n=0,u=!1,c=l=>{if(n--,!u){if(l){u=!0,o(l);return}n===0&&(u=!0,o(null))}};Object.keys(r).forEach(l=>{var i=r[l];Object.keys(i).forEach(s=>{if(s==="_")return;n++;let f=i[s],p=i._[">"][s];t(l+Ce+s,[f,p],c)})})}}},Ne=ze;var De=typeof document>"u",Me=De?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Me?.WebSocket);var Xe=e=>{let t=new Map,r=e.maxRequestsPerMinute||100,o=e.rateLimitWindow||6e4,n=e.wss&&e.wss.constructor.name==="Server",u=null;return n||(u=setInterval(()=>{let l=Date.now();for(let[i,s]of t.entries())l-s.lastCleanup>o&&(s.requests=[],s.lastCleanup=l),s.requests=s.requests.filter(f=>l-f<o)},o/4)),{getDelay:l=>{let i=Date.now(),s=t.get(l)||{requests:[],lastCleanup:i};if(s.requests=s.requests.filter(f=>i-f<o),s.requests.length>=r){let f=Math.min(...s.requests),p=o-(i-f);return Math.max(0,p)}return s.requests.push(i),t.set(l,s),0},getRemainingRequests:l=>{let i=t.get(l);if(!i)return r;let s=Date.now(),f=i.requests.filter(p=>s-p<o);return Math.max(0,r-f.length)},destroy:()=>{u&&(clearInterval(u),u=null),t.clear()}}},Ze=(e,t=1024*1024)=>{try{if(typeof e=="string"&&e.length>t)throw new Error("Message too large");return{success:!0,data:JSON.parse(e)}}catch(r){return{success:!1,error:r.message}}},Qe=(e,t=1024*1024)=>typeof e=="string"&&e.length>t?{valid:!1,error:"Message too large"}:Buffer.isBuffer(e)&&e.length>t?{valid:!1,error:"Message too large"}:{valid:!0},Ye=(e=1e3)=>{let t=new Set;return{add:r=>{if(t.size>=e)return!1;t.add(r);let o=r.close;return r.close=(...n)=>(t.delete(r),o.apply(r,n)),!0},remove:r=>{t.delete(r)},count:()=>t.size,isFull:()=>t.size>=e}},be=(e=5)=>{let t=0;return{shouldRetry:()=>t<e,getDelay:()=>Math.min(1e3*Math.pow(2,t),3e4),increment:()=>t++,reset:()=>t=0}},Ve=e=>{let t=ve(e.maxAge),r=Ne(e),o={},n={},u={},c=new Set,l=async k=>o[k]?!0:new Promise(b=>{r.get({"#":k},(y,m)=>{b(!y&&m&&m[k])})}),i=Xe(e),s=Ye(e.maxConnections||1e3),f=async(k,b,y)=>{for(let m of Object.keys(k)){let E=await new Promise(_=>{a({"#":m},_,b)});if(E.err)return y&&y(E.err),!1;let w=k[m],A=F;if(!(!E.put||!E.put[m]||E.put[m][A]===w[A]))return y&&y(`error in wire check public key does not match for soul: ${m}`),!1}return!0},p=(k,b)=>{let y=de(k.get,o);y?b(JSON.stringify({"#":t.track(I.random(9)),"@":k["#"],put:y})):r.get(k.get,(m,E)=>{b(JSON.stringify({"#":t.track(I.random(9)),"@":k["#"],put:E,err:m}))})},v=async(k,b)=>{let y=await me.mix(k.put,o,e.secure,u);if(Object.keys(y.now).length){if(!await f(y.now,b))return;r.put(y.now,m=>{b(JSON.stringify({"#":t.track(I.random(9)),"@":k["#"],err:m}))})}Object.keys(y.defer).length&&setTimeout(()=>v({put:y.defer},b),y.wait)},a=(k,b,y,m)=>{if(!b)return;R.is(m)||(m={});let E=de(k,o),w=I.random(9),A=JSON.stringify({"#":t.track(w),get:e.secure?{"#":k["#"]}:k});if(E){y(A),b({put:E});return}r.get(k,(_,N)=>{if(N){y(A),b({put:N,err:_});return}_&&console.log(_),n[w]=b,y(A),setTimeout(()=>{let C=n[w];if(C){let U=k["#"],K={[U]:null};typeof k["."]=="string"&&(K[U]={[k["."]]:null}),C({put:K}),delete n[w]}},m.wait||100)})},g=k=>({get:(b,y,m)=>{b&&b["#"]&&c.add(b["#"]),a(b,y,k,m)},put:async(b,y)=>{let m=await me.mix(b,o,e.secure,u);if(Object.keys(m.now).length===0){y(null);return}if(await f(m.now,k,y)){for(let[w,A]of Object.entries(m.now))if(A&&typeof A=="object")for(let[_,N]of Object.entries(A)){let C=D.is(N);C&&c.add(C)}r.put(m.now,y),k(JSON.stringify({"#":t.track(I.random(9)),put:b}))}},on:(b,y,m,E)=>{let w=b&&b["#"];!w||!y||(u[w]?u[w].push({".":b["."],cb:y}):u[w]=[{".":b["."],cb:y}],m&&a(b,y,k,E))},off:(b,y)=>{let m=b&&b["#"];if(!(!m||!u[m]))if(y){let E=u[m].find(w=>w.cb===y);E&&u[m].splice(u[m].indexOf(E),1)}else delete u[m]}});if(De){let k=e.wss,b=()=>k.clients();if(!k){let m=e.server?{server:e.server}:{port:e.port||8765};k=new Me.WebSocketServer(m),b=()=>k.clients}let y=(m,E)=>{b().forEach(w=>{if(w&&w.readyState===WebSocket.OPEN)w.send(m,{binary:E});else{let A=w._retryHandler||be();if(w._retryHandler=A,A.shouldRetry()){let _=A.getDelay();A.increment(),setTimeout(()=>{w&&w.readyState===WebSocket.OPEN&&(A.reset(),w.send(m,{binary:E}))},_)}}})};return k.on("connection",m=>{if(!s.add(m)){console.log("Connection limit reached, rejecting connection"),m.close(1013,"Connection limit reached - try again later");return}let E=I.random(9);console.log(`[HOLSTER-CONNECT] New WebSocket client connected: ${E}`),m.on("error",w=>{console.error("WebSocket error:",w),s.remove(m)}),m.on("close",()=>{console.log(`[HOLSTER-DISCONNECT] WebSocket client disconnected: ${E}`),s.remove(m)}),m.on("message",(w,A)=>{let _=Qe(w,e.maxMessageSize);if(!_.valid){console.warn(`Invalid message: ${_.error}`),m.send(JSON.stringify({error:_.error}));return}let N=Ze(w,e.maxMessageSize);if(!N.success){console.warn(`JSON parse error: ${N.error}`),m.send(JSON.stringify({error:"Invalid JSON"}));return}let C=N.data;if(t.check(C["#"]))return;let U=i.getDelay(E);if(U>0){console.log(`[HOLSTER-THROTTLE] Client ${E}: rate limit exceeded, delay would be ${U}ms, dropping message`),m.send(JSON.stringify({"#":t.track(I.random(9)),"@":C["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(U/1e3)}s`,throttle:U}));return}let K=()=>{t.track(C["#"]),C.get&&p(C,y),C.put&&v(C,y),y(w,A);let pe=C["@"],oe=n[pe];oe&&(delete C["#"],delete C["@"],oe(C),delete n[pe])};U>0?setTimeout(K,U):K()})}),g(y)}let d=[],T=!1,h=0,S=[],x=null,$=()=>{if(S.length===0){x=null;return}let k=Date.now();if(T&&k<h){x=setTimeout($,Math.min(1e3,h-k));return}T&&k>=h&&(console.log("[CLIENT-THROTTLED] Throttle period ended, resuming queue processing"),T=!1,h=0);let b=S.shift();j(b),S.length>0?x=setTimeout($,100):x=null},j=k=>{d.forEach(b=>{if(b&&b.readyState===WebSocket.OPEN)b.send(k);else{let y=b._retryHandler||be();if(b._retryHandler=y,y.shouldRetry()){let m=y.getDelay();y.increment(),setTimeout(()=>{b&&b.readyState===WebSocket.OPEN&&(y.reset(),b.send(k))},m)}}})},O=k=>{let b=Date.now();if(T||S.length>0){S.push(k),console.log(`[CLIENT-THROTTLED] Queuing message (queue length: ${S.length})`),x||(x=setTimeout($,100));return}j(k)};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(k=>{let b=()=>{let y=new WebSocket(k);d.push(y);let m=be();y.onclose=E=>{if(d.indexOf(y)!==-1&&d.splice(d.indexOf(y),1),y=null,m.shouldRetry()){let w=m.getDelay();m.increment(),setTimeout(b,w)}},y.onopen=()=>{m.reset()},y.onerror=E=>{console.error(E)},y.onmessage=async E=>{let w=JSON.parse(E.data);if(t.check(w["#"]))return;if(w.throttle&&w.err){console.log(`[CLIENT-THROTTLED] Server throttling: ${w.err}`),T=!0,h=Date.now()+w.throttle;return}if(t.track(w["#"]),w.get&&p(w,O),w.put){let N={};for(let[C,U]of Object.entries(w.put)){let K=!1;if(await l(C)&&(K=!0,U&&typeof U=="object"))for(let[pe,oe]of Object.entries(U)){let Se=D.is(oe);Se&&c.add(Se)}c.has(C)&&(K=!0,c.delete(C)),K&&(N[C]=U)}Object.keys(N).length>0&&v({put:N},O)}O(E.data);let A=w["@"],_=n[A];_&&(delete w["#"],delete w["@"],_(w),delete n[A])}};b()}),g(O)},ge=Ve;var et=(e,t)=>{t||(t=ge(e));let r=[],o=!1,n=!1,u=0,c=(i,s,f,p)=>{let v=T=>{u++,c(T,s,f,p)},a=T=>{r=[],u=0,n=!1,p(T)},g=()=>{if(r.length===0){a("Wrong username or password");return}let T=r.shift();t.get({"#":T},async h=>{if(h.err){a(`error getting ${T}: ${h.err}`);return}let S=h.put&&h.put[T];if(!S||!S.auth)return g();let x=JSON.parse(S.auth),$=await P.work(s,x.salt),j=await P.decrypt(x.enc,$);if(!j)return g();if(l.is={username:i,pub:S.pub,epub:S.epub,priv:j.priv,epriv:j.epriv},f!==""){let O=I.random(64),k=await P.work(f,O),b=await P.encrypt(j,k),y={username:i,pub:S.pub,epub:S.epub,auth:JSON.stringify({enc:b,salt:O})},m=await P.sign(y,l.is),E=G(T,m.m,m.s,S.pub);t.put(E,w=>{a(w?`error putting ${y} on ${T}: ${w}`:null)});return}return a(null)},{wait:1e3})};if(u>9){a("Wrong username or password");return}let d="~@"+i;t.get({"#":d},async T=>{if(T.err){a(`error getting ${d}: ${T.err}`);return}let h=T.put&&T.put[d];if(!h)return v(i);delete T.put[d]._,r=Object.keys(h),g()},{wait:1e3})},l={create:(i,s,f)=>{let p=a=>{f?f(a):console.log(a)};if(o){p("User is already being created");return}if(i===""){p("Please provide a username");return}if(s===""){p("Please provide a password");return}o=!0;let v="~@"+i;t.get({"#":v},async a=>{if(a.err){o=!1,p(`error getting ${v}: ${a.err}`);return}if(a.put&&a.put[v]){o=!1,p("Username already exists");return}let g=I.random(64),d=await P.work(s,g),T=await P.pair(),h={priv:T.priv,epriv:T.epriv},S=await P.encrypt(h,d),x={username:i,pub:T.pub,epub:T.epub,auth:JSON.stringify({enc:S,salt:g})},$="~"+T.pub,j=await P.sign(x,T),O=G($,j.m,j.s,T.pub);t.put(O,k=>{if(o=!1,k){p(`error putting ${x} on ${$}: ${k}`);return}let b={[$]:{"#":$}};t.put(G(v,b),y=>{if(y){p(`error putting ${b} on ${v}: ${y}`);return}f&&f(null)})})},{wait:1e3})},auth:(i,s,f)=>{let p=v=>{f?f(v):v&&console.log(v)};if(n){p("User is already authenticating");return}if(l.is=null,i===""){p("Please provide a username");return}if(s===""){p("Please provide a password");return}n=!0,c(i,s,"",p)},change:(i,s,f,p)=>{let v=a=>{p?p(a):a&&console.log(a)};if(n){v("User is already authenticating");return}if(l.is=null,i===""){v("Please provide a username");return}if(s===""){v("Please provide a password");return}if(f===""){v("Please provide a new password");return}n=!0,c(i,s,f,v)},store:i=>{if(!l.is){console.log("Please authenticate before calling store");return}if(i){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(l.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(l.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let i=globalThis.localStorage.getItem("user.is");if(i){l.is=JSON.parse(i);return}}if(typeof globalThis.sessionStorage<"u"){let i=globalThis.sessionStorage.getItem("user.is");i&&(l.is=JSON.parse(i))}},leave:()=>{l.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(i,s,f)=>{let p=v=>{f?f(v):console.log(v)};if(n){p("User is already authenticating");return}if(i===""){p("Please provide a username");return}if(s===""){p("Please provide a password");return}n=!0,c(i,s,"",async v=>{if(v){p(v);return}let a={username:null,pub:null,epub:null,auth:null},g=await P.sign(a,l.is),d="~"+l.is.pub,T=G(d,g.m,g.s,l.is.pub);t.put(T,h=>{if(h){p(`error putting null on ${d}: ${h}`);return}l.is=null,f&&f(null)})})}};return l},Re=et;var tt=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:R.is(e)||(e={});let t=ge(e),r=Re(null,t),o=new Map,n=new Map,u=i=>i===null||i===!0||i===!1||typeof i=="string"||D.is(i)||ie.is(i),c=i=>{if(u(i))return!0;if(R.is(i)){let f=[];for(let[p,v]of Object.entries(i)){if(p==="_")return"error underscore cannot be used as a property name";if(R.is(v)||u(v)){f.push(p);continue}return typeof v>"u"?`error undefined ${p} cannot be converted to a graph`:`error ${JSON.stringify({[p]:v})} cannot be converted to a graph`}if(f.length!==0)return f}return`error ${JSON.stringify(i)} cannot be converted to a graph`},l=i=>{let s=(a,g,d,T)=>{t.get(R.put(a,"#",g),async h=>{if(h.err&&console.log(h.err),h.put&&h.put[g]){delete h.put[g]._,delete h.put[g][F],delete h.put[g][J];for(let S of Object.keys(h.put[g])){let x=D.is(h.put[g][S]);if(x){let $=await new Promise(j=>{let O=I.random();n.set(O,{chain:[{item:null,soul:x}]}),l(O).next(null,j,T)});h.put[g][S]=$}}d(h.put[g])}else d(null)},T)},f=async(a,g,d,T)=>{if(d){let h=await P.sign(g,d);return G(a,h.m,h.s,d.pub)}return e.secure?(T||(T=console.log),T(`error putting data on ${a}: user required in secure mode`),null):G(a,g)},p=a=>g=>{let d=n.get(a);d&&typeof d.cb<"u"?setTimeout(()=>d.cb(g),1):g&&console.log("error no callback for data",g,"ctx",d),d&&!d.on&&n.delete(a)},v=(a,g)=>{if(!a){console.log("error resolve request parameter required");return}let d=typeof a.get<"u",T=typeof a.put<"u",h=typeof a.on<"u",S=typeof a.off<"u",x=!1,$=n.get(i);for(var j=1;j<$.chain.length;j++)if($.chain[j].soul===null){x=!0;break}if(x){let{item:O,soul:k}=$.chain[j-1],b=$.user||e.secure?{"#":k}:{"#":k,".":O};return t.get(b,async y=>{if(y.err){$.user||e.secure?console.log(`error getting ${k}: ${y.err}`):console.log(`error getting ${O} on ${k}: ${y.err}`),g&&g(null);return}let m=y.put&&y.put[k];if(m&&typeof m[O]<"u"){let E=D.is(m[O]);if(E)$.chain[j].soul=E,n.set(i,{...$}),d?l(i).next(null,a.get,g,a._opt):T?l(i).put(a.put,g):h?l(i).on(a.on,g,a._get,a._opt):S&&l(i).off(g);else if(d)g(m[O]);else if(T){E=I.random(),m[O]=D.ify(E);let w=await f(k,m,$.user,g);if(w===null)return;t.put(w,A=>{if(A){g(`error putting ${O} on ${k}: ${A}`);return}$.chain[j].soul=E,l(i).put(a.put,g)})}else(h||S&&g)&&g(null)}else if(T){let E=I.random();m||(m={}),m[O]=D.ify(E);let w=await f(k,m,$.user,g);if(w===null)return;t.put(w,A=>{if(A){g(`error putting ${O} on ${k}: ${A}`);return}$.chain[j].soul=E,l(i).put(a.put,g)})}else g&&g(null)},a._opt),!1}return d&&$.chain[$.chain.length-1].item!==null?($.chain.push({item:null,soul:null}),l(i).next(null,a.get,g,a._opt),!1):$.chain[$.chain.length-1]};return{get:(a,g,d,T)=>{if(typeof g=="function"&&(T=d,d=g,g=null),a===null||a===""||a==="_"){console.log("error please provide a key"),d&&d(null);return}if(g&&typeof d!="function"){console.log("error lex requires a callback function");return}if(i=I.random(),n.set(i,{chain:[{item:a,soul:"root"}],cb:d}),!d)return l(i);let h=p(i),{soul:S}=v({get:g,_opt:T},h);S&&s(g,S,h,T)},next:(a,g,d,T)=>{let h=j=>O=>{d?d(O):p(j)(O)};if(typeof g=="function"&&(T=d,d=g,g=null),!i){console.log("error please provide a key using get(key)"),d&&d(null);return}let S=h(i);if(a===""||a==="_"){S(null);return}if(g&&typeof d!="function"){console.log("error lex requires a callback function");return}let x=n.get(i);if(!x)return;if(d&&typeof x.cb>"u"&&(x.cb=d,d=null),a!==null&&x.chain.push({item:a,soul:null}),!x.cb)return l(i);let{soul:$}=v({get:g,_opt:T},S);$&&s(g,$,S,T)},put:(a,g,d)=>{typeof g=="function"&&(d=g,g=!1);let T=k=>b=>{d?d(b):p(k)(b)};if(!i){d&&d("error please provide a key using get(key)");return}let h=n.get(i);if(!h)return;if(!h.cb){if(!d)return;h.cb=d,d=null}g&&(a={[I.random()]:a});let S=T(i),x=c(a);if(typeof x=="string"){S(x);return}let{item:$,soul:j}=v({put:a},S);if(!j)return;if(x===!0){let k=h.user||e.secure?{"#":j}:{"#":j,".":$};t.get(k,async b=>{if(b.err){S(`error getting ${j}: ${b.err}`);return}let y=b.put&&b.put[j],m=y&&y[$],E=D.is(m);if(!E){y||(y={}),y[$]=a;let w=await f(j,y,h.user,S);if(w===null)return;t.put(w,S);return}t.get({"#":E},async w=>{if(w.err){S(`error getting ${E}: ${w.err}`);return}if(!w.put||!w.put[E]){S(`error ${E} not found`);return}for(let _ of Object.keys(w.put[E])){if(_==="_"||_===F||_===J)continue;let N=await new Promise(C=>{let U=I.random(),K=[{item:_,soul:E}];n.set(U,{chain:K,user:h.user}),l(U).put(null,C)});if(N){S(N);return}}y||(y={}),y[$]=a;let A=await f(j,y,h.user,S);A!==null&&t.put(A,S)})});return}let O=h.user||e.secure?{"#":j}:{"#":j,".":$};t.get(O,async k=>{if(k.err){S(`error getting ${j}.${$}: ${k.err}`);return}let b=k.put&&k.put[j],y=b&&b[$],m=D.is(y);if(!m){b||(b={}),b[$]=D.ify(I.random());let w=await f(j,b,h.user,S);if(w===null)return;t.put(w,A=>{if(A)S(`error putting ${$} on ${j}: ${A}`);else{let _=I.random(),N=[{item:$,soul:j}];n.set(_,{chain:N,user:h.user,cb:h.cb}),l(_).put(a)}});return}let E=[];for(let w of x){let A=await new Promise(_=>{if(R.is(a[w])&&!D.is(a[w])){let N=I.random(),C=[{item:w,soul:m}];n.set(N,{chain:C,user:h.user}),l(N).put(a[w],_)}else E.push(w),_(null)});if(A){S(A,i);return}}if(E.length===0){S(null);return}t.get({"#":m},async w=>{if(w.err){S(`error getting ${m}: ${w.err}`);return}let A=w.put&&w.put[m];A||(A={}),E.forEach(N=>{A[N]=a[N]});let _=await f(m,A,h.user,S);_!==null&&t.put(_,S)})})},on:(a,g,d,T)=>{if(typeof a=="function"&&(T=d,d=g,g=a,a=null),typeof g!="function"){console.log("error on() requires a callback function");return}if(!i){console.log("error please provide a key using get(key)"),g(null);return}let{item:h,soul:S}=v({on:a,_get:d,_opt:T},g);S&&(n.set(i,{chain:[{item:h,soul:S}],on:!0}),o.set(g,()=>l(i).next(null,g,T)),t.get({"#":S,".":h},x=>{if(x.err){console.log(`error getting ${S}.${h}: ${x.err}`);return}let $=x.put&&x.put[S]&&x.put[S][h],j=D.is($);j?a?a=R.put(a,"#",j):a={"#":j,".":null}:a?a=R.put(a,"#",S):a={"#":S,".":h},t.on(a,o.get(g),d,T)},T))},off:a=>{if(!i){console.log("error please provide a key using get(key)"),a&&a(null);return}let{item:g,soul:d}=v({off:!0},a);d&&t.get({"#":d,".":g},T=>{if(T.err){console.log(`error getting ${d}.${g}: ${T.err}`);return}let h=T.put&&T.put[d]&&T.put[d][g],S=D.is(h);S?t.off({"#":S},o.get(a)):t.off({"#":d},o.get(a)),o.delete(a),n.delete(i)})},user:()=>(r.get||(Object.assign(r,l()),r.get=(a,g,d,T)=>{typeof g=="function"&&(T=d,d=g,g=null);let h=null,S=null;if(r.is&&(h=r.is.pub),typeof a=="string"?S=a:a instanceof Array&&(a.length===2?(h=a[0],S=a[1]):a.length===1&&(S=a[0])),!h){console.log("error please log in or provide a public key"),d&&d(null);return}if(S===null||S===""||S==="_"){console.log("error please provide a key"),d&&d(null);return}if(g&&!d){console.log("error lex requires a callback function");return}i=I.random();let x=[{item:S,soul:"~"+h}];if(n.set(i,{chain:x,user:r.is,cb:d}),!d)return l(i);let $=p(i),{soul:j}=v({get:g,_opt:T},$);j&&s(g,j,$,T)}),r),wire:t,SEA:P}};return l()},Ct=tt;export{Ct as default};
//# sourceMappingURL=holster.js.map
