var X={is:e=>!(e instanceof Array)&&(e-parseFloat(e)+1>=0||e===1/0||e===-1/0)},A={is:e=>e?e instanceof Object&&e.constructor===Object||Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/)[1]==="Object":!1,map:(e,t,o)=>{var r=Object.keys(e);for(let n=0;n<r.length;n++){let l=t(e[r[n]],r[n],o);if(typeof l<"u")return l}},put:(e,t,o)=>(e||(e={}),e[t]=o,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Se=(e,t,o)=>{if(o.id){o.id=!1;return}if(t==="#"&&typeof e=="string"){o.id=e;return}o.id=!1},T={is:e=>{if(e&&e["#"]&&!e._&&A.is(e)){let t={};if(A.map(e,Se,t),t.id)return t.id}return!1},ify:e=>A.put({},"#",e)},W="_holster_user_public_key",M=(e,t,o,r)=>{let n={[e]:{_:{"#":e,">":{},s:o,p:r}}};for(let[l,f]of Object.entries(t))n[e][l]=f,n[e]._[">"][l]=Date.now();return r&&(n[e][W]=r,n[e]._[">"][W]=Date.now()),n},L=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!A.is(e)||!t)return!1;let o=e["*"];if(o)return t.slice(0,o.length)===o;let r=e[">"],n=e["<"];return r&&n?t>=r&&t<=n:r?t>=r:n?t<=n:!1},O={random:e=>{var t="";let o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let r=0;r<e;r++)t+=o.charAt(Math.floor(Math.random()*o.length));return t}};var ke=e=>{e||(e=9e3);let t={store:{}};return t.check=o=>t.store[o]?t.track(o):!1,t.track=o=>(t.store[o]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{let r=Date.now();Object.keys(t.store).forEach(n=>{r-t.store[n]>e&&delete t.store[n]}),t.expiry=null},e)),o),t},le=ke;var xe=(e,t)=>{let o=e["#"],r=typeof e["."]=="string"?e["."]:!1;var n=t[o];if(!n||!r)return;let l=n[r];if(l)return n={_:n._,[r]:l},n._[">"]={[r]:n._[">"][r]},{[o]:n}},ne=xe;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function Z(){}Object.assign(Z,{from:Array.from});Z.prototype=Object.create(Array.prototype);Z.prototype.toString=function(e,t,o){e||(e="utf8"),t||(t=0);let r=this.length;if(e==="hex"){let n=new Uint8Array(this);return[...Array((o&&o+1||r)-t).keys()].map(l=>n[l+t].toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:(o||r)-t},(n,l)=>String.fromCharCode(this[l+t])).join("");if(e==="base64")return btoa(this)};var F=Z;function R(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),R.from(...e)}R.prototype=Object.create(Array.prototype);Object.assign(R,{from(){if(!Object.keys(arguments).length||arguments[0]==null)throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.");let e=arguments[0],t;if(typeof e=="string"){let r=arguments[1]||"utf8";if(r==="hex"){let n=e.match(/([\da-fA-F]{2})/g).map(l=>parseInt(l,16));if(!n||!n.length)throw new TypeError("Invalid first argument for type 'hex'.");t=F.from(n)}else if(r==="utf8"||r==="binary"){let n=e.length,l=new Uint16Array(n);Array.from({length:n},(f,s)=>l[s]=e.charCodeAt(s)),t=F.from(l)}else if(r==="base64"){let n=atob(e),l=n.length,f=new Uint8Array(l);Array.from({length:l},(s,i)=>f[i]=n.charCodeAt(i)),t=F.from(f)}else console.info("SafeBuffer.from unknown encoding: "+r);return t}if(e.byteLength?e.byteLength:e.length){let r;return e instanceof ArrayBuffer&&(r=new Uint8Array(e)),F.from(r||e)}},alloc(e,t=0){return F.from(new Uint8Array(Array.from({length:e},()=>t)))},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be Array containing ArrayBuffer or Uint8Array instances.");return F.from(e.reduce((t,o)=>t.concat(Array.from(o)),[]))}});R.prototype.from=R.from;R.prototype.toString=F.prototype.toString;var N=R;var je=typeof document>"u",fe=je?(await import("node:crypto")).webcrypto:globalThis.crypto,_=fe.subtle,Y=e=>typeof e=="string"?e:JSON.stringify(e),q=e=>{try{return JSON.parse(e)}catch{return e}},V=e=>{let t=new Uint8Array(N.alloc(e));return N.from(fe.getRandomValues(t))},Q=(e,t)=>{let[o,r]=e.split(".");return{kty:"EC",crv:"P-256",x:o,y:r,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},ee=async e=>{let t=await _.digest({name:"SHA-256"},new TextEncoder().encode(Y(e)));return N.from(t)},ie=async(e,t)=>{let o=e+t.toString("utf8"),r=N.from(await ee(o),"binary"),n=$e(r);return await _.importKey("jwk",n,{name:"AES-GCM"},!1,["encrypt","decrypt"])},$e=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var Ae={pair:async e=>{let t=await _.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async n=>{let l=await _.exportKey("jwk",n.publicKey);return{priv:(await _.exportKey("jwk",n.privateKey)).d,pub:l.x+"."+l.y}}),o=await _.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async n=>{let l=await _.exportKey("jwk",n.publicKey);return{epriv:(await _.exportKey("jwk",n.privateKey)).d,epub:l.x+"."+l.y}}),r={pub:t.pub,priv:t.priv,epub:o.epub,epriv:o.epriv};return e&&e(r),r},encrypt:async(e,t,o)=>{if(!t||!t.epriv)return o&&o(null),null;let r={s:V(9),iv:V(15)},n=await ie(t.epriv,r.s).then(f=>_.encrypt({name:"AES-GCM",iv:new Uint8Array(r.iv)},f,new TextEncoder().encode(Y(e)))),l={ct:N.from(n,"binary").toString("base64"),iv:r.iv.toString("base64"),s:r.s.toString("base64")};return o&&o(l),l},decrypt:async(e,t,o)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return o&&o(null),null;let r={ct:N.from(e.ct,"base64"),iv:N.from(e.iv,"base64"),s:N.from(e.s,"base64")};try{let n=await ie(t.epriv,r.s).then(f=>_.decrypt({name:"AES-GCM",iv:new Uint8Array(r.iv),tagLength:128},f,new Uint8Array(r.ct))),l=q(new TextDecoder("utf8").decode(n));return o&&o(l),l}catch{return o&&o(null),null}},verify:async(e,t,o)=>{if(!t||!t.pub)return o&&o(null),null;let r=q(e),n=await _.importKey("jwk",Q(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),l={};if(typeof r.m=="string")l=r.m;else for(let p of Object.keys(r.m))p!=="_"&&p!=W&&(l[p]=r.m[p]);let f=await ee(l),s=new Uint8Array(N.from(r.s,"base64")),i={name:"ECDSA",hash:{name:"SHA-256"}};if(await _.verify(i,n,s,new Uint8Array(f))){let p=q(r.m);return o&&o(p),p}return o&&o(null),null},sign:async(e,t,o)=>{if(!t||!t.pub||!t.priv)return o&&o(null),null;let r=q(e),n=await ee(r),l=Q(t.pub,t.priv),f={name:"ECDSA",namedCurve:"P-256"},s=await _.importKey("jwk",l,f,!1,["sign"]).then(p=>_.sign({name:"ECDSA",hash:{name:"SHA-256"}},p,new Uint8Array(n))),i={m:r,s:N.from(s,"binary").toString("base64")};return o&&o(i),i},work:async(e,t,o)=>{typeof t=="function"&&(o=t,t=void 0),typeof t>"u"&&(t=V(9));let r=await _.importKey("raw",new TextEncoder().encode(Y(e)),{name:"PBKDF2"},!1,["deriveBits"]),n={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},l=await _.deriveBits(n,r,512),f={epriv:N.from(l,"binary").toString("base64")};return o&&o(f),f},secret:async(e,t,o)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return o&&o(null),null;let r={name:"ECDH",namedCurve:"P-256"},n=Q(e.epub),l=await _.importKey("jwk",n,r,!0,[]),f=Q(t.epub,t.epriv,!1);delete f.key_ops;let s=await _.importKey("jwk",f,r,!1,["deriveBits"]).then(async i=>{let p=await _.deriveBits({public:l,name:"ECDH",namedCurve:"P-256"},i,256),d=await _.importKey("raw",new Uint8Array(p),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return _.exportKey("jwk",d).then(({k:y})=>y)});return o&&o({epriv:s}),{epriv:s}}},K=Ae;var oe=(e,t,o,r)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof o!="string"&&(o=JSON.stringify(o)||""),typeof r!="string"&&(r=JSON.stringify(r)||""),o===r?{state:!0}:o<r?{current:!0}:{incoming:!0});oe.mix=async(e,t,o,r)=>{var n=Date.now(),l={},f={};let s=0;for(let i of Object.keys(e)){let p=e[i],d=!1,y=!1,m=0,u="",c=o;if(!(!p||!p._)){if(p._.s&&p._.p&&(c=!0),i.length>1&&i[0]==="~")if(i[1]==="@")y=!0,c=!1;else{if(p._.p&&i!="~"+p._.p){console.log(`error public key does not match for soul: ${i}`);continue}p._.p=i.slice(1),c=!0}if(c){if(!p._.s||!p._.p){console.log("error signature and public key required to verify data");continue}if(!await K.verify({m:p,s:p._.s},{pub:p._.p})){console.log(`error could not verify soul: ${i}`);continue}}for(let g of Object.keys(p)){if(g==="_")continue;let a=p[g],h=p._[">"][g],v=(t[i]||{})[g],b=(t[i]||{_:{">":{}}})._[">"][g]||0;if(y&&g!==T.is(a))continue;let w=h-n;if(w>0){if(w>864e5)continue;(s===0||w<s)&&(s=m=w),f[i]||(f[i]={_:{"#":i,">":{},s:p._.s,p:p._.p}}),f[i][g]=a,f[i]._[">"][g]=h}else oe(h,b,a,v).incoming&&(l[i]||(l[i]={_:{"#":i,">":{},s:p._.s,p:p._.p}}),t[i]||(t[i]={_:{"#":i,">":{},s:p._.s,p:p._.p}}),t[i][g]=l[i][g]=a,t[i]._[">"][g]=l[i]._[">"][g]=h,r[i]&&setTimeout(()=>{r[i]&&r[i].filter(x=>L(x["."],g)).forEach(x=>x.cb())},100),d=!0)}c&&m!==0&&l[i]&&(Object.assign(f[i],l[i]),delete l[i]),d&&r[i]&&setTimeout(()=>{r[i]&&r[i].filter(g=>L(g["."])).forEach(g=>g.cb())},100)}}return{now:l,defer:f,wait:s}};var se=oe;var J="",z="",ae=()=>{let e=(t,o,r)=>{if(r||(e[J]||(e[J]={}),r=e[J]),!t)return r;let n=0,l={},f=t[n],s=t.length-1,i=typeof o>"u",p=r[f];for(;!p&&n<s;)f+=t[++n],p=r[f];if(p)if(n===s){if(i)return typeof p[z]>"u"?p[J]:p[z];p[z]=o}else return!p[J]&&!i&&(p[J]={}),e(t.slice(++n),o,p[J]);else if(A.map(r,(y,m)=>{let u=0,c="";for(;m[u]===t[u];)c+=m[u++];if(c){if(i)return u<=s?void 0:(l[m.slice(u)]=y,y);let g={[m.slice(u)]:y,[t.slice(u)]:{[z]:o}};return r[c]={[J]:g},delete r[m],!0}})){if(i)return l}else{if(i)return;r[f]||(r[f]={}),r[f][z]=o}};return e};ae.map=function e(t,o,r,n){n||(n=[]);var l=t[J]||t,f=Object.keys(l).sort(),s;for(let i=0;i<f.length;i++){let p=f[i],d=l[p],y=d[z];if(typeof y<"u"){if(y=o(y,n.join("")+p,p,n),typeof y<"u")return y}else r&&o(s,n.join(""),p,n);if(d[J]){if(n.push(p),y=e(d[J],o,r,n),typeof y<"u")return y;n.pop()}}};var P=ae;var pe="",ce="",E="",G=e=>{var t,o=null;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=10*1e3),e.write||(e.write=1),e.size||(e.size=1024*1024),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let r=(n,l,f)=>{if(n=""+n,typeof l=="function")return f=l,l=r.batch(n),typeof l<"u"||r.thrash.at&&(l=r.thrash.at(n),typeof l<"u")?f(t,l):r.read(n,f);if(r.batch(n,l),f&&r.batch.acks.push(f),++r.batch.ed>=e.batch)return r.thrash();clearTimeout(r.batch.timeout),r.batch.timeout=setTimeout(r.thrash,e.write)};return r.batch=P(),r.batch.acks=[],r.batch.ed=0,r.thrash=()=>{if(r.thrash.ing)return r.thrash.more=!0;clearTimeout(r.batch.timeout),r.thrash.more=!1,r.thrash.ing=!0;var n=r.thrash.at=r.batch;r.batch=null,r.batch=P(),r.batch.acks=[],r.batch.ed=0;let l=0;r.save(n,f=>{++l>1||(f&&e.log(f),n.acks.forEach(s=>s(f)),r.thrash.at=null,r.thrash.ing=!1,r.thrash.more&&r.thrash())})},r.save=(n,l)=>{let f={find:(s,i)=>{if(!(i<f.start))return f.start=i,e.store.list(f.lex),!0},lex:s=>{if(!s||s>f.start)return f.end=s,f.mix(f.file||"!",f.start,f.end),!0;f.file=s},mix:(s,i,p)=>{f.start=f.end=f.file=t,r.parse(s,(d,y)=>{if(d)return l(d);P.map(n,(m,u)=>{if(!(u<i)){if(p&&p<u)return f.start=u,f.start;y(u,m)}}),r.write(s,y,f.next)})},next:s=>{if(s)return l(s);if(f.start)return P.map(n,f.find);l(s)}};P.map(n,f.find)},r.write=(n,l,f)=>{o=null;let s={text:"",count:0,file:n,each:(i,p,d,y)=>{s.count++;var m=G.encode(y.length)+"#"+G.encode(d)+(typeof i>"u"?"":"="+G.encode(i))+`
`;if(s.count>1&&s.text.length+m.length>e.size)return s.text="",s.limit=Math.ceil(s.count/2),s.count=0,s.sub=P(),P.map(l,s.slice),!0;s.text+=m},put:()=>{e.store.put(n,s.text,f)},slice:(i,p)=>{if(!(p<s.file)){if(++s.count>s.limit){var d=s.file;let y=p.indexOf(ce);return y===-1?s.file=p:s.file=p.substring(0,y),s.sub(s.file,null),s.count=0,r.write(d,s.sub,s.next),!0}s.sub(p,i)}},next:i=>{if(i)return f(i);s.sub=P(),P.map(l,s.slice)||r.write(s.file,s.sub,f)}};P.map(l,s.each,!0)||s.put()},r.read=(n,l)=>{if(o){let p=o(n);if(typeof p<"u")return l(t,p)}let f=n,s=n.indexOf(ce);s!==-1&&(f=n.substring(0,s));let i={lex:p=>{if(!p){if(!i.file){l("no file found",t);return}r.parse(i.file,i.it);return}p>f||p<i.file||(i.file=p)},it:(p,d)=>{p&&e.log(p),d&&(o=d,i.value=d(n)),l(p,i.value)}};e.store.list(i.lex)},r.parse=(n,l)=>{let f={disk:P(),read:(s,i)=>{if(s)return l(s);if(!i)return l(t,f.disk);let p=[],d=f.split(i);for(;d;){let y,m,u=d[1];d=f.split(d[2])||"",d[0]==="#"&&(y=d[1],p=p.slice(0,u),u<=p.length&&p.push(y)),d=f.split(d[2])||"",d[0]!==`
`&&(d[0]==="="&&(m=d[1]),typeof y<"u"&&typeof m<"u"&&f.disk(p.join(""),m),d=f.split(d[2]))}l(t,f.disk)},split:s=>{if(!s)return;let i=-1,p="",d=null;for(;(d=s[++i])&&d!==E;)p+=d;let y={};if(d)return[p,G.decode(s.slice(i),y),s.slice(i+y.i)]}};e.store.get(n,f.read)},r};G.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=pe+e[1],e=e[0]),typeof e=="string"){let r=0,n=null,l=E;for(;n=e[r++];)n===E&&(l+=E);return l+'"'+e+t+E}let o=T.is(e);if(o)return E+"#"+o+t+E;if(X.is(e))return E+"+"+(e||0)+t+E;if(e===!0)return E+"+"+t+E;if(e===!1)return E+"-"+t+E;if(e===null)return E+" "+t+E};G.decode=(e,t)=>{var o="",r=-1,n=0,l=null,f=null;if(e[0]!==E)return;for(;l=e[++r];)if(f){if(l===E&&--n<=0)break;o+=l}else l===E?n++:f=l||!0;t&&(t.i=r+1);let[s,i]=o.split(pe);if(i){if(i=parseFloat(i),f==='"')return[s,i];if(f==="#")return[T.ify(s),i];if(f==="+")return s.length===0?[!0,i]:[parseFloat(s),i];if(f==="-")return[!1,i];if(f===" ")return[null,i]}else{if(f==='"')return o;if(f==="#")return T.ify(o);if(f==="+")return o.length===0?!0:parseFloat(o);if(f==="-")return!1;if(f===" ")return null}};var ge=G;var he=typeof document>"u",H=he?await import("node:fs"):void 0,de="",te="",ue=te+"+0"+te+"#"+te+'"root'+te,Oe=e=>{let t=e.file;if(he)return H.existsSync(t)||H.mkdirSync(t),H.existsSync(t+"/!")||H.writeFileSync(t+"/!",ue),{get:(o,r)=>{H.readFile(t+"/"+o,(n,l)=>{if(n){if(n.code==="ENOENT"){r();return}console.log("fs.readFile error:",n)}l&&(l=l.toString()),r(n,l)})},put:(o,r,n)=>{var l=Math.random().toString(36).slice(-9),f=o+"."+l+".tmp";H.writeFile(f,r,s=>{if(s){n(s);return}H.rename(f,t+"/"+o,n)})},list:o=>{H.readdir(t,(r,n)=>{n.forEach(o),o()})}};if(e.indexedDB){let o,r=indexedDB.open(t,1);return r.onupgradeneeded=n=>{n.target.result.createObjectStore(t)},r.onerror=n=>{console.log(n)},r.onsuccess=()=>{if(o=r.result,o){let l=o.transaction([t],"readonly").objectStore(t).getKey("!");l.onerror=()=>{console.log(`error getting key ${t}/!`)},l.onsuccess=()=>{if(!l.result){let s=o.transaction([t],"readwrite").objectStore(t).put(ue,"!");s.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(n,l)=>{if(o){let s=o.transaction([t],"readonly").objectStore(t).get(n);s.onerror=()=>{console.log(`error getting ${t}/${n}`)},s.onsuccess=()=>{l(null,s.result)}}else l("error indexedDB not available")},put:(n,l,f)=>{if(o){let i=o.transaction([t],"readwrite").objectStore(t).put(l,n);i.onerror=()=>{console.log(`error putting data on ${t}/${n}`)},i.onsuccess=()=>{f(null)}}else f("error indexedDB not available")},list:n=>{if(o){let f=o.transaction([t],"readonly").objectStore(t).getAllKeys();f.onerror=()=>console.log("error getting keys for",t),f.onsuccess=()=>{f.result.forEach(n),n()}}else console.log("error indexedDB not available"),n()}}}return{get:(o,r)=>{r(null,ue)},put:(o,r,n)=>{n(null)},list:o=>{o("!"),o()}}},Ee=e=>{A.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Oe(e));let t=ge(e);return{get:(o,r)=>{if(!o){r("lex required");return}var n=o["#"],l=typeof o["."]=="string"?o["."]:"",f;let s=(i,p)=>{L(o["."],p)&&(f||(f={_:{"#":n,">":{}}}),f[p]=i[0],f._[">"][p]=i[1])};t(n+de+l,(i,p)=>{let d;A.is(p)?(P.map(p,s),f||s(p,l),d={[n]:f}):p&&(s(p,l),d={[n]:f}),r(i,d)})},put:(o,r)=>{if(!o){r("graph required");return}var n=0;let l=f=>{if(n--,!l.err){if(l.err=f,l.err){r(l.err);return}n===0&&r(null)}};Object.keys(o).forEach(f=>{var s=o[f];Object.keys(s).forEach(i=>{if(i==="_")return;n++;let p=s[i],d=s._[">"][i];t(f+de+i,[p,d],l)})})}}},ye=Ee;var me=typeof document>"u",we=me?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=we?.WebSocket);var Ce=e=>{let t=le(e.maxAge),o=ye(e),r={},n={},l={},f=async(u,c,g)=>{for(let a of Object.keys(u)){let h=await new Promise(S=>{p({"#":a},S,c)});if(h.err)return g&&g(h.err),!1;let v=u[a],b=v._?v._.p:void 0,w=W;if(!(!h.put||!h.put[a]||h.put[a][w]===b))return g&&g(`error in wire check public key does not match for soul: ${a}`),!1}return!0},s=(u,c)=>{let g=ne(u.get,r);g?c(JSON.stringify({"#":t.track(O.random(9)),"@":u["#"],put:g})):o.get(u.get,(a,h)=>{c(JSON.stringify({"#":t.track(O.random(9)),"@":u["#"],put:h,err:a}))})},i=async(u,c)=>{let g=await se.mix(u.put,r,e.secure,l);if(Object.keys(g.now).length){if(!await f(g.now,c))return;o.put(g.now,a=>{c(JSON.stringify({"#":t.track(O.random(9)),"@":u["#"],err:a}))})}Object.keys(g.defer).length&&setTimeout(()=>i({put:g.defer},c),g.wait)},p=(u,c,g,a)=>{if(!c)return;A.is(a)||(a={});let h=ne(u,r);if(h){c({put:h});return}o.get(u,(v,b)=>{if(b){c({put:b,err:v});return}v&&console.log(v);let w=O.random(9);n[w]=c,g(JSON.stringify({"#":t.track(w),get:u})),setTimeout(()=>{let S=n[w];if(S){let x=u["#"],k={[x]:null};typeof u["."]=="string"&&(k[x]={[u["."]]:null}),S({put:k}),delete n[w]}},a.wait||100)})},d=u=>({get:(c,g,a)=>{p(c,g,u,a)},put:async(c,g)=>{let a=await se.mix(c,r,e.secure,l);Object.keys(a.now).length===0||!await f(a.now,u,g)||(o.put(a.now,g),u(JSON.stringify({"#":t.track(O.random(9)),put:c})))},on:(c,g)=>{let a=c&&c["#"];!a||!g||(l[a]?l[a].push({".":c["."],cb:g}):l[a]=[{".":c["."],cb:g}])},off:(c,g)=>{let a=c&&c["#"];if(!(!a||!l[a]))if(g){let h=l[a].find(v=>v.cb===g);h&&l[a].splice(l[a].indexOf(h),1)}else delete l[a]}});if(me){let u=e.wss,c=()=>u.clients();if(!u){let a=e.server?{server:e.server}:{port:e.port||8765};u=new we.WebSocketServer(a),c=()=>u.clients}let g=(a,h)=>{c().forEach(v=>{v.readyState===WebSocket.OPEN&&v.send(a,{binary:h})})};return u.on("connection",a=>{a.on("error",console.error),a.on("message",(h,v)=>{let b=JSON.parse(h);if(t.check(b["#"]))return;t.track(b["#"]),b.get&&s(b,g),b.put&&i(b,g),g(h,v);let w=b["@"],S=n[w];S&&(delete b["#"],delete b["@"],S(b),delete n[w])})}),d(g)}let y=[],m=u=>{y.forEach(c=>{c&&c.readyState===WebSocket.OPEN?c.send(u):console.log("websocket not available")})};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(u=>{let c=new WebSocket(u);y.push(c);let g=()=>{c||(c=new WebSocket(u)),c.onclose=a=>{y.indexOf(c)!==-1&&y.splice(y.indexOf(c),1),c=null,setTimeout(g,Math.floor(Math.random()*5e3))},c.onerror=a=>{console.error(a)},c.onmessage=a=>{let h=JSON.parse(a.data);if(t.check(h["#"]))return;t.track(h["#"]),h.get&&s(h,m),h.put&&i(h,m),m(a.data);let v=h["@"],b=n[v];b&&(delete h["#"],delete h["@"],b(h),delete n[v])}};g()}),d(m)},re=Ce;var Te=(e,t)=>{t||(t=re(e));let o=[],r=!1,n=!1,l=0,f=(i,p,d,y)=>{let m=a=>{l++,f(a,p,d,y)},u=a=>{o=[],l=0,n=!1,y(a)},c=()=>{if(o.length===0){u("Wrong username or password");return}let a=o.shift();t.get({"#":a},async h=>{if(h.err){u(`error getting ${a}: ${h.err}`);return}let v=h.put&&h.put[a];if(!v||!v.auth)return c();let b=JSON.parse(v.auth),w=await K.work(p,b.salt),S=await K.decrypt(b.enc,w);if(!S)return c();if(s.is={username:i,pub:v.pub,epub:v.epub,priv:S.priv,epriv:S.epriv},s.ctx="~"+v.pub,d!==""){let x=O.random(64),k=await K.work(d,x),j=await K.encrypt(S,k),C={auth:JSON.stringify({enc:j,salt:x})},$=await K.sign(C,s.is),D=M(a,$.m,$.s,v.pub);t.put(D,B=>{u(B?`error putting ${C} on ${a}: ${B}`:null)});return}return u(null)})};if(l>9){u("Wrong username or password");return}let g="~@"+i;t.get({"#":g},async a=>{if(a.err){u(`error getting ${g}: ${a.err}`);return}let h=a.put&&a.put[g];if(!h)return m(i);delete a.put[g]._,o=Object.keys(h),c()})},s={create:(i,p,d)=>{let y=u=>{d?d(u):console.log(u)};if(r){y("User is already being created");return}if(i===""){y("Please provide a username");return}if(p===""){y("Please provide a password");return}r=!0;let m="~@"+i;t.get({"#":m},async u=>{if(u.err){r=!1,y(`error getting ${m}: ${u.err}`);return}if(u.put&&u.put[m]){r=!1,y("Username already exists");return}let c=O.random(64),g=await K.work(p,c),a=await K.pair(),h={priv:a.priv,epriv:a.epriv},v=await K.encrypt(h,g),b={username:i,pub:a.pub,epub:a.epub,auth:JSON.stringify({enc:v,salt:c})},w="~"+a.pub,S=await K.sign(b,a),x=M(w,S.m,S.s,a.pub);t.put(x,k=>{if(r=!1,k){y(`error putting ${b} on ${w}: ${k}`);return}let j={[w]:{"#":w}};t.put(M(m,j),C=>{if(C){y(`error putting ${j} on ${m}: ${C}`);return}d&&d(null)})})})},auth:(i,p,d)=>{let y=m=>{d?d(m):m&&console.log(m)};if(n){y("User is already authenticating");return}if(s.is=null,i===""){y("Please provide a username");return}if(p===""){y("Please provide a password");return}n=!0,f(i,p,"",y)},change:(i,p,d,y)=>{let m=u=>{y?y(u):u&&console.log(u)};if(n){m("User is already authenticating");return}if(s.is=null,i===""){m("Please provide a username");return}if(p===""){m("Please provide a password");return}if(d===""){m("Please provide a new password");return}n=!0,f(i,p,d,m)},store:i=>{if(!s.is){console.log("Please authenticate before calling store");return}if(i){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(s.is));return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(s.is))},recall:i=>{if(i){if(typeof globalThis.localStorage<"u"){let p=globalThis.localStorage.getItem("user.is");p?(s.is=JSON.parse(p),s.ctx="~"+s.is.pub):console.log("User credentials not stored in local storage")}return}if(typeof globalThis.sessionStorage<"u"){let p=globalThis.sessionStorage.getItem("user.is");p?(s.is=JSON.parse(p),s.ctx="~"+s.is.pub):console.log("User credentials not stored in session storage")}},leave:()=>{s.is=null,s.ctx=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(i,p,d)=>{let y=m=>{d?d(m):console.log(m)};if(n){y("User is already authenticating");return}if(i===""){y("Please provide a username");return}if(p===""){y("Please provide a password");return}n=!0,f(i,p,"",async m=>{if(m){y(m);return}let u={username:null,pub:null,epub:null,auth:null},c=await K.sign(u,s.is),g="~"+s.is.pub,a=M(g,c.m,c.s,s.is.pub);t.put(a,h=>{if(h){y(`error putting null on ${g}: ${h}`);return}s.is=null,s.ctx=null,d&&d(null)})})}};return s},be=Te;var Ke=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:A.is(e)||(e={});let t=re(e),o=be(null,t),r=new Map,n=new Map,l=i=>i===null||i===!0||i===!1||typeof i=="string"||T.is(i)||X.is(i),f=i=>{if(l(i))return!0;if(A.is(i)){let p=[];for(let[d,y]of Object.entries(i)){if(d==="_")return"error underscore cannot be used as an item name";if(A.is(y)||l(y)){p.push(d);continue}return`error {${d}:${y}} cannot be converted to graph`}if(p.length!==0)return p}return`error ${i} cannot be converted to a graph`},s=i=>{let p=(u,c,g)=>{t.get(A.put(u,"#",c),async a=>{if(a.err&&console.log(a.err),a.put&&a.put[c]){delete a.put[c]._,delete a.put[c][W];for(let h of Object.keys(a.put[c])){let v=T.is(a.put[c][h]);if(v){let b=await new Promise(w=>{let S=O.random();n.set(S,{chain:[{item:null,soul:v}]}),s(S).next(null,w)});a.put[c][h]=b}}g(a.put[c])}else g(null)})},d=async(u,c,g)=>{if(g||(g=console.log),!o.is)return e.secure?(g(`error putting data on ${u}: user required in secure mode`),null):M(u,c);if(!o.is)return g(`error putting data on ${u}: user not authenticated`),null;let a=await K.sign(c,o.is);return M(u,a.m,a.s,o.is.pub)},y=u=>{let c=n.get(i);c&&typeof c.cb<"u"?c.cb(u):u&&console.log(u),c&&!c.on&&n.delete(i)},m=(u,c)=>{let g=u&&typeof u.get<"u",a=u&&typeof u.put<"u",h=u&&typeof u.on<"u",v=u&&typeof u.off<"u",b=!1,w=n.get(i);for(var S=1;S<w.chain.length;S++)if(w.chain[S].soul===null){b=!0;break}if(b){let{item:x,soul:k}=w.chain[S-1];return t.get({"#":k,".":x},async j=>{if(j.err){console.log(`error getting ${x} on ${k}: ${j.err}`),c&&c(null);return}let C=j.put&&j.put[k];if(C&&typeof C[x]<"u"){let $=T.is(C[x]);if($)w.chain[S].soul=$,n.set(i,{chain:w.chain,cb:w.cb}),g?s(i).next(null,u.get,c):a?s(i).put(u.put,c):h?s(i).on(u.on,c):v&&s(i).off(c);else if(g)c(C[x]);else if(a){$=O.random();let D={[x]:T.ify($)},B=await d(k,D,c);if(B===null)return;t.put(B,U=>{if(U){c(`error putting ${x} on ${k}: ${U}`);return}w.chain[S].soul=$,s(i).put(u.put,c)})}else h?(console.log(`error resolving on for ${x} on ${k}`),c(null)):v&&(console.log(`error resolving off for ${x} on ${k}`),c&&c(null))}else a?c(`error ${x} not found on ${k}`):(console.log(`error ${x} not found on ${k}`),c&&c(null))}),!1}return g&&w.chain[w.chain.length-1].item!==null?(w.chain.push({item:null,soul:null}),s(i).next(null,u.get,c),!1):w.chain[w.chain.length-1]};return{get:(u,c,g)=>{if(typeof c=="function"&&(g=c,c=null),u===null||u===""||u==="_"){g&&g(null);return}if(c&&!g){console.log("lex requires a callback function");return}let a=o.ctx?o.ctx:"root";if(i=O.random(),n.set(i,{chain:[{item:u,soul:a}],cb:g}),!g)return s(i);let{soul:h}=m({get:c},y);h&&p(c,h,y)},next:(u,c,g)=>{let a=b=>{g?g(b):y(b)};if(typeof c=="function"&&(g=c,c=null),!i){console.log("please provide a key using get(key)"),a(null);return}if(u===""||u==="_"){a(null);return}if(c&&!g){console.log("lex requires a callback function");return}let h=n.get(i);if(!h)return;if(g&&typeof h.cb>"u"&&(h.cb=g,g=null),u!==null&&h.chain.push({item:u,soul:null}),!h.cb)return s(i);let{soul:v}=m({get:c},a);v&&p(c,v,a)},put:(u,c,g)=>{typeof c=="function"&&(g=c,c=!1);let a=S=>{g?g(S):y(S)};if(!i){a("please provide a key using get(key)");return}let h=n.get(i);if(!h)return;if(!h.cb){if(!g)return;h.cb=g,g=null}c&&(u={[O.random()]:u});let v=f(u);if(typeof v=="string"){a(v);return}let{item:b,soul:w}=m({put:u},a);if(w){if(v===!0){t.get({"#":w,".":b},async S=>{if(S.err){console.log(`error getting ${w}: ${S.err}`);return}let x=S.put&&S.put[w]&&S.put[w][b],k=T.is(x);if(!k){let j=await d(w,{[b]:u},a);if(j===null)return;t.put(j,a);return}t.get({"#":k},async j=>{if(j.err){console.log(`error getting ${k}: ${j.err}`);return}if(!j.put||!j.put[k]){console.log(`error ${k} not found`);return}delete j.put[k]._;for(let $ of Object.keys(j.put[k])){if($===W)continue;let D=await new Promise(B=>{let U=O.random();n.set(U,{chain:[{item:$,soul:k}]}),s(U).put(null,B)});if(D){a(D);return}}let C=await d(w,{[b]:u},a);C!==null&&t.put(C,a)})});return}t.get({"#":w,".":b},async S=>{if(S.err){a(`error getting ${w}.${b}: ${S.err}`);return}let x=S.put&&S.put[w]&&S.put[w][b],k=T.is(x);if(!k){let $={[b]:T.ify(O.random())},D=await d(w,$,a);if(D===null)return;t.put(D,B=>{if(B)a(`error putting ${b} on ${w}: ${B}`);else{let U=O.random(),ve=[{item:b,soul:w}];n.set(U,{chain:ve,cb:h.cb}),s(U).put(u)}});return}let j=!1,C={};for(let $ of v){let D=await new Promise(B=>{if(A.is(u[$])){let U=O.random();n.set(U,{chain:[{item:$,soul:k}]}),s(U).put(u[$],B)}else j=!0,C[$]=u[$],B(null)});if(D){a(D);return}}if(j){let $=await d(k,C,a);if($===null)return;t.put($,a)}else a(null)})}},on:(u,c)=>{if(typeof u=="function"&&(c=u,u=null),!c)return;if(!i){console.log("please provide a key using get(key)"),c(null);return}let{item:g,soul:a}=m({on:u},c);a&&(n.set(i,{chain:[{item:g,soul:a}],on:!0}),r.set(c,()=>s(i).next(null,c)),t.get({"#":a,".":g},h=>{if(h.err){console.log(`error getting ${a}.${g}: ${h.err}`);return}let v=h.put&&h.put[a]&&h.put[a][g],b=T.is(v);b?u?u=A.put(u,"#",b):u={"#":b,".":null}:u?u=A.put(u,"#",a):u={"#":a,".":g},t.on(u,r.get(c))}))},off:u=>{if(!i){console.log("please provide a key using get(key)"),u&&u(null);return}let{item:c,soul:g}=m({off:!0},u);g&&t.get({"#":g,".":c},a=>{if(a.err){console.log(`error getting ${g}.${c}: ${a.err}`);return}let h=a.put&&a.put[g]&&a.put[g][c],v=T.is(h);v?t.off({"#":v},r.get(u)):t.off({"#":g},r.get(u)),r.delete(u),n.delete(i)})},user:u=>(u&&(o.ctx="~"+u),Object.assign(o,s())),wire:t,SEA:K}};return s()},ut=Ke;export{ut as default};
//# sourceMappingURL=holster.js.map
