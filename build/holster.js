var fe={is:e=>{if(e instanceof Array)return!1;if(typeof e=="number")return!isNaN(e);if(typeof e=="string"){let t=parseFloat(e);return!isNaN(t)&&isFinite(t)}return!1}},L={is:e=>{if(!e||typeof e!="object")return!1;let r=Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/);return e.constructor===Object||r&&r[1]==="Object"},map:(e,t,r)=>{var n=Object.keys(e);for(let o=0;o<n.length;o++){let i=t(e[n[o]],n[o],r);if(typeof i<"u")return i}},put:(e,t,r)=>(e||(e={}),e[t]=r,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Be=(e,t,r)=>{if(r.id){r.id=!1;return}if(t==="#"&&typeof e=="string"){r.id=e;return}r.id=!1},U={is:e=>{if(e&&e["#"]&&!e._&&L.is(e)){let t={};if(L.map(e,Be,t),t.id)return t.id}return!1},ify:e=>L.put({},"#",e)},W="_holster_user_signature",F="_holster_user_public_key",X=(e,t,r,n)=>{let o=Date.now(),i={[e]:{_:{"#":e,">":{}}}};for(let[m,d]of Object.entries(t))m!=="_"&&m!==F&&m!==W&&(i[e][m]=d,i[e]._[">"][m]=o);if(r&&n){i[e]._.s={};for(let[m,d]of Object.entries(r))i[e]._.s[m]=d;i[e][F]=n,i[e]._[">"][F]=o}return i},V=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!L.is(e)||!t)return!1;let r=e["*"];if(r)return t.slice(0,r.length)===r;let n=e[">"],o=e["<"];return n&&o?t>=n&&t<=o:n?t>=n:o?t<=o:!1},R={random:e=>{var t="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let n=0;n<e;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}};var Fe=e=>{e||(e=9e3);let t={store:{}};return t.check=r=>t.store[r]?t.track(r):!1,t.track=r=>(t.store[r]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{if(t.expiry)return;let n=Date.now();Object.keys(t.store).forEach(o=>{n-t.store[o]>e&&delete t.store[o]}),t.expiry=null},e)),r),t},xe=Fe;var He=(e,t)=>{if(!e||typeof e!="object")throw new TypeError("lex must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");let r=e["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!t[r])return;let n={_:{"#":r,">":{}}},o={};if(typeof e["."]=="string"){let i=e["."];if(typeof t[r][i]>"u")return;n[i]=t[r][i],n._[">"][i]=t[r]._[">"][i],t[r]._.s&&t[r]._.s[i]&&(o[i]=t[r]._.s[i])}else for(let i of Object.keys(t[r]))V(e["."],i)&&(n[i]=t[r][i],n._[">"][i]=t[r]._[">"][i],t[r]._.s&&t[r]._.s[i]&&(o[i]=t[r]._.s[i]));return Object.keys(o).length>0&&(n._.s=o),{[r]:n}},me=He;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function ce(){}Object.assign(ce,{from:Array.from});ce.prototype=Object.create(Array.prototype);ce.prototype.toString=function(e,t,r){if(e||(e="utf8"),t||(t=0),r=r?Math.min(Math.max(r,t),this.length):this.length,e==="hex"){let n=new Uint8Array(this.slice(t,r));return Array.from(n,o=>o.toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:r-t},(n,o)=>{let i=this[o+t];return i<0||i>1114111?"\uFFFD":String.fromCharCode(i)}).join("");if(e==="base64"){let n=Array.from({length:r-t},(o,i)=>{let m=this[i+t];return m<0||m>255?"\uFFFD":String.fromCharCode(m)}).join("");return btoa(n)}};var Q=ce;var ge={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function Y(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),Y.from(...e)}Y.prototype=Object.create(Array.prototype);var le=(e,t)=>{if(typeof e!="string")throw new TypeError("Input must be a string for encoding: "+t);if(e.length>ge.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${e.length} > ${ge.MAX_STRING_LENGTH}`)},z=(e,t="buffer operation")=>{if(e>ge.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${t}: ${e} > ${ge.MAX_BUFFER_SIZE}`)},Ke=e=>{le(e,"hex");let t=e.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(t))throw new TypeError("Invalid hex string: contains non-hex characters");if(t.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(t.length===0)return new Uint8Array(0);z(t.length/2,"hex parsing");let r=new Uint8Array(t.length/2);for(let n=0;n<t.length;n+=2){let o=t.substr(n,2);r[n/2]=parseInt(o,16)}return r},_e=e=>{le(e,"utf8");try{let r=new TextEncoder().encode(e);return z(r.length,"UTF-8 encoding"),r}catch(t){throw new TypeError("Failed to encode UTF-8 string: "+t.message)}},Je=e=>{le(e,"binary"),z(e.length,"binary encoding");let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);t[r]=n}return t},qe=e=>{le(e,"base64");let t=e.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(t))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(t);z(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let o=0;o<r.length;o++)n[o]=r.charCodeAt(o);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},$e=e=>{let t;if(e instanceof ArrayBuffer)z(e.byteLength,"ArrayBuffer processing"),t=new Uint8Array(e);else if(ArrayBuffer.isView(e))z(e.byteLength||e.length,"TypedArray processing"),t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);else if(Array.isArray(e)){z(e.length,"Array processing");for(let r=0;r<e.length;r++){let n=e[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}t=new Uint8Array(e)}else if(typeof e=="object"&&e!==null&&typeof e.length=="number"){z(e.length,"array-like processing");let r=Array.from(e);for(let n=0;n<r.length;n++){let o=r[n];if(typeof o!="number"||o<0||o>255||!Number.isInteger(o))throw new TypeError(`Invalid byte value at index ${n}: ${o} (must be integer 0-255)`)}t=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof e);return t};Object.assign(Y,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let t=arguments[0];if(t==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof t=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=Ke(t);break;case"utf8":case"utf-8":r=_e(t);break;case"binary":case"latin1":r=Je(t);break;case"base64":r=qe(t);break;case"ascii":le(t,"ascii");for(let o=0;o<t.length;o++)if(t.charCodeAt(o)>127)throw new TypeError(`Invalid ASCII character at position ${o}: ${t.charCodeAt(o)} > 127`);r=_e(t);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=$e(t);if(!r||r.length===0)return Q.from(new Uint8Array(0));try{return Q.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(e,t=0){if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Length must be a non-negative integer");if(z(e,"buffer allocation"),typeof t=="number"){if(t<0||t>255||!Number.isInteger(t))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof t=="string"){if(t.length!==1)throw new TypeError("Fill string must be exactly one character");if(t=t.charCodeAt(0),t>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(e);return t!==0&&r.fill(t),Q.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be an array");if(e.length===0)return Q.from(new Uint8Array(0));let t=0,r=[];for(let n=0;n<e.length;n++){let o=e[n];if(!o)throw new TypeError(`Array element at index ${n} is null or undefined`);let i;try{i=$e(o)}catch(m){throw new TypeError(`Invalid array element at index ${n}: ${m.message}`)}t+=i.length,z(t,"buffer concatenation"),r.push(i)}try{let n=new Uint8Array(t),o=0;for(let i of r)n.set(i,o),o+=i.length;return Q.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(e){return e instanceof Q||e&&typeof e=="object"&&e.constructor===Y},byteLength(e,t="utf8"){if(typeof e!="string")throw new TypeError("First argument must be a string");switch(t.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(e).length;case"ascii":case"binary":case"latin1":return e.length;case"base64":let r=e.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(e.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+t)}}});Y.prototype.from=Y.from;Y.prototype.toString=function(e="utf8",t=0,r=this.length){if(typeof e!="string")throw new TypeError("Encoding must be a string");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<t)throw new TypeError("End must be an integer >= start");try{return Q.prototype.toString.call(this,e,t,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var J=Y;var We=typeof document>"u",je=We?(await import("node:crypto")).webcrypto:globalThis.crypto,P=je.subtle,pe=e=>typeof e=="string"?e:JSON.stringify(e),ie=e=>{try{return JSON.parse(e)}catch{return e}},de=e=>{let t=new Uint8Array(J.alloc(e));return J.from(je.getRandomValues(t))},te=(e,t)=>{let[r,n]=e.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},se=async e=>{let t=await P.digest({name:"SHA-256"},new TextEncoder().encode(pe(e)));return J.from(t)},we=async(e,t)=>{let r=e+t.toString("utf8"),n=J.from(await se(r),"binary"),o=Ge(n);return await P.importKey("jwk",o,{name:"AES-GCM"},!1,["encrypt","decrypt"])},Ge=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var Xe={pair:async e=>{let t=await P.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async o=>{let i=await P.exportKey("jwk",o.publicKey);return{priv:(await P.exportKey("jwk",o.privateKey)).d,pub:i.x+"."+i.y}}),r=await P.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async o=>{let i=await P.exportKey("jwk",o.publicKey);return{epriv:(await P.exportKey("jwk",o.privateKey)).d,epub:i.x+"."+i.y}}),n={pub:t.pub,priv:t.priv,epub:r.epub,epriv:r.epriv};return e&&e(n),n},encrypt:async(e,t,r)=>{if(!t||!t.epriv)return r&&r(null),null;let n={s:de(9),iv:de(15)},o=await we(t.epriv,n.s).then(m=>P.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},m,new TextEncoder().encode(pe(e)))),i={ct:J.from(o,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(i),i},decrypt:async(e,t,r)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return r&&r(null),null;let n={ct:J.from(e.ct,"base64"),iv:J.from(e.iv,"base64"),s:J.from(e.s,"base64")};try{let o=await we(t.epriv,n.s).then(m=>P.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},m,new Uint8Array(n.ct))),i=ie(new TextDecoder("utf8").decode(o));return r&&r(i),i}catch{return r&&r(null),null}},verify:async(e,t,r)=>{if(!t||!t.pub)return r&&r(null),null;let n=ie(e),o=await P.importKey("jwk",te(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),i={};if(typeof n.m=="string")i=n.m;else for(let h of Object.keys(n.m).sort())h!=="_"&&h!==F&&h!==W&&(i[h]=n.m[h]);let m=await se(i),d=new Uint8Array(J.from(n.s,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}};if(await P.verify(a,o,d,new Uint8Array(m))){let h=ie(n.m);return r&&r(h),h}return r&&r(null),null},verifyProperties:async(e,t,r)=>{if(!t||!e)return r&&r([]),[];let n=await P.importKey("jwk",te(t),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),o={name:"ECDSA",hash:{name:"SHA-256"}},i=[],m=e._&&e._.s||{};for(let d of Object.keys(e).sort()){if(d==="_"||d==F)continue;let a=m[d];if(!a){console.log(`warning: property '${d}' missing signature`);continue}try{let h=await se(e[d]),f=new Uint8Array(J.from(a,"base64"));await P.verify(o,n,f,new Uint8Array(h))?i.push(d):console.log(`warning: property '${d}' signature verification failed`)}catch(h){console.log(`warning: property '${d}' error verifying: ${h.message}`)}}return r&&r(i),i},sign:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n={};if(typeof e=="string")n=e;else{let h=ie(e);for(let f of Object.keys(h).sort())f!=="_"&&f!==F&&f!==W&&(n[f]=h[f])}let o=await se(n),i=te(t.pub,t.priv),m={name:"ECDSA",namedCurve:"P-256"},d=await P.importKey("jwk",i,m,!1,["sign"]).then(h=>P.sign({name:"ECDSA",hash:{name:"SHA-256"}},h,new Uint8Array(o))),a={m:n,s:J.from(d,"binary").toString("base64")};return r&&r(a),a},signProperties:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n=ie(e),o={},i=te(t.pub,t.priv),m={name:"ECDSA",namedCurve:"P-256"},d=await P.importKey("jwk",i,m,!1,["sign"]);for(let a of Object.keys(n).sort())if(a!=="_"&&a!=F&&a!=W){let h=await se(n[a]),f=await P.sign({name:"ECDSA",hash:{name:"SHA-256"}},d,new Uint8Array(h));o[a]=J.from(f,"binary").toString("base64")}return r&&r(o),o},work:async(e,t,r)=>{typeof t=="function"&&(r=t,t=void 0),typeof t>"u"&&(t=de(9));let n=await P.importKey("raw",new TextEncoder().encode(pe(e)),{name:"PBKDF2"},!1,["deriveBits"]),o={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},i=await P.deriveBits(o,n,512),m={epriv:J.from(i,"binary").toString("base64")};return r&&r(m),m},secret:async(e,t,r)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},o=te(e.epub),i=await P.importKey("jwk",o,n,!0,[]),m=te(t.epub,t.epriv,!1);delete m.key_ops;let d=await P.importKey("jwk",m,n,!1,["deriveBits"]).then(async a=>{let h=await P.deriveBits({public:i,name:"ECDH",namedCurve:"P-256"},a,256),f=await P.importKey("raw",new Uint8Array(h),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return P.exportKey("jwk",f).then(({k:y})=>y)});return r&&r({epriv:d}),{epriv:d}}},K=Xe;var Ae=100,Ce=1e4,be=(e,t,r,n)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});be.mix=async(e,t,r,n)=>{if(!e||typeof e!="object")throw new TypeError("change must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let o=Date.now(),i={},m={},d=new Map,a=0;for(let f of Object.keys(e)){let y=e[f],E=!1,s=!1,l=0,g=r;if(!y||!y._)continue;let c=y[F];if(y._.s&&c&&(g=!0),f.length>1&&f[0]==="~")if(f[1]==="@")s=!0,g=!1;else{if(c&&f!="~"+c){console.log(`error public key does not match for soul: ${f}`);continue}g=!0}if(g){if(!c||!y._)continue;let u=await K.verifyProperties(y,c);if(u.length===0)continue;d.set(f,new Set(u))}for(let u of Object.keys(y)){if(u==="_"||u===W||u===F||d.has(f)&&!d.get(f).has(u))continue;let p=y[u],T=y._&&y._[">"]?y._[">"][u]:0,w=(t[f]||{})[u],S=(t[f]||{_:{">":{}}})._[">"][u]||0;if(s&&u!==U.is(p)){console.log(`error alias ${s}: ${u} !== ${U.is(p)}`);continue}let _=T-o;if(_>0){if(_>864e5)continue;(a===0||_<a)&&(a=l=_),m[f]||(m[f]={_:{"#":f,">":{},s:{}}}),m[f][u]=p,m[f]._[">"][u]=T,y._.s&&y._.s[u]&&(m[f]._.s[u]=y._.s[u])}else be(T,S,p,w).incoming&&(i[f]||(i[f]={_:{"#":f,">":{},s:{}}}),t[f]||(t[f]={_:{"#":f,">":{},s:{}}}),t[f][u]=i[f][u]=p,t[f]._[">"][u]=i[f]._[">"][u]=T,y._.s&&y._.s[u]&&(t[f]._.s[u]=i[f]._.s[u]=y._.s[u]),n[f]&&setTimeout(()=>{n[f]&&n[f].filter(O=>V(O["."],u)).forEach(O=>O.cb())},Ae),E=!0)}g&&l!==0&&i[f]&&(Object.assign(m[f],i[f]),delete i[f]),E&&n[f]&&setTimeout(()=>{n[f]&&n[f].filter(u=>V(u["."])).forEach(u=>u.cb())},Ae)}let h=Object.keys(t);return h.length>Ce&&h.map(E=>{let s=t[E]._&&t[E]._[">"],l=s?Math.max(...Object.values(s)):0;return{soul:E,maxState:l}}).sort((E,s)=>E.maxState-s.maxState).slice(0,h.length-Ce).forEach(({soul:E})=>delete t[E]),{now:i,defer:m,wait:a}};var Se=be;var G="",ue="",Oe=()=>{let e=(t,r,n)=>{if(n||(e[G]||(e[G]={}),n=e[G]),!t)return n;let o=0,i={},m=t[o],d=t.length-1,a=typeof r>"u",h=n[m];for(;!h&&o<d;)m+=t[++o],h=n[m];if(h)if(o===d){if(a)return typeof h[ue]>"u"?h[G]:h[ue];h[ue]=r}else return!h[G]&&!a&&(h[G]={}),e(t.slice(++o),r,h[G]);else if(L.map(n,(y,E)=>{let s=0,l="";for(;E[s]===t[s];)l+=E[s++];if(l){if(a)return s<=d?void 0:(i[E.slice(s)]=y,y);let g={[E.slice(s)]:y,[t.slice(s)]:{[ue]:r}};return n[l]={[G]:g},delete n[E],!0}})){if(a)return i}else{if(a)return;n[m]||(n[m]={}),n[m][ue]=r}};return e};Oe.map=function e(t,r,n,o){o||(o=[]);var i=t[G]||t,m=Object.keys(i).sort(),d;for(let a=0;a<m.length;a++){let h=m[a],f=i[h],y=f[ue];if(typeof y<"u"){if(y=r(y,o.join("")+h,h,o),typeof y<"u")return y}else n&&r(d,o.join(""),h,o);if(f[G]){if(o.push(h),y=e(f[G],r,n,o),typeof y<"u")return y;o.pop()}}};var q=Oe;var ve="",Ie="",H="",re=e=>{var t;let r=new Map,n=null,o=0,i=1e4,m=new Map,d=0,a=3e4,h=.8,f=.9;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=100),e.write||(e.write=1),e.size||(e.size=1024*1024),e.memoryLimit||(e.memoryLimit=500),typeof e.cache>"u"&&(e.cache=!0),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let y=(l,g,c,u)=>{let p=Date.now()-g;p>2e3&&console.log(`[RADISK-SLOW] ${l}: ${p}ms for ${c}${u?` (${u} bytes)`:""}`)},E=()=>{if(typeof process>"u"||!process.memoryUsage)return;let l=Date.now();if(l-d<a)return;d=l;let g=process.memoryUsage(),c=g.heapUsed,u=g.heapTotal,p=e.memoryLimit*1024*1024,T=c/p;if(T>f){let w=r.size;console.log(`[RADISK-MEMORY] High memory usage: ${Math.round(T*100)}% of heap limit. Clearing ${w} cached files.`),r.clear(),global.gc&&global.gc(),d=l+a}else T>h&&console.log(`[RADISK-MEMORY] Memory warning: ${Math.round(T*100)}% of heap limit used. Cache size: ${r.size} files.`)},s=(l,g,c)=>{if(l=""+l,typeof g=="function"){if(c=g,g=s.batch(l),typeof g<"u"||s.thrash.at&&(g=s.thrash.at(l),typeof g<"u"))return c(t,g);if(m.has(l)){m.get(l).push(c);return}m.set(l,[c]);let u=Date.now();return s.read(l,(p,T)=>{y("read",u,l);let w=m.get(l)||[];m.delete(l),w.forEach(S=>S(p,T))})}if(s.batch(l,g),E(),c&&s.batch.acks.push(c),++s.batch.ed>=e.batch)return s.thrash();clearTimeout(s.batch.timeout),s.batch.timeout=setTimeout(s.thrash,e.write)};return s.batch=q(),s.batch.acks=[],s.batch.ed=0,s.thrash=()=>{if(s.thrash.ing)return s.thrash.more=!0;let l=Date.now();clearTimeout(s.batch.timeout),s.thrash.more=!1,s.thrash.ing=!0;var g=s.thrash.at=s.batch;s.batch=null,s.batch=q(),s.batch.acks=[],s.batch.ed=0;let c=0;s.save(g,u=>{++c>1||(y("thrash",l,`batch-${g.ed}`),u&&e.log(u),g.acks.forEach(p=>p(u)),s.thrash.at=null,s.thrash.ing=!1,s.thrash.more&&s.thrash())})},s.save=(l,g)=>{let c={find:(u,p)=>{if(!(p<c.start))return c.start=p,e.store.list(c.lex),!0},lex:u=>{!u||u>c.start?(c.end=u,c.start&&c.mix(c.file||"!",c.start,c.end)):c.file=u},mix:(u,p,T)=>{if(c.start=c.end=c.file=t,r.has(u)){let w=r.get(u);q.map(l,(S,_)=>{if(!(_<p)){if(T&&T<_){c.start=_;return}w(_,S)}}),s.write(u,w,c.next)}else s.parse(u,(w,S)=>{if(w)return g(w);q.map(l,(_,$)=>{if(!($<p)){if(T&&T<$){c.start=$;return}S($,_)}}),s.write(u,S,c.next)})},next:u=>{if(u)return g(u);if(c.start)return q.map(l,c.find);g(u)}};q.map(l,c.find)},s.write=(l,g,c)=>{let u={text:"",limit:"",done:!1,count:0,each:(T,w,S,_)=>{if(u.done)return;u.count++,T=typeof T>"u"?"":"="+re.encode(T);let $=re.encode(_.length)+"#"+re.encode(S)+T+`
`;if(u.count>1&&_.length===0&&u.text.length+$.length>e.size){let O=S.indexOf(Ie);if(u.limit=O===-1?S:S.substring(0,O),u.limit!==l){u.done=!0,u.sub=q(),q.map(g,u.slice),s.write(u.limit,u.sub,c);return}}u.text+=$},slice:(T,w)=>{w<u.limit||u.sub(w,T)}};q.map(g,u.each,!0);let p=Date.now();e.store.put(l,u.text,T=>{y("file-write",p,l,u.text.length),c(T)})},s.read=(l,g)=>{let c=l.indexOf(Ie),u=c===-1?l:l.substring(0,c),p={lex:w=>{if(!w){if(!p.file){g("no file found",t);return}if(e.cache&&r.has(p.file)){let S=r.get(p.file);return p.value=S(l),g(t,p.value)}s.parse(p.file,p.it);return}w>u||w<p.file||(p.file=w)},it:(w,S)=>{w&&e.log(w),S&&(e.cache&&(r.set(p.file,S),E()),p.value=S(l)),g(w,p.value)}},T=Date.now();if(e.cache&&n&&T-o<i)n.forEach(w=>p.lex(w)),p.lex();else{let w=[],S=p.lex;p.lex=_=>(_&&w.push(_),S(_)),e.store.list(_=>{p.lex(_),!_&&e.cache&&(n=w,o=T)})}},s.parse=(l,g)=>{let c={disk:q(),read:(u,p)=>{if(u)return g(u);if(!p)return g(t,c.disk);let T=[],w="",S=c.split(p);for(;S;){let _,$,O=S[1];S=c.split(S[2])||"",S[0]==="#"&&(_=S[1],O<T.length&&(T.length=O),O<=T.length&&(T[O]=_,T.length=O+1),w=T.join("")),S=c.split(S[2])||"",S[0]!==`
`&&(S[0]==="="&&($=S[1]),typeof _<"u"&&typeof $<"u"&&c.disk(w,$),S=c.split(S[2]))}g(t,c.disk)},split:u=>{if(!u)return;let p=u.indexOf(H);if(p===-1)return;let T=u.slice(0,p),w={};return[T,re.decode(u.slice(p),w),u.slice(p+w.i)]}};e.store.get(l,c.read)},s};re.encode=e=>{let t="",r="";if(e instanceof Array&&(e.length===2||e.length===3)&&(t=ve+e[1],e.length===3&&e[2]&&(r=ve+e[2]),e=e[0]),typeof e=="string"){let o=0,i=null,m=H;for(;i=e[o++];)i===H&&(m+=H);return m+'"'+e+t+r+H}let n=U.is(e);if(n)return H+"#"+n+t+r+H;if(fe.is(e))return H+"+"+(e||0)+t+r+H;if(e===!0)return H+"+"+t+r+H;if(e===!1)return H+"-"+t+r+H;if(e===null)return H+" "+t+r+H};re.decode=(e,t)=>{var r=-1,n=0,o=null,i=null,m=-1,d=-1;if(e[0]!==H)return;for(;o=e[++r];)if(i){if(m===-1&&(m=r),o===H&&--n<=0){d=r;break}}else o===H?n++:i=o||!0;let a=m!==-1?e.slice(m,d!==-1?d:r):"";t&&(t.i=r+1);let h=a.split(ve),f=h[0],y=h[1],E=h[2];if(y)if(y=parseFloat(y),E){if(i==='"')return[f,y,E];if(i==="#")return[U.ify(f),y,E];if(i==="+")return f.length===0?[!0,y,E]:[parseFloat(f),y,E];if(i==="-")return[!1,y,E];if(i===" ")return[null,y,E]}else{if(i==='"')return[f,y];if(i==="#")return[U.ify(f),y];if(i==="+")return f.length===0?[!0,y]:[parseFloat(f),y];if(i==="-")return[!1,y];if(i===" ")return[null,y]}else{if(i==='"')return a;if(i==="#")return U.ify(a);if(i==="+")return a.length===0?!0:parseFloat(a);if(i==="-")return!1;if(i===" ")return null}};var Ne=re;var Pe=typeof document>"u",Z=Pe?await import("node:fs"):void 0,Me="",he="",ke=he+"+0"+he+"#"+he+'"root'+he,Qe=e=>{let t=e.file;if(Pe)return Z.existsSync(t)||Z.mkdirSync(t),Z.existsSync(t+"/!")||Z.writeFileSync(t+"/!",ke),{get:(r,n)=>{Z.readFile(t+"/"+r,(o,i)=>{if(o){if(o.code==="ENOENT"){n();return}console.log("fs.readFile error:",o)}i&&(i=i.toString()),n(o,i)})},put:(r,n,o)=>{var i=r+"."+R.random(9)+".tmp";Z.writeFile(i,n,m=>{if(m){console.log("fs.writeFile error:",m),o(m);return}Z.rename(i,t+"/"+r,o)})},list:r=>{Z.readdir(t,(n,o)=>{if(n){console.log("fs.readdir error:",n),r();return}o.forEach(r),r()})}};if(e.indexedDB){let r,n=indexedDB.open(t,1);return n.onupgradeneeded=o=>{o.target.result.createObjectStore(t)},n.onerror=o=>{console.log(o)},n.onsuccess=()=>{if(r=n.result,r){let i=r.transaction([t],"readonly").objectStore(t).getKey("!");i.onerror=()=>{console.log(`error getting key ${t}/!`)},i.onsuccess=()=>{if(!i.result){let d=r.transaction([t],"readwrite").objectStore(t).put(ke,"!");d.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(o,i)=>{let m=(h,f)=>{let E=r.transaction([t],"readonly").objectStore(t).get(h);E.onerror=()=>{console.log(`error getting ${t}/${h}`)},E.onsuccess=()=>{f(null,E.result)}};if(r){m(o,i);return}let d=0,a=setInterval(()=>{if(r){clearInterval(a),m(o,i);return}d++>5&&(clearInterval(a),i("error indexedDB not available"))},1e3)},put:(o,i,m)=>{let d=(f,y,E)=>{let l=r.transaction([t],"readwrite").objectStore(t).put(y,f);l.onerror=()=>{console.log(`error putting data on ${t}/${f}`)},l.onsuccess=()=>{E(null)}};if(r){d(o,i,m);return}let a=0,h=setInterval(()=>{if(r){clearInterval(h),d(o,i,m);return}a++>5&&(clearInterval(h),m("error indexedDB not available"))},1e3)},list:o=>{let i=a=>{let f=r.transaction([t],"readonly").objectStore(t).getAllKeys();f.onerror=()=>console.log("error getting keys for",t),f.onsuccess=()=>{f.result.forEach(a),a()}};if(r){i(o);return}let m=0,d=setInterval(()=>{if(r){clearInterval(d),i(o);return}m++>5&&(clearInterval(d),console.log("error indexedDB not available"),o())},1e3)}}}return{get:(r,n)=>{n(null,ke)},put:(r,n,o)=>{o(null)},list:r=>{r("!"),r()}}},Ye=e=>{L.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Qe(e));let t=Ne(e);return{get:(r,n)=>{if(!r||!L.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}var o=r["#"],i=typeof r["."]=="string"?r["."]:"",m,d={};let a=(h,f)=>{V(r["."],f)&&(m||(m={_:{"#":o,">":{}}}),m[f]=h[0],m._[">"][f]=h[1],h.length===3&&h[2]&&(d[f]=h[2]))};t(o+Me+i,(h,f)=>{let y;L.is(f)?(q.map(f,a),m||a(f,i),y={[o]:m}):f&&(a(f,i),y={[o]:m}),y&&y[o]&&Object.keys(d).length>0&&(y[o]._.s=d),n(h,y)})},put:(r,n)=>{if(!r){n("graph required");return}let o=0,i=!1,m=d=>{if(o--,!i){if(d){i=!0,n(d);return}o===0&&(i=!0,n(null))}};Object.keys(r).forEach(d=>{var a=r[d];Object.keys(a).forEach(h=>{if(h==="_")return;o++;let f=a[h],y=a._[">"][h],E=a._.s&&a._.s[h],s=E?[f,y,E]:[f,y];t(d+Me+h,s,m)})})}}},Re=Ye;var De=typeof document>"u",Ue=De?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Ue?.WebSocket);var Ze=e=>{let t=new Map,r=1500,n=6e4,o=10,i=null;return e||(i=setInterval(()=>{let d=Date.now();for(let[a,h]of t.entries())d-h.lastCleanup>n&&(h.requests=[],h.lastCleanup=d),h.requests=h.requests.filter(f=>d-f<n),d-h.lastCleanup>n*10&&(h.throttleCount=0)},n/4)),{getDelay:d=>{let a=Date.now(),h=t.get(d)||{requests:[],lastCleanup:a,throttleCount:0};if(h.requests=h.requests.filter(f=>a-f<n),h.requests.length>=r){let f=Math.min(...h.requests),y=n-(a-f);return h.throttleCount=(h.throttleCount||0)+1,t.set(d,h),Math.max(0,y)}return h.requests.push(a),t.set(d,h),0},getRemainingRequests:d=>{let a=t.get(d);if(!a)return r;let h=Date.now(),f=a.requests.filter(y=>h-y<n);return Math.max(0,r-f.length)},getThrottleCount:d=>{let a=t.get(d);return a&&a.throttleCount||0},shouldDisconnect:d=>{let a=t.get(d);return a?a.throttleCount>=o:!1},destroy:()=>{i&&(clearInterval(i),i=null),t.clear()}}},Ve=(e,t=1024*1024)=>{try{if(typeof e=="string"&&e.length>t)throw new Error("Message too large");return{success:!0,data:JSON.parse(e)}}catch(r){return{success:!1,error:r.message}}},et=(e,t=1024*1024)=>typeof e=="string"&&e.length>t?{valid:!1,error:"Message too large"}:Buffer.isBuffer(e)&&e.length>t?{valid:!1,error:"Message too large"}:{valid:!0},tt=(e=1e3)=>{let t=new Set;return{add:r=>{if(t.size>=e)return!1;t.add(r);let n=r.close;return r.close=(...o)=>(t.delete(r),n.apply(r,o)),!0},remove:r=>{t.delete(r)},count:()=>t.size,isFull:()=>t.size>=e}},Ee=(e=5)=>{let t=0;return{shouldRetry:()=>t<e,getDelay:()=>Math.min(1e3*Math.pow(2,t),3e4),increment:()=>t++,reset:()=>t=0}},rt=e=>{let t=xe(e.maxAge),r=Re(e),n={},o={},i={},m=new Set,d=new Map,a=async x=>n[x]?!0:new Promise(v=>{r.get({"#":x},(b,k)=>{v(!b&&k&&k[x])})}),h=e.wss&&e.wss.constructor.name==="Server",f=Ze(h),y=tt(e.maxConnections||1e3),E=async(x,v,b)=>{for(let k of Object.keys(x)){let j=await new Promise(I=>{g({"#":k},I,v)});if(j.err)return b&&b(j.err),!1;let A=x[k],M=F;if(!(!j.put||!j.put[k]||j.put[k][M]===A[M]))return b&&b(`error in wire check public key does not match for soul: ${k}`),!1}return!0},s=(x,v)=>{let b=me(x.get,n);b?v(JSON.stringify({"#":t.track(R.random(9)),"@":x["#"],put:b})):r.get(x.get,(k,j)=>{v(JSON.stringify({"#":t.track(R.random(9)),"@":x["#"],put:j,err:k}))})},l=async(x,v)=>{let b=await Se.mix(x.put,n,e.secure,i);if(Object.keys(b.now).length===0){Object.keys(b.defer).length!==0&&setTimeout(()=>l({put:b.defer,"#":x["#"]},v),b.wait);return}await E(b.now,v)&&(r.put(b.now,k=>{v(JSON.stringify({"#":t.track(R.random(9)),"@":x["#"],err:k}))}),Object.keys(b.defer).length!==0&&setTimeout(()=>l({put:b.defer,"#":x["#"]},v),b.wait))},g=(x,v,b,k)=>{if(!v)return;L.is(k)||(k={});let j=me(x,n),A=R.random(9),M=JSON.stringify({"#":t.track(A),get:e.secure?{"#":x["#"]}:x});if(j){let I=b(M);if(I&&I.err){v({err:I.err});return}v({put:j});return}r.get(x,(I,D)=>{if(D){let B=b(M);if(B&&B.err){v({err:B.err});return}v({put:D,err:I});return}I&&console.log(I),o[A]=v,d.set(A,{lex:x,wait:k.wait||100});let N=b(M);if(N&&N.err){v({err:N.err}),delete o[A],d.delete(A);return}})},c=x=>({get:(v,b,k)=>{v&&v["#"]&&m.add(v["#"]),g(v,b,x,k)},put:async(v,b)=>{let k=await Se.mix(v,n,e.secure,i);if(Object.keys(k.now).length===0){b&&b(null);return}if(!await E(k.now,x,b))return;for(let[A,M]of Object.entries(k.now))if(M&&typeof M=="object")for(let[I,D]of Object.entries(M)){let N=U.is(D);N&&m.add(N)}r.put(k.now,b);let j=x(JSON.stringify({"#":t.track(R.random(9)),put:v}));if(j&&j.err){b&&b(j.err);return}},on:(v,b,k,j)=>{let A=v&&v["#"];!A||!b||(i[A]?i[A].push({".":v["."],cb:b}):i[A]=[{".":v["."],cb:b}],k&&g(v,b,x,j))},off:(v,b)=>{let k=v&&v["#"];if(!(!k||!i[k]))if(b){let j=i[k].find(A=>A.cb===b);j&&i[k].splice(i[k].indexOf(j),1)}else delete i[k]}});if(De){let x=e.wss,v=()=>x.clients();if(!x){let k=e.server?{server:e.server}:{port:e.port||8765};x=new Ue.WebSocketServer(k),v=()=>x.clients}let b=(k,j)=>{let M=JSON.parse(k)["#"];if(M&&d.has(M)){let I=d.get(M);d.delete(M),I.timeoutId=setTimeout(()=>{let D=o[M];if(D){let N=I.lex["#"],B={[N]:null};typeof I.lex["."]=="string"&&(B[N]={[I.lex["."]]:null}),D({put:B}),delete o[M]}},I.wait)}v().forEach(I=>{if(I&&I.readyState===WebSocket.OPEN)I.send(k,{binary:j});else{let D=I._retryHandler||Ee();if(I._retryHandler=D,D.shouldRetry()){let N=D.getDelay();D.increment(),setTimeout(()=>{I&&I.readyState===WebSocket.OPEN&&(D.reset(),I.send(k,{binary:j}))},N)}}})};return x.on("connection",k=>{if(!y.add(k)){console.log("Connection limit reached, rejecting connection"),k.close(1013,"Connection limit reached - try again later");return}let j=R.random(9);console.log(`New WebSocket client connected: ${j}`),k.on("error",A=>{console.log("WebSocket error:",A),y.remove(k)}),k.on("close",()=>{console.log(`WebSocket client disconnected: ${j}`),y.remove(k)}),k.on("message",(A,M)=>{let I=et(A,e.maxMessageSize);if(!I.valid){console.warn(`Invalid message: ${I.error}`),k.send(JSON.stringify({error:I.error}));return}let D=Ve(A,e.maxMessageSize);if(!D.success){console.warn(`JSON parse error: ${D.error}`),k.send(JSON.stringify({error:"Invalid JSON"}));return}let N=D.data;if(t.check(N["#"]))return;let B=f.getDelay(j);if(B>0){let oe=f.getThrottleCount(j);if(console.log(`Client ${j}: rate limit exceeded, delay would be ${B}ms, dropping message (throttle count: ${oe})`),f.shouldDisconnect(j)){console.log(`Client ${j}: Disconnecting after ${oe} throttle violations`),k.close(1008,"Rate limit violations");return}k.send(JSON.stringify({"#":t.track(R.random(9)),"@":N["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(B/1e3)}s`,throttle:B}));return}let ne=()=>{t.track(N["#"]),N.get&&s(N,b),N.put&&l(N,b),b(A,M);let oe=N["@"],ae=o[oe];ae&&(delete N["#"],delete N["@"],ae(N),delete o[oe])};B>0?setTimeout(ne,B):ne()})}),c(b)}let u=[],p=!1,T=0,w=[],S=null,_=e.maxQueueLength||1e4,$=()=>{if(w.length===0){S=null;return}let x=Date.now();if(p&&x<T){S=setTimeout($,Math.min(1e3,T-x));return}p&&x>=T&&(console.log("Throttle period ended, resuming queue processing"),p=!1,T=0);let v=w[0];if(O(v)){w.shift();let j=JSON.parse(v)["#"];if(j&&d.has(j)){let A=d.get(j);d.delete(j),A.timeoutId=setTimeout(()=>{let M=o[j];if(M){let I=A.lex["#"],D={[I]:null};typeof A.lex["."]=="string"&&(D[I]={[A.lex["."]]:null}),M({put:D}),delete o[j]}},A.wait)}}w.length>0?S=setTimeout($,50):S=null},O=x=>{let v=!1;return u.forEach(b=>{if(b&&b.readyState===WebSocket.OPEN)b.send(x),v=!0;else{let k=b._retryHandler||Ee();if(b._retryHandler=k,k.shouldRetry()){let j=k.getDelay();k.increment(),setTimeout(()=>{b&&b.readyState===WebSocket.OPEN&&(k.reset(),b.send(x))},j)}}}),v},C=x=>{if(w.length>=_)return{err:`Message queue exceeded maximum length (${_}). Update query logic to request less data.`,queueLength:w.length,maxQueueLength:_};w.push(x),S||(S=setTimeout($,50))};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(x=>{let v=()=>{let b=new WebSocket(x);u.push(b);let k=Ee();b.onclose=j=>{if(u.indexOf(b)!==-1&&u.splice(u.indexOf(b),1),b=null,k.shouldRetry()){let A=k.getDelay();k.increment(),setTimeout(v,A)}},b.onopen=()=>{k.reset()},b.onerror=j=>{console.log(j)},b.onmessage=async j=>{let A=JSON.parse(j.data);if(t.check(A["#"]))return;if(A.throttle&&A.err){console.log(`Server throttling: ${A.err}`),p=!0,T=Date.now()+A.throttle;return}if(t.track(A["#"]),A.get&&s(A,C),A.put){let D={};for(let[N,B]of Object.entries(A.put)){let ne=!1;if(await a(N)&&(ne=!0,B&&typeof B=="object"))for(let[oe,ae]of Object.entries(B)){let Te=U.is(ae);Te&&m.add(Te)}m.has(N)&&(ne=!0,m.delete(N)),ne&&(D[N]=B)}if(Object.keys(D).length>0){let N={put:D,"#":A["#"]};l(N,C)}}let M=A["@"],I=o[M];I&&(delete A["#"],delete A["@"],I(A),delete o[M])}};v()}),c(C)},ye=rt;var nt=(e,t)=>{t||(t=ye(e));let r=[],n=!1,o=!1,i=0,m=(a,h,f,y)=>{let E=c=>{i++,m(c,h,f,y)},s=c=>{r=[],i=0,o=!1,y(c)},l=()=>{if(r.length===0){s("Wrong username or password");return}let c=r.shift();t.get({"#":c},async u=>{if(u.err){s(`error getting ${c}: ${u.err}`);return}let p=u.put&&u.put[c];if(!p||!p.auth)return l();let T=JSON.parse(p.auth),w=await K.work(h,T.salt),S=await K.decrypt(T.enc,w);if(!S)return l();if(d.is={username:a,pub:p.pub,epub:p.epub,priv:S.priv,epriv:S.epriv},f!==""){let C=R.random(64),x=await K.work(f,C),v=await K.encrypt(S,x),b={auth:JSON.stringify({enc:v,salt:C})},k=await K.signProperties(b,d.is),j=X(c,b,k,p.pub);t.put(j,A=>{s(A?`error putting ${b} on ${c}: ${A}`:null)});return}let _={};for(let C of Object.keys(p))C!=="_"&&C!==F&&C!==W&&(_[C]=p[C]);let $=await K.signProperties(_,d.is),O=X(c,_,$,p.pub);t.put(O,C=>{C&&console.log(`warning: failed to migrate signatures on login: ${C}`),s(null)})},{wait:5e3})};if(i>9){s("Wrong username or password");return}let g="~@"+a;t.get({"#":g},async c=>{if(c.err){s(`error getting ${g}: ${c.err}`);return}let u=c.put&&c.put[g];if(!u)return E(a);delete c.put[g]._,r=Object.keys(u),l()},{wait:5e3})},d={create:(a,h,f)=>{let y=s=>{f?f(s):console.log(s)};if(n){y("User is already being created");return}if(a===""){y("Please provide a username");return}if(h===""){y("Please provide a password");return}n=!0;let E="~@"+a;t.get({"#":E},async s=>{if(s.err){n=!1,y(`error getting ${E}: ${s.err}`);return}if(s.put&&s.put[E]){n=!1,y("Username already exists");return}let l=R.random(64),g=await K.work(h,l),c=await K.pair(),u={priv:c.priv,epriv:c.epriv},p=await K.encrypt(u,g),T={username:a,pub:c.pub,epub:c.epub,auth:JSON.stringify({enc:p,salt:l})},w="~"+c.pub,S=await K.signProperties(T,c),_=X(w,T,S,c.pub);t.put(_,$=>{if(n=!1,$){y(`error putting ${T} on ${w}: ${$}`);return}let O={[w]:{"#":w}};t.put(X(E,O),C=>{if(C){y(`error putting ${O} on ${E}: ${C}`);return}f&&f(null)})})},{wait:5e3})},auth:(a,h,f)=>{let y=E=>{f?f(E):E&&console.log(E)};if(o){y("User is already authenticating");return}if(d.is=null,a===""){y("Please provide a username");return}if(h===""){y("Please provide a password");return}o=!0,m(a,h,"",y)},change:(a,h,f,y)=>{let E=s=>{y?y(s):s&&console.log(s)};if(o){E("User is already authenticating");return}if(d.is=null,a===""){E("Please provide a username");return}if(h===""){E("Please provide a password");return}if(f===""){E("Please provide a new password");return}o=!0,m(a,h,f,E)},store:a=>{if(!d.is){console.log("Please authenticate before calling store");return}if(a){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let a=globalThis.localStorage.getItem("user.is");if(a){d.is=JSON.parse(a);return}}if(typeof globalThis.sessionStorage<"u"){let a=globalThis.sessionStorage.getItem("user.is");a&&(d.is=JSON.parse(a))}},leave:()=>{d.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(a,h,f)=>{let y=E=>{f?f(E):console.log(E)};if(o){y("User is already authenticating");return}if(a===""){y("Please provide a username");return}if(h===""){y("Please provide a password");return}o=!0,m(a,h,"",async E=>{if(E){y(E);return}let s={username:null,pub:null,epub:null,auth:null},l=await K.signProperties(s,d.is),g="~"+d.is.pub,c=X(g,s,l,d.is.pub);t.put(c,u=>{if(u){y(`error putting null on ${g}: ${u}`);return}d.is=null,f&&f(null)})})}};return d},Le=nt;var ot=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:L.is(e)||(e={});let t=ye(e),r=Le(null,t),n=new Map,o=new Map,i=a=>a===null||a===!0||a===!1||typeof a=="string"||U.is(a)||fe.is(a),m=a=>{if(i(a))return!0;if(L.is(a)){let f=[];for(let[y,E]of Object.entries(a)){if(y==="_")return"error underscore cannot be used as a property name";if(L.is(E)||i(E)){f.push(y);continue}return typeof E>"u"?`error undefined ${y} cannot be converted to a graph`:`error ${JSON.stringify({[y]:E})} cannot be converted to a graph`}if(f.length!==0)return f}return`error ${JSON.stringify(a)} cannot be converted to a graph`},d=a=>{let h=(s,l,g,c)=>{t.get(L.put(s,"#",l),async u=>{if(u.err&&console.log(u.err),u.put&&u.put[l]){delete u.put[l]._,delete u.put[l][F],delete u.put[l][W];for(let p of Object.keys(u.put[l])){let T=U.is(u.put[l][p]);if(T){let w=async(S=0)=>{let _=await new Promise($=>{let O=R.random();o.set(O,{chain:[{item:null,soul:T}]}),d(O).next(null,$,c)});return _!==null||S>=5?_:(await new Promise($=>setTimeout($,50)),w(S+1))};u.put[l][p]=await w()}}g(u.put[l])}else g(null)},c)},f=async(s,l,g,c)=>{if(g){let u=await K.signProperties(l,g);return X(s,l,u,g.pub)}return e.secure?(c||(c=console.log),c(`error putting data on ${s}: user required in secure mode`),null):X(s,l)},y=s=>l=>{let g=o.get(s);g&&typeof g.cb<"u"?setTimeout(()=>g.cb(l),1):l&&console.log("error no callback for data",l,"ctx",g),g&&!g.on&&o.delete(s)},E=(s,l)=>{if(!s){console.log("error resolve request parameter required");return}let g=typeof s.get<"u",c=typeof s.put<"u",u=typeof s.on<"u",p=typeof s.off<"u",T=!1,w=o.get(a);for(var S=1;S<w.chain.length;S++)if(w.chain[S].soul===null){T=!0;break}if(T){let{item:_,soul:$}=w.chain[S-1];return t.get({"#":$,".":_},async O=>{if(O.err){w.user||e.secure?console.log(`error getting ${$}: ${O.err}`):console.log(`error getting ${_} on ${$}: ${O.err}`),l&&l(null);return}let C=O.put&&O.put[$];if(C&&typeof C[_]<"u"){let x=U.is(C[_]);if(x)w.chain[S].soul=x,o.set(a,{...w}),g?d(a).next(null,s.get,l,s._opt):c?d(a).put(s.put,l):u?d(a).on(s.on,l,s._get,s._opt):p&&d(a).off(l);else if(g)l(C[_]);else if(c){x=R.random(),C[_]=U.ify(x);let v=await f($,C,w.user,l);if(v===null)return;t.put(v,b=>{if(b){l(`error putting ${_} on ${$}: ${b}`);return}w.chain[S].soul=x,d(a).put(s.put,l)})}else(u||p&&l)&&l(null)}else if(c){let x=R.random();C||(C={}),C[_]=U.ify(x);let v=await f($,C,w.user,l);if(v===null)return;t.put(v,b=>{if(b){l(`error putting ${_} on ${$}: ${b}`);return}w.chain[S].soul=x,d(a).put(s.put,l)})}else l&&l(null)},s._opt),!1}return g&&w.chain[w.chain.length-1].item!==null?(w.chain.push({item:null,soul:null}),d(a).next(null,s.get,l,s._opt),!1):w.chain[w.chain.length-1]};return{get:(s,l,g,c)=>{if(typeof l=="function"&&(c=g,g=l,l=null),s===null||s===""||s==="_"){console.log("error please provide a key"),g&&g(null);return}if(l&&typeof g!="function"){console.log("error lex requires a callback function");return}if(a=R.random(),o.set(a,{chain:[{item:s,soul:"root"}],cb:g}),!g)return d(a);let u=y(a),{soul:p}=E({get:l,_opt:c},u);p&&h(l,p,u,c)},next:(s,l,g,c)=>{let u=S=>_=>{g?g(_):y(S)(_)};if(typeof l=="function"&&(c=g,g=l,l=null),!a){console.log("error please provide a key using get(key)"),g&&g(null);return}let p=u(a);if(s===""||s==="_"){p(null);return}if(l&&typeof g!="function"){console.log("error lex requires a callback function");return}let T=o.get(a);if(!T)return;if(g&&typeof T.cb>"u"&&(T.cb=g,g=null),s!==null&&T.chain.push({item:s,soul:null}),!T.cb)return d(a);let{soul:w}=E({get:l,_opt:c},p);w&&h(l,w,p,c)},put:(s,l,g)=>{typeof l=="function"&&(g=l,l=!1);let c=_=>$=>{g?g($):y(_)($)};if(!a){g&&g("error please provide a key using get(key)");return}let u=o.get(a);if(!u)return;if(!u.cb){if(!g)return;u.cb=g,g=null}l&&(s={[R.random()]:s});let p=c(a),T=m(s);if(typeof T=="string"){p(T);return}let{item:w,soul:S}=E({put:s},p);if(S){if(T===!0){t.get({"#":S,".":w},async _=>{if(_.err){p(`error getting ${S}: ${_.err}`);return}let $=_.put&&_.put[S],O=$&&$[w],C=U.is(O);if(!C){$||($={}),$[w]=s;let x=await f(S,$,u.user,p);if(x===null)return;t.put(x,p);return}t.get({"#":C},async x=>{if(x.err){p(`error getting ${C}: ${x.err}`);return}if(!x.put||!x.put[C]){p(`error ${C} not found`);return}for(let b of Object.keys(x.put[C])){if(b==="_"||b===F||b===W)continue;let k=await new Promise(j=>{let A=R.random(),M=[{item:b,soul:C}];o.set(A,{chain:M,user:u.user}),d(A).put(null,j)});if(k){p(k);return}}$||($={}),$[w]=s;let v=await f(S,$,u.user,p);v!==null&&t.put(v,p)})});return}t.get({"#":S,".":w},async _=>{if(_.err){p(`error getting ${S}.${w}: ${_.err}`);return}let $=_.put&&_.put[S],O=$&&$[w],C=U.is(O);if(!C){$||($={}),$[w]=U.ify(R.random());let v=await f(S,$,u.user,p);if(v===null)return;t.put(v,b=>{if(b)p(`error putting ${w} on ${S}: ${b}`);else{let k=R.random(),j=[{item:w,soul:S}];o.set(k,{chain:j,user:u.user,cb:u.cb}),d(k).put(s)}});return}let x=[];for(let v of T){let b=await new Promise(k=>{if(L.is(s[v])&&!U.is(s[v])){let j=R.random(),A=[{item:v,soul:C}];o.set(j,{chain:A,user:u.user}),d(j).put(s[v],k)}else x.push(v),k(null)});if(b){p(b,a);return}}if(x.length===0){p(null);return}t.get({"#":C},async v=>{if(v.err){p(`error getting ${C}: ${v.err}`);return}let b=v.put&&v.put[C];b||(b={}),x.forEach(j=>{b[j]=s[j]});let k=await f(C,b,u.user,p);k!==null&&t.put(k,p)})})}},on:(s,l,g,c)=>{if(typeof s=="function"&&(c=g,g=l,l=s,s=null),typeof l!="function"){console.log("error on() requires a callback function");return}if(!a){console.log("error please provide a key using get(key)"),l(null);return}let{item:u,soul:p}=E({on:s,_get:g,_opt:c},l);if(!p)return;o.set(a,{chain:[{item:u,soul:p}],on:!0}),n.set(l,()=>{t.get({"#":p,".":u},w=>{let S=w.put&&w.put[p]&&w.put[p][u],_=U.is(S);if(_){let $=async(O=0)=>{let C=await new Promise(x=>{let v=R.random();o.set(v,{chain:[{item:null,soul:_}]}),d(v).next(null,x,c)});C!==null||O>=5?l(C):(await new Promise(x=>setTimeout(x,50)),$(O+1))};$()}else l(S!==void 0?S:null)},c)});let T;s?T=L.put(s,"#",p):T={"#":p,".":u},t.on(T,n.get(l),!1,c),t.get({"#":p,".":u},w=>{if(w.err){console.log(`error getting ${p}.${u}: ${w.err}`);return}let S=w.put&&w.put[p]&&w.put[p][u],_=U.is(S);if(_){t.off(T,n.get(l));let $;s?$=L.put(s,"#",_):$={"#":_,".":null},t.on($,n.get(l),g,c)}else g&&n.get(l)()},c)},off:s=>{if(!a){console.log("error please provide a key using get(key)"),s&&s(null);return}let{item:l,soul:g}=E({off:!0},s);g&&t.get({"#":g,".":l},c=>{if(c.err){console.log(`error getting ${g}.${l}: ${c.err}`);return}let u=c.put&&c.put[g]&&c.put[g][l],p=U.is(u);p?t.off({"#":p},n.get(s)):t.off({"#":g},n.get(s)),n.delete(s),o.delete(a)})},user:()=>(r.get||(Object.assign(r,d()),r.get=(s,l,g,c)=>{typeof l=="function"&&(c=g,g=l,l=null);let u=null,p=null;if(r.is&&(u=r.is.pub),typeof s=="string"?p=s:s instanceof Array&&(s.length===2?(u=s[0],p=s[1]):s.length===1&&(p=s[0])),!u){console.log("error please log in or provide a public key"),g&&g(null);return}if(p===null||p===""||p==="_"){console.log("error please provide a key"),g&&g(null);return}if(l&&!g){console.log("error lex requires a callback function");return}a=R.random();let T=[{item:p,soul:"~"+u}];if(o.set(a,{chain:T,user:r.is,cb:g}),!g)return d(a);let w=y(a),{soul:S}=E({get:l,_opt:c},w);S&&h(l,S,w,c)}),r),wire:t,SEA:K}};return d()},Pt=ot;export{Pt as default};
//# sourceMappingURL=holster.js.map
