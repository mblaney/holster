var le={is:e=>{if(e instanceof Array)return!1;if(typeof e=="number")return!isNaN(e);if(typeof e=="string"){let t=parseFloat(e);return!isNaN(t)&&isFinite(t)}return!1}},B={is:e=>{if(!e||typeof e!="object")return!1;let r=Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/);return e.constructor===Object||r&&r[1]==="Object"},map:(e,t,r)=>{var n=Object.keys(e);for(let o=0;o<n.length;o++){let f=t(e[n[o]],n[o],r);if(typeof f<"u")return f}},put:(e,t,r)=>(e||(e={}),e[t]=r,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Pe=(e,t,r)=>{if(r.id){r.id=!1;return}if(t==="#"&&typeof e=="string"){r.id=e;return}r.id=!1},R={is:e=>{if(e&&e["#"]&&!e._&&B.is(e)){let t={};if(B.map(e,Pe,t),t.id)return t.id}return!1},ify:e=>B.put({},"#",e)},q="_holster_user_signature",H="_holster_user_public_key",Q=(e,t,r,n)=>{let o=Date.now(),f={[e]:{_:{"#":e,">":{}}}};for(let[y,d]of Object.entries(t))y!=="_"&&y!==H&&y!==q&&(f[e][y]=d,f[e]._[">"][y]=o);return r&&n&&(f[e][q]=r,f[e]._[">"][q]=o,f[e][H]=n,f[e]._[">"][H]=o),f},ee=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!B.is(e)||!t)return!1;let r=e["*"];if(r)return t.slice(0,r.length)===r;let n=e[">"],o=e["<"];return n&&o?t>=n&&t<=o:n?t>=n:o?t<=o:!1},N={random:e=>{var t="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let n=0;n<e;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}};var Le=e=>{e||(e=9e3);let t={store:{}};return t.check=r=>t.store[r]?t.track(r):!1,t.track=r=>(t.store[r]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{if(t.expiry)return;let n=Date.now();Object.keys(t.store).forEach(o=>{n-t.store[o]>e&&delete t.store[o]}),t.expiry=null},e)),r),t},ke=Le;var Fe=(e,t)=>{if(!e||typeof e!="object")throw new TypeError("lex must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");let r=e["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!t[r])return;let n={_:{"#":r,">":{}}};if(typeof e["."]=="string"){let o=e["."];if(typeof t[r][o]>"u")return;n[o]=t[r][o],n._[">"][o]=t[r]._[">"][o]}else for(let o of Object.keys(t[r]))ee(e["."],o)&&(n[o]=t[r][o],n._[">"][o]=t[r]._[">"][o]);return{[r]:n}},ye=Fe;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function ae(){}Object.assign(ae,{from:Array.from});ae.prototype=Object.create(Array.prototype);ae.prototype.toString=function(e,t,r){if(e||(e="utf8"),t||(t=0),r=r?Math.min(Math.max(r,t),this.length):this.length,e==="hex"){let n=new Uint8Array(this.slice(t,r));return Array.from(n,o=>o.toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:r-t},(n,o)=>{let f=this[o+t];return f<0||f>1114111?"\uFFFD":String.fromCharCode(f)}).join("");if(e==="base64"){let n=Array.from({length:r-t},(o,f)=>{let y=this[f+t];return y<0||y>255?"\uFFFD":String.fromCharCode(y)}).join("");return btoa(n)}};var Y=ae;var fe={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function Z(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),Z.from(...e)}Z.prototype=Object.create(Array.prototype);var oe=(e,t)=>{if(typeof e!="string")throw new TypeError("Input must be a string for encoding: "+t);if(e.length>fe.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${e.length} > ${fe.MAX_STRING_LENGTH}`)},G=(e,t="buffer operation")=>{if(e>fe.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${t}: ${e} > ${fe.MAX_BUFFER_SIZE}`)},He=e=>{oe(e,"hex");let t=e.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(t))throw new TypeError("Invalid hex string: contains non-hex characters");if(t.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(t.length===0)return new Uint8Array(0);G(t.length/2,"hex parsing");let r=new Uint8Array(t.length/2);for(let n=0;n<t.length;n+=2){let o=t.substr(n,2);r[n/2]=parseInt(o,16)}return r},Te=e=>{oe(e,"utf8");try{let r=new TextEncoder().encode(e);return G(r.length,"UTF-8 encoding"),r}catch(t){throw new TypeError("Failed to encode UTF-8 string: "+t.message)}},Ke=e=>{oe(e,"binary"),G(e.length,"binary encoding");let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);t[r]=n}return t},Je=e=>{oe(e,"base64");let t=e.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(t))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(t);G(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let o=0;o<r.length;o++)n[o]=r.charCodeAt(o);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},$e=e=>{let t;if(e instanceof ArrayBuffer)G(e.byteLength,"ArrayBuffer processing"),t=new Uint8Array(e);else if(ArrayBuffer.isView(e))G(e.byteLength||e.length,"TypedArray processing"),t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);else if(Array.isArray(e)){G(e.length,"Array processing");for(let r=0;r<e.length;r++){let n=e[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}t=new Uint8Array(e)}else if(typeof e=="object"&&e!==null&&typeof e.length=="number"){G(e.length,"array-like processing");let r=Array.from(e);for(let n=0;n<r.length;n++){let o=r[n];if(typeof o!="number"||o<0||o>255||!Number.isInteger(o))throw new TypeError(`Invalid byte value at index ${n}: ${o} (must be integer 0-255)`)}t=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof e);return t};Object.assign(Z,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let t=arguments[0];if(t==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof t=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=He(t);break;case"utf8":case"utf-8":r=Te(t);break;case"binary":case"latin1":r=Ke(t);break;case"base64":r=Je(t);break;case"ascii":oe(t,"ascii");for(let o=0;o<t.length;o++)if(t.charCodeAt(o)>127)throw new TypeError(`Invalid ASCII character at position ${o}: ${t.charCodeAt(o)} > 127`);r=Te(t);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=$e(t);if(!r||r.length===0)return Y.from(new Uint8Array(0));try{return Y.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(e,t=0){if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Length must be a non-negative integer");if(G(e,"buffer allocation"),typeof t=="number"){if(t<0||t>255||!Number.isInteger(t))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof t=="string"){if(t.length!==1)throw new TypeError("Fill string must be exactly one character");if(t=t.charCodeAt(0),t>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(e);return t!==0&&r.fill(t),Y.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be an array");if(e.length===0)return Y.from(new Uint8Array(0));let t=0,r=[];for(let n=0;n<e.length;n++){let o=e[n];if(!o)throw new TypeError(`Array element at index ${n} is null or undefined`);let f;try{f=$e(o)}catch(y){throw new TypeError(`Invalid array element at index ${n}: ${y.message}`)}t+=f.length,G(t,"buffer concatenation"),r.push(f)}try{let n=new Uint8Array(t),o=0;for(let f of r)n.set(f,o),o+=f.length;return Y.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(e){return e instanceof Y||e&&typeof e=="object"&&e.constructor===Z},byteLength(e,t="utf8"){if(typeof e!="string")throw new TypeError("First argument must be a string");switch(t.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(e).length;case"ascii":case"binary":case"latin1":return e.length;case"base64":let r=e.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(e.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+t)}}});Z.prototype.from=Z.from;Z.prototype.toString=function(e="utf8",t=0,r=this.length){if(typeof e!="string")throw new TypeError("Encoding must be a string");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<t)throw new TypeError("End must be an integer >= start");try{return Y.prototype.toString.call(this,e,t,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var K=Z;var qe=typeof document>"u",xe=qe?(await import("node:crypto")).webcrypto:globalThis.crypto,D=xe.subtle,ce=e=>typeof e=="string"?e:JSON.stringify(e),ie=e=>{try{return JSON.parse(e)}catch{return e}},ge=e=>{let t=new Uint8Array(K.alloc(e));return K.from(xe.getRandomValues(t))},se=(e,t)=>{let[r,n]=e.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},pe=async e=>{let t=await D.digest({name:"SHA-256"},new TextEncoder().encode(ce(e)));return K.from(t)},me=async(e,t)=>{let r=e+t.toString("utf8"),n=K.from(await pe(r),"binary"),o=We(n);return await D.importKey("jwk",o,{name:"AES-GCM"},!1,["encrypt","decrypt"])},We=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var ze={pair:async e=>{let t=await D.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async o=>{let f=await D.exportKey("jwk",o.publicKey);return{priv:(await D.exportKey("jwk",o.privateKey)).d,pub:f.x+"."+f.y}}),r=await D.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async o=>{let f=await D.exportKey("jwk",o.publicKey);return{epriv:(await D.exportKey("jwk",o.privateKey)).d,epub:f.x+"."+f.y}}),n={pub:t.pub,priv:t.priv,epub:r.epub,epriv:r.epriv};return e&&e(n),n},encrypt:async(e,t,r)=>{if(!t||!t.epriv)return r&&r(null),null;let n={s:ge(9),iv:ge(15)},o=await me(t.epriv,n.s).then(y=>D.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},y,new TextEncoder().encode(ce(e)))),f={ct:K.from(o,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(f),f},decrypt:async(e,t,r)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return r&&r(null),null;let n={ct:K.from(e.ct,"base64"),iv:K.from(e.iv,"base64"),s:K.from(e.s,"base64")};try{let o=await me(t.epriv,n.s).then(y=>D.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},y,new Uint8Array(n.ct))),f=ie(new TextDecoder("utf8").decode(o));return r&&r(f),f}catch{return r&&r(null),null}},verify:async(e,t,r)=>{if(!t||!t.pub)return r&&r(null),null;let n=ie(e),o=await D.importKey("jwk",se(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),f={};if(typeof n.m=="string")f=n.m;else for(let u of Object.keys(n.m).sort())u!=="_"&&u!=H&&u!=q&&(f[u]=n.m[u]);let y=await pe(f),d=new Uint8Array(K.from(n.s,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}};if(await D.verify(a,o,d,new Uint8Array(y))){let u=ie(n.m);return r&&r(u),u}return r&&r(null),null},sign:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n={};if(typeof e=="string")n=e;else{let u=ie(e);for(let h of Object.keys(u).sort())h!=="_"&&h!=H&&h!=q&&(n[h]=u[h])}let o=await pe(n),f=se(t.pub,t.priv),y={name:"ECDSA",namedCurve:"P-256"},d=await D.importKey("jwk",f,y,!1,["sign"]).then(u=>D.sign({name:"ECDSA",hash:{name:"SHA-256"}},u,new Uint8Array(o))),a={m:n,s:K.from(d,"binary").toString("base64")};return r&&r(a),a},work:async(e,t,r)=>{typeof t=="function"&&(r=t,t=void 0),typeof t>"u"&&(t=ge(9));let n=await D.importKey("raw",new TextEncoder().encode(ce(e)),{name:"PBKDF2"},!1,["deriveBits"]),o={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},f=await D.deriveBits(o,n,512),y={epriv:K.from(f,"binary").toString("base64")};return r&&r(y),y},secret:async(e,t,r)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},o=se(e.epub),f=await D.importKey("jwk",o,n,!0,[]),y=se(t.epub,t.epriv,!1);delete y.key_ops;let d=await D.importKey("jwk",y,n,!1,["deriveBits"]).then(async a=>{let u=await D.deriveBits({public:f,name:"ECDH",namedCurve:"P-256"},a,256),h=await D.importKey("raw",new Uint8Array(u),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return D.exportKey("jwk",h).then(({k:v})=>v)});return r&&r({epriv:d}),{epriv:d}}},L=ze;var Ae=100,je=1e4,we=(e,t,r,n)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});we.mix=async(e,t,r,n)=>{if(!e||typeof e!="object")throw new TypeError("change must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let o=Date.now(),f={},y={},d=0;for(let u of Object.keys(e)){let h=e[u],v=!1,x=!1,i=0,l=r;if(!h||!h._)continue;let g=h[q],c=h[H];if(g&&c&&(l=!0),u.length>1&&u[0]==="~")if(u[1]==="@")x=!0,l=!1;else{if(c&&u!="~"+c){console.log(`error public key does not match for soul: ${u}`);continue}l=!0}if(!(l&&(!g||!c||!await L.verify({m:h,s:g},{pub:c})))){for(let s of Object.keys(h)){if(s==="_")continue;let p=h[s],E=h._&&h._[">"]?h._[">"][s]:0,w=(t[u]||{})[s],b=(t[u]||{_:{">":{}}})._[">"][s]||0;if(x&&s!==R.is(p)){console.log(`error alias ${x}: ${s} !== ${R.is(p)}`);continue}let j=E-o;if(j>0){if(j>864e5)continue;(d===0||j<d)&&(d=i=j),y[u]||(y[u]={_:{"#":u,">":{}}}),y[u][s]=p,y[u]._[">"][s]=E}else we(E,b,p,w).incoming&&(f[u]||(f[u]={_:{"#":u,">":{}}}),t[u]||(t[u]={_:{"#":u,">":{}}}),t[u][s]=f[u][s]=p,t[u]._[">"][s]=f[u]._[">"][s]=E,n[u]&&setTimeout(()=>{n[u]&&n[u].filter(C=>ee(C["."],s)).forEach(C=>C.cb())},Ae),v=!0)}l&&i!==0&&f[u]&&(Object.assign(y[u],f[u]),delete f[u]),v&&n[u]&&setTimeout(()=>{n[u]&&n[u].filter(s=>ee(s["."])).forEach(s=>s.cb())},Ae)}}let a=Object.keys(t);return a.length>je&&a.map(v=>{let x=t[v]._&&t[v]._[">"],i=x?Math.max(...Object.values(x)):0;return{soul:v,maxState:i}}).sort((v,x)=>v.maxState-x.maxState).slice(0,a.length-je).forEach(({soul:v})=>delete t[v]),{now:f,defer:y,wait:d}};var be=we;var W="",ne="",Ce=()=>{let e=(t,r,n)=>{if(n||(e[W]||(e[W]={}),n=e[W]),!t)return n;let o=0,f={},y=t[o],d=t.length-1,a=typeof r>"u",u=n[y];for(;!u&&o<d;)y+=t[++o],u=n[y];if(u)if(o===d){if(a)return typeof u[ne]>"u"?u[W]:u[ne];u[ne]=r}else return!u[W]&&!a&&(u[W]={}),e(t.slice(++o),r,u[W]);else if(B.map(n,(v,x)=>{let i=0,l="";for(;x[i]===t[i];)l+=x[i++];if(l){if(a)return i<=d?void 0:(f[x.slice(i)]=v,v);let g={[x.slice(i)]:v,[t.slice(i)]:{[ne]:r}};return n[l]={[W]:g},delete n[x],!0}})){if(a)return f}else{if(a)return;n[y]||(n[y]={}),n[y][ne]=r}};return e};Ce.map=function e(t,r,n,o){o||(o=[]);var f=t[W]||t,y=Object.keys(f).sort(),d;for(let a=0;a<y.length;a++){let u=y[a],h=f[u],v=h[ne];if(typeof v<"u"){if(v=r(v,o.join("")+u,u,o),typeof v<"u")return v}else n&&r(d,o.join(""),u,o);if(h[W]){if(o.push(u),v=e(h[W],r,n,o),typeof v<"u")return v;o.pop()}}};var J=Ce;var Oe="",_e="",P="",re=e=>{var t;let r=new Map,n=null,o=0,f=1e4,y=new Map,d=0,a=3e4,u=.8,h=.9;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=100),e.write||(e.write=1),e.size||(e.size=1024*1024),e.memoryLimit||(e.memoryLimit=500),typeof e.cache>"u"&&(e.cache=!0),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let v=(l,g,c,s)=>{let p=Date.now()-g;p>1e3&&console.log(`[RADISK-SLOW] ${l}: ${p}ms for ${c}${s?` (${s} bytes)`:""}`)},x=()=>{if(typeof process>"u"||!process.memoryUsage)return;let l=Date.now();if(l-d<a)return;d=l;let g=process.memoryUsage(),c=g.heapUsed,s=g.heapTotal,p=e.memoryLimit*1024*1024,E=c/p;if(E>h){let w=r.size;console.log(`[RADISK-MEMORY] High memory usage: ${Math.round(E*100)}% of heap limit. Clearing ${w} cached files.`),r.clear(),global.gc&&global.gc(),d=l+a}else E>u&&console.log(`[RADISK-MEMORY] Memory warning: ${Math.round(E*100)}% of heap limit used. Cache size: ${r.size} files.`)},i=(l,g,c)=>{if(l=""+l,typeof g=="function"){if(c=g,g=i.batch(l),typeof g<"u"||i.thrash.at&&(g=i.thrash.at(l),typeof g<"u"))return c(t,g);if(y.has(l)){y.get(l).push(c);return}y.set(l,[c]);let s=Date.now();return i.read(l,(p,E)=>{v("read",s,l);let w=y.get(l)||[];y.delete(l),w.forEach(b=>b(p,E))})}if(i.batch(l,g),x(),c&&i.batch.acks.push(c),++i.batch.ed>=e.batch)return i.thrash();clearTimeout(i.batch.timeout),i.batch.timeout=setTimeout(i.thrash,e.write)};return i.batch=J(),i.batch.acks=[],i.batch.ed=0,i.thrash=()=>{if(i.thrash.ing)return i.thrash.more=!0;let l=Date.now();clearTimeout(i.batch.timeout),i.thrash.more=!1,i.thrash.ing=!0;var g=i.thrash.at=i.batch;i.batch=null,i.batch=J(),i.batch.acks=[],i.batch.ed=0;let c=0;i.save(g,s=>{++c>1||(v("thrash",l,`batch-${g.ed}`),s&&e.log(s),g.acks.forEach(p=>p(s)),i.thrash.at=null,i.thrash.ing=!1,i.thrash.more&&i.thrash())})},i.save=(l,g)=>{let c={find:(s,p)=>{if(!(p<c.start))return c.start=p,e.store.list(c.lex),!0},lex:s=>{!s||s>c.start?(c.end=s,c.start&&c.mix(c.file||"!",c.start,c.end)):c.file=s},mix:(s,p,E)=>{if(c.start=c.end=c.file=t,r.has(s)){let w=r.get(s);J.map(l,(b,j)=>{if(!(j<p)){if(E&&E<j){c.start=j;return}w(j,b)}}),i.write(s,w,c.next)}else i.parse(s,(w,b)=>{if(w)return g(w);J.map(l,(j,_)=>{if(!(_<p)){if(E&&E<_){c.start=_;return}b(_,j)}}),i.write(s,b,c.next)})},next:s=>{if(s)return g(s);if(c.start)return J.map(l,c.find);g(s)}};J.map(l,c.find)},i.write=(l,g,c)=>{let s={text:"",limit:"",done:!1,count:0,each:(E,w,b,j)=>{if(s.done)return;s.count++,E=typeof E>"u"?"":"="+re.encode(E);let _=re.encode(j.length)+"#"+re.encode(b)+E+`
`;if(s.count>1&&j.length===0&&s.text.length+_.length>e.size){let C=b.indexOf(_e);if(s.limit=C===-1?b:b.substring(0,C),s.limit!==l){s.done=!0,s.sub=J(),J.map(g,s.slice),i.write(s.limit,s.sub,c);return}}s.text+=_},slice:(E,w)=>{w<s.limit||s.sub(w,E)}};J.map(g,s.each,!0);let p=Date.now();e.store.put(l,s.text,E=>{v("file-write",p,l,s.text.length),c(E)})},i.read=(l,g)=>{let c=l.indexOf(_e),s=c===-1?l:l.substring(0,c),p={lex:w=>{if(!w){if(!p.file){g("no file found",t);return}if(e.cache&&r.has(p.file)){let b=r.get(p.file);return p.value=b(l),g(t,p.value)}i.parse(p.file,p.it);return}w>s||w<p.file||(p.file=w)},it:(w,b)=>{w&&e.log(w),b&&(e.cache&&(r.set(p.file,b),x()),p.value=b(l)),g(w,p.value)}},E=Date.now();if(e.cache&&n&&E-o<f)n.forEach(w=>p.lex(w)),p.lex();else{let w=[],b=p.lex;p.lex=j=>(j&&w.push(j),b(j)),e.store.list(j=>{p.lex(j),!j&&e.cache&&(n=w,o=E)})}},i.parse=(l,g)=>{let c={disk:J(),read:(s,p)=>{if(s)return g(s);if(!p)return g(t,c.disk);let E=[],w="",b=c.split(p);for(;b;){let j,_,C=b[1];b=c.split(b[2])||"",b[0]==="#"&&(j=b[1],C<E.length&&(E.length=C),C<=E.length&&(E[C]=j,E.length=C+1),w=E.join("")),b=c.split(b[2])||"",b[0]!==`
`&&(b[0]==="="&&(_=b[1]),typeof j<"u"&&typeof _<"u"&&c.disk(w,_),b=c.split(b[2]))}g(t,c.disk)},split:s=>{if(!s)return;let p=s.indexOf(P);if(p===-1)return;let E=s.slice(0,p),w={};return[E,re.decode(s.slice(p),w),s.slice(p+w.i)]}};e.store.get(l,c.read)},i};re.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=Oe+e[1],e=e[0]),typeof e=="string"){let n=0,o=null,f=P;for(;o=e[n++];)o===P&&(f+=P);return f+'"'+e+t+P}let r=R.is(e);if(r)return P+"#"+r+t+P;if(le.is(e))return P+"+"+(e||0)+t+P;if(e===!0)return P+"+"+t+P;if(e===!1)return P+"-"+t+P;if(e===null)return P+" "+t+P};re.decode=(e,t)=>{var r=-1,n=0,o=null,f=null,y=-1,d=-1;if(e[0]!==P)return;for(;o=e[++r];)if(f){if(y===-1&&(y=r),o===P&&--n<=0){d=r;break}}else o===P?n++:f=o||!0;let a=y!==-1?e.slice(y,d!==-1?d:r):"";t&&(t.i=r+1);let[u,h]=a.split(Oe);if(h){if(h=parseFloat(h),f==='"')return[u,h];if(f==="#")return[R.ify(u),h];if(f==="+")return u.length===0?[!0,h]:[parseFloat(u),h];if(f==="-")return[!1,h];if(f===" ")return[null,h]}else{if(f==='"')return a;if(f==="#")return R.ify(a);if(f==="+")return a.length===0?!0:parseFloat(a);if(f==="-")return!1;if(f===" ")return null}};var Ie=re;var Ne=typeof document>"u",V=Ne?await import("node:fs"):void 0,Me="",de="",Se=de+"+0"+de+"#"+de+'"root'+de,Xe=e=>{let t=e.file;if(Ne)return V.existsSync(t)||V.mkdirSync(t),V.existsSync(t+"/!")||V.writeFileSync(t+"/!",Se),{get:(r,n)=>{V.readFile(t+"/"+r,(o,f)=>{if(o){if(o.code==="ENOENT"){n();return}console.log("fs.readFile error:",o)}f&&(f=f.toString()),n(o,f)})},put:(r,n,o)=>{var f=r+"."+N.random(9)+".tmp";V.writeFile(f,n,y=>{if(y){console.log("fs.writeFile error:",y),o(y);return}V.rename(f,t+"/"+r,o)})},list:r=>{V.readdir(t,(n,o)=>{if(n){console.log("fs.readdir error:",n),r();return}o.forEach(r),r()})}};if(e.indexedDB){let r,n=indexedDB.open(t,1);return n.onupgradeneeded=o=>{o.target.result.createObjectStore(t)},n.onerror=o=>{console.log(o)},n.onsuccess=()=>{if(r=n.result,r){let f=r.transaction([t],"readonly").objectStore(t).getKey("!");f.onerror=()=>{console.log(`error getting key ${t}/!`)},f.onsuccess=()=>{if(!f.result){let d=r.transaction([t],"readwrite").objectStore(t).put(Se,"!");d.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(o,f)=>{let y=(u,h)=>{let x=r.transaction([t],"readonly").objectStore(t).get(u);x.onerror=()=>{console.log(`error getting ${t}/${u}`)},x.onsuccess=()=>{h(null,x.result)}};if(r){y(o,f);return}let d=0,a=setInterval(()=>{if(r){clearInterval(a),y(o,f);return}d++>5&&(clearInterval(a),f("error indexedDB not available"))},1e3)},put:(o,f,y)=>{let d=(h,v,x)=>{let l=r.transaction([t],"readwrite").objectStore(t).put(v,h);l.onerror=()=>{console.log(`error putting data on ${t}/${h}`)},l.onsuccess=()=>{x(null)}};if(r){d(o,f,y);return}let a=0,u=setInterval(()=>{if(r){clearInterval(u),d(o,f,y);return}a++>5&&(clearInterval(u),y("error indexedDB not available"))},1e3)},list:o=>{let f=a=>{let h=r.transaction([t],"readonly").objectStore(t).getAllKeys();h.onerror=()=>console.log("error getting keys for",t),h.onsuccess=()=>{h.result.forEach(a),a()}};if(r){f(o);return}let y=0,d=setInterval(()=>{if(r){clearInterval(d),f(o);return}y++>5&&(clearInterval(d),console.log("error indexedDB not available"),o())},1e3)}}}return{get:(r,n)=>{n(null,Se)},put:(r,n,o)=>{o(null)},list:r=>{r("!"),r()}}},Qe=e=>{B.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Xe(e));let t=Ie(e);return{get:(r,n)=>{if(!r||!B.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}var o=r["#"],f=typeof r["."]=="string"?r["."]:"",y;let d=(a,u)=>{ee(r["."],u)&&(y||(y={_:{"#":o,">":{}}}),y[u]=a[0],y._[">"][u]=a[1])};t(o+Me+f,(a,u)=>{let h;B.is(u)?(J.map(u,d),y||d(u,f),h={[o]:y}):u&&(d(u,f),h={[o]:y}),n(a,h)})},put:(r,n)=>{if(!r){n("graph required");return}let o=0,f=!1,y=d=>{if(o--,!f){if(d){f=!0,n(d);return}o===0&&(f=!0,n(null))}};Object.keys(r).forEach(d=>{var a=r[d];Object.keys(a).forEach(u=>{if(u==="_")return;o++;let h=a[u],v=a._[">"][u];t(d+Me+u,[h,v],y)})})}}},Re=Qe;var De=typeof document>"u",Ue=De?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Ue?.WebSocket);var Ye=e=>{let t=new Map,r=300,n=6e4,o=10,f=null;return e||(f=setInterval(()=>{let d=Date.now();for(let[a,u]of t.entries())d-u.lastCleanup>n&&(u.requests=[],u.lastCleanup=d),u.requests=u.requests.filter(h=>d-h<n),d-u.lastCleanup>n*10&&(u.throttleCount=0)},n/4)),{getDelay:d=>{let a=Date.now(),u=t.get(d)||{requests:[],lastCleanup:a,throttleCount:0};if(u.requests=u.requests.filter(h=>a-h<n),u.requests.length>=r){let h=Math.min(...u.requests),v=n-(a-h);return u.throttleCount=(u.throttleCount||0)+1,t.set(d,u),Math.max(0,v)}return u.requests.push(a),t.set(d,u),0},getRemainingRequests:d=>{let a=t.get(d);if(!a)return r;let u=Date.now(),h=a.requests.filter(v=>u-v<n);return Math.max(0,r-h.length)},getThrottleCount:d=>{let a=t.get(d);return a&&a.throttleCount||0},shouldDisconnect:d=>{let a=t.get(d);return a?a.throttleCount>=o:!1},destroy:()=>{f&&(clearInterval(f),f=null),t.clear()}}},Ze=(e,t=1024*1024)=>{try{if(typeof e=="string"&&e.length>t)throw new Error("Message too large");return{success:!0,data:JSON.parse(e)}}catch(r){return{success:!1,error:r.message}}},Ve=(e,t=1024*1024)=>typeof e=="string"&&e.length>t?{valid:!1,error:"Message too large"}:Buffer.isBuffer(e)&&e.length>t?{valid:!1,error:"Message too large"}:{valid:!0},et=(e=1e3)=>{let t=new Set;return{add:r=>{if(t.size>=e)return!1;t.add(r);let n=r.close;return r.close=(...o)=>(t.delete(r),n.apply(r,o)),!0},remove:r=>{t.delete(r)},count:()=>t.size,isFull:()=>t.size>=e}},ve=(e=5)=>{let t=0;return{shouldRetry:()=>t<e,getDelay:()=>Math.min(1e3*Math.pow(2,t),3e4),increment:()=>t++,reset:()=>t=0}},tt=e=>{let t=ke(e.maxAge),r=Re(e),n={},o={},f={},y=new Set,d=async T=>n[T]?!0:new Promise(k=>{r.get({"#":T},(S,m)=>{k(!S&&m&&m[T])})}),a=e.wss&&e.wss.constructor.name==="Server",u=Ye(a),h=et(e.maxConnections||1e3),v=async(T,k,S)=>{for(let m of Object.keys(T)){let A=await new Promise(I=>{l({"#":m},I,k)});if(A.err)return S&&S(A.err),!1;let $=T[m],O=H;if(!(!A.put||!A.put[m]||A.put[m][O]===$[O]))return S&&S(`error in wire check public key does not match for soul: ${m}`),!1}return!0},x=(T,k)=>{let S=ye(T.get,n);S?k(JSON.stringify({"#":t.track(N.random(9)),"@":T["#"],put:S})):r.get(T.get,(m,A)=>{k(JSON.stringify({"#":t.track(N.random(9)),"@":T["#"],put:A,err:m}))})},i=async(T,k)=>{let S=await be.mix(T.put,n,e.secure,f);if(Object.keys(S.now).length){if(!await v(S.now,k))return;r.put(S.now,m=>{k(JSON.stringify({"#":t.track(N.random(9)),"@":T["#"],err:m}))})}Object.keys(S.defer).length&&setTimeout(()=>i({put:S.defer},k),S.wait)},l=(T,k,S,m)=>{if(!k)return;B.is(m)||(m={});let A=ye(T,n),$=N.random(9),O=JSON.stringify({"#":t.track($),get:e.secure?{"#":T["#"]}:T});if(A){let I=S(O);if(I&&I.err){k({err:I.err});return}k({put:A});return}r.get(T,(I,F)=>{if(F){let U=S(O);if(U&&U.err){k({err:U.err});return}k({put:F,err:I});return}I&&console.log(I),o[$]=k;let M=S(O);if(M&&M.err){k({err:M.err}),delete o[$];return}setTimeout(()=>{let U=o[$];if(U){let z=T["#"],X={[z]:null};typeof T["."]=="string"&&(X[z]={[T["."]]:null}),U({put:X}),delete o[$]}},m.wait||100)})},g=T=>({get:(k,S,m)=>{k&&k["#"]&&y.add(k["#"]),l(k,S,T,m)},put:async(k,S)=>{let m=await be.mix(k,n,e.secure,f);if(Object.keys(m.now).length===0){S(null);return}if(!await v(m.now,T,S))return;for(let[O,I]of Object.entries(m.now))if(I&&typeof I=="object")for(let[F,M]of Object.entries(I)){let U=R.is(M);U&&y.add(U)}r.put(m.now,S);let $=T(JSON.stringify({"#":t.track(N.random(9)),put:k}));if($&&$.err){S&&S($.err);return}},on:(k,S,m,A)=>{let $=k&&k["#"];!$||!S||(f[$]?f[$].push({".":k["."],cb:S}):f[$]=[{".":k["."],cb:S}],m&&l(k,S,T,A))},off:(k,S)=>{let m=k&&k["#"];if(!(!m||!f[m]))if(S){let A=f[m].find($=>$.cb===S);A&&f[m].splice(f[m].indexOf(A),1)}else delete f[m]}});if(De){let T=e.wss,k=()=>T.clients();if(!T){let m=e.server?{server:e.server}:{port:e.port||8765};T=new Ue.WebSocketServer(m),k=()=>T.clients}let S=(m,A)=>{k().forEach($=>{if($&&$.readyState===WebSocket.OPEN)$.send(m,{binary:A});else{let O=$._retryHandler||ve();if($._retryHandler=O,O.shouldRetry()){let I=O.getDelay();O.increment(),setTimeout(()=>{$&&$.readyState===WebSocket.OPEN&&(O.reset(),$.send(m,{binary:A}))},I)}}})};return T.on("connection",m=>{if(!h.add(m)){console.log("Connection limit reached, rejecting connection"),m.close(1013,"Connection limit reached - try again later");return}let A=N.random(9);console.log(`New WebSocket client connected: ${A}`),m.on("error",$=>{console.log("WebSocket error:",$),h.remove(m)}),m.on("close",()=>{console.log(`WebSocket client disconnected: ${A}`),h.remove(m)}),m.on("message",($,O)=>{let I=Ve($,e.maxMessageSize);if(!I.valid){console.warn(`Invalid message: ${I.error}`),m.send(JSON.stringify({error:I.error}));return}let F=Ze($,e.maxMessageSize);if(!F.success){console.warn(`JSON parse error: ${F.error}`),m.send(JSON.stringify({error:"Invalid JSON"}));return}let M=F.data;if(t.check(M["#"]))return;let U=u.getDelay(A);if(U>0){let X=u.getThrottleCount(A);if(console.log(`Client ${A}: rate limit exceeded, delay would be ${U}ms, dropping message (throttle count: ${X})`),u.shouldDisconnect(A)){console.log(`Client ${A}: Disconnecting after ${X} throttle violations`),m.close(1008,"Rate limit violations");return}m.send(JSON.stringify({"#":t.track(N.random(9)),"@":M["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(U/1e3)}s`,throttle:U}));return}let z=()=>{t.track(M["#"]),M.get&&x(M,S),M.put&&i(M,S),S($,O);let X=M["@"],ue=o[X];ue&&(delete M["#"],delete M["@"],ue(M),delete o[X])};U>0?setTimeout(z,U):z()})}),g(S)}let c=[],s=!1,p=0,E=[],w=null,b=e.maxQueueLength||1e4,j=()=>{if(E.length===0){w=null;return}let T=Date.now();if(s&&T<p){w=setTimeout(j,Math.min(1e3,p-T));return}s&&T>=p&&(console.log("Throttle period ended, resuming queue processing"),s=!1,p=0);let k=E.shift();_(k),E.length>0?w=setTimeout(j,250):w=null},_=T=>{c.forEach(k=>{if(k&&k.readyState===WebSocket.OPEN)k.send(T);else{let S=k._retryHandler||ve();if(k._retryHandler=S,S.shouldRetry()){let m=S.getDelay();S.increment(),setTimeout(()=>{k&&k.readyState===WebSocket.OPEN&&(S.reset(),k.send(T))},m)}}})},C=T=>{if(E.length>=b)return{err:`Message queue exceeded maximum length (${b}). Update query logic to request less data.`,queueLength:E.length,maxQueueLength:b};E.push(T),w||(w=setTimeout(j,250))};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(T=>{let k=()=>{let S=new WebSocket(T);c.push(S);let m=ve();S.onclose=A=>{if(c.indexOf(S)!==-1&&c.splice(c.indexOf(S),1),S=null,m.shouldRetry()){let $=m.getDelay();m.increment(),setTimeout(k,$)}},S.onopen=()=>{m.reset()},S.onerror=A=>{console.log(A)},S.onmessage=async A=>{let $=JSON.parse(A.data);if(t.check($["#"]))return;if($.throttle&&$.err){console.log(`Server throttling: ${$.err}`),s=!0,p=Date.now()+$.throttle;return}if(t.track($["#"]),$.get&&x($,C),$.put){let F={};for(let[M,U]of Object.entries($.put)){let z=!1;if(await d(M)&&(z=!0,U&&typeof U=="object"))for(let[X,ue]of Object.entries(U)){let Ee=R.is(ue);Ee&&y.add(Ee)}y.has(M)&&(z=!0,y.delete(M)),z&&(F[M]=U)}Object.keys(F).length>0&&i({put:F},C)}C(A.data);let O=$["@"],I=o[O];I&&(delete $["#"],delete $["@"],I($),delete o[O])}};k()}),g(C)},he=tt;var rt=(e,t)=>{t||(t=he(e));let r=[],n=!1,o=!1,f=0,y=(a,u,h,v)=>{let x=c=>{f++,y(c,u,h,v)},i=c=>{r=[],f=0,o=!1,v(c)},l=()=>{if(r.length===0){i("Wrong username or password");return}let c=r.shift();t.get({"#":c},async s=>{if(s.err){i(`error getting ${c}: ${s.err}`);return}let p=s.put&&s.put[c];if(!p||!p.auth)return l();let E=JSON.parse(p.auth),w=await L.work(u,E.salt),b=await L.decrypt(E.enc,w);if(!b)return l();if(d.is={username:a,pub:p.pub,epub:p.epub,priv:b.priv,epriv:b.epriv},h!==""){let j=N.random(64),_=await L.work(h,j),C=await L.encrypt(b,_),T={username:a,pub:p.pub,epub:p.epub,auth:JSON.stringify({enc:C,salt:j})},k=await L.sign(T,d.is),S=Q(c,k.m,k.s,p.pub);t.put(S,m=>{i(m?`error putting ${T} on ${c}: ${m}`:null)});return}return i(null)},{wait:1e3})};if(f>9){i("Wrong username or password");return}let g="~@"+a;t.get({"#":g},async c=>{if(c.err){i(`error getting ${g}: ${c.err}`);return}let s=c.put&&c.put[g];if(!s)return x(a);delete c.put[g]._,r=Object.keys(s),l()},{wait:1e3})},d={create:(a,u,h)=>{let v=i=>{h?h(i):console.log(i)};if(n){v("User is already being created");return}if(a===""){v("Please provide a username");return}if(u===""){v("Please provide a password");return}n=!0;let x="~@"+a;t.get({"#":x},async i=>{if(i.err){n=!1,v(`error getting ${x}: ${i.err}`);return}if(i.put&&i.put[x]){n=!1,v("Username already exists");return}let l=N.random(64),g=await L.work(u,l),c=await L.pair(),s={priv:c.priv,epriv:c.epriv},p=await L.encrypt(s,g),E={username:a,pub:c.pub,epub:c.epub,auth:JSON.stringify({enc:p,salt:l})},w="~"+c.pub,b=await L.sign(E,c),j=Q(w,b.m,b.s,c.pub);t.put(j,_=>{if(n=!1,_){v(`error putting ${E} on ${w}: ${_}`);return}let C={[w]:{"#":w}};t.put(Q(x,C),T=>{if(T){v(`error putting ${C} on ${x}: ${T}`);return}h&&h(null)})})},{wait:1e3})},auth:(a,u,h)=>{let v=x=>{h?h(x):x&&console.log(x)};if(o){v("User is already authenticating");return}if(d.is=null,a===""){v("Please provide a username");return}if(u===""){v("Please provide a password");return}o=!0,y(a,u,"",v)},change:(a,u,h,v)=>{let x=i=>{v?v(i):i&&console.log(i)};if(o){x("User is already authenticating");return}if(d.is=null,a===""){x("Please provide a username");return}if(u===""){x("Please provide a password");return}if(h===""){x("Please provide a new password");return}o=!0,y(a,u,h,x)},store:a=>{if(!d.is){console.log("Please authenticate before calling store");return}if(a){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let a=globalThis.localStorage.getItem("user.is");if(a){d.is=JSON.parse(a);return}}if(typeof globalThis.sessionStorage<"u"){let a=globalThis.sessionStorage.getItem("user.is");a&&(d.is=JSON.parse(a))}},leave:()=>{d.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(a,u,h)=>{let v=x=>{h?h(x):console.log(x)};if(o){v("User is already authenticating");return}if(a===""){v("Please provide a username");return}if(u===""){v("Please provide a password");return}o=!0,y(a,u,"",async x=>{if(x){v(x);return}let i={username:null,pub:null,epub:null,auth:null},l=await L.sign(i,d.is),g="~"+d.is.pub,c=Q(g,l.m,l.s,d.is.pub);t.put(c,s=>{if(s){v(`error putting null on ${g}: ${s}`);return}d.is=null,h&&h(null)})})}};return d},Be=rt;var nt=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:B.is(e)||(e={});let t=he(e),r=Be(null,t),n=new Map,o=new Map,f=a=>a===null||a===!0||a===!1||typeof a=="string"||R.is(a)||le.is(a),y=a=>{if(f(a))return!0;if(B.is(a)){let h=[];for(let[v,x]of Object.entries(a)){if(v==="_")return"error underscore cannot be used as a property name";if(B.is(x)||f(x)){h.push(v);continue}return typeof x>"u"?`error undefined ${v} cannot be converted to a graph`:`error ${JSON.stringify({[v]:x})} cannot be converted to a graph`}if(h.length!==0)return h}return`error ${JSON.stringify(a)} cannot be converted to a graph`},d=a=>{let u=(i,l,g,c)=>{t.get(B.put(i,"#",l),async s=>{if(s.err&&console.log(s.err),s.put&&s.put[l]){delete s.put[l]._,delete s.put[l][H],delete s.put[l][q];for(let p of Object.keys(s.put[l])){let E=R.is(s.put[l][p]);if(E){let w=await new Promise(b=>{let j=N.random();o.set(j,{chain:[{item:null,soul:E}]}),d(j).next(null,b,c)});s.put[l][p]=w}}g(s.put[l])}else g(null)},c)},h=async(i,l,g,c)=>{if(g){let s=await L.sign(l,g);return Q(i,s.m,s.s,g.pub)}return e.secure?(c||(c=console.log),c(`error putting data on ${i}: user required in secure mode`),null):Q(i,l)},v=i=>l=>{let g=o.get(i);g&&typeof g.cb<"u"?setTimeout(()=>g.cb(l),1):l&&console.log("error no callback for data",l,"ctx",g),g&&!g.on&&o.delete(i)},x=(i,l)=>{if(!i){console.log("error resolve request parameter required");return}let g=typeof i.get<"u",c=typeof i.put<"u",s=typeof i.on<"u",p=typeof i.off<"u",E=!1,w=o.get(a);for(var b=1;b<w.chain.length;b++)if(w.chain[b].soul===null){E=!0;break}if(E){let{item:j,soul:_}=w.chain[b-1],C=w.user||e.secure?{"#":_}:{"#":_,".":j};return t.get(C,async T=>{if(T.err){w.user||e.secure?console.log(`error getting ${_}: ${T.err}`):console.log(`error getting ${j} on ${_}: ${T.err}`),l&&l(null);return}let k=T.put&&T.put[_];if(k&&typeof k[j]<"u"){let S=R.is(k[j]);if(S)w.chain[b].soul=S,o.set(a,{...w}),g?d(a).next(null,i.get,l,i._opt):c?d(a).put(i.put,l):s?d(a).on(i.on,l,i._get,i._opt):p&&d(a).off(l);else if(g)l(k[j]);else if(c){S=N.random(),k[j]=R.ify(S);let m=await h(_,k,w.user,l);if(m===null)return;t.put(m,A=>{if(A){l(`error putting ${j} on ${_}: ${A}`);return}w.chain[b].soul=S,d(a).put(i.put,l)})}else(s||p&&l)&&l(null)}else if(c){let S=N.random();k||(k={}),k[j]=R.ify(S);let m=await h(_,k,w.user,l);if(m===null)return;t.put(m,A=>{if(A){l(`error putting ${j} on ${_}: ${A}`);return}w.chain[b].soul=S,d(a).put(i.put,l)})}else l&&l(null)},i._opt),!1}return g&&w.chain[w.chain.length-1].item!==null?(w.chain.push({item:null,soul:null}),d(a).next(null,i.get,l,i._opt),!1):w.chain[w.chain.length-1]};return{get:(i,l,g,c)=>{if(typeof l=="function"&&(c=g,g=l,l=null),i===null||i===""||i==="_"){console.log("error please provide a key"),g&&g(null);return}if(l&&typeof g!="function"){console.log("error lex requires a callback function");return}if(a=N.random(),o.set(a,{chain:[{item:i,soul:"root"}],cb:g}),!g)return d(a);let s=v(a),{soul:p}=x({get:l,_opt:c},s);p&&u(l,p,s,c)},next:(i,l,g,c)=>{let s=b=>j=>{g?g(j):v(b)(j)};if(typeof l=="function"&&(c=g,g=l,l=null),!a){console.log("error please provide a key using get(key)"),g&&g(null);return}let p=s(a);if(i===""||i==="_"){p(null);return}if(l&&typeof g!="function"){console.log("error lex requires a callback function");return}let E=o.get(a);if(!E)return;if(g&&typeof E.cb>"u"&&(E.cb=g,g=null),i!==null&&E.chain.push({item:i,soul:null}),!E.cb)return d(a);let{soul:w}=x({get:l,_opt:c},p);w&&u(l,w,p,c)},put:(i,l,g)=>{typeof l=="function"&&(g=l,l=!1);let c=_=>C=>{g?g(C):v(_)(C)};if(!a){g&&g("error please provide a key using get(key)");return}let s=o.get(a);if(!s)return;if(!s.cb){if(!g)return;s.cb=g,g=null}l&&(i={[N.random()]:i});let p=c(a),E=y(i);if(typeof E=="string"){p(E);return}let{item:w,soul:b}=x({put:i},p);if(!b)return;if(E===!0){let _=s.user||e.secure?{"#":b}:{"#":b,".":w};t.get(_,async C=>{if(C.err){p(`error getting ${b}: ${C.err}`);return}let T=C.put&&C.put[b],k=T&&T[w],S=R.is(k);if(!S){T||(T={}),T[w]=i;let m=await h(b,T,s.user,p);if(m===null)return;t.put(m,p);return}t.get({"#":S},async m=>{if(m.err){p(`error getting ${S}: ${m.err}`);return}if(!m.put||!m.put[S]){p(`error ${S} not found`);return}for(let $ of Object.keys(m.put[S])){if($==="_"||$===H||$===q)continue;let O=await new Promise(I=>{let F=N.random(),M=[{item:$,soul:S}];o.set(F,{chain:M,user:s.user}),d(F).put(null,I)});if(O){p(O);return}}T||(T={}),T[w]=i;let A=await h(b,T,s.user,p);A!==null&&t.put(A,p)})});return}let j=s.user||e.secure?{"#":b}:{"#":b,".":w};t.get(j,async _=>{if(_.err){p(`error getting ${b}.${w}: ${_.err}`);return}let C=_.put&&_.put[b],T=C&&C[w],k=R.is(T);if(!k){C||(C={}),C[w]=R.ify(N.random());let m=await h(b,C,s.user,p);if(m===null)return;t.put(m,A=>{if(A)p(`error putting ${w} on ${b}: ${A}`);else{let $=N.random(),O=[{item:w,soul:b}];o.set($,{chain:O,user:s.user,cb:s.cb}),d($).put(i)}});return}let S=[];for(let m of E){let A=await new Promise($=>{if(B.is(i[m])&&!R.is(i[m])){let O=N.random(),I=[{item:m,soul:k}];o.set(O,{chain:I,user:s.user}),d(O).put(i[m],$)}else S.push(m),$(null)});if(A){p(A,a);return}}if(S.length===0){p(null);return}t.get({"#":k},async m=>{if(m.err){p(`error getting ${k}: ${m.err}`);return}let A=m.put&&m.put[k];A||(A={}),S.forEach(O=>{A[O]=i[O]});let $=await h(k,A,s.user,p);$!==null&&t.put($,p)})})},on:(i,l,g,c)=>{if(typeof i=="function"&&(c=g,g=l,l=i,i=null),typeof l!="function"){console.log("error on() requires a callback function");return}if(!a){console.log("error please provide a key using get(key)"),l(null);return}let{item:s,soul:p}=x({on:i,_get:g,_opt:c},l);p&&(o.set(a,{chain:[{item:s,soul:p}],on:!0}),n.set(l,()=>d(a).next(null,l,c)),t.get({"#":p,".":s},E=>{if(E.err){console.log(`error getting ${p}.${s}: ${E.err}`);return}let w=E.put&&E.put[p]&&E.put[p][s],b=R.is(w);b?i?i=B.put(i,"#",b):i={"#":b,".":null}:i?i=B.put(i,"#",p):i={"#":p,".":s},t.on(i,n.get(l),g,c)},c))},off:i=>{if(!a){console.log("error please provide a key using get(key)"),i&&i(null);return}let{item:l,soul:g}=x({off:!0},i);g&&t.get({"#":g,".":l},c=>{if(c.err){console.log(`error getting ${g}.${l}: ${c.err}`);return}let s=c.put&&c.put[g]&&c.put[g][l],p=R.is(s);p?t.off({"#":p},n.get(i)):t.off({"#":g},n.get(i)),n.delete(i),o.delete(a)})},user:()=>(r.get||(Object.assign(r,d()),r.get=(i,l,g,c)=>{typeof l=="function"&&(c=g,g=l,l=null);let s=null,p=null;if(r.is&&(s=r.is.pub),typeof i=="string"?p=i:i instanceof Array&&(i.length===2?(s=i[0],p=i[1]):i.length===1&&(p=i[0])),!s){console.log("error please log in or provide a public key"),g&&g(null);return}if(p===null||p===""||p==="_"){console.log("error please provide a key"),g&&g(null);return}if(l&&!g){console.log("error lex requires a callback function");return}a=N.random();let E=[{item:p,soul:"~"+s}];if(o.set(a,{chain:E,user:r.is,cb:g}),!g)return d(a);let w=v(a),{soul:b}=x({get:l,_opt:c},w);b&&u(l,b,w,c)}),r),wire:t,SEA:L}};return d()},Mt=nt;export{Mt as default};
//# sourceMappingURL=holster.js.map
