var V={is:e=>!(e instanceof Array)&&(e-parseFloat(e)+1>=0||e===1/0||e===-1/0)},K={is:e=>e?e instanceof Object&&e.constructor===Object||Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/)[1]==="Object":!1,map:(e,t,o)=>{var n=Object.keys(e);for(let r=0;r<n.length;r++){let u=t(e[n[r]],n[r],o);if(typeof u<"u")return u}},put:(e,t,o)=>(e||(e={}),e[t]=o,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Oe=(e,t,o)=>{if(o.id){o.id=!1;return}if(t==="#"&&typeof e=="string"){o.id=e;return}o.id=!1},P={is:e=>{if(e&&e["#"]&&!e._&&K.is(e)){let t={};if(K.map(e,Oe,t),t.id)return t.id}return!1},ify:e=>K.put({},"#",e)},M="_holster_user_signature",U="_holster_user_public_key",H=(e,t,o,n)=>{let r={[e]:{_:{"#":e,">":{}}}};for(let[u,a]of Object.entries(t))u!=="_"&&u!=U&&u!=M&&(r[e][u]=a,r[e]._[">"][u]=Date.now());return o&&n&&(r[e][M]=o,r[e]._[">"][M]=Date.now(),r[e][U]=n,r[e]._[">"][U]=Date.now()),r},q=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!K.is(e)||!t)return!1;let o=e["*"];if(o)return t.slice(0,o.length)===o;let n=e[">"],r=e["<"];return n&&r?t>=n&&t<=r:n?t>=n:r?t<=r:!1},T={random:e=>{var t="";let o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let n=0;n<e;n++)t+=o.charAt(Math.floor(Math.random()*o.length));return t}};var xe=e=>{e||(e=9e3);let t={store:{}};return t.check=o=>t.store[o]?t.track(o):!1,t.track=o=>(t.store[o]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{let n=Date.now();Object.keys(t.store).forEach(r=>{n-t.store[r]>e&&delete t.store[r]}),t.expiry=null},e)),o),t},ge=xe;var _e=(e,t)=>{let o=e["#"];if(!t[o])return;let n={_:{"#":o,">":{}}};if(typeof e["."]=="string"){let r=e["."];if(typeof t[o][r]>"u")return;n[r]=t[o][r],n._[">"][r]=t[o]._[">"][r]}else for(let r of Object.keys(t[o]))q(e["."],r)&&(n[r]=t[o][r],n._[">"][r]=t[o]._[">"][r]);return{[o]:n}},ue=_e;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function ee(){}Object.assign(ee,{from:Array.from});ee.prototype=Object.create(Array.prototype);ee.prototype.toString=function(e,t,o){e||(e="utf8"),t||(t=0);let n=this.length;if(e==="hex"){let r=new Uint8Array(this);return[...Array((o&&o+1||n)-t).keys()].map(u=>r[u+t].toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:(o||n)-t},(r,u)=>String.fromCharCode(this[u+t])).join("");if(e==="base64")return btoa(this)};var R=ee;function L(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),L.from(...e)}L.prototype=Object.create(Array.prototype);Object.assign(L,{from(){if(!Object.keys(arguments).length||arguments[0]==null)throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.");let e=arguments[0],t;if(typeof e=="string"){let n=arguments[1]||"utf8";if(n==="hex"){let r=e.match(/([\da-fA-F]{2})/g).map(u=>parseInt(u,16));if(!r||!r.length)throw new TypeError("Invalid first argument for type 'hex'.");t=R.from(r)}else if(n==="utf8"||n==="binary"){let r=e.length,u=new Uint16Array(r);Array.from({length:r},(a,l)=>u[l]=e.charCodeAt(l)),t=R.from(u)}else if(n==="base64"){let r=atob(e),u=r.length,a=new Uint8Array(u);Array.from({length:u},(l,i)=>a[i]=r.charCodeAt(i)),t=R.from(a)}else console.info("SafeBuffer.from unknown encoding: "+n);return t}if(e.byteLength?e.byteLength:e.length){let n;return e instanceof ArrayBuffer&&(n=new Uint8Array(e)),R.from(n||e)}},alloc(e,t=0){return R.from(new Uint8Array(Array.from({length:e},()=>t)))},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be Array containing ArrayBuffer or Uint8Array instances.");return R.from(e.reduce((t,o)=>t.concat(Array.from(o)),[]))}});L.prototype.from=L.from;L.prototype.toString=R.prototype.toString;var W=L;var Ee=typeof document>"u",de=Ee?(await import("node:crypto")).webcrypto:globalThis.crypto,E=de.subtle,te=e=>typeof e=="string"?e:JSON.stringify(e),Z=e=>{try{return JSON.parse(e)}catch{return e}},re=e=>{let t=new Uint8Array(W.alloc(e));return W.from(de.getRandomValues(t))},Y=(e,t)=>{let[o,n]=e.split(".");return{kty:"EC",crv:"P-256",x:o,y:n,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},ne=async e=>{let t=await E.digest({name:"SHA-256"},new TextEncoder().encode(te(e)));return W.from(t)},fe=async(e,t)=>{let o=e+t.toString("utf8"),n=W.from(await ne(o),"binary"),r=Te(n);return await E.importKey("jwk",r,{name:"AES-GCM"},!1,["encrypt","decrypt"])},Te=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var Ke={pair:async e=>{let t=await E.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async r=>{let u=await E.exportKey("jwk",r.publicKey);return{priv:(await E.exportKey("jwk",r.privateKey)).d,pub:u.x+"."+u.y}}),o=await E.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async r=>{let u=await E.exportKey("jwk",r.publicKey);return{epriv:(await E.exportKey("jwk",r.privateKey)).d,epub:u.x+"."+u.y}}),n={pub:t.pub,priv:t.priv,epub:o.epub,epriv:o.epriv};return e&&e(n),n},encrypt:async(e,t,o)=>{if(!t||!t.epriv)return o&&o(null),null;let n={s:re(9),iv:re(15)},r=await fe(t.epriv,n.s).then(a=>E.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},a,new TextEncoder().encode(te(e)))),u={ct:W.from(r,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return o&&o(u),u},decrypt:async(e,t,o)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return o&&o(null),null;let n={ct:W.from(e.ct,"base64"),iv:W.from(e.iv,"base64"),s:W.from(e.s,"base64")};try{let r=await fe(t.epriv,n.s).then(a=>E.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},a,new Uint8Array(n.ct))),u=Z(new TextDecoder("utf8").decode(r));return o&&o(u),u}catch{return o&&o(null),null}},verify:async(e,t,o)=>{if(!t||!t.pub)return o&&o(null),null;let n=Z(e),r=await E.importKey("jwk",Y(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),u={};if(typeof n.m=="string")u=n.m;else for(let g of Object.keys(n.m).sort())g!=="_"&&g!=U&&g!=M&&(u[g]=n.m[g]);let a=await ne(u),l=new Uint8Array(W.from(n.s,"base64")),i={name:"ECDSA",hash:{name:"SHA-256"}};if(await E.verify(i,r,l,new Uint8Array(a))){let g=Z(n.m);return o&&o(g),g}return o&&o(null),null},sign:async(e,t,o)=>{if(!t||!t.pub||!t.priv)return o&&o(null),null;let n={};if(typeof e=="string")n=e;else{let g=Z(e);for(let h of Object.keys(g).sort())h!=="_"&&h!=U&&h!=M&&(n[h]=g[h])}let r=await ne(n),u=Y(t.pub,t.priv),a={name:"ECDSA",namedCurve:"P-256"},l=await E.importKey("jwk",u,a,!1,["sign"]).then(g=>E.sign({name:"ECDSA",hash:{name:"SHA-256"}},g,new Uint8Array(r))),i={m:n,s:W.from(l,"binary").toString("base64")};return o&&o(i),i},work:async(e,t,o)=>{typeof t=="function"&&(o=t,t=void 0),typeof t>"u"&&(t=re(9));let n=await E.importKey("raw",new TextEncoder().encode(te(e)),{name:"PBKDF2"},!1,["deriveBits"]),r={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},u=await E.deriveBits(r,n,512),a={epriv:W.from(u,"binary").toString("base64")};return o&&o(a),a},secret:async(e,t,o)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return o&&o(null),null;let n={name:"ECDH",namedCurve:"P-256"},r=Y(e.epub),u=await E.importKey("jwk",r,n,!0,[]),a=Y(t.epub,t.epriv,!1);delete a.key_ops;let l=await E.importKey("jwk",a,n,!1,["deriveBits"]).then(async i=>{let g=await E.deriveBits({public:u,name:"ECDH",namedCurve:"P-256"},i,256),h=await E.importKey("raw",new Uint8Array(g),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return E.exportKey("jwk",h).then(({k:m})=>m)});return o&&o({epriv:l}),{epriv:l}}},B=Ke;var le=(e,t,o,n)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof o!="string"&&(o=JSON.stringify(o)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),o===n?{state:!0}:o<n?{current:!0}:{incoming:!0});le.mix=async(e,t,o,n)=>{let r=Date.now(),u={},a={},l=0;for(let i of Object.keys(e)){let g=e[i],h=!1,m=!1,w=0,s=o;if(!g||!g._)continue;let f=g[M],c=g[U];if(f&&c&&(s=!0),i.length>1&&i[0]==="~")if(i[1]==="@")m=!0,s=!1;else{if(c&&i!="~"+c){console.log(`error public key does not match for soul: ${i}`);continue}s=!0}if(!(s&&(!f||!c||!await B.verify({m:g,s:f},{pub:c})))){for(let p of Object.keys(g)){if(p==="_")continue;let d=g[p],y=g._&&g._[">"]?g._[">"][p]:0,S=(t[i]||{})[p],b=(t[i]||{_:{">":{}}})._[">"][p]||0;if(m&&p!==P.is(d)){console.log(`error alias ${m}: ${p} !== ${P.is(d)}`);continue}let v=y-r;if(v>0){if(v>864e5)continue;(l===0||v<l)&&(l=w=v),a[i]||(a[i]={_:{"#":i,">":{}}}),a[i][p]=d,a[i]._[">"][p]=y}else le(y,b,d,S).incoming&&(u[i]||(u[i]={_:{"#":i,">":{}}}),t[i]||(t[i]={_:{"#":i,">":{}}}),t[i][p]=u[i][p]=d,t[i]._[">"][p]=u[i]._[">"][p]=y,n[i]&&setTimeout(()=>{n[i]&&n[i].filter(j=>q(j["."],p)).forEach(j=>j.cb())},100),h=!0)}s&&w!==0&&u[i]&&(Object.assign(a[i],u[i]),delete u[i]),h&&n[i]&&setTimeout(()=>{n[i]&&n[i].filter(p=>q(p["."])).forEach(p=>p.cb())},100)}}return{now:u,defer:a,wait:l}};var ae=le;var F="",X="",ye=()=>{let e=(t,o,n)=>{if(n||(e[F]||(e[F]={}),n=e[F]),!t)return n;let r=0,u={},a=t[r],l=t.length-1,i=typeof o>"u",g=n[a];for(;!g&&r<l;)a+=t[++r],g=n[a];if(g)if(r===l){if(i)return typeof g[X]>"u"?g[F]:g[X];g[X]=o}else return!g[F]&&!i&&(g[F]={}),e(t.slice(++r),o,g[F]);else if(K.map(n,(m,w)=>{let s=0,f="";for(;w[s]===t[s];)f+=w[s++];if(f){if(i)return s<=l?void 0:(u[w.slice(s)]=m,m);let c={[w.slice(s)]:m,[t.slice(s)]:{[X]:o}};return n[f]={[F]:c},delete n[w],!0}})){if(i)return u}else{if(i)return;n[a]||(n[a]={}),n[a][X]=o}};return e};ye.map=function e(t,o,n,r){r||(r=[]);var u=t[F]||t,a=Object.keys(u).sort(),l;for(let i=0;i<a.length;i++){let g=a[i],h=u[g],m=h[X];if(typeof m<"u"){if(m=o(m,r.join("")+g,g,r),typeof m<"u")return m}else n&&o(l,r.join(""),g,r);if(h[F]){if(r.push(g),m=e(h[F],o,n,r),typeof m<"u")return m;r.pop()}}};var D=ye;var me="",he="",N="",Q=e=>{var t,o=null;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=10*1e3),e.write||(e.write=1),e.size||(e.size=1024*1024),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let n=(r,u,a)=>{if(r=""+r,typeof u=="function")return a=u,u=n.batch(r),typeof u<"u"||n.thrash.at&&(u=n.thrash.at(r),typeof u<"u")?a(t,u):n.read(r,a);if(n.batch(r,u),a&&n.batch.acks.push(a),++n.batch.ed>=e.batch)return n.thrash();clearTimeout(n.batch.timeout),n.batch.timeout=setTimeout(n.thrash,e.write)};return n.batch=D(),n.batch.acks=[],n.batch.ed=0,n.thrash=()=>{if(n.thrash.ing)return n.thrash.more=!0;clearTimeout(n.batch.timeout),n.thrash.more=!1,n.thrash.ing=!0;var r=n.thrash.at=n.batch;n.batch=null,n.batch=D(),n.batch.acks=[],n.batch.ed=0;let u=0;n.save(r,a=>{++u>1||(a&&e.log(a),r.acks.forEach(l=>l(a)),n.thrash.at=null,n.thrash.ing=!1,n.thrash.more&&n.thrash())})},n.save=(r,u)=>{let a={find:(l,i)=>{if(!(i<a.start))return a.start=i,e.store.list(a.lex),!0},lex:l=>{if(!l||l>a.start)return a.end=l,a.mix(a.file||"!",a.start,a.end),!0;a.file=l},mix:(l,i,g)=>{a.start=a.end=a.file=t,n.parse(l,(h,m)=>{if(h)return u(h);D.map(r,(w,s)=>{if(!(s<i)){if(g&&g<s)return a.start=s,a.start;m(s,w)}}),n.write(l,m,a.next)})},next:l=>{if(l)return u(l);if(a.start)return D.map(r,a.find);u(l)}};D.map(r,a.find)},n.write=(r,u,a)=>{o=null;let l={text:"",count:0,file:r,each:(i,g,h,m)=>{l.count++;var w=Q.encode(m.length)+"#"+Q.encode(h)+(typeof i>"u"?"":"="+Q.encode(i))+`
`;if(l.count>1&&l.text.length+w.length>e.size)return l.text="",l.limit=Math.ceil(l.count/2),l.count=0,l.sub=D(),D.map(u,l.slice),!0;l.text+=w},put:()=>{e.store.put(r,l.text,a)},slice:(i,g)=>{if(!(g<l.file)){if(++l.count>l.limit){var h=l.file;let m=g.indexOf(he);return m===-1?l.file=g:l.file=g.substring(0,m),l.sub(l.file,null),l.count=0,n.write(h,l.sub,l.next),!0}l.sub(g,i)}},next:i=>{if(i)return a(i);l.sub=D(),D.map(u,l.slice)||n.write(l.file,l.sub,a)}};D.map(u,l.each,!0)||l.put()},n.read=(r,u)=>{if(o){let g=o(r);if(typeof g<"u")return u(t,g)}let a=r,l=r.indexOf(he);l!==-1&&(a=r.substring(0,l));let i={lex:g=>{if(!g){if(!i.file){u("no file found",t);return}n.parse(i.file,i.it);return}g>a||g<i.file||(i.file=g)},it:(g,h)=>{g&&e.log(g),h&&(o=h,i.value=h(r)),u(g,i.value)}};e.store.list(i.lex)},n.parse=(r,u)=>{let a={disk:D(),read:(l,i)=>{if(l)return u(l);if(!i)return u(t,a.disk);let g=[],h=a.split(i);for(;h;){let m,w,s=h[1];h=a.split(h[2])||"",h[0]==="#"&&(m=h[1],g=g.slice(0,s),s<=g.length&&g.push(m)),h=a.split(h[2])||"",h[0]!==`
`&&(h[0]==="="&&(w=h[1]),typeof m<"u"&&typeof w<"u"&&a.disk(g.join(""),w),h=a.split(h[2]))}u(t,a.disk)},split:l=>{if(!l)return;let i=-1,g="",h=null;for(;(h=l[++i])&&h!==N;)g+=h;let m={};if(h)return[g,Q.decode(l.slice(i),m),l.slice(i+m.i)]}};e.store.get(r,a.read)},n};Q.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=me+e[1],e=e[0]),typeof e=="string"){let n=0,r=null,u=N;for(;r=e[n++];)r===N&&(u+=N);return u+'"'+e+t+N}let o=P.is(e);if(o)return N+"#"+o+t+N;if(V.is(e))return N+"+"+(e||0)+t+N;if(e===!0)return N+"+"+t+N;if(e===!1)return N+"-"+t+N;if(e===null)return N+" "+t+N};Q.decode=(e,t)=>{var o="",n=-1,r=0,u=null,a=null;if(e[0]!==N)return;for(;u=e[++n];)if(a){if(u===N&&--r<=0)break;o+=u}else u===N?r++:a=u||!0;t&&(t.i=n+1);let[l,i]=o.split(me);if(i){if(i=parseFloat(i),a==='"')return[l,i];if(a==="#")return[P.ify(l),i];if(a==="+")return l.length===0?[!0,i]:[parseFloat(l),i];if(a==="-")return[!1,i];if(a===" ")return[null,i]}else{if(a==='"')return o;if(a==="#")return P.ify(o);if(a==="+")return o.length===0?!0:parseFloat(o);if(a==="-")return!1;if(a===" ")return null}};var we=Q;var Se=typeof document>"u",G=Se?await import("node:fs"):void 0,be="",ie="",ce=ie+"+0"+ie+"#"+ie+'"root'+ie,Pe=e=>{let t=e.file;if(Se)return G.existsSync(t)||G.mkdirSync(t),G.existsSync(t+"/!")||G.writeFileSync(t+"/!",ce),{get:(o,n)=>{G.readFile(t+"/"+o,(r,u)=>{if(r){if(r.code==="ENOENT"){n();return}console.log("fs.readFile error:",r)}u&&(u=u.toString()),n(r,u)})},put:(o,n,r)=>{var u=Math.random().toString(36).slice(-9),a=o+"."+u+".tmp";G.writeFile(a,n,l=>{if(l){r(l);return}G.rename(a,t+"/"+o,r)})},list:o=>{G.readdir(t,(n,r)=>{r.forEach(o),o()})}};if(e.indexedDB){let o,n=indexedDB.open(t,1);return n.onupgradeneeded=r=>{r.target.result.createObjectStore(t)},n.onerror=r=>{console.log(r)},n.onsuccess=()=>{if(o=n.result,o){let u=o.transaction([t],"readonly").objectStore(t).getKey("!");u.onerror=()=>{console.log(`error getting key ${t}/!`)},u.onsuccess=()=>{if(!u.result){let l=o.transaction([t],"readwrite").objectStore(t).put(ce,"!");l.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(r,u)=>{if(o){let l=o.transaction([t],"readonly").objectStore(t).get(r);l.onerror=()=>{console.log(`error getting ${t}/${r}`)},l.onsuccess=()=>{u(null,l.result)}}else u("error indexedDB not available")},put:(r,u,a)=>{if(o){let i=o.transaction([t],"readwrite").objectStore(t).put(u,r);i.onerror=()=>{console.log(`error putting data on ${t}/${r}`)},i.onsuccess=()=>{a(null)}}else a("error indexedDB not available")},list:r=>{if(o){let a=o.transaction([t],"readonly").objectStore(t).getAllKeys();a.onerror=()=>console.log("error getting keys for",t),a.onsuccess=()=>{a.result.forEach(r),r()}}else console.log("error indexedDB not available"),r()}}}return{get:(o,n)=>{n(null,ce)},put:(o,n,r)=>{r(null)},list:o=>{o("!"),o()}}},Ne=e=>{K.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Pe(e));let t=we(e);return{get:(o,n)=>{if(!o){n("lex required");return}var r=o["#"],u=typeof o["."]=="string"?o["."]:"",a;let l=(i,g)=>{q(o["."],g)&&(a||(a={_:{"#":r,">":{}}}),a[g]=i[0],a._[">"][g]=i[1])};t(r+be+u,(i,g)=>{let h;K.is(g)?(D.map(g,l),a||l(g,u),h={[r]:a}):g&&(l(g,u),h={[r]:a}),n(i,h)})},put:(o,n)=>{if(!o){n("graph required");return}var r=0;let u=a=>{if(r--,!u.err){if(u.err=a,u.err){n(u.err);return}r===0&&n(null)}};Object.keys(o).forEach(a=>{var l=o[a];Object.keys(l).forEach(i=>{if(i==="_")return;r++;let g=l[i],h=l._[">"][i];t(a+be+i,[g,h],u)})})}}},ve=Ne;var ke=typeof document>"u",je=ke?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=je?.WebSocket);var Be=e=>{let t=ge(e.maxAge),o=ve(e),n={},r={},u={},a=async(s,f,c)=>{for(let p of Object.keys(s)){let d=await new Promise(b=>{g({"#":p},b,f)});if(d.err)return c&&c(d.err),!1;let y=s[p],S=U;if(!(!d.put||!d.put[p]||d.put[p][S]===y[S]))return c&&c(`error in wire check public key does not match for soul: ${p}`),!1}return!0},l=(s,f)=>{let c=ue(s.get,n);c?f(JSON.stringify({"#":t.track(T.random(9)),"@":s["#"],put:c})):o.get(s.get,(p,d)=>{f(JSON.stringify({"#":t.track(T.random(9)),"@":s["#"],put:d,err:p}))})},i=async(s,f)=>{let c=await ae.mix(s.put,n,e.secure,u);if(Object.keys(c.now).length){if(!await a(c.now,f))return;o.put(c.now,p=>{f(JSON.stringify({"#":t.track(T.random(9)),"@":s["#"],err:p}))})}Object.keys(c.defer).length&&setTimeout(()=>i({put:c.defer},f),c.wait)},g=(s,f,c,p)=>{if(!f)return;K.is(p)||(p={});let d=ue(s,n),y=T.random(9),S=JSON.stringify({"#":t.track(y),get:e.secure?{"#":s["#"]}:s});if(d){c(S),f({put:d});return}o.get(s,(b,v)=>{if(v){c(S),f({put:v,err:b});return}b&&console.log(b),r[y]=f,c(S),setTimeout(()=>{let $=r[y];if($){let j=s["#"],A={[j]:null};typeof s["."]=="string"&&(A[j]={[s["."]]:null}),$({put:A}),delete r[y]}},p.wait||100)})},h=s=>({get:(f,c,p)=>{g(f,c,s,p)},put:async(f,c)=>{let p=await ae.mix(f,n,e.secure,u);Object.keys(p.now).length===0||!await a(p.now,s,c)||(o.put(p.now,c),s(JSON.stringify({"#":t.track(T.random(9)),put:f})))},on:(f,c,p,d)=>{let y=f&&f["#"];!y||!c||(u[y]?u[y].push({".":f["."],cb:c}):u[y]=[{".":f["."],cb:c}],p&&g(f,c,s,d))},off:(f,c)=>{let p=f&&f["#"];if(!(!p||!u[p]))if(c){let d=u[p].find(y=>y.cb===c);d&&u[p].splice(u[p].indexOf(d),1)}else delete u[p]}});if(ke){let s=e.wss,f=()=>s.clients();if(!s){let p=e.server?{server:e.server}:{port:e.port||8765};s=new je.WebSocketServer(p),f=()=>s.clients}let c=(p,d)=>{f().forEach(y=>{y.readyState===WebSocket.OPEN&&y.send(p,{binary:d})})};return s.on("connection",p=>{p.on("error",console.error),p.on("message",(d,y)=>{let S=JSON.parse(d);if(t.check(S["#"]))return;t.track(S["#"]),S.get&&l(S,c),S.put&&i(S,c),c(d,y);let b=S["@"],v=r[b];v&&(delete S["#"],delete S["@"],v(S),delete r[b])})}),h(c)}let m=[],w=s=>{m.forEach(f=>{f&&f.readyState===WebSocket.OPEN?f.send(s):console.log("websocket not available")})};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(s=>{let f=new WebSocket(s);m.push(f);let c=()=>{f||(f=new WebSocket(s)),f.onclose=p=>{m.indexOf(f)!==-1&&m.splice(m.indexOf(f),1),f=null,setTimeout(c,Math.floor(Math.random()*5e3))},f.onerror=p=>{console.error(p)},f.onmessage=p=>{let d=JSON.parse(p.data);if(t.check(d["#"]))return;t.track(d["#"]),d.get&&l(d,w),d.put&&i(d,w),w(p.data);let y=d["@"],S=r[y];S&&(delete d["#"],delete d["@"],S(d),delete r[y])}};c()}),h(w)},oe=Be;var De=(e,t)=>{t||(t=oe(e));let o=[],n=!1,r=!1,u=0,a=(i,g,h,m)=>{let w=p=>{u++,a(p,g,h,m)},s=p=>{o=[],u=0,r=!1,m(p)},f=()=>{if(o.length===0){s("Wrong username or password");return}let p=o.shift();t.get({"#":p},async d=>{if(d.err){s(`error getting ${p}: ${d.err}`);return}let y=d.put&&d.put[p];if(!y||!y.auth)return f();let S=JSON.parse(y.auth),b=await B.work(g,S.salt),v=await B.decrypt(S.enc,b);if(!v)return f();if(l.is={username:i,pub:y.pub,epub:y.epub,priv:v.priv,epriv:v.epriv},h!==""){let $=T.random(64),j=await B.work(h,$),A=await B.encrypt(v,j),O={username:i,pub:y.pub,epub:y.epub,auth:JSON.stringify({enc:A,salt:$})},x=await B.sign(O,l.is),_=H(p,x.m,x.s,y.pub);t.put(_,k=>{s(k?`error putting ${O} on ${p}: ${k}`:null)});return}return s(null)})};if(u>9){s("Wrong username or password");return}let c="~@"+i;t.get({"#":c},async p=>{if(p.err){s(`error getting ${c}: ${p.err}`);return}let d=p.put&&p.put[c];if(!d)return w(i);delete p.put[c]._,o=Object.keys(d),f()})},l={create:(i,g,h)=>{let m=s=>{h?h(s):console.log(s)};if(n){m("User is already being created");return}if(i===""){m("Please provide a username");return}if(g===""){m("Please provide a password");return}n=!0;let w="~@"+i;t.get({"#":w},async s=>{if(s.err){n=!1,m(`error getting ${w}: ${s.err}`);return}if(s.put&&s.put[w]){n=!1,m("Username already exists");return}let f=T.random(64),c=await B.work(g,f),p=await B.pair(),d={priv:p.priv,epriv:p.epriv},y=await B.encrypt(d,c),S={username:i,pub:p.pub,epub:p.epub,auth:JSON.stringify({enc:y,salt:f})},b="~"+p.pub,v=await B.sign(S,p),$=H(b,v.m,v.s,p.pub);t.put($,j=>{if(n=!1,j){m(`error putting ${S} on ${b}: ${j}`);return}let A={[b]:{"#":b}};t.put(H(w,A),O=>{if(O){m(`error putting ${A} on ${w}: ${O}`);return}h&&h(null)})})})},auth:(i,g,h)=>{let m=w=>{h?h(w):w&&console.log(w)};if(r){m("User is already authenticating");return}if(l.is=null,i===""){m("Please provide a username");return}if(g===""){m("Please provide a password");return}r=!0,a(i,g,"",m)},change:(i,g,h,m)=>{let w=s=>{m?m(s):s&&console.log(s)};if(r){w("User is already authenticating");return}if(l.is=null,i===""){w("Please provide a username");return}if(g===""){w("Please provide a password");return}if(h===""){w("Please provide a new password");return}r=!0,a(i,g,h,w)},store:i=>{if(!l.is){console.log("Please authenticate before calling store");return}if(i){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(l.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(l.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let i=globalThis.localStorage.getItem("user.is");if(i){l.is=JSON.parse(i);return}}if(typeof globalThis.sessionStorage<"u"){let i=globalThis.sessionStorage.getItem("user.is");i&&(l.is=JSON.parse(i))}},leave:()=>{l.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(i,g,h)=>{let m=w=>{h?h(w):console.log(w)};if(r){m("User is already authenticating");return}if(i===""){m("Please provide a username");return}if(g===""){m("Please provide a password");return}r=!0,a(i,g,"",async w=>{if(w){m(w);return}let s={username:null,pub:null,epub:null,auth:null},f=await B.sign(s,l.is),c="~"+l.is.pub,p=H(c,f.m,f.s,l.is.pub);t.put(p,d=>{if(d){m(`error putting null on ${c}: ${d}`);return}l.is=null,h&&h(null)})})}};return l},$e=De;var Je=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:K.is(e)||(e={});let t=oe(e),o=$e(null,t),n=new Map,r=new Map,u=i=>i===null||i===!0||i===!1||typeof i=="string"||P.is(i)||V.is(i),a=i=>{if(u(i))return!0;if(K.is(i)){let h=[];for(let[m,w]of Object.entries(i)){if(m==="_")return"error underscore cannot be used as a property name";if(K.is(w)||u(w)){h.push(m);continue}return typeof w>"u"?`error undefined ${m} cannot be converted to a graph`:`error ${JSON.stringify({[m]:w})} cannot be converted to a graph`}if(h.length!==0)return h}return`error ${JSON.stringify(i)} cannot be converted to a graph`},l=i=>{let g=(s,f,c,p)=>{t.get(K.put(s,"#",f),async d=>{if(d.err&&console.log(d.err),d.put&&d.put[f]){delete d.put[f]._,delete d.put[f][U],delete d.put[f][M];for(let y of Object.keys(d.put[f])){let S=P.is(d.put[f][y]);if(S){let b=await new Promise(v=>{let $=T.random();r.set($,{chain:[{item:null,soul:S}]}),l($).next(null,v)});d.put[f][y]=b}}c(d.put[f])}else c(null)},p)},h=async(s,f,c,p)=>{if(c){let d=await B.sign(f,c);return H(s,d.m,d.s,c.pub)}return e.secure?(p||(p=console.log),p(`error putting data on ${s}: user required in secure mode`),null):H(s,f)},m=s=>f=>{let c=r.get(s);c&&typeof c.cb<"u"?setTimeout(()=>c.cb(f),1):f&&console.log("error no callback for data",f,"ctx",c),c&&!c.on&&r.delete(s)},w=(s,f)=>{if(!s){console.log("error resolve request parameter required");return}let c=typeof s.get<"u",p=typeof s.put<"u",d=typeof s.on<"u",y=typeof s.off<"u",S=!1,b=r.get(i);for(var v=1;v<b.chain.length;v++)if(b.chain[v].soul===null){S=!0;break}if(S){let{item:$,soul:j}=b.chain[v-1],A=b.user||e.secure?{"#":j}:{"#":j,".":$};return t.get(A,async O=>{if(O.err){b.user||e.secure?console.log(`error getting ${j}: ${O.err}`):console.log(`error getting ${$} on ${j}: ${O.err}`),f&&f(null);return}let x=O.put&&O.put[j];if(x&&typeof x[$]<"u"){let _=P.is(x[$]);if(_)b.chain[v].soul=_,r.set(i,{...b}),c?l(i).next(null,s.get,f,s._opt):p?l(i).put(s.put,f):d?l(i).on(s.on,f,s._get,s._opt):y&&l(i).off(f);else if(c)f(x[$]);else if(p){_=T.random(),x[$]=P.ify(_);let k=await h(j,x,b.user,f);if(k===null)return;t.put(k,C=>{if(C){f(`error putting ${$} on ${j}: ${C}`);return}b.chain[v].soul=_,l(i).put(s.put,f)})}else(d||y&&f)&&f(null)}else if(p){let _=T.random();x||(x={}),x[$]=P.ify(_);let k=await h(j,x,b.user,f);if(k===null)return;t.put(k,C=>{if(C){f(`error putting ${$} on ${j}: ${C}`);return}b.chain[v].soul=_,l(i).put(s.put,f)})}else f&&f(null)}),!1}return c&&b.chain[b.chain.length-1].item!==null?(b.chain.push({item:null,soul:null}),l(i).next(null,s.get,f),!1):b.chain[b.chain.length-1]};return{get:(s,f,c,p)=>{if(typeof f=="function"&&(p=c,c=f,f=null),s===null||s===""||s==="_"){console.log("error please provide a key"),c&&c(null);return}if(f&&typeof c!="function"){console.log("error lex requires a callback function");return}if(i=T.random(),r.set(i,{chain:[{item:s,soul:"root"}],cb:c}),!c)return l(i);let d=m(i),{soul:y}=w({get:f,_opt:p},d);y&&g(f,y,d,p)},next:(s,f,c,p)=>{let d=v=>$=>{c?c($):m(v)($)};if(typeof f=="function"&&(p=c,c=f,f=null),!i){console.log("error please provide a key using get(key)"),c&&c(null);return}let y=d(i);if(s===""||s==="_"){y(null);return}if(f&&typeof c!="function"){console.log("error lex requires a callback function");return}let S=r.get(i);if(!S)return;if(c&&typeof S.cb>"u"&&(S.cb=c,c=null),s!==null&&S.chain.push({item:s,soul:null}),!S.cb)return l(i);let{soul:b}=w({get:f,_opt:p},y);b&&g(f,b,y,p)},put:(s,f,c)=>{typeof f=="function"&&(c=f,f=!1);let p=j=>A=>{c?c(A):m(j)(A)};if(!i){c&&c("error please provide a key using get(key)");return}let d=r.get(i);if(!d)return;if(!d.cb){if(!c)return;d.cb=c,c=null}f&&(s={[T.random()]:s});let y=p(i),S=a(s);if(typeof S=="string"){y(S);return}let{item:b,soul:v}=w({put:s},y);if(!v)return;if(S===!0){let j=d.user||e.secure?{"#":v}:{"#":v,".":b};t.get(j,async A=>{if(A.err){y(`error getting ${v}: ${A.err}`);return}let O=A.put&&A.put[v],x=O&&O[b],_=P.is(x);if(!_){O||(O={}),O[b]=s;let k=await h(v,O,d.user,y);if(k===null)return;t.put(k,y);return}t.get({"#":_},async k=>{if(k.err){y(`error getting ${_}: ${k.err}`);return}if(!k.put||!k.put[_]){y(`error ${_} not found`);return}for(let J of Object.keys(k.put[_])){if(J==="_"||J===U||J===M)continue;let I=await new Promise(se=>{let pe=T.random(),Ae=[{item:J,soul:_}];r.set(pe,{chain:Ae,user:d.user}),l(pe).put(null,se)});if(I){y(I);return}}O||(O={}),O[b]=s;let C=await h(v,O,d.user,y);C!==null&&t.put(C,y)})});return}let $=d.user||e.secure?{"#":v}:{"#":v,".":b};t.get($,async j=>{if(j.err){y(`error getting ${v}.${b}: ${j.err}`);return}let A=j.put&&j.put[v],O=A&&A[b],x=P.is(O);if(!x){A||(A={}),A[b]=P.ify(T.random());let k=await h(v,A,d.user,y);if(k===null)return;t.put(k,C=>{if(C)y(`error putting ${b} on ${v}: ${C}`);else{let J=T.random(),I=[{item:b,soul:v}];r.set(J,{chain:I,user:d.user,cb:d.cb}),l(J).put(s)}});return}let _=[];for(let k of S){let C=await new Promise(J=>{if(K.is(s[k])&&!P.is(s[k])){let I=T.random(),se=[{item:k,soul:x}];r.set(I,{chain:se,user:d.user}),l(I).put(s[k],J)}else _.push(k),J(null)});if(C){y(C,i);return}}if(_.length===0){y(null);return}t.get({"#":x},async k=>{if(k.err){y(`error getting ${x}: ${k.err}`);return}let C=k.put&&k.put[x];C||(C={}),_.forEach(I=>{C[I]=s[I]});let J=await h(x,C,d.user,y);J!==null&&t.put(J,y)})})},on:(s,f,c,p)=>{if(typeof s=="function"&&(p=c,c=f,f=s,s=null),typeof f!="function"){console.log("error on() requires a callback function");return}if(!i){console.log("error please provide a key using get(key)"),f(null);return}let{item:d,soul:y}=w({on:s,_get:c,_opt:p},f);y&&(r.set(i,{chain:[{item:d,soul:y}],on:!0}),n.set(f,()=>l(i).next(null,f)),t.get({"#":y,".":d},S=>{if(S.err){console.log(`error getting ${y}.${d}: ${S.err}`);return}let b=S.put&&S.put[y]&&S.put[y][d],v=P.is(b);v?s?s=K.put(s,"#",v):s={"#":v,".":null}:s?s=K.put(s,"#",y):s={"#":y,".":d},t.on(s,n.get(f),c,p)}))},off:s=>{if(!i){console.log("error please provide a key using get(key)"),s&&s(null);return}let{item:f,soul:c}=w({off:!0},s);c&&t.get({"#":c,".":f},p=>{if(p.err){console.log(`error getting ${c}.${f}: ${p.err}`);return}let d=p.put&&p.put[c]&&p.put[c][f],y=P.is(d);y?t.off({"#":y},n.get(s)):t.off({"#":c},n.get(s)),n.delete(s),r.delete(i)})},user:()=>(o.get||(Object.assign(o,l()),o.get=(s,f,c,p)=>{typeof f=="function"&&(p=c,c=f,f=null);let d=null,y=null;if(o.is&&(d=o.is.pub),typeof s=="string"?y=s:s instanceof Array&&(s.length===2?(d=s[0],y=s[1]):s.length===1&&(y=s[0])),!d){console.log("error please log in or provide a public key"),c&&c(null);return}if(y===null||y===""||y==="_"){console.log("error please provide a key"),c&&c(null);return}if(f&&!c){console.log("error lex requires a callback function");return}i=T.random();let S=[{item:y,soul:"~"+d}];if(r.set(i,{chain:S,user:o.is,cb:c}),!c)return l(i);let b=m(i),{soul:v}=w({get:f},b);v&&g(f,v,b,p)}),o),wire:t,SEA:B}};return l()},gt=Je;export{gt as default};
//# sourceMappingURL=holster.js.map
