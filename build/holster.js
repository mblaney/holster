var ue={is:e=>{if(e instanceof Array)return!1;if(typeof e=="number")return!isNaN(e);if(typeof e=="string"){let t=parseFloat(e);return!isNaN(t)&&isFinite(t)}return!1}},L={is:e=>{if(!e||typeof e!="object")return!1;let r=Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/);return e.constructor===Object||r&&r[1]==="Object"},map:(e,t,r)=>{var n=Object.keys(e);for(let o=0;o<n.length;o++){let f=t(e[n[o]],n[o],r);if(typeof f<"u")return f}},put:(e,t,r)=>(e||(e={}),e[t]=r,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Ue=(e,t,r)=>{if(r.id){r.id=!1;return}if(t==="#"&&typeof e=="string"){r.id=e;return}r.id=!1},M={is:e=>{if(e&&e["#"]&&!e._&&L.is(e)){let t={};if(L.map(e,Ue,t),t.id)return t.id}return!1},ify:e=>L.put({},"#",e)},q="_holster_user_signature",B="_holster_user_public_key",X=(e,t,r,n)=>{let o=Date.now(),f={[e]:{_:{"#":e,">":{}}}};for(let[h,m]of Object.entries(t))h!=="_"&&h!==B&&h!==q&&(f[e][h]=m,f[e]._[">"][h]=o);return r&&n&&(f[e][q]=r,f[e]._[">"][q]=o,f[e][B]=n,f[e]._[">"][B]=o),f},V=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!L.is(e)||!t)return!1;let r=e["*"];if(r)return t.slice(0,r.length)===r;let n=e[">"],o=e["<"];return n&&o?t>=n&&t<=o:n?t>=n:o?t<=o:!1},N={random:e=>{var t="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let n=0;n<e;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}};var He=e=>{e||(e=9e3);let t={store:{}};return t.check=r=>t.store[r]?t.track(r):!1,t.track=r=>(t.store[r]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{if(t.expiry)return;let n=Date.now();Object.keys(t.store).forEach(o=>{n-t.store[o]>e&&delete t.store[o]}),t.expiry=null},e)),r),t},Ee=He;var Pe=(e,t)=>{if(!e||typeof e!="object")throw new TypeError("lex must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");let r=e["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!t[r])return;let n={_:{"#":r,">":{}}};if(typeof e["."]=="string"){let o=e["."];if(typeof t[r][o]>"u")return;n[o]=t[r][o],n._[">"][o]=t[r]._[">"][o]}else for(let o of Object.keys(t[r]))V(e["."],o)&&(n[o]=t[r][o],n._[">"][o]=t[r]._[">"][o]);return{[r]:n}},he=Pe;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function le(){}Object.assign(le,{from:Array.from});le.prototype=Object.create(Array.prototype);le.prototype.toString=function(e,t,r){if(e||(e="utf8"),t||(t=0),r=r?Math.min(Math.max(r,t),this.length):this.length,e==="hex"){let n=new Uint8Array(this.slice(t,r));return Array.from(n,o=>o.toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:r-t},(n,o)=>{let f=this[o+t];return f<0||f>1114111?"\uFFFD":String.fromCharCode(f)}).join("");if(e==="base64"){let n=Array.from({length:r-t},(o,f)=>{let h=this[f+t];return h<0||h>255?"\uFFFD":String.fromCharCode(h)}).join("");return btoa(n)}};var Q=le;var ae={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function Y(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),Y.from(...e)}Y.prototype=Object.create(Array.prototype);var ne=(e,t)=>{if(typeof e!="string")throw new TypeError("Input must be a string for encoding: "+t);if(e.length>ae.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${e.length} > ${ae.MAX_STRING_LENGTH}`)},W=(e,t="buffer operation")=>{if(e>ae.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${t}: ${e} > ${ae.MAX_BUFFER_SIZE}`)},Be=e=>{ne(e,"hex");let t=e.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(t))throw new TypeError("Invalid hex string: contains non-hex characters");if(t.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(t.length===0)return new Uint8Array(0);W(t.length/2,"hex parsing");let r=new Uint8Array(t.length/2);for(let n=0;n<t.length;n+=2){let o=t.substr(n,2);r[n/2]=parseInt(o,16)}return r},Te=e=>{ne(e,"utf8");try{let r=new TextEncoder().encode(e);return W(r.length,"UTF-8 encoding"),r}catch(t){throw new TypeError("Failed to encode UTF-8 string: "+t.message)}},Fe=e=>{ne(e,"binary"),W(e.length,"binary encoding");let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);t[r]=n}return t},Ke=e=>{ne(e,"base64");let t=e.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(t))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(t);W(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let o=0;o<r.length;o++)n[o]=r.charCodeAt(o);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},ke=e=>{let t;if(e instanceof ArrayBuffer)W(e.byteLength,"ArrayBuffer processing"),t=new Uint8Array(e);else if(ArrayBuffer.isView(e))W(e.byteLength||e.length,"TypedArray processing"),t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);else if(Array.isArray(e)){W(e.length,"Array processing");for(let r=0;r<e.length;r++){let n=e[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}t=new Uint8Array(e)}else if(typeof e=="object"&&e!==null&&typeof e.length=="number"){W(e.length,"array-like processing");let r=Array.from(e);for(let n=0;n<r.length;n++){let o=r[n];if(typeof o!="number"||o<0||o>255||!Number.isInteger(o))throw new TypeError(`Invalid byte value at index ${n}: ${o} (must be integer 0-255)`)}t=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof e);return t};Object.assign(Y,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let t=arguments[0];if(t==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof t=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=Be(t);break;case"utf8":case"utf-8":r=Te(t);break;case"binary":case"latin1":r=Fe(t);break;case"base64":r=Ke(t);break;case"ascii":ne(t,"ascii");for(let o=0;o<t.length;o++)if(t.charCodeAt(o)>127)throw new TypeError(`Invalid ASCII character at position ${o}: ${t.charCodeAt(o)} > 127`);r=Te(t);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=ke(t);if(!r||r.length===0)return Q.from(new Uint8Array(0));try{return Q.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(e,t=0){if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Length must be a non-negative integer");if(W(e,"buffer allocation"),typeof t=="number"){if(t<0||t>255||!Number.isInteger(t))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof t=="string"){if(t.length!==1)throw new TypeError("Fill string must be exactly one character");if(t=t.charCodeAt(0),t>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(e);return t!==0&&r.fill(t),Q.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be an array");if(e.length===0)return Q.from(new Uint8Array(0));let t=0,r=[];for(let n=0;n<e.length;n++){let o=e[n];if(!o)throw new TypeError(`Array element at index ${n} is null or undefined`);let f;try{f=ke(o)}catch(h){throw new TypeError(`Invalid array element at index ${n}: ${h.message}`)}t+=f.length,W(t,"buffer concatenation"),r.push(f)}try{let n=new Uint8Array(t),o=0;for(let f of r)n.set(f,o),o+=f.length;return Q.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(e){return e instanceof Q||e&&typeof e=="object"&&e.constructor===Y},byteLength(e,t="utf8"){if(typeof e!="string")throw new TypeError("First argument must be a string");switch(t.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(e).length;case"ascii":case"binary":case"latin1":return e.length;case"base64":let r=e.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(e.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+t)}}});Y.prototype.from=Y.from;Y.prototype.toString=function(e="utf8",t=0,r=this.length){if(typeof e!="string")throw new TypeError("Encoding must be a string");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<t)throw new TypeError("End must be an integer >= start");try{return Q.prototype.toString.call(this,e,t,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var F=Y;var qe=typeof document>"u",$e=qe?(await import("node:crypto")).webcrypto:globalThis.crypto,D=$e.subtle,fe=e=>typeof e=="string"?e:JSON.stringify(e),oe=e=>{try{return JSON.parse(e)}catch{return e}},ce=e=>{let t=new Uint8Array(F.alloc(e));return F.from($e.getRandomValues(t))},ie=(e,t)=>{let[r,n]=e.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},ge=async e=>{let t=await D.digest({name:"SHA-256"},new TextEncoder().encode(fe(e)));return F.from(t)},ye=async(e,t)=>{let r=e+t.toString("utf8"),n=F.from(await ge(r),"binary"),o=Je(n);return await D.importKey("jwk",o,{name:"AES-GCM"},!1,["encrypt","decrypt"])},Je=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var Ge={pair:async e=>{let t=await D.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async o=>{let f=await D.exportKey("jwk",o.publicKey);return{priv:(await D.exportKey("jwk",o.privateKey)).d,pub:f.x+"."+f.y}}),r=await D.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async o=>{let f=await D.exportKey("jwk",o.publicKey);return{epriv:(await D.exportKey("jwk",o.privateKey)).d,epub:f.x+"."+f.y}}),n={pub:t.pub,priv:t.priv,epub:r.epub,epriv:r.epriv};return e&&e(n),n},encrypt:async(e,t,r)=>{if(!t||!t.epriv)return r&&r(null),null;let n={s:ce(9),iv:ce(15)},o=await ye(t.epriv,n.s).then(h=>D.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},h,new TextEncoder().encode(fe(e)))),f={ct:F.from(o,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(f),f},decrypt:async(e,t,r)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return r&&r(null),null;let n={ct:F.from(e.ct,"base64"),iv:F.from(e.iv,"base64"),s:F.from(e.s,"base64")};try{let o=await ye(t.epriv,n.s).then(h=>D.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},h,new Uint8Array(n.ct))),f=oe(new TextDecoder("utf8").decode(o));return r&&r(f),f}catch{return r&&r(null),null}},verify:async(e,t,r)=>{if(!t||!t.pub)return r&&r(null),null;let n=oe(e),o=await D.importKey("jwk",ie(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),f={};if(typeof n.m=="string")f=n.m;else for(let l of Object.keys(n.m).sort())l!=="_"&&l!=B&&l!=q&&(f[l]=n.m[l]);let h=await ge(f),m=new Uint8Array(F.from(n.s,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}};if(await D.verify(a,o,m,new Uint8Array(h))){let l=oe(n.m);return r&&r(l),l}return r&&r(null),null},sign:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n={};if(typeof e=="string")n=e;else{let l=oe(e);for(let d of Object.keys(l).sort())d!=="_"&&d!=B&&d!=q&&(n[d]=l[d])}let o=await ge(n),f=ie(t.pub,t.priv),h={name:"ECDSA",namedCurve:"P-256"},m=await D.importKey("jwk",f,h,!1,["sign"]).then(l=>D.sign({name:"ECDSA",hash:{name:"SHA-256"}},l,new Uint8Array(o))),a={m:n,s:F.from(m,"binary").toString("base64")};return r&&r(a),a},work:async(e,t,r)=>{typeof t=="function"&&(r=t,t=void 0),typeof t>"u"&&(t=ce(9));let n=await D.importKey("raw",new TextEncoder().encode(fe(e)),{name:"PBKDF2"},!1,["deriveBits"]),o={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},f=await D.deriveBits(o,n,512),h={epriv:F.from(f,"binary").toString("base64")};return r&&r(h),h},secret:async(e,t,r)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},o=ie(e.epub),f=await D.importKey("jwk",o,n,!0,[]),h=ie(t.epub,t.epriv,!1);delete h.key_ops;let m=await D.importKey("jwk",h,n,!1,["deriveBits"]).then(async a=>{let l=await D.deriveBits({public:f,name:"ECDH",namedCurve:"P-256"},a,256),d=await D.importKey("raw",new Uint8Array(l),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return D.exportKey("jwk",d).then(({k:b})=>b)});return r&&r({epriv:m}),{epriv:m}}},H=Ge;var xe=100,Ce=1e4,me=(e,t,r,n)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});me.mix=async(e,t,r,n)=>{if(!e||typeof e!="object")throw new TypeError("change must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let o=Date.now(),f={},h={},m=0;for(let l of Object.keys(e)){let d=e[l],b=!1,x=!1,i=0,u=r;if(!d||!d._)continue;let g=d[q],c=d[B];if(g&&c&&(u=!0),l.length>1&&l[0]==="~")if(l[1]==="@")x=!0,u=!1;else{if(c&&l!="~"+c){console.log(`error public key does not match for soul: ${l}`);continue}u=!0}if(!(u&&(!g||!c||!await H.verify({m:d,s:g},{pub:c})))){for(let s of Object.keys(d)){if(s==="_")continue;let p=d[s],k=d._&&d._[">"]?d._[">"][s]:0,y=(t[l]||{})[s],w=(t[l]||{_:{">":{}}})._[">"][s]||0;if(x&&s!==M.is(p)){console.log(`error alias ${x}: ${s} !== ${M.is(p)}`);continue}let A=k-o;if(A>0){if(A>864e5)continue;(m===0||A<m)&&(m=i=A),h[l]||(h[l]={_:{"#":l,">":{}}}),h[l][s]=p,h[l]._[">"][s]=k}else me(k,w,p,y).incoming&&(f[l]||(f[l]={_:{"#":l,">":{}}}),t[l]||(t[l]={_:{"#":l,">":{}}}),t[l][s]=f[l][s]=p,t[l]._[">"][s]=f[l]._[">"][s]=k,n[l]&&setTimeout(()=>{n[l]&&n[l].filter(S=>V(S["."],s)).forEach(S=>S.cb())},xe),b=!0)}u&&i!==0&&f[l]&&(Object.assign(h[l],f[l]),delete f[l]),b&&n[l]&&setTimeout(()=>{n[l]&&n[l].filter(s=>V(s["."])).forEach(s=>s.cb())},xe)}}let a=Object.keys(t);return a.length>Ce&&a.map(b=>{let x=t[b]._&&t[b]._[">"],i=x?Math.max(...Object.values(x)):0;return{soul:b,maxState:i}}).sort((b,x)=>b.maxState-x.maxState).slice(0,a.length-Ce).forEach(({soul:b})=>delete t[b]),{now:f,defer:h,wait:m}};var we=me;var J="",re="",Ae=()=>{let e=(t,r,n)=>{if(n||(e[J]||(e[J]={}),n=e[J]),!t)return n;let o=0,f={},h=t[o],m=t.length-1,a=typeof r>"u",l=n[h];for(;!l&&o<m;)h+=t[++o],l=n[h];if(l)if(o===m){if(a)return typeof l[re]>"u"?l[J]:l[re];l[re]=r}else return!l[J]&&!a&&(l[J]={}),e(t.slice(++o),r,l[J]);else if(L.map(n,(b,x)=>{let i=0,u="";for(;x[i]===t[i];)u+=x[i++];if(u){if(a)return i<=m?void 0:(f[x.slice(i)]=b,b);let g={[x.slice(i)]:b,[t.slice(i)]:{[re]:r}};return n[u]={[J]:g},delete n[x],!0}})){if(a)return f}else{if(a)return;n[h]||(n[h]={}),n[h][re]=r}};return e};Ae.map=function e(t,r,n,o){o||(o=[]);var f=t[J]||t,h=Object.keys(f).sort(),m;for(let a=0;a<h.length;a++){let l=h[a],d=f[l],b=d[re];if(typeof b<"u"){if(b=r(b,o.join("")+l,l,o),typeof b<"u")return b}else n&&r(m,o.join(""),l,o);if(d[J]){if(o.push(l),b=e(d[J],r,n,o),typeof b<"u")return b;o.pop()}}};var K=Ae;var Oe="",je="",U="",te=e=>{var t;let r=new Map,n=null,o=0,f=1e4,h=new Map,m=0,a=3e4,l=.8,d=.9;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=100),e.write||(e.write=1),e.size||(e.size=1024*1024),e.memoryLimit||(e.memoryLimit=500),typeof e.cache>"u"&&(e.cache=!0),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let b=(u,g,c,s)=>{let p=Date.now()-g;p>1e3&&console.log(`[RADISK-SLOW] ${u}: ${p}ms for ${c}${s?` (${s} bytes)`:""}`)},x=()=>{let u=Date.now();if(u-m<a)return;m=u;let g=process.memoryUsage(),c=g.heapUsed,s=g.heapTotal,p=e.memoryLimit*1024*1024,k=c/p;if(k>d){let y=r.size;console.log(`[RADISK-MEMORY] High memory usage: ${Math.round(k*100)}% of heap limit. Clearing ${y} cached files.`),r.clear(),global.gc&&global.gc(),m=u+a}else k>l&&console.log(`[RADISK-MEMORY] Memory warning: ${Math.round(k*100)}% of heap limit used. Cache size: ${r.size} files.`)},i=(u,g,c)=>{if(u=""+u,typeof g=="function"){if(c=g,g=i.batch(u),typeof g<"u"||i.thrash.at&&(g=i.thrash.at(u),typeof g<"u"))return c(t,g);if(h.has(u)){h.get(u).push(c);return}h.set(u,[c]);let s=Date.now();return i.read(u,(p,k)=>{b("read",s,u);let y=h.get(u)||[];h.delete(u),y.forEach(w=>w(p,k))})}if(i.batch(u,g),x(),c&&i.batch.acks.push(c),++i.batch.ed>=e.batch)return i.thrash();clearTimeout(i.batch.timeout),i.batch.timeout=setTimeout(i.thrash,e.write)};return i.batch=K(),i.batch.acks=[],i.batch.ed=0,i.thrash=()=>{if(i.thrash.ing)return i.thrash.more=!0;let u=Date.now();clearTimeout(i.batch.timeout),i.thrash.more=!1,i.thrash.ing=!0;var g=i.thrash.at=i.batch;i.batch=null,i.batch=K(),i.batch.acks=[],i.batch.ed=0;let c=0;i.save(g,s=>{++c>1||(b("thrash",u,`batch-${g.ed}`),s&&e.log(s),g.acks.forEach(p=>p(s)),i.thrash.at=null,i.thrash.ing=!1,i.thrash.more&&i.thrash())})},i.save=(u,g)=>{let c={find:(s,p)=>{if(!(p<c.start))return c.start=p,e.store.list(c.lex),!0},lex:s=>{!s||s>c.start?(c.end=s,c.start&&c.mix(c.file||"!",c.start,c.end)):c.file=s},mix:(s,p,k)=>{if(c.start=c.end=c.file=t,r.has(s)){let y=r.get(s);K.map(u,(w,A)=>{if(!(A<p)){if(k&&k<A){c.start=A;return}y(A,w)}}),i.write(s,y,c.next)}else i.parse(s,(y,w)=>{if(y)return g(y);K.map(u,(A,j)=>{if(!(j<p)){if(k&&k<j){c.start=j;return}w(j,A)}}),i.write(s,w,c.next)})},next:s=>{if(s)return g(s);if(c.start)return K.map(u,c.find);g(s)}};K.map(u,c.find)},i.write=(u,g,c)=>{let s={text:"",limit:"",done:!1,count:0,each:(k,y,w,A)=>{if(s.done)return;s.count++,k=typeof k>"u"?"":"="+te.encode(k);let j=te.encode(A.length)+"#"+te.encode(w)+k+`
`;if(s.count>1&&A.length===0&&s.text.length+j.length>e.size){let S=w.indexOf(je);if(s.limit=S===-1?w:w.substring(0,S),s.limit!==u){s.done=!0,s.sub=K(),K.map(g,s.slice),i.write(s.limit,s.sub,c);return}}s.text+=j},slice:(k,y)=>{y<s.limit||s.sub(y,k)}};K.map(g,s.each,!0);let p=Date.now();e.store.put(u,s.text,k=>{b("file-write",p,u,s.text.length),c(k)})},i.read=(u,g)=>{let c=u.indexOf(je),s=c===-1?u:u.substring(0,c),p={lex:y=>{if(!y){if(!p.file){g("no file found",t);return}if(e.cache&&r.has(p.file)){let w=r.get(p.file);return p.value=w(u),g(t,p.value)}i.parse(p.file,p.it);return}y>s||y<p.file||(p.file=y)},it:(y,w)=>{y&&e.log(y),w&&(e.cache&&(r.set(p.file,w),x()),p.value=w(u)),g(y,p.value)}},k=Date.now();if(e.cache&&n&&k-o<f)n.forEach(y=>p.lex(y)),p.lex();else{let y=[],w=p.lex;p.lex=A=>(A&&y.push(A),w(A)),e.store.list(A=>{p.lex(A),!A&&e.cache&&(n=y,o=k)})}},i.parse=(u,g)=>{let c={disk:K(),read:(s,p)=>{if(s)return g(s);if(!p)return g(t,c.disk);let k=[],y="",w=c.split(p);for(;w;){let A,j,S=w[1];w=c.split(w[2])||"",w[0]==="#"&&(A=w[1],S<k.length&&(k.length=S),S<=k.length&&(k[S]=A,k.length=S+1),y=k.join("")),w=c.split(w[2])||"",w[0]!==`
`&&(w[0]==="="&&(j=w[1]),typeof A<"u"&&typeof j<"u"&&c.disk(y,j),w=c.split(w[2]))}g(t,c.disk)},split:s=>{if(!s)return;let p=s.indexOf(U);if(p===-1)return;let k=s.slice(0,p),y={};return[k,te.decode(s.slice(p),y),s.slice(p+y.i)]}};e.store.get(u,c.read)},i};te.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=Oe+e[1],e=e[0]),typeof e=="string"){let n=0,o=null,f=U;for(;o=e[n++];)o===U&&(f+=U);return f+'"'+e+t+U}let r=M.is(e);if(r)return U+"#"+r+t+U;if(ue.is(e))return U+"+"+(e||0)+t+U;if(e===!0)return U+"+"+t+U;if(e===!1)return U+"-"+t+U;if(e===null)return U+" "+t+U};te.decode=(e,t)=>{var r=-1,n=0,o=null,f=null,h=-1,m=-1;if(e[0]!==U)return;for(;o=e[++r];)if(f){if(h===-1&&(h=r),o===U&&--n<=0){m=r;break}}else o===U?n++:f=o||!0;let a=h!==-1?e.slice(h,m!==-1?m:r):"";t&&(t.i=r+1);let[l,d]=a.split(Oe);if(d){if(d=parseFloat(d),f==='"')return[l,d];if(f==="#")return[M.ify(l),d];if(f==="+")return l.length===0?[!0,d]:[parseFloat(l),d];if(f==="-")return[!1,d];if(f===" ")return[null,d]}else{if(f==='"')return a;if(f==="#")return M.ify(a);if(f==="+")return a.length===0?!0:parseFloat(a);if(f==="-")return!1;if(f===" ")return null}};var _e=te;var Ne=typeof document>"u",Z=Ne?await import("node:fs"):void 0,Ie="",pe="",be=pe+"+0"+pe+"#"+pe+'"root'+pe,ze=e=>{let t=e.file;if(Ne)return Z.existsSync(t)||Z.mkdirSync(t),Z.existsSync(t+"/!")||Z.writeFileSync(t+"/!",be),{get:(r,n)=>{Z.readFile(t+"/"+r,(o,f)=>{if(o){if(o.code==="ENOENT"){n();return}console.log("fs.readFile error:",o)}f&&(f=f.toString()),n(o,f)})},put:(r,n,o)=>{var f=r+"."+N.random(9)+".tmp";Z.writeFile(f,n,h=>{if(h){console.log("fs.writeFile error:",h),o(h);return}Z.rename(f,t+"/"+r,o)})},list:r=>{Z.readdir(t,(n,o)=>{if(n){console.log("fs.readdir error:",n),r();return}o.forEach(r),r()})}};if(e.indexedDB){let r,n=indexedDB.open(t,1);return n.onupgradeneeded=o=>{o.target.result.createObjectStore(t)},n.onerror=o=>{console.log(o)},n.onsuccess=()=>{if(r=n.result,r){let f=r.transaction([t],"readonly").objectStore(t).getKey("!");f.onerror=()=>{console.log(`error getting key ${t}/!`)},f.onsuccess=()=>{if(!f.result){let m=r.transaction([t],"readwrite").objectStore(t).put(be,"!");m.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(o,f)=>{let h=(l,d)=>{let x=r.transaction([t],"readonly").objectStore(t).get(l);x.onerror=()=>{console.log(`error getting ${t}/${l}`)},x.onsuccess=()=>{d(null,x.result)}};if(r){h(o,f);return}let m=0,a=setInterval(()=>{if(r){clearInterval(a),h(o,f);return}m++>5&&(clearInterval(a),f("error indexedDB not available"))},1e3)},put:(o,f,h)=>{let m=(d,b,x)=>{let u=r.transaction([t],"readwrite").objectStore(t).put(b,d);u.onerror=()=>{console.log(`error putting data on ${t}/${d}`)},u.onsuccess=()=>{x(null)}};if(r){m(o,f,h);return}let a=0,l=setInterval(()=>{if(r){clearInterval(l),m(o,f,h);return}a++>5&&(clearInterval(l),h("error indexedDB not available"))},1e3)},list:o=>{let f=a=>{let d=r.transaction([t],"readonly").objectStore(t).getAllKeys();d.onerror=()=>console.log("error getting keys for",t),d.onsuccess=()=>{d.result.forEach(a),a()}};if(r){f(o);return}let h=0,m=setInterval(()=>{if(r){clearInterval(m),f(o);return}h++>5&&(clearInterval(m),console.log("error indexedDB not available"),o())},1e3)}}}return{get:(r,n)=>{n(null,be)},put:(r,n,o)=>{o(null)},list:r=>{r("!"),r()}}},Xe=e=>{L.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=ze(e));let t=_e(e);return{get:(r,n)=>{if(!r||!L.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}var o=r["#"],f=typeof r["."]=="string"?r["."]:"",h;let m=(a,l)=>{V(r["."],l)&&(h||(h={_:{"#":o,">":{}}}),h[l]=a[0],h._[">"][l]=a[1])};t(o+Ie+f,(a,l)=>{let d;L.is(l)?(K.map(l,m),h||m(l,f),d={[o]:h}):l&&(m(l,f),d={[o]:h}),n(a,d)})},put:(r,n)=>{if(!r){n("graph required");return}let o=0,f=!1,h=m=>{if(o--,!f){if(m){f=!0,n(m);return}o===0&&(f=!0,n(null))}};Object.keys(r).forEach(m=>{var a=r[m];Object.keys(a).forEach(l=>{if(l==="_")return;o++;let d=a[l],b=a._[">"][l];t(m+Ie+l,[d,b],h)})})}}},Re=Xe;var Me=typeof document>"u",De=Me?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=De?.WebSocket);var Qe=e=>{let t=new Map,r=e.maxRequestsPerMinute||100,n=e.rateLimitWindow||6e4,o=e.disconnectThreshold||10,f=e.wss&&e.wss.constructor.name==="Server",h=null;return f||(h=setInterval(()=>{let a=Date.now();for(let[l,d]of t.entries())a-d.lastCleanup>n&&(d.requests=[],d.lastCleanup=a),d.requests=d.requests.filter(b=>a-b<n),a-d.lastCleanup>n*10&&(d.throttleCount=0)},n/4)),{getDelay:a=>{let l=Date.now(),d=t.get(a)||{requests:[],lastCleanup:l,throttleCount:0};if(d.requests=d.requests.filter(b=>l-b<n),d.requests.length>=r){let b=Math.min(...d.requests),x=n-(l-b);return d.throttleCount=(d.throttleCount||0)+1,t.set(a,d),Math.max(0,x)}return d.requests.push(l),t.set(a,d),0},getRemainingRequests:a=>{let l=t.get(a);if(!l)return r;let d=Date.now(),b=l.requests.filter(x=>d-x<n);return Math.max(0,r-b.length)},getThrottleCount:a=>{let l=t.get(a);return l&&l.throttleCount||0},shouldDisconnect:a=>{let l=t.get(a);return l?l.throttleCount>=o:!1},destroy:()=>{h&&(clearInterval(h),h=null),t.clear()}}},Ye=(e,t=1024*1024)=>{try{if(typeof e=="string"&&e.length>t)throw new Error("Message too large");return{success:!0,data:JSON.parse(e)}}catch(r){return{success:!1,error:r.message}}},Ze=(e,t=1024*1024)=>typeof e=="string"&&e.length>t?{valid:!1,error:"Message too large"}:Buffer.isBuffer(e)&&e.length>t?{valid:!1,error:"Message too large"}:{valid:!0},Ve=(e=1e3)=>{let t=new Set;return{add:r=>{if(t.size>=e)return!1;t.add(r);let n=r.close;return r.close=(...o)=>(t.delete(r),n.apply(r,o)),!0},remove:r=>{t.delete(r)},count:()=>t.size,isFull:()=>t.size>=e}},Se=(e=5)=>{let t=0;return{shouldRetry:()=>t<e,getDelay:()=>Math.min(1e3*Math.pow(2,t),3e4),increment:()=>t++,reset:()=>t=0}},et=e=>{let t=Ee(e.maxAge),r=Re(e),n={},o={},f={},h=new Set,m=async S=>n[S]?!0:new Promise(T=>{r.get({"#":S},(v,E)=>{T(!v&&E&&E[S])})}),a=Qe(e),l=Ve(e.maxConnections||1e3),d=async(S,T,v)=>{for(let E of Object.keys(S)){let C=await new Promise(O=>{i({"#":E},O,T)});if(C.err)return v&&v(C.err),!1;let $=S[E],_=B;if(!(!C.put||!C.put[E]||C.put[E][_]===$[_]))return v&&v(`error in wire check public key does not match for soul: ${E}`),!1}return!0},b=(S,T)=>{let v=he(S.get,n);v?T(JSON.stringify({"#":t.track(N.random(9)),"@":S["#"],put:v})):r.get(S.get,(E,C)=>{T(JSON.stringify({"#":t.track(N.random(9)),"@":S["#"],put:C,err:E}))})},x=async(S,T)=>{let v=await we.mix(S.put,n,e.secure,f);if(Object.keys(v.now).length){if(!await d(v.now,T))return;r.put(v.now,E=>{T(JSON.stringify({"#":t.track(N.random(9)),"@":S["#"],err:E}))})}Object.keys(v.defer).length&&setTimeout(()=>x({put:v.defer},T),v.wait)},i=(S,T,v,E)=>{if(!T)return;L.is(E)||(E={});let C=he(S,n),$=N.random(9),_=JSON.stringify({"#":t.track($),get:e.secure?{"#":S["#"]}:S});if(C){let O=v(_);if(O&&O.err){T({err:O.err});return}T({put:C});return}r.get(S,(O,P)=>{if(P){let R=v(_);if(R&&R.err){T({err:R.err});return}T({put:P,err:O});return}O&&console.log(O),o[$]=T;let I=v(_);if(I&&I.err){T({err:I.err}),delete o[$];return}setTimeout(()=>{let R=o[$];if(R){let G=S["#"],z={[G]:null};typeof S["."]=="string"&&(z[G]={[S["."]]:null}),R({put:z}),delete o[$]}},E.wait||100)})},u=S=>({get:(T,v,E)=>{T&&T["#"]&&h.add(T["#"]),i(T,v,S,E)},put:async(T,v)=>{let E=await we.mix(T,n,e.secure,f);if(Object.keys(E.now).length===0){v(null);return}if(!await d(E.now,S,v))return;for(let[_,O]of Object.entries(E.now))if(O&&typeof O=="object")for(let[P,I]of Object.entries(O)){let R=M.is(I);R&&h.add(R)}r.put(E.now,v);let $=S(JSON.stringify({"#":t.track(N.random(9)),put:T}));if($&&$.err){v&&v($.err);return}},on:(T,v,E,C)=>{let $=T&&T["#"];!$||!v||(f[$]?f[$].push({".":T["."],cb:v}):f[$]=[{".":T["."],cb:v}],E&&i(T,v,S,C))},off:(T,v)=>{let E=T&&T["#"];if(!(!E||!f[E]))if(v){let C=f[E].find($=>$.cb===v);C&&f[E].splice(f[E].indexOf(C),1)}else delete f[E]}});if(Me){let S=e.wss,T=()=>S.clients();if(!S){let E=e.server?{server:e.server}:{port:e.port||8765};S=new De.WebSocketServer(E),T=()=>S.clients}let v=(E,C)=>{T().forEach($=>{if($&&$.readyState===WebSocket.OPEN)$.send(E,{binary:C});else{let _=$._retryHandler||Se();if($._retryHandler=_,_.shouldRetry()){let O=_.getDelay();_.increment(),setTimeout(()=>{$&&$.readyState===WebSocket.OPEN&&(_.reset(),$.send(E,{binary:C}))},O)}}})};return S.on("connection",E=>{if(!l.add(E)){console.log("Connection limit reached, rejecting connection"),E.close(1013,"Connection limit reached - try again later");return}let C=N.random(9);console.log(`[HOLSTER-CONNECT] New WebSocket client connected: ${C}`),E.on("error",$=>{console.log("WebSocket error:",$),l.remove(E)}),E.on("close",()=>{console.log(`[HOLSTER-DISCONNECT] WebSocket client disconnected: ${C}`),l.remove(E)}),E.on("message",($,_)=>{let O=Ze($,e.maxMessageSize);if(!O.valid){console.warn(`Invalid message: ${O.error}`),E.send(JSON.stringify({error:O.error}));return}let P=Ye($,e.maxMessageSize);if(!P.success){console.warn(`JSON parse error: ${P.error}`),E.send(JSON.stringify({error:"Invalid JSON"}));return}let I=P.data;if(t.check(I["#"]))return;let R=a.getDelay(C);if(R>0){let z=a.getThrottleCount(C);if(console.log(`[HOLSTER-THROTTLE] Client ${C}: rate limit exceeded, delay would be ${R}ms, dropping message (throttle count: ${z})`),a.shouldDisconnect(C)){console.log(`[HOLSTER-DISCONNECT] Client ${C}: Disconnecting bad actor after ${z} throttle violations`),E.close(1008,"Rate limit violations - bad actor");return}E.send(JSON.stringify({"#":t.track(N.random(9)),"@":I["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(R/1e3)}s`,throttle:R}));return}let G=()=>{t.track(I["#"]),I.get&&b(I,v),I.put&&x(I,v),v($,_);let z=I["@"],se=o[z];se&&(delete I["#"],delete I["@"],se(I),delete o[z])};R>0?setTimeout(G,R):G()})}),u(v)}let g=[],c=!1,s=0,p=[],k=null,y=e.maxQueueLength||1e3,w=()=>{if(p.length===0){k=null;return}let S=Date.now();if(c&&S<s){k=setTimeout(w,Math.min(1e3,s-S));return}c&&S>=s&&(console.log("[CLIENT-THROTTLED] Throttle period ended, resuming queue processing"),c=!1,s=0);let T=p.shift();A(T),p.length>0?k=setTimeout(w,100):k=null},A=S=>{g.forEach(T=>{if(T&&T.readyState===WebSocket.OPEN)T.send(S);else{let v=T._retryHandler||Se();if(T._retryHandler=v,v.shouldRetry()){let E=v.getDelay();v.increment(),setTimeout(()=>{T&&T.readyState===WebSocket.OPEN&&(v.reset(),T.send(S))},E)}}})},j=S=>{if(c||p.length>0){if(p.length>=y)return{err:`Message queue exceeded maximum length (${y}). Update query logic to request less data.`,queueLength:p.length,maxQueueLength:y};p.push(S),console.log(`Queuing message (queue length: ${p.length}/${y})`),k||(k=setTimeout(w,100));return}A(S)};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(S=>{let T=()=>{let v=new WebSocket(S);g.push(v);let E=Se();v.onclose=C=>{if(g.indexOf(v)!==-1&&g.splice(g.indexOf(v),1),v=null,E.shouldRetry()){let $=E.getDelay();E.increment(),setTimeout(T,$)}},v.onopen=()=>{E.reset()},v.onerror=C=>{console.log(C)},v.onmessage=async C=>{let $=JSON.parse(C.data);if(t.check($["#"]))return;if($.throttle&&$.err){console.log(`[CLIENT-THROTTLED] Server throttling: ${$.err}`),c=!0,s=Date.now()+$.throttle;return}if(t.track($["#"]),$.get&&b($,j),$.put){let P={};for(let[I,R]of Object.entries($.put)){let G=!1;if(await m(I)&&(G=!0,R&&typeof R=="object"))for(let[z,se]of Object.entries(R)){let ve=M.is(se);ve&&h.add(ve)}h.has(I)&&(G=!0,h.delete(I)),G&&(P[I]=R)}Object.keys(P).length>0&&x({put:P},j)}j(C.data);let _=$["@"],O=o[_];O&&(delete $["#"],delete $["@"],O($),delete o[_])}};T()}),u(j)},de=et;var tt=(e,t)=>{t||(t=de(e));let r=[],n=!1,o=!1,f=0,h=(a,l,d,b)=>{let x=c=>{f++,h(c,l,d,b)},i=c=>{r=[],f=0,o=!1,b(c)},u=()=>{if(r.length===0){i("Wrong username or password");return}let c=r.shift();t.get({"#":c},async s=>{if(s.err){i(`error getting ${c}: ${s.err}`);return}let p=s.put&&s.put[c];if(!p||!p.auth)return u();let k=JSON.parse(p.auth),y=await H.work(l,k.salt),w=await H.decrypt(k.enc,y);if(!w)return u();if(m.is={username:a,pub:p.pub,epub:p.epub,priv:w.priv,epriv:w.epriv},d!==""){let A=N.random(64),j=await H.work(d,A),S=await H.encrypt(w,j),T={username:a,pub:p.pub,epub:p.epub,auth:JSON.stringify({enc:S,salt:A})},v=await H.sign(T,m.is),E=X(c,v.m,v.s,p.pub);t.put(E,C=>{i(C?`error putting ${T} on ${c}: ${C}`:null)});return}return i(null)},{wait:1e3})};if(f>9){i("Wrong username or password");return}let g="~@"+a;t.get({"#":g},async c=>{if(c.err){i(`error getting ${g}: ${c.err}`);return}let s=c.put&&c.put[g];if(!s)return x(a);delete c.put[g]._,r=Object.keys(s),u()},{wait:1e3})},m={create:(a,l,d)=>{let b=i=>{d?d(i):console.log(i)};if(n){b("User is already being created");return}if(a===""){b("Please provide a username");return}if(l===""){b("Please provide a password");return}n=!0;let x="~@"+a;t.get({"#":x},async i=>{if(i.err){n=!1,b(`error getting ${x}: ${i.err}`);return}if(i.put&&i.put[x]){n=!1,b("Username already exists");return}let u=N.random(64),g=await H.work(l,u),c=await H.pair(),s={priv:c.priv,epriv:c.epriv},p=await H.encrypt(s,g),k={username:a,pub:c.pub,epub:c.epub,auth:JSON.stringify({enc:p,salt:u})},y="~"+c.pub,w=await H.sign(k,c),A=X(y,w.m,w.s,c.pub);t.put(A,j=>{if(n=!1,j){b(`error putting ${k} on ${y}: ${j}`);return}let S={[y]:{"#":y}};t.put(X(x,S),T=>{if(T){b(`error putting ${S} on ${x}: ${T}`);return}d&&d(null)})})},{wait:1e3})},auth:(a,l,d)=>{let b=x=>{d?d(x):x&&console.log(x)};if(o){b("User is already authenticating");return}if(m.is=null,a===""){b("Please provide a username");return}if(l===""){b("Please provide a password");return}o=!0,h(a,l,"",b)},change:(a,l,d,b)=>{let x=i=>{b?b(i):i&&console.log(i)};if(o){x("User is already authenticating");return}if(m.is=null,a===""){x("Please provide a username");return}if(l===""){x("Please provide a password");return}if(d===""){x("Please provide a new password");return}o=!0,h(a,l,d,x)},store:a=>{if(!m.is){console.log("Please authenticate before calling store");return}if(a){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(m.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(m.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let a=globalThis.localStorage.getItem("user.is");if(a){m.is=JSON.parse(a);return}}if(typeof globalThis.sessionStorage<"u"){let a=globalThis.sessionStorage.getItem("user.is");a&&(m.is=JSON.parse(a))}},leave:()=>{m.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(a,l,d)=>{let b=x=>{d?d(x):console.log(x)};if(o){b("User is already authenticating");return}if(a===""){b("Please provide a username");return}if(l===""){b("Please provide a password");return}o=!0,h(a,l,"",async x=>{if(x){b(x);return}let i={username:null,pub:null,epub:null,auth:null},u=await H.sign(i,m.is),g="~"+m.is.pub,c=X(g,u.m,u.s,m.is.pub);t.put(c,s=>{if(s){b(`error putting null on ${g}: ${s}`);return}m.is=null,d&&d(null)})})}};return m},Le=tt;var rt=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:L.is(e)||(e={});let t=de(e),r=Le(null,t),n=new Map,o=new Map,f=a=>a===null||a===!0||a===!1||typeof a=="string"||M.is(a)||ue.is(a),h=a=>{if(f(a))return!0;if(L.is(a)){let d=[];for(let[b,x]of Object.entries(a)){if(b==="_")return"error underscore cannot be used as a property name";if(L.is(x)||f(x)){d.push(b);continue}return typeof x>"u"?`error undefined ${b} cannot be converted to a graph`:`error ${JSON.stringify({[b]:x})} cannot be converted to a graph`}if(d.length!==0)return d}return`error ${JSON.stringify(a)} cannot be converted to a graph`},m=a=>{let l=(i,u,g,c)=>{t.get(L.put(i,"#",u),async s=>{if(s.err&&console.log(s.err),s.put&&s.put[u]){delete s.put[u]._,delete s.put[u][B],delete s.put[u][q];for(let p of Object.keys(s.put[u])){let k=M.is(s.put[u][p]);if(k){let y=await new Promise(w=>{let A=N.random();o.set(A,{chain:[{item:null,soul:k}]}),m(A).next(null,w,c)});s.put[u][p]=y}}g(s.put[u])}else g(null)},c)},d=async(i,u,g,c)=>{if(g){let s=await H.sign(u,g);return X(i,s.m,s.s,g.pub)}return e.secure?(c||(c=console.log),c(`error putting data on ${i}: user required in secure mode`),null):X(i,u)},b=i=>u=>{let g=o.get(i);g&&typeof g.cb<"u"?setTimeout(()=>g.cb(u),1):u&&console.log("error no callback for data",u,"ctx",g),g&&!g.on&&o.delete(i)},x=(i,u)=>{if(!i){console.log("error resolve request parameter required");return}let g=typeof i.get<"u",c=typeof i.put<"u",s=typeof i.on<"u",p=typeof i.off<"u",k=!1,y=o.get(a);for(var w=1;w<y.chain.length;w++)if(y.chain[w].soul===null){k=!0;break}if(k){let{item:A,soul:j}=y.chain[w-1],S=y.user||e.secure?{"#":j}:{"#":j,".":A};return t.get(S,async T=>{if(T.err){y.user||e.secure?console.log(`error getting ${j}: ${T.err}`):console.log(`error getting ${A} on ${j}: ${T.err}`),u&&u(null);return}let v=T.put&&T.put[j];if(v&&typeof v[A]<"u"){let E=M.is(v[A]);if(E)y.chain[w].soul=E,o.set(a,{...y}),g?m(a).next(null,i.get,u,i._opt):c?m(a).put(i.put,u):s?m(a).on(i.on,u,i._get,i._opt):p&&m(a).off(u);else if(g)u(v[A]);else if(c){E=N.random(),v[A]=M.ify(E);let C=await d(j,v,y.user,u);if(C===null)return;t.put(C,$=>{if($){u(`error putting ${A} on ${j}: ${$}`);return}y.chain[w].soul=E,m(a).put(i.put,u)})}else(s||p&&u)&&u(null)}else if(c){let E=N.random();v||(v={}),v[A]=M.ify(E);let C=await d(j,v,y.user,u);if(C===null)return;t.put(C,$=>{if($){u(`error putting ${A} on ${j}: ${$}`);return}y.chain[w].soul=E,m(a).put(i.put,u)})}else u&&u(null)},i._opt),!1}return g&&y.chain[y.chain.length-1].item!==null?(y.chain.push({item:null,soul:null}),m(a).next(null,i.get,u,i._opt),!1):y.chain[y.chain.length-1]};return{get:(i,u,g,c)=>{if(typeof u=="function"&&(c=g,g=u,u=null),i===null||i===""||i==="_"){console.log("error please provide a key"),g&&g(null);return}if(u&&typeof g!="function"){console.log("error lex requires a callback function");return}if(a=N.random(),o.set(a,{chain:[{item:i,soul:"root"}],cb:g}),!g)return m(a);let s=b(a),{soul:p}=x({get:u,_opt:c},s);p&&l(u,p,s,c)},next:(i,u,g,c)=>{let s=w=>A=>{g?g(A):b(w)(A)};if(typeof u=="function"&&(c=g,g=u,u=null),!a){console.log("error please provide a key using get(key)"),g&&g(null);return}let p=s(a);if(i===""||i==="_"){p(null);return}if(u&&typeof g!="function"){console.log("error lex requires a callback function");return}let k=o.get(a);if(!k)return;if(g&&typeof k.cb>"u"&&(k.cb=g,g=null),i!==null&&k.chain.push({item:i,soul:null}),!k.cb)return m(a);let{soul:y}=x({get:u,_opt:c},p);y&&l(u,y,p,c)},put:(i,u,g)=>{typeof u=="function"&&(g=u,u=!1);let c=j=>S=>{g?g(S):b(j)(S)};if(!a){g&&g("error please provide a key using get(key)");return}let s=o.get(a);if(!s)return;if(!s.cb){if(!g)return;s.cb=g,g=null}u&&(i={[N.random()]:i});let p=c(a),k=h(i);if(typeof k=="string"){p(k);return}let{item:y,soul:w}=x({put:i},p);if(!w)return;if(k===!0){let j=s.user||e.secure?{"#":w}:{"#":w,".":y};t.get(j,async S=>{if(S.err){p(`error getting ${w}: ${S.err}`);return}let T=S.put&&S.put[w],v=T&&T[y],E=M.is(v);if(!E){T||(T={}),T[y]=i;let C=await d(w,T,s.user,p);if(C===null)return;t.put(C,p);return}t.get({"#":E},async C=>{if(C.err){p(`error getting ${E}: ${C.err}`);return}if(!C.put||!C.put[E]){p(`error ${E} not found`);return}for(let _ of Object.keys(C.put[E])){if(_==="_"||_===B||_===q)continue;let O=await new Promise(P=>{let I=N.random(),R=[{item:_,soul:E}];o.set(I,{chain:R,user:s.user}),m(I).put(null,P)});if(O){p(O);return}}T||(T={}),T[y]=i;let $=await d(w,T,s.user,p);$!==null&&t.put($,p)})});return}let A=s.user||e.secure?{"#":w}:{"#":w,".":y};t.get(A,async j=>{if(j.err){p(`error getting ${w}.${y}: ${j.err}`);return}let S=j.put&&j.put[w],T=S&&S[y],v=M.is(T);if(!v){S||(S={}),S[y]=M.ify(N.random());let C=await d(w,S,s.user,p);if(C===null)return;t.put(C,$=>{if($)p(`error putting ${y} on ${w}: ${$}`);else{let _=N.random(),O=[{item:y,soul:w}];o.set(_,{chain:O,user:s.user,cb:s.cb}),m(_).put(i)}});return}let E=[];for(let C of k){let $=await new Promise(_=>{if(L.is(i[C])&&!M.is(i[C])){let O=N.random(),P=[{item:C,soul:v}];o.set(O,{chain:P,user:s.user}),m(O).put(i[C],_)}else E.push(C),_(null)});if($){p($,a);return}}if(E.length===0){p(null);return}t.get({"#":v},async C=>{if(C.err){p(`error getting ${v}: ${C.err}`);return}let $=C.put&&C.put[v];$||($={}),E.forEach(O=>{$[O]=i[O]});let _=await d(v,$,s.user,p);_!==null&&t.put(_,p)})})},on:(i,u,g,c)=>{if(typeof i=="function"&&(c=g,g=u,u=i,i=null),typeof u!="function"){console.log("error on() requires a callback function");return}if(!a){console.log("error please provide a key using get(key)"),u(null);return}let{item:s,soul:p}=x({on:i,_get:g,_opt:c},u);p&&(o.set(a,{chain:[{item:s,soul:p}],on:!0}),n.set(u,()=>m(a).next(null,u,c)),t.get({"#":p,".":s},k=>{if(k.err){console.log(`error getting ${p}.${s}: ${k.err}`);return}let y=k.put&&k.put[p]&&k.put[p][s],w=M.is(y);w?i?i=L.put(i,"#",w):i={"#":w,".":null}:i?i=L.put(i,"#",p):i={"#":p,".":s},t.on(i,n.get(u),g,c)},c))},off:i=>{if(!a){console.log("error please provide a key using get(key)"),i&&i(null);return}let{item:u,soul:g}=x({off:!0},i);g&&t.get({"#":g,".":u},c=>{if(c.err){console.log(`error getting ${g}.${u}: ${c.err}`);return}let s=c.put&&c.put[g]&&c.put[g][u],p=M.is(s);p?t.off({"#":p},n.get(i)):t.off({"#":g},n.get(i)),n.delete(i),o.delete(a)})},user:()=>(r.get||(Object.assign(r,m()),r.get=(i,u,g,c)=>{typeof u=="function"&&(c=g,g=u,u=null);let s=null,p=null;if(r.is&&(s=r.is.pub),typeof i=="string"?p=i:i instanceof Array&&(i.length===2?(s=i[0],p=i[1]):i.length===1&&(p=i[0])),!s){console.log("error please log in or provide a public key"),g&&g(null);return}if(p===null||p===""||p==="_"){console.log("error please provide a key"),g&&g(null);return}if(u&&!g){console.log("error lex requires a callback function");return}a=N.random();let k=[{item:p,soul:"~"+s}];if(o.set(a,{chain:k,user:r.is,cb:g}),!g)return m(a);let y=b(a),{soul:w}=x({get:u,_opt:c},y);w&&l(u,w,y,c)}),r),wire:t,SEA:H}};return m()},It=rt;export{It as default};
//# sourceMappingURL=holster.js.map
