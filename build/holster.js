var fe={is:e=>{if(e instanceof Array)return!1;if(typeof e=="number")return!isNaN(e);if(typeof e=="string"){let t=parseFloat(e);return!isNaN(t)&&isFinite(t)}return!1}},L={is:e=>{if(!e||typeof e!="object")return!1;let r=Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/);return e.constructor===Object||r&&r[1]==="Object"},map:(e,t,r)=>{var n=Object.keys(e);for(let o=0;o<n.length;o++){let s=t(e[n[o]],n[o],r);if(typeof s<"u")return s}},put:(e,t,r)=>(e||(e={}),e[t]=r,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Be=(e,t,r)=>{if(r.id){r.id=!1;return}if(t==="#"&&typeof e=="string"){r.id=e;return}r.id=!1},U={is:e=>{if(e&&e["#"]&&!e._&&L.is(e)){let t={};if(L.map(e,Be,t),t.id)return t.id}return!1},ify:e=>L.put({},"#",e)},W="_holster_user_signature",F="_holster_user_public_key",X=(e,t,r,n)=>{let o=Date.now(),s={[e]:{_:{"#":e,">":{}}}};for(let[m,d]of Object.entries(t))m!=="_"&&m!==F&&m!==W&&(s[e][m]=d,s[e]._[">"][m]=o);if(r&&n){s[e]._.s={};for(let[m,d]of Object.entries(r))s[e]._.s[m]=d;s[e][F]=n,s[e]._[">"][F]=o}return s},V=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!L.is(e)||!t)return!1;let r=e["*"];if(r)return t.slice(0,r.length)===r;let n=e[">"],o=e["<"];return n&&o?t>=n&&t<=o:n?t>=n:o?t<=o:!1},R={random:e=>{var t="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let n=0;n<e;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}};var Fe=e=>{e||(e=9e3);let t={store:{}};return t.check=r=>t.store[r]?t.track(r):!1,t.track=r=>(t.store[r]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{if(t.expiry)return;let n=Date.now();Object.keys(t.store).forEach(o=>{n-t.store[o]>e&&delete t.store[o]}),t.expiry=null},e)),r),t},_e=Fe;var He=(e,t)=>{if(!e||typeof e!="object")throw new TypeError("lex must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");let r=e["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!t[r])return;let n={_:{"#":r,">":{}}},o={};if(typeof e["."]=="string"){let s=e["."];if(typeof t[r][s]>"u")return;n[s]=t[r][s],n._[">"][s]=t[r]._[">"][s],t[r]._.s&&t[r]._.s[s]&&(o[s]=t[r]._.s[s])}else for(let s of Object.keys(t[r]))V(e["."],s)&&(n[s]=t[r][s],n._[">"][s]=t[r]._[">"][s],t[r]._.s&&t[r]._.s[s]&&(o[s]=t[r]._.s[s]));return Object.keys(o).length>0&&(n._.s=o),{[r]:n}},me=He;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function ce(){}Object.assign(ce,{from:Array.from});ce.prototype=Object.create(Array.prototype);ce.prototype.toString=function(e,t,r){if(e||(e="utf8"),t||(t=0),r=r?Math.min(Math.max(r,t),this.length):this.length,e==="hex"){let n=new Uint8Array(this.slice(t,r));return Array.from(n,o=>o.toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:r-t},(n,o)=>{let s=this[o+t];return s<0||s>1114111?"\uFFFD":String.fromCharCode(s)}).join("");if(e==="base64"){let n=Array.from({length:r-t},(o,s)=>{let m=this[s+t];return m<0||m>255?"\uFFFD":String.fromCharCode(m)}).join("");return btoa(n)}};var Q=ce;var ge={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function Y(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),Y.from(...e)}Y.prototype=Object.create(Array.prototype);var le=(e,t)=>{if(typeof e!="string")throw new TypeError("Input must be a string for encoding: "+t);if(e.length>ge.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${e.length} > ${ge.MAX_STRING_LENGTH}`)},z=(e,t="buffer operation")=>{if(e>ge.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${t}: ${e} > ${ge.MAX_BUFFER_SIZE}`)},Ke=e=>{le(e,"hex");let t=e.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(t))throw new TypeError("Invalid hex string: contains non-hex characters");if(t.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(t.length===0)return new Uint8Array(0);z(t.length/2,"hex parsing");let r=new Uint8Array(t.length/2);for(let n=0;n<t.length;n+=2){let o=t.substr(n,2);r[n/2]=parseInt(o,16)}return r},xe=e=>{le(e,"utf8");try{let r=new TextEncoder().encode(e);return z(r.length,"UTF-8 encoding"),r}catch(t){throw new TypeError("Failed to encode UTF-8 string: "+t.message)}},Je=e=>{le(e,"binary"),z(e.length,"binary encoding");let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);t[r]=n}return t},qe=e=>{le(e,"base64");let t=e.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(t))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(t);z(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let o=0;o<r.length;o++)n[o]=r.charCodeAt(o);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},$e=e=>{let t;if(e instanceof ArrayBuffer)z(e.byteLength,"ArrayBuffer processing"),t=new Uint8Array(e);else if(ArrayBuffer.isView(e))z(e.byteLength||e.length,"TypedArray processing"),t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);else if(Array.isArray(e)){z(e.length,"Array processing");for(let r=0;r<e.length;r++){let n=e[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}t=new Uint8Array(e)}else if(typeof e=="object"&&e!==null&&typeof e.length=="number"){z(e.length,"array-like processing");let r=Array.from(e);for(let n=0;n<r.length;n++){let o=r[n];if(typeof o!="number"||o<0||o>255||!Number.isInteger(o))throw new TypeError(`Invalid byte value at index ${n}: ${o} (must be integer 0-255)`)}t=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof e);return t};Object.assign(Y,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let t=arguments[0];if(t==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof t=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=Ke(t);break;case"utf8":case"utf-8":r=xe(t);break;case"binary":case"latin1":r=Je(t);break;case"base64":r=qe(t);break;case"ascii":le(t,"ascii");for(let o=0;o<t.length;o++)if(t.charCodeAt(o)>127)throw new TypeError(`Invalid ASCII character at position ${o}: ${t.charCodeAt(o)} > 127`);r=xe(t);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=$e(t);if(!r||r.length===0)return Q.from(new Uint8Array(0));try{return Q.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(e,t=0){if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Length must be a non-negative integer");if(z(e,"buffer allocation"),typeof t=="number"){if(t<0||t>255||!Number.isInteger(t))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof t=="string"){if(t.length!==1)throw new TypeError("Fill string must be exactly one character");if(t=t.charCodeAt(0),t>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(e);return t!==0&&r.fill(t),Q.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be an array");if(e.length===0)return Q.from(new Uint8Array(0));let t=0,r=[];for(let n=0;n<e.length;n++){let o=e[n];if(!o)throw new TypeError(`Array element at index ${n} is null or undefined`);let s;try{s=$e(o)}catch(m){throw new TypeError(`Invalid array element at index ${n}: ${m.message}`)}t+=s.length,z(t,"buffer concatenation"),r.push(s)}try{let n=new Uint8Array(t),o=0;for(let s of r)n.set(s,o),o+=s.length;return Q.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(e){return e instanceof Q||e&&typeof e=="object"&&e.constructor===Y},byteLength(e,t="utf8"){if(typeof e!="string")throw new TypeError("First argument must be a string");switch(t.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(e).length;case"ascii":case"binary":case"latin1":return e.length;case"base64":let r=e.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(e.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+t)}}});Y.prototype.from=Y.from;Y.prototype.toString=function(e="utf8",t=0,r=this.length){if(typeof e!="string")throw new TypeError("Encoding must be a string");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<t)throw new TypeError("End must be an integer >= start");try{return Q.prototype.toString.call(this,e,t,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var J=Y;var We=typeof document>"u",je=We?(await import("node:crypto")).webcrypto:globalThis.crypto,P=je.subtle,pe=e=>typeof e=="string"?e:JSON.stringify(e),ie=e=>{try{return JSON.parse(e)}catch{return e}},de=e=>{let t=new Uint8Array(J.alloc(e));return J.from(je.getRandomValues(t))},te=(e,t)=>{let[r,n]=e.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},se=async e=>{let t=await P.digest({name:"SHA-256"},new TextEncoder().encode(pe(e)));return J.from(t)},we=async(e,t)=>{let r=e+t.toString("utf8"),n=J.from(await se(r),"binary"),o=Ge(n);return await P.importKey("jwk",o,{name:"AES-GCM"},!1,["encrypt","decrypt"])},Ge=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var Xe={pair:async e=>{let t=await P.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async o=>{let s=await P.exportKey("jwk",o.publicKey);return{priv:(await P.exportKey("jwk",o.privateKey)).d,pub:s.x+"."+s.y}}),r=await P.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async o=>{let s=await P.exportKey("jwk",o.publicKey);return{epriv:(await P.exportKey("jwk",o.privateKey)).d,epub:s.x+"."+s.y}}),n={pub:t.pub,priv:t.priv,epub:r.epub,epriv:r.epriv};return e&&e(n),n},encrypt:async(e,t,r)=>{if(!t||!t.epriv)return r&&r(null),null;let n={s:de(9),iv:de(15)},o=await we(t.epriv,n.s).then(m=>P.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},m,new TextEncoder().encode(pe(e)))),s={ct:J.from(o,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(s),s},decrypt:async(e,t,r)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return r&&r(null),null;let n={ct:J.from(e.ct,"base64"),iv:J.from(e.iv,"base64"),s:J.from(e.s,"base64")};try{let o=await we(t.epriv,n.s).then(m=>P.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},m,new Uint8Array(n.ct))),s=ie(new TextDecoder("utf8").decode(o));return r&&r(s),s}catch{return r&&r(null),null}},verify:async(e,t,r)=>{if(!t||!t.pub)return r&&r(null),null;let n=ie(e),o=await P.importKey("jwk",te(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),s={};if(typeof n.m=="string")s=n.m;else for(let h of Object.keys(n.m).sort())h!=="_"&&h!==F&&h!==W&&(s[h]=n.m[h]);let m=await se(s),d=new Uint8Array(J.from(n.s,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}};if(await P.verify(a,o,d,new Uint8Array(m))){let h=ie(n.m);return r&&r(h),h}return r&&r(null),null},verifyProperties:async(e,t,r)=>{if(!t||!e)return r&&r([]),[];let n=await P.importKey("jwk",te(t),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),o={name:"ECDSA",hash:{name:"SHA-256"}},s=[],m=e._&&e._.s||{};for(let d of Object.keys(e).sort()){if(d==="_"||d==F)continue;let a=m[d];if(!a){console.log(`warning: property '${d}' missing signature`);continue}try{let h=await se(e[d]),f=new Uint8Array(J.from(a,"base64"));await P.verify(o,n,f,new Uint8Array(h))?s.push(d):console.log(`warning: property '${d}' signature verification failed`)}catch(h){console.log(`warning: property '${d}' error verifying: ${h.message}`)}}return r&&r(s),s},sign:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n={};if(typeof e=="string")n=e;else{let h=ie(e);for(let f of Object.keys(h).sort())f!=="_"&&f!==F&&f!==W&&(n[f]=h[f])}let o=await se(n),s=te(t.pub,t.priv),m={name:"ECDSA",namedCurve:"P-256"},d=await P.importKey("jwk",s,m,!1,["sign"]).then(h=>P.sign({name:"ECDSA",hash:{name:"SHA-256"}},h,new Uint8Array(o))),a={m:n,s:J.from(d,"binary").toString("base64")};return r&&r(a),a},signProperties:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n=ie(e),o={},s=te(t.pub,t.priv),m={name:"ECDSA",namedCurve:"P-256"},d=await P.importKey("jwk",s,m,!1,["sign"]);for(let a of Object.keys(n).sort())if(a!=="_"&&a!=F&&a!=W){let h=await se(n[a]),f=await P.sign({name:"ECDSA",hash:{name:"SHA-256"}},d,new Uint8Array(h));o[a]=J.from(f,"binary").toString("base64")}return r&&r(o),o},work:async(e,t,r)=>{typeof t=="function"&&(r=t,t=void 0),typeof t>"u"&&(t=de(9));let n=await P.importKey("raw",new TextEncoder().encode(pe(e)),{name:"PBKDF2"},!1,["deriveBits"]),o={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},s=await P.deriveBits(o,n,512),m={epriv:J.from(s,"binary").toString("base64")};return r&&r(m),m},secret:async(e,t,r)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},o=te(e.epub),s=await P.importKey("jwk",o,n,!0,[]),m=te(t.epub,t.epriv,!1);delete m.key_ops;let d=await P.importKey("jwk",m,n,!1,["deriveBits"]).then(async a=>{let h=await P.deriveBits({public:s,name:"ECDH",namedCurve:"P-256"},a,256),f=await P.importKey("raw",new Uint8Array(h),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return P.exportKey("jwk",f).then(({k:y})=>y)});return r&&r({epriv:d}),{epriv:d}}},K=Xe;var Ae=100,Ce=1e4,be=(e,t,r,n)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});be.mix=async(e,t,r,n)=>{if(!e||typeof e!="object")throw new TypeError("change must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let o=Date.now(),s={},m={},d=new Map,a=0;for(let f of Object.keys(e)){let y=e[f],k=!1,i=!1,l=0,g=r;if(!y||!y._)continue;let c=y[F];if(y._.s&&c&&(g=!0),f.length>1&&f[0]==="~")if(f[1]==="@")i=!0,g=!1;else{if(c&&f!="~"+c){console.log(`error public key does not match for soul: ${f}`);continue}g=!0}if(g){if(!c||!y._)continue;let u=await K.verifyProperties(y,c);if(u.length===0)continue;d.set(f,new Set(u))}for(let u of Object.keys(y)){if(u==="_"||u===W||u===F||d.has(f)&&!d.get(f).has(u))continue;let p=y[u],E=y._&&y._[">"]?y._[">"][u]:0,w=(t[f]||{})[u],S=(t[f]||{_:{">":{}}})._[">"][u]||0;if(i&&u!==U.is(p)){console.log(`error alias ${i}: ${u} !== ${U.is(p)}`);continue}let _=E-o;if(_>0){if(_>864e5)continue;(a===0||_<a)&&(a=l=_),m[f]||(m[f]={_:{"#":f,">":{},s:{}}}),m[f][u]=p,m[f]._[">"][u]=E,y._.s&&y._.s[u]&&(m[f]._.s[u]=y._.s[u])}else be(E,S,p,w).incoming&&(s[f]||(s[f]={_:{"#":f,">":{},s:{}}}),t[f]||(t[f]={_:{"#":f,">":{},s:{}}}),t[f][u]=s[f][u]=p,t[f]._[">"][u]=s[f]._[">"][u]=E,y._.s&&y._.s[u]&&(t[f]._.s[u]=s[f]._.s[u]=y._.s[u]),n[f]&&setTimeout(()=>{n[f]&&n[f].filter(O=>V(O["."],u)).forEach(O=>O.cb())},Ae),k=!0)}g&&l!==0&&s[f]&&(Object.assign(m[f],s[f]),delete s[f]),k&&n[f]&&setTimeout(()=>{n[f]&&n[f].filter(u=>V(u["."])).forEach(u=>u.cb())},Ae)}let h=Object.keys(t);return h.length>Ce&&h.map(k=>{let i=t[k]._&&t[k]._[">"],l=i?Math.max(...Object.values(i)):0;return{soul:k,maxState:l}}).sort((k,i)=>k.maxState-i.maxState).slice(0,h.length-Ce).forEach(({soul:k})=>delete t[k]),{now:s,defer:m,wait:a}};var Se=be;var G="",ue="",Oe=()=>{let e=(t,r,n)=>{if(n||(e[G]||(e[G]={}),n=e[G]),!t)return n;let o=0,s={},m=t[o],d=t.length-1,a=typeof r>"u",h=n[m];for(;!h&&o<d;)m+=t[++o],h=n[m];if(h)if(o===d){if(a)return typeof h[ue]>"u"?h[G]:h[ue];h[ue]=r}else return!h[G]&&!a&&(h[G]={}),e(t.slice(++o),r,h[G]);else if(L.map(n,(y,k)=>{let i=0,l="";for(;k[i]===t[i];)l+=k[i++];if(l){if(a)return i<=d?void 0:(s[k.slice(i)]=y,y);let g={[k.slice(i)]:y,[t.slice(i)]:{[ue]:r}};return n[l]={[G]:g},delete n[k],!0}})){if(a)return s}else{if(a)return;n[m]||(n[m]={}),n[m][ue]=r}};return e};Oe.map=function e(t,r,n,o){o||(o=[]);var s=t[G]||t,m=Object.keys(s).sort(),d;for(let a=0;a<m.length;a++){let h=m[a],f=s[h],y=f[ue];if(typeof y<"u"){if(y=r(y,o.join("")+h,h,o),typeof y<"u")return y}else n&&r(d,o.join(""),h,o);if(f[G]){if(o.push(h),y=e(f[G],r,n,o),typeof y<"u")return y;o.pop()}}};var q=Oe;var ve="",Ie="",H="",re=e=>{var t;let r=new Map,n=null,o=0,s=1e4,m=new Map,d=0,a=3e4,h=.8,f=.9;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=100),e.write||(e.write=1),e.size||(e.size=1024*1024),e.memoryLimit||(e.memoryLimit=500),typeof e.cache>"u"&&(e.cache=!0),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let y=(l,g,c,u)=>{let p=Date.now()-g;p>2e3&&console.log(`[RADISK-SLOW] ${l}: ${p}ms for ${c}${u?` (${u} bytes)`:""}`)},k=()=>{if(typeof process>"u"||!process.memoryUsage)return;let l=Date.now();if(l-d<a)return;d=l;let g=process.memoryUsage(),c=g.heapUsed,u=g.heapTotal,p=e.memoryLimit*1024*1024,E=c/p;if(E>f){let w=r.size;console.log(`[RADISK-MEMORY] High memory usage: ${Math.round(E*100)}% of heap limit. Clearing ${w} cached files.`),r.clear(),global.gc&&global.gc(),d=l+a}else E>h&&console.log(`[RADISK-MEMORY] Memory warning: ${Math.round(E*100)}% of heap limit used. Cache size: ${r.size} files.`)},i=(l,g,c)=>{if(l=""+l,typeof g=="function"){if(c=g,g=i.batch(l),typeof g<"u"||i.thrash.at&&(g=i.thrash.at(l),typeof g<"u"))return c(t,g);if(m.has(l)){m.get(l).push(c);return}m.set(l,[c]);let u=Date.now();return i.read(l,(p,E)=>{y("read",u,l);let w=m.get(l)||[];m.delete(l),w.forEach(S=>S(p,E))})}if(i.batch(l,g),k(),c&&i.batch.acks.push(c),++i.batch.ed>=e.batch)return i.thrash();clearTimeout(i.batch.timeout),i.batch.timeout=setTimeout(i.thrash,e.write)};return i.batch=q(),i.batch.acks=[],i.batch.ed=0,i.thrash=()=>{if(i.thrash.ing)return i.thrash.more=!0;let l=Date.now();clearTimeout(i.batch.timeout),i.thrash.more=!1,i.thrash.ing=!0;var g=i.thrash.at=i.batch;i.batch=null,i.batch=q(),i.batch.acks=[],i.batch.ed=0;let c=0;i.save(g,u=>{++c>1||(y("thrash",l,`batch-${g.ed}`),u&&e.log(u),g.acks.forEach(p=>p(u)),i.thrash.at=null,i.thrash.ing=!1,i.thrash.more&&i.thrash())})},i.save=(l,g)=>{let c={find:(u,p)=>{if(!(p<c.start))return c.start=p,e.store.list(c.lex),!0},lex:u=>{!u||u>c.start?(c.end=u,c.start&&c.mix(c.file||"!",c.start,c.end)):c.file=u},mix:(u,p,E)=>{if(c.start=c.end=c.file=t,r.has(u)){let w=r.get(u);q.map(l,(S,_)=>{if(!(_<p)){if(E&&E<_){c.start=_;return}w(_,S)}}),i.write(u,w,c.next)}else i.parse(u,(w,S)=>{if(w)return g(w);q.map(l,(_,$)=>{if(!($<p)){if(E&&E<$){c.start=$;return}S($,_)}}),i.write(u,S,c.next)})},next:u=>{if(u)return g(u);if(c.start)return q.map(l,c.find);g(u)}};q.map(l,c.find)},i.write=(l,g,c)=>{let u={text:"",limit:"",done:!1,count:0,each:(E,w,S,_)=>{if(u.done)return;u.count++,E=typeof E>"u"?"":"="+re.encode(E);let $=re.encode(_.length)+"#"+re.encode(S)+E+`
`;if(u.count>1&&_.length===0&&u.text.length+$.length>e.size){let O=S.indexOf(Ie);if(u.limit=O===-1?S:S.substring(0,O),u.limit!==l){u.done=!0,u.sub=q(),q.map(g,u.slice),i.write(u.limit,u.sub,c);return}}u.text+=$},slice:(E,w)=>{w<u.limit||u.sub(w,E)}};q.map(g,u.each,!0);let p=Date.now();e.store.put(l,u.text,E=>{y("file-write",p,l,u.text.length),c(E)})},i.read=(l,g)=>{let c=l.indexOf(Ie),u=c===-1?l:l.substring(0,c),p={lex:w=>{if(!w){if(!p.file){g("no file found",t);return}if(e.cache&&r.has(p.file)){let S=r.get(p.file);return p.value=S(l),g(t,p.value)}i.parse(p.file,p.it);return}w>u||w<p.file||(p.file=w)},it:(w,S)=>{w&&e.log(w),S&&(e.cache&&(r.set(p.file,S),k()),p.value=S(l)),g(w,p.value)}},E=Date.now();if(e.cache&&n&&E-o<s)n.forEach(w=>p.lex(w)),p.lex();else{let w=[],S=p.lex;p.lex=_=>(_&&w.push(_),S(_)),e.store.list(_=>{p.lex(_),!_&&e.cache&&(n=w,o=E)})}},i.parse=(l,g)=>{let c={disk:q(),read:(u,p)=>{if(u)return g(u);if(!p)return g(t,c.disk);let E=[],w="",S=c.split(p);for(;S;){let _,$,O=S[1];S=c.split(S[2])||"",S[0]==="#"&&(_=S[1],O<E.length&&(E.length=O),O<=E.length&&(E[O]=_,E.length=O+1),w=E.join("")),S=c.split(S[2])||"",S[0]!==`
`&&(S[0]==="="&&($=S[1]),typeof _<"u"&&typeof $<"u"&&c.disk(w,$),S=c.split(S[2]))}g(t,c.disk)},split:u=>{if(!u)return;let p=u.indexOf(H);if(p===-1)return;let E=u.slice(0,p),w={};return[E,re.decode(u.slice(p),w),u.slice(p+w.i)]}};e.store.get(l,c.read)},i};re.encode=e=>{let t="",r="";if(e instanceof Array&&(e.length===2||e.length===3)&&(t=ve+e[1],e.length===3&&e[2]&&(r=ve+e[2]),e=e[0]),typeof e=="string"){let o=0,s=null,m=H;for(;s=e[o++];)s===H&&(m+=H);return m+'"'+e+t+r+H}let n=U.is(e);if(n)return H+"#"+n+t+r+H;if(fe.is(e))return H+"+"+(e||0)+t+r+H;if(e===!0)return H+"+"+t+r+H;if(e===!1)return H+"-"+t+r+H;if(e===null)return H+" "+t+r+H};re.decode=(e,t)=>{var r=-1,n=0,o=null,s=null,m=-1,d=-1;if(e[0]!==H)return;for(;o=e[++r];)if(s){if(m===-1&&(m=r),o===H&&--n<=0){d=r;break}}else o===H?n++:s=o||!0;let a=m!==-1?e.slice(m,d!==-1?d:r):"";t&&(t.i=r+1);let h=a.split(ve),f=h[0],y=h[1],k=h[2];if(y)if(y=parseFloat(y),k){if(s==='"')return[f,y,k];if(s==="#")return[U.ify(f),y,k];if(s==="+")return f.length===0?[!0,y,k]:[parseFloat(f),y,k];if(s==="-")return[!1,y,k];if(s===" ")return[null,y,k]}else{if(s==='"')return[f,y];if(s==="#")return[U.ify(f),y];if(s==="+")return f.length===0?[!0,y]:[parseFloat(f),y];if(s==="-")return[!1,y];if(s===" ")return[null,y]}else{if(s==='"')return a;if(s==="#")return U.ify(a);if(s==="+")return a.length===0?!0:parseFloat(a);if(s==="-")return!1;if(s===" ")return null}};var Ne=re;var Pe=typeof document>"u",Z=Pe?await import("node:fs"):void 0,Me="",he="",ke=he+"+0"+he+"#"+he+'"root'+he,Qe=e=>{let t=e.file;if(Pe)return Z.existsSync(t)||Z.mkdirSync(t),Z.existsSync(t+"/!")||Z.writeFileSync(t+"/!",ke),{get:(r,n)=>{Z.readFile(t+"/"+r,(o,s)=>{if(o){if(o.code==="ENOENT"){n();return}console.log("fs.readFile error:",o)}s&&(s=s.toString()),n(o,s)})},put:(r,n,o)=>{var s=r+"."+R.random(9)+".tmp";Z.writeFile(s,n,m=>{if(m){console.log("fs.writeFile error:",m),o(m);return}Z.rename(s,t+"/"+r,o)})},list:r=>{Z.readdir(t,(n,o)=>{if(n){console.log("fs.readdir error:",n),r();return}o.forEach(r),r()})}};if(e.indexedDB){let r,n=indexedDB.open(t,1);return n.onupgradeneeded=o=>{o.target.result.createObjectStore(t)},n.onerror=o=>{console.log(o)},n.onsuccess=()=>{if(r=n.result,r){let s=r.transaction([t],"readonly").objectStore(t).getKey("!");s.onerror=()=>{console.log(`error getting key ${t}/!`)},s.onsuccess=()=>{if(!s.result){let d=r.transaction([t],"readwrite").objectStore(t).put(ke,"!");d.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(o,s)=>{let m=(h,f)=>{let k=r.transaction([t],"readonly").objectStore(t).get(h);k.onerror=()=>{console.log(`error getting ${t}/${h}`)},k.onsuccess=()=>{f(null,k.result)}};if(r){m(o,s);return}let d=0,a=setInterval(()=>{if(r){clearInterval(a),m(o,s);return}d++>5&&(clearInterval(a),s("error indexedDB not available"))},1e3)},put:(o,s,m)=>{let d=(f,y,k)=>{let l=r.transaction([t],"readwrite").objectStore(t).put(y,f);l.onerror=()=>{console.log(`error putting data on ${t}/${f}`)},l.onsuccess=()=>{k(null)}};if(r){d(o,s,m);return}let a=0,h=setInterval(()=>{if(r){clearInterval(h),d(o,s,m);return}a++>5&&(clearInterval(h),m("error indexedDB not available"))},1e3)},list:o=>{let s=a=>{let f=r.transaction([t],"readonly").objectStore(t).getAllKeys();f.onerror=()=>console.log("error getting keys for",t),f.onsuccess=()=>{f.result.forEach(a),a()}};if(r){s(o);return}let m=0,d=setInterval(()=>{if(r){clearInterval(d),s(o);return}m++>5&&(clearInterval(d),console.log("error indexedDB not available"),o())},1e3)}}}return{get:(r,n)=>{n(null,ke)},put:(r,n,o)=>{o(null)},list:r=>{r("!"),r()}}},Ye=e=>{L.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Qe(e));let t=Ne(e);return{get:(r,n)=>{if(!r||!L.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}var o=r["#"],s=typeof r["."]=="string"?r["."]:"",m,d={};let a=(h,f)=>{V(r["."],f)&&(m||(m={_:{"#":o,">":{}}}),m[f]=h[0],m._[">"][f]=h[1],h.length===3&&h[2]&&(d[f]=h[2]))};t(o+Me+s,(h,f)=>{let y;L.is(f)?(q.map(f,a),m||a(f,s),y={[o]:m}):f&&(a(f,s),y={[o]:m}),y&&y[o]&&Object.keys(d).length>0&&(y[o]._.s=d),n(h,y)})},put:(r,n)=>{if(!r){n("graph required");return}let o=0,s=!1,m=d=>{if(o--,!s){if(d){s=!0,n(d);return}o===0&&(s=!0,n(null))}};Object.keys(r).forEach(d=>{var a=r[d];Object.keys(a).forEach(h=>{if(h==="_")return;o++;let f=a[h],y=a._[">"][h],k=a._.s&&a._.s[h],i=k?[f,y,k]:[f,y];t(d+Me+h,i,m)})})}}},Re=Ye;var De=typeof document>"u",Ue=De?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Ue?.WebSocket);var Ze=e=>{let t=new Map,r=1500,n=6e4,o=10,s=null;return e||(s=setInterval(()=>{let d=Date.now();for(let[a,h]of t.entries())d-h.lastCleanup>n&&(h.requests=[],h.lastCleanup=d),h.requests=h.requests.filter(f=>d-f<n),d-h.lastCleanup>n*10&&(h.throttleCount=0)},n/4)),{getDelay:d=>{let a=Date.now(),h=t.get(d)||{requests:[],lastCleanup:a,throttleCount:0};if(h.requests=h.requests.filter(f=>a-f<n),h.requests.length>=r){let f=Math.min(...h.requests),y=n-(a-f);return h.throttleCount=(h.throttleCount||0)+1,t.set(d,h),Math.max(0,y)}return h.requests.push(a),t.set(d,h),0},getRemainingRequests:d=>{let a=t.get(d);if(!a)return r;let h=Date.now(),f=a.requests.filter(y=>h-y<n);return Math.max(0,r-f.length)},getThrottleCount:d=>{let a=t.get(d);return a&&a.throttleCount||0},shouldDisconnect:d=>{let a=t.get(d);return a?a.throttleCount>=o:!1},destroy:()=>{s&&(clearInterval(s),s=null),t.clear()}}},Ve=(e,t=1024*1024)=>{try{if(typeof e=="string"&&e.length>t)throw new Error("Message too large");return{success:!0,data:JSON.parse(e)}}catch(r){return{success:!1,error:r.message}}},et=(e,t=1024*1024)=>typeof e=="string"&&e.length>t?{valid:!1,error:"Message too large"}:Buffer.isBuffer(e)&&e.length>t?{valid:!1,error:"Message too large"}:{valid:!0},tt=(e=1e3)=>{let t=new Set;return{add:r=>{if(t.size>=e)return!1;t.add(r);let n=r.close;return r.close=(...o)=>(t.delete(r),n.apply(r,o)),!0},remove:r=>{t.delete(r)},count:()=>t.size,isFull:()=>t.size>=e}},Ee=(e=5)=>{let t=0;return{shouldRetry:()=>t<e,getDelay:()=>Math.min(1e3*Math.pow(2,t),3e4),increment:()=>t++,reset:()=>t=0}},rt=e=>{let t=_e(e.maxAge),r=Re(e),n={},o={},s={},m=new Set,d=new Map,a=async x=>n[x]?!0:new Promise(v=>{r.get({"#":x},(b,T)=>{v(!b&&T&&T[x])})}),h=e.wss&&e.wss.constructor.name==="Server",f=Ze(h),y=tt(e.maxConnections||1e3),k=async(x,v,b)=>{for(let T of Object.keys(x)){let j=await new Promise(I=>{g({"#":T},I,v)});if(j.err)return b&&b(j.err),!1;let A=x[T],M=F;if(!(!j.put||!j.put[T]||j.put[T][M]===A[M]))return b&&b(`error in wire check public key does not match for soul: ${T}`),!1}return!0},i=(x,v)=>{let b=me(x.get,n);b?v(JSON.stringify({"#":t.track(R.random(9)),"@":x["#"],put:b})):r.get(x.get,(T,j)=>{v(JSON.stringify({"#":t.track(R.random(9)),"@":x["#"],put:j,err:T}))})},l=async(x,v)=>{let b=await Se.mix(x.put,n,e.secure,s);if(Object.keys(b.now).length===0){Object.keys(b.defer).length!==0&&setTimeout(()=>l({put:b.defer,"#":x["#"]},v),b.wait);return}await k(b.now,v)&&(r.put(b.now,T=>{v(JSON.stringify({"#":t.track(R.random(9)),"@":x["#"],err:T}))}),Object.keys(b.defer).length!==0&&setTimeout(()=>l({put:b.defer,"#":x["#"]},v),b.wait))},g=(x,v,b,T)=>{if(!v)return;L.is(T)||(T={});let j=me(x,n),A=R.random(9),M=JSON.stringify({"#":t.track(A),get:e.secure?{"#":x["#"]}:x});if(j){let I=b(M);if(I&&I.err){v({err:I.err});return}v({put:j});return}r.get(x,(I,D)=>{if(D){let B=b(M);if(B&&B.err){v({err:B.err});return}v({put:D,err:I});return}I&&console.log(I),o[A]=v,d.set(A,{lex:x,wait:T.wait||100});let N=b(M);if(N&&N.err){v({err:N.err}),delete o[A],d.delete(A);return}})},c=x=>({get:(v,b,T)=>{v&&v["#"]&&m.add(v["#"]),g(v,b,x,T)},put:async(v,b)=>{let T=await Se.mix(v,n,e.secure,s);if(Object.keys(T.now).length===0){b&&b(null);return}if(!await k(T.now,x,b))return;for(let[A,M]of Object.entries(T.now))if(M&&typeof M=="object")for(let[I,D]of Object.entries(M)){let N=U.is(D);N&&m.add(N)}r.put(T.now,b);let j=x(JSON.stringify({"#":t.track(R.random(9)),put:v}));if(j&&j.err){b&&b(j.err);return}},on:(v,b,T,j)=>{let A=v&&v["#"];!A||!b||(s[A]?s[A].push({".":v["."],cb:b}):s[A]=[{".":v["."],cb:b}],T&&g(v,b,x,j))},off:(v,b)=>{let T=v&&v["#"];if(!(!T||!s[T]))if(b){let j=s[T].find(A=>A.cb===b);j&&s[T].splice(s[T].indexOf(j),1)}else delete s[T]}});if(De){let x=e.wss,v=()=>x.clients();if(!x){let T=e.server?{server:e.server}:{port:e.port||8765};x=new Ue.WebSocketServer(T),v=()=>x.clients}let b=(T,j)=>{let M=JSON.parse(T)["#"];if(M&&d.has(M)){let I=d.get(M);d.delete(M),I.timeoutId=setTimeout(()=>{let D=o[M];if(D){let N=I.lex["#"],B={[N]:null};typeof I.lex["."]=="string"&&(B[N]={[I.lex["."]]:null}),D({put:B}),delete o[M]}},I.wait)}v().forEach(I=>{if(I&&I.readyState===WebSocket.OPEN)I.send(T,{binary:j});else{let D=I._retryHandler||Ee();if(I._retryHandler=D,D.shouldRetry()){let N=D.getDelay();D.increment(),setTimeout(()=>{I&&I.readyState===WebSocket.OPEN&&(D.reset(),I.send(T,{binary:j}))},N)}}})};return x.on("connection",T=>{if(!y.add(T)){console.log("Connection limit reached, rejecting connection"),T.close(1013,"Connection limit reached - try again later");return}let j=R.random(9);console.log(`New WebSocket client connected: ${j}`),T.on("error",A=>{console.log("WebSocket error:",A),y.remove(T)}),T.on("close",()=>{console.log(`WebSocket client disconnected: ${j}`),y.remove(T)}),T.on("message",(A,M)=>{let I=et(A,e.maxMessageSize);if(!I.valid){console.warn(`Invalid message: ${I.error}`),T.send(JSON.stringify({error:I.error}));return}let D=Ve(A,e.maxMessageSize);if(!D.success){console.warn(`JSON parse error: ${D.error}`),T.send(JSON.stringify({error:"Invalid JSON"}));return}let N=D.data;if(t.check(N["#"]))return;let B=f.getDelay(j);if(B>0){let oe=f.getThrottleCount(j);if(console.log(`Client ${j}: rate limit exceeded, delay would be ${B}ms, dropping message (throttle count: ${oe})`),f.shouldDisconnect(j)){console.log(`Client ${j}: Disconnecting after ${oe} throttle violations`),T.close(1008,"Rate limit violations");return}T.send(JSON.stringify({"#":t.track(R.random(9)),"@":N["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(B/1e3)}s`,throttle:B}));return}let ne=()=>{t.track(N["#"]),N.get&&i(N,b),N.put&&l(N,b),b(A,M);let oe=N["@"],ae=o[oe];ae&&(delete N["#"],delete N["@"],ae(N),delete o[oe])};B>0?setTimeout(ne,B):ne()})}),c(b)}let u=[],p=!1,E=0,w=[],S=null,_=e.maxQueueLength||1e4,$=()=>{if(w.length===0){S=null;return}let x=Date.now();if(p&&x<E){S=setTimeout($,Math.min(1e3,E-x));return}p&&x>=E&&(console.log("Throttle period ended, resuming queue processing"),p=!1,E=0);let v=w[0];if(O(v)){w.shift();let j=JSON.parse(v)["#"];if(j&&d.has(j)){let A=d.get(j);d.delete(j),A.timeoutId=setTimeout(()=>{let M=o[j];if(M){let I=A.lex["#"],D={[I]:null};typeof A.lex["."]=="string"&&(D[I]={[A.lex["."]]:null}),M({put:D}),delete o[j]}},A.wait)}}w.length>0?S=setTimeout($,50):S=null},O=x=>{let v=!1;return u.forEach(b=>{if(b&&b.readyState===WebSocket.OPEN)b.send(x),v=!0;else{let T=b._retryHandler||Ee();if(b._retryHandler=T,T.shouldRetry()){let j=T.getDelay();T.increment(),setTimeout(()=>{b&&b.readyState===WebSocket.OPEN&&(T.reset(),b.send(x))},j)}}}),v},C=x=>{if(w.length>=_)return{err:`Message queue exceeded maximum length (${_}). Update query logic to request less data.`,queueLength:w.length,maxQueueLength:_};w.push(x),S||(S=setTimeout($,50))};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(x=>{let v=()=>{let b=new WebSocket(x);u.push(b);let T=Ee();b.onclose=j=>{if(u.indexOf(b)!==-1&&u.splice(u.indexOf(b),1),b=null,T.shouldRetry()){let A=T.getDelay();T.increment(),setTimeout(v,A)}},b.onopen=()=>{T.reset()},b.onerror=j=>{console.log(j)},b.onmessage=async j=>{let A=JSON.parse(j.data);if(t.check(A["#"]))return;if(A.throttle&&A.err){console.log(`Server throttling: ${A.err}`),p=!0,E=Date.now()+A.throttle;return}if(t.track(A["#"]),A.get&&i(A,C),A.put){let D={};for(let[N,B]of Object.entries(A.put)){let ne=!1;if(await a(N)&&(ne=!0,B&&typeof B=="object"))for(let[oe,ae]of Object.entries(B)){let Te=U.is(ae);Te&&m.add(Te)}m.has(N)&&(ne=!0,m.delete(N)),ne&&(D[N]=B)}if(Object.keys(D).length>0){let N={put:D,"#":A["#"]};l(N,C)}}let M=A["@"],I=o[M];I&&(delete A["#"],delete A["@"],I(A),delete o[M])}};v()}),c(C)},ye=rt;var nt=(e,t)=>{t||(t=ye(e));let r=[],n=!1,o=!1,s=0,m=(a,h,f,y)=>{let k=c=>{s++,m(c,h,f,y)},i=c=>{r=[],s=0,o=!1,y(c)},l=()=>{if(r.length===0){i("Wrong username or password");return}let c=r.shift();t.get({"#":c},async u=>{if(u.err){i(`error getting ${c}: ${u.err}`);return}let p=u.put&&u.put[c];if(!p||!p.auth)return l();let E=JSON.parse(p.auth),w=await K.work(h,E.salt),S=await K.decrypt(E.enc,w);if(!S)return l();if(d.is={username:a,pub:p.pub,epub:p.epub,priv:S.priv,epriv:S.epriv},f!==""){let _=R.random(64),$=await K.work(f,_),O=await K.encrypt(S,$),C={auth:JSON.stringify({enc:O,salt:_})},x=await K.signProperties(C,d.is),v=X(c,C,x,p.pub);t.put(v,b=>{i(b?`error putting ${C} on ${c}: ${b}`:null)});return}if(!p._||!p._.s||Object.keys(p._.s).length===0){let _={};for(let C of Object.keys(p))C!=="_"&&C!==F&&C!==W&&(_[C]=p[C]);let $=await K.signProperties(_,d.is),O=X(c,_,$,p.pub);t.put(O,C=>{C&&console.log(`warning: failed to migrate signatures on login: ${C}`),i(null)});return}return i(null)},{wait:5e3})};if(s>9){i("Wrong username or password");return}let g="~@"+a;t.get({"#":g},async c=>{if(c.err){i(`error getting ${g}: ${c.err}`);return}let u=c.put&&c.put[g];if(!u)return k(a);delete c.put[g]._,r=Object.keys(u),l()},{wait:5e3})},d={create:(a,h,f)=>{let y=i=>{f?f(i):console.log(i)};if(n){y("User is already being created");return}if(a===""){y("Please provide a username");return}if(h===""){y("Please provide a password");return}n=!0;let k="~@"+a;t.get({"#":k},async i=>{if(i.err){n=!1,y(`error getting ${k}: ${i.err}`);return}if(i.put&&i.put[k]){n=!1,y("Username already exists");return}let l=R.random(64),g=await K.work(h,l),c=await K.pair(),u={priv:c.priv,epriv:c.epriv},p=await K.encrypt(u,g),E={username:a,pub:c.pub,epub:c.epub,auth:JSON.stringify({enc:p,salt:l})},w="~"+c.pub,S=await K.signProperties(E,c),_=X(w,E,S,c.pub);t.put(_,$=>{if(n=!1,$){y(`error putting ${E} on ${w}: ${$}`);return}let O={[w]:{"#":w}};t.put(X(k,O),C=>{if(C){y(`error putting ${O} on ${k}: ${C}`);return}f&&f(null)})})},{wait:5e3})},auth:(a,h,f)=>{let y=k=>{f?f(k):k&&console.log(k)};if(o){y("User is already authenticating");return}if(d.is=null,a===""){y("Please provide a username");return}if(h===""){y("Please provide a password");return}o=!0,m(a,h,"",y)},change:(a,h,f,y)=>{let k=i=>{y?y(i):i&&console.log(i)};if(o){k("User is already authenticating");return}if(d.is=null,a===""){k("Please provide a username");return}if(h===""){k("Please provide a password");return}if(f===""){k("Please provide a new password");return}o=!0,m(a,h,f,k)},store:a=>{if(!d.is){console.log("Please authenticate before calling store");return}if(a){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let a=globalThis.localStorage.getItem("user.is");if(a){d.is=JSON.parse(a);return}}if(typeof globalThis.sessionStorage<"u"){let a=globalThis.sessionStorage.getItem("user.is");a&&(d.is=JSON.parse(a))}},leave:()=>{d.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(a,h,f)=>{let y=k=>{f?f(k):console.log(k)};if(o){y("User is already authenticating");return}if(a===""){y("Please provide a username");return}if(h===""){y("Please provide a password");return}o=!0,m(a,h,"",async k=>{if(k){y(k);return}let i={username:null,pub:null,epub:null,auth:null},l=await K.signProperties(i,d.is),g="~"+d.is.pub,c=X(g,i,l,d.is.pub);t.put(c,u=>{if(u){y(`error putting null on ${g}: ${u}`);return}d.is=null,f&&f(null)})})}};return d},Le=nt;var ot=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:L.is(e)||(e={});let t=ye(e),r=Le(null,t),n=new Map,o=new Map,s=a=>a===null||a===!0||a===!1||typeof a=="string"||U.is(a)||fe.is(a),m=a=>{if(s(a))return!0;if(L.is(a)){let f=[];for(let[y,k]of Object.entries(a)){if(y==="_")return"error underscore cannot be used as a property name";if(L.is(k)||s(k)){f.push(y);continue}return typeof k>"u"?`error undefined ${y} cannot be converted to a graph`:`error ${JSON.stringify({[y]:k})} cannot be converted to a graph`}if(f.length!==0)return f}return`error ${JSON.stringify(a)} cannot be converted to a graph`},d=a=>{let h=(i,l,g,c)=>{t.get(L.put(i,"#",l),async u=>{if(u.err&&console.log(u.err),u.put&&u.put[l]){delete u.put[l]._,delete u.put[l][F],delete u.put[l][W];for(let p of Object.keys(u.put[l])){let E=U.is(u.put[l][p]);if(E){let w=async(S=0)=>{let _=await new Promise($=>{let O=R.random();o.set(O,{chain:[{item:null,soul:E}]}),d(O).next(null,$,c)});return _!==null||S>=5?_:(await new Promise($=>setTimeout($,50)),w(S+1))};u.put[l][p]=await w()}}g(u.put[l])}else g(null)},c)},f=async(i,l,g,c)=>{if(g){let u=await K.signProperties(l,g);return X(i,l,u,g.pub)}return e.secure?(c||(c=console.log),c(`error putting data on ${i}: user required in secure mode`),null):X(i,l)},y=i=>l=>{let g=o.get(i);g&&typeof g.cb<"u"?setTimeout(()=>g.cb(l),1):l&&console.log("error no callback for data",l,"ctx",g),g&&!g.on&&o.delete(i)},k=(i,l)=>{if(!i){console.log("error resolve request parameter required");return}let g=typeof i.get<"u",c=typeof i.put<"u",u=typeof i.on<"u",p=typeof i.off<"u",E=!1,w=o.get(a);for(var S=1;S<w.chain.length;S++)if(w.chain[S].soul===null){E=!0;break}if(E){let{item:_,soul:$}=w.chain[S-1];return t.get({"#":$,".":_},async O=>{if(O.err){w.user||e.secure?console.log(`error getting ${$}: ${O.err}`):console.log(`error getting ${_} on ${$}: ${O.err}`),l&&l(null);return}let C=O.put&&O.put[$];if(C&&typeof C[_]<"u"){let x=U.is(C[_]);if(x)w.chain[S].soul=x,o.set(a,{...w}),g?d(a).next(null,i.get,l,i._opt):c?d(a).put(i.put,l):u?d(a).on(i.on,l,i._get,i._opt):p&&d(a).off(l);else if(g)l(C[_]);else if(c){x=R.random(),C[_]=U.ify(x);let v=await f($,C,w.user,l);if(v===null)return;t.put(v,b=>{if(b){l(`error putting ${_} on ${$}: ${b}`);return}w.chain[S].soul=x,d(a).put(i.put,l)})}else(u||p&&l)&&l(null)}else if(c){let x=R.random();C||(C={}),C[_]=U.ify(x);let v=await f($,C,w.user,l);if(v===null)return;t.put(v,b=>{if(b){l(`error putting ${_} on ${$}: ${b}`);return}w.chain[S].soul=x,d(a).put(i.put,l)})}else l&&l(null)},i._opt),!1}return g&&w.chain[w.chain.length-1].item!==null?(w.chain.push({item:null,soul:null}),d(a).next(null,i.get,l,i._opt),!1):w.chain[w.chain.length-1]};return{get:(i,l,g,c)=>{if(typeof l=="function"&&(c=g,g=l,l=null),i===null||i===""||i==="_"){console.log("error please provide a key"),g&&g(null);return}if(l&&typeof g!="function"){console.log("error lex requires a callback function");return}if(a=R.random(),o.set(a,{chain:[{item:i,soul:"root"}],cb:g}),!g)return d(a);let u=y(a),{soul:p}=k({get:l,_opt:c},u);p&&h(l,p,u,c)},next:(i,l,g,c)=>{let u=S=>_=>{g?g(_):y(S)(_)};if(typeof l=="function"&&(c=g,g=l,l=null),!a){console.log("error please provide a key using get(key)"),g&&g(null);return}let p=u(a);if(i===""||i==="_"){p(null);return}if(l&&typeof g!="function"){console.log("error lex requires a callback function");return}let E=o.get(a);if(!E)return;if(g&&typeof E.cb>"u"&&(E.cb=g,g=null),i!==null&&E.chain.push({item:i,soul:null}),!E.cb)return d(a);let{soul:w}=k({get:l,_opt:c},p);w&&h(l,w,p,c)},put:(i,l,g)=>{typeof l=="function"&&(g=l,l=!1);let c=_=>$=>{g?g($):y(_)($)};if(!a){g&&g("error please provide a key using get(key)");return}let u=o.get(a);if(!u)return;if(!u.cb){if(!g)return;u.cb=g,g=null}l&&(i={[R.random()]:i});let p=c(a),E=m(i);if(typeof E=="string"){p(E);return}let{item:w,soul:S}=k({put:i},p);if(S){if(E===!0){t.get({"#":S,".":w},async _=>{if(_.err){p(`error getting ${S}: ${_.err}`);return}let $=_.put&&_.put[S],O=$&&$[w],C=U.is(O);if(!C){$||($={}),$[w]=i;let x=await f(S,$,u.user,p);if(x===null)return;t.put(x,p);return}t.get({"#":C},async x=>{if(x.err){p(`error getting ${C}: ${x.err}`);return}if(!x.put||!x.put[C]){p(`error ${C} not found`);return}for(let b of Object.keys(x.put[C])){if(b==="_"||b===F||b===W)continue;let T=await new Promise(j=>{let A=R.random(),M=[{item:b,soul:C}];o.set(A,{chain:M,user:u.user}),d(A).put(null,j)});if(T){p(T);return}}$||($={}),$[w]=i;let v=await f(S,$,u.user,p);v!==null&&t.put(v,p)})});return}t.get({"#":S,".":w},async _=>{if(_.err){p(`error getting ${S}.${w}: ${_.err}`);return}let $=_.put&&_.put[S],O=$&&$[w],C=U.is(O);if(!C){$||($={}),$[w]=U.ify(R.random());let v=await f(S,$,u.user,p);if(v===null)return;t.put(v,b=>{if(b)p(`error putting ${w} on ${S}: ${b}`);else{let T=R.random(),j=[{item:w,soul:S}];o.set(T,{chain:j,user:u.user,cb:u.cb}),d(T).put(i)}});return}let x=[];for(let v of E){let b=await new Promise(T=>{if(L.is(i[v])&&!U.is(i[v])){let j=R.random(),A=[{item:v,soul:C}];o.set(j,{chain:A,user:u.user}),d(j).put(i[v],T)}else x.push(v),T(null)});if(b){p(b,a);return}}if(x.length===0){p(null);return}t.get({"#":C},async v=>{if(v.err){p(`error getting ${C}: ${v.err}`);return}let b=v.put&&v.put[C];b||(b={}),x.forEach(j=>{b[j]=i[j]});let T=await f(C,b,u.user,p);T!==null&&t.put(T,p)})})}},on:(i,l,g,c)=>{if(typeof i=="function"&&(c=g,g=l,l=i,i=null),typeof l!="function"){console.log("error on() requires a callback function");return}if(!a){console.log("error please provide a key using get(key)"),l(null);return}let{item:u,soul:p}=k({on:i,_get:g,_opt:c},l);if(!p)return;o.set(a,{chain:[{item:u,soul:p}],on:!0}),n.set(l,()=>{t.get({"#":p,".":u},w=>{let S=w.put&&w.put[p]&&w.put[p][u],_=U.is(S);if(_){let $=async(O=0)=>{let C=await new Promise(x=>{let v=R.random();o.set(v,{chain:[{item:null,soul:_}]}),d(v).next(null,x,c)});C!==null||O>=5?l(C):(await new Promise(x=>setTimeout(x,50)),$(O+1))};$()}else l(S!==void 0?S:null)},c)});let E;i?E=L.put(i,"#",p):E={"#":p,".":u},t.on(E,n.get(l),!1,c),t.get({"#":p,".":u},w=>{if(w.err){console.log(`error getting ${p}.${u}: ${w.err}`);return}let S=w.put&&w.put[p]&&w.put[p][u],_=U.is(S);if(_){t.off(E,n.get(l));let $;i?$=L.put(i,"#",_):$={"#":_,".":null},t.on($,n.get(l),g,c)}else g&&n.get(l)()},c)},off:i=>{if(!a){console.log("error please provide a key using get(key)"),i&&i(null);return}let{item:l,soul:g}=k({off:!0},i);g&&t.get({"#":g,".":l},c=>{if(c.err){console.log(`error getting ${g}.${l}: ${c.err}`);return}let u=c.put&&c.put[g]&&c.put[g][l],p=U.is(u);p?t.off({"#":p},n.get(i)):t.off({"#":g},n.get(i)),n.delete(i),o.delete(a)})},user:()=>(r.get||(Object.assign(r,d()),r.get=(i,l,g,c)=>{typeof l=="function"&&(c=g,g=l,l=null);let u=null,p=null;if(r.is&&(u=r.is.pub),typeof i=="string"?p=i:i instanceof Array&&(i.length===2?(u=i[0],p=i[1]):i.length===1&&(p=i[0])),!u){console.log("error please log in or provide a public key"),g&&g(null);return}if(p===null||p===""||p==="_"){console.log("error please provide a key"),g&&g(null);return}if(l&&!g){console.log("error lex requires a callback function");return}a=R.random();let E=[{item:p,soul:"~"+u}];if(o.set(a,{chain:E,user:r.is,cb:g}),!g)return d(a);let w=y(a),{soul:S}=k({get:l,_opt:c},w);S&&h(l,S,w,c)}),r),wire:t,SEA:K}};return d()},Pt=ot;export{Pt as default};
//# sourceMappingURL=holster.js.map
