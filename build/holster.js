var X={is:e=>!(e instanceof Array)&&(e-parseFloat(e)+1>=0||e===1/0||e===-1/0)},_={is:e=>e?e instanceof Object&&e.constructor===Object||Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/)[1]==="Object":!1,map:(e,t,o)=>{var r=Object.keys(e);for(let n=0;n<r.length;n++){let u=t(e[r[n]],r[n],o);if(typeof u<"u")return u}},put:(e,t,o)=>(e||(e={}),e[t]=o,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},ve=(e,t,o)=>{if(o.id){o.id=!1;return}if(t==="#"&&typeof e=="string"){o.id=e;return}o.id=!1},T={is:e=>{if(e&&e["#"]&&!e._&&_.is(e)){let t={};if(_.map(e,ve,t),t.id)return t.id}return!1},ify:e=>_.put({},"#",e)},J="_holster_user_public_key",W=(e,t,o,r)=>{let n={[e]:{_:{"#":e,">":{},s:o,p:r}}};for(let[u,l]of Object.entries(t))n[e][u]=l,n[e]._[">"][u]=Date.now();return r&&(n[e][J]=r,n[e]._[">"][J]=Date.now()),n},z=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!_.is(e)||!t)return!1;let o=e["*"];if(o)return t.slice(0,o.length)===o;let r=e[">"],n=e["<"];return r&&n?t>=r&&t<=n:r?t>=r:n?t<=n:!1},E={random:e=>{var t="";let o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let r=0;r<e;r++)t+=o.charAt(Math.floor(Math.random()*o.length));return t}};var Se=e=>{e||(e=9e3);let t={store:{}};return t.check=o=>t.store[o]?t.track(o):!1,t.track=o=>(t.store[o]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{let r=Date.now();Object.keys(t.store).forEach(n=>{r-t.store[n]>e&&delete t.store[n]}),t.expiry=null},e)),o),t},le=Se;var ke=(e,t)=>{let o=e["#"],r=typeof e["."]=="string"?e["."]:!1;var n=t[o];if(!n||!r)return;let u=n[r];if(u)return n={_:n._,[r]:u},n._[">"]={[r]:n._[">"][r]},{[o]:n}},ne=ke;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function Z(){}Object.assign(Z,{from:Array.from});Z.prototype=Object.create(Array.prototype);Z.prototype.toString=function(e,t,o){e||(e="utf8"),t||(t=0);let r=this.length;if(e==="hex"){let n=new Uint8Array(this);return[...Array((o&&o+1||r)-t).keys()].map(u=>n[u+t].toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:(o||r)-t},(n,u)=>String.fromCharCode(this[u+t])).join("");if(e==="base64")return btoa(this)};var M=Z;function I(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),I.from(...e)}I.prototype=Object.create(Array.prototype);Object.assign(I,{from(){if(!Object.keys(arguments).length||arguments[0]==null)throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.");let e=arguments[0],t;if(typeof e=="string"){let r=arguments[1]||"utf8";if(r==="hex"){let n=e.match(/([\da-fA-F]{2})/g).map(u=>parseInt(u,16));if(!n||!n.length)throw new TypeError("Invalid first argument for type 'hex'.");t=M.from(n)}else if(r==="utf8"||r==="binary"){let n=e.length,u=new Uint16Array(n);Array.from({length:n},(l,s)=>u[s]=e.charCodeAt(s)),t=M.from(u)}else if(r==="base64"){let n=atob(e),u=n.length,l=new Uint8Array(u);Array.from({length:u},(s,i)=>l[i]=n.charCodeAt(i)),t=M.from(l)}else console.info("SafeBuffer.from unknown encoding: "+r);return t}if(e.byteLength?e.byteLength:e.length){let r;return e instanceof ArrayBuffer&&(r=new Uint8Array(e)),M.from(r||e)}},alloc(e,t=0){return M.from(new Uint8Array(Array.from({length:e},()=>t)))},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be Array containing ArrayBuffer or Uint8Array instances.");return M.from(e.reduce((t,o)=>t.concat(Array.from(o)),[]))}});I.prototype.from=I.from;I.prototype.toString=M.prototype.toString;var N=I;var je=typeof document>"u",fe=je?(await import("node:crypto")).webcrypto:globalThis.crypto,$=fe.subtle,Y=e=>typeof e=="string"?e:JSON.stringify(e),L=e=>{try{return JSON.parse(e)}catch{return e}},V=e=>{let t=new Uint8Array(N.alloc(e));return N.from(fe.getRandomValues(t))},q=(e,t)=>{let[o,r]=e.split(".");return{kty:"EC",crv:"P-256",x:o,y:r,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},ee=async e=>{let t=await $.digest({name:"SHA-256"},new TextEncoder().encode(Y(e)));return N.from(t)},ie=async(e,t)=>{let o=e+t.toString("utf8"),r=N.from(await ee(o),"binary"),n=xe(r);return await $.importKey("jwk",n,{name:"AES-GCM"},!1,["encrypt","decrypt"])},xe=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var _e={pair:async e=>{let t=await $.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async n=>{let u=await $.exportKey("jwk",n.publicKey);return{priv:(await $.exportKey("jwk",n.privateKey)).d,pub:u.x+"."+u.y}}),o=await $.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async n=>{let u=await $.exportKey("jwk",n.publicKey);return{epriv:(await $.exportKey("jwk",n.privateKey)).d,epub:u.x+"."+u.y}}),r={pub:t.pub,priv:t.priv,epub:o.epub,epriv:o.epriv};return e&&e(r),r},encrypt:async(e,t,o)=>{if(!t||!t.epriv)return o&&o(null),null;let r={s:V(9),iv:V(15)},n=await ie(t.epriv,r.s).then(l=>$.encrypt({name:"AES-GCM",iv:new Uint8Array(r.iv)},l,new TextEncoder().encode(Y(e)))),u={ct:N.from(n,"binary").toString("base64"),iv:r.iv.toString("base64"),s:r.s.toString("base64")};return o&&o(u),u},decrypt:async(e,t,o)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return o&&o(null),null;let r={ct:N.from(e.ct,"base64"),iv:N.from(e.iv,"base64"),s:N.from(e.s,"base64")};try{let n=await ie(t.epriv,r.s).then(l=>$.decrypt({name:"AES-GCM",iv:new Uint8Array(r.iv),tagLength:128},l,new Uint8Array(r.ct))),u=L(new TextDecoder("utf8").decode(n));return o&&o(u),u}catch{return o&&o(null),null}},verify:async(e,t,o)=>{if(!t||!t.pub)return o&&o(null),null;let r=L(e),n=await $.importKey("jwk",q(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),u={};if(typeof r.m=="string")u=r.m;else for(let a of Object.keys(r.m))a!=="_"&&a!=J&&(u[a]=r.m[a]);let l=await ee(u),s=new Uint8Array(N.from(r.s,"base64")),i={name:"ECDSA",hash:{name:"SHA-256"}};if(await $.verify(i,n,s,new Uint8Array(l))){let a=L(r.m);return o&&o(a),a}return o&&o(null),null},sign:async(e,t,o)=>{if(!t||!t.pub||!t.priv)return o&&o(null),null;let r=L(e),n=await ee(r),u=q(t.pub,t.priv),l={name:"ECDSA",namedCurve:"P-256"},s=await $.importKey("jwk",u,l,!1,["sign"]).then(a=>$.sign({name:"ECDSA",hash:{name:"SHA-256"}},a,new Uint8Array(n))),i={m:r,s:N.from(s,"binary").toString("base64")};return o&&o(i),i},work:async(e,t,o)=>{typeof t=="function"&&(o=t,t=void 0),typeof t>"u"&&(t=V(9));let r=await $.importKey("raw",new TextEncoder().encode(Y(e)),{name:"PBKDF2"},!1,["deriveBits"]),n={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},u=await $.deriveBits(n,r,512),l={epriv:N.from(u,"binary").toString("base64")};return o&&o(l),l},secret:async(e,t,o)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return o&&o(null),null;let r={name:"ECDH",namedCurve:"P-256"},n=q(e.epub),u=await $.importKey("jwk",n,r,!0,[]),l=q(t.epub,t.epriv,!1);delete l.key_ops;let s=await $.importKey("jwk",l,r,!1,["deriveBits"]).then(async i=>{let a=await $.deriveBits({public:u,name:"ECDH",namedCurve:"P-256"},i,256),h=await $.importKey("raw",new Uint8Array(a),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return $.exportKey("jwk",h).then(({k:y})=>y)});return o&&o({epriv:s}),{epriv:s}}},K=_e;var oe=(e,t,o,r)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof o!="string"&&(o=JSON.stringify(o)||""),typeof r!="string"&&(r=JSON.stringify(r)||""),o===r?{state:!0}:o<r?{current:!0}:{incoming:!0});oe.mix=async(e,t,o,r)=>{var n=Date.now(),u={},l={};let s=0;for(let i of Object.keys(e)){let a=e[i],h=!1,y=!1,b=0,d="",c=o;if(!(!a||!a._)){if(a._.s&&a._.p&&(c=!0),i.length>1&&i[0]==="~")if(i[1]==="@")y=!0,c=!1;else{if(a._.p&&i!="~"+a._.p){console.log(`error public key does not match for soul: ${i}`);continue}a._.p=i.slice(1),c=!0}if(c){if(!a._.s||!a._.p){console.log("error signature and public key required to verify data");continue}if(!await K.verify({m:a,s:a._.s},{pub:a._.p})){console.log(`error could not verify soul: ${i}`);continue}}for(let f of Object.keys(a)){if(f==="_")continue;let p=a[f],g=a._[">"][f],w=(t[i]||{})[f],v=(t[i]||{_:{">":{}}})._[">"][f]||0;if(y&&f!==T.is(p))continue;let m=g-n;if(m>0){if(m>864e5)continue;(s===0||m<s)&&(s=b=m),l[i]||(l[i]={_:{"#":i,">":{},s:a._.s,p:a._.p}}),l[i][f]=p,l[i]._[">"][f]=g}else oe(g,v,p,w).incoming&&(u[i]||(u[i]={_:{"#":i,">":{},s:a._.s,p:a._.p}}),t[i]||(t[i]={_:{"#":i,">":{},s:a._.s,p:a._.p}}),t[i][f]=u[i][f]=p,t[i]._[">"][f]=u[i]._[">"][f]=g,r[i]&&setTimeout(()=>{r[i]&&r[i].filter(S=>z(S["."],f)).forEach(S=>S.cb())},100),h=!0)}c&&b!==0&&u[i]&&(Object.assign(l[i],u[i]),delete u[i]),h&&r[i]&&setTimeout(()=>{r[i]&&r[i].filter(f=>z(f["."])).forEach(f=>f.cb())},100)}}return{now:u,defer:l,wait:s}};var se=oe;var U="",G="",ae=()=>{let e=(t,o,r)=>{if(r||(e[U]||(e[U]={}),r=e[U]),!t)return r;let n=0,u={},l=t[n],s=t.length-1,i=typeof o>"u",a=r[l];for(;!a&&n<s;)l+=t[++n],a=r[l];if(a)if(n===s){if(i)return typeof a[G]>"u"?a[U]:a[G];a[G]=o}else return!a[U]&&!i&&(a[U]={}),e(t.slice(++n),o,a[U]);else if(_.map(r,(y,b)=>{let d=0,c="";for(;b[d]===t[d];)c+=b[d++];if(c){if(i)return d<=s?void 0:(u[b.slice(d)]=y,y);let f={[b.slice(d)]:y,[t.slice(d)]:{[G]:o}};return r[c]={[U]:f},delete r[b],!0}})){if(i)return u}else{if(i)return;r[l]||(r[l]={}),r[l][G]=o}};return e};ae.map=function e(t,o,r,n){n||(n=[]);var u=t[U]||t,l=Object.keys(u).sort(),s;for(let i=0;i<l.length;i++){let a=l[i],h=u[a],y=h[G];if(typeof y<"u"){if(y=o(y,n.join("")+a,a,n),typeof y<"u")return y}else r&&o(s,n.join(""),a,n);if(h[U]){if(n.push(a),y=e(h[U],o,r,n),typeof y<"u")return y;n.pop()}}};var B=ae;var pe="",ce="",O="",R=e=>{var t,o=null;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=10*1e3),e.write||(e.write=1),e.size||(e.size=1024*1024),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let r=(n,u,l)=>{if(n=""+n,typeof u=="function")return l=u,u=r.batch(n),typeof u<"u"||r.thrash.at&&(u=r.thrash.at(n),typeof u<"u")?l(t,u):r.read(n,l);if(r.batch(n,u),l&&r.batch.acks.push(l),++r.batch.ed>=e.batch)return r.thrash();clearTimeout(r.batch.timeout),r.batch.timeout=setTimeout(r.thrash,e.write)};return r.batch=B(),r.batch.acks=[],r.batch.ed=0,r.thrash=()=>{if(r.thrash.ing)return r.thrash.more=!0;clearTimeout(r.batch.timeout),r.thrash.more=!1,r.thrash.ing=!0;var n=r.thrash.at=r.batch;r.batch=null,r.batch=B(),r.batch.acks=[],r.batch.ed=0;let u=0;r.save(n,l=>{++u>1||(l&&e.log(l),n.acks.forEach(s=>s(l)),r.thrash.at=null,r.thrash.ing=!1,r.thrash.more&&r.thrash())})},r.save=(n,u)=>{let l={find:(s,i)=>{if(!(i<l.start))return l.start=i,e.store.list(l.lex),!0},lex:s=>{if(!s||s>l.start)return l.end=s,l.mix(l.file||"!",l.start,l.end),!0;l.file=s},mix:(s,i,a)=>{l.start=l.end=l.file=t,r.parse(s,(h,y)=>{if(h)return u(h);B.map(n,(b,d)=>{if(!(d<i)){if(a&&a<d)return l.start=d,l.start;y(d,b)}}),r.write(s,y,l.next)})},next:s=>{if(s)return u(s);if(l.start)return B.map(n,l.find);u(s)}};B.map(n,l.find)},r.write=(n,u,l)=>{o=null;let s={text:"",count:0,file:n,each:(i,a,h,y)=>{s.count++;var b=R.encode(y.length)+"#"+R.encode(h)+(typeof i>"u"?"":"="+R.encode(i))+`
`;if(s.count>1&&s.text.length+b.length>e.size)return s.text="",s.limit=Math.ceil(s.count/2),s.count=0,s.sub=B(),B.map(u,s.slice),!0;s.text+=b},put:()=>{e.store.put(n,s.text,l)},slice:(i,a)=>{if(!(a<s.file)){if(++s.count>s.limit){var h=s.file;let y=a.indexOf(ce);return y===-1?s.file=a:s.file=a.substring(0,y),s.sub(s.file,null),s.count=0,r.write(h,s.sub,s.next),!0}s.sub(a,i)}},next:i=>{if(i)return l(i);s.sub=B(),B.map(u,s.slice)||r.write(s.file,s.sub,l)}};B.map(u,s.each,!0)||s.put()},r.read=(n,u)=>{if(o){let a=o(n);if(typeof a<"u")return u(t,a)}let l=n,s=n.indexOf(ce);s!==-1&&(l=n.substring(0,s));let i={lex:a=>{if(!a){if(!i.file){u("no file found",t);return}r.parse(i.file,i.it);return}a>l||a<i.file||(i.file=a)},it:(a,h)=>{a&&e.log(a),h&&(o=h,i.value=h(n)),u(a,i.value)}};e.store.list(i.lex)},r.parse=(n,u)=>{let l={disk:B(),read:(s,i)=>{if(s)return u(s);if(!i)return u(t,l.disk);let a=[],h=l.split(i);for(;h;){let y,b,d=h[1];h=l.split(h[2])||"",h[0]==="#"&&(y=h[1],a=a.slice(0,d),d<=a.length&&a.push(y)),h=l.split(h[2])||"",h[0]!==`
`&&(h[0]==="="&&(b=h[1]),typeof y<"u"&&typeof b<"u"&&l.disk(a.join(""),b),h=l.split(h[2]))}u(t,l.disk)},split:s=>{if(!s)return;let i=-1,a="",h=null;for(;(h=s[++i])&&h!==O;)a+=h;let y={};if(h)return[a,R.decode(s.slice(i),y),s.slice(i+y.i)]}};e.store.get(n,l.read)},r};R.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=pe+e[1],e=e[0]),typeof e=="string"){let r=0,n=null,u=O;for(;n=e[r++];)n===O&&(u+=O);return u+'"'+e+t+O}let o=T.is(e);if(o)return O+"#"+o+t+O;if(X.is(e))return O+"+"+(e||0)+t+O;if(e===!0)return O+"+"+t+O;if(e===!1)return O+"-"+t+O;if(e===null)return O+" "+t+O};R.decode=(e,t)=>{var o="",r=-1,n=0,u=null,l=null;if(e[0]!==O)return;for(;u=e[++r];)if(l){if(u===O&&--n<=0)break;o+=u}else u===O?n++:l=u||!0;t&&(t.i=r+1);let[s,i]=o.split(pe);if(i){if(i=parseFloat(i),l==='"')return[s,i];if(l==="#")return[T.ify(s),i];if(l==="+")return s.length===0?[!0,i]:[parseFloat(s),i];if(l==="-")return[!1,i];if(l===" ")return[null,i]}else{if(l==='"')return o;if(l==="#")return T.ify(o);if(l==="+")return o.length===0?!0:parseFloat(o);if(l==="-")return!1;if(l===" ")return null}};var de=R;var he=typeof document>"u",F=he?await import("node:fs"):void 0,ge="",te="",ue=te+"+0"+te+"#"+te+'"root'+te,Ae=e=>{let t=e.file;if(he)return F.existsSync(t)||F.mkdirSync(t),F.existsSync(t+"/!")||F.writeFileSync(t+"/!",ue),{get:(o,r)=>{F.readFile(t+"/"+o,(n,u)=>{if(n){if(n.code==="ENOENT"){r();return}console.log("fs.readFile error:",n)}u&&(u=u.toString()),r(n,u)})},put:(o,r,n)=>{var u=Math.random().toString(36).slice(-9),l=o+"."+u+".tmp";F.writeFile(l,r,s=>{if(s){n(s);return}F.rename(l,t+"/"+o,n)})},list:o=>{F.readdir(t,(r,n)=>{n.forEach(o),o()})}};if(e.indexedDB){let o,r=indexedDB.open(t,1);return r.onupgradeneeded=n=>{n.target.result.createObjectStore(t)},r.onerror=n=>{console.log(n)},r.onsuccess=()=>{if(o=r.result,o){let u=o.transaction([t],"readonly").objectStore(t).getKey("!");u.onerror=()=>{console.log(`error getting key ${t}/!`)},u.onsuccess=()=>{if(!u.result){let s=o.transaction([t],"readwrite").objectStore(t).put(ue,"!");s.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(n,u)=>{if(o){let s=o.transaction([t],"readonly").objectStore(t).get(n);s.onerror=()=>{console.log(`error getting ${t}/${n}`)},s.onsuccess=()=>{u(null,s.result)}}else u("error indexedDB not available")},put:(n,u,l)=>{if(o){let i=o.transaction([t],"readwrite").objectStore(t).put(u,n);i.onerror=()=>{console.log(`error putting data on ${t}/${n}`)},i.onsuccess=()=>{l(null)}}else l("error indexedDB not available")},list:n=>{if(o){let l=o.transaction([t],"readonly").objectStore(t).getAllKeys();l.onerror=()=>console.log("error getting keys for",t),l.onsuccess=()=>{l.result.forEach(n),n()}}else console.log("error indexedDB not available"),n()}}}return{get:(o,r)=>{r(null,ue)},put:(o,r,n)=>{n(null)},list:o=>{o("!"),o()}}},Oe=e=>{_.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Ae(e));let t=de(e);return{get:(o,r)=>{if(!o){r("lex required");return}var n=o["#"],u=typeof o["."]=="string"?o["."]:"",l;let s=(i,a)=>{z(o["."],a)&&(l||(l={_:{"#":n,">":{}}}),l[a]=i[0],l._[">"][a]=i[1])};t(n+ge+u,(i,a)=>{let h;_.is(a)?(B.map(a,s),l||s(a,u),h={[n]:l}):a&&(s(a,u),h={[n]:l}),r(i,h)})},put:(o,r)=>{if(!o){r("graph required");return}var n=0;let u=l=>{if(n--,!u.err){if(u.err=l,u.err){r(u.err);return}n===0&&r(null)}};Object.keys(o).forEach(l=>{var s=o[l];Object.keys(s).forEach(i=>{if(i==="_")return;n++;let a=s[i],h=s._[">"][i];t(l+ge+i,[a,h],u)})})}}},ye=Oe;var me=typeof document>"u",we=me?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=we?.WebSocket);var Ce=e=>{_.is(e)||(e={});let t=le(e.maxAge),o=ye(e),r={},n={},u={},l=async(c,f,p)=>{for(let g of Object.keys(c)){let w=await new Promise(S=>{a({"#":g},S,f)});if(w.err)return p&&p(w.err),!1;let v=c[g],m=v._?v._.p:void 0,k=J;if(!(!w.put||!w.put[g]||w.put[g][k]===m))return p&&p(`error in wire check public key does not match for soul: ${g}`),!1}return!0},s=(c,f)=>{let p=ne(c.get,r);p?f(JSON.stringify({"#":t.track(E.random(9)),"@":c["#"],put:p})):o.get(c.get,(g,w)=>{f(JSON.stringify({"#":t.track(E.random(9)),"@":c["#"],put:w,err:g}))})},i=async(c,f)=>{let p=await se.mix(c.put,r,e.secure,u);if(Object.keys(p.now).length){if(!await l(p.now,f))return;o.put(p.now,g=>{f(JSON.stringify({"#":t.track(E.random(9)),"@":c["#"],err:g}))})}Object.keys(p.defer).length&&setTimeout(()=>i({put:p.defer},f),p.wait)},a=(c,f,p,g)=>{if(!f)return;_.is(g)||(g={});let w=ne(c,r);if(w){f({put:w});return}o.get(c,(v,m)=>{if(m){f({put:m,err:v});return}v&&console.log(v);let k=E.random(9);n[k]=f,p(JSON.stringify({"#":t.track(k),get:c})),setTimeout(()=>{let S=n[k];if(S){let j=c["#"],A={[j]:null};typeof c["."]=="string"&&(A[j]={[c["."]]:null}),S({put:A}),delete n[k]}},g.wait||100)})},h=c=>({get:(f,p,g)=>{a(f,p,c,g)},put:async(f,p)=>{let g=await se.mix(f,r,e.secure,u);Object.keys(g.now).length===0||!await l(g.now,c,p)||(o.put(g.now,p),c(JSON.stringify({"#":t.track(E.random(9)),put:f})))},on:(f,p)=>{let g=f&&f["#"];!g||!p||(u[g]?u[g].push({".":f["."],cb:p}):u[g]=[{".":f["."],cb:p}])},off:(f,p)=>{let g=f&&f["#"];if(!(!g||!u[g]))if(p){let w=u[g].find(v=>v.cb===p);w&&u[g].splice(u[g].indexOf(w),1)}else delete u[g]}});if(me){let c=e.wss,f=()=>c.clients();c||(c=new we.WebSocketServer({port:8080}),f=()=>c.clients);let p=(g,w)=>{f().forEach(v=>{v.readyState===WebSocket.OPEN&&v.send(g,{binary:w})})};return c.on("connection",g=>{g.on("error",console.error),g.on("message",(w,v)=>{let m=JSON.parse(w);if(t.check(m["#"]))return;t.track(m["#"]),m.get&&s(m,p),m.put&&i(m,p),p(w,v);let k=m["@"],S=n[k];S&&(delete m["#"],delete m["@"],S(m),delete n[k])})}),h(p)}let y=new WebSocket("ws://localhost:8080"),b=c=>{if(!y||y.readyState!==WebSocket.OPEN){console.log("websocket not available");return}y.send(c)},d=()=>{y||(y=new WebSocket("ws://localhost:8080")),y.onclose=c=>{y=null,setTimeout(d,Math.floor(Math.random()*5e3))},y.onerror=c=>{console.error(c)},y.onmessage=c=>{let f=JSON.parse(c.data);if(t.check(f["#"]))return;t.track(f["#"]),f.get&&s(f,b),f.put&&i(f,b),b(c.data);let p=f["@"],g=n[p];g&&(delete f["#"],delete f["@"],g(f),delete n[p])}};return d(),h(b)},re=Ce;var Ee=(e,t)=>{t||(t=re(e));let o=[],r=!1,n=!1,u=0,l=(i,a,h,y)=>{let b=p=>{u++,l(p,a,h,y)},d=p=>{o=[],u=0,n=!1,y(p)},c=()=>{if(o.length===0){d("Wrong username or password");return}let p=o.shift();t.get({"#":p},async g=>{if(g.err){d(`error getting ${p}: ${g.err}`);return}let w=g.put&&g.put[p];if(!w||!w.auth)return c();let v=JSON.parse(w.auth),m=await K.work(a,v.salt),k=await K.decrypt(v.enc,m);if(!k)return c();if(s.is={username:i,pub:w.pub,epub:w.epub,priv:k.priv,epriv:k.epriv},s.ctx="~"+w.pub,h!==""){let S=E.random(64),j=await K.work(h,S),A=await K.encrypt(k,j),x={auth:JSON.stringify({enc:A,salt:S})},C=await K.sign(x,s.is),D=W(p,C.m,C.s,w.pub);t.put(D,P=>{d(P?`error putting ${x} on ${p}: ${P}`:null)});return}return d(null)})};if(u>9){d("Wrong username or password");return}let f="~@"+i;t.get({"#":f},async p=>{if(p.err){d(`error getting ${f}: ${p.err}`);return}let g=p.put&&p.put[f];if(!g)return b(i);delete p.put[f]._,o=Object.keys(g),c()})},s={create:(i,a,h)=>{let y=d=>{h?h(d):console.log(d)};if(r){y("User is already being created");return}if(i===""){y("Please provide a username");return}if(a===""){y("Please provide a password");return}r=!0;let b="~@"+i;t.get({"#":b},async d=>{if(d.err){r=!1,y(`error getting ${b}: ${d.err}`);return}if(d.put&&d.put[b]){r=!1,y("Username already exists");return}let c=E.random(64),f=await K.work(a,c),p=await K.pair(),g={priv:p.priv,epriv:p.epriv},w=await K.encrypt(g,f),v={username:i,pub:p.pub,epub:p.epub,auth:JSON.stringify({enc:w,salt:c})},m="~"+p.pub,k=await K.sign(v,p),S=W(m,k.m,k.s,p.pub);t.put(S,j=>{if(r=!1,j){y(`error putting ${v} on ${m}: ${j}`);return}let A={[m]:{"#":m}};t.put(W(b,A),x=>{if(x){y(`error putting ${A} on ${b}: ${x}`);return}h&&h(null)})})})},auth:(i,a,h)=>{let y=b=>{h?h(b):b&&console.log(b)};if(n){y("User is already authenticating");return}if(s.is=null,i===""){y("Please provide a username");return}if(a===""){y("Please provide a password");return}n=!0,l(i,a,"",y)},change:(i,a,h,y)=>{let b=d=>{y?y(d):d&&console.log(d)};if(n){b("User is already authenticating");return}if(s.is=null,i===""){b("Please provide a username");return}if(a===""){b("Please provide a password");return}if(h===""){b("Please provide a new password");return}n=!0,l(i,a,h,b)},store:i=>{if(!s.is){console.log("Please authenticate before calling store");return}if(i){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(s.is));return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(s.is))},recall:i=>{if(i){if(typeof globalThis.localStorage<"u"){let a=globalThis.localStorage.getItem("user.is");a?(s.is=JSON.parse(a),s.ctx="~"+s.is.pub):console.log("User credentials not stored in local storage")}return}if(typeof globalThis.sessionStorage<"u"){let a=globalThis.sessionStorage.getItem("user.is");a?(s.is=JSON.parse(a),s.ctx="~"+s.is.pub):console.log("User credentials not stored in session storage")}},leave:()=>{s.is=null,s.ctx=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(i,a,h)=>{let y=b=>{h?h(b):console.log(b)};if(n){y("User is already authenticating");return}if(i===""){y("Please provide a username");return}if(a===""){y("Please provide a password");return}n=!0,l(i,a,"",async b=>{if(b){y(b);return}let d={username:null,pub:null,epub:null,auth:null},c=await K.sign(d,s.is),f="~"+s.is.pub,p=W(f,c.m,c.s,s.is.pub);t.put(p,g=>{if(g){y(`error putting null on ${f}: ${g}`);return}s.is=null,s.ctx=null,h&&h(null)})})}};return s},be=Ee;var Te=e=>{let t=re(e),o=be(null,t),r=new Map,n=new Map,u=i=>i===null||i===!0||i===!1||typeof i=="string"||T.is(i)||X.is(i),l=i=>{if(u(i))return!0;if(_.is(i)){let a=[];for(let[h,y]of Object.entries(i)){if(h==="_")return"error underscore cannot be used as an item name";if(_.is(y)||u(y)){a.push(h);continue}return`error {${h}:${y}} cannot be converted to graph`}if(a.length!==0)return a}return`error ${i} cannot be converted to a graph`},s=i=>{let a=(d,c,f)=>{t.get(_.put(d,"#",c),async p=>{if(p.err&&console.log(p.err),p.put&&p.put[c]){delete p.put[c]._,delete p.put[c][J];for(let g of Object.keys(p.put[c])){let w=T.is(p.put[c][g]);if(w){let v=await new Promise(m=>{let k=E.random();n.set(k,{chain:[{item:null,soul:w}]}),s(k).next(null,m)});p.put[c][g]=v}}f(p.put[c])}else f(null)})},h=async(d,c,f)=>{if(f||(f=console.log),!o.is)return e.secure?(f(`error putting data on ${d}: user required in secure mode`),null):W(d,c);if(!o.is)return f(`error putting data on ${d}: user not authenticated`),null;let p=await K.sign(c,o.is);return W(d,p.m,p.s,o.is.pub)},y=d=>{let c=n.get(i);c&&typeof c.cb<"u"?c.cb(d):d&&console.log(d),c&&!c.on&&n.delete(i)},b=(d,c)=>{let f=d&&typeof d.get<"u",p=d&&typeof d.put<"u",g=d&&typeof d.on<"u",w=d&&typeof d.off<"u",v=!1,m=n.get(i);for(var k=1;k<m.chain.length;k++)if(m.chain[k].soul===null){v=!0;break}if(v){let{item:S,soul:j}=m.chain[k-1];return t.get({"#":j,".":S},async A=>{if(A.err){console.log(`error getting ${S} on ${j}: ${A.err}`),c&&c(null);return}let x=A.put&&A.put[j];if(x&&typeof x[S]<"u"){let C=T.is(x[S]);if(C)m.chain[k].soul=C,n.set(i,{chain:m.chain,cb:m.cb}),f?s(i).next(null,d.get,c):p?s(i).put(d.put,c):g?s(i).on(d.on,c):w&&s(i).off(c);else if(f)c(x[S]);else if(p){C=E.random();let D={[S]:T.ify(C)},P=await h(j,D,c);if(P===null)return;t.put(P,Q=>{if(Q){c(`error putting ${S} on ${j}: ${Q}`);return}m.chain[k].soul=C,s(i).put(d.put,c)})}else g?(console.log(`error resolving on for ${S} on ${j}`),c(null)):w&&(console.log(`error resolving off for ${S} on ${j}`),c&&c(null))}else p?c(`error ${S} not found on ${j}`):(console.log(`error ${S} not found on ${j}`),c&&c(null))}),!1}return f&&m.chain[m.chain.length-1].item!==null?(m.chain.push({item:null,soul:null}),s(i).next(null,d.get,c),!1):m.chain[m.chain.length-1]};return{get:(d,c,f)=>{if(typeof c=="function"&&(f=c,c=null),d===null||d===""||d==="_"){f&&f(null);return}if(c&&!f){console.log("lex requires a callback function");return}let p=o.ctx?o.ctx:"root";if(i=E.random(),n.set(i,{chain:[{item:d,soul:p}],cb:f}),!f)return s(i);let{soul:g}=b({get:c},y);g&&a(c,g,y)},next:(d,c,f)=>{let p=v=>{f?f(v):y(v)};if(typeof c=="function"&&(f=c,c=null),!i){console.log("please provide a key using get(key)"),p(null);return}if(d===""||d==="_"){p(null);return}if(c&&!f){console.log("lex requires a callback function");return}let g=n.get(i);if(!g)return;if(f&&typeof g.cb>"u"&&(g.cb=f,f=null),d!==null&&g.chain.push({item:d,soul:null}),!g.cb)return s(i);let{soul:w}=b({get:c},p);w&&a(c,w,p)},put:(d,c)=>{let f=m=>{c?c(m):y(m)};if(!i){f("please provide a key using get(key)");return}let p=n.get(i);if(!p)return;if(!p.cb){if(!c)return;p.cb=c,c=null}let g=l(d);if(typeof g=="string"){f(g);return}let{item:w,soul:v}=b({put:d},f);if(v){if(g===!0){t.get({"#":v,".":w},async m=>{if(m.err){console.log(`error getting ${v}: ${m.err}`);return}let k=m.put&&m.put[v]&&m.put[v][w],S=T.is(k);if(!S){let j=await h(v,{[w]:d},f);if(j===null)return;t.put(j,f);return}t.get({"#":S},async j=>{if(j.err){console.log(`error getting ${S}: ${j.err}`);return}if(!j.put||!j.put[S]){console.log(`error ${S} not found`);return}delete j.put[S]._;for(let x of Object.keys(j.put[S])){if(x===J)continue;let C=await new Promise(D=>{let P=E.random();n.set(P,{chain:[{item:x,soul:S}]}),s(P).put(null,D)});if(C){f(C);return}}let A=await h(v,{[w]:d},f);A!==null&&t.put(A,f)})});return}t.get({"#":v,".":w},async m=>{if(m.err){f(`error getting ${v}.${w}: ${m.err}`);return}let k=m.put&&m.put[v]&&m.put[v][w],S=T.is(k);if(!S){let x={[w]:T.ify(E.random())},C=await h(v,x,f);if(C===null)return;t.put(C,D=>{if(D)f(`error putting ${w} on ${v}: ${D}`);else{let P=E.random(),Q=[{item:w,soul:v}];n.set(P,{chain:Q,cb:p.cb}),s(P).put(d)}});return}let j=!1,A={};for(let x of g){let C=await new Promise(D=>{if(_.is(d[x])){let P=E.random();n.set(P,{chain:[{item:x,soul:S}]}),s(P).put(d[x],D)}else j=!0,A[x]=d[x],D(null)});if(C){f(C);return}}if(j){let x=await h(S,A,f);if(x===null)return;t.put(x,f)}else f(null)})}},on:(d,c)=>{if(typeof d=="function"&&(c=d,d=null),!c)return;if(!i){console.log("please provide a key using get(key)"),c(null);return}let{item:f,soul:p}=b({on:d},c);p&&(n.set(i,{chain:[{item:f,soul:p}],on:!0}),r.set(c,()=>s(i).next(null,c)),t.get({"#":p,".":f},g=>{if(g.err){console.log(`error getting ${p}.${f}: ${g.err}`);return}let w=g.put&&g.put[p]&&g.put[p][f],v=T.is(w);v?d?d=_.put(d,"#",v):d={"#":v,".":null}:d?d=_.put(d,"#",p):d={"#":p,".":f},t.on(d,r.get(c))}))},off:d=>{if(!i){console.log("please provide a key using get(key)"),d&&d(null);return}let{item:c,soul:f}=b({off:!0},d);f&&t.get({"#":f,".":c},p=>{if(p.err){console.log(`error getting ${f}.${c}: ${p.err}`);return}let g=p.put&&p.put[f]&&p.put[f][c],w=T.is(g);w?t.off({"#":w},r.get(d)):t.off({"#":f},r.get(d)),r.delete(d),n.delete(i)})},user:d=>(d&&(o.ctx="~"+d),Object.assign(o,s())),wire:t,SEA:K}};return s()},st=Te;export{st as default};
//# sourceMappingURL=holster.js.map
