var fe={is:t=>{if(t instanceof Array)return!1;if(typeof t=="number")return!isNaN(t);if(typeof t=="string"){let e=parseFloat(t);return!isNaN(e)&&isFinite(e)}return!1}},L={is:t=>{if(!t||typeof t!="object")return!1;let r=Object.prototype.toString.call(t).match(/^\[object (\w+)\]$/);return t.constructor===Object||r&&r[1]==="Object"},map:(t,e,r)=>{var n=Object.keys(t);for(let i=0;i<n.length;i++){let s=e(t[n[i]],n[i],r);if(typeof s<"u")return s}},put:(t,e,r)=>(t||(t={}),t[e]=r,t),del:(t,e)=>{if(t)return t[e]=null,delete t[e],t}},Be=(t,e,r)=>{if(r.id){r.id=!1;return}if(e==="#"&&typeof t=="string"){r.id=t;return}r.id=!1},P={is:t=>{if(t&&t["#"]&&!t._&&L.is(t)){let e={};if(L.map(t,Be,e),e.id)return e.id}return!1},ify:t=>L.put({},"#",t)},W="_holster_user_signature",K="_holster_user_public_key",X=(t,e,r,n,i)=>{let s={[t]:{_:{"#":t,">":{}}}};for(let[y,d]of Object.entries(e))y!=="_"&&y!==K&&y!==W&&(s[t][y]=d,s[t]._[">"][y]=i||Date.now());if(r&&n&&i){if(s[t]._.s={},typeof r=="string")s[t]._.s[i]=r;else if(typeof r=="object")for(let[y,d]of Object.entries(r))s[t]._.s[y]=d;s[t][K]=n,s[t]._[">"][K]=i}return s},V=(t,e)=>{if(typeof e>"u")return t===null;if(typeof t>"u")return!0;if(typeof t=="string")return t===e;if(!L.is(t)||!e)return!1;let r=t["*"];if(r)return e.slice(0,r.length)===r;let n=t[">"],i=t["<"];return n&&i?e>=n&&e<=i:n?e>=n:i?e<=i:!1},R={random:t=>{var e="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";t||(t=24);for(let n=0;n<t;n++)e+=r.charAt(Math.floor(Math.random()*r.length));return e}};var Fe=t=>{t||(t=9e3);let e={store:{}};return e.check=r=>e.store[r]?e.track(r):!1,e.track=r=>(e.store[r]=Date.now(),e.expiry||(e.expiry=setTimeout(()=>{if(e.expiry)return;let n=Date.now();Object.keys(e.store).forEach(i=>{n-e.store[i]>t&&delete e.store[i]}),e.expiry=null},t)),r),e},Ee=Fe;var He=(t,e)=>{if(!t||typeof t!="object")throw new TypeError("lex must be an object");if(!e||typeof e!="object")throw new TypeError("graph must be an object");let r=t["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!e[r])return;let n={_:{"#":r,">":{}}},i={};if(typeof t["."]=="string"){let s=t["."];if(typeof e[r][s]>"u")return;n[s]=e[r][s],n._[">"][s]=e[r]._[">"][s];let y=e[r]._[">"][s];e[r]._.s&&(e[r]._.s[y]?i[y]=e[r]._.s[y]:e[r]._.s[s]&&(i[s]=e[r]._.s[s]))}else for(let s of Object.keys(e[r]))if(V(t["."],s)){n[s]=e[r][s],n._[">"][s]=e[r]._[">"][s];let y=e[r]._[">"][s];e[r]._.s&&(e[r]._.s[y]?i[y]=e[r]._.s[y]:e[r]._.s[s]&&(i[s]=e[r]._.s[s]))}return Object.keys(i).length>0&&(n._.s=i),{[r]:n}},me=He;typeof btoa>"u"&&(globalThis.btoa=t=>Buffer.from(t,"binary").toString("base64"),globalThis.atob=t=>Buffer.from(t,"base64").toString("binary"));function ce(){}Object.assign(ce,{from:Array.from});ce.prototype=Object.create(Array.prototype);ce.prototype.toString=function(t,e,r){if(t||(t="utf8"),e||(e=0),r=r?Math.min(Math.max(r,e),this.length):this.length,t==="hex"){let n=new Uint8Array(this.slice(e,r));return Array.from(n,i=>i.toString(16).padStart(2,"0")).join("")}if(t==="utf8")return Array.from({length:r-e},(n,i)=>{let s=this[i+e];return s<0||s>1114111?"\uFFFD":String.fromCharCode(s)}).join("");if(t==="base64"){let n=Array.from({length:r-e},(i,s)=>{let y=this[s+e];return y<0||y>255?"\uFFFD":String.fromCharCode(y)}).join("");return btoa(n)}};var Q=ce;var ge={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function Y(...t){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),Y.from(...t)}Y.prototype=Object.create(Array.prototype);var ue=(t,e)=>{if(typeof t!="string")throw new TypeError("Input must be a string for encoding: "+e);if(t.length>ge.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${t.length} > ${ge.MAX_STRING_LENGTH}`)},z=(t,e="buffer operation")=>{if(t>ge.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${e}: ${t} > ${ge.MAX_BUFFER_SIZE}`)},Ke=t=>{ue(t,"hex");let e=t.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(e))throw new TypeError("Invalid hex string: contains non-hex characters");if(e.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(e.length===0)return new Uint8Array(0);z(e.length/2,"hex parsing");let r=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2){let i=e.substr(n,2);r[n/2]=parseInt(i,16)}return r},$e=t=>{ue(t,"utf8");try{let r=new TextEncoder().encode(t);return z(r.length,"UTF-8 encoding"),r}catch(e){throw new TypeError("Failed to encode UTF-8 string: "+e.message)}},Je=t=>{ue(t,"binary"),z(t.length,"binary encoding");let e=new Uint8Array(t.length);for(let r=0;r<t.length;r++){let n=t.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);e[r]=n}return e},qe=t=>{ue(t,"base64");let e=t.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(e))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(e);z(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let i=0;i<r.length;i++)n[i]=r.charCodeAt(i);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},je=t=>{let e;if(t instanceof ArrayBuffer)z(t.byteLength,"ArrayBuffer processing"),e=new Uint8Array(t);else if(ArrayBuffer.isView(t))z(t.byteLength||t.length,"TypedArray processing"),e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);else if(Array.isArray(t)){z(t.length,"Array processing");for(let r=0;r<t.length;r++){let n=t[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}e=new Uint8Array(t)}else if(typeof t=="object"&&t!==null&&typeof t.length=="number"){z(t.length,"array-like processing");let r=Array.from(t);for(let n=0;n<r.length;n++){let i=r[n];if(typeof i!="number"||i<0||i>255||!Number.isInteger(i))throw new TypeError(`Invalid byte value at index ${n}: ${i} (must be integer 0-255)`)}e=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof t);return e};Object.assign(Y,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let e=arguments[0];if(e==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof e=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=Ke(e);break;case"utf8":case"utf-8":r=$e(e);break;case"binary":case"latin1":r=Je(e);break;case"base64":r=qe(e);break;case"ascii":ue(e,"ascii");for(let i=0;i<e.length;i++)if(e.charCodeAt(i)>127)throw new TypeError(`Invalid ASCII character at position ${i}: ${e.charCodeAt(i)} > 127`);r=$e(e);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=je(e);if(!r||r.length===0)return Q.from(new Uint8Array(0));try{return Q.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(t,e=0){if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Length must be a non-negative integer");if(z(t,"buffer allocation"),typeof e=="number"){if(e<0||e>255||!Number.isInteger(e))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof e=="string"){if(e.length!==1)throw new TypeError("Fill string must be exactly one character");if(e=e.charCodeAt(0),e>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(t);return e!==0&&r.fill(e),Q.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(t){if(!Array.isArray(t))throw new TypeError("First argument must be an array");if(t.length===0)return Q.from(new Uint8Array(0));let e=0,r=[];for(let n=0;n<t.length;n++){let i=t[n];if(!i)throw new TypeError(`Array element at index ${n} is null or undefined`);let s;try{s=je(i)}catch(y){throw new TypeError(`Invalid array element at index ${n}: ${y.message}`)}e+=s.length,z(e,"buffer concatenation"),r.push(s)}try{let n=new Uint8Array(e),i=0;for(let s of r)n.set(s,i),i+=s.length;return Q.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(t){return t instanceof Q||t&&typeof t=="object"&&t.constructor===Y},byteLength(t,e="utf8"){if(typeof t!="string")throw new TypeError("First argument must be a string");switch(e.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(t).length;case"ascii":case"binary":case"latin1":return t.length;case"base64":let r=t.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(t.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+e)}}});Y.prototype.from=Y.from;Y.prototype.toString=function(t="utf8",e=0,r=this.length){if(typeof t!="string")throw new TypeError("Encoding must be a string");if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<e)throw new TypeError("End must be an integer >= start");try{return Q.prototype.toString.call(this,t,e,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var J=Y;var We=typeof document>"u",xe=We?(await import("node:crypto")).webcrypto:globalThis.crypto,M=xe.subtle,pe=t=>typeof t=="string"?t:JSON.stringify(t),le=t=>{try{return JSON.parse(t)}catch{return t}},de=t=>{let e=new Uint8Array(J.alloc(t));return J.from(xe.getRandomValues(e))},te=(t,e)=>{let[r,n]=t.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:e,ext:!0,key_ops:e?["sign"]:["verify"]}},oe=async t=>{let e=await M.digest({name:"SHA-256"},new TextEncoder().encode(pe(t)));return J.from(e)},we=async(t,e)=>{let r=t+e.toString("utf8"),n=J.from(await oe(r),"binary"),i=Ge(n);return await M.importKey("jwk",i,{name:"AES-GCM"},!1,["encrypt","decrypt"])},Ge=t=>({kty:"oct",k:t.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var Xe={pair:async t=>{let e=await M.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async i=>{let s=await M.exportKey("jwk",i.publicKey);return{priv:(await M.exportKey("jwk",i.privateKey)).d,pub:s.x+"."+s.y}}),r=await M.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async i=>{let s=await M.exportKey("jwk",i.publicKey);return{epriv:(await M.exportKey("jwk",i.privateKey)).d,epub:s.x+"."+s.y}}),n={pub:e.pub,priv:e.priv,epub:r.epub,epriv:r.epriv};return t&&t(n),n},encrypt:async(t,e,r)=>{if(!e||!e.epriv)return r&&r(null),null;let n={s:de(9),iv:de(15)},i=await we(e.epriv,n.s).then(y=>M.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},y,new TextEncoder().encode(pe(t)))),s={ct:J.from(i,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(s),s},decrypt:async(t,e,r)=>{if(!t||!t.ct||!t.iv||!t.s||!e||!e.epriv)return r&&r(null),null;let n={ct:J.from(t.ct,"base64"),iv:J.from(t.iv,"base64"),s:J.from(t.s,"base64")};try{let i=await we(e.epriv,n.s).then(y=>M.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},y,new Uint8Array(n.ct))),s=le(new TextDecoder("utf8").decode(i));return r&&r(s),s}catch{return r&&r(null),null}},verify:async(t,e,r)=>{if(!e||!e.pub)return r&&r(null),null;let n=le(t),i=await M.importKey("jwk",te(e.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),s={};if(typeof n.m=="string")s=n.m;else for(let h of Object.keys(n.m).sort())h!=="_"&&h!==K&&h!==W&&(s[h]=n.m[h]);let y=await oe(s),d=new Uint8Array(J.from(n.s,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}};if(await M.verify(a,i,d,new Uint8Array(y))){let h=le(n.m);return r&&r(h),h}return r&&r(null),null},sign:async(t,e,r)=>{if(!e||!e.pub||!e.priv)return r&&r(null),null;let n={};if(typeof t=="string")n=t;else{let h=le(t);for(let b of Object.keys(h).sort())b!=="_"&&b!==K&&b!==W&&(n[b]=h[b])}let i=await oe(n),s=te(e.pub,e.priv),y={name:"ECDSA",namedCurve:"P-256"},d=await M.importKey("jwk",s,y,!1,["sign"]).then(h=>M.sign({name:"ECDSA",hash:{name:"SHA-256"}},h,new Uint8Array(i))),a={m:n,s:J.from(d,"binary").toString("base64")};return r&&r(a),a},signTimestamp:async(t,e,r)=>{if(!e||!e.pub||!e.priv)return r&&r(null),null;let n=t.toString(),i=await oe(n),s=te(e.pub,e.priv),y={name:"ECDSA",namedCurve:"P-256"},d=await M.importKey("jwk",s,y,!1,["sign"]).then(h=>M.sign({name:"ECDSA",hash:{name:"SHA-256"}},h,new Uint8Array(i))),a=J.from(d,"binary").toString("base64");return r&&r(a),a},verifyTimestamp:async(t,e,r,n)=>{if(!r||!t||!e)return n&&n(!1),!1;try{let i=t.toString(),s=await oe(i),y=await M.importKey("jwk",te(r),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),d=new Uint8Array(J.from(e,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}},h=await M.verify(a,y,d,new Uint8Array(s));return n&&n(h),h}catch(i){return console.log(`error verifying timestamp signature: ${i.message}`),n&&n(!1),!1}},work:async(t,e,r)=>{typeof e=="function"&&(r=e,e=void 0),typeof e>"u"&&(e=de(9));let n=await M.importKey("raw",new TextEncoder().encode(pe(t)),{name:"PBKDF2"},!1,["deriveBits"]),i={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(e),hash:{name:"SHA-256"}},s=await M.deriveBits(i,n,512),y={epriv:J.from(s,"binary").toString("base64")};return r&&r(y),y},secret:async(t,e,r)=>{if(!t||!t.epub||!e||!e.epub||!e.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},i=te(t.epub),s=await M.importKey("jwk",i,n,!0,[]),y=te(e.epub,e.epriv,!1);delete y.key_ops;let d=await M.importKey("jwk",y,n,!1,["deriveBits"]).then(async a=>{let h=await M.deriveBits({public:s,name:"ECDH",namedCurve:"P-256"},a,256),b=await M.importKey("raw",new Uint8Array(h),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return M.exportKey("jwk",b).then(({k:f})=>f)});return r&&r({epriv:d}),{epriv:d}}},H=Xe;var Ae=100,Ce=1e4,be=(t,e,r,n,i=!1)=>t<e?{historical:!0}:t>e?{incoming:!0}:i&&r!==n?(console.log(`Signed timestamp ${t}: reject conflicting value`),{historical:!0}):(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});be.mix=async(t,e,r,n)=>{if(!t||typeof t!="object")throw new TypeError("change must be an object");if(!e||typeof e!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let i=Date.now(),s={},y={},d=new Map,a=new Map,h=0;for(let f of Object.keys(t)){let S=t[f],o=!1,l=!1,p=0,g=r;if(!S||!S._)continue;let c=S[K];if(S._.s&&c&&(g=!0),f.length>1&&f[0]==="~")if(f[1]==="@")l=!0,g=!1;else{if(c&&f!="~"+c){console.log(`error public key does not match for soul: ${f}`);continue}g=!0}if(g){if(!c||!S._)continue;let u=new Set,T=new Set;for(let[m,v]of Object.entries(S._.s||{})){let $=Number(m);if(!isNaN($)&&$>0&&await H.verifyTimestamp($,v,c)){u.add($);for(let[C,I]of Object.entries(S._[">"]||{}))I===$&&T.add(C)}}if(T.size===0)continue;d.set(f,T),a.set(f,u)}for(let u of Object.keys(S)){if(u==="_"||u===W||u===K||d.has(f)&&!d.get(f).has(u))continue;let T=S[u],m=S._&&S._[">"]?S._[">"][u]:0,v=(e[f]||{})[u],$=(e[f]||{_:{">":{}}})._[">"][u]||0;if(l&&u!==P.is(T)){console.log(`error alias ${l}: ${u} !== ${P.is(T)}`);continue}let x=m-i;if(x>0){if(x>864e5)continue;(h===0||x<h)&&(h=p=x),y[f]||(y[f]={_:{"#":f,">":{},s:{}}}),y[f][u]=T,y[f]._[">"][u]=m,S._.s&&(S._.s[m]?y[f]._.s[m]=S._.s[m]:S._.s[u]&&(y[f]._.s[u]=S._.s[u]))}else{let C=a.has(f)&&a.get(f).has(m);be(m,$,T,v,C).incoming&&(s[f]||(s[f]={_:{"#":f,">":{},s:{}}}),e[f]||(e[f]={_:{"#":f,">":{},s:{}}}),e[f][u]=s[f][u]=T,e[f]._[">"][u]=s[f]._[">"][u]=m,S._.s&&(S._.s[m]?e[f]._.s[m]=s[f]._.s[m]=S._.s[m]:S._.s[u]&&(e[f]._.s[u]=s[f]._.s[u]=S._.s[u])),n[f]&&setTimeout(()=>{n[f]&&n[f].filter(_=>V(_["."],u)).forEach(_=>_.cb())},Ae),o=!0)}}o&&n[f]&&setTimeout(()=>{n[f]&&n[f].filter(u=>V(u["."])).forEach(u=>u.cb())},Ae)}let b=Object.keys(e);return b.length>Ce&&b.map(o=>{let l=e[o]._&&e[o]._[">"],p=l?Math.max(...Object.values(l)):0;return{soul:o,maxState:p}}).sort((o,l)=>o.maxState-l.maxState).slice(0,b.length-Ce).forEach(({soul:o})=>delete e[o]),{now:s,defer:y,wait:h}};var Se=be;var G="",se="",Oe=()=>{let t=(e,r,n)=>{if(n||(t[G]||(t[G]={}),n=t[G]),!e)return n;let i=0,s={},y=e[i],d=e.length-1,a=typeof r>"u",h=n[y];for(;!h&&i<d;)y+=e[++i],h=n[y];if(h)if(i===d){if(a)return typeof h[se]>"u"?h[G]:h[se];h[se]=r}else return!h[G]&&!a&&(h[G]={}),t(e.slice(++i),r,h[G]);else if(L.map(n,(f,S)=>{let o=0,l="";for(;S[o]===e[o];)l+=S[o++];if(l){if(a)return o<=d?void 0:(s[S.slice(o)]=f,f);let p={[S.slice(o)]:f,[e.slice(o)]:{[se]:r}};return n[l]={[G]:p},delete n[S],!0}})){if(a)return s}else{if(a)return;n[y]||(n[y]={}),n[y][se]=r}};return t};Oe.map=function t(e,r,n,i){i||(i=[]);var s=e[G]||e,y=Object.keys(s).sort(),d;for(let a=0;a<y.length;a++){let h=y[a],b=s[h],f=b[se];if(typeof f<"u"){if(f=r(f,i.join("")+h,h,i),typeof f<"u")return f}else n&&r(d,i.join(""),h,i);if(b[G]){if(i.push(h),f=t(b[G],r,n,i),typeof f<"u")return f;i.pop()}}};var q=Oe;var ve="",Ie="",F="",re=t=>{var e;let r=new Map,n=null,i=0,s=1e4,y=new Map,d=0,a=3e4,h=.8,b=.9;if(t||(t={}),t.log||(t.log=console.log),t.batch||(t.batch=100),t.write||(t.write=1),t.size||(t.size=1024*1024),t.memoryLimit||(t.memoryLimit=500),typeof t.cache>"u"&&(t.cache=!0),!t.store){t.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!t.store.get){t.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!t.store.put){t.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!t.store.list){t.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let f=(l,p,g,c)=>{let u=Date.now()-p;u>2e3&&console.log(`[RADISK-SLOW] ${l}: ${u}ms for ${g}${c?` (${c} bytes)`:""}`)},S=()=>{if(typeof process>"u"||!process.memoryUsage)return;let l=Date.now();if(l-d<a)return;d=l;let p=process.memoryUsage(),g=p.heapUsed,c=p.heapTotal,u=t.memoryLimit*1024*1024,T=g/u;if(T>b){let m=r.size;console.log(`[RADISK-MEMORY] High memory usage: ${Math.round(T*100)}% of heap limit. Clearing ${m} cached files.`),r.clear(),global.gc&&global.gc(),d=l+a}else T>h&&console.log(`[RADISK-MEMORY] Memory warning: ${Math.round(T*100)}% of heap limit used. Cache size: ${r.size} files.`)},o=(l,p,g)=>{if(l=""+l,typeof p=="function"){if(g=p,p=o.batch(l),typeof p<"u"||o.thrash.at&&(p=o.thrash.at(l),typeof p<"u"))return g(e,p);if(y.has(l)){y.get(l).push(g);return}y.set(l,[g]);let c=Date.now();return o.read(l,(u,T)=>{f("read",c,l);let m=y.get(l)||[];y.delete(l),m.forEach(v=>v(u,T))})}if(o.batch(l,p),S(),g&&o.batch.acks.push(g),++o.batch.ed>=t.batch)return o.thrash();clearTimeout(o.batch.timeout),o.batch.timeout=setTimeout(o.thrash,t.write)};return o.batch=q(),o.batch.acks=[],o.batch.ed=0,o.thrash=()=>{if(o.thrash.ing)return o.thrash.more=!0;let l=Date.now();clearTimeout(o.batch.timeout),o.thrash.more=!1,o.thrash.ing=!0;var p=o.thrash.at=o.batch;o.batch=null,o.batch=q(),o.batch.acks=[],o.batch.ed=0;let g=0;o.save(p,c=>{++g>1||(f("thrash",l,`batch-${p.ed}`),c&&t.log(c),p.acks.forEach(u=>u(c)),o.thrash.at=null,o.thrash.ing=!1,o.thrash.more&&o.thrash())})},o.save=(l,p)=>{let g={find:(c,u)=>{if(!(u<g.start))return g.start=u,t.store.list(g.lex),!0},lex:c=>{!c||c>g.start?(g.end=c,g.start&&g.mix(g.file||"!",g.start,g.end)):g.file=c},mix:(c,u,T)=>{if(g.start=g.end=g.file=e,r.has(c)){let m=r.get(c);q.map(l,(v,$)=>{if(!($<u)){if(T&&T<$){g.start=$;return}m($,v)}}),o.write(c,m,g.next)}else o.parse(c,(m,v)=>{if(m)return p(m);q.map(l,($,x)=>{if(!(x<u)){if(T&&T<x){g.start=x;return}v(x,$)}}),o.write(c,v,g.next)})},next:c=>{if(c)return p(c);if(g.start)return q.map(l,g.find);p(c)}};q.map(l,g.find)},o.write=(l,p,g)=>{let c={text:"",limit:"",done:!1,count:0,each:(T,m,v,$)=>{if(c.done)return;c.count++,T=typeof T>"u"?"":"="+re.encode(T);let x=re.encode($.length)+"#"+re.encode(v)+T+`
`;if(c.count>1&&$.length===0&&c.text.length+x.length>t.size){let C=v.indexOf(Ie);if(c.limit=C===-1?v:v.substring(0,C),c.limit!==l){c.done=!0,c.sub=q(),q.map(p,c.slice),o.write(c.limit,c.sub,g);return}}c.text+=x},slice:(T,m)=>{m<c.limit||c.sub(m,T)}};q.map(p,c.each,!0);let u=Date.now();t.store.put(l,c.text,T=>{f("file-write",u,l,c.text.length),g(T)})},o.read=(l,p)=>{let g=l.indexOf(Ie),c=g===-1?l:l.substring(0,g),u={lex:m=>{if(!m){if(!u.file){p("no file found",e);return}if(t.cache&&r.has(u.file)){let v=r.get(u.file);return u.value=v(l),p(e,u.value)}o.parse(u.file,u.it);return}m>c||m<u.file||(u.file=m)},it:(m,v)=>{m&&t.log(m),v&&(t.cache&&(r.set(u.file,v),S()),u.value=v(l)),p(m,u.value)}},T=Date.now();if(t.cache&&n&&T-i<s)n.forEach(m=>u.lex(m)),u.lex();else{let m=[],v=u.lex;u.lex=$=>($&&m.push($),v($)),t.store.list($=>{u.lex($),!$&&t.cache&&(n=m,i=T)})}},o.parse=(l,p)=>{let g={disk:q(),read:(c,u)=>{if(c)return p(c);if(!u)return p(e,g.disk);let T=[],m="",v=g.split(u);for(;v;){let $,x,C=v[1];v=g.split(v[2])||"",v[0]==="#"&&($=v[1],C<T.length&&(T.length=C),C<=T.length&&(T[C]=$,T.length=C+1),m=T.join("")),v=g.split(v[2])||"",v[0]!==`
`&&(v[0]==="="&&(x=v[1]),typeof $<"u"&&typeof x<"u"&&g.disk(m,x),v=g.split(v[2]))}p(e,g.disk)},split:c=>{if(!c)return;let u=c.indexOf(F);if(u===-1)return;let T=c.slice(0,u),m={};return[T,re.decode(c.slice(u),m),c.slice(u+m.i)]}};t.store.get(l,g.read)},o};re.encode=t=>{let e="",r="";if(t instanceof Array&&(t.length===2||t.length===3)&&(e=ve+t[1],t.length===3&&t[2]&&(r=ve+t[2]),t=t[0]),typeof t=="string"){let i=0,s=null,y=F;for(;s=t[i++];)s===F&&(y+=F);return y+'"'+t+e+r+F}let n=P.is(t);if(n)return F+"#"+n+e+r+F;if(fe.is(t))return F+"+"+(t||0)+e+r+F;if(t===!0)return F+"+"+e+r+F;if(t===!1)return F+"-"+e+r+F;if(t===null)return F+" "+e+r+F};re.decode=(t,e)=>{var r=-1,n=0,i=null,s=null,y=-1,d=-1;if(t[0]!==F)return;for(;i=t[++r];)if(s){if(y===-1&&(y=r),i===F&&--n<=0){d=r;break}}else i===F?n++:s=i||!0;let a=y!==-1?t.slice(y,d!==-1?d:r):"";e&&(e.i=r+1);let h=a.split(ve),b=h[0],f=h[1],S=h[2];if(f)if(f=parseFloat(f),S){if(s==='"')return[b,f,S];if(s==="#")return[P.ify(b),f,S];if(s==="+")return b.length===0?[!0,f,S]:[parseFloat(b),f,S];if(s==="-")return[!1,f,S];if(s===" ")return[null,f,S]}else{if(s==='"')return[b,f];if(s==="#")return[P.ify(b),f];if(s==="+")return b.length===0?[!0,f]:[parseFloat(b),f];if(s==="-")return[!1,f];if(s===" ")return[null,f]}else{if(s==='"')return a;if(s==="#")return P.ify(a);if(s==="+")return a.length===0?!0:parseFloat(a);if(s==="-")return!1;if(s===" ")return null}};var Ne=re;var Me=typeof document>"u",Z=Me?await import("node:fs"):void 0,De="",he="",ke=he+"+0"+he+"#"+he+'"root'+he,Qe=t=>{let e=t.file;if(Me)return Z.existsSync(e)||Z.mkdirSync(e),Z.existsSync(e+"/!")||Z.writeFileSync(e+"/!",ke),{get:(r,n)=>{Z.readFile(e+"/"+r,(i,s)=>{if(i){if(i.code==="ENOENT"){n();return}console.log("fs.readFile error:",i)}s&&(s=s.toString()),n(i,s)})},put:(r,n,i)=>{var s=r+"."+R.random(9)+".tmp";Z.writeFile(s,n,y=>{if(y){console.log("fs.writeFile error:",y),i(y);return}Z.rename(s,e+"/"+r,i)})},list:r=>{Z.readdir(e,(n,i)=>{if(n){console.log("fs.readdir error:",n),r();return}i.forEach(r),r()})}};if(t.indexedDB){let r,n=indexedDB.open(e,1);return n.onupgradeneeded=i=>{i.target.result.createObjectStore(e)},n.onerror=i=>{console.log(i)},n.onsuccess=()=>{if(r=n.result,r){let s=r.transaction([e],"readonly").objectStore(e).getKey("!");s.onerror=()=>{console.log(`error getting key ${e}/!`)},s.onsuccess=()=>{if(!s.result){let d=r.transaction([e],"readwrite").objectStore(e).put(ke,"!");d.onerror=()=>{console.log(`error putting root on ${e}/!`)}}}}else console.log("error indexedDB not available")},{get:(i,s)=>{let y=(h,b)=>{let S=r.transaction([e],"readonly").objectStore(e).get(h);S.onerror=()=>{console.log(`error getting ${e}/${h}`)},S.onsuccess=()=>{b(null,S.result)}};if(r){y(i,s);return}let d=0,a=setInterval(()=>{if(r){clearInterval(a),y(i,s);return}d++>5&&(clearInterval(a),s("error indexedDB not available"))},1e3)},put:(i,s,y)=>{let d=(b,f,S)=>{let l=r.transaction([e],"readwrite").objectStore(e).put(f,b);l.onerror=()=>{console.log(`error putting data on ${e}/${b}`)},l.onsuccess=()=>{S(null)}};if(r){d(i,s,y);return}let a=0,h=setInterval(()=>{if(r){clearInterval(h),d(i,s,y);return}a++>5&&(clearInterval(h),y("error indexedDB not available"))},1e3)},list:i=>{let s=a=>{let b=r.transaction([e],"readonly").objectStore(e).getAllKeys();b.onerror=()=>console.log("error getting keys for",e),b.onsuccess=()=>{b.result.forEach(a),a()}};if(r){s(i);return}let y=0,d=setInterval(()=>{if(r){clearInterval(d),s(i);return}y++>5&&(clearInterval(d),console.log("error indexedDB not available"),i())},1e3)}}}return{get:(r,n)=>{n(null,ke)},put:(r,n,i)=>{i(null)},list:r=>{r("!"),r()}}},Ye=t=>{L.is(t)||(t={}),t.file=String(t.file||"radata"),t.store||(t.store=Qe(t));let e=Ne(t);return{get:(r,n)=>{if(!r||!L.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}var i=r["#"],s=typeof r["."]=="string"?r["."]:"",y,d={};let a=(h,b)=>{if(V(r["."],b)&&(y||(y={_:{"#":i,">":{}}}),y[b]=h[0],y._[">"][b]=h[1],h.length===3&&h[2])){let f=h[1];d[f]=h[2],d[b]=h[2]}};e(i+De+s,(h,b)=>{let f;L.is(b)?(q.map(b,a),y||a(b,s),f={[i]:y}):b&&(a(b,s),f={[i]:y}),f&&f[i]&&Object.keys(d).length>0&&(f[i]._.s=d),n(h,f)})},put:(r,n)=>{if(!r){n("graph required");return}let i=0,s=!1,y=d=>{if(i--,!s){if(d){s=!0,n(d);return}i===0&&(s=!0,n(null))}};Object.keys(r).forEach(d=>{var a=r[d];Object.keys(a).forEach(h=>{if(h==="_")return;i++;let b=a[h],f=a._[">"][h],S=a._.s&&a._.s[f],o=S?[b,f,S]:[b,f];e(d+De+h,o,y)})})}}},Re=Ye;var Ue=typeof document>"u",Pe=Ue?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Pe?.WebSocket);var Ze=t=>{let e=new Map,r=1500,n=6e4,i=10,s=null;return t||(s=setInterval(()=>{let d=Date.now();for(let[a,h]of e.entries())d-h.lastCleanup>n&&(h.requests=[],h.lastCleanup=d),h.requests=h.requests.filter(b=>d-b<n),d-h.lastCleanup>n*10&&(h.throttleCount=0)},n/4)),{getDelay:d=>{let a=Date.now(),h=e.get(d)||{requests:[],lastCleanup:a,throttleCount:0};if(h.requests=h.requests.filter(b=>a-b<n),h.requests.length>=r){let b=Math.min(...h.requests),f=n-(a-b);return h.throttleCount=(h.throttleCount||0)+1,e.set(d,h),Math.max(0,f)}return h.requests.push(a),e.set(d,h),0},getRemainingRequests:d=>{let a=e.get(d);if(!a)return r;let h=Date.now(),b=a.requests.filter(f=>h-f<n);return Math.max(0,r-b.length)},getThrottleCount:d=>{let a=e.get(d);return a&&a.throttleCount||0},shouldDisconnect:d=>{let a=e.get(d);return a?a.throttleCount>=i:!1},destroy:()=>{s&&(clearInterval(s),s=null),e.clear()}}},Ve=(t,e=1024*1024)=>{try{if(typeof t=="string"&&t.length>e)throw new Error("Message too large");return{success:!0,data:JSON.parse(t)}}catch(r){return{success:!1,error:r.message}}},et=(t,e=1024*1024)=>typeof t=="string"&&t.length>e?{valid:!1,error:"Message too large"}:Buffer.isBuffer(t)&&t.length>e?{valid:!1,error:"Message too large"}:{valid:!0},tt=(t=1e3)=>{let e=new Set;return{add:r=>{if(e.size>=t)return!1;e.add(r);let n=r.close;return r.close=(...i)=>(e.delete(r),n.apply(r,i)),!0},remove:r=>{e.delete(r)},count:()=>e.size,isFull:()=>e.size>=t}},Te=(t=5)=>{let e=0;return{shouldRetry:()=>e<t,getDelay:()=>Math.min(1e3*Math.pow(2,e),3e4),increment:()=>e++,reset:()=>e=0}},rt=t=>{let e=Ee(t.maxAge),r=Re(t),n={},i={},s={},y=new Set,d=new Map,a=async _=>n[_]?!0:new Promise(w=>{r.get({"#":_},(E,k)=>{w(!E&&k&&k[_])})}),h=t.wss&&t.wss.constructor.name==="Server",b=Ze(h),f=tt(t.maxConnections||1e3),S=async(_,w,E)=>{for(let k of Object.keys(_)){let j=await new Promise(O=>{p({"#":k},O,w)});if(j.err)return E&&E(j.err),!1;let A=_[k],N=K;if(!(!j.put||!j.put[k]||j.put[k][N]===A[N]))return E&&E(`error in wire check public key does not match for soul: ${k}`),!1}return!0},o=(_,w)=>{let E=me(_.get,n);E?w(JSON.stringify({"#":e.track(R.random(9)),"@":_["#"],put:E})):r.get(_.get,(k,j)=>{w(JSON.stringify({"#":e.track(R.random(9)),"@":_["#"],put:j,err:k}))})},l=async(_,w)=>{let E=await Se.mix(_.put,n,t.secure,s);if(Object.keys(E.now).length===0){Object.keys(E.defer).length!==0&&setTimeout(()=>l({put:E.defer,"#":_["#"]},w),E.wait);return}await S(E.now,w)&&(r.put(E.now,k=>{w(JSON.stringify({"#":e.track(R.random(9)),"@":_["#"],err:k}))}),Object.keys(E.defer).length!==0&&setTimeout(()=>l({put:E.defer,"#":_["#"]},w),E.wait))},p=(_,w,E,k)=>{if(!w)return;L.is(k)||(k={});let j=me(_,n),A=R.random(9),N=JSON.stringify({"#":e.track(A),get:t.secure?{"#":_["#"]}:_});if(j){let O=E(N);if(O&&O.err){w({err:O.err});return}w({put:j});return}r.get(_,(O,U)=>{if(U){let B=E(N);if(B&&B.err){w({err:B.err});return}w({put:U,err:O});return}O&&console.log(O),i[A]=w,d.set(A,{lex:_,wait:k.wait||100});let D=E(N);if(D&&D.err){w({err:D.err}),delete i[A],d.delete(A);return}})},g=_=>({get:(w,E,k)=>{w&&typeof w["."]=="number"&&(w={...w,".":String(w["."])}),w&&w["#"]&&y.add(w["#"]),p(w,E,_,k)},put:async(w,E)=>{let k=await Se.mix(w,n,t.secure,s);if(Object.keys(k.now).length===0){E&&E(null);return}if(!await S(k.now,_,E))return;for(let[A,N]of Object.entries(k.now))if(N&&typeof N=="object")for(let[O,U]of Object.entries(N)){let D=P.is(U);D&&y.add(D)}r.put(k.now,E);let j=_(JSON.stringify({"#":e.track(R.random(9)),put:w}));if(j&&j.err){E&&E(j.err);return}},on:(w,E,k,j)=>{w&&typeof w["."]=="number"&&(w={...w,".":String(w["."])});let A=w&&w["#"];!A||!E||(s[A]?s[A].push({".":w["."],cb:E}):s[A]=[{".":w["."],cb:E}],k&&p(w,E,_,j))},off:(w,E)=>{let k=w&&w["#"];if(!(!k||!s[k]))if(E){let j=s[k].find(A=>A.cb===E);j&&s[k].splice(s[k].indexOf(j),1)}else delete s[k]}});if(Ue){let _=t.wss,w=()=>_.clients();if(!_){let k=t.server?{server:t.server}:{port:t.port||8765};_=new Pe.WebSocketServer(k),w=()=>_.clients}let E=(k,j)=>{let N=JSON.parse(k)["#"];if(N&&d.has(N)){let O=d.get(N);d.delete(N),O.timeoutId=setTimeout(()=>{let U=i[N];if(U){let D=O.lex["#"],B={[D]:null};typeof O.lex["."]=="string"&&(B[D]={[O.lex["."]]:null}),U({put:B}),delete i[N]}},O.wait)}w().forEach(O=>{if(O&&O.readyState===WebSocket.OPEN)O.send(k,{binary:j});else{let U=O._retryHandler||Te();if(O._retryHandler=U,U.shouldRetry()){let D=U.getDelay();U.increment(),setTimeout(()=>{O&&O.readyState===WebSocket.OPEN&&(U.reset(),O.send(k,{binary:j}))},D)}}})};return _.on("connection",k=>{if(!f.add(k)){console.log("Connection limit reached, rejecting connection"),k.close(1013,"Connection limit reached - try again later");return}let j=R.random(9);console.log(`New WebSocket client connected: ${j}`),k.on("error",A=>{console.log("WebSocket error:",A),f.remove(k)}),k.on("close",()=>{console.log(`WebSocket client disconnected: ${j}`),f.remove(k)}),k.on("message",(A,N)=>{let O=et(A,t.maxMessageSize);if(!O.valid){console.warn(`Invalid message: ${O.error}`),k.send(JSON.stringify({error:O.error}));return}let U=Ve(A,t.maxMessageSize);if(!U.success){console.warn(`JSON parse error: ${U.error}`),k.send(JSON.stringify({error:"Invalid JSON"}));return}let D=U.data;if(e.check(D["#"]))return;let B=b.getDelay(j);if(B>0){let ie=b.getThrottleCount(j);if(console.log(`Client ${j}: rate limit exceeded, delay would be ${B}ms, dropping message (throttle count: ${ie})`),b.shouldDisconnect(j)){console.log(`Client ${j}: Disconnecting after ${ie} throttle violations`),k.close(1008,"Rate limit violations");return}k.send(JSON.stringify({"#":e.track(R.random(9)),"@":D["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(B/1e3)}s`,throttle:B}));return}let ne=()=>{e.track(D["#"]),D.get&&o(D,E),D.put&&l(D,E),E(A,N);let ie=D["@"],ae=i[ie];ae&&(delete D["#"],delete D["@"],ae(D),delete i[ie])};B>0?setTimeout(ne,B):ne()})}),g(E)}let c=[],u=!1,T=0,m=[],v=null,$=t.maxQueueLength||1e4,x=()=>{if(m.length===0){v=null;return}let _=Date.now();if(u&&_<T){v=setTimeout(x,Math.min(1e3,T-_));return}u&&_>=T&&(console.log("Throttle period ended, resuming queue processing"),u=!1,T=0);let w=m[0];if(C(w)){m.shift();let j=JSON.parse(w)["#"];if(j&&d.has(j)){let A=d.get(j);d.delete(j),A.timeoutId=setTimeout(()=>{let N=i[j];if(N){let O=A.lex["#"],U={[O]:null};typeof A.lex["."]=="string"&&(U[O]={[A.lex["."]]:null}),N({put:U}),delete i[j]}},A.wait)}}m.length>0?v=setTimeout(x,50):v=null},C=_=>{let w=!1;return c.forEach(E=>{if(E&&E.readyState===WebSocket.OPEN)E.send(_),w=!0;else{let k=E._retryHandler||Te();if(E._retryHandler=k,k.shouldRetry()){let j=k.getDelay();k.increment(),setTimeout(()=>{E&&E.readyState===WebSocket.OPEN&&(k.reset(),E.send(_))},j)}}}),w},I=_=>{if(m.length>=$)return{err:`Message queue exceeded maximum length (${$}). Update query logic to request less data.`,queueLength:m.length,maxQueueLength:$};m.push(_),v||(v=setTimeout(x,50))};return t.peers instanceof Array||(t.peers=[`ws://localhost:${t.port||8765}`]),t.peers.forEach(_=>{let w=()=>{let E=new WebSocket(_);c.push(E);let k=Te();E.onclose=j=>{if(c.indexOf(E)!==-1&&c.splice(c.indexOf(E),1),E=null,k.shouldRetry()){let A=k.getDelay();k.increment(),setTimeout(w,A)}},E.onopen=()=>{k.reset()},E.onerror=j=>{console.log(j)},E.onmessage=async j=>{let A=JSON.parse(j.data);if(e.check(A["#"]))return;if(A.throttle&&A.err){console.log(`Server throttling: ${A.err}`),u=!0,T=Date.now()+A.throttle;return}if(e.track(A["#"]),A.get&&o(A,I),A.put){let U={};for(let[D,B]of Object.entries(A.put)){let ne=!1;if(await a(D)&&(ne=!0,B&&typeof B=="object"))for(let[ie,ae]of Object.entries(B)){let _e=P.is(ae);_e&&y.add(_e)}y.has(D)&&(ne=!0,y.delete(D)),ne&&(U[D]=B)}if(Object.keys(U).length>0){let D={put:U,"#":A["#"]};l(D,I)}}let N=A["@"],O=i[N];O&&(delete A["#"],delete A["@"],O(A),delete i[N])}};w()}),g(I)},ye=rt;var nt=(t,e)=>{e||(e=ye(t));let r=[],n=!1,i=!1,s=0,y=(a,h,b,f)=>{let S=g=>{s++,y(g,h,b,f)},o=g=>{r=[],s=0,i=!1,f(g)},l=()=>{if(r.length===0){o("Wrong username or password");return}let g=r.shift();e.get({"#":g},async c=>{if(c.err){o(`error getting ${g}: ${c.err}`);return}let u=c.put&&c.put[g];if(!u||!u.auth)return l();let T=JSON.parse(u.auth),m=await H.work(h,T.salt),v=await H.decrypt(T.enc,m);if(!v)return l();if(d.is={username:a,pub:u.pub,epub:u.epub,priv:v.priv,epriv:v.epriv},b!==""){let x=R.random(64),C=await H.work(b,x),I=await H.encrypt(v,C),_={auth:JSON.stringify({enc:I,salt:x})},w=Date.now(),E=await H.signTimestamp(w,d.is),k=X(g,_,E,u.pub,w);e.put(k,j=>{o(j?`error putting ${_} on ${g}: ${j}`:null)});return}if(typeof globalThis.localStorage<"u"&&globalThis.localStorage.getItem("holster_migrate_signatures")==="true"){let x={};for(let w of Object.keys(u))w!=="_"&&w!==K&&w!==W&&(x[w]=u[w]);let C=Date.now(),I=await H.signTimestamp(C,d.is),_=X(g,x,I,u.pub,C);e.put(_,w=>{w&&console.log(`warning: failed to migrate signatures on login: ${w}`),o(null)})}else o(null)},{wait:5e3})};if(s>9){o("Wrong username or password");return}let p="~@"+a;e.get({"#":p},async g=>{if(g.err){o(`error getting ${p}: ${g.err}`);return}let c=g.put&&g.put[p];if(!c)return S(a);delete g.put[p]._,r=Object.keys(c),l()},{wait:5e3})},d={create:(a,h,b)=>{let f=o=>{b?b(o):console.log(o)};if(n){f("User is already being created");return}if(a===""){f("Please provide a username");return}if(h===""){f("Please provide a password");return}n=!0;let S="~@"+a;e.get({"#":S},async o=>{if(o.err){n=!1,f(`error getting ${S}: ${o.err}`);return}if(o.put&&o.put[S]){n=!1,f("Username already exists");return}let l=R.random(64),p=await H.work(h,l),g=await H.pair(),c={priv:g.priv,epriv:g.epriv},u=await H.encrypt(c,p),T={username:a,pub:g.pub,epub:g.epub,auth:JSON.stringify({enc:u,salt:l})},m="~"+g.pub,v=Date.now(),$=await H.signTimestamp(v,g),x=X(m,T,$,g.pub,v);e.put(x,C=>{if(n=!1,C){f(`error putting ${T} on ${m}: ${C}`);return}let I={[m]:{"#":m}};e.put(X(S,I),_=>{if(_){f(`error putting ${I} on ${S}: ${_}`);return}b&&b(null)})})},{wait:5e3})},auth:(a,h,b)=>{let f=S=>{b?b(S):S&&console.log(S)};if(i){f("User is already authenticating");return}if(d.is=null,a===""){f("Please provide a username");return}if(h===""){f("Please provide a password");return}i=!0,y(a,h,"",f)},change:(a,h,b,f)=>{let S=o=>{f?f(o):o&&console.log(o)};if(i){S("User is already authenticating");return}if(d.is=null,a===""){S("Please provide a username");return}if(h===""){S("Please provide a password");return}if(b===""){S("Please provide a new password");return}i=!0,y(a,h,b,S)},store:a=>{if(!d.is){console.log("Please authenticate before calling store");return}if(a){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(d.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let a=globalThis.localStorage.getItem("user.is");if(a){d.is=JSON.parse(a);return}}if(typeof globalThis.sessionStorage<"u"){let a=globalThis.sessionStorage.getItem("user.is");a&&(d.is=JSON.parse(a))}},leave:()=>{d.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(a,h,b)=>{let f=S=>{b?b(S):console.log(S)};if(i){f("User is already authenticating");return}if(a===""){f("Please provide a username");return}if(h===""){f("Please provide a password");return}i=!0,y(a,h,"",async S=>{if(S){f(S);return}let o={username:null,pub:null,epub:null,auth:null},l=Date.now(),p=await H.signTimestamp(l,d.is),g="~"+d.is.pub,c=X(g,o,p,d.is.pub,l);e.put(c,u=>{if(u){f(`error putting null on ${g}: ${u}`);return}d.is=null,b&&b(null)})})}};return d},Le=nt;var it=t=>{typeof t=="string"?t={peers:[t]}:t instanceof Array?t={peers:t}:L.is(t)||(t={});let e=ye(t),r=Le(null,e),n=new Map,i=new Map,s=a=>a===null||a===!0||a===!1||typeof a=="string"||P.is(a)||fe.is(a),y=a=>{if(s(a))return!0;if(L.is(a)){let b=[];for(let[f,S]of Object.entries(a)){if(f==="_")return"error underscore cannot be used as a property name";if(L.is(S)||s(S)){b.push(f);continue}return typeof S>"u"?`error undefined ${f} cannot be converted to a graph`:`error ${JSON.stringify({[f]:S})} cannot be converted to a graph`}if(b.length!==0)return b}return`error ${JSON.stringify(a)} cannot be converted to a graph`},d=a=>{let h=(o,l,p,g)=>{e.get(L.put(o,"#",l),async c=>{if(c.err&&console.log(c.err),c.put&&c.put[l]){delete c.put[l]._,delete c.put[l][K],delete c.put[l][W];for(let u of Object.keys(c.put[l])){let T=P.is(c.put[l][u]);if(T){let m=async(v=0)=>{let $=await new Promise(x=>{let C=R.random();i.set(C,{chain:[{item:null,soul:T}]}),d(C).next(null,x,g)});return $!==null||v>=5?$:(await new Promise(x=>setTimeout(x,50)),m(v+1))};c.put[l][u]=await m()}}p(c.put[l])}else p(null)},g)},b=async(o,l,p,g)=>{if(p){let c=Date.now(),u=await H.signTimestamp(c,p);return X(o,l,u,p.pub,c)}return t.secure?(g||(g=console.log),g(`error putting data on ${o}: user required in secure mode`),null):X(o,l)},f=o=>l=>{let p=i.get(o);p&&typeof p.cb<"u"?setTimeout(()=>p.cb(l),1):l&&console.log("error no callback for data",l,"ctx",p),p&&!p.on&&i.delete(o)},S=(o,l)=>{if(!o){console.log("error resolve request parameter required");return}let p=typeof o.get<"u",g=typeof o.put<"u",c=typeof o.on<"u",u=typeof o.off<"u",T=!1,m=i.get(a);for(var v=1;v<m.chain.length;v++)if(m.chain[v].soul===null){T=!0;break}if(T){let{item:$,soul:x}=m.chain[v-1];return e.get({"#":x,".":$},async C=>{if(C.err){m.user||t.secure?console.log(`error getting ${x}: ${C.err}`):console.log(`error getting ${$} on ${x}: ${C.err}`),l&&l(null);return}let I=C.put&&C.put[x];if(I&&typeof I[$]<"u"){let _=P.is(I[$]);if(_)m.chain[v].soul=_,i.set(a,{...m}),p?d(a).next(null,o.get,l,o._opt):g?d(a).put(o.put,l):c?d(a).on(o.on,l,o._get,o._opt):u&&d(a).off(l);else if(p)l(I[$]);else if(g){_=R.random(),I[$]=P.ify(_);let w=await b(x,I,m.user,l);if(w===null)return;e.put(w,E=>{if(E){l(`error putting ${$} on ${x}: ${E}`);return}m.chain[v].soul=_,d(a).put(o.put,l)})}else(c||u&&l)&&l(null)}else if(g){let _=R.random();I||(I={}),I[$]=P.ify(_);let w=await b(x,I,m.user,l);if(w===null)return;e.put(w,E=>{if(E){l(`error putting ${$} on ${x}: ${E}`);return}m.chain[v].soul=_,d(a).put(o.put,l)})}else l&&l(null)},o._opt),!1}return p&&m.chain[m.chain.length-1].item!==null?(m.chain.push({item:null,soul:null}),d(a).next(null,o.get,l,o._opt),!1):m.chain[m.chain.length-1]};return{get:(o,l,p,g)=>{if(typeof l=="function"&&(g=p,p=l,l=null),o===null||o===""||o==="_"){console.log("error please provide a key"),p&&p(null);return}if(l&&typeof p!="function"){console.log("error lex requires a callback function");return}if(a=R.random(),i.set(a,{chain:[{item:String(o),soul:"root"}],cb:p}),!p)return d(a);let c=f(a),{soul:u}=S({get:l,_opt:g},c);u&&h(l,u,c,g)},next:(o,l,p,g)=>{let c=v=>$=>{p?p($):f(v)($)};if(typeof l=="function"&&(g=p,p=l,l=null),!a){console.log("error please provide a key using get(key)"),p&&p(null);return}let u=c(a);if(o===""||o==="_"){u(null);return}if(l&&typeof p!="function"){console.log("error lex requires a callback function");return}let T=i.get(a);if(!T)return;if(p&&typeof T.cb>"u"&&(T.cb=p,p=null),o!==null&&T.chain.push({item:String(o),soul:null}),!T.cb)return d(a);let{soul:m}=S({get:l,_opt:g},u);m&&h(l,m,u,g)},put:(o,l,p)=>{typeof l=="function"&&(p=l,l=!1);let g=x=>C=>{p?p(C):f(x)(C)};if(!a){p&&p("error please provide a key using get(key)");return}let c=i.get(a);if(!c)return;if(!c.cb){if(!p)return;c.cb=p,p=null}l&&(o={[R.random()]:o});let u=g(a),T=y(o);if(typeof T=="string"){u(T);return}let{item:m,soul:v}=S({put:o},u);if(!v)return;if(T===!0){e.get({"#":v,".":m},async x=>{if(x.err){u(`error getting ${v}: ${x.err}`);return}let C=x.put&&x.put[v],I=C&&C[m],_=P.is(I);if(!_){C||(C={}),C[m]=o;let w=await b(v,C,c.user,u);if(w===null)return;e.put(w,u);return}e.get({"#":_},async w=>{if(w.err){u(`error getting ${_}: ${w.err}`);return}if(!w.put||!w.put[_]){u(`error ${_} not found`);return}for(let k of Object.keys(w.put[_])){if(k==="_"||k===K||k===W)continue;let j=await new Promise(A=>{let N=R.random(),O=[{item:k,soul:_}];i.set(N,{chain:O,user:c.user}),d(N).put(null,A)});if(j){u(j);return}}C||(C={}),C[m]=o;let E=await b(v,C,c.user,u);E!==null&&e.put(E,u)})});return}let $=(x=0)=>{e.get({"#":v,".":m},async C=>{if(C.err){u(`error getting ${v}.${m}: ${C.err}`);return}let I=C.put&&C.put[v],_=I&&I[m];if(!_&&x<5)return await new Promise(k=>setTimeout(k,50)),$(x+1);let w=P.is(_);if(!w){I||(I={}),I[m]=P.ify(R.random());let k=await b(v,I,c.user,u);if(k===null)return;e.put(k,j=>{if(j)u(`error putting ${m} on ${v}: ${j}`);else{let A=R.random(),N=[{item:m,soul:v}];i.set(A,{chain:N,user:c.user,cb:c.cb}),d(A).put(o)}});return}let E=[];for(let k of T){let j=await new Promise(A=>{if(L.is(o[k])&&!P.is(o[k])){let N=R.random(),O=[{item:k,soul:w}];i.set(N,{chain:O,user:c.user}),d(N).put(o[k],A)}else E.push(k),A(null)});if(j){u(j,a);return}}if(E.length===0){u(null);return}e.get({"#":w},async k=>{if(k.err){u(`error getting ${w}: ${k.err}`);return}let j=k.put&&k.put[w];j||(j={}),E.forEach(N=>{j[N]=o[N]});let A=await b(w,j,c.user,u);A!==null&&e.put(A,u)})})};$()},on:(o,l,p,g)=>{if(typeof o=="function"&&(g=p,p=l,l=o,o=null),typeof l!="function"){console.log("error on() requires a callback function");return}if(!a){console.log("error please provide a key using get(key)"),l(null);return}let{item:c,soul:u}=S({on:o,_get:p,_opt:g},l);if(!u)return;i.set(a,{chain:[{item:c,soul:u}],on:!0}),n.set(l,()=>{e.get({"#":u,".":c},m=>{let v=m.put&&m.put[u]&&m.put[u][c],$=P.is(v);if($){let x=async(C=0)=>{let I=await new Promise(_=>{let w=R.random();i.set(w,{chain:[{item:null,soul:$}]}),d(w).next(null,_,g)});I!==null||C>=5?l(I):(await new Promise(_=>setTimeout(_,50)),x(C+1))};x()}else l(v!==void 0?v:null)},g)});let T;o?(T=L.put(o,"#",u),T["."]!=null&&typeof T["."]=="number"&&(T={...T,".":String(T["."])})):T={"#":u,".":c},e.on(T,n.get(l),!1,g),e.get({"#":u,".":c},m=>{if(m.err){console.log(`error getting ${u}.${c}: ${m.err}`);return}let v=m.put&&m.put[u]&&m.put[u][c],$=P.is(v);if($){e.off(T,n.get(l));let x;o?x=L.put(T,"#",$):x={"#":$,".":null},e.on(x,n.get(l),p,g)}else p&&n.get(l)()},g)},off:o=>{if(!a){console.log("error please provide a key using get(key)"),o&&o(null);return}let{item:l,soul:p}=S({off:!0},o);p&&e.get({"#":p,".":l},g=>{if(g.err){console.log(`error getting ${p}.${l}: ${g.err}`);return}let c=g.put&&g.put[p]&&g.put[p][l],u=P.is(c);u?e.off({"#":u},n.get(o)):e.off({"#":p},n.get(o)),n.delete(o),i.delete(a)})},user:()=>(r.get||(Object.assign(r,d()),r.get=(o,l,p,g)=>{typeof l=="function"&&(g=p,p=l,l=null);let c=null,u=null;if(r.is&&(c=r.is.pub),typeof o=="string"?u=o:o instanceof Array&&(o.length===2?(c=o[0],u=o[1]):o.length===1&&(u=o[0])),!c){console.log("error please log in or provide a public key"),p&&p(null);return}if(u===null||u===""||u==="_"){console.log("error please provide a key"),p&&p(null);return}if(l&&!p){console.log("error lex requires a callback function");return}a=R.random();let T=[{item:String(u),soul:"~"+c}];if(i.set(a,{chain:T,user:r.is,cb:p}),!p)return d(a);let m=f(a),{soul:v}=S({get:l,_opt:g},m);v&&h(l,v,m,g)}),r),wire:e,SEA:H}};return d()},Mt=it;export{Mt as default};
//# sourceMappingURL=holster.js.map
