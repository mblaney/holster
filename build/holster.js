var B={is:t=>!(t instanceof Array)&&(t-parseFloat(t)+1>=0||t===1/0||t===-1/0)},v={is:t=>t?t instanceof Object&&t.constructor===Object||Object.prototype.toString.call(t).match(/^\[object (\w+)\]$/)[1]==="Object":!1,map:(t,e,u)=>{var n=Object.keys(t);for(let i=0;i<n.length;i++){let c=e(t[n[i]],n[i],u);if(typeof c<"u")return c}},put:(t,e,u)=>(t||(t={}),t[e]=u,t),del:(t,e)=>{if(t)return t[e]=null,delete t[e],t}},et=(t,e,u)=>{if(u.id){u.id=!1;return}if(e==="#"&&typeof t=="string"){u.id=t;return}u.id=!1},_={is:t=>{if(t&&t["#"]&&!t._&&v.is(t)){let e={};if(v.map(t,et,e),e.id)return e.id}return!1},ify:t=>v.put({},"#",t)},b={random:t=>{var e="";let u="0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";t||(t=24);for(let n=0;n<t;n++)e+=u.charAt(Math.floor(Math.random()*u.length));return e}};var rt=t=>{t||(t=9e3);let e={store:{}};return e.check=u=>e.store[u]?e.track(u):!1,e.track=u=>(e.store[u]=Date.now(),e.expiry||(e.expiry=setTimeout(()=>{let n=Date.now();Object.keys(e.store).forEach(i=>{n-e.store[i]>t&&delete e.store[i]}),e.expiry=null},t)),u),e},I=rt;var nt=(t,e)=>{let u=t["#"],n=t["."];var i=e[u];if(!i||!n)return;let c=i[n];if(c)return i={_:i._,[n]:c},i._[">"]={[n]:i._[">"][n]},{[u]:i}},z=nt;var it="",H=(t,e,u,n)=>t<e?{historical:!0}:t>e?{incoming:!0}:(typeof u!="string"&&(u=JSON.stringify(u)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),u===n?{state:!0}:u<n?{current:!0}:{incoming:!0});H.mix=(t,e,u)=>{var n=Date.now(),i={},c={};let f=0;return Object.keys(t).forEach(r=>{let s=t[r],d=!1;Object.keys(s).forEach(h=>{if(h==="_")return;let g=s[h],l=s._[">"][h],o=(e[r]||{})[h],a=(e[r]||{_:{">":{}}})._[">"][h]||0,p=l-n;if(p>0){if(p>864e5)return;(f===0||p<f)&&(f=p),c[r]||(c[r]={_:{"#":r,">":{}}}),c[r][h]=g,c[r]._[">"][h]=l}else H(l,a,g,o).incoming&&(i[r]||(i[r]={_:{"#":r,">":{}}}),e[r]||(e[r]={_:{"#":r,">":{}}}),e[r][h]=i[r][h]=g,e[r]._[">"][h]=i[r]._[">"][h]=l,setTimeout(()=>{let y=r+it+h;u[y]&&u[y].forEach(m=>m())},100),d=!0)}),d&&u[r]&&setTimeout(()=>{u[r].forEach(h=>h())},100)}),{now:i,defer:c,wait:f}};var A=H;var N="",M="",q=()=>{let t=(e,u,n)=>{if(n||(t[N]||(t[N]={}),n=t[N]),!e)return n;let i=0,c={},f=e[i],r=e.length-1,s=typeof u>"u",d=n[f];for(;!d&&i<r;)f+=e[++i],d=n[f];if(d)if(i===r){if(s)return typeof d[M]>"u"?d[N]:d[M];d[M]=u}else return!d[N]&&!s&&(d[N]={}),t(e.slice(++i),u,d[N]);else if(v.map(n,(g,l)=>{let o=0,a="";for(;l[o]===e[o];)a+=l[o++];if(a){if(s)return o<=r?void 0:(c[l.slice(o)]=g,g);let p={[l.slice(o)]:g,[e.slice(o)]:{[M]:u}};return n[a]={[N]:p},delete n[l],!0}})){if(s)return c}else{if(s)return;n[f]||(n[f]={}),n[f][M]=u}};return t};q.map=function t(e,u,n,i){i||(i=[]);var c=e[N]||e,f=Object.keys(c).sort(),r;for(let s=0;s<f.length;s++){let d=f[s],h=c[d],g=h[M];if(typeof g<"u"){if(g=u(g,i.join("")+d,d,i),typeof g<"u")return g}else n&&u(r,i.join(""),d,i);if(h[N]){if(i.push(d),g=t(h[N],u,n,i),typeof g<"u")return g;i.pop()}}};var C=q;var Q="",L="",k="",F=t=>{var e,u=null;if(t||(t={}),t.log||(t.log=console.log),t.batch||(t.batch=10*1e3),t.write||(t.write=1),t.size||(t.size=1024*1024),!t.store){t.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!t.store.get){t.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!t.store.put){t.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!t.store.list){t.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let n=(i,c,f)=>{if(i=""+i,typeof c=="function")return f=c,c=n.batch(i),typeof c<"u"||n.thrash.at&&(c=n.thrash.at(i),typeof c<"u")?f(e,c):n.read(i,f);if(n.batch(i,c),f&&n.batch.acks.push(f),++n.batch.ed>=t.batch)return n.thrash();clearTimeout(n.batch.timeout),n.batch.timeout=setTimeout(n.thrash,t.write)};return n.batch=C(),n.batch.acks=[],n.batch.ed=0,n.thrash=()=>{if(n.thrash.ing)return n.thrash.more=!0;clearTimeout(n.batch.timeout),n.thrash.more=!1,n.thrash.ing=!0;var i=n.thrash.at=n.batch;n.batch=null,n.batch=C(),n.batch.acks=[],n.batch.ed=0;let c=0;n.save(i,f=>{++c>1||(f&&t.log(f),i.acks.forEach(r=>r(f)),n.thrash.at=null,n.thrash.ing=!1,n.thrash.more&&n.thrash())})},n.save=(i,c)=>{let f={find:(r,s)=>{if(!(s<f.start))return f.start=s,t.store.list(f.lex),!0},lex:r=>{if(!r||r>f.start)return f.end=r,f.mix(f.file||"!",f.start,f.end),!0;f.file=r},mix:(r,s,d)=>{f.start=f.end=f.file=e,n.parse(r,(h,g)=>{if(h)return c(h);C.map(i,(l,o)=>{if(!(o<s)){if(d&&d<o)return f.start=o,f.start;g(o,l)}}),n.write(r,g,f.next)})},next:r=>{if(r)return c(r);if(f.start)return C.map(i,f.find);c(r)}};C.map(i,f.find)},n.write=(i,c,f)=>{u=null;let r={text:"",count:0,file:i,each:(s,d,h,g)=>{r.count++;var l=F.encode(g.length)+"#"+F.encode(h)+(typeof s>"u"?"":"="+F.encode(s))+`
`;if(r.count>1&&r.text.length+l.length>t.size)return r.text="",r.limit=Math.ceil(r.count/2),r.count=0,r.sub=C(),C.map(c,r.slice),!0;r.text+=l},put:()=>{t.store.put(i,r.text,f)},slice:(s,d)=>{if(!(d<r.file)){if(++r.count>r.limit){var h=r.file;let g=d.indexOf(L);return g===-1?r.file=d:r.file=d.substring(0,g),r.sub(r.file,null),r.count=0,n.write(h,r.sub,r.next),!0}r.sub(d,s)}},next:s=>{if(s)return f(s);r.sub=C(),C.map(c,r.slice)||n.write(r.file,r.sub,f)}};C.map(c,r.each,!0)||r.put()},n.read=(i,c)=>{if(u){let d=u(i);if(typeof d<"u")return c(e,d)}let f=i,r=i.indexOf(L);r!==-1&&(f=i.substring(0,r));let s={lex:d=>{if(!d){if(!s.file){c("no file found",e);return}n.parse(s.file,s.it);return}d>f||d<s.file||(s.file=d)},it:(d,h)=>{d&&t.log(d),h&&(u=h,s.value=h(i)),c(d,s.value)}};t.store.list(s.lex)},n.parse=(i,c)=>{let f={disk:C(),read:(r,s)=>{if(r)return c(r);if(!s)return c(e,f.disk);let d=[],h=f.split(s);for(;h;){let g,l,o=h[1];h=f.split(h[2])||"",h[0]==="#"&&(g=h[1],d=d.slice(0,o),o<=d.length&&d.push(g)),h=f.split(h[2])||"",h[0]!==`
`&&(h[0]==="="&&(l=h[1]),typeof g<"u"&&typeof l<"u"&&f.disk(d.join(""),l),h=f.split(h[2]))}c(e,f.disk)},split:r=>{if(!r)return;let s=-1,d="",h=null;for(;(h=r[++s])&&h!==k;)d+=h;let g={};if(h)return[d,F.decode(r.slice(s),g),r.slice(s+g.i)]}};t.store.get(i,f.read)},n};F.encode=t=>{let e="";if(t instanceof Array&&t.length===2&&(e=Q+t[1],t=t[0]),typeof t=="string"){let n=0,i=null,c=k;for(;i=t[n++];)i===k&&(c+=k);return c+'"'+t+e+k}let u=_.is(t);if(u)return k+"#"+u+e+k;if(B.is(t))return k+"+"+(t||0)+e+k;if(t===!0)return k+"+"+e+k;if(t===!1)return k+"-"+e+k;if(t===null)return k+" "+e+k};F.decode=(t,e)=>{var u="",n=-1,i=0,c=null,f=null;if(t[0]!==k)return;for(;c=t[++n];)if(f){if(c===k&&--i<=0)break;u+=c}else c===k?i++:f=c||!0;e&&(e.i=n+1);let[r,s]=u.split(Q);if(s){if(s=parseFloat(s),f==='"')return[r,s];if(f==="#")return[_.ify(r),s];if(f==="+")return r.length===0?[!0,s]:[parseFloat(r),s];if(f==="-")return[!1,s];if(f===" ")return[null,s]}else{if(f==='"')return u;if(f==="#")return _.ify(u);if(f==="+")return u.length===0?!0:parseFloat(u);if(f==="-")return!1;if(f===" ")return null}};var U=F;var Z=typeof document>"u",J=Z?await import("node:fs"):void 0,X="",P="",G=P+"+0"+P+"#"+P+'"root'+P,ot=t=>{let e=t.file;if(Z)return J.existsSync(e)||J.mkdirSync(e),J.existsSync(e+"/!")||J.writeFileSync(e+"/!",G),{get:(u,n)=>{J.readFile(e+"/"+u,(i,c)=>{if(i){if(i.code==="ENOENT"){n();return}console.log("fs.readFile error:",i)}c&&(c=c.toString()),n(i,c)})},put:(u,n,i)=>{var c=Math.random().toString(36).slice(-9),f=u+"."+c+".tmp";J.writeFile(f,n,r=>{if(r){i(r);return}J.rename(f,e+"/"+u,i)})},list:u=>{J.readdir(e,(n,i)=>{i.forEach(u),u()})}};if(t.indexedDB){let u,n=indexedDB.open(e,1);return n.onupgradeneeded=i=>{i.target.result.createObjectStore(e)},n.onerror=i=>{console.log(i)},n.onsuccess=()=>{if(u=n.result,u){let c=u.transaction([e],"readonly").objectStore(e).getKey("!");c.onerror=()=>{console.log(`error getting key ${e}/!`)},c.onsuccess=()=>{if(!c.result){let r=u.transaction([e],"readwrite").objectStore(e).put(G,"!");r.onerror=()=>{console.log(`error putting root on ${e}/!`)}}}}else console.log("error indexedDB not available")},{get:(i,c)=>{if(u){let r=u.transaction([e],"readonly").objectStore(e).get(i);r.onerror=()=>{console.log(`error getting ${e}/${i}`)},r.onsuccess=()=>{c(null,r.result)}}else c("error indexedDB not available")},put:(i,c,f)=>{if(u){let s=u.transaction([e],"readwrite").objectStore(e).put(c,i);s.onerror=()=>{console.log(`error putting data on ${e}/${i}`)},s.onsuccess=()=>{f(null)}}else f("error indexedDB not available")},list:i=>{if(u){let f=u.transaction([e],"readonly").objectStore(e).getAllKeys();f.onerror=()=>console.log("error getting keys for",e),f.onsuccess=()=>{f.result.forEach(i),i()}}else console.log("error indexedDB not available"),i()}}}return{get:(u,n)=>{n(null,G)},put:(u,n,i)=>{i(null)},list:u=>{u("!"),u()}}},st=t=>{v.is(t)||(t={}),t.file=String(t.file||"radata"),t.store||(t.store=ot(t));let e=U(t);return{get:(u,n)=>{if(!u){n("lex required");return}var i=u["#"],c=u["."]||"",f;let r=(s,d)=>{f||(f={_:{"#":i,">":{}}}),f[d]=s[0],f._[">"][d]=s[1]};e(i+X+c,(s,d)=>{let h;v.is(d)?(C.map(d,r),f||r(d,c),h={[i]:f}):d&&(r(d,c),h={[i]:f}),n(s,h)})},put:(u,n)=>{if(!u){n("graph required");return}var i=0;let c=f=>{if(i--,!c.err){if(c.err=f,c.err){n(c.err);return}i===0&&n(null)}};Object.keys(u).forEach(f=>{var r=u[f];Object.keys(r).forEach(s=>{if(s==="_")return;i++;let d=r[s],h=r._[">"][s];e(f+X+s,[d,h],c)})})}}},K=st;var V=typeof document>"u",ft=V?(await import("ws")).WebSocketServer:void 0,Y="",ut=t=>{v.is(t)||(t={});let e=I(t.maxAge),u=K(t),n={},i={},c={},f=(l,o)=>{let a=z(l.get,n);a?o(JSON.stringify({"#":e.track(b.random(9)),"@":l["#"],put:a})):u.get(l.get,(p,x)=>{o(JSON.stringify({"#":e.track(b.random(9)),"@":l["#"],put:x,err:p}))})},r=(l,o)=>{let a=A.mix(l.put,n,c);u.put(a.now,p=>{o(JSON.stringify({"#":e.track(b.random(9)),"@":l["#"],err:p}))}),a.wait!==0&&setTimeout(()=>r({put:a.defer},o),a.wait)},s=l=>({get:(o,a,p)=>{if(!a)return;v.is(p)||(p={});let x=z(o,n);if(x){a({put:x});return}u.get(o,(y,m)=>{if(m){a({put:m,err:y});return}y&&console.log(y);let w=b.random(9);i[w]=a,l(JSON.stringify({"#":e.track(w),get:o})),setTimeout(()=>{let j=i[w];if(j){let S=o["#"],$={[S]:null};o["."]&&($[S]={[o["."]]:null}),j({put:$}),delete i[w]}},p.wait||100)})},put:(o,a)=>{let p=A.mix(o,n,c);u.put(p.now,a),l(JSON.stringify({"#":e.track(b.random(9)),put:o}))},on:(o,a)=>{if(!a)return;let p=o["#"];p&&(o["."]&&(p+=Y+o["."]),c[p]?c[p].includes(a)||c[p].push(a):c[p]=[a])},off:(o,a)=>{let p=o["#"];p&&(o["."]&&(p+=Y+o["."]),c[p]&&(a?c[p].includes(a)&&c[p].splice(c[p].indexOf(a),1):delete c[p]))}});if(V){let l=t.wss,o=()=>l.clients();l||(l=new ft({port:8080}),o=()=>l.clients);let a=(p,x)=>{o().forEach(y=>{y.readyState===WebSocket.OPEN&&y.send(p,{binary:x})})};return l.on("connection",p=>{p.on("error",console.error),p.on("message",(x,y)=>{let m=JSON.parse(x);if(e.check(m["#"]))return;e.track(m["#"]),m.get&&f(m,a),m.put&&r(m,a),a(x,y);let w=m["@"],j=i[w];j&&(delete m["#"],delete m["@"],j(m),delete i[w])})}),s(a)}let d=new WebSocket("ws://localhost:8080"),h=l=>{if(!d||d.readyState!==WebSocket.OPEN){console.log("websocket not available");return}d.send(l)},g=()=>{d||(d=new WebSocket("ws://localhost:8080")),d.onclose=l=>{d=null,setTimeout(g,Math.floor(Math.random()*5e3))},d.onerror=l=>{console.error(l)},d.onmessage=l=>{let o=JSON.parse(l.data);if(e.check(o["#"]))return;e.track(o["#"]),o.get&&f(o,h),o.put&&r(o,h),h(l.data);let a=o["@"],p=i[a];p&&(delete o["#"],delete o["@"],p(o),delete i[a])}};return g(),s(h)},tt=ut;var lt=t=>{let e=tt(t),u=new Map,n=new Map,i=s=>s===null||s===!0||s===!1||typeof s=="string"||_.is(s)||B.is(s),c=s=>{if(i(s))return!0;if(v.is(s)){let d=[];for(let[h,g]of Object.entries(s)){if(h==="_")return"error underscore cannot be used as an item name";if(v.is(g)||i(g)){d.push(h);continue}return`error {${h}:${g}} cannot be converted to graph`}if(d.length!==0)return d}return`error ${s} cannot be converted to a graph`},f=(s,d,h)=>{h?h[s]={_:{"#":s,">":{}}}:h={[s]:{_:{"#":s,">":{}}}};for(let[g,l]of Object.entries(d))h[s][g]=l,h[s]._[">"][g]=Date.now();return h},r=s=>{let d=(l,o,a)=>{e.get(v.put(l,"#",o),async p=>{if(p.err&&console.log(p.err),p.put&&p.put[o]){delete p.put[o]._;for(let x of Object.keys(p.put[o])){let y=_.is(p.put[o][x]);if(y){let m=await new Promise(w=>{let j=b.random();n.set(j,{chain:[{item:null,soul:y}]}),r(j).next(null,w)});p.put[o][x]=m}}a(p.put[o])}else a(null)})},h=l=>{let o=n.get(s);o&&typeof o.cb<"u"?o.cb(l):l&&console.log(l),o.on||n.delete(s)},g=(l,o)=>{let a=l&&typeof l.get<"u",p=l&&typeof l.put<"u",x=l&&typeof l.on<"u",y=l&&typeof l.off<"u",m=!1,w=n.get(s);for(var j=1;j<w.chain.length;j++)if(w.chain[j].soul===null){m=!0;break}if(m){let{item:S,soul:$}=w.chain[j-1];return e.get({"#":$,".":S},T=>{if(T.err){console.log(`error getting ${S} on ${$}: ${T.err}`),o&&o(null);return}let O=T.put&&T.put[$];if(O&&typeof O[S]<"u"){let E=_.is(O[S]);if(E)w.chain[j].soul=E,n.set(s,{chain:w.chain,cb:w.cb}),a?r(s).next(null,l.get,o):p?r(s).put(l.put,o):x?r(s).on(o):y&&r(s).off(o);else if(a)o(O[S]);else if(p){E=b.random();let D={[S]:_.ify(E)};e.put(f($,D),R=>{if(R){o(`error putting ${S} on ${$}: ${R}`);return}w.chain[j].soul=E,r(s).put(l.put,o)})}else x?(console.log(`error resolving on for ${S} on ${$}`),o(null)):y&&(console.log(`error resolving off for ${S} on ${$}`),o&&o(null))}else p?o(`error ${S} not found on ${$}`):(console.log(`error ${S} not found on ${$}`),o&&o(null))}),!1}return a&&w.chain[w.chain.length-1].item!==null?(w.chain.push({item:null,soul:null}),r(s).next(null,l.get,o),!1):w.chain[w.chain.length-1]};return{get:(l,o,a)=>{if(typeof o=="function"&&(a=o,o=null),l===null||l===""||l==="_"){a&&a(null);return}if(s=b.random(),n.set(s,{chain:[{item:l,soul:"root"}],cb:a}),!a)return r(s);let{soul:p}=g({get:o},h);p&&d(o,p,h)},next:(l,o,a)=>{let p=m=>{a?a(m):h(m)};if(typeof o=="function"&&(a=o,o=null),!s){console.log("please provide a key using get(key)"),p(null);return}let x=n.get(s);if(!x)return;if(a&&typeof x.cb>"u"&&(x.cb=a,a=null),l===""||l==="_"){p(null);return}if(l!==null&&x.chain.push({item:l,soul:null}),!x.cb)return r(s);let{soul:y}=g({get:o},p);y&&d(o,y,p)},put:(l,o)=>{let a=w=>{o?o(w):h(w)};if(!s){a("please provide a key using get(key)");return}let p=n.get(s);if(!p)return;if(!p.cb){if(!o)return;p.cb=o,o=null}let x=c(l);if(typeof x=="string"){a(x);return}let{item:y,soul:m}=g({put:l},a);if(m){if(x===!0){e.get({"#":m,".":y},async w=>{if(w.err){console.log(`error getting ${m}: ${w.err}`);return}let j=w.put&&w.put[m]&&w.put[m][y],S=_.is(j);if(!S){e.put(f(m,{[y]:l}),a);return}e.get({"#":S},async $=>{if($.err){console.log(`error getting ${S}: ${$.err}`);return}if(!$.put||!$.put[S]){console.log(`error ${S} not found`);return}delete $.put[S]._;for(let T of Object.keys($.put[S])){let O=await new Promise(E=>{let D=b.random();n.set(D,{chain:[{item:T,soul:S}]}),r(D).put(null,E)});if(O){a(O);return}}e.put(f(m,{[y]:l}),a)})});return}e.get({"#":m,".":y},async w=>{if(w.err){a(`error getting ${m}: ${w.err}`);return}let j=w.put&&w.put[m]&&w.put[m][y],S=_.is(j);if(!S){let O={[y]:_.ify(b.random())};e.put(f(m,O),E=>{if(E)a(`error putting ${y} on ${m}: ${E}`);else{let D=b.random(),R=[{item:y,soul:m}];n.set(D,{chain:R,cb:p.cb}),r(D).put(l)}});return}let $=!1,T={};for(let O of x){let E=await new Promise(D=>{if(v.is(l[O])){let R=b.random();n.set(R,{chain:[{item:O,soul:S}]}),r(R).put(l[O],D)}else $=!0,T[O]=l[O],D(null)});if(E){a(E);return}}$?e.put(f(S,T),a):a()})}},on:l=>{if(!l)return;if(!s){console.log("please provide a key using get(key)"),l(null);return}let{item:o,soul:a}=g({on:!0},l);a&&(n.set(s,{chain:[{item:o,soul:a}],on:!0}),u.set(l,()=>r(s).next(null,l)),e.get({"#":a,".":o},async p=>{if(p.err){console.log(`error getting ${a}: ${p.err}`);return}let x=p.put&&p.put[a]&&p.put[a][o],y=_.is(x);y?e.on({"#":y},u.get(l)):e.on({"#":a,".":o},u.get(l))}))},off:l=>{if(!s){console.log("please provide a key using get(key)"),l&&l(null);return}let{item:o,soul:a}=g({off:!0},l);a&&e.get({"#":a,".":o},async p=>{if(p.err){console.log(`error getting ${a}: ${p.err}`);return}let x=p.put&&p.put[a]&&p.put[a][o],y=_.is(x);y?e.off({"#":y},u.get(l)):e.off({"#":a,".":o},u.get(l)),u.delete(l),n.delete(s)})},wire:e}};return r()},Ot=lt;export{Ot as default};
//# sourceMappingURL=holster.js.map
