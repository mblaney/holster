var Z={is:e=>!(e instanceof Array)&&(e-parseFloat(e)+1>=0||e===1/0||e===-1/0)},O={is:e=>e?e instanceof Object&&e.constructor===Object||Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/)[1]==="Object":!1,map:(e,t,i)=>{var r=Object.keys(e);for(let n=0;n<r.length;n++){let u=t(e[r[n]],r[n],i);if(typeof u<"u")return u}},put:(e,t,i)=>(e||(e={}),e[t]=i,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},ke=(e,t,i)=>{if(i.id){i.id=!1;return}if(t==="#"&&typeof e=="string"){i.id=e;return}i.id=!1},T={is:e=>{if(e&&e["#"]&&!e._&&O.is(e)){let t={};if(O.map(e,ke,t),t.id)return t.id}return!1},ify:e=>O.put({},"#",e)},M="_holster_user_public_key",F=(e,t,i,r)=>{let n={[e]:{_:{"#":e,">":{},s:i,p:r}}};for(let[u,f]of Object.entries(t))n[e][u]=f,n[e]._[">"][u]=Date.now();return r&&(n[e][M]=r,n[e]._[">"][M]=Date.now()),n},q=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!O.is(e)||!t)return!1;let i=e["*"];if(i)return t.slice(0,i.length)===i;let r=e[">"],n=e["<"];return r&&n?t>=r&&t<=n:r?t>=r:n?t<=n:!1},E={random:e=>{var t="";let i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let r=0;r<e;r++)t+=i.charAt(Math.floor(Math.random()*i.length));return t}};var je=e=>{e||(e=9e3);let t={store:{}};return t.check=i=>t.store[i]?t.track(i):!1,t.track=i=>(t.store[i]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{let r=Date.now();Object.keys(t.store).forEach(n=>{r-t.store[n]>e&&delete t.store[n]}),t.expiry=null},e)),i),t},fe=je;var xe=(e,t)=>{let i=e["#"],r=typeof e["."]=="string"?e["."]:!1;var n=t[i];if(!n||!r)return;let u=n[r];if(u)return n={_:n._,[r]:u},n._[">"]={[r]:n._[">"][r]},{[i]:n}},ie=xe;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function Y(){}Object.assign(Y,{from:Array.from});Y.prototype=Object.create(Array.prototype);Y.prototype.toString=function(e,t,i){e||(e="utf8"),t||(t=0);let r=this.length;if(e==="hex"){let n=new Uint8Array(this);return[...Array((i&&i+1||r)-t).keys()].map(u=>n[u+t].toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:(i||r)-t},(n,u)=>String.fromCharCode(this[u+t])).join("");if(e==="base64")return btoa(this)};var H=Y;function G(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),G.from(...e)}G.prototype=Object.create(Array.prototype);Object.assign(G,{from(){if(!Object.keys(arguments).length||arguments[0]==null)throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.");let e=arguments[0],t;if(typeof e=="string"){let r=arguments[1]||"utf8";if(r==="hex"){let n=e.match(/([\da-fA-F]{2})/g).map(u=>parseInt(u,16));if(!n||!n.length)throw new TypeError("Invalid first argument for type 'hex'.");t=H.from(n)}else if(r==="utf8"||r==="binary"){let n=e.length,u=new Uint16Array(n);Array.from({length:n},(f,c)=>u[c]=e.charCodeAt(c)),t=H.from(u)}else if(r==="base64"){let n=atob(e),u=n.length,f=new Uint8Array(u);Array.from({length:u},(c,s)=>f[s]=n.charCodeAt(s)),t=H.from(f)}else console.info("SafeBuffer.from unknown encoding: "+r);return t}if(e.byteLength?e.byteLength:e.length){let r;return e instanceof ArrayBuffer&&(r=new Uint8Array(e)),H.from(r||e)}},alloc(e,t=0){return H.from(new Uint8Array(Array.from({length:e},()=>t)))},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be Array containing ArrayBuffer or Uint8Array instances.");return H.from(e.reduce((t,i)=>t.concat(Array.from(i)),[]))}});G.prototype.from=G.from;G.prototype.toString=H.prototype.toString;var D=G;var $e=typeof document>"u",ae=$e?(await import("node:crypto")).webcrypto:globalThis.crypto,_=ae.subtle,V=e=>typeof e=="string"?e:JSON.stringify(e),Q=e=>{try{return JSON.parse(e)}catch{return e}},ee=e=>{let t=new Uint8Array(D.alloc(e));return D.from(ae.getRandomValues(t))},X=(e,t)=>{let[i,r]=e.split(".");return{kty:"EC",crv:"P-256",x:i,y:r,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},te=async e=>{let t=await _.digest({name:"SHA-256"},new TextEncoder().encode(V(e)));return D.from(t)},oe=async(e,t)=>{let i=e+t.toString("utf8"),r=D.from(await te(i),"binary"),n=_e(r);return await _.importKey("jwk",n,{name:"AES-GCM"},!1,["encrypt","decrypt"])},_e=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var Oe={pair:async e=>{let t=await _.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async n=>{let u=await _.exportKey("jwk",n.publicKey);return{priv:(await _.exportKey("jwk",n.privateKey)).d,pub:u.x+"."+u.y}}),i=await _.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async n=>{let u=await _.exportKey("jwk",n.publicKey);return{epriv:(await _.exportKey("jwk",n.privateKey)).d,epub:u.x+"."+u.y}}),r={pub:t.pub,priv:t.priv,epub:i.epub,epriv:i.epriv};return e&&e(r),r},encrypt:async(e,t,i)=>{if(!t||!t.epriv)return i&&i(null),null;let r={s:ee(9),iv:ee(15)},n=await oe(t.epriv,r.s).then(f=>_.encrypt({name:"AES-GCM",iv:new Uint8Array(r.iv)},f,new TextEncoder().encode(V(e)))),u={ct:D.from(n,"binary").toString("base64"),iv:r.iv.toString("base64"),s:r.s.toString("base64")};return i&&i(u),u},decrypt:async(e,t,i)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return i&&i(null),null;let r={ct:D.from(e.ct,"base64"),iv:D.from(e.iv,"base64"),s:D.from(e.s,"base64")};try{let n=await oe(t.epriv,r.s).then(f=>_.decrypt({name:"AES-GCM",iv:new Uint8Array(r.iv),tagLength:128},f,new Uint8Array(r.ct))),u=Q(new TextDecoder("utf8").decode(n));return i&&i(u),u}catch{return i&&i(null),null}},verify:async(e,t,i)=>{if(!t||!t.pub)return i&&i(null),null;let r=Q(e),n=await _.importKey("jwk",X(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),u={};if(typeof r.m=="string")u=r.m;else for(let o of Object.keys(r.m))o!=="_"&&o!=M&&(u[o]=r.m[o]);let f=await te(u),c=new Uint8Array(D.from(r.s,"base64")),s={name:"ECDSA",hash:{name:"SHA-256"}};if(await _.verify(s,n,c,new Uint8Array(f))){let o=Q(r.m);return i&&i(o),o}return i&&i(null),null},sign:async(e,t,i)=>{if(!t||!t.pub||!t.priv)return i&&i(null),null;let r=Q(e),n=await te(r),u=X(t.pub,t.priv),f={name:"ECDSA",namedCurve:"P-256"},c=await _.importKey("jwk",u,f,!1,["sign"]).then(o=>_.sign({name:"ECDSA",hash:{name:"SHA-256"}},o,new Uint8Array(n))),s={m:r,s:D.from(c,"binary").toString("base64")};return i&&i(s),s},work:async(e,t,i)=>{typeof t=="function"&&(i=t,t=void 0),typeof t>"u"&&(t=ee(9));let r=await _.importKey("raw",new TextEncoder().encode(V(e)),{name:"PBKDF2"},!1,["deriveBits"]),n={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},u=await _.deriveBits(n,r,512),f={epriv:D.from(u,"binary").toString("base64")};return i&&i(f),f},secret:async(e,t,i)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return i&&i(null),null;let r={name:"ECDH",namedCurve:"P-256"},n=X(e.epub),u=await _.importKey("jwk",n,r,!0,[]),f=X(t.epub,t.epriv,!1);delete f.key_ops;let c=await _.importKey("jwk",f,r,!1,["deriveBits"]).then(async s=>{let o=await _.deriveBits({public:u,name:"ECDH",namedCurve:"P-256"},s,256),y=await _.importKey("raw",new Uint8Array(o),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return _.exportKey("jwk",y).then(({k:h})=>h)});return i&&i({epriv:c}),{epriv:c}}},K=Oe;var se=(e,t,i,r)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof i!="string"&&(i=JSON.stringify(i)||""),typeof r!="string"&&(r=JSON.stringify(r)||""),i===r?{state:!0}:i<r?{current:!0}:{incoming:!0});se.mix=async(e,t,i,r)=>{var n=Date.now(),u={},f={};let c=0;for(let s of Object.keys(e)){let o=e[s],y=!1,h=!1,w=0,d="",a=i;if(!(!o||!o._)){if(o._.s&&o._.p&&(a=!0),s.length>1&&s[0]==="~")if(s[1]==="@")h=!0,a=!1;else{if(o._.p&&s!="~"+o._.p){console.log(`error public key does not match for soul: ${s}`);continue}o._.p=s.slice(1),a=!0}if(a){if(!o._.s||!o._.p){console.log("error signature and public key required to verify data");continue}if(!await K.verify({m:o,s:o._.s},{pub:o._.p})){console.log(`error could not verify soul: ${s}`);continue}}for(let l of Object.keys(o)){if(l==="_")continue;let p=o[l],g=o._[">"][l],m=(t[s]||{})[l],b=(t[s]||{_:{">":{}}})._[">"][l]||0;if(h&&l!==T.is(p))continue;let S=g-n;if(S>0){if(S>864e5)continue;(c===0||S<c)&&(c=w=S),f[s]||(f[s]={_:{"#":s,">":{},s:o._.s,p:o._.p}}),f[s][l]=p,f[s]._[">"][l]=g}else se(g,b,p,m).incoming&&(u[s]||(u[s]={_:{"#":s,">":{},s:o._.s,p:o._.p}}),t[s]||(t[s]={_:{"#":s,">":{},s:o._.s,p:o._.p}}),t[s][l]=u[s][l]=p,t[s]._[">"][l]=u[s]._[">"][l]=g,r[s]&&setTimeout(()=>{r[s]&&r[s].filter(k=>q(k["."],l)).forEach(k=>k.cb())},100),y=!0)}a&&w!==0&&u[s]&&(Object.assign(f[s],u[s]),delete u[s]),y&&r[s]&&setTimeout(()=>{r[s]&&r[s].filter(l=>q(l["."])).forEach(l=>l.cb())},100)}}return{now:u,defer:f,wait:c}};var ue=se;var J="",L="",ce=()=>{let e=(t,i,r)=>{if(r||(e[J]||(e[J]={}),r=e[J]),!t)return r;let n=0,u={},f=t[n],c=t.length-1,s=typeof i>"u",o=r[f];for(;!o&&n<c;)f+=t[++n],o=r[f];if(o)if(n===c){if(s)return typeof o[L]>"u"?o[J]:o[L];o[L]=i}else return!o[J]&&!s&&(o[J]={}),e(t.slice(++n),i,o[J]);else if(O.map(r,(h,w)=>{let d=0,a="";for(;w[d]===t[d];)a+=w[d++];if(a){if(s)return d<=c?void 0:(u[w.slice(d)]=h,h);let l={[w.slice(d)]:h,[t.slice(d)]:{[L]:i}};return r[a]={[J]:l},delete r[w],!0}})){if(s)return u}else{if(s)return;r[f]||(r[f]={}),r[f][L]=i}};return e};ce.map=function e(t,i,r,n){n||(n=[]);var u=t[J]||t,f=Object.keys(u).sort(),c;for(let s=0;s<f.length;s++){let o=f[s],y=u[o],h=y[L];if(typeof h<"u"){if(h=i(h,n.join("")+o,o,n),typeof h<"u")return h}else r&&i(c,n.join(""),o,n);if(y[J]){if(n.push(o),h=e(y[J],i,r,n),typeof h<"u")return h;n.pop()}}};var P=ce;var ge="",pe="",C="",z=e=>{var t,i=null;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=10*1e3),e.write||(e.write=1),e.size||(e.size=1024*1024),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let r=(n,u,f)=>{if(n=""+n,typeof u=="function")return f=u,u=r.batch(n),typeof u<"u"||r.thrash.at&&(u=r.thrash.at(n),typeof u<"u")?f(t,u):r.read(n,f);if(r.batch(n,u),f&&r.batch.acks.push(f),++r.batch.ed>=e.batch)return r.thrash();clearTimeout(r.batch.timeout),r.batch.timeout=setTimeout(r.thrash,e.write)};return r.batch=P(),r.batch.acks=[],r.batch.ed=0,r.thrash=()=>{if(r.thrash.ing)return r.thrash.more=!0;clearTimeout(r.batch.timeout),r.thrash.more=!1,r.thrash.ing=!0;var n=r.thrash.at=r.batch;r.batch=null,r.batch=P(),r.batch.acks=[],r.batch.ed=0;let u=0;r.save(n,f=>{++u>1||(f&&e.log(f),n.acks.forEach(c=>c(f)),r.thrash.at=null,r.thrash.ing=!1,r.thrash.more&&r.thrash())})},r.save=(n,u)=>{let f={find:(c,s)=>{if(!(s<f.start))return f.start=s,e.store.list(f.lex),!0},lex:c=>{if(!c||c>f.start)return f.end=c,f.mix(f.file||"!",f.start,f.end),!0;f.file=c},mix:(c,s,o)=>{f.start=f.end=f.file=t,r.parse(c,(y,h)=>{if(y)return u(y);P.map(n,(w,d)=>{if(!(d<s)){if(o&&o<d)return f.start=d,f.start;h(d,w)}}),r.write(c,h,f.next)})},next:c=>{if(c)return u(c);if(f.start)return P.map(n,f.find);u(c)}};P.map(n,f.find)},r.write=(n,u,f)=>{i=null;let c={text:"",count:0,file:n,each:(s,o,y,h)=>{c.count++;var w=z.encode(h.length)+"#"+z.encode(y)+(typeof s>"u"?"":"="+z.encode(s))+`
`;if(c.count>1&&c.text.length+w.length>e.size)return c.text="",c.limit=Math.ceil(c.count/2),c.count=0,c.sub=P(),P.map(u,c.slice),!0;c.text+=w},put:()=>{e.store.put(n,c.text,f)},slice:(s,o)=>{if(!(o<c.file)){if(++c.count>c.limit){var y=c.file;let h=o.indexOf(pe);return h===-1?c.file=o:c.file=o.substring(0,h),c.sub(c.file,null),c.count=0,r.write(y,c.sub,c.next),!0}c.sub(o,s)}},next:s=>{if(s)return f(s);c.sub=P(),P.map(u,c.slice)||r.write(c.file,c.sub,f)}};P.map(u,c.each,!0)||c.put()},r.read=(n,u)=>{if(i){let o=i(n);if(typeof o<"u")return u(t,o)}let f=n,c=n.indexOf(pe);c!==-1&&(f=n.substring(0,c));let s={lex:o=>{if(!o){if(!s.file){u("no file found",t);return}r.parse(s.file,s.it);return}o>f||o<s.file||(s.file=o)},it:(o,y)=>{o&&e.log(o),y&&(i=y,s.value=y(n)),u(o,s.value)}};e.store.list(s.lex)},r.parse=(n,u)=>{let f={disk:P(),read:(c,s)=>{if(c)return u(c);if(!s)return u(t,f.disk);let o=[],y=f.split(s);for(;y;){let h,w,d=y[1];y=f.split(y[2])||"",y[0]==="#"&&(h=y[1],o=o.slice(0,d),d<=o.length&&o.push(h)),y=f.split(y[2])||"",y[0]!==`
`&&(y[0]==="="&&(w=y[1]),typeof h<"u"&&typeof w<"u"&&f.disk(o.join(""),w),y=f.split(y[2]))}u(t,f.disk)},split:c=>{if(!c)return;let s=-1,o="",y=null;for(;(y=c[++s])&&y!==C;)o+=y;let h={};if(y)return[o,z.decode(c.slice(s),h),c.slice(s+h.i)]}};e.store.get(n,f.read)},r};z.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=ge+e[1],e=e[0]),typeof e=="string"){let r=0,n=null,u=C;for(;n=e[r++];)n===C&&(u+=C);return u+'"'+e+t+C}let i=T.is(e);if(i)return C+"#"+i+t+C;if(Z.is(e))return C+"+"+(e||0)+t+C;if(e===!0)return C+"+"+t+C;if(e===!1)return C+"-"+t+C;if(e===null)return C+" "+t+C};z.decode=(e,t)=>{var i="",r=-1,n=0,u=null,f=null;if(e[0]!==C)return;for(;u=e[++r];)if(f){if(u===C&&--n<=0)break;i+=u}else u===C?n++:f=u||!0;t&&(t.i=r+1);let[c,s]=i.split(ge);if(s){if(s=parseFloat(s),f==='"')return[c,s];if(f==="#")return[T.ify(c),s];if(f==="+")return c.length===0?[!0,s]:[parseFloat(c),s];if(f==="-")return[!1,s];if(f===" ")return[null,s]}else{if(f==='"')return i;if(f==="#")return T.ify(i);if(f==="+")return i.length===0?!0:parseFloat(i);if(f==="-")return!1;if(f===" ")return null}};var de=z;var he=typeof document>"u",I=he?await import("node:fs"):void 0,ye="",re="",le=re+"+0"+re+"#"+re+'"root'+re,Ee=e=>{let t=e.file;if(he)return I.existsSync(t)||I.mkdirSync(t),I.existsSync(t+"/!")||I.writeFileSync(t+"/!",le),{get:(i,r)=>{I.readFile(t+"/"+i,(n,u)=>{if(n){if(n.code==="ENOENT"){r();return}console.log("fs.readFile error:",n)}u&&(u=u.toString()),r(n,u)})},put:(i,r,n)=>{var u=Math.random().toString(36).slice(-9),f=i+"."+u+".tmp";I.writeFile(f,r,c=>{if(c){n(c);return}I.rename(f,t+"/"+i,n)})},list:i=>{I.readdir(t,(r,n)=>{n.forEach(i),i()})}};if(e.indexedDB){let i,r=indexedDB.open(t,1);return r.onupgradeneeded=n=>{n.target.result.createObjectStore(t)},r.onerror=n=>{console.log(n)},r.onsuccess=()=>{if(i=r.result,i){let u=i.transaction([t],"readonly").objectStore(t).getKey("!");u.onerror=()=>{console.log(`error getting key ${t}/!`)},u.onsuccess=()=>{if(!u.result){let c=i.transaction([t],"readwrite").objectStore(t).put(le,"!");c.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(n,u)=>{if(i){let c=i.transaction([t],"readonly").objectStore(t).get(n);c.onerror=()=>{console.log(`error getting ${t}/${n}`)},c.onsuccess=()=>{u(null,c.result)}}else u("error indexedDB not available")},put:(n,u,f)=>{if(i){let s=i.transaction([t],"readwrite").objectStore(t).put(u,n);s.onerror=()=>{console.log(`error putting data on ${t}/${n}`)},s.onsuccess=()=>{f(null)}}else f("error indexedDB not available")},list:n=>{if(i){let f=i.transaction([t],"readonly").objectStore(t).getAllKeys();f.onerror=()=>console.log("error getting keys for",t),f.onsuccess=()=>{f.result.forEach(n),n()}}else console.log("error indexedDB not available"),n()}}}return{get:(i,r)=>{r(null,le)},put:(i,r,n)=>{n(null)},list:i=>{i("!"),i()}}},Ce=e=>{O.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Ee(e));let t=de(e);return{get:(i,r)=>{if(!i){r("lex required");return}var n=i["#"],u=typeof i["."]=="string"?i["."]:"",f;let c=(s,o)=>{q(i["."],o)&&(f||(f={_:{"#":n,">":{}}}),f[o]=s[0],f._[">"][o]=s[1])};t(n+ye+u,(s,o)=>{let y;O.is(o)?(P.map(o,c),f||c(o,u),y={[n]:f}):o&&(c(o,u),y={[n]:f}),r(s,y)})},put:(i,r)=>{if(!i){r("graph required");return}var n=0;let u=f=>{if(n--,!u.err){if(u.err=f,u.err){r(u.err);return}n===0&&r(null)}};Object.keys(i).forEach(f=>{var c=i[f];Object.keys(c).forEach(s=>{if(s==="_")return;n++;let o=c[s],y=c._[">"][s];t(f+ye+s,[o,y],u)})})}}},me=Ce;var we=typeof document>"u",be=we?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=be?.WebSocket);var Te=e=>{let t=fe(e.maxAge),i=me(e),r={},n={},u={},f=async(d,a,l)=>{for(let p of Object.keys(d)){let g=await new Promise(v=>{o({"#":p},v,a)});if(g.err)return l&&l(g.err),!1;let m=d[p],b=m._?m._.p:void 0,S=M;if(!(!g.put||!g.put[p]||g.put[p][S]===b))return l&&l(`error in wire check public key does not match for soul: ${p}`),!1}return!0},c=(d,a)=>{let l=ie(d.get,r);l?a(JSON.stringify({"#":t.track(E.random(9)),"@":d["#"],put:l})):i.get(d.get,(p,g)=>{a(JSON.stringify({"#":t.track(E.random(9)),"@":d["#"],put:g,err:p}))})},s=async(d,a)=>{let l=await ue.mix(d.put,r,e.secure,u);if(Object.keys(l.now).length){if(!await f(l.now,a))return;i.put(l.now,p=>{a(JSON.stringify({"#":t.track(E.random(9)),"@":d["#"],err:p}))})}Object.keys(l.defer).length&&setTimeout(()=>s({put:l.defer},a),l.wait)},o=(d,a,l,p)=>{if(!a)return;O.is(p)||(p={});let g=ie(d,r);if(g){a({put:g});return}i.get(d,(m,b)=>{if(b){a({put:b,err:m});return}m&&console.log(m);let S=E.random(9);n[S]=a,l(JSON.stringify({"#":t.track(S),get:d})),setTimeout(()=>{let v=n[S];if(v){let k=d["#"],x={[k]:null};typeof d["."]=="string"&&(x[k]={[d["."]]:null}),v({put:x}),delete n[S]}},p.wait||100)})},y=d=>({get:(a,l,p)=>{o(a,l,d,p)},put:async(a,l)=>{let p=await ue.mix(a,r,e.secure,u);Object.keys(p.now).length===0||!await f(p.now,d,l)||(i.put(p.now,l),d(JSON.stringify({"#":t.track(E.random(9)),put:a})))},on:(a,l)=>{let p=a&&a["#"];!p||!l||(u[p]?u[p].push({".":a["."],cb:l}):u[p]=[{".":a["."],cb:l}])},off:(a,l)=>{let p=a&&a["#"];if(!(!p||!u[p]))if(l){let g=u[p].find(m=>m.cb===l);g&&u[p].splice(u[p].indexOf(g),1)}else delete u[p]}});if(we){let d=e.wss,a=()=>d.clients();if(!d){let p=e.server?{server:e.server}:{port:e.port||8765};d=new be.WebSocketServer(p),a=()=>d.clients}let l=(p,g)=>{a().forEach(m=>{m.readyState===WebSocket.OPEN&&m.send(p,{binary:g})})};return d.on("connection",p=>{p.on("error",console.error),p.on("message",(g,m)=>{let b=JSON.parse(g);if(t.check(b["#"]))return;t.track(b["#"]),b.get&&c(b,l),b.put&&s(b,l),l(g,m);let S=b["@"],v=n[S];v&&(delete b["#"],delete b["@"],v(b),delete n[S])})}),y(l)}let h=[],w=d=>{h.forEach(a=>{a&&a.readyState===WebSocket.OPEN?a.send(d):console.log("websocket not available")})};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(d=>{let a=new WebSocket(d);h.push(a);let l=()=>{a||(a=new WebSocket(d)),a.onclose=p=>{h.indexOf(a)!==-1&&h.splice(h.indexOf(a),1),a=null,setTimeout(l,Math.floor(Math.random()*5e3))},a.onerror=p=>{console.error(p)},a.onmessage=p=>{let g=JSON.parse(p.data);if(t.check(g["#"]))return;t.track(g["#"]),g.get&&c(g,w),g.put&&s(g,w),w(p.data);let m=g["@"],b=n[m];b&&(delete g["#"],delete g["@"],b(g),delete n[m])}};l()}),y(w)},ne=Te;var Ke=(e,t)=>{t||(t=ne(e));let i=[],r=!1,n=!1,u=0,f=(s,o,y,h)=>{let w=p=>{u++,f(p,o,y,h)},d=p=>{i=[],u=0,n=!1,h(p)},a=()=>{if(i.length===0){d("Wrong username or password");return}let p=i.shift();t.get({"#":p},async g=>{if(g.err){d(`error getting ${p}: ${g.err}`);return}let m=g.put&&g.put[p];if(!m||!m.auth)return a();let b=JSON.parse(m.auth),S=await K.work(o,b.salt),v=await K.decrypt(b.enc,S);if(!v)return a();if(c.is={username:s,pub:m.pub,epub:m.epub,priv:v.priv,epriv:v.epriv},c.ctx="~"+m.pub,y!==""){let k=E.random(64),x=await K.work(y,k),j=await K.encrypt(v,x),$={auth:JSON.stringify({enc:j,salt:k})},B=await K.sign($,c.is),A=F(p,B.m,B.s,m.pub);t.put(A,N=>{d(N?`error putting ${$} on ${p}: ${N}`:null)});return}return d(null)})};if(u>9){d("Wrong username or password");return}let l="~@"+s;t.get({"#":l},async p=>{if(p.err){d(`error getting ${l}: ${p.err}`);return}let g=p.put&&p.put[l];if(!g)return w(s);delete p.put[l]._,i=Object.keys(g),a()})},c={create:(s,o,y)=>{let h=d=>{y?y(d):console.log(d)};if(r){h("User is already being created");return}if(s===""){h("Please provide a username");return}if(o===""){h("Please provide a password");return}r=!0;let w="~@"+s;t.get({"#":w},async d=>{if(d.err){r=!1,h(`error getting ${w}: ${d.err}`);return}if(d.put&&d.put[w]){r=!1,h("Username already exists");return}let a=E.random(64),l=await K.work(o,a),p=await K.pair(),g={priv:p.priv,epriv:p.epriv},m=await K.encrypt(g,l),b={username:s,pub:p.pub,epub:p.epub,auth:JSON.stringify({enc:m,salt:a})},S="~"+p.pub,v=await K.sign(b,p),k=F(S,v.m,v.s,p.pub);t.put(k,x=>{if(r=!1,x){h(`error putting ${b} on ${S}: ${x}`);return}let j={[S]:{"#":S}};t.put(F(w,j),$=>{if($){h(`error putting ${j} on ${w}: ${$}`);return}y&&y(null)})})})},auth:(s,o,y)=>{let h=w=>{y?y(w):w&&console.log(w)};if(n){h("User is already authenticating");return}if(c.is=null,s===""){h("Please provide a username");return}if(o===""){h("Please provide a password");return}n=!0,f(s,o,"",h)},change:(s,o,y,h)=>{let w=d=>{h?h(d):d&&console.log(d)};if(n){w("User is already authenticating");return}if(c.is=null,s===""){w("Please provide a username");return}if(o===""){w("Please provide a password");return}if(y===""){w("Please provide a new password");return}n=!0,f(s,o,y,w)},store:s=>{if(!c.is){console.log("Please authenticate before calling store");return}if(s){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(c.is));return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(c.is))},recall:s=>{if(s){if(typeof globalThis.localStorage<"u"){let o=globalThis.localStorage.getItem("user.is");o?(c.is=JSON.parse(o),c.ctx="~"+c.is.pub):console.log("User credentials not stored in local storage")}return}if(typeof globalThis.sessionStorage<"u"){let o=globalThis.sessionStorage.getItem("user.is");o?(c.is=JSON.parse(o),c.ctx="~"+c.is.pub):console.log("User credentials not stored in session storage")}},leave:()=>{c.is=null,c.ctx=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(s,o,y)=>{let h=w=>{y?y(w):console.log(w)};if(n){h("User is already authenticating");return}if(s===""){h("Please provide a username");return}if(o===""){h("Please provide a password");return}n=!0,f(s,o,"",async w=>{if(w){h(w);return}let d={username:null,pub:null,epub:null,auth:null},a=await K.sign(d,c.is),l="~"+c.is.pub,p=F(l,a.m,a.s,c.is.pub);t.put(p,g=>{if(g){h(`error putting null on ${l}: ${g}`);return}c.is=null,c.ctx=null,y&&y(null)})})}};return c},ve=Ke;var Pe=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:O.is(e)||(e={});let t=ne(e),i=ve(null,t),r=new Map,n=new Map,u,f=o=>o===null||o===!0||o===!1||typeof o=="string"||T.is(o)||Z.is(o),c=o=>{if(f(o))return!0;if(O.is(o)){let y=[];for(let[h,w]of Object.entries(o)){if(h==="_")return"error underscore cannot be used as an item name";if(O.is(w)||f(w)){y.push(h);continue}return`error {${h}:${w}} cannot be converted to graph`}if(y.length!==0)return y}return`error ${o} cannot be converted to a graph`},s=o=>{let y=(a,l,p,g)=>{t.get(O.put(a,"#",l),async m=>{if(m.err&&console.log(m.err),m.put&&m.put[l]){delete m.put[l]._,delete m.put[l][M];for(let b of Object.keys(m.put[l])){let S=T.is(m.put[l][b]);if(S){let v=await new Promise(k=>{let x=E.random();n.set(x,{chain:[{item:null,soul:S}]}),s(x).next(null,k)});m.put[l][b]=v}}p(m.put[l])}else p(null)},g)},h=async(a,l,p)=>{if(p||(p=console.log),i.is){let g=await K.sign(l,i.is);return F(a,g.m,g.s,i.is.pub)}return e.secure?(p(`error putting data on ${a}: user required in secure mode`),null):F(a,l)},w=a=>{let l=n.get(o);l&&typeof l.cb<"u"?l.cb(a):a&&console.log(a),l&&!l.on&&n.delete(o)},d=(a,l)=>{let p=a&&typeof a.get<"u",g=a&&typeof a.put<"u",m=a&&typeof a.on<"u",b=a&&typeof a.off<"u",S=!1,v=n.get(o);for(var k=1;k<v.chain.length;k++)if(v.chain[k].soul===null){S=!0;break}if(S){let{item:x,soul:j}=v.chain[k-1];return t.get({"#":j,".":x},async $=>{if($.err){console.log(`error getting ${x} on ${j}: ${$.err}`),l&&l(null);return}let B=$.put&&$.put[j];if(B&&typeof B[x]<"u"){let A=T.is(B[x]);if(A)v.chain[k].soul=A,n.set(o,{chain:v.chain,cb:v.cb}),p?s(o).next(null,a.get,l):g?s(o).put(a.put,l):m?s(o).on(a.on,l):b&&s(o).off(l);else if(p)l(B[x]);else if(g){A=E.random();let N={[x]:T.ify(A)},W=await h(j,N,l);if(W===null)return;t.put(W,U=>{if(U){l(`error putting ${x} on ${j}: ${U}`);return}v.chain[k].soul=A,s(o).put(a.put,l)})}else m?(console.log(`error resolving on for ${x} on ${j}`),l(null)):b&&(console.log(`error resolving off for ${x} on ${j}`),l&&l(null))}else g?l(`error ${x} not found on ${j}`):(console.log(`error ${x} not found on ${j}`),l&&l(null))}),!1}return p&&v.chain[v.chain.length-1].item!==null?(v.chain.push({item:null,soul:null}),s(o).next(null,a.get,l),!1):v.chain[v.chain.length-1]};return{get:(a,l,p,g)=>{if(typeof l=="function"&&(p=l,l=null),a===null||a===""||a==="_"){p&&p(null);return}if(l&&!p){console.log("error lex requires a callback function");return}let m=u||(i.ctx?i.ctx:"root");if(o=E.random(),n.set(o,{chain:[{item:a,soul:m}],cb:p}),!p)return s(o);let{soul:b}=d({get:l},w);b&&y(l,b,w,g)},next:(a,l,p,g)=>{let m=v=>{p?p(v):w(v)};if(typeof l=="function"&&(p=l,l=null),!o){console.log("error please provide a key using get(key)"),m(null);return}if(a===""||a==="_"){m(null);return}if(l&&!p){console.log("error lex requires a callback function");return}let b=n.get(o);if(!b)return;if(p&&typeof b.cb>"u"&&(b.cb=p,p=null),a!==null&&b.chain.push({item:a,soul:null}),!b.cb)return s(o);let{soul:S}=d({get:l},m);S&&y(l,S,m,g)},put:(a,l,p)=>{typeof l=="function"&&(p=l,l=!1);let g=k=>{p?p(k):w(k)};if(!o){g("please provide a key using get(key)");return}let m=n.get(o);if(!m)return;if(!m.cb){if(!p)return;m.cb=p,p=null}l&&(a={[E.random()]:a});let b=c(a);if(typeof b=="string"){g(b);return}let{item:S,soul:v}=d({put:a},g);if(v){if(b===!0){t.get({"#":v,".":S},async k=>{if(k.err){console.log(`error getting ${v}: ${k.err}`);return}let x=k.put&&k.put[v]&&k.put[v][S],j=T.is(x);if(!j){let $=await h(v,{[S]:a},g);if($===null)return;t.put($,g);return}t.get({"#":j},async $=>{if($.err){console.log(`error getting ${j}: ${$.err}`);return}if(!$.put||!$.put[j]){console.log(`error ${j} not found`);return}delete $.put[j]._;for(let A of Object.keys($.put[j])){if(A===M)continue;let N=await new Promise(W=>{let U=E.random();n.set(U,{chain:[{item:A,soul:j}]}),s(U).put(null,W)});if(N){g(N);return}}let B=await h(v,{[S]:a},g);B!==null&&t.put(B,g)})});return}t.get({"#":v,".":S},async k=>{if(k.err){g(`error getting ${v}.${S}: ${k.err}`);return}let x=k.put&&k.put[v]&&k.put[v][S],j=T.is(x);if(!j){let A={[S]:T.ify(E.random())},N=await h(v,A,g);if(N===null)return;t.put(N,W=>{if(W)g(`error putting ${S} on ${v}: ${W}`);else{let U=E.random(),Se=[{item:S,soul:v}];n.set(U,{chain:Se,cb:m.cb}),s(U).put(a)}});return}let $=!1,B={};for(let A of b){let N=await new Promise(W=>{if(O.is(a[A])){let U=E.random();n.set(U,{chain:[{item:A,soul:j}]}),s(U).put(a[A],W)}else $=!0,B[A]=a[A],W(null)});if(N){g(N);return}}if($){let A=await h(j,B,g);if(A===null)return;t.put(A,g)}else g(null)})}},on:(a,l)=>{if(typeof a=="function"&&(l=a,a=null),!l)return;if(!o){console.log("error please provide a key using get(key)"),l(null);return}let{item:p,soul:g}=d({on:a},l);g&&(n.set(o,{chain:[{item:p,soul:g}],on:!0}),r.set(l,()=>s(o).next(null,l)),t.get({"#":g,".":p},m=>{if(m.err){console.log(`error getting ${g}.${p}: ${m.err}`);return}let b=m.put&&m.put[g]&&m.put[g][p],S=T.is(b);S?a?a=O.put(a,"#",S):a={"#":S,".":null}:a?a=O.put(a,"#",g):a={"#":g,".":p},t.on(a,r.get(l))}))},off:a=>{if(!o){console.log("error please provide a key using get(key)"),a&&a(null);return}let{item:l,soul:p}=d({off:!0},a);p&&t.get({"#":p,".":l},g=>{if(g.err){console.log(`error getting ${p}.${l}: ${g.err}`);return}let m=g.put&&g.put[p]&&g.put[p][l],b=T.is(m);b?t.off({"#":b},r.get(a)):t.off({"#":p},r.get(a)),r.delete(a),n.delete(o)})},user:a=>(a?u="~"+a:u=null,Object.assign(i,s())),wire:t,SEA:K}};return s()},lt=Pe;export{lt as default};
//# sourceMappingURL=holster.js.map
