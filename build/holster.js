var te={is:e=>{if(e instanceof Array)return!1;if(typeof e=="number")return!isNaN(e);if(typeof e=="string"){let t=parseFloat(e);return!isNaN(t)&&isFinite(t)}return!1}},N={is:e=>{if(!e||typeof e!="object")return!1;let r=Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/);return e.constructor===Object||r&&r[1]==="Object"},map:(e,t,r)=>{var n=Object.keys(e);for(let o=0;o<n.length;o++){let u=t(e[n[o]],n[o],r);if(typeof u<"u")return u}},put:(e,t,r)=>(e||(e={}),e[t]=r,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Me=(e,t,r)=>{if(r.id){r.id=!1;return}if(t==="#"&&typeof e=="string"){r.id=e;return}r.id=!1},C={is:e=>{if(e&&e["#"]&&!e._&&N.is(e)){let t={};if(N.map(e,Me,t),t.id)return t.id}return!1},ify:e=>N.put({},"#",e)},K="_holster_user_signature",R="_holster_user_public_key",q=(e,t,r,n)=>{let o=Date.now(),u={[e]:{_:{"#":e,">":{}}}};for(let[l,f]of Object.entries(t))l!=="_"&&l!==R&&l!==K&&(u[e][l]=f,u[e]._[">"][l]=o);return r&&n&&(u[e][K]=r,u[e]._[">"][K]=o,u[e][R]=n,u[e]._[">"][R]=o),u},z=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!N.is(e)||!t)return!1;let r=e["*"];if(r)return t.slice(0,r.length)===r;let n=e[">"],o=e["<"];return n&&o?t>=n&&t<=o:n?t>=n:o?t<=o:!1},O={random:e=>{var t="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let n=0;n<e;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}};var Be=e=>{e||(e=9e3);let t={store:{}};return t.check=r=>t.store[r]?t.track(r):!1,t.track=r=>(t.store[r]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{if(t.expiry)return;let n=Date.now();Object.keys(t.store).forEach(o=>{n-t.store[o]>e&&delete t.store[o]}),t.expiry=null},e)),r),t},me=Be;var Ue=(e,t)=>{if(!e||typeof e!="object")throw new TypeError("lex must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");let r=e["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!t[r])return;let n={_:{"#":r,">":{}}};if(typeof e["."]=="string"){let o=e["."];if(typeof t[r][o]>"u")return;n[o]=t[r][o],n._[">"][o]=t[r]._[">"][o]}else for(let o of Object.keys(t[r]))z(e["."],o)&&(n[o]=t[r][o],n._[">"][o]=t[r]._[">"][o]);return{[r]:n}},ae=Ue;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function re(){}Object.assign(re,{from:Array.from});re.prototype=Object.create(Array.prototype);re.prototype.toString=function(e,t,r){if(e||(e="utf8"),t||(t=0),r=r?Math.min(Math.max(r,t),this.length):this.length,e==="hex"){let n=new Uint8Array(this.slice(t,r));return Array.from(n,o=>o.toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:r-t},(n,o)=>{let u=this[o+t];return u<0||u>1114111?"\uFFFD":String.fromCharCode(u)}).join("");if(e==="base64"){let n=Array.from({length:r-t},(o,u)=>{let l=this[u+t];return l<0||l>255?"\uFFFD":String.fromCharCode(l)}).join("");return btoa(n)}};var L=re;var ne={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function W(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),W.from(...e)}W.prototype=Object.create(Array.prototype);var Q=(e,t)=>{if(typeof e!="string")throw new TypeError("Input must be a string for encoding: "+t);if(e.length>ne.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${e.length} > ${ne.MAX_STRING_LENGTH}`)},H=(e,t="buffer operation")=>{if(e>ne.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${t}: ${e} > ${ne.MAX_BUFFER_SIZE}`)},Pe=e=>{Q(e,"hex");let t=e.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(t))throw new TypeError("Invalid hex string: contains non-hex characters");if(t.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(t.length===0)return new Uint8Array(0);H(t.length/2,"hex parsing");let r=new Uint8Array(t.length/2);for(let n=0;n<t.length;n+=2){let o=t.substr(n,2);r[n/2]=parseInt(o,16)}return r},we=e=>{Q(e,"utf8");try{let r=new TextEncoder().encode(e);return H(r.length,"UTF-8 encoding"),r}catch(t){throw new TypeError("Failed to encode UTF-8 string: "+t.message)}},Re=e=>{Q(e,"binary"),H(e.length,"binary encoding");let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);t[r]=n}return t},Fe=e=>{Q(e,"base64");let t=e.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(t))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(t);H(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let o=0;o<r.length;o++)n[o]=r.charCodeAt(o);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},be=e=>{let t;if(e instanceof ArrayBuffer)H(e.byteLength,"ArrayBuffer processing"),t=new Uint8Array(e);else if(ArrayBuffer.isView(e))H(e.byteLength||e.length,"TypedArray processing"),t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);else if(Array.isArray(e)){H(e.length,"Array processing");for(let r=0;r<e.length;r++){let n=e[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}t=new Uint8Array(e)}else if(typeof e=="object"&&e!==null&&typeof e.length=="number"){H(e.length,"array-like processing");let r=Array.from(e);for(let n=0;n<r.length;n++){let o=r[n];if(typeof o!="number"||o<0||o>255||!Number.isInteger(o))throw new TypeError(`Invalid byte value at index ${n}: ${o} (must be integer 0-255)`)}t=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof e);return t};Object.assign(W,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let t=arguments[0];if(t==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof t=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=Pe(t);break;case"utf8":case"utf-8":r=we(t);break;case"binary":case"latin1":r=Re(t);break;case"base64":r=Fe(t);break;case"ascii":Q(t,"ascii");for(let o=0;o<t.length;o++)if(t.charCodeAt(o)>127)throw new TypeError(`Invalid ASCII character at position ${o}: ${t.charCodeAt(o)} > 127`);r=we(t);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=be(t);if(!r||r.length===0)return L.from(new Uint8Array(0));try{return L.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(e,t=0){if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Length must be a non-negative integer");if(H(e,"buffer allocation"),typeof t=="number"){if(t<0||t>255||!Number.isInteger(t))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof t=="string"){if(t.length!==1)throw new TypeError("Fill string must be exactly one character");if(t=t.charCodeAt(0),t>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(e);return t!==0&&r.fill(t),L.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be an array");if(e.length===0)return L.from(new Uint8Array(0));let t=0,r=[];for(let n=0;n<e.length;n++){let o=e[n];if(!o)throw new TypeError(`Array element at index ${n} is null or undefined`);let u;try{u=be(o)}catch(l){throw new TypeError(`Invalid array element at index ${n}: ${l.message}`)}t+=u.length,H(t,"buffer concatenation"),r.push(u)}try{let n=new Uint8Array(t),o=0;for(let u of r)n.set(u,o),o+=u.length;return L.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(e){return e instanceof L||e&&typeof e=="object"&&e.constructor===W},byteLength(e,t="utf8"){if(typeof e!="string")throw new TypeError("First argument must be a string");switch(t.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(e).length;case"ascii":case"binary":case"latin1":return e.length;case"base64":let r=e.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(e.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+t)}}});W.prototype.from=W.from;W.prototype.toString=function(e="utf8",t=0,r=this.length){if(typeof e!="string")throw new TypeError("Encoding must be a string");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<t)throw new TypeError("End must be an integer >= start");try{return L.prototype.toString.call(this,e,t,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var F=W;var De=typeof document>"u",Se=De?(await import("node:crypto")).webcrypto:globalThis.crypto,I=Se.subtle,oe=e=>typeof e=="string"?e:JSON.stringify(e),V=e=>{try{return JSON.parse(e)}catch{return e}},ie=e=>{let t=new Uint8Array(F.alloc(e));return F.from(Se.getRandomValues(t))},ee=(e,t)=>{let[r,n]=e.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},se=async e=>{let t=await I.digest({name:"SHA-256"},new TextEncoder().encode(oe(e)));return F.from(t)},ce=async(e,t)=>{let r=e+t.toString("utf8"),n=F.from(await se(r),"binary"),o=Ke(n);return await I.importKey("jwk",o,{name:"AES-GCM"},!1,["encrypt","decrypt"])},Ke=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var He={pair:async e=>{let t=await I.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async o=>{let u=await I.exportKey("jwk",o.publicKey);return{priv:(await I.exportKey("jwk",o.privateKey)).d,pub:u.x+"."+u.y}}),r=await I.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async o=>{let u=await I.exportKey("jwk",o.publicKey);return{epriv:(await I.exportKey("jwk",o.privateKey)).d,epub:u.x+"."+u.y}}),n={pub:t.pub,priv:t.priv,epub:r.epub,epriv:r.epriv};return e&&e(n),n},encrypt:async(e,t,r)=>{if(!t||!t.epriv)return r&&r(null),null;let n={s:ie(9),iv:ie(15)},o=await ce(t.epriv,n.s).then(l=>I.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},l,new TextEncoder().encode(oe(e)))),u={ct:F.from(o,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(u),u},decrypt:async(e,t,r)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return r&&r(null),null;let n={ct:F.from(e.ct,"base64"),iv:F.from(e.iv,"base64"),s:F.from(e.s,"base64")};try{let o=await ce(t.epriv,n.s).then(l=>I.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},l,new Uint8Array(n.ct))),u=V(new TextDecoder("utf8").decode(o));return r&&r(u),u}catch{return r&&r(null),null}},verify:async(e,t,r)=>{if(!t||!t.pub)return r&&r(null),null;let n=V(e),o=await I.importKey("jwk",ee(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),u={};if(typeof n.m=="string")u=n.m;else for(let i of Object.keys(n.m).sort())i!=="_"&&i!=R&&i!=K&&(u[i]=n.m[i]);let l=await se(u),f=new Uint8Array(F.from(n.s,"base64")),s={name:"ECDSA",hash:{name:"SHA-256"}};if(await I.verify(s,o,f,new Uint8Array(l))){let i=V(n.m);return r&&r(i),i}return r&&r(null),null},sign:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n={};if(typeof e=="string")n=e;else{let i=V(e);for(let g of Object.keys(i).sort())g!=="_"&&g!=R&&g!=K&&(n[g]=i[g])}let o=await se(n),u=ee(t.pub,t.priv),l={name:"ECDSA",namedCurve:"P-256"},f=await I.importKey("jwk",u,l,!1,["sign"]).then(i=>I.sign({name:"ECDSA",hash:{name:"SHA-256"}},i,new Uint8Array(o))),s={m:n,s:F.from(f,"binary").toString("base64")};return r&&r(s),s},work:async(e,t,r)=>{typeof t=="function"&&(r=t,t=void 0),typeof t>"u"&&(t=ie(9));let n=await I.importKey("raw",new TextEncoder().encode(oe(e)),{name:"PBKDF2"},!1,["deriveBits"]),o={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},u=await I.deriveBits(o,n,512),l={epriv:F.from(u,"binary").toString("base64")};return r&&r(l),l},secret:async(e,t,r)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},o=ee(e.epub),u=await I.importKey("jwk",o,n,!0,[]),l=ee(t.epub,t.epriv,!1);delete l.key_ops;let f=await I.importKey("jwk",l,n,!1,["deriveBits"]).then(async s=>{let i=await I.deriveBits({public:u,name:"ECDH",namedCurve:"P-256"},s,256),g=await I.importKey("raw",new Uint8Array(i),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return I.exportKey("jwk",g).then(({k:w})=>w)});return r&&r({epriv:f}),{epriv:f}}},U=He;var ve=100,ke=1e4,pe=(e,t,r,n)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});pe.mix=async(e,t,r,n)=>{if(!e||typeof e!="object")throw new TypeError("change must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let o=Date.now(),u={},l={},f=0;for(let i of Object.keys(e)){let g=e[i],w=!1,k=!1,a=0,d=r;if(!g||!g._)continue;let m=g[K],b=g[R];if(m&&b&&(d=!0),i.length>1&&i[0]==="~")if(i[1]==="@")k=!0,d=!1;else{if(b&&i!="~"+b){console.log(`error public key does not match for soul: ${i}`);continue}d=!0}if(!(d&&(!m||!b||!await U.verify({m:g,s:m},{pub:b})))){for(let c of Object.keys(g)){if(c==="_")continue;let p=g[c],h=g._&&g._[">"]?g._[">"][c]:0,y=(t[i]||{})[c],S=(t[i]||{_:{">":{}}})._[">"][c]||0;if(k&&c!==C.is(p)){console.log(`error alias ${k}: ${c} !== ${C.is(p)}`);continue}let v=h-o;if(v>0){if(v>864e5)continue;(f===0||v<f)&&(f=a=v),l[i]||(l[i]={_:{"#":i,">":{}}}),l[i][c]=p,l[i]._[">"][c]=h}else pe(h,S,p,y).incoming&&(u[i]||(u[i]={_:{"#":i,">":{}}}),t[i]||(t[i]={_:{"#":i,">":{}}}),t[i][c]=u[i][c]=p,t[i]._[">"][c]=u[i]._[">"][c]=h,n[i]&&setTimeout(()=>{n[i]&&n[i].filter(T=>z(T["."],c)).forEach(T=>T.cb())},ve),w=!0)}d&&a!==0&&u[i]&&(Object.assign(l[i],u[i]),delete u[i]),w&&n[i]&&setTimeout(()=>{n[i]&&n[i].filter(c=>z(c["."])).forEach(c=>c.cb())},ve)}}let s=Object.keys(t);return s.length>ke&&s.map(w=>{let k=t[w]._&&t[w]._[">"],a=k?Math.max(...Object.values(k)):0;return{soul:w,maxState:a}}).sort((w,k)=>w.maxState-k.maxState).slice(0,s.length-ke).forEach(({soul:w})=>delete t[w]),{now:u,defer:l,wait:f}};var ge=pe;var J="",Y="",Ee=()=>{let e=(t,r,n)=>{if(n||(e[J]||(e[J]={}),n=e[J]),!t)return n;let o=0,u={},l=t[o],f=t.length-1,s=typeof r>"u",i=n[l];for(;!i&&o<f;)l+=t[++o],i=n[l];if(i)if(o===f){if(s)return typeof i[Y]>"u"?i[J]:i[Y];i[Y]=r}else return!i[J]&&!s&&(i[J]={}),e(t.slice(++o),r,i[J]);else if(N.map(n,(w,k)=>{let a=0,d="";for(;k[a]===t[a];)d+=k[a++];if(d){if(s)return a<=f?void 0:(u[k.slice(a)]=w,w);let m={[k.slice(a)]:w,[t.slice(a)]:{[Y]:r}};return n[d]={[J]:m},delete n[k],!0}})){if(s)return u}else{if(s)return;n[l]||(n[l]={}),n[l][Y]=r}};return e};Ee.map=function e(t,r,n,o){o||(o=[]);var u=t[J]||t,l=Object.keys(u).sort(),f;for(let s=0;s<l.length;s++){let i=l[s],g=u[i],w=g[Y];if(typeof w<"u"){if(w=r(w,o.join("")+i,i,o),typeof w<"u")return w}else n&&r(f,o.join(""),i,o);if(g[J]){if(o.push(i),w=e(g[J],r,n,o),typeof w<"u")return w;o.pop()}}};var D=Ee;var Te="",je="",B="",Z=e=>{var t,r=null;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=10*1e3),e.write||(e.write=1),e.size||(e.size=1024*1024),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let n=(o,u,l)=>{if(o=""+o,typeof u=="function")return l=u,u=n.batch(o),typeof u<"u"||n.thrash.at&&(u=n.thrash.at(o),typeof u<"u")?l(t,u):n.read(o,l);if(n.batch(o,u),l&&n.batch.acks.push(l),++n.batch.ed>=e.batch)return n.thrash();clearTimeout(n.batch.timeout),n.batch.timeout=setTimeout(n.thrash,e.write)};return n.batch=D(),n.batch.acks=[],n.batch.ed=0,n.thrash=()=>{if(n.thrash.ing)return n.thrash.more=!0;clearTimeout(n.batch.timeout),n.thrash.more=!1,n.thrash.ing=!0;var o=n.thrash.at=n.batch;n.batch=null,n.batch=D(),n.batch.acks=[],n.batch.ed=0;let u=0;n.save(o,l=>{++u>1||(l&&e.log(l),o.acks.forEach(f=>f(l)),n.thrash.at=null,n.thrash.ing=!1,n.thrash.more&&n.thrash())})},n.save=(o,u)=>{let l={find:(f,s)=>{if(!(s<l.start))return l.start=s,e.store.list(l.lex),!0},lex:f=>{!f||f>l.start?(l.end=f,l.start&&l.mix(l.file||"!",l.start,l.end)):l.file=f},mix:(f,s,i)=>{l.start=l.end=l.file=t,n.parse(f,(g,w)=>{if(g)return u(g);D.map(o,(k,a)=>{if(!(a<s)){if(i&&i<a){l.start=a;return}w(a,k)}}),n.write(f,w,l.next)})},next:f=>{if(f)return u(f);if(l.start)return D.map(o,l.find);u(f)}};D.map(o,l.find)},n.write=(o,u,l)=>{r=null;let f={text:"",limit:"",done:!1,count:0,each:(s,i,g,w)=>{if(f.done)return;f.count++,s=typeof s>"u"?"":"="+Z.encode(s);let k=Z.encode(w.length)+"#"+Z.encode(g)+s+`
`;if(f.count>1&&w.length===0&&f.text.length+k.length>e.size){let a=g.indexOf(je);if(f.limit=a===-1?g:g.substring(0,a),f.limit!==o){f.done=!0,f.sub=D(),D.map(u,f.slice),n.write(f.limit,f.sub,l);return}}f.text+=k},slice:(s,i)=>{i<f.limit||f.sub(i,s)}};D.map(u,f.each,!0),e.store.put(o,f.text,l)},n.read=(o,u)=>{if(r){let i=r(o);if(typeof i<"u")return u(t,i)}let l=o.indexOf(je),f=l===-1?o:o.substring(0,l),s={lex:i=>{if(!i){if(!s.file){u("no file found",t);return}n.parse(s.file,s.it);return}i>f||i<s.file||(s.file=i)},it:(i,g)=>{i&&e.log(i),g&&(r=g,s.value=g(o)),u(i,s.value)}};e.store.list(s.lex)},n.parse=(o,u)=>{let l={disk:D(),read:(f,s)=>{if(f)return u(f);if(!s)return u(t,l.disk);let i=[],g=l.split(s);for(;g;){let w,k,a=g[1];g=l.split(g[2])||"",g[0]==="#"&&(w=g[1],i=i.slice(0,a),a<=i.length&&i.push(w)),g=l.split(g[2])||"",g[0]!==`
`&&(g[0]==="="&&(k=g[1]),typeof w<"u"&&typeof k<"u"&&l.disk(i.join(""),k),g=l.split(g[2]))}u(t,l.disk)},split:f=>{if(!f)return;let s=-1,i="",g=null;for(;(g=f[++s])&&g!==B;)i+=g;let w={};if(g)return[i,Z.decode(f.slice(s),w),f.slice(s+w.i)]}};e.store.get(o,l.read)},n};Z.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=Te+e[1],e=e[0]),typeof e=="string"){let n=0,o=null,u=B;for(;o=e[n++];)o===B&&(u+=B);return u+'"'+e+t+B}let r=C.is(e);if(r)return B+"#"+r+t+B;if(te.is(e))return B+"+"+(e||0)+t+B;if(e===!0)return B+"+"+t+B;if(e===!1)return B+"-"+t+B;if(e===null)return B+" "+t+B};Z.decode=(e,t)=>{var r="",n=-1,o=0,u=null,l=null;if(e[0]!==B)return;for(;u=e[++n];)if(l){if(u===B&&--o<=0)break;r+=u}else u===B?o++:l=u||!0;t&&(t.i=n+1);let[f,s]=r.split(Te);if(s){if(s=parseFloat(s),l==='"')return[f,s];if(l==="#")return[C.ify(f),s];if(l==="+")return f.length===0?[!0,s]:[parseFloat(f),s];if(l==="-")return[!1,s];if(l===" ")return[null,s]}else{if(l==='"')return r;if(l==="#")return C.ify(r);if(l==="+")return r.length===0?!0:parseFloat(r);if(l==="-")return!1;if(l===" ")return null}};var Ae=Z;var xe=typeof document>"u",G=xe?await import("node:fs"):void 0,$e="",ue="",de=ue+"+0"+ue+"#"+ue+'"root'+ue,qe=e=>{let t=e.file;if(xe)return G.existsSync(t)||G.mkdirSync(t),G.existsSync(t+"/!")||G.writeFileSync(t+"/!",de),{get:(r,n)=>{G.readFile(t+"/"+r,(o,u)=>{if(o){if(o.code==="ENOENT"){n();return}console.log("fs.readFile error:",o)}u&&(u=u.toString()),n(o,u)})},put:(r,n,o)=>{var u=r+"."+O.random(9)+".tmp";G.writeFile(u,n,l=>{if(l){console.log("fs.writeFile error:",l),o(l);return}G.rename(u,t+"/"+r,o)})},list:r=>{G.readdir(t,(n,o)=>{if(n){console.log("fs.readdir error:",n),r();return}o.forEach(r),r()})}};if(e.indexedDB){let r,n=indexedDB.open(t,1);return n.onupgradeneeded=o=>{o.target.result.createObjectStore(t)},n.onerror=o=>{console.log(o)},n.onsuccess=()=>{if(r=n.result,r){let u=r.transaction([t],"readonly").objectStore(t).getKey("!");u.onerror=()=>{console.log(`error getting key ${t}/!`)},u.onsuccess=()=>{if(!u.result){let f=r.transaction([t],"readwrite").objectStore(t).put(de,"!");f.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(o,u)=>{let l=(i,g)=>{let k=r.transaction([t],"readonly").objectStore(t).get(i);k.onerror=()=>{console.log(`error getting ${t}/${i}`)},k.onsuccess=()=>{g(null,k.result)}};if(r){l(o,u);return}let f=0,s=setInterval(()=>{if(r){clearInterval(s),l(o,u);return}f++>5&&(clearInterval(s),u("error indexedDB not available"))},1e3)},put:(o,u,l)=>{let f=(g,w,k)=>{let d=r.transaction([t],"readwrite").objectStore(t).put(w,g);d.onerror=()=>{console.log(`error putting data on ${t}/${g}`)},d.onsuccess=()=>{k(null)}};if(r){f(o,u,l);return}let s=0,i=setInterval(()=>{if(r){clearInterval(i),f(o,u,l);return}s++>5&&(clearInterval(i),l("error indexedDB not available"))},1e3)},list:o=>{let u=s=>{let g=r.transaction([t],"readonly").objectStore(t).getAllKeys();g.onerror=()=>console.log("error getting keys for",t),g.onsuccess=()=>{g.result.forEach(s),s()}};if(r){u(o);return}let l=0,f=setInterval(()=>{if(r){clearInterval(f),u(o);return}l++>5&&(clearInterval(f),console.log("error indexedDB not available"),o())},1e3)}}}return{get:(r,n)=>{n(null,de)},put:(r,n,o)=>{o(null)},list:r=>{r("!"),r()}}},Le=e=>{N.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=qe(e));let t=Ae(e);return{get:(r,n)=>{if(!r||!N.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}var o=r["#"],u=typeof r["."]=="string"?r["."]:"",l;let f=(s,i)=>{z(r["."],i)&&(l||(l={_:{"#":o,">":{}}}),l[i]=s[0],l._[">"][i]=s[1])};t(o+$e+u,(s,i)=>{let g;N.is(i)?(D.map(i,f),l||f(i,u),g={[o]:l}):i&&(f(i,u),g={[o]:l}),n(s,g)})},put:(r,n)=>{if(!r){n("graph required");return}let o=0,u=!1,l=f=>{if(o--,!u){if(f){u=!0,n(f);return}o===0&&(u=!0,n(null))}};Object.keys(r).forEach(f=>{var s=r[f];Object.keys(s).forEach(i=>{if(i==="_")return;o++;let g=s[i],w=s._[">"][i];t(f+$e+i,[g,w],l)})})}}},_e=Le;var Oe=typeof document>"u",Ce=Oe?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Ce?.WebSocket);var We=e=>{let t=new Map,r=e.maxRequestsPerMinute||100,n=e.rateLimitWindow||6e4,o=e.wss&&e.wss.constructor.name==="Server",u=null;return o||(u=setInterval(()=>{let f=Date.now();for(let[s,i]of t.entries())f-i.lastCleanup>n&&(i.requests=[],i.lastCleanup=f),i.requests=i.requests.filter(g=>f-g<n)},n/4)),{getDelay:f=>{let s=Date.now(),i=t.get(f)||{requests:[],lastCleanup:s};if(i.requests=i.requests.filter(g=>s-g<n),i.requests.length>=r){let g=Math.min(...i.requests),w=n-(s-g);return Math.max(0,w)}return i.requests.push(s),t.set(f,i),0},getRemainingRequests:f=>{let s=t.get(f);if(!s)return r;let i=Date.now(),g=s.requests.filter(w=>i-w<n);return Math.max(0,r-g.length)},destroy:()=>{u&&(clearInterval(u),u=null),t.clear()}}},Ge=(e,t=1024*1024)=>{try{if(typeof e=="string"&&e.length>t)throw new Error("Message too large");return{success:!0,data:JSON.parse(e)}}catch(r){return{success:!1,error:r.message}}},ze=(e,t=1024*1024)=>typeof e=="string"&&e.length>t?{valid:!1,error:"Message too large"}:Buffer.isBuffer(e)&&e.length>t?{valid:!1,error:"Message too large"}:{valid:!0},Xe=(e=1e3)=>{let t=new Set;return{add:r=>{if(t.size>=e)return!1;t.add(r);let n=r.close;return r.close=(...o)=>(t.delete(r),n.apply(r,o)),!0},remove:r=>{t.delete(r)},count:()=>t.size,isFull:()=>t.size>=e}},ye=(e=5)=>{let t=0;return{shouldRetry:()=>t<e,getDelay:()=>Math.min(1e3*Math.pow(2,t),3e4),increment:()=>t++,reset:()=>t=0}},Ze=e=>{let t=me(e.maxAge),r=_e(e),n={},o={},u={},l=new Set,f=async c=>n[c]?!0:new Promise(p=>{r.get({"#":c},(h,y)=>{p(!h&&y&&y[c])})}),s=We(e),i=Xe(e.maxConnections||1e3),g=async(c,p,h)=>{for(let y of Object.keys(c)){let S=await new Promise(T=>{a({"#":y},T,p)});if(S.err)return h&&h(S.err),!1;let v=c[y],E=R;if(!(!S.put||!S.put[y]||S.put[y][E]===v[E]))return h&&h(`error in wire check public key does not match for soul: ${y}`),!1}return!0},w=(c,p)=>{let h=ae(c.get,n);h?p(JSON.stringify({"#":t.track(O.random(9)),"@":c["#"],put:h})):r.get(c.get,(y,S)=>{p(JSON.stringify({"#":t.track(O.random(9)),"@":c["#"],put:S,err:y}))})},k=async(c,p)=>{let h=await ge.mix(c.put,n,e.secure,u);if(Object.keys(h.now).length){if(!await g(h.now,p))return;r.put(h.now,y=>{p(JSON.stringify({"#":t.track(O.random(9)),"@":c["#"],err:y}))})}Object.keys(h.defer).length&&setTimeout(()=>k({put:h.defer},p),h.wait)},a=(c,p,h,y)=>{if(!p)return;N.is(y)||(y={});let S=ae(c,n),v=O.random(9),E=JSON.stringify({"#":t.track(v),get:e.secure?{"#":c["#"]}:c});if(S){h(E),p({put:S});return}r.get(c,(T,$)=>{if($){h(E),p({put:$,err:T});return}T&&console.log(T),o[v]=p,h(E),setTimeout(()=>{let j=o[v];if(j){let x=c["#"],A={[x]:null};typeof c["."]=="string"&&(A[x]={[c["."]]:null}),j({put:A}),delete o[v]}},y.wait||100)})},d=c=>({get:(p,h,y)=>{p&&p["#"]&&l.add(p["#"]),a(p,h,c,y)},put:async(p,h)=>{let y=await ge.mix(p,n,e.secure,u);if(Object.keys(y.now).length===0){h(null);return}if(await g(y.now,c,h)){for(let[v,E]of Object.entries(y.now))if(E&&typeof E=="object")for(let[T,$]of Object.entries(E)){let j=C.is($);j&&l.add(j)}r.put(y.now,h),c(JSON.stringify({"#":t.track(O.random(9)),put:p}))}},on:(p,h,y,S)=>{let v=p&&p["#"];!v||!h||(u[v]?u[v].push({".":p["."],cb:h}):u[v]=[{".":p["."],cb:h}],y&&a(p,h,c,S))},off:(p,h)=>{let y=p&&p["#"];if(!(!y||!u[y]))if(h){let S=u[y].find(v=>v.cb===h);S&&u[y].splice(u[y].indexOf(S),1)}else delete u[y]}});if(Oe){let c=e.wss,p=()=>c.clients();if(!c){let y=e.server?{server:e.server}:{port:e.port||8765};c=new Ce.WebSocketServer(y),p=()=>c.clients}let h=(y,S)=>{p().forEach(v=>{if(v&&v.readyState===WebSocket.OPEN)v.send(y,{binary:S});else{let E=v._retryHandler||ye();if(v._retryHandler=E,E.shouldRetry()){let T=E.getDelay();E.increment(),setTimeout(()=>{v&&v.readyState===WebSocket.OPEN&&(E.reset(),v.send(y,{binary:S}))},T)}}})};return c.on("connection",y=>{if(!i.add(y)){console.log("Connection limit reached, rejecting connection"),y.close(1013,"Connection limit reached - try again later");return}let S=O.random(9);y.on("error",v=>{console.error("WebSocket error:",v),i.remove(y)}),y.on("close",()=>{i.remove(y)}),y.on("message",(v,E)=>{let T=ze(v,e.maxMessageSize);if(!T.valid){console.warn(`Invalid message: ${T.error}`),y.send(JSON.stringify({error:T.error}));return}let $=Ge(v,e.maxMessageSize);if(!$.success){console.warn(`JSON parse error: ${$.error}`),y.send(JSON.stringify({error:"Invalid JSON"}));return}let j=$.data;if(t.check(j["#"]))return;let x=s.getDelay(S),A=()=>{t.track(j["#"]),j.get&&w(j,h),j.put&&k(j,h),h(v,E);let _=j["@"],M=o[_];M&&(delete j["#"],delete j["@"],M(j),delete o[_])};x>0?setTimeout(A,x):A()})}),d(h)}let m=[],b=c=>{m.forEach(p=>{if(p&&p.readyState===WebSocket.OPEN)p.send(c);else{let h=p._retryHandler||ye();if(p._retryHandler=h,h.shouldRetry()){let y=h.getDelay();h.increment(),setTimeout(()=>{p&&p.readyState===WebSocket.OPEN&&(h.reset(),p.send(c))},y)}}})};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(c=>{let p=()=>{let h=new WebSocket(c);m.push(h);let y=ye();h.onclose=S=>{if(m.indexOf(h)!==-1&&m.splice(m.indexOf(h),1),h=null,y.shouldRetry()){let v=y.getDelay();y.increment(),setTimeout(p,v)}},h.onopen=()=>{y.reset()},h.onerror=S=>{console.error(S)},h.onmessage=async S=>{let v=JSON.parse(S.data);if(t.check(v["#"]))return;if(t.track(v["#"]),v.get&&w(v,b),v.put){let $={};for(let[j,x]of Object.entries(v.put)){let A=!1;if(await f(j)&&(A=!0,x&&typeof x=="object"))for(let[_,M]of Object.entries(x)){let P=C.is(M);P&&l.add(P)}l.has(j)&&(A=!0,l.delete(j)),A&&($[j]=x)}Object.keys($).length>0&&k({put:$},b)}b(S.data);let E=v["@"],T=o[E];T&&(delete v["#"],delete v["@"],T(v),delete o[E])}};p()}),d(b)},le=Ze;var Ye=(e,t)=>{t||(t=le(e));let r=[],n=!1,o=!1,u=0,l=(s,i,g,w)=>{let k=b=>{u++,l(b,i,g,w)},a=b=>{r=[],u=0,o=!1,w(b)},d=()=>{if(r.length===0){a("Wrong username or password");return}let b=r.shift();t.get({"#":b},async c=>{if(c.err){a(`error getting ${b}: ${c.err}`);return}let p=c.put&&c.put[b];if(!p||!p.auth)return d();let h=JSON.parse(p.auth),y=await U.work(i,h.salt),S=await U.decrypt(h.enc,y);if(!S)return d();if(f.is={username:s,pub:p.pub,epub:p.epub,priv:S.priv,epriv:S.epriv},g!==""){let v=O.random(64),E=await U.work(g,v),T=await U.encrypt(S,E),$={username:s,pub:p.pub,epub:p.epub,auth:JSON.stringify({enc:T,salt:v})},j=await U.sign($,f.is),x=q(b,j.m,j.s,p.pub);t.put(x,A=>{a(A?`error putting ${$} on ${b}: ${A}`:null)});return}return a(null)},{wait:1e3})};if(u>9){a("Wrong username or password");return}let m="~@"+s;t.get({"#":m},async b=>{if(b.err){a(`error getting ${m}: ${b.err}`);return}let c=b.put&&b.put[m];if(!c)return k(s);delete b.put[m]._,r=Object.keys(c),d()},{wait:1e3})},f={create:(s,i,g)=>{let w=a=>{g?g(a):console.log(a)};if(n){w("User is already being created");return}if(s===""){w("Please provide a username");return}if(i===""){w("Please provide a password");return}n=!0;let k="~@"+s;t.get({"#":k},async a=>{if(a.err){n=!1,w(`error getting ${k}: ${a.err}`);return}if(a.put&&a.put[k]){n=!1,w("Username already exists");return}let d=O.random(64),m=await U.work(i,d),b=await U.pair(),c={priv:b.priv,epriv:b.epriv},p=await U.encrypt(c,m),h={username:s,pub:b.pub,epub:b.epub,auth:JSON.stringify({enc:p,salt:d})},y="~"+b.pub,S=await U.sign(h,b),v=q(y,S.m,S.s,b.pub);t.put(v,E=>{if(n=!1,E){w(`error putting ${h} on ${y}: ${E}`);return}let T={[y]:{"#":y}};t.put(q(k,T),$=>{if($){w(`error putting ${T} on ${k}: ${$}`);return}g&&g(null)})})},{wait:1e3})},auth:(s,i,g)=>{let w=k=>{g?g(k):k&&console.log(k)};if(o){w("User is already authenticating");return}if(f.is=null,s===""){w("Please provide a username");return}if(i===""){w("Please provide a password");return}o=!0,l(s,i,"",w)},change:(s,i,g,w)=>{let k=a=>{w?w(a):a&&console.log(a)};if(o){k("User is already authenticating");return}if(f.is=null,s===""){k("Please provide a username");return}if(i===""){k("Please provide a password");return}if(g===""){k("Please provide a new password");return}o=!0,l(s,i,g,k)},store:s=>{if(!f.is){console.log("Please authenticate before calling store");return}if(s){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(f.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(f.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let s=globalThis.localStorage.getItem("user.is");if(s){f.is=JSON.parse(s);return}}if(typeof globalThis.sessionStorage<"u"){let s=globalThis.sessionStorage.getItem("user.is");s&&(f.is=JSON.parse(s))}},leave:()=>{f.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(s,i,g)=>{let w=k=>{g?g(k):console.log(k)};if(o){w("User is already authenticating");return}if(s===""){w("Please provide a username");return}if(i===""){w("Please provide a password");return}o=!0,l(s,i,"",async k=>{if(k){w(k);return}let a={username:null,pub:null,epub:null,auth:null},d=await U.sign(a,f.is),m="~"+f.is.pub,b=q(m,d.m,d.s,f.is.pub);t.put(b,c=>{if(c){w(`error putting null on ${m}: ${c}`);return}f.is=null,g&&g(null)})})}};return f},Ie=Ye;var Qe=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:N.is(e)||(e={});let t=le(e),r=Ie(null,t),n=new Map,o=new Map,u=s=>s===null||s===!0||s===!1||typeof s=="string"||C.is(s)||te.is(s),l=s=>{if(u(s))return!0;if(N.is(s)){let g=[];for(let[w,k]of Object.entries(s)){if(w==="_")return"error underscore cannot be used as a property name";if(N.is(k)||u(k)){g.push(w);continue}return typeof k>"u"?`error undefined ${w} cannot be converted to a graph`:`error ${JSON.stringify({[w]:k})} cannot be converted to a graph`}if(g.length!==0)return g}return`error ${JSON.stringify(s)} cannot be converted to a graph`},f=s=>{let i=(a,d,m,b)=>{t.get(N.put(a,"#",d),async c=>{if(c.err&&console.log(c.err),c.put&&c.put[d]){delete c.put[d]._,delete c.put[d][R],delete c.put[d][K];for(let p of Object.keys(c.put[d])){let h=C.is(c.put[d][p]);if(h){let y=await new Promise(S=>{let v=O.random();o.set(v,{chain:[{item:null,soul:h}]}),f(v).next(null,S,b)});c.put[d][p]=y}}m(c.put[d])}else m(null)},b)},g=async(a,d,m,b)=>{if(m){let c=await U.sign(d,m);return q(a,c.m,c.s,m.pub)}return e.secure?(b||(b=console.log),b(`error putting data on ${a}: user required in secure mode`),null):q(a,d)},w=a=>d=>{let m=o.get(a);m&&typeof m.cb<"u"?setTimeout(()=>m.cb(d),1):d&&console.log("error no callback for data",d,"ctx",m),m&&!m.on&&o.delete(a)},k=(a,d)=>{if(!a){console.log("error resolve request parameter required");return}let m=typeof a.get<"u",b=typeof a.put<"u",c=typeof a.on<"u",p=typeof a.off<"u",h=!1,y=o.get(s);for(var S=1;S<y.chain.length;S++)if(y.chain[S].soul===null){h=!0;break}if(h){let{item:v,soul:E}=y.chain[S-1],T=y.user||e.secure?{"#":E}:{"#":E,".":v};return t.get(T,async $=>{if($.err){y.user||e.secure?console.log(`error getting ${E}: ${$.err}`):console.log(`error getting ${v} on ${E}: ${$.err}`),d&&d(null);return}let j=$.put&&$.put[E];if(j&&typeof j[v]<"u"){let x=C.is(j[v]);if(x)y.chain[S].soul=x,o.set(s,{...y}),m?f(s).next(null,a.get,d,a._opt):b?f(s).put(a.put,d):c?f(s).on(a.on,d,a._get,a._opt):p&&f(s).off(d);else if(m)d(j[v]);else if(b){x=O.random(),j[v]=C.ify(x);let A=await g(E,j,y.user,d);if(A===null)return;t.put(A,_=>{if(_){d(`error putting ${v} on ${E}: ${_}`);return}y.chain[S].soul=x,f(s).put(a.put,d)})}else(c||p&&d)&&d(null)}else if(b){let x=O.random();j||(j={}),j[v]=C.ify(x);let A=await g(E,j,y.user,d);if(A===null)return;t.put(A,_=>{if(_){d(`error putting ${v} on ${E}: ${_}`);return}y.chain[S].soul=x,f(s).put(a.put,d)})}else d&&d(null)},a._opt),!1}return m&&y.chain[y.chain.length-1].item!==null?(y.chain.push({item:null,soul:null}),f(s).next(null,a.get,d,a._opt),!1):y.chain[y.chain.length-1]};return{get:(a,d,m,b)=>{if(typeof d=="function"&&(b=m,m=d,d=null),a===null||a===""||a==="_"){console.log("error please provide a key"),m&&m(null);return}if(d&&typeof m!="function"){console.log("error lex requires a callback function");return}if(s=O.random(),o.set(s,{chain:[{item:a,soul:"root"}],cb:m}),!m)return f(s);let c=w(s),{soul:p}=k({get:d,_opt:b},c);p&&i(d,p,c,b)},next:(a,d,m,b)=>{let c=S=>v=>{m?m(v):w(S)(v)};if(typeof d=="function"&&(b=m,m=d,d=null),!s){console.log("error please provide a key using get(key)"),m&&m(null);return}let p=c(s);if(a===""||a==="_"){p(null);return}if(d&&typeof m!="function"){console.log("error lex requires a callback function");return}let h=o.get(s);if(!h)return;if(m&&typeof h.cb>"u"&&(h.cb=m,m=null),a!==null&&h.chain.push({item:a,soul:null}),!h.cb)return f(s);let{soul:y}=k({get:d,_opt:b},p);y&&i(d,y,p,b)},put:(a,d,m)=>{typeof d=="function"&&(m=d,d=!1);let b=E=>T=>{m?m(T):w(E)(T)};if(!s){m&&m("error please provide a key using get(key)");return}let c=o.get(s);if(!c)return;if(!c.cb){if(!m)return;c.cb=m,m=null}d&&(a={[O.random()]:a});let p=b(s),h=l(a);if(typeof h=="string"){p(h);return}let{item:y,soul:S}=k({put:a},p);if(!S)return;if(h===!0){let E=c.user||e.secure?{"#":S}:{"#":S,".":y};t.get(E,async T=>{if(T.err){p(`error getting ${S}: ${T.err}`);return}let $=T.put&&T.put[S],j=$&&$[y],x=C.is(j);if(!x){$||($={}),$[y]=a;let A=await g(S,$,c.user,p);if(A===null)return;t.put(A,p);return}t.get({"#":x},async A=>{if(A.err){p(`error getting ${x}: ${A.err}`);return}if(!A.put||!A.put[x]){p(`error ${x} not found`);return}for(let M of Object.keys(A.put[x])){if(M==="_"||M===R||M===K)continue;let P=await new Promise(fe=>{let he=O.random(),Ne=[{item:M,soul:x}];o.set(he,{chain:Ne,user:c.user}),f(he).put(null,fe)});if(P){p(P);return}}$||($={}),$[y]=a;let _=await g(S,$,c.user,p);_!==null&&t.put(_,p)})});return}let v=c.user||e.secure?{"#":S}:{"#":S,".":y};t.get(v,async E=>{if(E.err){p(`error getting ${S}.${y}: ${E.err}`);return}let T=E.put&&E.put[S],$=T&&T[y],j=C.is($);if(!j){T||(T={}),T[y]=C.ify(O.random());let A=await g(S,T,c.user,p);if(A===null)return;t.put(A,_=>{if(_)p(`error putting ${y} on ${S}: ${_}`);else{let M=O.random(),P=[{item:y,soul:S}];o.set(M,{chain:P,user:c.user,cb:c.cb}),f(M).put(a)}});return}let x=[];for(let A of h){let _=await new Promise(M=>{if(N.is(a[A])&&!C.is(a[A])){let P=O.random(),fe=[{item:A,soul:j}];o.set(P,{chain:fe,user:c.user}),f(P).put(a[A],M)}else x.push(A),M(null)});if(_){p(_,s);return}}if(x.length===0){p(null);return}t.get({"#":j},async A=>{if(A.err){p(`error getting ${j}: ${A.err}`);return}let _=A.put&&A.put[j];_||(_={}),x.forEach(P=>{_[P]=a[P]});let M=await g(j,_,c.user,p);M!==null&&t.put(M,p)})})},on:(a,d,m,b)=>{if(typeof a=="function"&&(b=m,m=d,d=a,a=null),typeof d!="function"){console.log("error on() requires a callback function");return}if(!s){console.log("error please provide a key using get(key)"),d(null);return}let{item:c,soul:p}=k({on:a,_get:m,_opt:b},d);p&&(o.set(s,{chain:[{item:c,soul:p}],on:!0}),n.set(d,()=>f(s).next(null,d,b)),t.get({"#":p,".":c},h=>{if(h.err){console.log(`error getting ${p}.${c}: ${h.err}`);return}let y=h.put&&h.put[p]&&h.put[p][c],S=C.is(y);S?a?a=N.put(a,"#",S):a={"#":S,".":null}:a?a=N.put(a,"#",p):a={"#":p,".":c},t.on(a,n.get(d),m,b)},b))},off:a=>{if(!s){console.log("error please provide a key using get(key)"),a&&a(null);return}let{item:d,soul:m}=k({off:!0},a);m&&t.get({"#":m,".":d},b=>{if(b.err){console.log(`error getting ${m}.${d}: ${b.err}`);return}let c=b.put&&b.put[m]&&b.put[m][d],p=C.is(c);p?t.off({"#":p},n.get(a)):t.off({"#":m},n.get(a)),n.delete(a),o.delete(s)})},user:()=>(r.get||(Object.assign(r,f()),r.get=(a,d,m,b)=>{typeof d=="function"&&(b=m,m=d,d=null);let c=null,p=null;if(r.is&&(c=r.is.pub),typeof a=="string"?p=a:a instanceof Array&&(a.length===2?(c=a[0],p=a[1]):a.length===1&&(p=a[0])),!c){console.log("error please log in or provide a public key"),m&&m(null);return}if(p===null||p===""||p==="_"){console.log("error please provide a key"),m&&m(null);return}if(d&&!m){console.log("error lex requires a callback function");return}s=O.random();let h=[{item:p,soul:"~"+c}];if(o.set(s,{chain:h,user:r.is,cb:m}),!m)return f(s);let y=w(s),{soul:S}=k({get:d,_opt:b},y);S&&i(d,S,y,b)}),r),wire:t,SEA:U}};return f()},xt=Qe;export{xt as default};
//# sourceMappingURL=holster.js.map
