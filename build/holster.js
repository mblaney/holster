var Q={is:e=>!(e instanceof Array)&&(e-parseFloat(e)+1>=0||e===1/0||e===-1/0)},E={is:e=>e?e instanceof Object&&e.constructor===Object||Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/)[1]==="Object":!1,map:(e,t,o)=>{var r=Object.keys(e);for(let n=0;n<r.length;n++){let u=t(e[r[n]],r[n],o);if(typeof u<"u")return u}},put:(e,t,o)=>(e||(e={}),e[t]=o,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Se=(e,t,o)=>{if(o.id){o.id=!1;return}if(t==="#"&&typeof e=="string"){o.id=e;return}o.id=!1},T={is:e=>{if(e&&e["#"]&&!e._&&E.is(e)){let t={};if(E.map(e,Se,t),t.id)return t.id}return!1},ify:e=>E.put({},"#",e)},J="_holster_user_public_key",W=(e,t,o,r)=>{let n={[e]:{_:{"#":e,">":{},s:o,p:r}}};for(let[u,l]of Object.entries(t))n[e][u]=l,n[e]._[">"][u]=Date.now();return r&&(n[e][J]=r,n[e]._[">"][J]=Date.now()),n},C={random:e=>{var t="";let o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let r=0;r<e;r++)t+=o.charAt(Math.floor(Math.random()*o.length));return t}};var ve=e=>{e||(e=9e3);let t={store:{}};return t.check=o=>t.store[o]?t.track(o):!1,t.track=o=>(t.store[o]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{let r=Date.now();Object.keys(t.store).forEach(n=>{r-t.store[n]>e&&delete t.store[n]}),t.expiry=null},e)),o),t},ue=ve;var ke=(e,t)=>{let o=e["#"],r=e["."];var n=t[o];if(!n||!r)return;let u=n[r];if(u)return n={_:n._,[r]:u},n._[">"]={[r]:n._[">"][r]},{[o]:n}},re=ke;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function X(){}Object.assign(X,{from:Array.from});X.prototype=Object.create(Array.prototype);X.prototype.toString=function(e,t,o){e||(e="utf8"),t||(t=0);let r=this.length;if(e==="hex"){let n=new Uint8Array(this);return[...Array((o&&o+1||r)-t).keys()].map(u=>n[u+t].toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:(o||r)-t},(n,u)=>String.fromCharCode(this[u+t])).join("");if(e==="base64")return btoa(this)};var M=X;function I(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),I.from(...e)}I.prototype=Object.create(Array.prototype);Object.assign(I,{from(){if(!Object.keys(arguments).length||arguments[0]==null)throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.");let e=arguments[0],t;if(typeof e=="string"){let r=arguments[1]||"utf8";if(r==="hex"){let n=e.match(/([\da-fA-F]{2})/g).map(u=>parseInt(u,16));if(!n||!n.length)throw new TypeError("Invalid first argument for type 'hex'.");t=M.from(n)}else if(r==="utf8"||r==="binary"){let n=e.length,u=new Uint16Array(n);Array.from({length:n},(l,s)=>u[s]=e.charCodeAt(s)),t=M.from(u)}else if(r==="base64"){let n=atob(e),u=n.length,l=new Uint8Array(u);Array.from({length:u},(s,i)=>l[i]=n.charCodeAt(i)),t=M.from(l)}else console.info("SafeBuffer.from unknown encoding: "+r);return t}if(e.byteLength?e.byteLength:e.length){let r;return e instanceof ArrayBuffer&&(r=new Uint8Array(e)),M.from(r||e)}},alloc(e,t=0){return M.from(new Uint8Array(Array.from({length:e},()=>t)))},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be Array containing ArrayBuffer or Uint8Array instances.");return M.from(e.reduce((t,o)=>t.concat(Array.from(o)),[]))}});I.prototype.from=I.from;I.prototype.toString=M.prototype.toString;var N=I;var xe=typeof document>"u",le=xe?(await import("node:crypto")).webcrypto:globalThis.crypto,_=le.subtle,Z=e=>typeof e=="string"?e:JSON.stringify(e),q=e=>{try{return JSON.parse(e)}catch{return e}},Y=e=>{let t=new Uint8Array(N.alloc(e));return N.from(le.getRandomValues(t))},z=(e,t)=>{let[o,r]=e.split(".");return{kty:"EC",crv:"P-256",x:o,y:r,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},V=async e=>{let t=await _.digest({name:"SHA-256"},new TextEncoder().encode(Z(e)));return N.from(t)},ne=async(e,t)=>{let o=e+t.toString("utf8"),r=N.from(await V(o),"binary"),n=je(r);return await _.importKey("jwk",n,{name:"AES-GCM"},!1,["encrypt","decrypt"])},je=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var $e={pair:async e=>{let t=await _.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async n=>{let u=await _.exportKey("jwk",n.publicKey);return{priv:(await _.exportKey("jwk",n.privateKey)).d,pub:u.x+"."+u.y}}),o=await _.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async n=>{let u=await _.exportKey("jwk",n.publicKey);return{epriv:(await _.exportKey("jwk",n.privateKey)).d,epub:u.x+"."+u.y}}),r={pub:t.pub,priv:t.priv,epub:o.epub,epriv:o.epriv};return e&&e(r),r},encrypt:async(e,t,o)=>{if(!t||!t.epriv)return o&&o(null),null;let r={s:Y(9),iv:Y(15)},n=await ne(t.epriv,r.s).then(l=>_.encrypt({name:"AES-GCM",iv:new Uint8Array(r.iv)},l,new TextEncoder().encode(Z(e)))),u={ct:N.from(n,"binary").toString("base64"),iv:r.iv.toString("base64"),s:r.s.toString("base64")};return o&&o(u),u},decrypt:async(e,t,o)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return o&&o(null),null;let r={ct:N.from(e.ct,"base64"),iv:N.from(e.iv,"base64"),s:N.from(e.s,"base64")};try{let n=await ne(t.epriv,r.s).then(l=>_.decrypt({name:"AES-GCM",iv:new Uint8Array(r.iv),tagLength:128},l,new Uint8Array(r.ct))),u=q(new TextDecoder("utf8").decode(n));return o&&o(u),u}catch{return o&&o(null),null}},verify:async(e,t,o)=>{if(!t||!t.pub)return o&&o(null),null;let r=q(e),n=await _.importKey("jwk",z(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),u={};if(typeof r.m=="string")u=r.m;else for(let a of Object.keys(r.m))a!=="_"&&a!=J&&(u[a]=r.m[a]);let l=await V(u),s=new Uint8Array(N.from(r.s,"base64")),i={name:"ECDSA",hash:{name:"SHA-256"}};if(await _.verify(i,n,s,new Uint8Array(l))){let a=q(r.m);return o&&o(a),a}return o&&o(null),null},sign:async(e,t,o)=>{if(!t||!t.pub||!t.priv)return o&&o(null),null;let r=q(e),n=await V(r),u=z(t.pub,t.priv),l={name:"ECDSA",namedCurve:"P-256"},s=await _.importKey("jwk",u,l,!1,["sign"]).then(a=>_.sign({name:"ECDSA",hash:{name:"SHA-256"}},a,new Uint8Array(n))),i={m:r,s:N.from(s,"binary").toString("base64")};return o&&o(i),i},work:async(e,t,o)=>{typeof t=="function"&&(o=t,t=void 0),typeof t>"u"&&(t=Y(9));let r=await _.importKey("raw",new TextEncoder().encode(Z(e)),{name:"PBKDF2"},!1,["deriveBits"]),n={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},u=await _.deriveBits(n,r,512),l={epriv:N.from(u,"binary").toString("base64")};return o&&o(l),l},secret:async(e,t,o)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return o&&o(null),null;let r={name:"ECDH",namedCurve:"P-256"},n=z(e.epub),u=await _.importKey("jwk",n,r,!0,[]),l=z(t.epub,t.epriv,!1);delete l.key_ops;let s=await _.importKey("jwk",l,r,!1,["deriveBits"]).then(async i=>{let a=await _.deriveBits({public:u,name:"ECDH",namedCurve:"P-256"},i,256),y=await _.importKey("raw",new Uint8Array(a),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return _.exportKey("jwk",y).then(({k:h})=>h)});return o&&o({epriv:s}),{epriv:s}}},K=$e;var Ae="",ie=(e,t,o,r)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof o!="string"&&(o=JSON.stringify(o)||""),typeof r!="string"&&(r=JSON.stringify(r)||""),o===r?{state:!0}:o<r?{current:!0}:{incoming:!0});ie.mix=async(e,t,o,r)=>{var n=Date.now(),u={},l={};let s=0;for(let i of Object.keys(e)){let a=e[i],y=!1,h=!1,b=0,d="",c=o;if(a._&&a._.s&&a._.p&&(c=!0),i.length>1&&i[0]==="~")if(i[1]==="@")h=!0,c=!1;else{if(a._&&a._.p&&i!="~"+a._.p){console.log(`error public key does not match for soul: ${i}`);continue}a._.p=i.slice(1),c=!0}if(c){if(!a._||!a._.s||!a._.p){console.log("error signature and public key required to verify data");continue}if(!await K.verify({m:a,s:a._.s},{pub:a._.p})){console.log(`error could not verify soul: ${i}`);continue}}for(let f of Object.keys(a)){if(f==="_")continue;let p=a[f],g=a._[">"][f],w=(t[i]||{})[f],S=(t[i]||{_:{">":{}}})._[">"][f]||0;if(h&&f!==T.is(p))continue;let m=g-n;if(m>0){if(m>864e5)continue;(s===0||m<s)&&(s=b=m),l[i]||(l[i]={_:{"#":i,">":{},s:a._.s,p:a._.p}}),l[i][f]=p,l[i]._[">"][f]=g}else ie(g,S,p,w).incoming&&(u[i]||(u[i]={_:{"#":i,">":{},s:a._.s,p:a._.p}}),t[i]||(t[i]={_:{"#":i,">":{},s:a._.s,p:a._.p}}),t[i][f]=u[i][f]=p,t[i]._[">"][f]=u[i]._[">"][f]=g,setTimeout(()=>{let v=i+Ae+f;r[v]&&r[v].forEach(x=>x())},100),y=!0)}c&&b!==0&&u[i]&&(Object.assign(l[i],u[i]),delete u[i]),y&&r[i]&&setTimeout(()=>{r[i].forEach(f=>f())},100)}return{now:u,defer:l,wait:s}};var oe=ie;var U="",G="",fe=()=>{let e=(t,o,r)=>{if(r||(e[U]||(e[U]={}),r=e[U]),!t)return r;let n=0,u={},l=t[n],s=t.length-1,i=typeof o>"u",a=r[l];for(;!a&&n<s;)l+=t[++n],a=r[l];if(a)if(n===s){if(i)return typeof a[G]>"u"?a[U]:a[G];a[G]=o}else return!a[U]&&!i&&(a[U]={}),e(t.slice(++n),o,a[U]);else if(E.map(r,(h,b)=>{let d=0,c="";for(;b[d]===t[d];)c+=b[d++];if(c){if(i)return d<=s?void 0:(u[b.slice(d)]=h,h);let f={[b.slice(d)]:h,[t.slice(d)]:{[G]:o}};return r[c]={[U]:f},delete r[b],!0}})){if(i)return u}else{if(i)return;r[l]||(r[l]={}),r[l][G]=o}};return e};fe.map=function e(t,o,r,n){n||(n=[]);var u=t[U]||t,l=Object.keys(u).sort(),s;for(let i=0;i<l.length;i++){let a=l[i],y=u[a],h=y[G];if(typeof h<"u"){if(h=o(h,n.join("")+a,a,n),typeof h<"u")return h}else r&&o(s,n.join(""),a,n);if(y[U]){if(n.push(a),h=e(y[U],o,r,n),typeof h<"u")return h;n.pop()}}};var B=fe;var ce="",ae="",A="",R=e=>{var t,o=null;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=10*1e3),e.write||(e.write=1),e.size||(e.size=1024*1024),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let r=(n,u,l)=>{if(n=""+n,typeof u=="function")return l=u,u=r.batch(n),typeof u<"u"||r.thrash.at&&(u=r.thrash.at(n),typeof u<"u")?l(t,u):r.read(n,l);if(r.batch(n,u),l&&r.batch.acks.push(l),++r.batch.ed>=e.batch)return r.thrash();clearTimeout(r.batch.timeout),r.batch.timeout=setTimeout(r.thrash,e.write)};return r.batch=B(),r.batch.acks=[],r.batch.ed=0,r.thrash=()=>{if(r.thrash.ing)return r.thrash.more=!0;clearTimeout(r.batch.timeout),r.thrash.more=!1,r.thrash.ing=!0;var n=r.thrash.at=r.batch;r.batch=null,r.batch=B(),r.batch.acks=[],r.batch.ed=0;let u=0;r.save(n,l=>{++u>1||(l&&e.log(l),n.acks.forEach(s=>s(l)),r.thrash.at=null,r.thrash.ing=!1,r.thrash.more&&r.thrash())})},r.save=(n,u)=>{let l={find:(s,i)=>{if(!(i<l.start))return l.start=i,e.store.list(l.lex),!0},lex:s=>{if(!s||s>l.start)return l.end=s,l.mix(l.file||"!",l.start,l.end),!0;l.file=s},mix:(s,i,a)=>{l.start=l.end=l.file=t,r.parse(s,(y,h)=>{if(y)return u(y);B.map(n,(b,d)=>{if(!(d<i)){if(a&&a<d)return l.start=d,l.start;h(d,b)}}),r.write(s,h,l.next)})},next:s=>{if(s)return u(s);if(l.start)return B.map(n,l.find);u(s)}};B.map(n,l.find)},r.write=(n,u,l)=>{o=null;let s={text:"",count:0,file:n,each:(i,a,y,h)=>{s.count++;var b=R.encode(h.length)+"#"+R.encode(y)+(typeof i>"u"?"":"="+R.encode(i))+`
`;if(s.count>1&&s.text.length+b.length>e.size)return s.text="",s.limit=Math.ceil(s.count/2),s.count=0,s.sub=B(),B.map(u,s.slice),!0;s.text+=b},put:()=>{e.store.put(n,s.text,l)},slice:(i,a)=>{if(!(a<s.file)){if(++s.count>s.limit){var y=s.file;let h=a.indexOf(ae);return h===-1?s.file=a:s.file=a.substring(0,h),s.sub(s.file,null),s.count=0,r.write(y,s.sub,s.next),!0}s.sub(a,i)}},next:i=>{if(i)return l(i);s.sub=B(),B.map(u,s.slice)||r.write(s.file,s.sub,l)}};B.map(u,s.each,!0)||s.put()},r.read=(n,u)=>{if(o){let a=o(n);if(typeof a<"u")return u(t,a)}let l=n,s=n.indexOf(ae);s!==-1&&(l=n.substring(0,s));let i={lex:a=>{if(!a){if(!i.file){u("no file found",t);return}r.parse(i.file,i.it);return}a>l||a<i.file||(i.file=a)},it:(a,y)=>{a&&e.log(a),y&&(o=y,i.value=y(n)),u(a,i.value)}};e.store.list(i.lex)},r.parse=(n,u)=>{let l={disk:B(),read:(s,i)=>{if(s)return u(s);if(!i)return u(t,l.disk);let a=[],y=l.split(i);for(;y;){let h,b,d=y[1];y=l.split(y[2])||"",y[0]==="#"&&(h=y[1],a=a.slice(0,d),d<=a.length&&a.push(h)),y=l.split(y[2])||"",y[0]!==`
`&&(y[0]==="="&&(b=y[1]),typeof h<"u"&&typeof b<"u"&&l.disk(a.join(""),b),y=l.split(y[2]))}u(t,l.disk)},split:s=>{if(!s)return;let i=-1,a="",y=null;for(;(y=s[++i])&&y!==A;)a+=y;let h={};if(y)return[a,R.decode(s.slice(i),h),s.slice(i+h.i)]}};e.store.get(n,l.read)},r};R.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=ce+e[1],e=e[0]),typeof e=="string"){let r=0,n=null,u=A;for(;n=e[r++];)n===A&&(u+=A);return u+'"'+e+t+A}let o=T.is(e);if(o)return A+"#"+o+t+A;if(Q.is(e))return A+"+"+(e||0)+t+A;if(e===!0)return A+"+"+t+A;if(e===!1)return A+"-"+t+A;if(e===null)return A+" "+t+A};R.decode=(e,t)=>{var o="",r=-1,n=0,u=null,l=null;if(e[0]!==A)return;for(;u=e[++r];)if(l){if(u===A&&--n<=0)break;o+=u}else u===A?n++:l=u||!0;t&&(t.i=r+1);let[s,i]=o.split(ce);if(i){if(i=parseFloat(i),l==='"')return[s,i];if(l==="#")return[T.ify(s),i];if(l==="+")return s.length===0?[!0,i]:[parseFloat(s),i];if(l==="-")return[!1,i];if(l===" ")return[null,i]}else{if(l==='"')return o;if(l==="#")return T.ify(o);if(l==="+")return o.length===0?!0:parseFloat(o);if(l==="-")return!1;if(l===" ")return null}};var pe=R;var ge=typeof document>"u",F=ge?await import("node:fs"):void 0,de="",ee="",se=ee+"+0"+ee+"#"+ee+'"root'+ee,Oe=e=>{let t=e.file;if(ge)return F.existsSync(t)||F.mkdirSync(t),F.existsSync(t+"/!")||F.writeFileSync(t+"/!",se),{get:(o,r)=>{F.readFile(t+"/"+o,(n,u)=>{if(n){if(n.code==="ENOENT"){r();return}console.log("fs.readFile error:",n)}u&&(u=u.toString()),r(n,u)})},put:(o,r,n)=>{var u=Math.random().toString(36).slice(-9),l=o+"."+u+".tmp";F.writeFile(l,r,s=>{if(s){n(s);return}F.rename(l,t+"/"+o,n)})},list:o=>{F.readdir(t,(r,n)=>{n.forEach(o),o()})}};if(e.indexedDB){let o,r=indexedDB.open(t,1);return r.onupgradeneeded=n=>{n.target.result.createObjectStore(t)},r.onerror=n=>{console.log(n)},r.onsuccess=()=>{if(o=r.result,o){let u=o.transaction([t],"readonly").objectStore(t).getKey("!");u.onerror=()=>{console.log(`error getting key ${t}/!`)},u.onsuccess=()=>{if(!u.result){let s=o.transaction([t],"readwrite").objectStore(t).put(se,"!");s.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(n,u)=>{if(o){let s=o.transaction([t],"readonly").objectStore(t).get(n);s.onerror=()=>{console.log(`error getting ${t}/${n}`)},s.onsuccess=()=>{u(null,s.result)}}else u("error indexedDB not available")},put:(n,u,l)=>{if(o){let i=o.transaction([t],"readwrite").objectStore(t).put(u,n);i.onerror=()=>{console.log(`error putting data on ${t}/${n}`)},i.onsuccess=()=>{l(null)}}else l("error indexedDB not available")},list:n=>{if(o){let l=o.transaction([t],"readonly").objectStore(t).getAllKeys();l.onerror=()=>console.log("error getting keys for",t),l.onsuccess=()=>{l.result.forEach(n),n()}}else console.log("error indexedDB not available"),n()}}}return{get:(o,r)=>{r(null,se)},put:(o,r,n)=>{n(null)},list:o=>{o("!"),o()}}},Ce=e=>{E.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Oe(e));let t=pe(e);return{get:(o,r)=>{if(!o){r("lex required");return}var n=o["#"],u=o["."]||"",l;let s=(i,a)=>{l||(l={_:{"#":n,">":{}}}),l[a]=i[0],l._[">"][a]=i[1]};t(n+de+u,(i,a)=>{let y;E.is(a)?(B.map(a,s),l||s(a,u),y={[n]:l}):a&&(s(a,u),y={[n]:l}),r(i,y)})},put:(o,r)=>{if(!o){r("graph required");return}var n=0;let u=l=>{if(n--,!u.err){if(u.err=l,u.err){r(u.err);return}n===0&&r(null)}};Object.keys(o).forEach(l=>{var s=o[l];Object.keys(s).forEach(i=>{if(i==="_")return;n++;let a=s[i],y=s._[">"][i];t(l+de+i,[a,y],u)})})}}},ye=Ce;var me=typeof document>"u",we=me?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=we?.WebSocket);var he="",Ee=e=>{E.is(e)||(e={});let t=ue(e.maxAge),o=ye(e),r={},n={},u={},l=async(c,f,p)=>{for(let g of Object.keys(c)){let w=await new Promise(k=>{a({"#":g},k,f)});if(w.err)return p&&p(w.err),!1;let S=c[g],m=J;if(!(!w.put||!w.put[g]||w.put[g][m]===S._.p))return p&&p(`error in wire check public key does not match for soul: ${g}`),!1}return!0},s=(c,f)=>{let p=re(c.get,r);p?f(JSON.stringify({"#":t.track(C.random(9)),"@":c["#"],put:p})):o.get(c.get,(g,w)=>{f(JSON.stringify({"#":t.track(C.random(9)),"@":c["#"],put:w,err:g}))})},i=async(c,f)=>{if(!await l(c.put,f))return;let p=await oe.mix(c.put,r,e.secure,u);o.put(p.now,g=>{f(JSON.stringify({"#":t.track(C.random(9)),"@":c["#"],err:g}))}),p.wait!==0&&setTimeout(()=>i({put:p.defer},f),p.wait)},a=(c,f,p,g)=>{if(!f)return;E.is(g)||(g={});let w=re(c,r);if(w){f({put:w});return}o.get(c,(S,m)=>{if(m){f({put:m,err:S});return}S&&console.log(S);let k=C.random(9);n[k]=f,p(JSON.stringify({"#":t.track(k),get:c})),setTimeout(()=>{let v=n[k];if(v){let x=c["#"],$={[x]:null};c["."]&&($[x]={[c["."]]:null}),v({put:$}),delete n[k]}},g.wait||100)})},y=c=>({get:(f,p,g)=>{a(f,p,c,g)},put:async(f,p)=>{if(!await l(f,c,p))return;let g=await oe.mix(f,r,e.secure,u);o.put(g.now,p),c(JSON.stringify({"#":t.track(C.random(9)),put:f}))},on:(f,p)=>{if(!p)return;let g=f["#"];g&&(f["."]&&(g+=he+f["."]),u[g]?u[g].includes(p)||u[g].push(p):u[g]=[p])},off:(f,p)=>{let g=f["#"];g&&(f["."]&&(g+=he+f["."]),u[g]&&(p?u[g].includes(p)&&u[g].splice(u[g].indexOf(p),1):delete u[g]))}});if(me){let c=e.wss,f=()=>c.clients();c||(c=new we.WebSocketServer({port:8080}),f=()=>c.clients);let p=(g,w)=>{f().forEach(S=>{S.readyState===WebSocket.OPEN&&S.send(g,{binary:w})})};return c.on("connection",g=>{g.on("error",console.error),g.on("message",(w,S)=>{let m=JSON.parse(w);if(t.check(m["#"]))return;t.track(m["#"]),m.get&&s(m,p),m.put&&i(m,p),p(w,S);let k=m["@"],v=n[k];v&&(delete m["#"],delete m["@"],v(m),delete n[k])})}),y(p)}let h=new WebSocket("ws://localhost:8080"),b=c=>{if(!h||h.readyState!==WebSocket.OPEN){console.log("websocket not available");return}h.send(c)},d=()=>{h||(h=new WebSocket("ws://localhost:8080")),h.onclose=c=>{h=null,setTimeout(d,Math.floor(Math.random()*5e3))},h.onerror=c=>{console.error(c)},h.onmessage=c=>{let f=JSON.parse(c.data);if(t.check(f["#"]))return;t.track(f["#"]),f.get&&s(f,b),f.put&&i(f,b),b(c.data);let p=f["@"],g=n[p];g&&(delete f["#"],delete f["@"],g(f),delete n[p])}};return d(),y(b)},te=Ee;var Te=(e,t)=>{t||(t=te(e));let o=[],r=!1,n=!1,u=0,l=(i,a,y,h)=>{let b=p=>{u++,l(p,a,y,h)},d=p=>{o=[],u=0,n=!1,h(p)},c=()=>{if(o.length===0){d("Wrong username or password");return}let p=o.shift();t.get({"#":p},async g=>{if(g.err){d(`error getting ${p}: ${g.err}`);return}let w=g.put&&g.put[p];if(!w||!w.auth)return c();let S=JSON.parse(w.auth),m=await K.work(a,S.salt),k=await K.decrypt(S.enc,m);if(!k)return c();if(s.is={username:i,pub:w.pub,epub:w.epub,priv:k.priv,epriv:k.epriv},s.ctx="~"+w.pub,y!==""){let v=C.random(64),x=await K.work(y,v),$=await K.encrypt(k,x),j={auth:JSON.stringify({enc:$,salt:v})},O=await K.sign(j,s.is),D=W(p,O.m,O.s,w.pub);t.put(D,P=>{d(P?`error putting ${j} on ${p}: ${P}`:null)});return}return d(null)})};if(u>9){d("Wrong username or password");return}let f="~@"+i;t.get({"#":f},async p=>{if(p.err){d(`error getting ${f}: ${p.err}`);return}let g=p.put&&p.put[f];if(!g)return b(i);delete p.put[f]._,o=Object.keys(g),c()})},s={create:(i,a,y)=>{let h=d=>{y?y(d):console.log(d)};if(r){h("User is already being created");return}if(i===""){h("Please provide a username");return}if(a===""){h("Please provide a password");return}r=!0;let b="~@"+i;t.get({"#":b},async d=>{if(d.err){r=!1,h(`error getting ${b}: ${d.err}`);return}if(d.put&&d.put[b]){r=!1,h("Username already exists");return}let c=C.random(64),f=await K.work(a,c),p=await K.pair(),g={priv:p.priv,epriv:p.epriv},w=await K.encrypt(g,f),S={username:i,pub:p.pub,epub:p.epub,auth:JSON.stringify({enc:w,salt:c})},m="~"+p.pub,k=await K.sign(S,p),v=W(m,k.m,k.s,p.pub);t.put(v,x=>{if(r=!1,x){h(`error putting ${S} on ${m}: ${x}`);return}let $={[m]:{"#":m}};t.put(W(b,$),j=>{if(j){h(`error putting ${$} on ${b}: ${j}`);return}y&&y(null)})})})},auth:(i,a,y)=>{let h=b=>{y?y(b):b&&console.log(b)};if(n){h("User is already authenticating");return}if(s.is=null,i===""){h("Please provide a username");return}if(a===""){h("Please provide a password");return}n=!0,l(i,a,"",h)},change:(i,a,y,h)=>{let b=d=>{h?h(d):d&&console.log(d)};if(n){b("User is already authenticating");return}if(s.is=null,i===""){b("Please provide a username");return}if(a===""){b("Please provide a password");return}if(y===""){b("Please provide a new password");return}n=!0,l(i,a,y,b)},store:i=>{if(!s.is){console.log("Please authenticate before calling store");return}if(i){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(s.is));return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(s.is))},recall:i=>{if(i){if(typeof globalThis.localStorage<"u"){let a=globalThis.localStorage.getItem("user.is");a?(s.is=JSON.parse(a),s.ctx="~"+s.is.pub):console.log("User credentials not stored in local storage")}return}if(typeof globalThis.sessionStorage<"u"){let a=globalThis.sessionStorage.getItem("user.is");a?(s.is=JSON.parse(a),s.ctx="~"+s.is.pub):console.log("User credentials not stored in session storage")}},leave:()=>{s.is=null,s.ctx=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(i,a,y)=>{let h=b=>{y?y(b):console.log(b)};if(n){h("User is already authenticating");return}if(i===""){h("Please provide a username");return}if(a===""){h("Please provide a password");return}n=!0,l(i,a,"",async b=>{if(b){h(b);return}let d={username:null,pub:null,epub:null,auth:null},c=await K.sign(d,s.is),f="~"+s.is.pub,p=W(f,c.m,c.s,s.is.pub);t.put(p,g=>{if(g){h(`error putting null on ${f}: ${g}`);return}s.is=null,s.ctx=null,y&&y(null)})})}};return s},be=Te;var Ke=e=>{let t=te(e),o=be(null,t),r=new Map,n=new Map,u=i=>i===null||i===!0||i===!1||typeof i=="string"||T.is(i)||Q.is(i),l=i=>{if(u(i))return!0;if(E.is(i)){let a=[];for(let[y,h]of Object.entries(i)){if(y==="_")return"error underscore cannot be used as an item name";if(E.is(h)||u(h)){a.push(y);continue}return`error {${y}:${h}} cannot be converted to graph`}if(a.length!==0)return a}return`error ${i} cannot be converted to a graph`},s=i=>{let a=(d,c,f)=>{t.get(E.put(d,"#",c),async p=>{if(p.err&&console.log(p.err),p.put&&p.put[c]){delete p.put[c]._,delete p.put[c][J];for(let g of Object.keys(p.put[c])){let w=T.is(p.put[c][g]);if(w){let S=await new Promise(m=>{let k=C.random();n.set(k,{chain:[{item:null,soul:w}]}),s(k).next(null,m)});p.put[c][g]=S}}f(p.put[c])}else f(null)})},y=async(d,c,f)=>{if(f||(f=console.log),!o.is)return e.secure?(f(`error putting data on ${d}: user required in secure mode`),null):W(d,c);if(!o.is)return f(`error putting data on ${d}: user not authenticated`),null;let p=await K.sign(c,o.is);return W(d,p.m,p.s,o.is.pub)},h=d=>{let c=n.get(i);c&&typeof c.cb<"u"?c.cb(d):d&&console.log(d),c.on||n.delete(i)},b=(d,c)=>{let f=d&&typeof d.get<"u",p=d&&typeof d.put<"u",g=d&&typeof d.on<"u",w=d&&typeof d.off<"u",S=!1,m=n.get(i);for(var k=1;k<m.chain.length;k++)if(m.chain[k].soul===null){S=!0;break}if(S){let{item:v,soul:x}=m.chain[k-1];return t.get({"#":x,".":v},async $=>{if($.err){console.log(`error getting ${v} on ${x}: ${$.err}`),c&&c(null);return}let j=$.put&&$.put[x];if(j&&typeof j[v]<"u"){let O=T.is(j[v]);if(O)m.chain[k].soul=O,n.set(i,{chain:m.chain,cb:m.cb}),f?s(i).next(null,d.get,c):p?s(i).put(d.put,c):g?s(i).on(c):w&&s(i).off(c);else if(f)c(j[v]);else if(p){O=C.random();let D={[v]:T.ify(O)},P=await y(x,D,c);if(P===null)return;t.put(P,L=>{if(L){c(`error putting ${v} on ${x}: ${L}`);return}m.chain[k].soul=O,s(i).put(d.put,c)})}else g?(console.log(`error resolving on for ${v} on ${x}`),c(null)):w&&(console.log(`error resolving off for ${v} on ${x}`),c&&c(null))}else p?c(`error ${v} not found on ${x}`):(console.log(`error ${v} not found on ${x}`),c&&c(null))}),!1}return f&&m.chain[m.chain.length-1].item!==null?(m.chain.push({item:null,soul:null}),s(i).next(null,d.get,c),!1):m.chain[m.chain.length-1]};return{get:(d,c,f)=>{if(typeof c=="function"&&(f=c,c=null),d===null||d===""||d==="_"){f&&f(null);return}let p=o.ctx?o.ctx:"root";if(i=C.random(),n.set(i,{chain:[{item:d,soul:p}],cb:f}),!f)return s(i);let{soul:g}=b({get:c},h);g&&a(c,g,h)},next:(d,c,f)=>{let p=S=>{f?f(S):h(S)};if(typeof c=="function"&&(f=c,c=null),!i){console.log("please provide a key using get(key)"),p(null);return}let g=n.get(i);if(!g)return;if(f&&typeof g.cb>"u"&&(g.cb=f,f=null),d===""||d==="_"){p(null);return}if(d!==null&&g.chain.push({item:d,soul:null}),!g.cb)return s(i);let{soul:w}=b({get:c},p);w&&a(c,w,p)},put:(d,c)=>{let f=m=>{c?c(m):h(m)};if(!i){f("please provide a key using get(key)");return}let p=n.get(i);if(!p)return;if(!p.cb){if(!c)return;p.cb=c,c=null}let g=l(d);if(typeof g=="string"){f(g);return}let{item:w,soul:S}=b({put:d},f);if(S){if(g===!0){t.get({"#":S,".":w},async m=>{if(m.err){console.log(`error getting ${S}: ${m.err}`);return}let k=m.put&&m.put[S]&&m.put[S][w],v=T.is(k);if(!v){let x=await y(S,{[w]:d},f);if(x===null)return;t.put(x,f);return}t.get({"#":v},async x=>{if(x.err){console.log(`error getting ${v}: ${x.err}`);return}if(!x.put||!x.put[v]){console.log(`error ${v} not found`);return}delete x.put[v]._;for(let j of Object.keys(x.put[v])){if(j===J)continue;let O=await new Promise(D=>{let P=C.random();n.set(P,{chain:[{item:j,soul:v}]}),s(P).put(null,D)});if(O){f(O);return}}let $=await y(S,{[w]:d},f);$!==null&&t.put($,f)})});return}t.get({"#":S,".":w},async m=>{if(m.err){f(`error getting ${S}.${w}: ${m.err}`);return}let k=m.put&&m.put[S]&&m.put[S][w],v=T.is(k);if(!v){let j={[w]:T.ify(C.random())},O=await y(S,j,f);if(O===null)return;t.put(O,D=>{if(D)f(`error putting ${w} on ${S}: ${D}`);else{let P=C.random(),L=[{item:w,soul:S}];n.set(P,{chain:L,cb:p.cb}),s(P).put(d)}});return}let x=!1,$={};for(let j of g){let O=await new Promise(D=>{if(E.is(d[j])){let P=C.random();n.set(P,{chain:[{item:j,soul:v}]}),s(P).put(d[j],D)}else x=!0,$[j]=d[j],D(null)});if(O){f(O);return}}if(x){let j=await y(v,$,f);if(j===null)return;t.put(j,f)}else f()})}},on:d=>{if(!d)return;if(!i){console.log("please provide a key using get(key)"),d(null);return}let{item:c,soul:f}=b({on:!0},d);f&&(n.set(i,{chain:[{item:c,soul:f}],on:!0}),r.set(d,()=>s(i).next(null,d)),t.get({"#":f,".":c},p=>{if(p.err){console.log(`error getting ${f}.${c}: ${p.err}`);return}let g=p.put&&p.put[f]&&p.put[f][c],w=T.is(g);w?t.on({"#":w},r.get(d)):t.on({"#":f,".":c},r.get(d))}))},off:d=>{if(!i){console.log("please provide a key using get(key)"),d&&d(null);return}let{item:c,soul:f}=b({off:!0},d);f&&t.get({"#":f,".":c},p=>{if(p.err){console.log(`error getting ${f}.${c}: ${p.err}`);return}let g=p.put&&p.put[f]&&p.put[f][c],w=T.is(g);w?t.off({"#":w},r.get(d)):t.off({"#":f,".":c},r.get(d)),r.delete(d),n.delete(i)})},user:d=>(d&&(o.ctx="~"+d),Object.assign(o,s())),wire:t,SEA:K}};return s()},ut=Ke;export{ut as default};
//# sourceMappingURL=holster.js.map
