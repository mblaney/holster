var fe={is:e=>{if(e instanceof Array)return!1;if(typeof e=="number")return!isNaN(e);if(typeof e=="string"){let t=parseFloat(e);return!isNaN(t)&&isFinite(t)}return!1}},B={is:e=>{if(!e||typeof e!="object")return!1;let r=Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/);return e.constructor===Object||r&&r[1]==="Object"},map:(e,t,r)=>{var n=Object.keys(e);for(let i=0;i<n.length;i++){let s=t(e[n[i]],n[i],r);if(typeof s<"u")return s}},put:(e,t,r)=>(e||(e={}),e[t]=r,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Be=(e,t,r)=>{if(r.id){r.id=!1;return}if(t==="#"&&typeof e=="string"){r.id=e;return}r.id=!1},U={is:e=>{if(e&&e["#"]&&!e._&&B.is(e)){let t={};if(B.map(e,Be,t),t.id)return t.id}return!1},ify:e=>B.put({},"#",e)},W="_holster_user_signature",L="_holster_user_public_key",X=(e,t,r,n,i)=>{let s={[e]:{_:{"#":e,">":{}}}};for(let[m,p]of Object.entries(t))m!=="_"&&m!==L&&m!==W&&(s[e][m]=p,s[e]._[">"][m]=i||Date.now());if(r&&n&&i){if(s[e]._.s={},typeof r=="string")s[e]._.s[i]=r;else if(typeof r=="object")for(let[m,p]of Object.entries(r))s[e]._.s[m]=p;s[e][L]=n,s[e]._[">"][L]=i}return s},ee=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!B.is(e)||!t)return!1;let r=e["*"];if(r)return t.slice(0,r.length)===r;let n=e[">"],i=e["<"];return n&&i?t>=n&&t<=i:n?t>=n:i?t<=i:!1},P={random:e=>{var t="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let n=0;n<e;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}};var Ke=e=>{e||(e=9e3);let t={store:{}};return t.check=r=>t.store[r]?t.track(r):!1,t.track=r=>(t.store[r]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{if(t.expiry)return;let n=Date.now();Object.keys(t.store).forEach(i=>{n-t.store[i]>e&&delete t.store[i]}),t.expiry=null},e)),r),t},_e=Ke;var He=(e,t)=>{if(!e||typeof e!="object")throw new TypeError("lex must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");let r=e["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!t[r])return;let n={_:{"#":r,">":{}}},i={};if(typeof e["."]=="string"){let s=e["."];if(typeof t[r][s]>"u")return;n[s]=t[r][s],n._[">"][s]=t[r]._[">"][s];let m=t[r]._[">"][s];t[r]._.s&&(t[r]._.s[m]?i[m]=t[r]._.s[m]:t[r]._.s[s]&&(i[s]=t[r]._.s[s]))}else for(let s of Object.keys(t[r]))if(s===L||ee(e["."],s)){n[s]=t[r][s],n._[">"][s]=t[r]._[">"][s];let m=t[r]._[">"][s];t[r]._.s&&(t[r]._.s[m]?i[m]=t[r]._.s[m]:t[r]._.s[s]&&(i[s]=t[r]._.s[s]))}return Object.keys(i).length>0&&(n._.s=i),{[r]:n}},me=He;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function ce(){}Object.assign(ce,{from:Array.from});ce.prototype=Object.create(Array.prototype);ce.prototype.toString=function(e,t,r){if(e||(e="utf8"),t||(t=0),r=r?Math.min(Math.max(r,t),this.length):this.length,e==="hex"){let n=new Uint8Array(this.slice(t,r));return Array.from(n,i=>i.toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:r-t},(n,i)=>{let s=this[i+t];return s<0||s>1114111?"\uFFFD":String.fromCharCode(s)}).join("");if(e==="base64"){let n=Array.from({length:r-t},(i,s)=>{let m=this[s+t];return m<0||m>255?"\uFFFD":String.fromCharCode(m)}).join("");return btoa(n)}};var Q=ce;var ge={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function Y(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),Y.from(...e)}Y.prototype=Object.create(Array.prototype);var ue=(e,t)=>{if(typeof e!="string")throw new TypeError("Input must be a string for encoding: "+t);if(e.length>ge.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${e.length} > ${ge.MAX_STRING_LENGTH}`)},z=(e,t="buffer operation")=>{if(e>ge.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${t}: ${e} > ${ge.MAX_BUFFER_SIZE}`)},Fe=e=>{ue(e,"hex");let t=e.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(t))throw new TypeError("Invalid hex string: contains non-hex characters");if(t.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(t.length===0)return new Uint8Array(0);z(t.length/2,"hex parsing");let r=new Uint8Array(t.length/2);for(let n=0;n<t.length;n+=2){let i=t.substr(n,2);r[n/2]=parseInt(i,16)}return r},je=e=>{ue(e,"utf8");try{let r=new TextEncoder().encode(e);return z(r.length,"UTF-8 encoding"),r}catch(t){throw new TypeError("Failed to encode UTF-8 string: "+t.message)}},Je=e=>{ue(e,"binary"),z(e.length,"binary encoding");let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);t[r]=n}return t},qe=e=>{ue(e,"base64");let t=e.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(t))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(t);z(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let i=0;i<r.length;i++)n[i]=r.charCodeAt(i);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},Ae=e=>{let t;if(e instanceof ArrayBuffer)z(e.byteLength,"ArrayBuffer processing"),t=new Uint8Array(e);else if(ArrayBuffer.isView(e))z(e.byteLength||e.length,"TypedArray processing"),t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);else if(Array.isArray(e)){z(e.length,"Array processing");for(let r=0;r<e.length;r++){let n=e[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}t=new Uint8Array(e)}else if(typeof e=="object"&&e!==null&&typeof e.length=="number"){z(e.length,"array-like processing");let r=Array.from(e);for(let n=0;n<r.length;n++){let i=r[n];if(typeof i!="number"||i<0||i>255||!Number.isInteger(i))throw new TypeError(`Invalid byte value at index ${n}: ${i} (must be integer 0-255)`)}t=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof e);return t};Object.assign(Y,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let t=arguments[0];if(t==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof t=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=Fe(t);break;case"utf8":case"utf-8":r=je(t);break;case"binary":case"latin1":r=Je(t);break;case"base64":r=qe(t);break;case"ascii":ue(t,"ascii");for(let i=0;i<t.length;i++)if(t.charCodeAt(i)>127)throw new TypeError(`Invalid ASCII character at position ${i}: ${t.charCodeAt(i)} > 127`);r=je(t);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=Ae(t);if(!r||r.length===0)return Q.from(new Uint8Array(0));try{return Q.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(e,t=0){if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Length must be a non-negative integer");if(z(e,"buffer allocation"),typeof t=="number"){if(t<0||t>255||!Number.isInteger(t))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof t=="string"){if(t.length!==1)throw new TypeError("Fill string must be exactly one character");if(t=t.charCodeAt(0),t>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(e);return t!==0&&r.fill(t),Q.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be an array");if(e.length===0)return Q.from(new Uint8Array(0));let t=0,r=[];for(let n=0;n<e.length;n++){let i=e[n];if(!i)throw new TypeError(`Array element at index ${n} is null or undefined`);let s;try{s=Ae(i)}catch(m){throw new TypeError(`Invalid array element at index ${n}: ${m.message}`)}t+=s.length,z(t,"buffer concatenation"),r.push(s)}try{let n=new Uint8Array(t),i=0;for(let s of r)n.set(s,i),i+=s.length;return Q.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(e){return e instanceof Q||e&&typeof e=="object"&&e.constructor===Y},byteLength(e,t="utf8"){if(typeof e!="string")throw new TypeError("First argument must be a string");switch(t.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(e).length;case"ascii":case"binary":case"latin1":return e.length;case"base64":let r=e.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(e.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+t)}}});Y.prototype.from=Y.from;Y.prototype.toString=function(e="utf8",t=0,r=this.length){if(typeof e!="string")throw new TypeError("Encoding must be a string");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<t)throw new TypeError("End must be an integer >= start");try{return Q.prototype.toString.call(this,e,t,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var J=Y;var We=typeof document>"u",$e=We?(await import("node:crypto")).webcrypto:globalThis.crypto,M=$e.subtle,pe=e=>typeof e=="string"?e:JSON.stringify(e),le=e=>{try{return JSON.parse(e)}catch{return e}},de=e=>{let t=new Uint8Array(J.alloc(e));return J.from($e.getRandomValues(t))},Z=(e,t)=>{let[r,n]=e.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},re=async e=>{let t=await M.digest({name:"SHA-256"},new TextEncoder().encode(pe(e)));return J.from(t)},we=async(e,t)=>{let r=e+t.toString("utf8"),n=J.from(await re(r),"binary"),i=Ge(n);return await M.importKey("jwk",i,{name:"AES-GCM"},!1,["encrypt","decrypt"])},Ge=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var Xe={pair:async e=>{let t=await M.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async i=>{let s=await M.exportKey("jwk",i.publicKey);return{priv:(await M.exportKey("jwk",i.privateKey)).d,pub:s.x+"."+s.y}}),r=await M.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async i=>{let s=await M.exportKey("jwk",i.publicKey);return{epriv:(await M.exportKey("jwk",i.privateKey)).d,epub:s.x+"."+s.y}}),n={pub:t.pub,priv:t.priv,epub:r.epub,epriv:r.epriv};return e&&e(n),n},encrypt:async(e,t,r)=>{if(!t||!t.epriv)return r&&r(null),null;let n={s:de(9),iv:de(15)},i=await we(t.epriv,n.s).then(m=>M.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},m,new TextEncoder().encode(pe(e)))),s={ct:J.from(i,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(s),s},decrypt:async(e,t,r)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return r&&r(null),null;let n={ct:J.from(e.ct,"base64"),iv:J.from(e.iv,"base64"),s:J.from(e.s,"base64")};try{let i=await we(t.epriv,n.s).then(m=>M.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},m,new Uint8Array(n.ct))),s=le(new TextDecoder("utf8").decode(i));return r&&r(s),s}catch{return r&&r(null),null}},verify:async(e,t,r)=>{if(!t||!t.pub)return r&&r(null),null;let n=le(e),i=await M.importKey("jwk",Z(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),s={};if(typeof n.m=="string")s=n.m;else for(let y of Object.keys(n.m).sort())y!=="_"&&y!==L&&y!==W&&(s[y]=n.m[y]);let m=await re(s),p=new Uint8Array(J.from(n.s,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}};if(await M.verify(a,i,p,new Uint8Array(m))){let y=le(n.m);return r&&r(y),y}return r&&r(null),null},sign:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n={};if(typeof e=="string")n=e;else{let y=le(e);for(let S of Object.keys(y).sort())S!=="_"&&S!==L&&S!==W&&(n[S]=y[S])}let i=await re(n),s=Z(t.pub,t.priv),m={name:"ECDSA",namedCurve:"P-256"},p=await M.importKey("jwk",s,m,!1,["sign"]).then(y=>M.sign({name:"ECDSA",hash:{name:"SHA-256"}},y,new Uint8Array(i))),a={m:n,s:J.from(p,"binary").toString("base64")};return r&&r(a),a},signTimestamp:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n=e.toString(),i=await re(n),s=Z(t.pub,t.priv),m={name:"ECDSA",namedCurve:"P-256"},p=await M.importKey("jwk",s,m,!1,["sign"]).then(y=>M.sign({name:"ECDSA",hash:{name:"SHA-256"}},y,new Uint8Array(i))),a=J.from(p,"binary").toString("base64");return r&&r(a),a},verifyTimestamp:async(e,t,r,n)=>{if(!r||!e||!t)return n&&n(!1),!1;try{let i=e.toString(),s=await re(i),m=await M.importKey("jwk",Z(r),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),p=new Uint8Array(J.from(t,"base64")),a={name:"ECDSA",hash:{name:"SHA-256"}},y=await M.verify(a,m,p,new Uint8Array(s));return n&&n(y),y}catch(i){return console.log(`error verifying timestamp signature: ${i.message}`),n&&n(!1),!1}},verifyProperties:async(e,t,r)=>{if(!t||!e)return r&&r([]),[];let n=await M.importKey("jwk",Z(t),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),i={name:"ECDSA",hash:{name:"SHA-256"}},s=[],m=e._&&e._.s||{};for(let p of Object.keys(e).sort()){if(p==="_"||p==L)continue;let a=m[p];if(a)try{let y=await re(e[p]),S=new Uint8Array(J.from(a,"base64"));await M.verify(i,n,S,new Uint8Array(y))?s.push(p):console.log(`warning: property '${p}' signature verification failed`)}catch(y){console.log(`warning: property '${p}' error verifying: ${y.message}`)}}return r&&r(s),s},work:async(e,t,r)=>{typeof t=="function"&&(r=t,t=void 0),typeof t>"u"&&(t=de(9));let n=await M.importKey("raw",new TextEncoder().encode(pe(e)),{name:"PBKDF2"},!1,["deriveBits"]),i={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},s=await M.deriveBits(i,n,512),m={epriv:J.from(s,"binary").toString("base64")};return r&&r(m),m},secret:async(e,t,r)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},i=Z(e.epub),s=await M.importKey("jwk",i,n,!0,[]),m=Z(t.epub,t.epriv,!1);delete m.key_ops;let p=await M.importKey("jwk",m,n,!1,["deriveBits"]).then(async a=>{let y=await M.deriveBits({public:s,name:"ECDH",namedCurve:"P-256"},a,256),S=await M.importKey("raw",new Uint8Array(y),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return M.exportKey("jwk",S).then(({k:f})=>f)});return r&&r({epriv:p}),{epriv:p}}},H=Xe;var xe=100,Ce=1e4,be=(e,t,r,n,i=!1)=>e<t?{historical:!0}:e>t?{incoming:!0}:i&&r!==n?(console.log(`Signed timestamp ${e}: reject conflicting value`),{historical:!0}):(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});be.mix=async(e,t,r,n)=>{if(!e||typeof e!="object")throw new TypeError("change must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let i=Date.now(),s={},m={},p=new Map,a=new Map,y=0;for(let f of Object.keys(e)){let w=e[f],o=!1,l=!1,d=0,g=r;if(!w||!w._)continue;let c=w[L];if(w._.s&&c&&(g=!0),f.length>1&&f[0]==="~")if(f[1]==="@")l=!0,g=!1;else{if(c&&f!="~"+c){console.log(`error public key does not match for soul: ${f}`);continue}g=!0}if(g){if(!c||!w._)continue;let u=new Set,T=new Set;for(let[v,x]of Object.entries(w._.s||{})){let j=Number(v);if(!isNaN(j)&&j>0&&await H.verifyTimestamp(j,x,c)){u.add(j);for(let[O,_]of Object.entries(w._[">"]||{}))Number(_)===j&&T.add(O)}}if((await H.verifyProperties(w,c)).forEach(v=>T.add(v)),T.size===0)continue;p.set(f,T),a.set(f,u)}for(let u of Object.keys(w)){if(u==="_"||u===W||u===L||p.has(f)&&!p.get(f).has(u))continue;let T=w[u],h=w._&&w._[">"]?w._[">"][u]:0,v=(t[f]||{})[u],x=(t[f]||{_:{">":{}}})._[">"][u]||0;if(l&&u!==U.is(T)){console.log(`error alias ${l}: ${u} !== ${U.is(T)}`);continue}let j=h-i;if(j>0){if(j>864e5)continue;(y===0||j<y)&&(y=d=j),m[f]||(m[f]={_:{"#":f,">":{},s:{}}}),m[f][u]=T,m[f]._[">"][u]=h,w._.s&&(w._.s[h]?m[f]._.s[h]=w._.s[h]:w._.s[u]&&(m[f]._.s[u]=w._.s[u]))}else{let C=a.has(f)&&a.get(f).has(h);be(h,x,T,v,C).incoming&&(s[f]||(s[f]={_:{"#":f,">":{},s:{}}}),t[f]||(t[f]={_:{"#":f,">":{},s:{}}}),t[f][u]=s[f][u]=T,t[f]._[">"][u]=s[f]._[">"][u]=h,w._.s&&(w._.s[h]?t[f]._.s[h]=s[f]._.s[h]=w._.s[h]:w._.s[u]&&(t[f]._.s[u]=s[f]._.s[u]=w._.s[u])),n[f]&&setTimeout(()=>{n[f]&&n[f].filter(_=>ee(_["."],u)).forEach(_=>_.cb())},xe),o=!0)}}o&&n[f]&&setTimeout(()=>{n[f]&&n[f].filter(u=>ee(u["."])).forEach(u=>u.cb())},xe)}let S=Object.keys(t);return S.length>Ce&&S.map(o=>{let l=t[o]._&&t[o]._[">"],d=l?Math.max(...Object.values(l)):0;return{soul:o,maxState:d}}).sort((o,l)=>o.maxState-l.maxState).slice(0,S.length-Ce).forEach(({soul:o})=>delete t[o]),{now:s,defer:m,wait:y}};var Se=be;var G="",oe="",Oe=()=>{let e=(t,r,n)=>{if(n||(e[G]||(e[G]={}),n=e[G]),!t)return n;let i=0,s={},m=t[i],p=t.length-1,a=typeof r>"u",y=n[m];for(;!y&&i<p;)m+=t[++i],y=n[m];if(y)if(i===p){if(a)return typeof y[oe]>"u"?y[G]:y[oe];y[oe]=r}else return!y[G]&&!a&&(y[G]={}),e(t.slice(++i),r,y[G]);else if(B.map(n,(f,w)=>{let o=0,l="";for(;w[o]===t[o];)l+=w[o++];if(l){if(a)return o<=p?void 0:(s[w.slice(o)]=f,f);let d={[w.slice(o)]:f,[t.slice(o)]:{[oe]:r}};return n[l]={[G]:d},delete n[w],!0}})){if(a)return s}else{if(a)return;n[m]||(n[m]={}),n[m][oe]=r}};return e};Oe.map=function e(t,r,n,i){i||(i=[]);var s=t[G]||t,m=Object.keys(s).sort(),p;for(let a=0;a<m.length;a++){let y=m[a],S=s[y],f=S[oe];if(typeof f<"u"){if(f=r(f,i.join("")+y,y,i),typeof f<"u")return f}else n&&r(p,i.join(""),y,i);if(S[G]){if(i.push(y),f=e(S[G],r,n,i),typeof f<"u")return f;i.pop()}}};var q=Oe;var ve="",Ie="",F="",ne=e=>{var t;let r=new Map,n=null,i=0,s=1e4,m=new Map,p=0,a=3e4,y=.8,S=.9;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=100),e.write||(e.write=1),e.size||(e.size=1024*1024),e.memoryLimit||(e.memoryLimit=500),e.readTimeout||(e.readTimeout=1e3),typeof e.cache>"u"&&(e.cache=!0),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let f=(l,d,g,c)=>{let u=Date.now()-d;u>2e3&&console.log(`[RADISK-SLOW] ${l}: ${u}ms for ${g}${c?` (${c} bytes)`:""}`)},w=()=>{if(typeof process>"u"||!process.memoryUsage)return;let l=Date.now();if(l-p<a)return;p=l;let d=process.memoryUsage(),g=d.heapUsed,c=d.heapTotal,u=e.memoryLimit*1024*1024,T=g/u;if(T>S){let h=r.size;console.log(`[RADISK-MEMORY] High memory usage: ${Math.round(T*100)}% of heap limit. Clearing ${h} cached files.`),r.clear(),global.gc&&global.gc(),p=l+a}else T>y&&console.log(`[RADISK-MEMORY] Memory warning: ${Math.round(T*100)}% of heap limit used. Cache size: ${r.size} files.`)},o=(l,d,g)=>{if(l=""+l,typeof d=="function"){if(g=d,d=o.batch(l),typeof d<"u"||o.thrash.at&&(d=o.thrash.at(l),typeof d<"u"))return g(t,d);if(m.has(l)){m.get(l).callbacks.push(g);return}let c={callbacks:[g],fired:!1,timeoutId:null};m.set(l,c),c.timeoutId=setTimeout(()=>{if(!c.fired){c.fired=!0,m.delete(l);let T=new Error("radisk read timeout");c.callbacks.forEach(h=>h(T,void 0))}},e.readTimeout);let u=Date.now();return o.read(l,(T,h)=>{clearTimeout(c.timeoutId),f("read",u,l),c.fired||(c.fired=!0,m.delete(l),c.callbacks.forEach(v=>v(T,h)))})}if(o.batch(l,d),w(),g&&o.batch.acks.push(g),++o.batch.ed>=e.batch)return o.thrash();clearTimeout(o.batch.timeout),o.batch.timeout=setTimeout(o.thrash,e.write)};return o.batch=q(),o.batch.acks=[],o.batch.ed=0,o.thrash=()=>{if(o.thrash.ing)return o.thrash.more=!0;let l=Date.now();clearTimeout(o.batch.timeout),o.thrash.more=!1,o.thrash.ing=!0;var d=o.thrash.at=o.batch;o.batch=null,o.batch=q(),o.batch.acks=[],o.batch.ed=0;let g=0;o.save(d,c=>{++g>1||(f("thrash",l,`batch-${d.ed}`),c&&e.log(c),d.acks.forEach(u=>u(c)),o.thrash.at=null,o.thrash.ing=!1,o.thrash.more&&o.thrash())})},o.save=(l,d)=>{let g={find:(c,u)=>{if(!(u<g.start))return g.start=u,e.store.list(g.lex),!0},lex:c=>{!c||c>g.start?(g.end=c,g.start&&g.mix(g.file||"!",g.start,g.end)):g.file=c},mix:(c,u,T)=>{if(g.start=g.end=g.file=t,r.has(c)){let h=r.get(c);q.map(l,(v,x)=>{if(!(x<u)){if(T&&T<x){g.start=x;return}h(x,v)}}),o.write(c,h,g.next)}else o.parse(c,(h,v)=>{if(h)return d(h);q.map(l,(x,j)=>{if(!(j<u)){if(T&&T<j){g.start=j;return}v(j,x)}}),o.write(c,v,g.next)})},next:c=>{if(c)return d(c);if(g.start)return q.map(l,g.find);d(c)}};q.map(l,g.find)},o.write=(l,d,g)=>{let c={text:"",limit:"",done:!1,count:0,each:(T,h,v,x)=>{if(c.done)return;c.count++,T=typeof T>"u"?"":"="+ne.encode(T);let j=ne.encode(x.length)+"#"+ne.encode(v)+T+`
`;if(c.count>1&&x.length===0&&c.text.length+j.length>e.size){let C=v.indexOf(Ie);if(c.limit=C===-1?v:v.substring(0,C),c.limit!==l){c.done=!0,c.sub=q(),q.map(d,c.slice),o.write(c.limit,c.sub,g);return}}c.text+=j},slice:(T,h)=>{h<c.limit||c.sub(h,T)}};q.map(d,c.each,!0);let u=Date.now();e.store.put(l,c.text,T=>{f("file-write",u,l,c.text.length),g(T)})},o.read=(l,d)=>{let g=l.indexOf(Ie),c=g===-1?l:l.substring(0,g),u={lex:h=>{if(!h){if(!u.file){d("no file found",t);return}if(e.cache&&r.has(u.file)){let v=r.get(u.file);return u.value=v(l),d(t,u.value)}o.parse(u.file,u.it);return}h>c||h<u.file||(u.file=h)},it:(h,v)=>{h&&e.log(h),v&&(e.cache&&(r.set(u.file,v),w()),u.value=v(l)),d(h,u.value)}},T=Date.now();if(e.cache&&n&&T-i<s)n.forEach(h=>u.lex(h)),u.lex();else{let h=[],v=u.lex;u.lex=x=>(x&&h.push(x),v(x)),e.store.list(x=>{u.lex(x),!x&&e.cache&&(n=h,i=T)})}},o.parse=(l,d)=>{let g={disk:q(),read:(c,u)=>{if(c)return d(c);if(!u)return d(t,g.disk);let T=[],h="",v=g.split(u);for(;v;){let x,j,C=v[1];v=g.split(v[2])||"",v[0]==="#"&&(x=v[1],C<T.length&&(T.length=C),C<=T.length&&(T[C]=x,T.length=C+1),h=T.join("")),v=g.split(v[2])||"",v[0]!==`
`&&(v[0]==="="&&(j=v[1]),typeof x<"u"&&typeof j<"u"&&g.disk(h,j),v=g.split(v[2]))}d(t,g.disk)},split:c=>{if(!c)return;let u=c.indexOf(F);if(u===-1)return;let T=c.slice(0,u),h={};return[T,ne.decode(c.slice(u),h),c.slice(u+h.i)]}};e.store.get(l,g.read)},o};ne.encode=e=>{let t="",r="";if(e instanceof Array&&(e.length===2||e.length===3)&&(t=ve+e[1],e.length===3&&e[2]&&(r=ve+e[2]),e=e[0]),typeof e=="string"){let i=0,s=null,m=F;for(;s=e[i++];)s===F&&(m+=F);return m+'"'+e+t+r+F}let n=U.is(e);if(n)return F+"#"+n+t+r+F;if(fe.is(e))return F+"+"+(e||0)+t+r+F;if(e===!0)return F+"+"+t+r+F;if(e===!1)return F+"-"+t+r+F;if(e===null)return F+" "+t+r+F};ne.decode=(e,t)=>{var r=-1,n=0,i=null,s=null,m=-1,p=-1;if(e[0]!==F)return;for(;i=e[++r];)if(s){if(m===-1&&(m=r),i===F&&--n<=0){p=r;break}}else i===F?n++:s=i||!0;let a=m!==-1?e.slice(m,p!==-1?p:r):"";t&&(t.i=r+1);let y=a.split(ve),S=y[0],f=y[1],w=y[2];if(f)if(f=parseFloat(f),w){if(s==='"')return[S,f,w];if(s==="#")return[U.ify(S),f,w];if(s==="+")return S.length===0?[!0,f,w]:[parseFloat(S),f,w];if(s==="-")return[!1,f,w];if(s===" ")return[null,f,w]}else{if(s==='"')return[S,f];if(s==="#")return[U.ify(S),f];if(s==="+")return S.length===0?[!0,f]:[parseFloat(S),f];if(s==="-")return[!1,f];if(s===" ")return[null,f]}else{if(s==='"')return a;if(s==="#")return U.ify(a);if(s==="+")return a.length===0?!0:parseFloat(a);if(s==="-")return!1;if(s===" ")return null}};var Ne=ne;var Me=typeof document>"u",V=Me?await import("node:fs"):void 0,De="",he="",ke=he+"+0"+he+"#"+he+'"root'+he,Qe=e=>{let t=e.file;if(Me)return V.existsSync(t)||V.mkdirSync(t),V.existsSync(t+"/!")||V.writeFileSync(t+"/!",ke),{get:(r,n)=>{V.readFile(t+"/"+r,(i,s)=>{if(i){if(i.code==="ENOENT"){n();return}console.log("fs.readFile error:",i)}s&&(s=s.toString()),n(i,s)})},put:(r,n,i)=>{var s=r+"."+P.random(9)+".tmp";V.writeFile(s,n,m=>{if(m){console.log("fs.writeFile error:",m),i(m);return}V.rename(s,t+"/"+r,i)})},list:r=>{V.readdir(t,(n,i)=>{if(n){console.log("fs.readdir error:",n),r();return}i.forEach(r),r()})}};if(e.indexedDB){let r,n=indexedDB.open(t,1);return n.onupgradeneeded=i=>{i.target.result.createObjectStore(t)},n.onerror=i=>{console.log(i)},n.onsuccess=()=>{if(r=n.result,r){let s=r.transaction([t],"readonly").objectStore(t).getKey("!");s.onerror=()=>{console.log(`error getting key ${t}/!`)},s.onsuccess=()=>{if(!s.result){let p=r.transaction([t],"readwrite").objectStore(t).put(ke,"!");p.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(i,s)=>{let m=(y,S)=>{let w=r.transaction([t],"readonly").objectStore(t).get(y);w.onerror=()=>{console.log(`error getting ${t}/${y}`)},w.onsuccess=()=>{S(null,w.result)}};if(r){m(i,s);return}let p=0,a=setInterval(()=>{if(r){clearInterval(a),m(i,s);return}p++>5&&(clearInterval(a),s("error indexedDB not available"))},1e3)},put:(i,s,m)=>{let p=(S,f,w)=>{let l=r.transaction([t],"readwrite").objectStore(t).put(f,S);l.onerror=()=>{console.log(`error putting data on ${t}/${S}`)},l.onsuccess=()=>{w(null)}};if(r){p(i,s,m);return}let a=0,y=setInterval(()=>{if(r){clearInterval(y),p(i,s,m);return}a++>5&&(clearInterval(y),m("error indexedDB not available"))},1e3)},list:i=>{let s=a=>{let S=r.transaction([t],"readonly").objectStore(t).getAllKeys();S.onerror=()=>console.log("error getting keys for",t),S.onsuccess=()=>{S.result.forEach(a),a()}};if(r){s(i);return}let m=0,p=setInterval(()=>{if(r){clearInterval(p),s(i);return}m++>5&&(clearInterval(p),console.log("error indexedDB not available"),i())},1e3)}}}return{get:(r,n)=>{n(null,ke)},put:(r,n,i)=>{i(null)},list:r=>{r("!"),r()}}},Ye=e=>{B.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=Qe(e));let t=Ne(e);return{get:(r,n,i)=>{if(!r||!B.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}i||(i={});var s=r["#"],m=!i.secure&&typeof r["."]=="string"?r["."]:"",p,a={};let y=(S,f)=>{if(!(f!==L&&!ee(r["."],f))&&(p||(p={_:{"#":s,">":{}}}),p[f]=S[0],p._[">"][f]=S[1],S.length===3&&S[2])){let w=S[1];a[w]=S[2],a[f]=S[2]}};t(s+De+m,(S,f)=>{let w;B.is(f)?(q.map(f,y),p||y(f,m),w={[s]:p}):f&&(y(f,m),w={[s]:p}),w&&w[s]&&Object.keys(a).length>0&&(w[s]._.s=a),n(S,w)})},put:(r,n)=>{if(!r){n("graph required");return}let i=0,s=!1,m=p=>{if(i--,!s){if(p){s=!0,n(p);return}i===0&&(s=!0,n(null))}};Object.keys(r).forEach(p=>{var a=r[p];Object.keys(a).forEach(y=>{if(y==="_")return;i++;let S=a[y],f=a._[">"][y],w=a._.s&&a._.s[f],o=w?[S,f,w]:[S,f];t(p+De+y,o,m)})})}}},Pe=Ye;var Re=typeof document>"u",Ue=Re?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Ue?.WebSocket);var Ze=e=>{let t=new Map,r=1500,n=6e4,i=10,s=null;return e||(s=setInterval(()=>{let p=Date.now();for(let[a,y]of t.entries())p-y.lastCleanup>n&&(y.requests=[],y.lastCleanup=p),y.requests=y.requests.filter(S=>p-S<n),p-y.lastCleanup>n*10&&(y.throttleCount=0)},n/4)),{getDelay:p=>{let a=Date.now(),y=t.get(p)||{requests:[],lastCleanup:a,throttleCount:0};if(y.requests=y.requests.filter(S=>a-S<n),y.requests.length>=r){let S=Math.min(...y.requests),f=n-(a-S);return y.throttleCount=(y.throttleCount||0)+1,t.set(p,y),Math.max(0,f)}return y.requests.push(a),t.set(p,y),0},getRemainingRequests:p=>{let a=t.get(p);if(!a)return r;let y=Date.now(),S=a.requests.filter(f=>y-f<n);return Math.max(0,r-S.length)},getThrottleCount:p=>{let a=t.get(p);return a&&a.throttleCount||0},shouldDisconnect:p=>{let a=t.get(p);return a?a.throttleCount>=i:!1},destroy:()=>{s&&(clearInterval(s),s=null),t.clear()}}},Ve=(e,t=1024*1024)=>{try{if(typeof e=="string"&&e.length>t)throw new Error("Message too large");return{success:!0,data:JSON.parse(e)}}catch(r){return{success:!1,error:r.message}}},et=(e,t=1024*1024)=>typeof e=="string"&&e.length>t?{valid:!1,error:"Message too large"}:Buffer.isBuffer(e)&&e.length>t?{valid:!1,error:"Message too large"}:{valid:!0},tt=(e=1e3)=>{let t=new Set;return{add:r=>{if(t.size>=e)return!1;t.add(r);let n=r.close;return r.close=(...i)=>(t.delete(r),n.apply(r,i)),!0},remove:r=>{t.delete(r)},count:()=>t.size,isFull:()=>t.size>=e}},Te=(e=5)=>{let t=0;return{shouldRetry:()=>t<e,getDelay:()=>Math.min(1e3*Math.pow(2,t),3e4),increment:()=>t++,reset:()=>t=0}},rt=e=>{let t=_e(e.maxAge),r=Pe(e),n={},i={},s={},m=new Set,p=new Map,a=async _=>n[_]?!0:new Promise(b=>{r.get({"#":_},(E,k)=>{b(!E&&k&&k[_])})}),y=e.wss&&e.wss.constructor.name==="Server",S=Ze(y),f=tt(e.maxConnections||1e3),w=async(_,b,E)=>{for(let k of Object.keys(_)){let A=await new Promise(I=>{d({"#":k},I,b)});if(A.err)return E&&E(A.err),!1;let $=_[k],N=L;if(!(!A.put||!A.put[k]||A.put[k][N]===$[N]))return E&&E(`error in wire check public key does not match for soul: ${k}`),!1}return!0},o=(_,b)=>{let E=me(_.get,n);E?b(JSON.stringify({"#":t.track(P.random(9)),"@":_["#"],put:E})):r.get(_.get,(k,A)=>{b(JSON.stringify({"#":t.track(P.random(9)),"@":_["#"],put:A,err:k}))})},l=async(_,b)=>{let E=await Se.mix(_.put,n,e.secure,s);if(Object.keys(E.now).length===0){Object.keys(E.defer).length!==0&&setTimeout(()=>l({put:E.defer,"#":_["#"]},b),E.wait);return}await w(E.now,b)&&(r.put(E.now,k=>{b(JSON.stringify({"#":t.track(P.random(9)),"@":_["#"],err:k}))}),Object.keys(E.defer).length!==0&&setTimeout(()=>l({put:E.defer,"#":_["#"]},b),E.wait))},d=(_,b,E,k)=>{if(!b)return;B.is(k)||(k={});let A=me(_,n),$=P.random(9),N=JSON.stringify({"#":t.track($),get:_});if(A){let I=E(N);if(I&&I.err){b({err:I.err});return}b({put:A});return}r.get(_,(I,R)=>{if(R){let K=E(N);if(K&&K.err){b({err:K.err});return}b({put:R,err:I});return}I&&console.log(I),i[$]=b,p.set($,{lex:_,wait:k.wait||100});let D=E(N);if(D&&D.err){b({err:D.err}),delete i[$],p.delete($);return}},k)},g=_=>({get:(b,E,k)=>{b&&typeof b["."]=="number"&&(b={...b,".":String(b["."])}),b&&b["#"]&&m.add(b["#"]),d(b,E,_,k)},put:async(b,E)=>{let k=await Se.mix(b,n,e.secure,s);if(Object.keys(k.now).length===0){E&&E(null);return}if(!await w(k.now,_,E))return;for(let[$,N]of Object.entries(k.now))if(N&&typeof N=="object")for(let[I,R]of Object.entries(N)){let D=U.is(R);D&&m.add(D)}r.put(k.now,E);let A=_(JSON.stringify({"#":t.track(P.random(9)),put:b}));if(A&&A.err){E&&E(A.err);return}},on:(b,E,k,A)=>{b&&typeof b["."]=="number"&&(b={...b,".":String(b["."])});let $=b&&b["#"];!$||!E||(s[$]?s[$].push({".":b["."],cb:E}):s[$]=[{".":b["."],cb:E}],k&&d(b,E,_,A))},off:(b,E)=>{let k=b&&b["#"];if(!(!k||!s[k]))if(E){let A=s[k].find($=>$.cb===E);A&&s[k].splice(s[k].indexOf(A),1)}else delete s[k]}});if(Re){let _=e.wss,b=()=>_.clients();if(!_){let k=e.server?{server:e.server}:{port:e.port||8765};_=new Ue.WebSocketServer(k),b=()=>_.clients}let E=(k,A)=>{let N=JSON.parse(k)["#"];if(N&&p.has(N)){let I=p.get(N);p.delete(N),I.timeoutId=setTimeout(()=>{let R=i[N];if(R){let D=I.lex["#"],K={[D]:null};typeof I.lex["."]=="string"&&(K[D]={[I.lex["."]]:null}),R({put:K}),delete i[N]}},I.wait)}b().forEach(I=>{if(I&&I.readyState===WebSocket.OPEN)I.send(k,{binary:A});else{let R=I._retryHandler||Te();if(I._retryHandler=R,R.shouldRetry()){let D=R.getDelay();R.increment(),setTimeout(()=>{I&&I.readyState===WebSocket.OPEN&&(R.reset(),I.send(k,{binary:A}))},D)}}})};return _.on("connection",k=>{if(!f.add(k)){console.log("Connection limit reached, rejecting connection"),k.close(1013,"Connection limit reached - try again later");return}let A=P.random(9);console.log(`New WebSocket client connected: ${A}`),k.on("error",$=>{console.log("WebSocket error:",$),f.remove(k)}),k.on("close",()=>{console.log(`WebSocket client disconnected: ${A}`),f.remove(k)}),k.on("message",($,N)=>{let I=et($,e.maxMessageSize);if(!I.valid){console.warn(`Invalid message: ${I.error}`),k.send(JSON.stringify({error:I.error}));return}let R=Ve($,e.maxMessageSize);if(!R.success){console.warn(`JSON parse error: ${R.error}`),k.send(JSON.stringify({error:"Invalid JSON"}));return}let D=R.data;if(t.check(D["#"]))return;let K=S.getDelay(A);if(K>0){let se=S.getThrottleCount(A);if(console.log(`Client ${A}: rate limit exceeded, delay would be ${K}ms, dropping message (throttle count: ${se})`),S.shouldDisconnect(A)){console.log(`Client ${A}: Disconnecting after ${se} throttle violations`),k.close(1008,"Rate limit violations");return}k.send(JSON.stringify({"#":t.track(P.random(9)),"@":D["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(K/1e3)}s`,throttle:K}));return}let ie=()=>{t.track(D["#"]),D.get&&o(D,E),D.put&&l(D,E),E($,N);let se=D["@"],ae=i[se];ae&&(delete D["#"],delete D["@"],ae(D),delete i[se])};K>0?setTimeout(ie,K):ie()})}),g(E)}let c=[],u=!1,T=0,h=[],v=null,x=e.maxQueueLength||1e4,j=()=>{if(h.length===0){v=null;return}let _=Date.now();if(u&&_<T){v=setTimeout(j,Math.min(1e3,T-_));return}u&&_>=T&&(console.log("Throttle period ended, resuming queue processing"),u=!1,T=0);let b=h[0];if(C(b)){h.shift();let A=JSON.parse(b)["#"];if(A&&p.has(A)){let $=p.get(A);p.delete(A),$.timeoutId=setTimeout(()=>{let N=i[A];if(N){let I=$.lex["#"],R={[I]:null};typeof $.lex["."]=="string"&&(R[I]={[$.lex["."]]:null}),N({put:R}),delete i[A]}},$.wait)}}h.length>0?v=setTimeout(j,50):v=null},C=_=>{let b=!1;return c.forEach(E=>{if(E&&E.readyState===WebSocket.OPEN)E.send(_),b=!0;else{let k=E._retryHandler||Te();if(E._retryHandler=k,k.shouldRetry()){let A=k.getDelay();k.increment(),setTimeout(()=>{E&&E.readyState===WebSocket.OPEN&&(k.reset(),E.send(_))},A)}}}),b},O=_=>{if(h.length>=x)return{err:`Message queue exceeded maximum length (${x}). Update query logic to request less data.`,queueLength:h.length,maxQueueLength:x};h.push(_),v||(v=setTimeout(j,50))};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(_=>{let b=()=>{let E=new WebSocket(_);c.push(E);let k=Te();E.onclose=A=>{if(c.indexOf(E)!==-1&&c.splice(c.indexOf(E),1),E=null,k.shouldRetry()){let $=k.getDelay();k.increment(),setTimeout(b,$)}},E.onopen=()=>{k.reset()},E.onerror=A=>{console.log(A)},E.onmessage=async A=>{let $=JSON.parse(A.data);if(t.check($["#"]))return;if($.throttle&&$.err){console.log(`Server throttling: ${$.err}`),u=!0,T=Date.now()+$.throttle;return}if(t.track($["#"]),$.get&&o($,O),$.put){let R={};for(let[D,K]of Object.entries($.put)){let ie=!1;if(await a(D)&&(ie=!0,K&&typeof K=="object"))for(let[se,ae]of Object.entries(K)){let Ee=U.is(ae);Ee&&m.add(Ee)}m.has(D)&&(ie=!0,m.delete(D)),ie&&(R[D]=K)}if(Object.keys(R).length>0){let D={put:R,"#":$["#"]};l(D,O)}}let N=$["@"],I=i[N];I&&(delete $["#"],delete $["@"],I($),delete i[N])}};b()}),g(O)},ye=rt;var nt=(e,t)=>{t||(t=ye(e));let r=[],n=!1,i=!1,s=0,m=(a,y,S,f)=>{let w=g=>{s++,m(g,y,S,f)},o=g=>{r=[],s=0,i=!1,f(g)},l=()=>{if(r.length===0){o("Wrong username or password");return}let g=r.shift();t.get({"#":g},async c=>{if(c.err){o(`error getting ${g}: ${c.err}`);return}let u=c.put&&c.put[g];if(!u||!u.auth)return l();let T=JSON.parse(u.auth),h=await H.work(y,T.salt),v=await H.decrypt(T.enc,h);if(!v)return l();if(p.is={username:a,pub:u.pub,epub:u.epub,priv:v.priv,epriv:v.epriv},S!==""){let j=P.random(64),C=await H.work(S,j),O=await H.encrypt(v,C),_={auth:JSON.stringify({enc:O,salt:j})},b=Date.now(),E=await H.signTimestamp(b,p.is),k=X(g,_,E,u.pub,b);t.put(k,A=>{o(A?`error putting ${_} on ${g}: ${A}`:null)});return}if(typeof globalThis.localStorage<"u"&&globalThis.localStorage.getItem("holster_migrate_signatures")==="true"){let j={};for(let b of Object.keys(u))b!=="_"&&b!==L&&b!==W&&(j[b]=u[b]);let C=Date.now(),O=await H.signTimestamp(C,p.is),_=X(g,j,O,u.pub,C);t.put(_,b=>{b&&console.log(`warning: failed to migrate signatures on login: ${b}`),o(null)})}else o(null)},{wait:5e3})};if(s>9){o("Wrong username or password");return}let d="~@"+a;t.get({"#":d},async g=>{if(g.err){o(`error getting ${d}: ${g.err}`);return}let c=g.put&&g.put[d];if(!c)return w(a);delete g.put[d]._,r=Object.keys(c),l()},{wait:5e3})},p={create:(a,y,S)=>{let f=o=>{S?S(o):console.log(o)};if(n){f("User is already being created");return}if(a===""){f("Please provide a username");return}if(y===""){f("Please provide a password");return}n=!0;let w="~@"+a;t.get({"#":w},async o=>{if(o.err){n=!1,f(`error getting ${w}: ${o.err}`);return}if(o.put&&o.put[w]){n=!1,f("Username already exists");return}let l=P.random(64),d=await H.work(y,l),g=await H.pair(),c={priv:g.priv,epriv:g.epriv},u=await H.encrypt(c,d),T={username:a,pub:g.pub,epub:g.epub,auth:JSON.stringify({enc:u,salt:l})},h="~"+g.pub,v=Date.now(),x=await H.signTimestamp(v,g),j=X(h,T,x,g.pub,v);t.put(j,C=>{if(n=!1,C){f(`error putting ${T} on ${h}: ${C}`);return}let O={[h]:{"#":h}};t.put(X(w,O),_=>{if(_){f(`error putting ${O} on ${w}: ${_}`);return}S&&S(null)})})},{wait:5e3})},auth:(a,y,S)=>{let f=w=>{S?S(w):w&&console.log(w)};if(i){f("User is already authenticating");return}if(p.is=null,a===""){f("Please provide a username");return}if(y===""){f("Please provide a password");return}i=!0,m(a,y,"",f)},change:(a,y,S,f)=>{let w=o=>{f?f(o):o&&console.log(o)};if(i){w("User is already authenticating");return}if(p.is=null,a===""){w("Please provide a username");return}if(y===""){w("Please provide a password");return}if(S===""){w("Please provide a new password");return}i=!0,m(a,y,S,w)},store:a=>{if(!p.is){console.log("Please authenticate before calling store");return}if(a){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(p.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(p.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let a=globalThis.localStorage.getItem("user.is");if(a){p.is=JSON.parse(a);return}}if(typeof globalThis.sessionStorage<"u"){let a=globalThis.sessionStorage.getItem("user.is");a&&(p.is=JSON.parse(a))}},leave:()=>{p.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(a,y,S)=>{let f=w=>{S?S(w):console.log(w)};if(i){f("User is already authenticating");return}if(a===""){f("Please provide a username");return}if(y===""){f("Please provide a password");return}i=!0,m(a,y,"",async w=>{if(w){f(w);return}let o={username:null,pub:null,epub:null,auth:null},l=Date.now(),d=await H.signTimestamp(l,p.is),g="~"+p.is.pub,c=X(g,o,d,p.is.pub,l);t.put(c,u=>{if(u){f(`error putting null on ${g}: ${u}`);return}p.is=null,S&&S(null)})})}};return p},Le=nt;var it=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:B.is(e)||(e={});let t=ye(e),r=Le(null,t),n=new Map,i=new Map,s=a=>a===null||a===!0||a===!1||typeof a=="string"||U.is(a)||fe.is(a),m=a=>{if(s(a))return!0;if(B.is(a)){let S=[];for(let[f,w]of Object.entries(a)){if(f==="_")return"error underscore cannot be used as a property name";if(B.is(w)||s(w)){S.push(f);continue}return typeof w>"u"?`error undefined ${f} cannot be converted to a graph`:`error ${JSON.stringify({[f]:w})} cannot be converted to a graph`}if(S.length!==0)return S}return`error ${JSON.stringify(a)} cannot be converted to a graph`},p=a=>{let y=(o,l,d,g)=>{t.get(B.put(o,"#",l),async c=>{if(c.err&&console.log(c.err),c.put&&c.put[l]){delete c.put[l]._,delete c.put[l][L],delete c.put[l][W];for(let u of Object.keys(c.put[l])){let T=U.is(c.put[l][u]);if(T){let h=async(v=0)=>{let x=await new Promise(j=>{let C=P.random(),O=i.get(a);i.set(C,{chain:[{item:null,soul:T}],user:O?O.user:null}),p(C).next(null,j,g)});return x!==null||v>=5?x:(await new Promise(j=>setTimeout(j,50)),h(v+1))};c.put[l][u]=await h()}}d(c.put[l])}else d(null)},g)},S=async(o,l,d,g)=>{if(d){let c=Date.now(),u=await H.signTimestamp(c,d);return X(o,l,u,d.pub,c)}return e.secure?(g||(g=console.log),g(`error putting data on ${o}: user required in secure mode`),null):X(o,l)},f=o=>l=>{let d=i.get(o);d&&typeof d.cb<"u"?setTimeout(()=>d.cb(l),1):l&&console.log("error no callback for data",l,"ctx",d),d&&!d.on&&i.delete(o)},w=(o,l)=>{if(!o){console.log("error resolve request parameter required");return}let d=typeof o.get<"u",g=typeof o.put<"u",c=typeof o.on<"u",u=typeof o.off<"u",T=!1,h=i.get(a);for(var v=1;v<h.chain.length;v++)if(h.chain[v].soul===null){T=!0;break}if(T){let{item:x,soul:j}=h.chain[v-1];return t.get({"#":j,".":x},async C=>{if(C.err){console.log(`error getting ${x} on ${j}: ${C.err}`),l&&l(null);return}let O=C.put&&C.put[j];if(O&&typeof O[x]<"u"){let _=U.is(O[x]);if(_)h.chain[v].soul=_,i.set(a,{...h}),d?p(a).next(null,o.get,l,o._opt):g?p(a).put(o.put,l):c?p(a).on(o.on,l,o._get,o._opt):u&&p(a).off(l);else if(d)l(O[x]);else if(g){_=P.random(),O[x]=U.ify(_);let b=await S(j,O,h.user,l);if(b===null)return;t.put(b,E=>{if(E){l(`error putting ${x} on ${j}: ${E}`);return}h.chain[v].soul=_,p(a).put(o.put,l)})}else(c||u&&l)&&l(null)}else if(g){let _=P.random();O||(O={}),O[x]=U.ify(_);let b=await S(j,O,h.user,l);if(b===null)return;t.put(b,E=>{if(E){l(`error putting ${x} on ${j}: ${E}`);return}h.chain[v].soul=_,p(a).put(o.put,l)})}else l&&l(null)},{...o._opt,secure:h.user||e.secure}),!1}return d&&h.chain[h.chain.length-1].item!==null?(h.chain.push({item:null,soul:null}),p(a).next(null,o.get,l,o._opt),!1):h.chain[h.chain.length-1]};return{get:(o,l,d,g)=>{if(typeof l=="function"&&(g=d,d=l,l=null),o===null||o===""||o==="_"){console.log("error please provide a key"),d&&d(null);return}if(l&&typeof d!="function"){console.log("error lex requires a callback function");return}if(a=P.random(),i.set(a,{chain:[{item:String(o),soul:"root"}],cb:d}),!d)return p(a);let c=f(a),{soul:u}=w({get:l,_opt:g},c);u&&y(l,u,c,g)},next:(o,l,d,g)=>{let c=v=>x=>{d?d(x):f(v)(x)};if(typeof l=="function"&&(g=d,d=l,l=null),!a){console.log("error please provide a key using get(key)"),d&&d(null);return}let u=c(a);if(o===""||o==="_"){u(null);return}if(l&&typeof d!="function"){console.log("error lex requires a callback function");return}let T=i.get(a);if(!T)return;if(d&&typeof T.cb>"u"&&(T.cb=d,d=null),o!==null&&T.chain.push({item:String(o),soul:null}),!T.cb)return p(a);let{soul:h}=w({get:l,_opt:g},u);h&&y(l,h,u,g)},put:(o,l,d)=>{typeof l=="function"&&(d=l,l=!1);let g=j=>C=>{d?d(C):f(j)(C)};if(!a){d&&d("error please provide a key using get(key)");return}let c=i.get(a);if(!c)return;if(!c.cb){if(!d)return;c.cb=d,d=null}l&&(o={[P.random()]:o});let u=g(a),T=m(o);if(typeof T=="string"){u(T);return}let{item:h,soul:v}=w({put:o},u);if(!v)return;if(T===!0){t.get({"#":v,".":h},async j=>{if(j.err){u(`error getting ${v}: ${j.err}`);return}let C=j.put&&j.put[v],O=C&&C[h],_=U.is(O);if(!_){C||(C={}),C[h]=o;let b=await S(v,C,c.user,u);if(b===null)return;t.put(b,u);return}t.get({"#":_},async b=>{if(b.err){u(`error getting ${_}: ${b.err}`);return}if(!b.put||!b.put[_]){u(`error ${_} not found`);return}for(let k of Object.keys(b.put[_])){if(k==="_"||k===L||k===W)continue;let A=await new Promise($=>{let N=P.random(),I=[{item:k,soul:_}];i.set(N,{chain:I,user:c.user}),p(N).put(null,$)});if(A){u(A);return}}C||(C={}),C[h]=o;let E=await S(v,C,c.user,u);E!==null&&t.put(E,u)})},{secure:c.user||e.secure});return}let x=(j=0)=>{t.get({"#":v,".":h},async C=>{if(C.err){u(`error getting ${v}.${h}: ${C.err}`);return}let O=C.put&&C.put[v],_=O&&O[h];if(!_&&j<5)return await new Promise(k=>setTimeout(k,50)),x(j+1);let b=U.is(_);if(!b){O||(O={}),O[h]=U.ify(P.random());let k=await S(v,O,c.user,u);if(k===null)return;t.put(k,A=>{if(A)u(`error putting ${h} on ${v}: ${A}`);else{let $=P.random(),N=[{item:h,soul:v}];i.set($,{chain:N,user:c.user,cb:c.cb}),p($).put(o)}});return}let E=[];for(let k of T){let A=await new Promise($=>{if(B.is(o[k])&&!U.is(o[k])){let N=P.random(),I=[{item:k,soul:b}];i.set(N,{chain:I,user:c.user}),p(N).put(o[k],$)}else E.push(k),$(null)});if(A){u(A,a);return}}if(E.length===0){u(null);return}t.get({"#":b},async k=>{if(k.err){u(`error getting ${b}: ${k.err}`);return}let A=k.put&&k.put[b];A||(A={}),E.forEach(N=>{A[N]=o[N]});let $=await S(b,A,c.user,u);$!==null&&t.put($,u)})},{secure:c.user||e.secure})};x()},on:(o,l,d,g)=>{if(typeof o=="function"&&(g=d,d=l,l=o,o=null),typeof l!="function"){console.log("error on() requires a callback function");return}if(!a){console.log("error please provide a key using get(key)"),l(null);return}let{item:c,soul:u}=w({on:o,_get:d,_opt:g},l);if(!u)return;let T=i.get(a);i.set(a,{chain:[{item:c,soul:u}],on:!0,user:T?T.user:null}),n.set(l,()=>{t.get({"#":u,".":c},v=>{let x=v.put&&v.put[u]&&v.put[u][c],j=U.is(x);if(j){let C=async(O=0)=>{let _=await new Promise(b=>{let E=P.random();i.set(E,{chain:[{item:null,soul:j}],user:T?T.user:null}),p(E).next(null,b,g)});_!==null||O>=5?l(_):(await new Promise(b=>setTimeout(b,50)),C(O+1))};C()}else l(x!==void 0?x:null)},{...g,secure:T.user||e.secure})});let h;o?(h=B.put(o,"#",u),h["."]!=null&&typeof h["."]=="number"&&(h={...h,".":String(h["."])})):h={"#":u,".":c},t.on(h,n.get(l),!1,g),t.get({"#":u,".":c},v=>{if(v.err){console.log(`error getting ${u}.${c}: ${v.err}`);return}let x=v.put&&v.put[u]&&v.put[u][c],j=U.is(x);if(j){t.off(h,n.get(l));let C;o?C=B.put(h,"#",j):C={"#":j,".":null},t.on(C,n.get(l),d,g)}else d&&n.get(l)()},{...g,secure:T.user||e.secure})},off:o=>{if(!a){console.log("error please provide a key using get(key)"),o&&o(null);return}let{item:l,soul:d}=w({off:!0},o);d&&t.get({"#":d,".":l},g=>{if(g.err){console.log(`error getting ${d}.${l}: ${g.err}`);return}let c=g.put&&g.put[d]&&g.put[d][l],u=U.is(c);u?t.off({"#":u},n.get(o)):t.off({"#":d},n.get(o)),n.delete(o),i.delete(a)})},user:()=>(r.get||(Object.assign(r,p()),r.get=(o,l,d,g)=>{typeof l=="function"&&(g=d,d=l,l=null);let c=null,u=null;if(r.is&&(c=r.is.pub),typeof o=="string"?u=o:o instanceof Array&&(o.length===2?(c=o[0],u=o[1]):o.length===1&&(u=o[0])),!c){console.log("error please log in or provide a public key"),d&&d(null);return}if(u===null||u===""||u==="_"){console.log("error please provide a key"),d&&d(null);return}if(l&&!d){console.log("error lex requires a callback function");return}a=P.random();let T=[{item:String(u),soul:"~"+c}];if(i.set(a,{chain:T,user:r.is,cb:d}),!d)return p(a);let h=f(a),{soul:v}=w({get:l,_opt:g},h);v&&y(l,v,h,g)}),r),wire:t,SEA:H}};return p()},Mt=it;export{Mt as default};
//# sourceMappingURL=holster.js.map
