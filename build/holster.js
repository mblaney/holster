var ue={is:e=>{if(e instanceof Array)return!1;if(typeof e=="number")return!isNaN(e);if(typeof e=="string"){let t=parseFloat(e);return!isNaN(t)&&isFinite(t)}return!1}},U={is:e=>{if(!e||typeof e!="object")return!1;let r=Object.prototype.toString.call(e).match(/^\[object (\w+)\]$/);return e.constructor===Object||r&&r[1]==="Object"},map:(e,t,r)=>{var n=Object.keys(e);for(let i=0;i<n.length;i++){let u=t(e[n[i]],n[i],r);if(typeof u<"u")return u}},put:(e,t,r)=>(e||(e={}),e[t]=r,e),del:(e,t)=>{if(e)return e[t]=null,delete e[t],e}},Be=(e,t,r)=>{if(r.id){r.id=!1;return}if(t==="#"&&typeof e=="string"){r.id=e;return}r.id=!1},D={is:e=>{if(e&&e["#"]&&!e._&&U.is(e)){let t={};if(U.map(e,Be,t),t.id)return t.id}return!1},ify:e=>U.put({},"#",e)},q="_holster_user_signature",F="_holster_user_public_key",X=(e,t,r,n)=>{let i=Date.now(),u={[e]:{_:{"#":e,">":{}}}};for(let[f,g]of Object.entries(t))f!=="_"&&f!==F&&f!==q&&(u[e][f]=g,u[e]._[">"][f]=i);return r&&n&&(u[e][q]=r,u[e]._[">"][q]=i,u[e][F]=n,u[e]._[">"][F]=i),u},V=(e,t)=>{if(typeof t>"u")return e===null;if(typeof e>"u")return!0;if(typeof e=="string")return e===t;if(!U.is(e)||!t)return!1;let r=e["*"];if(r)return t.slice(0,r.length)===r;let n=e[">"],i=e["<"];return n&&i?t>=n&&t<=i:n?t>=n:i?t<=i:!1},I={random:e=>{var t="";let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";e||(e=24);for(let n=0;n<e;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}};var Pe=e=>{e||(e=9e3);let t={store:{}};return t.check=r=>t.store[r]?t.track(r):!1,t.track=r=>(t.store[r]=Date.now(),t.expiry||(t.expiry=setTimeout(()=>{if(t.expiry)return;let n=Date.now();Object.keys(t.store).forEach(i=>{n-t.store[i]>e&&delete t.store[i]}),t.expiry=null},e)),r),t},Te=Pe;var Le=(e,t)=>{if(!e||typeof e!="object")throw new TypeError("lex must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");let r=e["#"];if(!r||typeof r!="string")throw new TypeError("soul must be a string");if(!t[r])return;let n={_:{"#":r,">":{}}};if(typeof e["."]=="string"){let i=e["."];if(typeof t[r][i]>"u")return;n[i]=t[r][i],n._[">"][i]=t[r]._[">"][i]}else for(let i of Object.keys(t[r]))V(e["."],i)&&(n[i]=t[r][i],n._[">"][i]=t[r]._[">"][i]);return{[r]:n}},he=Le;typeof btoa>"u"&&(globalThis.btoa=e=>Buffer.from(e,"binary").toString("base64"),globalThis.atob=e=>Buffer.from(e,"base64").toString("binary"));function le(){}Object.assign(le,{from:Array.from});le.prototype=Object.create(Array.prototype);le.prototype.toString=function(e,t,r){if(e||(e="utf8"),t||(t=0),r=r?Math.min(Math.max(r,t),this.length):this.length,e==="hex"){let n=new Uint8Array(this.slice(t,r));return Array.from(n,i=>i.toString(16).padStart(2,"0")).join("")}if(e==="utf8")return Array.from({length:r-t},(n,i)=>{let u=this[i+t];return u<0||u>1114111?"\uFFFD":String.fromCharCode(u)}).join("");if(e==="base64"){let n=Array.from({length:r-t},(i,u)=>{let f=this[u+t];return f<0||f>255?"\uFFFD":String.fromCharCode(f)}).join("");return btoa(n)}};var Q=le;var ae={MAX_BUFFER_SIZE:10*1024*1024,MAX_STRING_LENGTH:1024*1024};function Z(...e){return console.warn("new SafeBuffer() is deprecated, please use SafeBuffer.from()"),Z.from(...e)}Z.prototype=Object.create(Array.prototype);var ne=(e,t)=>{if(typeof e!="string")throw new TypeError("Input must be a string for encoding: "+t);if(e.length>ae.MAX_STRING_LENGTH)throw new RangeError(`String too large: ${e.length} > ${ae.MAX_STRING_LENGTH}`)},W=(e,t="buffer operation")=>{if(e>ae.MAX_BUFFER_SIZE)throw new RangeError(`Buffer size too large for ${t}: ${e} > ${ae.MAX_BUFFER_SIZE}`)},Fe=e=>{ne(e,"hex");let t=e.replace(/\s/g,"").toLowerCase();if(!/^[0-9a-f]*$/.test(t))throw new TypeError("Invalid hex string: contains non-hex characters");if(t.length%2!==0)throw new TypeError("Invalid hex string: must have even length");if(t.length===0)return new Uint8Array(0);W(t.length/2,"hex parsing");let r=new Uint8Array(t.length/2);for(let n=0;n<t.length;n+=2){let i=t.substr(n,2);r[n/2]=parseInt(i,16)}return r},Ee=e=>{ne(e,"utf8");try{let r=new TextEncoder().encode(e);return W(r.length,"UTF-8 encoding"),r}catch(t){throw new TypeError("Failed to encode UTF-8 string: "+t.message)}},He=e=>{ne(e,"binary"),W(e.length,"binary encoding");let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);if(n>255)throw new TypeError(`Invalid binary string: character at position ${r} exceeds byte range (${n} > 255)`);t[r]=n}return t},Ke=e=>{ne(e,"base64");let t=e.replace(/\s/g,"");if(!/^[A-Za-z0-9+/]*={0,2}$/.test(t))throw new TypeError("Invalid base64 string: contains invalid characters");try{let r=atob(t);W(r.length,"base64 decoding");let n=new Uint8Array(r.length);for(let i=0;i<r.length;i++)n[i]=r.charCodeAt(i);return n}catch(r){throw new TypeError("Failed to decode base64 string: "+r.message)}},ke=e=>{let t;if(e instanceof ArrayBuffer)W(e.byteLength,"ArrayBuffer processing"),t=new Uint8Array(e);else if(ArrayBuffer.isView(e))W(e.byteLength||e.length,"TypedArray processing"),t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);else if(Array.isArray(e)){W(e.length,"Array processing");for(let r=0;r<e.length;r++){let n=e[r];if(typeof n!="number"||n<0||n>255||!Number.isInteger(n))throw new TypeError(`Invalid byte value at index ${r}: ${n} (must be integer 0-255)`)}t=new Uint8Array(e)}else if(typeof e=="object"&&e!==null&&typeof e.length=="number"){W(e.length,"array-like processing");let r=Array.from(e);for(let n=0;n<r.length;n++){let i=r[n];if(typeof i!="number"||i<0||i>255||!Number.isInteger(i))throw new TypeError(`Invalid byte value at index ${n}: ${i} (must be integer 0-255)`)}t=new Uint8Array(r)}else throw new TypeError("Unsupported input type: "+typeof e);return t};Object.assign(Z,{from(){if(arguments.length===0)throw new TypeError("SafeBuffer.from() requires at least one argument");let t=arguments[0];if(t==null)throw new TypeError("First argument must not be null or undefined");let r;if(typeof t=="string"){let n=(arguments[1]||"utf8").toLowerCase();switch(n){case"hex":r=Fe(t);break;case"utf8":case"utf-8":r=Ee(t);break;case"binary":case"latin1":r=He(t);break;case"base64":r=Ke(t);break;case"ascii":ne(t,"ascii");for(let i=0;i<t.length;i++)if(t.charCodeAt(i)>127)throw new TypeError(`Invalid ASCII character at position ${i}: ${t.charCodeAt(i)} > 127`);r=Ee(t);break;default:throw new TypeError("Unknown encoding: "+n)}}else r=ke(t);if(!r||r.length===0)return Q.from(new Uint8Array(0));try{return Q.from(r)}catch(n){throw new Error("Failed to create SafeBuffer: "+n.message)}},alloc(e,t=0){if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new TypeError("Length must be a non-negative integer");if(W(e,"buffer allocation"),typeof t=="number"){if(t<0||t>255||!Number.isInteger(t))throw new TypeError("Fill value must be an integer between 0 and 255")}else if(typeof t=="string"){if(t.length!==1)throw new TypeError("Fill string must be exactly one character");if(t=t.charCodeAt(0),t>255)throw new TypeError("Fill character code must be <= 255")}else throw new TypeError("Fill must be a number or single character string");try{let r=new Uint8Array(e);return t!==0&&r.fill(t),Q.from(r)}catch(r){throw new Error("Failed to allocate buffer: "+r.message)}},concat(e){if(!Array.isArray(e))throw new TypeError("First argument must be an array");if(e.length===0)return Q.from(new Uint8Array(0));let t=0,r=[];for(let n=0;n<e.length;n++){let i=e[n];if(!i)throw new TypeError(`Array element at index ${n} is null or undefined`);let u;try{u=ke(i)}catch(f){throw new TypeError(`Invalid array element at index ${n}: ${f.message}`)}t+=u.length,W(t,"buffer concatenation"),r.push(u)}try{let n=new Uint8Array(t),i=0;for(let u of r)n.set(u,i),i+=u.length;return Q.from(n)}catch(n){throw new Error("Failed to concatenate buffers: "+n.message)}},isBuffer(e){return e instanceof Q||e&&typeof e=="object"&&e.constructor===Z},byteLength(e,t="utf8"){if(typeof e!="string")throw new TypeError("First argument must be a string");switch(t.toLowerCase()){case"utf8":case"utf-8":return new TextEncoder().encode(e).length;case"ascii":case"binary":case"latin1":return e.length;case"base64":let r=e.replace(/\s/g,"");return Math.floor(r.length*3/4)-(r.match(/=/g)||[]).length;case"hex":return Math.floor(e.replace(/\s/g,"").length/2);default:throw new TypeError("Unknown encoding: "+t)}}});Z.prototype.from=Z.from;Z.prototype.toString=function(e="utf8",t=0,r=this.length){if(typeof e!="string")throw new TypeError("Encoding must be a string");if(typeof t!="number"||!Number.isInteger(t)||t<0)throw new TypeError("Start must be a non-negative integer");if(typeof r!="number"||!Number.isInteger(r)||r<t)throw new TypeError("End must be an integer >= start");try{return Q.prototype.toString.call(this,e,t,r)}catch(n){throw new Error("Failed to convert buffer to string: "+n.message)}};var H=Z;var qe=typeof document>"u",$e=qe?(await import("node:crypto")).webcrypto:globalThis.crypto,M=$e.subtle,fe=e=>typeof e=="string"?e:JSON.stringify(e),oe=e=>{try{return JSON.parse(e)}catch{return e}},ce=e=>{let t=new Uint8Array(H.alloc(e));return H.from($e.getRandomValues(t))},ie=(e,t)=>{let[r,n]=e.split(".");return{kty:"EC",crv:"P-256",x:r,y:n,d:t,ext:!0,key_ops:t?["sign"]:["verify"]}},ge=async e=>{let t=await M.digest({name:"SHA-256"},new TextEncoder().encode(fe(e)));return H.from(t)},ye=async(e,t)=>{let r=e+t.toString("utf8"),n=H.from(await ge(r),"binary"),i=Je(n);return await M.importKey("jwk",i,{name:"AES-GCM"},!1,["encrypt","decrypt"])},Je=e=>({kty:"oct",k:e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"});var Ge={pair:async e=>{let t=await M.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async i=>{let u=await M.exportKey("jwk",i.publicKey);return{priv:(await M.exportKey("jwk",i.privateKey)).d,pub:u.x+"."+u.y}}),r=await M.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async i=>{let u=await M.exportKey("jwk",i.publicKey);return{epriv:(await M.exportKey("jwk",i.privateKey)).d,epub:u.x+"."+u.y}}),n={pub:t.pub,priv:t.priv,epub:r.epub,epriv:r.epriv};return e&&e(n),n},encrypt:async(e,t,r)=>{if(!t||!t.epriv)return r&&r(null),null;let n={s:ce(9),iv:ce(15)},i=await ye(t.epriv,n.s).then(f=>M.encrypt({name:"AES-GCM",iv:new Uint8Array(n.iv)},f,new TextEncoder().encode(fe(e)))),u={ct:H.from(i,"binary").toString("base64"),iv:n.iv.toString("base64"),s:n.s.toString("base64")};return r&&r(u),u},decrypt:async(e,t,r)=>{if(!e||!e.ct||!e.iv||!e.s||!t||!t.epriv)return r&&r(null),null;let n={ct:H.from(e.ct,"base64"),iv:H.from(e.iv,"base64"),s:H.from(e.s,"base64")};try{let i=await ye(t.epriv,n.s).then(f=>M.decrypt({name:"AES-GCM",iv:new Uint8Array(n.iv),tagLength:128},f,new Uint8Array(n.ct))),u=oe(new TextDecoder("utf8").decode(i));return r&&r(u),u}catch{return r&&r(null),null}},verify:async(e,t,r)=>{if(!t||!t.pub)return r&&r(null),null;let n=oe(e),i=await M.importKey("jwk",ie(t.pub),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),u={};if(typeof n.m=="string")u=n.m;else for(let o of Object.keys(n.m).sort())o!=="_"&&o!=F&&o!=q&&(u[o]=n.m[o]);let f=await ge(u),g=new Uint8Array(H.from(n.s,"base64")),s={name:"ECDSA",hash:{name:"SHA-256"}};if(await M.verify(s,i,g,new Uint8Array(f))){let o=oe(n.m);return r&&r(o),o}return r&&r(null),null},sign:async(e,t,r)=>{if(!t||!t.pub||!t.priv)return r&&r(null),null;let n={};if(typeof e=="string")n=e;else{let o=oe(e);for(let a of Object.keys(o).sort())a!=="_"&&a!=F&&a!=q&&(n[a]=o[a])}let i=await ge(n),u=ie(t.pub,t.priv),f={name:"ECDSA",namedCurve:"P-256"},g=await M.importKey("jwk",u,f,!1,["sign"]).then(o=>M.sign({name:"ECDSA",hash:{name:"SHA-256"}},o,new Uint8Array(i))),s={m:n,s:H.from(g,"binary").toString("base64")};return r&&r(s),s},work:async(e,t,r)=>{typeof t=="function"&&(r=t,t=void 0),typeof t>"u"&&(t=ce(9));let n=await M.importKey("raw",new TextEncoder().encode(fe(e)),{name:"PBKDF2"},!1,["deriveBits"]),i={name:"PBKDF2",iterations:1e5,salt:new TextEncoder().encode(t),hash:{name:"SHA-256"}},u=await M.deriveBits(i,n,512),f={epriv:H.from(u,"binary").toString("base64")};return r&&r(f),f},secret:async(e,t,r)=>{if(!e||!e.epub||!t||!t.epub||!t.epriv)return r&&r(null),null;let n={name:"ECDH",namedCurve:"P-256"},i=ie(e.epub),u=await M.importKey("jwk",i,n,!0,[]),f=ie(t.epub,t.epriv,!1);delete f.key_ops;let g=await M.importKey("jwk",f,n,!1,["deriveBits"]).then(async s=>{let o=await M.deriveBits({public:u,name:"ECDH",namedCurve:"P-256"},s,256),a=await M.importKey("raw",new Uint8Array(o),{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return M.exportKey("jwk",a).then(({k:p})=>p)});return r&&r({epriv:g}),{epriv:g}}},P=Ge;var je=100,xe=1e4,me=(e,t,r,n)=>e<t?{historical:!0}:e>t?{incoming:!0}:(typeof r!="string"&&(r=JSON.stringify(r)||""),typeof n!="string"&&(n=JSON.stringify(n)||""),r===n?{state:!0}:r<n?{current:!0}:{incoming:!0});me.mix=async(e,t,r,n)=>{if(!e||typeof e!="object")throw new TypeError("change must be an object");if(!t||typeof t!="object")throw new TypeError("graph must be an object");if(!n||typeof n!="object")throw new TypeError("listen must be an object");let i=Date.now(),u={},f={},g=0;for(let o of Object.keys(e)){let a=e[o],p=!1,h=!1,l=0,c=r;if(!a||!a._)continue;let d=a[q],m=a[F];if(d&&m&&(c=!0),o.length>1&&o[0]==="~")if(o[1]==="@")h=!0,c=!1;else{if(m&&o!="~"+m){console.log(`error public key does not match for soul: ${o}`);continue}c=!0}if(!(c&&(!d||!m||!await P.verify({m:a,s:d},{pub:m})))){for(let y of Object.keys(a)){if(y==="_")continue;let S=a[y],x=a._&&a._[">"]?a._[">"][y]:0,$=(t[o]||{})[y],j=(t[o]||{_:{">":{}}})._[">"][y]||0;if(h&&y!==D.is(S)){console.log(`error alias ${h}: ${y} !== ${D.is(S)}`);continue}let A=x-i;if(A>0){if(A>864e5)continue;(g===0||A<g)&&(g=l=A),f[o]||(f[o]={_:{"#":o,">":{}}}),f[o][y]=S,f[o]._[">"][y]=x}else me(x,j,S,$).incoming&&(u[o]||(u[o]={_:{"#":o,">":{}}}),t[o]||(t[o]={_:{"#":o,">":{}}}),t[o][y]=u[o][y]=S,t[o]._[">"][y]=u[o]._[">"][y]=x,n[o]&&setTimeout(()=>{n[o]&&n[o].filter(T=>V(T["."],y)).forEach(T=>T.cb())},je),p=!0)}c&&l!==0&&u[o]&&(Object.assign(f[o],u[o]),delete u[o]),p&&n[o]&&setTimeout(()=>{n[o]&&n[o].filter(y=>V(y["."])).forEach(y=>y.cb())},je)}}let s=Object.keys(t);return s.length>xe&&s.map(p=>{let h=t[p]._&&t[p]._[">"],l=h?Math.max(...Object.values(h)):0;return{soul:p,maxState:l}}).sort((p,h)=>p.maxState-h.maxState).slice(0,s.length-xe).forEach(({soul:p})=>delete t[p]),{now:u,defer:f,wait:g}};var we=me;var J="",re="",Ce=()=>{let e=(t,r,n)=>{if(n||(e[J]||(e[J]={}),n=e[J]),!t)return n;let i=0,u={},f=t[i],g=t.length-1,s=typeof r>"u",o=n[f];for(;!o&&i<g;)f+=t[++i],o=n[f];if(o)if(i===g){if(s)return typeof o[re]>"u"?o[J]:o[re];o[re]=r}else return!o[J]&&!s&&(o[J]={}),e(t.slice(++i),r,o[J]);else if(U.map(n,(p,h)=>{let l=0,c="";for(;h[l]===t[l];)c+=h[l++];if(c){if(s)return l<=g?void 0:(u[h.slice(l)]=p,p);let d={[h.slice(l)]:p,[t.slice(l)]:{[re]:r}};return n[c]={[J]:d},delete n[h],!0}})){if(s)return u}else{if(s)return;n[f]||(n[f]={}),n[f][re]=r}};return e};Ce.map=function e(t,r,n,i){i||(i=[]);var u=t[J]||t,f=Object.keys(u).sort(),g;for(let s=0;s<f.length;s++){let o=f[s],a=u[o],p=a[re];if(typeof p<"u"){if(p=r(p,i.join("")+o,o,i),typeof p<"u")return p}else n&&r(g,i.join(""),o,i);if(a[J]){if(i.push(o),p=e(a[J],r,n,i),typeof p<"u")return p;i.pop()}}};var K=Ce;var Ae="",Oe="",B="",te=e=>{var t;let r=new Map,n=new Map;if(e||(e={}),e.log||(e.log=console.log),e.batch||(e.batch=100),e.write||(e.write=1),e.size||(e.size=1024*1024),!e.store){e.log("Radisk needs `store` interface with `{get: fn, put: fn, list: fn}`");return}if(!e.store.get){e.log("Radisk needs `store.get` interface with `(file, cb)`");return}if(!e.store.put){e.log("Radisk needs `store.put` interface with `(file, data, cb)`");return}if(!e.store.list){e.log("Radisk needs a streaming `store.list` interface with `(cb)`");return}let i=(f,g,s,o)=>{let a=Date.now()-g;a>1e3&&console.log(`[RADISK-SLOW] ${f}: ${a}ms for ${s}${o?` (${o} bytes)`:""}`)},u=(f,g,s)=>{if(f=""+f,typeof g=="function"){if(s=g,g=u.batch(f),typeof g<"u"||u.thrash.at&&(g=u.thrash.at(f),typeof g<"u"))return s(t,g);if(n.has(f)){n.get(f).push(s);return}n.set(f,[s]);let o=Date.now();return u.read(f,(a,p)=>{i("read",o,f);let h=n.get(f)||[];n.delete(f),h.forEach(l=>l(a,p))})}if(u.batch(f,g),s&&u.batch.acks.push(s),++u.batch.ed>=e.batch)return u.thrash();clearTimeout(u.batch.timeout),u.batch.timeout=setTimeout(u.thrash,e.write)};return u.batch=K(),u.batch.acks=[],u.batch.ed=0,u.thrash=()=>{if(u.thrash.ing)return u.thrash.more=!0;let f=Date.now();clearTimeout(u.batch.timeout),u.thrash.more=!1,u.thrash.ing=!0;var g=u.thrash.at=u.batch;u.batch=null,u.batch=K(),u.batch.acks=[],u.batch.ed=0;let s=0;u.save(g,o=>{++s>1||(i("thrash",f,`batch-${g.ed}`),o&&e.log(o),g.acks.forEach(a=>a(o)),u.thrash.at=null,u.thrash.ing=!1,u.thrash.more&&u.thrash())})},u.save=(f,g)=>{let s={find:(o,a)=>{if(!(a<s.start))return s.start=a,e.store.list(s.lex),!0},lex:o=>{!o||o>s.start?(s.end=o,s.start&&s.mix(s.file||"!",s.start,s.end)):s.file=o},mix:(o,a,p)=>{if(s.start=s.end=s.file=t,r.has(o)){let h=r.get(o);K.map(f,(l,c)=>{if(!(c<a)){if(p&&p<c){s.start=c;return}h(c,l)}}),u.write(o,h,s.next)}else u.parse(o,(h,l)=>{if(h)return g(h);K.map(f,(c,d)=>{if(!(d<a)){if(p&&p<d){s.start=d;return}l(d,c)}}),u.write(o,l,s.next)})},next:o=>{if(o)return g(o);if(s.start)return K.map(f,s.find);g(o)}};K.map(f,s.find)},u.write=(f,g,s)=>{r.delete(f);let o={text:"",limit:"",done:!1,count:0,each:(p,h,l,c)=>{if(o.done)return;o.count++,p=typeof p>"u"?"":"="+te.encode(p);let d=te.encode(c.length)+"#"+te.encode(l)+p+`
`;if(o.count>1&&c.length===0&&o.text.length+d.length>e.size){let m=l.indexOf(Oe);if(o.limit=m===-1?l:l.substring(0,m),o.limit!==f){o.done=!0,o.sub=K(),K.map(g,o.slice),u.write(o.limit,o.sub,s);return}}o.text+=d},slice:(p,h)=>{h<o.limit||o.sub(h,p)}};K.map(g,o.each,!0);let a=Date.now();e.store.put(f,o.text,p=>{i("file-write",a,f,o.text.length),s(p)})},u.read=(f,g)=>{let s=f.indexOf(Oe),o=s===-1?f:f.substring(0,s),a={lex:p=>{if(!p){if(!a.file){g("no file found",t);return}if(r.has(a.file)){let h=r.get(a.file);if(a.value=h(f),typeof a.value<"u")return g(t,a.value)}u.parse(a.file,a.it);return}p>o||p<a.file||(a.file=p)},it:(p,h)=>{p&&e.log(p),h&&(r.set(a.file,h),a.value=h(f)),g(p,a.value)}};e.store.list(a.lex)},u.parse=(f,g)=>{let s={disk:K(),read:(o,a)=>{if(o)return g(o);if(!a)return g(t,s.disk);let p=[],h="",l=s.split(a);for(;l;){let c,d,m=l[1];l=s.split(l[2])||"",l[0]==="#"&&(c=l[1],m<p.length&&(p.length=m),m<=p.length&&(p[m]=c,p.length=m+1),h=p.join("")),l=s.split(l[2])||"",l[0]!==`
`&&(l[0]==="="&&(d=l[1]),typeof c<"u"&&typeof d<"u"&&s.disk(h,d),l=s.split(l[2]))}g(t,s.disk)},split:o=>{if(!o)return;let a=o.indexOf(B);if(a===-1)return;let p=o.slice(0,a),h={};return[p,te.decode(o.slice(a),h),o.slice(a+h.i)]}};e.store.get(f,s.read)},u};te.encode=e=>{let t="";if(e instanceof Array&&e.length===2&&(t=Ae+e[1],e=e[0]),typeof e=="string"){let n=0,i=null,u=B;for(;i=e[n++];)i===B&&(u+=B);return u+'"'+e+t+B}let r=D.is(e);if(r)return B+"#"+r+t+B;if(ue.is(e))return B+"+"+(e||0)+t+B;if(e===!0)return B+"+"+t+B;if(e===!1)return B+"-"+t+B;if(e===null)return B+" "+t+B};te.decode=(e,t)=>{var r=-1,n=0,i=null,u=null,f=-1,g=-1;if(e[0]!==B)return;for(;i=e[++r];)if(u){if(f===-1&&(f=r),i===B&&--n<=0){g=r;break}}else i===B?n++:u=i||!0;let s=f!==-1?e.slice(f,g!==-1?g:r):"";t&&(t.i=r+1);let[o,a]=s.split(Ae);if(a){if(a=parseFloat(a),u==='"')return[o,a];if(u==="#")return[D.ify(o),a];if(u==="+")return o.length===0?[!0,a]:[parseFloat(o),a];if(u==="-")return[!1,a];if(u===" ")return[null,a]}else{if(u==='"')return s;if(u==="#")return D.ify(s);if(u==="+")return s.length===0?!0:parseFloat(s);if(u==="-")return!1;if(u===" ")return null}};var _e=te;var Ie=typeof document>"u",Y=Ie?await import("node:fs"):void 0,Ne="",pe="",be=pe+"+0"+pe+"#"+pe+'"root'+pe,ze=e=>{let t=e.file;if(Ie)return Y.existsSync(t)||Y.mkdirSync(t),Y.existsSync(t+"/!")||Y.writeFileSync(t+"/!",be),{get:(r,n)=>{Y.readFile(t+"/"+r,(i,u)=>{if(i){if(i.code==="ENOENT"){n();return}console.log("fs.readFile error:",i)}u&&(u=u.toString()),n(i,u)})},put:(r,n,i)=>{var u=r+"."+I.random(9)+".tmp";Y.writeFile(u,n,f=>{if(f){console.log("fs.writeFile error:",f),i(f);return}Y.rename(u,t+"/"+r,i)})},list:r=>{Y.readdir(t,(n,i)=>{if(n){console.log("fs.readdir error:",n),r();return}i.forEach(r),r()})}};if(e.indexedDB){let r,n=indexedDB.open(t,1);return n.onupgradeneeded=i=>{i.target.result.createObjectStore(t)},n.onerror=i=>{console.log(i)},n.onsuccess=()=>{if(r=n.result,r){let u=r.transaction([t],"readonly").objectStore(t).getKey("!");u.onerror=()=>{console.log(`error getting key ${t}/!`)},u.onsuccess=()=>{if(!u.result){let g=r.transaction([t],"readwrite").objectStore(t).put(be,"!");g.onerror=()=>{console.log(`error putting root on ${t}/!`)}}}}else console.log("error indexedDB not available")},{get:(i,u)=>{let f=(o,a)=>{let h=r.transaction([t],"readonly").objectStore(t).get(o);h.onerror=()=>{console.log(`error getting ${t}/${o}`)},h.onsuccess=()=>{a(null,h.result)}};if(r){f(i,u);return}let g=0,s=setInterval(()=>{if(r){clearInterval(s),f(i,u);return}g++>5&&(clearInterval(s),u("error indexedDB not available"))},1e3)},put:(i,u,f)=>{let g=(a,p,h)=>{let c=r.transaction([t],"readwrite").objectStore(t).put(p,a);c.onerror=()=>{console.log(`error putting data on ${t}/${a}`)},c.onsuccess=()=>{h(null)}};if(r){g(i,u,f);return}let s=0,o=setInterval(()=>{if(r){clearInterval(o),g(i,u,f);return}s++>5&&(clearInterval(o),f("error indexedDB not available"))},1e3)},list:i=>{let u=s=>{let a=r.transaction([t],"readonly").objectStore(t).getAllKeys();a.onerror=()=>console.log("error getting keys for",t),a.onsuccess=()=>{a.result.forEach(s),s()}};if(r){u(i);return}let f=0,g=setInterval(()=>{if(r){clearInterval(g),u(i);return}f++>5&&(clearInterval(g),console.log("error indexedDB not available"),i())},1e3)}}}return{get:(r,n)=>{n(null,be)},put:(r,n,i)=>{i(null)},list:r=>{r("!"),r()}}},Xe=e=>{U.is(e)||(e={}),e.file=String(e.file||"radata"),e.store||(e.store=ze(e));let t=_e(e);return{get:(r,n)=>{if(!r||!U.is(r)){n("lex required");return}if(!r["#"]){n("soul required in lex");return}var i=r["#"],u=typeof r["."]=="string"?r["."]:"",f;let g=(s,o)=>{V(r["."],o)&&(f||(f={_:{"#":i,">":{}}}),f[o]=s[0],f._[">"][o]=s[1])};t(i+Ne+u,(s,o)=>{let a;U.is(o)?(K.map(o,g),f||g(o,u),a={[i]:f}):o&&(g(o,u),a={[i]:f}),n(s,a)})},put:(r,n)=>{if(!r){n("graph required");return}let i=0,u=!1,f=g=>{if(i--,!u){if(g){u=!0,n(g);return}i===0&&(u=!0,n(null))}};Object.keys(r).forEach(g=>{var s=r[g];Object.keys(s).forEach(o=>{if(o==="_")return;i++;let a=s[o],p=s._[">"][o];t(g+Ne+o,[a,p],f)})})}}},Re=Xe;var De=typeof document>"u",Me=De?await import("ws"):void 0;typeof globalThis.WebSocket>"u"&&(globalThis.WebSocket=Me?.WebSocket);var Qe=e=>{let t=new Map,r=e.maxRequestsPerMinute||100,n=e.rateLimitWindow||6e4,i=e.disconnectThreshold||10,u=e.wss&&e.wss.constructor.name==="Server",f=null;return u||(f=setInterval(()=>{let s=Date.now();for(let[o,a]of t.entries())s-a.lastCleanup>n&&(a.requests=[],a.lastCleanup=s),a.requests=a.requests.filter(p=>s-p<n),s-a.lastCleanup>n*10&&(a.throttleCount=0)},n/4)),{getDelay:s=>{let o=Date.now(),a=t.get(s)||{requests:[],lastCleanup:o,throttleCount:0};if(a.requests=a.requests.filter(p=>o-p<n),a.requests.length>=r){let p=Math.min(...a.requests),h=n-(o-p);return a.throttleCount=(a.throttleCount||0)+1,t.set(s,a),Math.max(0,h)}return a.requests.push(o),t.set(s,a),0},getRemainingRequests:s=>{let o=t.get(s);if(!o)return r;let a=Date.now(),p=o.requests.filter(h=>a-h<n);return Math.max(0,r-p.length)},getThrottleCount:s=>{let o=t.get(s);return o&&o.throttleCount||0},shouldDisconnect:s=>{let o=t.get(s);return o?o.throttleCount>=i:!1},destroy:()=>{f&&(clearInterval(f),f=null),t.clear()}}},Ze=(e,t=1024*1024)=>{try{if(typeof e=="string"&&e.length>t)throw new Error("Message too large");return{success:!0,data:JSON.parse(e)}}catch(r){return{success:!1,error:r.message}}},Ye=(e,t=1024*1024)=>typeof e=="string"&&e.length>t?{valid:!1,error:"Message too large"}:Buffer.isBuffer(e)&&e.length>t?{valid:!1,error:"Message too large"}:{valid:!0},Ve=(e=1e3)=>{let t=new Set;return{add:r=>{if(t.size>=e)return!1;t.add(r);let n=r.close;return r.close=(...i)=>(t.delete(r),n.apply(r,i)),!0},remove:r=>{t.delete(r)},count:()=>t.size,isFull:()=>t.size>=e}},Se=(e=5)=>{let t=0;return{shouldRetry:()=>t<e,getDelay:()=>Math.min(1e3*Math.pow(2,t),3e4),increment:()=>t++,reset:()=>t=0}},et=e=>{let t=Te(e.maxAge),r=Re(e),n={},i={},u={},f=new Set,g=async T=>n[T]?!0:new Promise(v=>{r.get({"#":T},(w,b)=>{v(!w&&b&&b[T])})}),s=Qe(e),o=Ve(e.maxConnections||1e3),a=async(T,v,w)=>{for(let b of Object.keys(T)){let k=await new Promise(C=>{l({"#":b},C,v)});if(k.err)return w&&w(k.err),!1;let E=T[b],O=F;if(!(!k.put||!k.put[b]||k.put[b][O]===E[O]))return w&&w(`error in wire check public key does not match for soul: ${b}`),!1}return!0},p=(T,v)=>{let w=he(T.get,n);w?v(JSON.stringify({"#":t.track(I.random(9)),"@":T["#"],put:w})):r.get(T.get,(b,k)=>{v(JSON.stringify({"#":t.track(I.random(9)),"@":T["#"],put:k,err:b}))})},h=async(T,v)=>{let w=await we.mix(T.put,n,e.secure,u);if(Object.keys(w.now).length){if(!await a(w.now,v))return;r.put(w.now,b=>{v(JSON.stringify({"#":t.track(I.random(9)),"@":T["#"],err:b}))})}Object.keys(w.defer).length&&setTimeout(()=>h({put:w.defer},v),w.wait)},l=(T,v,w,b)=>{if(!v)return;U.is(b)||(b={});let k=he(T,n),E=I.random(9),O=JSON.stringify({"#":t.track(E),get:e.secure?{"#":T["#"]}:T});if(k){let C=w(O);if(C&&C.err){v({err:C.err});return}v({put:k});return}r.get(T,(C,L)=>{if(L){let R=w(O);if(R&&R.err){v({err:R.err});return}v({put:L,err:C});return}C&&console.log(C),i[E]=v;let N=w(O);if(N&&N.err){v({err:N.err}),delete i[E];return}setTimeout(()=>{let R=i[E];if(R){let G=T["#"],z={[G]:null};typeof T["."]=="string"&&(z[G]={[T["."]]:null}),R({put:z}),delete i[E]}},b.wait||100)})},c=T=>({get:(v,w,b)=>{v&&v["#"]&&f.add(v["#"]),l(v,w,T,b)},put:async(v,w)=>{let b=await we.mix(v,n,e.secure,u);if(Object.keys(b.now).length===0){w(null);return}if(!await a(b.now,T,w))return;for(let[O,C]of Object.entries(b.now))if(C&&typeof C=="object")for(let[L,N]of Object.entries(C)){let R=D.is(N);R&&f.add(R)}r.put(b.now,w);let E=T(JSON.stringify({"#":t.track(I.random(9)),put:v}));if(E&&E.err){w&&w(E.err);return}},on:(v,w,b,k)=>{let E=v&&v["#"];!E||!w||(u[E]?u[E].push({".":v["."],cb:w}):u[E]=[{".":v["."],cb:w}],b&&l(v,w,T,k))},off:(v,w)=>{let b=v&&v["#"];if(!(!b||!u[b]))if(w){let k=u[b].find(E=>E.cb===w);k&&u[b].splice(u[b].indexOf(k),1)}else delete u[b]}});if(De){let T=e.wss,v=()=>T.clients();if(!T){let b=e.server?{server:e.server}:{port:e.port||8765};T=new Me.WebSocketServer(b),v=()=>T.clients}let w=(b,k)=>{v().forEach(E=>{if(E&&E.readyState===WebSocket.OPEN)E.send(b,{binary:k});else{let O=E._retryHandler||Se();if(E._retryHandler=O,O.shouldRetry()){let C=O.getDelay();O.increment(),setTimeout(()=>{E&&E.readyState===WebSocket.OPEN&&(O.reset(),E.send(b,{binary:k}))},C)}}})};return T.on("connection",b=>{if(!o.add(b)){console.log("Connection limit reached, rejecting connection"),b.close(1013,"Connection limit reached - try again later");return}let k=I.random(9);console.log(`[HOLSTER-CONNECT] New WebSocket client connected: ${k}`),b.on("error",E=>{console.error("WebSocket error:",E),o.remove(b)}),b.on("close",()=>{console.log(`[HOLSTER-DISCONNECT] WebSocket client disconnected: ${k}`),o.remove(b)}),b.on("message",(E,O)=>{let C=Ye(E,e.maxMessageSize);if(!C.valid){console.warn(`Invalid message: ${C.error}`),b.send(JSON.stringify({error:C.error}));return}let L=Ze(E,e.maxMessageSize);if(!L.success){console.warn(`JSON parse error: ${L.error}`),b.send(JSON.stringify({error:"Invalid JSON"}));return}let N=L.data;if(t.check(N["#"]))return;let R=s.getDelay(k);if(R>0){let z=s.getThrottleCount(k);if(console.log(`[HOLSTER-THROTTLE] Client ${k}: rate limit exceeded, delay would be ${R}ms, dropping message (throttle count: ${z})`),s.shouldDisconnect(k)){console.error(`[HOLSTER-DISCONNECT] Client ${k}: Disconnecting bad actor after ${z} throttle violations`),b.close(1008,"Rate limit violations - bad actor");return}b.send(JSON.stringify({"#":t.track(I.random(9)),"@":N["#"],err:`Rate limit exceeded. Slow down requests. Wait ${Math.ceil(R/1e3)}s`,throttle:R}));return}let G=()=>{t.track(N["#"]),N.get&&p(N,w),N.put&&h(N,w),w(E,O);let z=N["@"],se=i[z];se&&(delete N["#"],delete N["@"],se(N),delete i[z])};R>0?setTimeout(G,R):G()})}),c(w)}let d=[],m=!1,y=0,S=[],x=null,$=e.maxQueueLength||1e3,j=()=>{if(S.length===0){x=null;return}let T=Date.now();if(m&&T<y){x=setTimeout(j,Math.min(1e3,y-T));return}m&&T>=y&&(console.log("[CLIENT-THROTTLED] Throttle period ended, resuming queue processing"),m=!1,y=0);let v=S.shift();A(v),S.length>0?x=setTimeout(j,100):x=null},A=T=>{d.forEach(v=>{if(v&&v.readyState===WebSocket.OPEN)v.send(T);else{let w=v._retryHandler||Se();if(v._retryHandler=w,w.shouldRetry()){let b=w.getDelay();w.increment(),setTimeout(()=>{v&&v.readyState===WebSocket.OPEN&&(w.reset(),v.send(T))},b)}}})},_=T=>{if(m||S.length>0){if(S.length>=$)return{err:`Message queue exceeded maximum length (${$}). Update query logic to request less data.`,queueLength:S.length,maxQueueLength:$};S.push(T),console.log(`Queuing message (queue length: ${S.length}/${$})`),x||(x=setTimeout(j,100));return}A(T)};return e.peers instanceof Array||(e.peers=[`ws://localhost:${e.port||8765}`]),e.peers.forEach(T=>{let v=()=>{let w=new WebSocket(T);d.push(w);let b=Se();w.onclose=k=>{if(d.indexOf(w)!==-1&&d.splice(d.indexOf(w),1),w=null,b.shouldRetry()){let E=b.getDelay();b.increment(),setTimeout(v,E)}},w.onopen=()=>{b.reset()},w.onerror=k=>{console.error(k)},w.onmessage=async k=>{let E=JSON.parse(k.data);if(t.check(E["#"]))return;if(E.throttle&&E.err){console.log(`[CLIENT-THROTTLED] Server throttling: ${E.err}`),m=!0,y=Date.now()+E.throttle;return}if(t.track(E["#"]),E.get&&p(E,_),E.put){let L={};for(let[N,R]of Object.entries(E.put)){let G=!1;if(await g(N)&&(G=!0,R&&typeof R=="object"))for(let[z,se]of Object.entries(R)){let ve=D.is(se);ve&&f.add(ve)}f.has(N)&&(G=!0,f.delete(N)),G&&(L[N]=R)}Object.keys(L).length>0&&h({put:L},_)}_(k.data);let O=E["@"],C=i[O];C&&(delete E["#"],delete E["@"],C(E),delete i[O])}};v()}),c(_)},de=et;var tt=(e,t)=>{t||(t=de(e));let r=[],n=!1,i=!1,u=0,f=(s,o,a,p)=>{let h=m=>{u++,f(m,o,a,p)},l=m=>{r=[],u=0,i=!1,p(m)},c=()=>{if(r.length===0){l("Wrong username or password");return}let m=r.shift();t.get({"#":m},async y=>{if(y.err){l(`error getting ${m}: ${y.err}`);return}let S=y.put&&y.put[m];if(!S||!S.auth)return c();let x=JSON.parse(S.auth),$=await P.work(o,x.salt),j=await P.decrypt(x.enc,$);if(!j)return c();if(g.is={username:s,pub:S.pub,epub:S.epub,priv:j.priv,epriv:j.epriv},a!==""){let A=I.random(64),_=await P.work(a,A),T=await P.encrypt(j,_),v={username:s,pub:S.pub,epub:S.epub,auth:JSON.stringify({enc:T,salt:A})},w=await P.sign(v,g.is),b=X(m,w.m,w.s,S.pub);t.put(b,k=>{l(k?`error putting ${v} on ${m}: ${k}`:null)});return}return l(null)},{wait:1e3})};if(u>9){l("Wrong username or password");return}let d="~@"+s;t.get({"#":d},async m=>{if(m.err){l(`error getting ${d}: ${m.err}`);return}let y=m.put&&m.put[d];if(!y)return h(s);delete m.put[d]._,r=Object.keys(y),c()},{wait:1e3})},g={create:(s,o,a)=>{let p=l=>{a?a(l):console.log(l)};if(n){p("User is already being created");return}if(s===""){p("Please provide a username");return}if(o===""){p("Please provide a password");return}n=!0;let h="~@"+s;t.get({"#":h},async l=>{if(l.err){n=!1,p(`error getting ${h}: ${l.err}`);return}if(l.put&&l.put[h]){n=!1,p("Username already exists");return}let c=I.random(64),d=await P.work(o,c),m=await P.pair(),y={priv:m.priv,epriv:m.epriv},S=await P.encrypt(y,d),x={username:s,pub:m.pub,epub:m.epub,auth:JSON.stringify({enc:S,salt:c})},$="~"+m.pub,j=await P.sign(x,m),A=X($,j.m,j.s,m.pub);t.put(A,_=>{if(n=!1,_){p(`error putting ${x} on ${$}: ${_}`);return}let T={[$]:{"#":$}};t.put(X(h,T),v=>{if(v){p(`error putting ${T} on ${h}: ${v}`);return}a&&a(null)})})},{wait:1e3})},auth:(s,o,a)=>{let p=h=>{a?a(h):h&&console.log(h)};if(i){p("User is already authenticating");return}if(g.is=null,s===""){p("Please provide a username");return}if(o===""){p("Please provide a password");return}i=!0,f(s,o,"",p)},change:(s,o,a,p)=>{let h=l=>{p?p(l):l&&console.log(l)};if(i){h("User is already authenticating");return}if(g.is=null,s===""){h("Please provide a username");return}if(o===""){h("Please provide a password");return}if(a===""){h("Please provide a new password");return}i=!0,f(s,o,a,h)},store:s=>{if(!g.is){console.log("Please authenticate before calling store");return}if(s){typeof globalThis.localStorage<"u"&&globalThis.localStorage.setItem("user.is",JSON.stringify(g.is)),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is");return}typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.setItem("user.is",JSON.stringify(g.is)),typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is")},recall:()=>{if(typeof globalThis.localStorage<"u"){let s=globalThis.localStorage.getItem("user.is");if(s){g.is=JSON.parse(s);return}}if(typeof globalThis.sessionStorage<"u"){let s=globalThis.sessionStorage.getItem("user.is");s&&(g.is=JSON.parse(s))}},leave:()=>{g.is=null,typeof globalThis.localStorage<"u"&&globalThis.localStorage.removeItem("user.is"),typeof globalThis.sessionStorage<"u"&&globalThis.sessionStorage.removeItem("user.is")},delete:(s,o,a)=>{let p=h=>{a?a(h):console.log(h)};if(i){p("User is already authenticating");return}if(s===""){p("Please provide a username");return}if(o===""){p("Please provide a password");return}i=!0,f(s,o,"",async h=>{if(h){p(h);return}let l={username:null,pub:null,epub:null,auth:null},c=await P.sign(l,g.is),d="~"+g.is.pub,m=X(d,c.m,c.s,g.is.pub);t.put(m,y=>{if(y){p(`error putting null on ${d}: ${y}`);return}g.is=null,a&&a(null)})})}};return g},Ue=tt;var rt=e=>{typeof e=="string"?e={peers:[e]}:e instanceof Array?e={peers:e}:U.is(e)||(e={});let t=de(e),r=Ue(null,t),n=new Map,i=new Map,u=s=>s===null||s===!0||s===!1||typeof s=="string"||D.is(s)||ue.is(s),f=s=>{if(u(s))return!0;if(U.is(s)){let a=[];for(let[p,h]of Object.entries(s)){if(p==="_")return"error underscore cannot be used as a property name";if(U.is(h)||u(h)){a.push(p);continue}return typeof h>"u"?`error undefined ${p} cannot be converted to a graph`:`error ${JSON.stringify({[p]:h})} cannot be converted to a graph`}if(a.length!==0)return a}return`error ${JSON.stringify(s)} cannot be converted to a graph`},g=s=>{let o=(l,c,d,m)=>{t.get(U.put(l,"#",c),async y=>{if(y.err&&console.log(y.err),y.put&&y.put[c]){delete y.put[c]._,delete y.put[c][F],delete y.put[c][q];for(let S of Object.keys(y.put[c])){let x=D.is(y.put[c][S]);if(x){let $=await new Promise(j=>{let A=I.random();i.set(A,{chain:[{item:null,soul:x}]}),g(A).next(null,j,m)});y.put[c][S]=$}}d(y.put[c])}else d(null)},m)},a=async(l,c,d,m)=>{if(d){let y=await P.sign(c,d);return X(l,y.m,y.s,d.pub)}return e.secure?(m||(m=console.log),m(`error putting data on ${l}: user required in secure mode`),null):X(l,c)},p=l=>c=>{let d=i.get(l);d&&typeof d.cb<"u"?setTimeout(()=>d.cb(c),1):c&&console.log("error no callback for data",c,"ctx",d),d&&!d.on&&i.delete(l)},h=(l,c)=>{if(!l){console.log("error resolve request parameter required");return}let d=typeof l.get<"u",m=typeof l.put<"u",y=typeof l.on<"u",S=typeof l.off<"u",x=!1,$=i.get(s);for(var j=1;j<$.chain.length;j++)if($.chain[j].soul===null){x=!0;break}if(x){let{item:A,soul:_}=$.chain[j-1],T=$.user||e.secure?{"#":_}:{"#":_,".":A};return t.get(T,async v=>{if(v.err){$.user||e.secure?console.log(`error getting ${_}: ${v.err}`):console.log(`error getting ${A} on ${_}: ${v.err}`),c&&c(null);return}let w=v.put&&v.put[_];if(w&&typeof w[A]<"u"){let b=D.is(w[A]);if(b)$.chain[j].soul=b,i.set(s,{...$}),d?g(s).next(null,l.get,c,l._opt):m?g(s).put(l.put,c):y?g(s).on(l.on,c,l._get,l._opt):S&&g(s).off(c);else if(d)c(w[A]);else if(m){b=I.random(),w[A]=D.ify(b);let k=await a(_,w,$.user,c);if(k===null)return;t.put(k,E=>{if(E){c(`error putting ${A} on ${_}: ${E}`);return}$.chain[j].soul=b,g(s).put(l.put,c)})}else(y||S&&c)&&c(null)}else if(m){let b=I.random();w||(w={}),w[A]=D.ify(b);let k=await a(_,w,$.user,c);if(k===null)return;t.put(k,E=>{if(E){c(`error putting ${A} on ${_}: ${E}`);return}$.chain[j].soul=b,g(s).put(l.put,c)})}else c&&c(null)},l._opt),!1}return d&&$.chain[$.chain.length-1].item!==null?($.chain.push({item:null,soul:null}),g(s).next(null,l.get,c,l._opt),!1):$.chain[$.chain.length-1]};return{get:(l,c,d,m)=>{if(typeof c=="function"&&(m=d,d=c,c=null),l===null||l===""||l==="_"){console.log("error please provide a key"),d&&d(null);return}if(c&&typeof d!="function"){console.log("error lex requires a callback function");return}if(s=I.random(),i.set(s,{chain:[{item:l,soul:"root"}],cb:d}),!d)return g(s);let y=p(s),{soul:S}=h({get:c,_opt:m},y);S&&o(c,S,y,m)},next:(l,c,d,m)=>{let y=j=>A=>{d?d(A):p(j)(A)};if(typeof c=="function"&&(m=d,d=c,c=null),!s){console.log("error please provide a key using get(key)"),d&&d(null);return}let S=y(s);if(l===""||l==="_"){S(null);return}if(c&&typeof d!="function"){console.log("error lex requires a callback function");return}let x=i.get(s);if(!x)return;if(d&&typeof x.cb>"u"&&(x.cb=d,d=null),l!==null&&x.chain.push({item:l,soul:null}),!x.cb)return g(s);let{soul:$}=h({get:c,_opt:m},S);$&&o(c,$,S,m)},put:(l,c,d)=>{typeof c=="function"&&(d=c,c=!1);let m=_=>T=>{d?d(T):p(_)(T)};if(!s){d&&d("error please provide a key using get(key)");return}let y=i.get(s);if(!y)return;if(!y.cb){if(!d)return;y.cb=d,d=null}c&&(l={[I.random()]:l});let S=m(s),x=f(l);if(typeof x=="string"){S(x);return}let{item:$,soul:j}=h({put:l},S);if(!j)return;if(x===!0){let _=y.user||e.secure?{"#":j}:{"#":j,".":$};t.get(_,async T=>{if(T.err){S(`error getting ${j}: ${T.err}`);return}let v=T.put&&T.put[j],w=v&&v[$],b=D.is(w);if(!b){v||(v={}),v[$]=l;let k=await a(j,v,y.user,S);if(k===null)return;t.put(k,S);return}t.get({"#":b},async k=>{if(k.err){S(`error getting ${b}: ${k.err}`);return}if(!k.put||!k.put[b]){S(`error ${b} not found`);return}for(let O of Object.keys(k.put[b])){if(O==="_"||O===F||O===q)continue;let C=await new Promise(L=>{let N=I.random(),R=[{item:O,soul:b}];i.set(N,{chain:R,user:y.user}),g(N).put(null,L)});if(C){S(C);return}}v||(v={}),v[$]=l;let E=await a(j,v,y.user,S);E!==null&&t.put(E,S)})});return}let A=y.user||e.secure?{"#":j}:{"#":j,".":$};t.get(A,async _=>{if(_.err){S(`error getting ${j}.${$}: ${_.err}`);return}let T=_.put&&_.put[j],v=T&&T[$],w=D.is(v);if(!w){T||(T={}),T[$]=D.ify(I.random());let k=await a(j,T,y.user,S);if(k===null)return;t.put(k,E=>{if(E)S(`error putting ${$} on ${j}: ${E}`);else{let O=I.random(),C=[{item:$,soul:j}];i.set(O,{chain:C,user:y.user,cb:y.cb}),g(O).put(l)}});return}let b=[];for(let k of x){let E=await new Promise(O=>{if(U.is(l[k])&&!D.is(l[k])){let C=I.random(),L=[{item:k,soul:w}];i.set(C,{chain:L,user:y.user}),g(C).put(l[k],O)}else b.push(k),O(null)});if(E){S(E,s);return}}if(b.length===0){S(null);return}t.get({"#":w},async k=>{if(k.err){S(`error getting ${w}: ${k.err}`);return}let E=k.put&&k.put[w];E||(E={}),b.forEach(C=>{E[C]=l[C]});let O=await a(w,E,y.user,S);O!==null&&t.put(O,S)})})},on:(l,c,d,m)=>{if(typeof l=="function"&&(m=d,d=c,c=l,l=null),typeof c!="function"){console.log("error on() requires a callback function");return}if(!s){console.log("error please provide a key using get(key)"),c(null);return}let{item:y,soul:S}=h({on:l,_get:d,_opt:m},c);S&&(i.set(s,{chain:[{item:y,soul:S}],on:!0}),n.set(c,()=>g(s).next(null,c,m)),t.get({"#":S,".":y},x=>{if(x.err){console.log(`error getting ${S}.${y}: ${x.err}`);return}let $=x.put&&x.put[S]&&x.put[S][y],j=D.is($);j?l?l=U.put(l,"#",j):l={"#":j,".":null}:l?l=U.put(l,"#",S):l={"#":S,".":y},t.on(l,n.get(c),d,m)},m))},off:l=>{if(!s){console.log("error please provide a key using get(key)"),l&&l(null);return}let{item:c,soul:d}=h({off:!0},l);d&&t.get({"#":d,".":c},m=>{if(m.err){console.log(`error getting ${d}.${c}: ${m.err}`);return}let y=m.put&&m.put[d]&&m.put[d][c],S=D.is(y);S?t.off({"#":S},n.get(l)):t.off({"#":d},n.get(l)),n.delete(l),i.delete(s)})},user:()=>(r.get||(Object.assign(r,g()),r.get=(l,c,d,m)=>{typeof c=="function"&&(m=d,d=c,c=null);let y=null,S=null;if(r.is&&(y=r.is.pub),typeof l=="string"?S=l:l instanceof Array&&(l.length===2?(y=l[0],S=l[1]):l.length===1&&(S=l[0])),!y){console.log("error please log in or provide a public key"),d&&d(null);return}if(S===null||S===""||S==="_"){console.log("error please provide a key"),d&&d(null);return}if(c&&!d){console.log("error lex requires a callback function");return}s=I.random();let x=[{item:S,soul:"~"+y}];if(i.set(s,{chain:x,user:r.is,cb:d}),!d)return g(s);let $=p(s),{soul:j}=h({get:c,_opt:m},$);j&&o(c,j,$,m)}),r),wire:t,SEA:P}};return g()},Nt=rt;export{Nt as default};
//# sourceMappingURL=holster.js.map
